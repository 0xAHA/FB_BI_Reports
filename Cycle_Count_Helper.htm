<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cycle Count Helper</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 6px;
        }
        .section.out {
            border-color: #ff6b6b;
            background-color: #fff5f5;
        }
        .section.in {
            border-color: #51cf66;
            background-color: #f4fdf7;
        }
        .section h2 {
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 2px solid currentColor;
        }
        .section.out h2 {
            color: #c92a2a;
        }
        .section.in h2 {
            color: #2b8a3e;
        }
        .item-row {
            display: grid;
            grid-template-columns: 1fr 200px 150px 100px 50px;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        .locationgroup-selector {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #e7f5ff;
            border: 2px solid #4dabf7;
            border-radius: 6px;
        }
        .locationgroup-selector h3 {
            margin-top: 0;
            color: #1971c2;
            font-size: 16px;
        }
        .locationgroup-selector select {
            width: 100%;
            max-width: 400px;
            padding: 10px;
            border: 1px solid #4dabf7;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            background-color: white;
        }
        .item-row label {
            font-weight: bold;
            font-size: 12px;
            color: #666;
            margin-bottom: 3px;
            display: block;
        }
        .item-row select,
        .item-row input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        .item-row select:focus,
        .item-row input:focus {
            outline: none;
            border-color: #4dabf7;
            box-shadow: 0 0 0 3px rgba(77, 171, 247, 0.1);
        }
        .add-btn,
        .remove-btn,
        .export-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s;
        }
        .add-btn {
            background-color: #4dabf7;
            color: white;
            margin-top: 10px;
        }
        .add-btn:hover {
            background-color: #339af0;
        }
        .remove-btn {
            background-color: #fa5252;
            color: white;
            width: 40px;
            height: 40px;
        }
        .remove-btn:hover {
            background-color: #e03131;
        }
        .export-btn {
            background-color: #51cf66;
            color: white;
            padding: 12px 30px;
            font-size: 16px;
            display: block;
            margin: 30px auto 0;
        }
        .export-btn:hover {
            background-color: #40c057;
        }
        .export-btn:disabled {
            background-color: #adb5bd;
            cursor: not-allowed;
        }
        .metadata-fields {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        .metadata-fields h3 {
            margin-top: 0;
            font-size: 14px;
            color: #495057;
        }
        .metadata-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-top: 10px;
        }
        .metadata-row label {
            font-weight: bold;
            font-size: 12px;
            color: #666;
            margin-bottom: 3px;
            display: block;
        }
        .metadata-row input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        .preview-section {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 6px;
        }
        .preview-section h2 {
            margin-top: 0;
            color: #495057;
            font-size: 18px;
        }
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            margin-top: 15px;
            font-size: 13px;
        }
        .preview-table th {
            background-color: #495057;
            color: white;
            padding: 10px;
            text-align: left;
            font-weight: bold;
            border: 1px solid #dee2e6;
        }
        .preview-table td {
            padding: 8px 10px;
            border: 1px solid #dee2e6;
        }
        .preview-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        .preview-table tr:hover {
            background-color: #e9ecef;
        }
        .preview-table .negative {
            color: #c92a2a;
            font-weight: bold;
        }
        .preview-table .positive {
            color: #2b8a3e;
            font-weight: bold;
        }
        .empty-preview {
            text-align: center;
            padding: 40px;
            color: #868e96;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Cycle Count Helper</h1>

        <div class="locationgroup-selector">
            <h3>üìç Location Group Filter</h3>
            <select id="locationGroupSelector" onchange="onLocationGroupChange()">
                <option value="">-- Select Location Group --</option>
            </select>
        </div>

        <div class="section out">
            <h2>üîª Items to Adjust OUT</h2>
            <div id="outItems">
                <!-- Items will be added here dynamically -->
            </div>
            <button class="add-btn" onclick="addOutItem()">+ Add Item to Adjust Out</button>
        </div>

        <div class="section in">
            <h2>üî∫ Items to Adjust IN</h2>
            <div id="inItems">
                <!-- Items will be added here dynamically -->
            </div>
            <button class="add-btn" onclick="addInItem()">+ Add Item to Adjust In</button>
        </div>

        <div class="metadata-fields">
            <h3>Additional Information (Optional)</h3>
            <div class="metadata-row">
                <div>
                    <label>Date</label>
                    <input type="date" id="cycleDate" onchange="updatePreview()" />
                </div>
                <div>
                    <label>Customer</label>
                    <input type="text" id="customer" placeholder="Customer name (optional)" oninput="updatePreview()" />
                </div>
                <div>
                    <label>Note</label>
                    <input type="text" id="note" placeholder="Add a note (optional)" oninput="updatePreview()" />
                </div>
            </div>
        </div>

        <div class="preview-section">
            <h2>üìã CSV Export Preview</h2>
            <div id="previewContainer">
                <div class="empty-preview">Add items above to see preview</div>
            </div>
        </div>

        <button class="export-btn" onclick="exportCycleCount()">Export Cycle Count CSV</button>
    </div>

    <script>
    let outItemCounter = 0;
    let inItemCounter = 0;
    let parts = [];
    let locationGroups = [];
    let selectedLocationGroupId = null;
    let user = JSON.parse(getUser());
    let currentUser = user.id;

    // Load location groups
    function loadLocationGroups() {
        try {
            let query = `SELECT id, name FROM locationgroup WHERE activeflag = 1 ORDER BY name`;
            locationGroups = JSON.parse(runQuery(query));

            let selector = document.getElementById('locationGroupSelector');
            selector.innerHTML = '<option value="">-- Select Location Group --</option>';
            locationGroups.forEach(function(lg) {
                selector.innerHTML += '<option value="' + lg.id + '">' + lg.name + '</option>';
            });

            // Default select location group id 1
            selector.value = '1';
            selectedLocationGroupId = 1;
            loadParts();

            // Add initial rows
            addOutItem();
            addInItem();
        } catch(e) {
            console.error('Error loading location groups:', e);
            alert('Error loading location groups: ' + e.message);
        }
    }

    // Handle location group change
    function onLocationGroupChange() {
        let selector = document.getElementById('locationGroupSelector');
        selectedLocationGroupId = selector.value ? parseInt(selector.value) : null;

        // Clear existing items
        document.getElementById('outItems').innerHTML = '';
        document.getElementById('inItems').innerHTML = '';
        outItemCounter = 0;
        inItemCounter = 0;

        // Reload parts for selected location group
        if (selectedLocationGroupId) {
            loadParts();
            addOutItem();
            addInItem();
        } else {
            parts = [];
        }
        updatePreview();
    }

    // Load parts list filtered by location group
    function loadParts() {
        try {
            if (!selectedLocationGroupId) {
                parts = [];
                return;
            }

            console.log('Loading parts for location group:', selectedLocationGroupId);
            // Only show parts that have inventory in the selected location group
            let query = `SELECT DISTINCT
                part.num as partnum,
                part.description as partdescription,
                part.id as partid,
                uom.code as uom
            FROM part
            INNER JOIN uom ON part.uomid = uom.id
            INNER JOIN qtyonhand qoh ON part.id = qoh.partid
            WHERE part.activeflag = 1
            AND qoh.locationgroupid = ${selectedLocationGroupId}
            AND qoh.qty > 0
            ORDER BY part.num`;

            console.log('Parts query:', query);
            parts = JSON.parse(runQuery(query));
            console.log('Loaded ' + parts.length + ' parts with inventory in location group');
        } catch(e) {
            console.error('Error loading parts:', e);
            alert('Error loading parts: ' + e.message);
            parts = [];
        }
    }

    // Create part dropdown options
    function createPartOptions() {
        let options = '<option value="">-- Select Part --</option>';
        parts.forEach(function(part) {
            options += '<option value="' + part.partnum + '" data-uom="' + part.uom + '" data-description="' + part.partdescription + '">' +
                       part.partnum + ' - ' + part.partdescription + '</option>';
        });
        return options;
    }

    // Load locations with stock for a specific part
    function loadLocationsForPart(partNum, locationSelectId, type) {
        try {
            if (!partNum || !selectedLocationGroupId) {
                alert('Debug: partNum=' + partNum + ', locationGroupId=' + selectedLocationGroupId);
                return;
            }

            alert('Loading locations for part: ' + partNum + ' in location group: ' + selectedLocationGroupId + ' (type: ' + type + ')');

            if (type === 'in') {
                // For Adjust IN: Check if default location exists in this location group
                let defaultQuery = `SELECT
                    part.num as partnum,
                    lg.name as locationgroupname,
                    loc.name as locationname,
                    CASE
                        WHEN COALESCE(lg.name, '') != '' AND COALESCE(loc.name, '') != '' THEN CONCAT(lg.name, '-', loc.name)
                        WHEN COALESCE(lg.name, '') != '' THEN lg.name
                        WHEN COALESCE(loc.name, '') != '' THEN loc.name
                        ELSE ''
                    END as location
                FROM part
                LEFT JOIN defaultlocation dl ON part.id = dl.partid
                LEFT JOIN location loc ON dl.locationid = loc.id
                LEFT JOIN locationgroup lg ON loc.locationgroupid = lg.id
                WHERE part.num = '${partNum}'
                AND lg.id = ${selectedLocationGroupId}`;

                alert('Default location query: ' + defaultQuery);
                let defaultResult = runQuery(defaultQuery);
                alert('Default location raw result: ' + defaultResult);
                let defaultLocations = JSON.parse(defaultResult);
                alert('Default location parsed: ' + JSON.stringify(defaultLocations));

                let locationSelect = document.getElementById(locationSelectId);

                if (defaultLocations && defaultLocations.length > 0 && defaultLocations[0].location) {
                    // Use ONLY the default location
                    let defaultLoc = defaultLocations[0];
                    locationSelect.innerHTML = '<option value="' + defaultLoc.location + '">' + defaultLoc.location + ' (Default)</option>';
                    locationSelect.value = defaultLoc.location;
                    alert('Set default location for IN: ' + defaultLoc.location);
                } else {
                    // No default location - show ALL locations in this location group
                    alert('No default location found, loading all locations in group');
                    let allLocQuery = `SELECT DISTINCT
                        lg.name as locationgroupname,
                        loc.name as locationname,
                        CASE
                            WHEN COALESCE(lg.name, '') != '' AND COALESCE(loc.name, '') != '' THEN CONCAT(lg.name, '-', loc.name)
                            WHEN COALESCE(lg.name, '') != '' THEN lg.name
                            WHEN COALESCE(loc.name, '') != '' THEN loc.name
                            ELSE 'Unknown Location'
                        END as location
                    FROM location loc
                    LEFT JOIN locationgroup lg ON loc.locationgroupid = lg.id
                    WHERE lg.id = ${selectedLocationGroupId}
                    ORDER BY loc.name`;

                    alert('All locations query: ' + allLocQuery);
                    let allLocsResult = runQuery(allLocQuery);
                    alert('All locations raw result: ' + allLocsResult);
                    let allLocations = JSON.parse(allLocsResult);
                    alert('Found ' + (allLocations ? allLocations.length : 0) + ' locations in group');

                    locationSelect.innerHTML = '<option value="">-- Select Location --</option>';
                    if (allLocations && allLocations.length > 0) {
                        allLocations.forEach(function(loc) {
                            locationSelect.innerHTML += '<option value="' + loc.location + '">' + loc.location + '</option>';
                        });
                        locationSelect.value = allLocations[0].location;
                    }
                }
            } else {
                // For Adjust OUT: Show only locations with stock
                let query = `SELECT DISTINCT
                    lg.name as locationgroupname,
                    loc.name as locationname,
                    CASE
                        WHEN COALESCE(lg.name, '') != '' AND COALESCE(loc.name, '') != '' THEN CONCAT(lg.name, '-', loc.name)
                        WHEN COALESCE(lg.name, '') != '' THEN lg.name
                        WHEN COALESCE(loc.name, '') != '' THEN loc.name
                        ELSE 'Unknown Location'
                    END as location,
                    qoh.qty
                FROM part
                INNER JOIN qtyonhand qoh ON part.id = qoh.partid
                LEFT JOIN location loc ON qoh.locationid = loc.id
                LEFT JOIN locationgroup lg ON loc.locationgroupid = lg.id
                WHERE part.num = '${partNum}'
                AND lg.id = ${selectedLocationGroupId}
                AND qoh.qty > 0
                ORDER BY qoh.qty DESC`;

                alert('OUT query: ' + query);
                let queryResult = runQuery(query);
                alert('OUT raw result: ' + queryResult);
                let locations = JSON.parse(queryResult);
                alert('OUT parsed: Found ' + (locations ? locations.length : 0) + ' locations with stock');

                let locationSelect = document.getElementById(locationSelectId);
                locationSelect.innerHTML = '<option value="">-- Select Location --</option>';

                if (locations && locations.length > 0) {
                    locations.forEach(function(loc) {
                        locationSelect.innerHTML += '<option value="' + loc.location + '">' + loc.location + ' (Qty: ' + loc.qty + ')</option>';
                    });
                    locationSelect.value = locations[0].location;
                }
            }

            updatePreview();
        } catch(e) {
            console.error('Error loading locations for part:', e);
            alert('Error loading locations: ' + e.message);
        }
    }

    // Add OUT item row
    function addOutItem() {
        outItemCounter++;
        let container = document.getElementById('outItems');
        let row = document.createElement('div');
        row.className = 'item-row';
        row.id = 'out-' + outItemCounter;
        row.innerHTML = `
            <div>
                <label>Part Number</label>
                <select id="out-part-${outItemCounter}" onchange="onPartSelected(this, 'out', ${outItemCounter})">
                    ${createPartOptions()}
                </select>
            </div>
            <div>
                <label>Location</label>
                <select id="out-loc-${outItemCounter}" onchange="updatePreview()">
                    <option value="">-- Select Part First --</option>
                </select>
            </div>
            <div>
                <label>Quantity to Remove</label>
                <input type="number" id="out-qty-${outItemCounter}" min="0" step="1" value="" placeholder="Qty" oninput="updatePreview()" />
            </div>
            <div>
                <label>UOM</label>
                <input type="text" id="out-uom-${outItemCounter}" readonly style="background-color: #f1f3f5;" />
            </div>
            <div>
                <label>&nbsp;</label>
                <button class="remove-btn" onclick="removeItem('out-${outItemCounter}')">√ó</button>
            </div>
        `;
        container.appendChild(row);
    }

    // Add IN item row
    function addInItem() {
        inItemCounter++;
        let container = document.getElementById('inItems');
        let row = document.createElement('div');
        row.className = 'item-row';
        row.id = 'in-' + inItemCounter;
        row.innerHTML = `
            <div>
                <label>Part Number</label>
                <select id="in-part-${inItemCounter}" onchange="onPartSelected(this, 'in', ${inItemCounter})">
                    ${createPartOptions()}
                </select>
            </div>
            <div>
                <label>Location</label>
                <select id="in-loc-${inItemCounter}" onchange="updatePreview()">
                    <option value="">-- Select Part First --</option>
                </select>
            </div>
            <div>
                <label>Quantity to Add</label>
                <input type="number" id="in-qty-${inItemCounter}" min="0" step="1" value="" placeholder="Qty" oninput="updatePreview()" />
            </div>
            <div>
                <label>UOM</label>
                <input type="text" id="in-uom-${inItemCounter}" readonly style="background-color: #f1f3f5;" />
            </div>
            <div>
                <label>&nbsp;</label>
                <button class="remove-btn" onclick="removeItem('in-${inItemCounter}')">√ó</button>
            </div>
        `;
        container.appendChild(row);
    }

    // Handle part selection
    function onPartSelected(selectElement, type, counter) {
        let selectedOption = selectElement.options[selectElement.selectedIndex];
        let partNum = selectElement.value;
        let uom = selectedOption.getAttribute('data-uom') || '';

        // Update UOM
        let uomInput = document.getElementById(type + '-uom-' + counter);
        if (uomInput) {
            uomInput.value = uom;
        }

        // Set quantity to 1
        let qtyInput = document.getElementById(type + '-qty-' + counter);
        if (qtyInput && partNum) {
            qtyInput.value = '1';
        }

        // Load locations for this part
        if (partNum) {
            loadLocationsForPart(partNum, type + '-loc-' + counter, type);
        }

        updatePreview();
    }

    // Remove item row
    function removeItem(rowId) {
        let row = document.getElementById(rowId);
        if (row) {
            row.remove();
            updatePreview();
        }
    }

    // Get location information for parts
    function getLocationInfo(partNumbers, type) {
        if (partNumbers.length === 0) return [];

        let partNumList = partNumbers.map(p => "'" + p + "'").join(',');
        console.log('getLocationInfo called with type:', type, 'parts:', partNumbers);

        try {
            if (type === 'IN') {
                // For cycle IN: Get default location for each part based on user's default location group
                let query = `SELECT
                    part.num as partnum,
                    COALESCE(lg.name, '') as locationgroup,
                    COALESCE(loc.name, '') as locationname,
                    CASE
                        WHEN COALESCE(lg.name, '') != '' AND COALESCE(loc.name, '') != '' THEN CONCAT(lg.name, '-', loc.name)
                        WHEN COALESCE(lg.name, '') != '' THEN lg.name
                        WHEN COALESCE(loc.name, '') != '' THEN loc.name
                        ELSE 'No Location Set'
                    END as location,
                    uom.code as uom
                FROM part
                INNER JOIN uom ON part.uomid = uom.id
                LEFT JOIN defaultlocation dl ON part.id = dl.partid
                LEFT JOIN usertolg utlg ON utlg.userid = ${currentUser} AND utlg.defaultflag = 1
                LEFT JOIN locationgroup lg ON dl.locationgroupid = lg.id
                LEFT JOIN location loc ON dl.locationid = loc.id
                WHERE part.num IN (${partNumList})`;

                console.log('IN Query:', query);
                let queryResult = runQuery(query);
                console.log('IN Query raw result:', queryResult);
                let result = JSON.parse(queryResult);
                console.log('IN Query parsed result:', result);
                // Ensure we always return an array
                if (!result || result === null) {
                    console.warn('IN Query returned null, returning empty array');
                    return [];
                }
                if (!Array.isArray(result)) {
                    console.warn('IN Query did not return array, wrapping in array');
                    return [result];
                }
                return result;
            } else {
                // For cycle OUT: Get current inventory locations (where qty > 0) - any location, not just default location group
                let query = `SELECT
                    part.num as partnum,
                    COALESCE(lg.name, '') as locationgroup,
                    COALESCE(loc.name, '') as locationname,
                    CASE
                        WHEN COALESCE(lg.name, '') != '' AND COALESCE(loc.name, '') != '' THEN CONCAT(lg.name, '-', loc.name)
                        WHEN COALESCE(lg.name, '') != '' THEN lg.name
                        WHEN COALESCE(loc.name, '') != '' THEN loc.name
                        ELSE 'Unknown Location'
                    END as location,
                    uom.code as uom,
                    qoh.qty as qtyonhand
                FROM part
                INNER JOIN uom ON part.uomid = uom.id
                INNER JOIN qtyonhand qoh ON part.id = qoh.partid
                LEFT JOIN locationgroup lg ON qoh.locationgroupid = lg.id
                LEFT JOIN location loc ON qoh.locationid = loc.id
                WHERE part.num IN (${partNumList})
                AND qoh.qty > 0
                ORDER BY part.num, qoh.qty DESC`;

                console.log('OUT Query:', query);
                let queryResult = runQuery(query);
                console.log('OUT Query raw result:', queryResult);
                let result = JSON.parse(queryResult);
                console.log('OUT Query parsed result:', result);
                // Ensure we always return an array
                if (!result || result === null) {
                    console.warn('OUT Query returned null, returning empty array');
                    return [];
                }
                if (!Array.isArray(result)) {
                    console.warn('OUT Query did not return array, wrapping in array');
                    return [result];
                }
                return result;
            }
        } catch(e) {
            console.error('Error in getLocationInfo:', e);
            alert('Error getting location info: ' + e.message);
            return [];
        }
    }

    // Update preview table
    function updatePreview() {
        console.log('=== UPDATE PREVIEW CALLED ===');
        try {
            let previewContainer = document.getElementById('previewContainer');
            if (!previewContainer) {
                console.error('Preview container not found!');
                return;
            }

            let metadata = {
                date: document.getElementById('cycleDate').value || '',
                customer: document.getElementById('customer').value || '',
                note: document.getElementById('note').value || ''
            };
            console.log('Metadata:', metadata);

        // Collect OUT items
        let outItems = [];
        document.getElementById('outItems').querySelectorAll('.item-row').forEach(function(row) {
            let selects = row.querySelectorAll('select');
            let partSelect = selects[0];  // First select is part
            let locationSelect = selects[1];  // Second select is location
            let qtyInput = row.querySelector('input[type="number"]');
            let partNum = partSelect.value;
            let location = locationSelect.value;
            let qty = parseFloat(qtyInput.value) || 0;

            if (partNum && qty > 0 && location) {
                outItems.push({
                    partnum: partNum,
                    location: location,
                    qty: qty,
                    uom: row.querySelector('input[type="text"]').value
                });
            }
        });

        // Collect IN items
        let inItems = [];
        document.getElementById('inItems').querySelectorAll('.item-row').forEach(function(row) {
            let selects = row.querySelectorAll('select');
            let partSelect = selects[0];  // First select is part
            let locationSelect = selects[1];  // Second select is location
            let qtyInput = row.querySelector('input[type="number"]');
            let partNum = partSelect.value;
            let location = locationSelect.value;
            let qty = parseFloat(qtyInput.value) || 0;

            if (partNum && qty > 0 && location) {
                inItems.push({
                    partnum: partNum,
                    location: location,
                    qty: qty,
                    uom: row.querySelector('input[type="text"]').value
                });
            }
        });

        if (outItems.length === 0 && inItems.length === 0) {
            previewContainer.innerHTML = '<div class="empty-preview">Add items above to see preview</div>';
            return;
        }

        // Build preview data directly from items (location already selected in dropdown)
        let previewData = [];

        // Build OUT entries
        outItems.forEach(function(item) {
            previewData.push({
                PartNumber: item.partnum,
                Location: item.location,
                Qty: -Math.abs(item.qty),
                UOM: item.uom,
                Date: metadata.date,
                Note: metadata.note,
                Customer: metadata.customer,
                type: 'OUT'
            });
        });

        // Build IN entries
        inItems.forEach(function(item) {
            previewData.push({
                PartNumber: item.partnum,
                Location: item.location,
                Qty: Math.abs(item.qty),
                UOM: item.uom,
                Date: metadata.date,
                Note: metadata.note,
                Customer: metadata.customer,
                type: 'IN'
            });
        });

        if (previewData.length === 0) {
            previewContainer.innerHTML = '<div class="empty-preview">No valid items to preview (check console for errors)</div>';
            return;
        }

        // Build preview table
        let html = '<table class="preview-table">';
        html += '<thead><tr>';
        html += '<th>Part Number</th>';
        html += '<th>Location</th>';
        html += '<th>Qty</th>';
        html += '<th>UOM</th>';
        html += '<th>Date</th>';
        html += '<th>Note</th>';
        html += '<th>Customer</th>';
        html += '</tr></thead>';
        html += '<tbody>';

        previewData.forEach(function(row) {
            let qtyClass = row.Qty < 0 ? 'negative' : 'positive';
            html += '<tr>';
            html += '<td>' + row.PartNumber + '</td>';
            html += '<td>' + row.Location + '</td>';
            html += '<td class="' + qtyClass + '">' + row.Qty + '</td>';
            html += '<td>' + row.UOM + '</td>';
            html += '<td>' + row.Date + '</td>';
            html += '<td>' + row.Note + '</td>';
            html += '<td>' + row.Customer + '</td>';
            html += '</tr>';
        });

        html += '</tbody></table>';
        previewContainer.innerHTML = html;
        console.log('Preview updated with', previewData.length, 'entries');
        } catch(e) {
            console.error('Error in updatePreview:', e);
            alert('Error updating preview: ' + e.message + '. Check console for details.');
        }
    }

    // Export cycle count CSV
    function exportCycleCount() {
        console.log('Starting export...');
        alert('Export started...');

        try {
            let csvData = [];
            let metadata = {
                date: document.getElementById('cycleDate').value || '',
                customer: document.getElementById('customer').value || '',
                note: document.getElementById('note').value || ''
            };

        // Collect OUT items
        let outItems = [];
        document.getElementById('outItems').querySelectorAll('.item-row').forEach(function(row) {
            let selects = row.querySelectorAll('select');
            let partSelect = selects[0];  // First select is part
            let locationSelect = selects[1];  // Second select is location
            let qtyInput = row.querySelector('input[type="number"]');
            let partNum = partSelect.value;
            let location = locationSelect.value;
            let qty = parseFloat(qtyInput.value) || 0;

            if (partNum && qty > 0 && location) {
                outItems.push({
                    partnum: partNum,
                    location: location,
                    qty: qty,
                    uom: row.querySelector('input[type="text"]').value
                });
            }
        });

        // Collect IN items
        let inItems = [];
        document.getElementById('inItems').querySelectorAll('.item-row').forEach(function(row) {
            let selects = row.querySelectorAll('select');
            let partSelect = selects[0];  // First select is part
            let locationSelect = selects[1];  // Second select is location
            let qtyInput = row.querySelector('input[type="number"]');
            let partNum = partSelect.value;
            let location = locationSelect.value;
            let qty = parseFloat(qtyInput.value) || 0;

            if (partNum && qty > 0 && location) {
                inItems.push({
                    partnum: partNum,
                    location: location,
                    qty: qty,
                    uom: row.querySelector('input[type="text"]').value
                });
            }
        });

        if (outItems.length === 0 && inItems.length === 0) {
            alert('Please add at least one item to adjust.');
            console.log('No items to export');
            return;
        }

        alert('Found ' + outItems.length + ' OUT items and ' + inItems.length + ' IN items');
        console.log('OUT items:', outItems);
        console.log('IN items:', inItems);

        // Build OUT entries (negative quantities) - location already selected in dropdown
        outItems.forEach(function(item) {
            csvData.push({
                PartNumber: item.partnum,
                Location: item.location,
                Qty: -Math.abs(item.qty), // Negative for OUT
                UOM: item.uom,
                Date: metadata.date,
                Note: metadata.note,
                Customer: metadata.customer
            });
            console.log('Added OUT entry:', item.partnum, 'at', item.location);
        });

        // Build IN entries (positive quantities) - location already selected in dropdown
        inItems.forEach(function(item) {
            csvData.push({
                PartNumber: item.partnum,
                Location: item.location,
                Qty: Math.abs(item.qty), // Positive for IN
                UOM: item.uom,
                Date: metadata.date,
                Note: metadata.note,
                Customer: metadata.customer
            });
            console.log('Added IN entry:', item.partnum, 'at', item.location);
        });

        if (csvData.length === 0) {
            alert('No valid entries to export. No locations were found for the selected parts.');
            console.error('No CSV data generated');
            return;
        }

        alert('Built ' + csvData.length + ' CSV entries. Generating file...');
        console.log('CSV data to export:', csvData);

        // Generate CSV
        let csv = 'PartNumber,Location,Qty,UOM,Date,Note,Customer\n';
        csvData.forEach(function(row) {
            csv += '"' + row.PartNumber + '",';
            csv += '"' + row.Location + '",';
            csv += row.Qty + ',';
            csv += '"' + row.UOM + '",';
            csv += '"' + row.Date + '",';
            csv += '"' + row.Note + '",';
            csv += '"' + row.Customer + '"\n';
        });

        console.log('Generated CSV:');
        console.log(csv);

        // Download CSV
        try {
            let blob = new Blob([csv], { type: 'text/csv' });
            let url = window.URL.createObjectURL(blob);
            let a = document.createElement('a');
            a.href = url;
            let filename = 'CycleCount_' + new Date().toISOString().split('T')[0] + '.csv';
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            console.log('Successfully exported ' + csvData.length + ' cycle count entries to ' + filename);
            alert('CSV file downloaded: ' + filename);
        } catch(e) {
            console.error('Error downloading CSV:', e);
            alert('Error creating CSV file: ' + e.message);
        }
        } catch(mainError) {
            console.error('Error in exportCycleCount:', mainError);
            alert('Export failed: ' + mainError.message + '. Please check your selections and try again.');
        }
    }

    // Initialize
    window.onload = function() {
        // Set default date to today
        document.getElementById('cycleDate').valueAsDate = new Date();
        // Load location groups (this will auto-select id=1 and load parts)
        loadLocationGroups();
        // Note: Initial rows will be added after location group is loaded
    };
    </script>
</body>
</html>
