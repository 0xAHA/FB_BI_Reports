<!DOCTYPE html>
<html lang="en">
<head>
    {% Template Cycle_Count_Helper %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cycle Count Helper</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 6px;
        }
        .section.out {
            border-color: #ff6b6b;
            background-color: #fff5f5;
        }
        .section.in {
            border-color: #51cf66;
            background-color: #f4fdf7;
        }
        .section h2 {
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 2px solid currentColor;
        }
        .section.out h2 {
            color: #c92a2a;
        }
        .section.in h2 {
            color: #2b8a3e;
        }
        .item-row {
            display: grid;
            grid-template-columns: 1fr 150px 100px 50px;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        .item-row label {
            font-weight: bold;
            font-size: 12px;
            color: #666;
            margin-bottom: 3px;
            display: block;
        }
        .item-row select,
        .item-row input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        .item-row select:focus,
        .item-row input:focus {
            outline: none;
            border-color: #4dabf7;
            box-shadow: 0 0 0 3px rgba(77, 171, 247, 0.1);
        }
        .add-btn,
        .remove-btn,
        .export-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s;
        }
        .add-btn {
            background-color: #4dabf7;
            color: white;
            margin-top: 10px;
        }
        .add-btn:hover {
            background-color: #339af0;
        }
        .remove-btn {
            background-color: #fa5252;
            color: white;
            width: 40px;
            height: 40px;
        }
        .remove-btn:hover {
            background-color: #e03131;
        }
        .export-btn {
            background-color: #51cf66;
            color: white;
            padding: 12px 30px;
            font-size: 16px;
            display: block;
            margin: 30px auto 0;
        }
        .export-btn:hover {
            background-color: #40c057;
        }
        .export-btn:disabled {
            background-color: #adb5bd;
            cursor: not-allowed;
        }
        .metadata-fields {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        .metadata-fields h3 {
            margin-top: 0;
            font-size: 14px;
            color: #495057;
        }
        .metadata-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-top: 10px;
        }
        .metadata-row label {
            font-weight: bold;
            font-size: 12px;
            color: #666;
            margin-bottom: 3px;
            display: block;
        }
        .metadata-row input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Cycle Count Helper</h1>

        <div class="section out">
            <h2>ðŸ”» Items to Adjust OUT</h2>
            <div id="outItems">
                <!-- Items will be added here dynamically -->
            </div>
            <button class="add-btn" onclick="addOutItem()">+ Add Item to Adjust Out</button>
        </div>

        <div class="section in">
            <h2>ðŸ”º Items to Adjust IN</h2>
            <div id="inItems">
                <!-- Items will be added here dynamically -->
            </div>
            <button class="add-btn" onclick="addInItem()">+ Add Item to Adjust In</button>
        </div>

        <div class="metadata-fields">
            <h3>Additional Information (Optional)</h3>
            <div class="metadata-row">
                <div>
                    <label>Date</label>
                    <input type="date" id="cycleDate" />
                </div>
                <div>
                    <label>Customer</label>
                    <input type="text" id="customer" placeholder="Customer name (optional)" />
                </div>
                <div>
                    <label>Note</label>
                    <input type="text" id="note" placeholder="Add a note (optional)" />
                </div>
            </div>
        </div>

        <button class="export-btn" onclick="exportCycleCount()">Export Cycle Count CSV</button>
    </div>

    <script>
    let outItemCounter = 0;
    let inItemCounter = 0;
    let parts = [];
    let user = JSON.parse(getUser());
    let currentUser = user.id;

    // Load parts list
    function loadParts() {
        let query = `SELECT
            part.num as partnum,
            part.description as partdescription,
            part.id as partid,
            uom.code as uom
        FROM part
        INNER JOIN uom ON part.uomid = uom.id
        WHERE part.activeflag = 1
        ORDER BY part.num`;

        parts = JSON.parse(runQuery(query));
        console.log('Loaded ' + parts.length + ' parts');
    }

    // Create part dropdown options
    function createPartOptions() {
        let options = '<option value="">-- Select Part --</option>';
        parts.forEach(function(part) {
            options += '<option value="' + part.partnum + '" data-uom="' + part.uom + '" data-description="' + part.partdescription + '">' +
                       part.partnum + ' - ' + part.partdescription + '</option>';
        });
        return options;
    }

    // Add OUT item row
    function addOutItem() {
        outItemCounter++;
        let container = document.getElementById('outItems');
        let row = document.createElement('div');
        row.className = 'item-row';
        row.id = 'out-' + outItemCounter;
        row.innerHTML = `
            <div>
                <label>Part Number</label>
                <select onchange="updateUOM(this, 'out-qty-${outItemCounter}')">
                    ${createPartOptions()}
                </select>
            </div>
            <div>
                <label>Quantity to Remove</label>
                <input type="number" id="out-qty-${outItemCounter}" min="0" step="1" placeholder="Qty" />
            </div>
            <div>
                <label>UOM</label>
                <input type="text" id="out-uom-${outItemCounter}" readonly style="background-color: #f1f3f5;" />
            </div>
            <div>
                <label>&nbsp;</label>
                <button class="remove-btn" onclick="removeItem('out-${outItemCounter}')">Ã—</button>
            </div>
        `;
        container.appendChild(row);
    }

    // Add IN item row
    function addInItem() {
        inItemCounter++;
        let container = document.getElementById('inItems');
        let row = document.createElement('div');
        row.className = 'item-row';
        row.id = 'in-' + inItemCounter;
        row.innerHTML = `
            <div>
                <label>Part Number</label>
                <select onchange="updateUOM(this, 'in-qty-${inItemCounter}')">
                    ${createPartOptions()}
                </select>
            </div>
            <div>
                <label>Quantity to Add</label>
                <input type="number" id="in-qty-${inItemCounter}" min="0" step="1" placeholder="Qty" />
            </div>
            <div>
                <label>UOM</label>
                <input type="text" id="in-uom-${inItemCounter}" readonly style="background-color: #f1f3f5;" />
            </div>
            <div>
                <label>&nbsp;</label>
                <button class="remove-btn" onclick="removeItem('in-${inItemCounter}')">Ã—</button>
            </div>
        `;
        container.appendChild(row);
    }

    // Update UOM when part is selected
    function updateUOM(selectElement, qtyId) {
        let selectedOption = selectElement.options[selectElement.selectedIndex];
        let uom = selectedOption.getAttribute('data-uom') || '';
        let uomInput = selectElement.closest('.item-row').querySelector('input[type="text"]');
        if (uomInput) {
            uomInput.value = uom;
        }
    }

    // Remove item row
    function removeItem(rowId) {
        let row = document.getElementById(rowId);
        if (row) {
            row.remove();
        }
    }

    // Get location information for parts
    function getLocationInfo(partNumbers, type) {
        if (partNumbers.length === 0) return [];

        let partNumList = partNumbers.map(p => "'" + p + "'").join(',');

        if (type === 'IN') {
            // For cycle IN: Get default location for each part based on user's default location group
            let query = `SELECT
                part.num as partnum,
                CONCAT(COALESCE(lg.name, ''), '-', COALESCE(loc.name, '')) as location,
                uom.code as uom
            FROM part
            INNER JOIN uom ON part.uomid = uom.id
            LEFT JOIN defaultlocation dl ON part.id = dl.partid
            LEFT JOIN usertolg utlg ON utlg.userid = ${currentUser} AND utlg.defaultflag = 1
            LEFT JOIN locationgroup lg ON (dl.locationgroupid = lg.id AND lg.id = utlg.locationgroupid)
            LEFT JOIN location loc ON dl.locationid = loc.id
            WHERE part.num IN (${partNumList})`;

            return JSON.parse(runQuery(query));
        } else {
            // For cycle OUT: Get current inventory locations (where qty > 0)
            let query = `SELECT
                part.num as partnum,
                CONCAT(COALESCE(lg.name, ''), '-', COALESCE(loc.name, '')) as location,
                uom.code as uom,
                qoh.qty as qtyonhand
            FROM part
            INNER JOIN uom ON part.uomid = uom.id
            LEFT JOIN qtyonhand qoh ON part.id = qoh.partid
            LEFT JOIN usertolg utlg ON utlg.userid = ${currentUser} AND utlg.defaultflag = 1
            LEFT JOIN locationgroup lg ON (qoh.locationgroupid = lg.id AND lg.id = utlg.locationgroupid)
            LEFT JOIN location loc ON qoh.locationid = loc.id
            WHERE part.num IN (${partNumList})
            AND qoh.qty > 0`;

            return JSON.parse(runQuery(query));
        }
    }

    // Export cycle count CSV
    function exportCycleCount() {
        let csvData = [];
        let metadata = {
            date: document.getElementById('cycleDate').value || '',
            customer: document.getElementById('customer').value || '',
            note: document.getElementById('note').value || ''
        };

        // Collect OUT items
        let outPartNumbers = [];
        let outItems = [];
        document.getElementById('outItems').querySelectorAll('.item-row').forEach(function(row) {
            let select = row.querySelector('select');
            let qtyInput = row.querySelector('input[type="number"]');
            let partNum = select.value;
            let qty = parseFloat(qtyInput.value) || 0;

            if (partNum && qty > 0) {
                outPartNumbers.push(partNum);
                outItems.push({
                    partnum: partNum,
                    qty: qty,
                    uom: row.querySelector('input[type="text"]').value
                });
            }
        });

        // Collect IN items
        let inPartNumbers = [];
        let inItems = [];
        document.getElementById('inItems').querySelectorAll('.item-row').forEach(function(row) {
            let select = row.querySelector('select');
            let qtyInput = row.querySelector('input[type="number"]');
            let partNum = select.value;
            let qty = parseFloat(qtyInput.value) || 0;

            if (partNum && qty > 0) {
                inPartNumbers.push(partNum);
                inItems.push({
                    partnum: partNum,
                    qty: qty,
                    uom: row.querySelector('input[type="text"]').value
                });
            }
        });

        if (outPartNumbers.length === 0 && inPartNumbers.length === 0) {
            alert('Please add at least one item to adjust.');
            return;
        }

        // Get location info
        let outLocations = getLocationInfo(outPartNumbers, 'OUT');
        let inLocations = getLocationInfo(inPartNumbers, 'IN');

        // Build OUT entries (negative quantities)
        outItems.forEach(function(item) {
            let locInfo = outLocations.find(l => l.partnum === item.partnum);
            if (locInfo) {
                csvData.push({
                    PartNumber: item.partnum,
                    Location: locInfo.location,
                    Qty: -Math.abs(item.qty), // Negative for OUT
                    UOM: item.uom,
                    Date: metadata.date,
                    Note: metadata.note,
                    Customer: metadata.customer
                });
            }
        });

        // Build IN entries (positive quantities)
        inItems.forEach(function(item) {
            let locInfo = inLocations.find(l => l.partnum === item.partnum);
            if (locInfo) {
                csvData.push({
                    PartNumber: item.partnum,
                    Location: locInfo.location,
                    Qty: Math.abs(item.qty), // Positive for IN
                    UOM: item.uom,
                    Date: metadata.date,
                    Note: metadata.note,
                    Customer: metadata.customer
                });
            }
        });

        // Generate CSV
        let csv = 'PartNumber,Location,Qty,UOM,Date,Note,Customer\n';
        csvData.forEach(function(row) {
            csv += '"' + row.PartNumber + '",';
            csv += '"' + row.Location + '",';
            csv += row.Qty + ',';
            csv += '"' + row.UOM + '",';
            csv += '"' + row.Date + '",';
            csv += '"' + row.Note + '",';
            csv += '"' + row.Customer + '"\n';
        });

        // Download CSV
        let blob = new Blob([csv], { type: 'text/csv' });
        let url = window.URL.createObjectURL(blob);
        let a = document.createElement('a');
        a.href = url;
        a.download = 'CycleCount_' + new Date().toISOString().split('T')[0] + '.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);

        console.log('Exported ' + csvData.length + ' cycle count entries');
    }

    // Initialize
    window.onload = function() {
        loadParts();
        // Set default date to today
        document.getElementById('cycleDate').valueAsDate = new Date();
        // Add one row to each section to start
        addOutItem();
        addInItem();
    };
    </script>
</body>
</html>
