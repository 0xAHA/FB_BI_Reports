<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Back Order Dashboard - Fishbowl Advanced</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- D3.js v7 -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- DataTables -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.css">
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.js"></script>

    <style>
        /* ============================================
           Base Styles (matching Sales Dashboard)
           ============================================ */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        /* Custom Brand Colors (matching Sales Dashboard) */
        :root {
            --color-primary: #2d9cdb;
            --color-primary-dark: #1e7bb4;
            --color-sidebar: #06162d;
            --color-sidebar-hover: #0a1f3d;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Override Tailwind indigo with custom blue */
        .bg-indigo-600 { background-color: var(--color-primary) !important; }
        .bg-indigo-50 { background-color: rgba(45, 156, 219, 0.1) !important; }
        .text-indigo-600 { color: var(--color-primary) !important; }
        .text-indigo-700 { color: var(--color-primary-dark) !important; }
        .border-indigo-200 { border-color: rgba(45, 156, 219, 0.3) !important; }
        .hover\:text-indigo-600:hover { color: var(--color-primary) !important; }
        .hover\:bg-indigo-50:hover { background-color: rgba(45, 156, 219, 0.1) !important; }

        /* ============================================
           DataTables Overrides
           ============================================ */
        table.dataTable {
            table-layout: fixed;
            font-size: 12px;
            border-collapse: separate;
            border-spacing: 0;
        }

        table.dataTable thead th {
            font-size: 12px;
            padding: 12px 8px;
            background-color: var(--color-primary) !important;
            color: white !important;
            font-weight: 600;
            border: none;
            text-align: center;
            white-space: normal;
            line-height: 1.3;
        }

        table.dataTable thead th:first-child {
            border-top-left-radius: 8px;
        }

        table.dataTable thead th:last-child {
            border-top-right-radius: 8px;
        }

        table.dataTable tbody td {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 12px;
            padding: 8px;
            border-bottom: 1px solid #e2e8f0;
        }

        /* Center aligned columns */
        table.dataTable tbody td.dt-center {
            text-align: center;
        }

        /* Left aligned columns */
        table.dataTable tbody td.dt-left {
            text-align: left;
        }

        table.dataTable tbody tr {
            background-color: white;
            transition: background-color 0.15s ease;
        }

        table.dataTable tbody tr:hover {
            background-color: #f8fafc;
        }

        /* Percentage Bar Styling */
        .percentage-bar {
            height: 20px;
            background-color: #e2e8f0;
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            margin: 0 auto;
            width: 90%;
        }

        .percentage-bar > div {
            height: 100%;
            position: absolute;
            left: 0;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .percentage-bar span {
            position: absolute;
            width: 100%;
            text-align: center;
            line-height: 20px;
            color: #1e293b;
            font-weight: 600;
            font-size: 11px;
            z-index: 1;
            left: 0;
        }

        /* Order link styling */
        .order-link {
            color: var(--color-primary);
            text-decoration: none;
            font-weight: 600;
            transition: color 0.2s ease;
        }

        .order-link:hover {
            color: var(--color-primary-dark);
            text-decoration: underline;
        }

        /* DataTables wrapper styling */
        .dataTables_wrapper .dataTables_length {
            float: left;
            margin-bottom: 16px;
        }

        .dataTables_wrapper .dataTables_filter {
            float: right;
            margin-bottom: 16px;
        }

        .dataTables_wrapper .dataTables_filter input {
            margin-left: 8px;
            padding: 6px 12px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 13px;
            transition: all 0.2s ease;
        }

        .dataTables_wrapper .dataTables_filter input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(45, 156, 219, 0.1);
        }

        .dataTables_wrapper .dataTables_info {
            color: #64748b;
            font-size: 13px;
        }

        .dataTables_wrapper .dataTables_paginate {
            color: #64748b;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button {
            padding: 4px 12px;
            margin-left: 4px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            background-color: white;
            color: #475569 !important;
            transition: all 0.2s ease;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
            background-color: var(--color-primary) !important;
            color: white !important;
            border-color: var(--color-primary);
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            background-color: var(--color-primary) !important;
            color: white !important;
            border-color: var(--color-primary);
        }
    </style>
</head>
<body class="bg-slate-50">
    <div class="flex flex-col h-screen">
        <!-- Header (matching Sales Dashboard) -->
        <header id="headerContainer" class="h-20 bg-white border-b border-slate-200 px-8 flex items-center justify-between flex-shrink-0 z-20 shadow-sm">
            <div class="flex items-center gap-6">
                <div>
                    <h1 class="text-xl font-bold text-slate-900">Back Order Dashboard</h1>
                    <p class="text-xs text-slate-500 mt-0.5">Real-time backorder monitoring and fulfillment tracking</p>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <!-- Help Button -->
                <button onclick="toggleInstructions()" class="px-3 py-2 bg-slate-100 hover:bg-slate-200 border border-slate-300 rounded-lg text-sm font-medium transition-colors" title="View Usage Guide">
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Help
                </button>

                <!-- Refresh Button -->
                <button onclick="refreshData()" class="p-2.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-xl transition-all" title="Refresh Data">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                </button>
            </div>
        </header>

        <!-- Content Area -->
        <div class="flex-1 overflow-y-auto custom-scrollbar p-4 lg:p-8">
            <!-- Instructions Panel (hidden by default) -->
            <div id="instructionsPanel" class="bg-white rounded-2xl shadow-md border border-slate-300 p-6 mb-6" style="display: none;">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Usage Guide
                    </h2>
                    <button onclick="toggleInstructions()" class="text-slate-400 hover:text-slate-600 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-sm font-bold text-slate-700 mb-2">Report Purpose</h3>
                        <p class="text-sm text-slate-600 mb-4">This dashboard displays backorder status, fulfillment progress, and inventory availability for orders that cannot be fully fulfilled from current stock.</p>

                        <h3 class="text-sm font-bold text-slate-700 mb-2">Order Status Types</h3>
                        <div class="text-sm text-slate-600 space-y-1">
                            <p><strong>Progress Order:</strong> Partial fulfillment in progress</p>
                            <p><strong>New Backorder:</strong> Recently identified backorder</p>
                            <p><strong>Backorder:</strong> Awaiting stock replenishment</p>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-sm font-bold text-slate-700 mb-3">Progress Indicators</h3>
                        <p class="text-sm text-slate-600 mb-3">Progress bars show completion percentages:</p>
                        <div class="text-sm text-slate-600 space-y-1">
                            <p><strong>Payment Made:</strong> Payment received vs total amount</p>
                            <p><strong>In Stock:</strong> Items currently available</p>
                            <p><strong>Picked:</strong> Items picked from warehouse</p>
                            <p><strong>Shipped:</strong> Items shipped to customer</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Table Container -->
            <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                <table id="order-table" class="display" style="width:100%">
                    <thead>
                        <tr>
                            <th>Order Status</th>
                            <th>Order Number</th>
                            <th>Order Date</th>
                            <th>Priority</th>
                            <th>Carrier</th>
                            <th>Customer Name</th>
                            <th>Customer Type</th>
                            <th>Terms</th>
                            <th>Payment Type</th>
                            <th>Fraud Level</th>
                            <th>Payment Made</th>
                            <th>In Stock</th>
                            <th>Next Exp. Stock</th>
                            <th>Picked</th>
                            <th>Shipped</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Helper function to create percentage bars
        function createPercentageBar(value) {
            const percentageBar = document.createElement('div');
            percentageBar.classList.add('percentage-bar');

            const bar = document.createElement('div');
            bar.style.width = (value * 100) + '%';

            // Set the bar color based on the value
            if (value < 0.5) {
                bar.style.backgroundColor = '#ef4444';  // Red for values below 50%
            } else {
                bar.style.backgroundColor = '#10b981';  // Green for values 50% and above
            }

            // Create a span element to show the percentage text
            const percentageText = document.createElement('span');
            percentageText.textContent = Math.round(value * 100) + '%';

            // Append the bar and text to the outer div
            percentageBar.appendChild(bar);
            percentageBar.appendChild(percentageText);

            return percentageBar;
        }

        // Function to open picking module
        function openPick() {
            openModule("Picking", "");
        }

        // Function to fetch data
        async function getData() {
            let query = `SELECT
        CASE WHEN UNIONALL.Type = 'PBO' THEN 'Progress Order' WHEN UNIONALL.Type = 'NBO' THEN 'New Backorder' ELSE 'Backorder' END AS Order_Status,
        Pick.Num AS Order_Number,
        Pick.Id as objectId,
        Pick.DateScheduled AS Order_Date,
        SUBSTRING(
            Priority.Name,
            LOCATE('-', Priority.Name)+ 1
        ) AS Priority,
        Carrier.Name AS Carrier,
        Customer.Name AS Customer_Name,
        Coalesce(AccountGroup.Name,'') AS CustomerType,
        Coalesce(PaymentTerms.Name,'') AS Terms,
        Coalesce(PaymentMethod.Name,'') AS Payment_Type,
        '' AS Fraud_Level,
        COALESCE(
            IF(
                ROUND(
                    (
                        SELECT
                            SUM(PosTransaction.Amount)
                        FROM
                            posTransaction
                        WHERE
                            posTransaction.SoId = So.Id
                    )
                )/ ROUND(So.TotalPrice) > 1,
                1,
                ROUND(
                    (
                        SELECT
                            SUM(PosTransaction.Amount)
                        FROM
                            posTransaction
                        WHERE
                            posTransaction.SoId = So.Id
                    )
                )/ ROUND(So.TotalPrice)
            ),
            0
        ) AS Payment_Made,
        ROUND(
            (
                SELECT
                    SUM(
                        CASE WHEN subsp1.Qty > sp1.Qty THEN LEAST(subsp1.Qty, sp1.Qty) ELSE subsp1.Qty END
                    )
                FROM
                    pickitem sp1
                    JOIN (
                        SELECT
                            part.id AS partid,
                            COALESCE(
                                (
                                    SELECT
                                        SUM(QohView.Qty)
                                    FROM
                                        QohView
                                    WHERE
                                        QohView.PartId = part.Id
                                        AND QohView.LocationGroupId = 1
                                ),
                                0
                            ) - COALESCE(
                                (
                                    SELECT
                                        SUM(QtyCommitted.Qty)
                                    FROM
                                        QtyCommitted
                                    WHERE
                                        QtyCommitted.PartId = part.Id
                                        AND QtyCommitted.LocationGroupId = 1
                                ),
                                0
                            ) - COALESCE(
                                (
                                    SELECT
                                        SUM(QtyNotAvailableToPick.Qty)
                                    FROM
                                        QtyNotAvailableToPick
                                    WHERE
                                        QtyNotAvailableToPick.PartId = part.Id
                                        AND QtyNotAvailableToPick.LocationGroupId = 1
                                ),
                                0
                            ) AS Qty
                        FROM
                            part
                        WHERE
                            part.typeid = 10
                    ) AS subsp1 ON subsp1.partid = sp1.partid
                WHERE
                    sp1.pickId = pick.id
                    AND sp1.statusId NOT IN (40)
            ) / SUM(
                IF(
                    PickItem.StatusId NOT IN (40),
                    pickitem.Qty,
                    0
                )
            ),
            2
        ) AS In_Stock,
        (
            SELECT
                MIN(
                    PoItem.dateScheduledFulfillment
                )
            FROM
                Po
                JOIN poitem ON poitem.poid = po.id
            WHERE
                poitem.StatusId = 10
                AND po.statusid > 10
                AND poitem.typeid = 10
                AND poitem.partid IN (
                    SELECT
                        sp1.partid
                    FROM
                        pickitem sp1
                    WHERE
                        sp1.pickid = pick.id
                )
        ) AS Next_Inbound,
        ROUND(
            (
                SUM(soitem.QtyPicked)+ SUM(
                    IF(
                        PickItem.StatusId = 30, pickitem.Qty,
                        0
                    )
                )
            )/ SUM(soitem.QtyToFulFill),
            2
        ) AS Picked,
        ROUND(
            SUM(soitem.QtyFulFilled)/ SUM(soitem.QtyToFulFill),
            2
        ) AS Shipped,
        So.Note AS Notes

    FROM
        (
            SELECT
                *
            FROM
                (
                    SELECT
                        'NBO' AS TYPE,
                        Pick.Id AS PickId,
                        SUM(
                            CASE WHEN k.AvailableToPick > 0 THEN LEAST(k.AvailableToPick, PickItem.Qty) ELSE 0 END
                        ) AS Pickable
                    FROM
                        Pick
                        JOIN PickItem ON PickItem.PickId = Pick.Id
                        /* Available to Pick Per Part */
                        LEFT JOIN (
                            SELECT
                                Part.Id AS PartId,
                                COALESCE(
                                    (
                                        SELECT
                                            SUM(QohView.Qty)
                                        FROM
                                            QohView
                                        WHERE
                                            QohView.PartId = Part.Id
                                            AND QohView.LocationGroupId = 1
                                    ),
                                    0
                                ) - COALESCE(
                                    (
                                        SELECT
                                            SUM(QtyCommitted.Qty)
                                        FROM
                                            QtyCommitted
                                        WHERE
                                            QtyCommitted.PartId = Part.Id
                                            AND QtyCommitted.LocationGroupId = 1
                                    ),
                                    0
                                ) - COALESCE(
                                    (
                                        SELECT
                                            SUM(QtyNotAvailableToPick.Qty)
                                        FROM
                                            QtyNotAvailableToPick
                                        WHERE
                                            QtyNotAvailableToPick.PartId = Part.Id
                                            AND QtyNotAvailableToPick.LocationGroupId = 1
                                    ),
                                    0
                                ) AS AvailableToPick
                            FROM
                                Part
                            WHERE
                                Part.TypeId = 10
                            GROUP BY
                                Part.Id
                        ) AS k ON k.PartId = PickItem.PartId
                    WHERE
                        (
                            NOT EXISTS (
                                SELECT
                                    1
                                FROM
                                    PickItem pi
                                WHERE
                                    pi.PickId = Pick.Id
                                    AND pi.StatusId IN (20, 30, 40)
                            )
                            AND NOT EXISTS (
                                SELECT
                                    GROUP_CONCAT(DISTINCT pi.StatusId) AS t
                                FROM
                                    PickItem pi
                                WHERE
                                    pi.PickId = Pick.Id
                                GROUP BY
                                    pi.PickId
                                HAVING
                                    t = 10
                            )
                            AND EXISTS (
                                SELECT
                                    1
                                FROM
                                    PickItem
                                    JOIN Part ON Part.Id = PickItem.PartId
                                WHERE
                                    PickItem.PickId = Pick.Id
                                    AND PickItem.StatusId != 40
                                    AND (
                                        COALESCE(
                                            (
                                                SELECT
                                                    SUM(QohView.Qty)
                                                FROM
                                                    QohView
                                                WHERE
                                                    QohView.PartId = Part.Id
                                                    AND QohView.LocationGroupId = 1
                                            ),
                                            0
                                        ) - COALESCE(
                                            (
                                                SELECT
                                                    SUM(QtyCommitted.Qty)
                                                FROM
                                                    QtyCommitted
                                                WHERE
                                                    QtyCommitted.PartId = Part.Id
                                                    AND QtyCommitted.LocationGroupId = 1
                                            ),
                                            0
                                        ) - COALESCE(
                                            (
                                                SELECT
                                                    SUM(QtyNotAvailableToPick.Qty)
                                                FROM
                                                    QtyNotAvailableToPick
                                                WHERE
                                                    QtyNotAvailableToPick.PartId = Part.Id
                                                    AND QtyNotAvailableToPick.LocationGroupId = 1
                                            ),
                                            0
                                        ) > 0
                                    )
                            )
                        )
                    GROUP BY
                        Pick.Id,
                        Pick.Num
                    HAVING
                        Pickable > 0
                ) AS NBO
            UNION ALL
            SELECT
                *
            FROM
                (
                    SELECT
                        'PBO',
                        Pick.Id,
                        SUM(
                            CASE WHEN k.AvailableToPick > 0 THEN LEAST(k.AvailableToPick, PickItem.Qty) ELSE 0 END
                        ) AS pickable
                    FROM
                        Pick
                        JOIN PickItem ON PickItem.PickId = Pick.Id
                        /* Available to Pick Per Part */
                        LEFT JOIN (
                            SELECT
                                Part.Id AS PartId,
                                COALESCE(
                                    (
                                        SELECT
                                            SUM(QohView.Qty)
                                        FROM
                                            QohView
                                        WHERE
                                            QohView.PartId = Part.Id
                                            AND QohView.LocationGroupId = 1
                                    ),
                                    0
                                ) - COALESCE(
                                    (
                                        SELECT
                                            SUM(QtyCommitted.Qty)
                                        FROM
                                            QtyCommitted
                                        WHERE
                                            QtyCommitted.PartId = Part.Id
                                            AND QtyCommitted.LocationGroupId = 1
                                    ),
                                    0
                                ) - COALESCE(
                                    (
                                        SELECT
                                            SUM(QtyNotAvailableToPick.Qty)
                                        FROM
                                            QtyNotAvailableToPick
                                        WHERE
                                            QtyNotAvailableToPick.PartId = Part.Id
                                            AND QtyNotAvailableToPick.LocationGroupId = 1
                                    ),
                                    0
                                ) AS AvailableToPick
                            FROM
                                Part
                            WHERE
                                Part.TypeId = 10
                            GROUP BY
                                Part.Id
                        ) AS k ON k.PartId = PickItem.PartId
                    WHERE
                        Pick.StatusId != 40
                        AND (
                            EXISTS (
                                SELECT
                                    1
                                FROM
                                    PickItem pi
                                WHERE
                                    pi.PickId = Pick.Id
                                    AND pi.StatusId IN (30, 40)
                            )
                            AND NOT EXISTS (
                                SELECT
                                    GROUP_CONCAT(DISTINCT pi.StatusId) AS t
                                FROM
                                    PickItem pi
                                WHERE
                                    pi.PickId = Pick.Id
                                GROUP BY
                                    pi.PickId
                                HAVING
                                    t = 10
                            )
                            AND EXISTS (
                                SELECT
                                    1
                                FROM
                                    PickItem
                                    JOIN Part ON Part.Id = PickItem.PartId
                                WHERE
                                    PickItem.PickId = Pick.Id
                                    AND pickitem.statusId NOT IN (30, 40)
                                    AND (
                                        COALESCE(
                                            (
                                                SELECT
                                                    SUM(QohView.Qty)
                                                FROM
                                                    QohView
                                                WHERE
                                                    QohView.PartId = Part.Id
                                                    AND QohView.LocationGroupId = 1
                                            ),
                                            0
                                        ) - COALESCE(
                                            (
                                                SELECT
                                                    SUM(QtyCommitted.Qty)
                                                FROM
                                                    QtyCommitted
                                                WHERE
                                                    QtyCommitted.PartId = Part.Id
                                                    AND QtyCommitted.LocationGroupId = 1
                                            ),
                                            0
                                        ) - COALESCE(
                                            (
                                                SELECT
                                                    SUM(QtyNotAvailableToPick.Qty)
                                                FROM
                                                    QtyNotAvailableToPick
                                                WHERE
                                                    QtyNotAvailableToPick.PartId = Part.Id
                                                    AND QtyNotAvailableToPick.LocationGroupId = 1
                                            ),
                                            0
                                        ) > 0
                                    )
                            )
                        )
                    GROUP BY
                        Pick.Id,
                        Pick.Num
                    HAVING
                        Pickable > 0
                ) AS PBO
            UNION ALL
            SELECT
                *
            FROM
                (
                    SELECT
                        'BO',
                        Pick.Id,
                        SUM(
                            CASE WHEN k.AvailableToPick > 0 THEN LEAST(k.AvailableToPick, PickItem.Qty) ELSE 0 END
                        ) AS pickable
                    FROM
                        Pick
                        JOIN PickItem ON PickItem.PickId = Pick.Id
                        AND PickItem.StatusId NOT IN (30, 40)
                        /* Available to Pick Per Part */
                        LEFT JOIN (
                            SELECT
                                Part.Id AS PartId,
                                COALESCE(
                                    (
                                        SELECT
                                            SUM(QohView.Qty)
                                        FROM
                                            QohView
                                        WHERE
                                            QohView.PartId = Part.Id
                                            AND QohView.LocationGroupId = 1
                                    ),
                                    0
                                ) - COALESCE(
                                    (
                                        SELECT
                                            SUM(QtyCommitted.Qty)
                                        FROM
                                            QtyCommitted
                                        WHERE
                                            QtyCommitted.PartId = Part.Id
                                            AND QtyCommitted.LocationGroupId = 1
                                    ),
                                    0
                                ) - COALESCE(
                                    (
                                        SELECT
                                            SUM(QtyNotAvailableToPick.Qty)
                                        FROM
                                            QtyNotAvailableToPick
                                        WHERE
                                            QtyNotAvailableToPick.PartId = Part.Id
                                            AND QtyNotAvailableToPick.LocationGroupId = 1
                                    ),
                                    0
                                ) AS AvailableToPick
                            FROM
                                Part
                            WHERE
                                Part.TypeId = 10
                            GROUP BY
                                Part.Id
                        ) AS k ON k.PartId = PickItem.PartId
                    WHERE
                        Pick.StatusId != 40
                        AND EXISTS (
                            SELECT
                                1
                            FROM
                                PickItem pi
                            WHERE
                                pi.PickId = Pick.Id
                                AND pi.StatusId IN (30, 40)
                        )
                        AND NOT EXISTS (
                            SELECT
                                GROUP_CONCAT(DISTINCT pi.StatusId) AS t
                            FROM
                                PickItem pi
                            WHERE
                                pi.PickId = Pick.Id
                            GROUP BY
                                pi.PickId
                            HAVING
                                t = 10
                        )
                        AND EXISTS (
                            SELECT
                                1
                            FROM
                                PickItem pi
                                JOIN Part ON Part.Id = pi.PartId
                            WHERE
                                pi.PickId = Pick.Id
                                AND pi.statusId NOT IN (30, 40)
                                AND (
                                    COALESCE(
                                        (
                                            SELECT
                                                SUM(QohView.Qty)
                                            FROM
                                                QohView
                                            WHERE
                                                QohView.PartId = Part.Id
                                                AND QohView.LocationGroupId = 1
                                        ),
                                        0
                                    ) - COALESCE(
                                        (
                                            SELECT
                                                SUM(QtyCommitted.Qty)
                                            FROM
                                                QtyCommitted
                                            WHERE
                                                QtyCommitted.PartId = Part.Id
                                                AND QtyCommitted.LocationGroupId = 1
                                        ),
                                        0
                                    ) - COALESCE(
                                        (
                                            SELECT
                                                SUM(QtyNotAvailableToPick.Qty)
                                            FROM
                                                QtyNotAvailableToPick
                                            WHERE
                                                QtyNotAvailableToPick.PartId = Part.Id
                                                AND QtyNotAvailableToPick.LocationGroupId = 1
                                        ),
                                        0
                                    ) <= 0
                                )
                        )
                    GROUP BY
                        Pick.Id
                    HAVING
                        Pickable <= 0
                ) AS BO
        ) AS UNIONALL
        JOIN pick ON pick.id = UNIONALL.pickid
        JOIN Priority ON Priority.Id = Pick.Priority
        JOIN PickItem ON PickItem.PickId = Pick.Id
        JOIN Part ON Part.Id = PickItem.PartId
        JOIN SoItem ON SoItem.Id = PickItem.SoItemId
        JOIN So ON So.ID = SoItem.SoId
        LEFT JOIN PosTransaction ON PosTransaction.SoId = So.Id
        LEFT JOIN PaymentMethod ON PaymentMethod.Id = PosTransaction.PaymentMethodId
        JOIN PaymentTerms ON PaymentTerms.Id = So.PaymentTermsId
        JOIN Customer ON Customer.Id = So.CustomerId
        LEFT JOIN AccountGroupRelation ON AccountGroupRelation.AccountId = Customer.AccountId
        LEFT JOIN AccountGroup ON AccountGroup.Id = AccountGroupRelation.GroupId
        JOIN Carrier ON Carrier.Id = So.CarrierId
    GROUP BY
        2
    ORDER BY
        CASE WHEN UNIONALL.Type = 'PBO' THEN 1 WHEN UNIONALL.Type = 'NBO' THEN 2 ELSE 3 END`;

            let dataset = await runQuery(query);
            return JSON.parse(dataset);
        }

        // Initialize DataTable
        $(document).ready(async function () {
            let dataset = await getData();

            $('#order-table').DataTable({
                data: dataset,
                columns: [
                    { title: 'Order Status', data: 'order_status', className: 'dt-left' },
                    {
                        title: 'Order Number',
                        data: 'order_number',
                        className: 'dt-center',
                        render: function (data, type, row) {
                            return '<a href="#" class="order-link" onclick="openPick()">' + data + '</a>';
                        }
                    },
                    {
                        title: 'Order Date',
                        data: 'order_date',
                        className: 'dt-center',
                        render: function(data, type, row) {
                            if (data) {
                                const date = new Date(data);
                                const day = String(date.getDate()).padStart(2, '0');
                                const month = String(date.getMonth() + 1).padStart(2, '0');
                                const year = date.getFullYear();
                                return `${day}/${month}/${year}`;
                            }
                            return '';
                        }
                    },
                    { title: 'Priority', data: 'priority', className: 'dt-center' },
                    { title: 'Carrier', data: 'carrier', className: 'dt-center' },
                    { title: 'Customer Name', data: 'customer_name', className: 'dt-left' },
                    { title: 'Customer Type', data: 'customertype', className: 'dt-center' },
                    { title: 'Terms', data: 'terms', className: 'dt-center' },
                    { title: 'Payment Type', data: 'payment_type', className: 'dt-center' },
                    { title: 'Fraud Level', data: 'fraud_level', className: 'dt-center' },
                    {
                        title: 'Payment Made',
                        data: 'payment_made',
                        className: 'dt-center',
                        render: function (data) {
                            return createPercentageBar(data).outerHTML;
                        }
                    },
                    {
                        title: 'In Stock',
                        data: 'in_stock',
                        className: 'dt-center',
                        render: function (data) {
                            return createPercentageBar(data).outerHTML;
                        }
                    },
                    {
                        title: 'Next Exp. Stock',
                        data: 'next_inbound',
                        className: 'dt-center',
                        render: function(data, type, row) {
                            if (data) {
                                const date = new Date(data);
                                const day = String(date.getDate()).padStart(2, '0');
                                const month = String(date.getMonth() + 1).padStart(2, '0');
                                const year = date.getFullYear();
                                return `${day}/${month}/${year}`;
                            }
                            return 'None Expected';
                        }
                    },
                    {
                        title: 'Picked',
                        data: 'picked',
                        className: 'dt-center',
                        render: function (data) {
                            return createPercentageBar(data).outerHTML;
                        }
                    },
                    {
                        title: 'Shipped',
                        data: 'shipped',
                        className: 'dt-center',
                        render: function (data) {
                            return createPercentageBar(data).outerHTML;
                        }
                    },
                    { title: 'Notes', data: 'notes', className: 'dt-left' }
                ],
                paging: true,
                searching: true,
                ordering: true,
                order: [[0, 'desc'], [2, 'desc']],
                pageLength: 25
            });
        });

        // Refresh function
        async function refreshData() {
            let dataset = await getData();
            let table = $('#order-table').DataTable();
            table.clear();
            table.rows.add(dataset);
            table.draw();
        }

        // Make refreshData globally accessible
        window.refreshData = refreshData;

        // Toggle instructions panel
        function toggleInstructions() {
            const panel = document.getElementById('instructionsPanel');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
            } else {
                panel.style.display = 'none';
            }
        }

        const displayHeader = true;
        let headerContainer = document.getElementById('headerContainer');
        displayHeader ? headerContainer.style.display = 'flex' : headerContainer.style.display = 'none';
    </script>
</body>
</html>
