<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Part, Product & Vendor Pricing Validator</title>

    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Fishbowl Modern Theme (overrides Bootstrap) -->
    <style>
        {% Style fishbowl-theme-modern %}
    </style>

    <style>
        /* Page-specific overrides and Bootstrap integration */
        h1 {
            text-align: center;
            margin-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            color: var(--fb-text-secondary);
            margin-bottom: 20px;
        }

        /* Upload section improvements */
        .upload-section {
            padding: 20px;
            background-color: var(--fb-primary-pale);
            border: 2px dashed var(--fb-primary);
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: var(--fb-primary-dark);
            background-color: #BBDEFB;
        }

        .upload-section.dragover {
            border-color: var(--fb-success);
            background-color: var(--fb-success-bg);
            border-style: solid;
        }

        .upload-section h3 {
            margin: 0 0 10px 0;
            color: var(--fb-primary-dark);
            font-size: 18px;
        }

        .upload-section p {
            margin: 5px 0;
            font-size: 14px;
        }

        /* Compact summary stats - inline badges */
        .summary-stats {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .stat-card {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .stat-card.total {
            background-color: var(--fb-info);
            color: white;
        }

        .stat-card.valid {
            background-color: var(--fb-success);
            color: white;
        }

        .stat-card.warning {
            background-color: var(--fb-warning);
            color: white;
        }

        .stat-card.error {
            background-color: var(--fb-danger);
            color: white;
        }

        .stat-number {
            font-size: 18px;
            font-weight: bold;
        }

        .stat-label {
            font-size: 13px;
            opacity: 0.95;
        }

        /* Results table with max height and scrolling */
        .results-table-container {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid var(--fb-border-light);
            border-radius: 6px;
            margin-bottom: 20px;
        }

        /* Issue action buttons - proper Bootstrap styling */
        .issue-action-btn {
            padding: 6px 12px;
            font-size: 13px;
            border-radius: 4px;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        /* Offcanvas customization */
        .offcanvas {
            background-color: white !important;
            box-shadow: -4px 0 12px rgba(0, 0, 0, 0.15);
        }

        .offcanvas.offcanvas-start {
            box-shadow: 4px 0 12px rgba(0, 0, 0, 0.15);
        }

        .offcanvas-header {
            background-color: var(--fb-primary);
            color: var(--fb-text-white);
            border-bottom: 2px solid var(--fb-primary-dark);
        }

        .offcanvas-title {
            color: var(--fb-text-white);
            font-weight: 600;
        }

        .btn-close {
            filter: brightness(0) invert(1);
        }

        /* Toolbar area - fixed at top */
        .toolbar-area {
            position: sticky;
            top: 0;
            z-index: 1020;
            background-color: white;
            border-bottom: 2px solid var(--fb-border-light);
            padding: 10px 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .toolbar-btn {
            margin: 0 5px;
        }

        /* Configuration settings styling */
        .config-group {
            margin-bottom: 20px;
            padding: 15px;
            background-color: var(--fb-gray-50);
            border-radius: 6px;
            border: 1px solid var(--fb-border-light);
        }

        .config-group h5 {
            color: var(--fb-primary-dark);
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .config-item {
            margin-bottom: 10px;
        }

        .config-item label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--fb-text-primary);
            margin-bottom: 5px;
        }

        .config-item input[type="number"],
        .config-item select {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid var(--fb-border-medium);
            border-radius: 4px;
            font-size: 13px;
        }

        .config-item small {
            color: var(--fb-text-secondary);
            font-size: 11px;
        }
    </style>
</head>
<body>
    <!-- Toolbar Buttons -->
    <div class="toolbar-area">
        <button class="btn btn-primary toolbar-btn" type="button" data-bs-toggle="offcanvas" data-bs-target="#settingsOffcanvas" aria-controls="settingsOffcanvas">
            <i class="bi bi-gear-fill"></i> Settings
        </button>
        <button class="btn btn-info toolbar-btn" type="button" data-bs-toggle="offcanvas" data-bs-target="#columnRefOffcanvas" aria-controls="columnRefOffcanvas">
            <i class="bi bi-book-fill"></i> Column Guide
        </button>
    </div>

    <!-- Left Offcanvas: Configuration Settings -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="settingsOffcanvas" aria-labelledby="settingsOffcanvasLabel" style="width: 380px;">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="settingsOffcanvasLabel"><i class="bi bi-gear-fill"></i> Configuration Settings</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <div class="config-group">
                <h5><i class="bi bi-speedometer2"></i> Performance Settings</h5>
                <div class="config-item">
                    <label for="batchSizeInput">Batch Size:</label>
                    <input type="number" id="batchSizeInput" value="200" min="50" max="1000" step="50" onchange="updateBatchSize(this.value)">
                    <small>Number of rows to process at a time (50-1000)</small>
                </div>
                <div class="config-item">
                    <label for="rowHeightInput">Row Height (px):</label>
                    <input type="number" id="rowHeightInput" value="35" min="25" max="60" step="5" onchange="updateRowHeight(this.value)">
                    <small>Approximate height of each table row (25-60px)</small>
                </div>
                <div class="config-item">
                    <label for="bufferRowsInput">Buffer Rows:</label>
                    <input type="number" id="bufferRowsInput" value="20" min="5" max="50" step="5" onchange="updateBufferRows(this.value)">
                    <small>Extra rows to render above/below viewport (5-50)</small>
                </div>
            </div>

            <div class="config-group">
                <h5><i class="bi bi-display"></i> Display Settings</h5>
                <div class="config-item">
                    <label for="virtualScrollThreshold">Virtual Scroll Threshold:</label>
                    <input type="number" id="virtualScrollThreshold" value="500" min="100" max="2000" step="100" onchange="updateVirtualScrollThreshold(this.value)">
                    <small>Enable virtual scrolling when rows exceed this number (100-2000)</small>
                </div>
                <div class="config-item">
                    <label for="debounceDelay">Debounce Delay (ms):</label>
                    <input type="number" id="debounceDelay" value="500" min="100" max="2000" step="100" onchange="updateDebounceDelay(this.value)">
                    <small>Delay before revalidating after edits (100-2000ms)</small>
                </div>
            </div>

            <div class="config-group">
                <h5><i class="bi bi-shield-check"></i> Validation Settings</h5>
                <div class="config-item">
                    <label for="strictMode">Strict Mode:</label>
                    <select id="strictMode" onchange="updateStrictMode(this.value)">
                        <option value="false">Normal (Warnings + Errors)</option>
                        <option value="true">Strict (Errors Only)</option>
                    </select>
                    <small>Choose validation strictness level</small>
                </div>
            </div>

            <div class="alert alert-info mt-3" style="font-size: 12px;">
                <i class="bi bi-info-circle-fill"></i> Changes take effect immediately. Refresh the page to reset to defaults.
            </div>
        </div>
    </div>

    <!-- Right Offcanvas: Column Reference Guide -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="columnRefOffcanvas" aria-labelledby="columnRefOffcanvasLabel" style="width: 450px;">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="columnRefOffcanvasLabel"><i class="bi bi-book-fill"></i> PPP Import Column Reference</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <div class="alert alert-info mb-3" style="font-size: 12px;">
                <i class="bi bi-info-circle-fill"></i> This guide describes all columns expected in the PPP import CSV file.
            </div>
            <div id="columnRefContent">
                <!-- Will be populated dynamically -->
            </div>
        </div>
    </div>

    <div class="container">
        <h1>Part, Product & Vendor Pricing Validator</h1>
        <p class="subtitle">Validate your PPP import CSV before importing to Fishbowl</p>

        <!-- Upload Section -->
        <div class="upload-section" id="uploadSection">
            <h3>üìÑ Upload PPP Import CSV</h3>
            <p>Drag and drop file here, or <button type="button" class="btn btn-primary" onclick="document.getElementById('fileInput').click()">Choose File</button></p>
            <input type="file" id="fileInput" accept=".csv" onchange="handleFileSelect(event)" />
            <p id="fileName" class="text-primary fw-bold"></p>
        </div>

        <!-- Summary Stats (hidden until file loaded) -->
        <div class="summary-stats hidden" id="summaryStats">
            <div class="stat-card total">
                <span class="stat-number" id="statTotal">0</span>
                <span class="stat-label">Total</span>
            </div>
            <div class="stat-card valid">
                <span class="stat-number" id="statValid">0</span>
                <span class="stat-label">Valid</span>
            </div>
            <div class="stat-card warning">
                <span class="stat-number" id="statWarning">0</span>
                <span class="stat-label">Warnings</span>
            </div>
            <div class="stat-card error">
                <span class="stat-number" id="statError">0</span>
                <span class="stat-label">Errors</span>
            </div>
        </div>

        <!-- Consolidated Issues Summary -->
        <div class="consolidated-issues hidden" id="consolidatedIssues">
            <h3>‚ö†Ô∏è Issues Summary</h3>
            <div id="consolidatedIssuesContent"></div>
        </div>

        <!-- Filter Controls -->
        <div class="filter-controls hidden" id="filterControls">
            <div class="row g-3 align-items-center">
                <div class="col-auto">
                    <label for="filterStatus" class="col-form-label fw-bold">Show:</label>
                </div>
                <div class="col-auto">
                    <select id="filterStatus" class="form-select" onchange="applyFilters()">
                        <option value="all">All Rows</option>
                        <option value="errors" selected>Errors Only</option>
                        <option value="warnings">Warnings Only</option>
                        <option value="valid">Valid Only</option>
                    </select>
                </div>
                <div class="col">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" id="searchInput" class="form-control" placeholder="Search by Part Number, Vendor, etc..." oninput="applyFilters()" />
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Table -->
        <div class="results-section hidden" id="resultsSection">
            <div class="results-table-container">
                <table class="table table-sm table-hover results-table" id="resultsTable">
                    <thead id="tableHeader" class="table-primary sticky-top">
                        <!-- Dynamic headers -->
                    </thead>
                    <tbody id="tableBody">
                        <!-- Dynamic rows -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons hidden" id="actionButtons">
            <div class="d-flex gap-2 flex-wrap justify-content-center">
                <button type="button" class="btn btn-primary" onclick="revalidateData()">
                    <i class="bi bi-arrow-clockwise"></i> Re-validate
                </button>
                <button type="button" class="btn btn-success" onclick="exportValidRows()" id="exportValidBtn">
                    <i class="bi bi-check-circle"></i> Export Valid Rows
                </button>
                <button type="button" class="btn btn-warning" onclick="exportAllWithFixes()" id="exportAllBtn">
                    <i class="bi bi-pencil-square"></i> Export All (with suggestions)
                </button>
                <button type="button" class="btn btn-success" onclick="importToFishbowl()" id="importBtn">
                    <i class="bi bi-download"></i> Import to Fishbowl
                </button>
                <button type="button" class="btn btn-secondary" onclick="clearData()">
                    <i class="bi bi-trash"></i> Clear
                </button>
            </div>
        </div>

        <!-- Column Reference -->
        <!-- Column reference moved to offcanvas -->

        <!-- Debug Console -->
        <div class="debug-console mt-4">
            <div class="card bg-dark text-success">
                <div class="card-header bg-dark border-success d-flex justify-content-between align-items-center"
                     onclick="toggleDebugConsole()" style="cursor: pointer; font-family: 'Courier New', monospace;">
                    <span><span id="debugToggle">‚ñ∂</span> Debug Console</span>
                    <button type="button" class="btn btn-sm btn-outline-light" onclick="clearDebugConsole(); event.stopPropagation();">
                        <i class="bi bi-trash"></i> Clear
                    </button>
                </div>
                <div id="debugConsoleContent" class="hidden card-body bg-dark text-light"
                     style="font-family: 'Courier New', monospace; font-size: 12px; max-height: 300px; overflow-y: auto;">
                    <!-- Debug messages will appear here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay hidden" id="loadingOverlay">
        <div class="text-center">
            <div class="spinner-border text-primary loading-spinner" role="status" style="width: 4rem; height: 4rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="loading-text mt-3 fs-5 fw-bold text-white" id="loadingText">Processing file...</div>
            <div id="progressBarContainer" class="hidden mt-3" style="width: 300px; margin-left: auto; margin-right: auto;">
                <div class="progress" style="height: 20px;">
                    <div id="progressBar" class="progress-bar bg-success progress-bar-striped progress-bar-animated"
                         role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
            <div id="progressText" class="hidden mt-2 text-white">0 / 0 rows</div>
        </div>
    </div>

    <script>
    // ============================================
    // Debug Console Functions
    // ============================================

    function debugLog(message, type = 'log') {
        const timestamp = new Date().toLocaleTimeString();
        const colors = {
            log: '#d4d4d4',
            info: '#4fc3f7',
            warn: '#ffb74d',
            error: '#ff6b6b',
            success: '#66bb6a'
        };

        const consoleContent = document.getElementById('debugConsoleContent');
        if (consoleContent) {
            const logEntry = document.createElement('div');
            logEntry.style.color = colors[type] || colors.log;
            logEntry.style.marginBottom = '4px';
            logEntry.style.borderBottom = '1px solid #2a2a2a';
            logEntry.style.paddingBottom = '4px';

            // Create type label mapping without toUpperCase
            const typeLabels = {
                log: 'LOG    ',
                info: 'INFO   ',
                warn: 'WARN   ',
                error: 'ERROR  ',
                success: 'SUCCESS'
            };
            const typeLabel = typeLabels[type] || 'LOG    ';

            logEntry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> <span style="color: ${colors[type]};">[${typeLabel}]</span> ${escapeHtml(String(message))}`;

            consoleContent.appendChild(logEntry);
            consoleContent.scrollTop = consoleContent.scrollHeight;
        }
    }

    function toggleDebugConsole() {
        const content = document.getElementById('debugConsoleContent');
        const toggle = document.getElementById('debugToggle');

        if (content.classList.contains('hidden')) {
            content.classList.remove('hidden');
            toggle.textContent = '‚ñº';
        } else {
            content.classList.add('hidden');
            toggle.textContent = '‚ñ∂';
        }
    }

    function clearDebugConsole() {
        const consoleContent = document.getElementById('debugConsoleContent');
        if (consoleContent) {
            consoleContent.innerHTML = '';
        }
    }

    // Override console methods to also write to debug console
    const originalConsole = {
        log: console.log,
        error: console.error,
        warn: console.warn,
        info: console.info
    };

    console.log = function(...args) {
        debugLog(args.join(' '), 'log');
        originalConsole.log.apply(console, args);
    };

    console.error = function(...args) {
        debugLog(args.join(' '), 'error');
        originalConsole.error.apply(console, args);
    };

    console.warn = function(...args) {
        debugLog(args.join(' '), 'warn');
        originalConsole.warn.apply(console, args);
    };

    console.info = function(...args) {
        debugLog(args.join(' '), 'info');
        originalConsole.info.apply(console, args);
    };

    // Global error handler
    window.onerror = function(message, source, lineno, colno, error) {
        debugLog(`JavaScript Error: ${message} at line ${lineno}:${colno}`, 'error');
        if (error && error.stack) {
            debugLog(`Stack: ${error.stack}`, 'error');
        }
        return false; // Allow default error handling
    };

    // Unhandled promise rejection handler
    window.onunhandledrejection = function(event) {
        debugLog(`Unhandled Promise Rejection: ${event.reason}`, 'error');
    };

    // ============================================
    // Performance Utility Functions
    // ============================================

    function showProgress(current, total) {
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const progressBarContainer = document.getElementById('progressBarContainer');

        if (progressBar && progressText && progressBarContainer) {
            progressBarContainer.classList.remove('hidden');
            progressText.classList.remove('hidden');

            const percent = Math.round((current / total) * 100);
            progressBar.style.width = percent + '%';
            progressText.textContent = `${current} / ${total} rows (${percent}%)`;
        }
    }

    function hideProgress() {
        const progressBarContainer = document.getElementById('progressBarContainer');
        const progressText = document.getElementById('progressText');

        if (progressBarContainer && progressText) {
            progressBarContainer.classList.add('hidden');
            progressText.classList.add('hidden');
        }
    }

    // Debounce function to delay execution
    function debounce(func, delay) {
        return function(...args) {
            if (debounceTimer) {
                clearTimeout(debounceTimer);
            }
            debounceTimer = setTimeout(() => {
                func.apply(this, args);
            }, delay);
        };
    }

    // Sleep function for batch processing
    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    // ============================================
    // Configuration & Column Definitions
    // ============================================

    const PPP_COLUMNS = {
        // Part Information - Core (Required fields marked)
        'PartNumber': { type: 'Text', required: true, desc: 'Unique part identifier (70 chars max) - REQUIRED' },
        'PartDescription': { type: 'Text', required: true, desc: 'Part description (252 chars max) - REQUIRED' },
        'PartDetails': { type: 'Text', required: false, desc: 'Additional part details (no limit)' },
        'UOM': { type: 'Text', required: true, desc: 'Default Unit of Measure (10 chars max) - REQUIRED', validateUOM: true },
        'UPC': { type: 'Text', required: false, desc: 'Universal Product Code (31 chars max)' },
        'PartTypeID': { type: 'Integer', required: true, desc: 'Part type ID - REQUIRED: 10=INVENTORY, 20=SERVICE, 21=LABOR, 22=OVERHEAD, 30=NON_INVENTORY, 40=INTERNAL_USE, 50=CAPITAL, 60=SHIPPING', validValues: ['10', '20', '21', '22', '30', '40', '50', '60'] },
        'Active': { type: 'Text', required: true, desc: 'Whether part is active (text field) - REQUIRED' },
        'PartTaxCode': { type: 'Text', required: true, desc: 'Tax code for the part - REQUIRED', validateTaxCode: true },
        'StdCost': { type: 'Decimal', required: false, desc: 'Standard cost (numeric)' },

        // Part - Tracking Flags (all Text type in Fishbowl)
        'Tracks-Lot Number': { type: 'Text', required: false, desc: 'Indicates if the part tracks lot numbers' },
        'Tracks-Revision Level': { type: 'Text', required: false, desc: 'Indicates if the part tracks revision levels' },
        'Tracks-Expiration Date': { type: 'Text', required: false, desc: 'Indicates if the part tracks expiration dates' },
        'Tracks-Serial Number': { type: 'Text', required: false, desc: 'Indicates if the part tracks serial numbers' },
        'Tracks-Batch Number': { type: 'Text', required: false, desc: 'Indicates if the part tracks batch numbers' },
        'Tracks-BoxID-Qty': { type: 'Text', required: false, desc: 'Indicates if the part tracks BoxID quantity' },
        'Tracks-BoxID-count': { type: 'Text', required: false, desc: 'Indicates if the part tracks BoxID count' },
        'Tracks-BoxID-money': { type: 'Text', required: false, desc: 'Indicates if the part tracks BoxID money' },
        'Tracks-Consignment': { type: 'Text', required: false, desc: 'Indicates if the part tracks consignment' },
        'Next Value-': { type: 'Text', required: false, desc: 'The next value for tracking' },

        // Accounting
        'AssetAccount': { type: 'Text', required: false, desc: 'Inventory asset account' },
        'COGSAccount': { type: 'Text', required: false, desc: 'Cost of goods sold account' },
        'AdjustmentAccount': { type: 'Text', required: false, desc: 'Adjustment account' },
        'ScrapAccount': { type: 'Text', required: false, desc: 'Scrap account' },
        'VarianceAccount': { type: 'Text', required: false, desc: 'Variance account' },
        'ABCCode': { type: 'Text', required: false, desc: 'ABC code classification' },

        // Part - Physical Properties (all Text type)
        'Weight': { type: 'Text', required: false, desc: 'Part weight' },
        'WeightUOM': { type: 'Text', required: false, desc: 'Weight unit of measure', validateUOM: true },
        'Width': { type: 'Text', required: false, desc: 'Part width' },
        'Height': { type: 'Text', required: false, desc: 'Part height' },
        'Len': { type: 'Text', required: false, desc: 'Part length' },
        'SizeUOM': { type: 'Text', required: false, desc: 'Size unit of measure', validateUOM: true },
        'ConsumptionRate': { type: 'Decimal', required: false, desc: 'Consumption rate (numeric)' },

        // Part - Other
        'PartURL': { type: 'Text', required: false, desc: 'URL for the part' },
        'PartRevision': { type: 'Text', required: false, desc: 'Part revision' },
        'PartPictureURL': { type: 'Text', required: false, desc: 'URL to part picture (import only)' },

        // Product Information
        'ProductNumber': { type: 'Text', required: false, desc: 'Product number (70 chars max)' },
        'ProductDescription': { type: 'Text', required: false, desc: 'Product description (252 chars max)' },
        'ProductDetails': { type: 'Text', required: false, desc: 'Additional product details (no limit)' },
        'Price': { type: 'Decimal', required: false, desc: 'Product price (numeric)' },
        'ProductSKU': { type: 'Text', required: false, desc: 'Product SKU (31 chars max)' },
        'ProductUPC': { type: 'Text', required: false, desc: 'Product UPC code (31 chars max)' },
        'ProductActive': { type: 'Text', required: false, desc: 'Whether product is active' },
        'ProductTaxable': { type: 'Text', required: false, desc: 'Whether product is taxable' },
        'ProductSOItemTypeID': { type: 'Integer', required: false, desc: 'Product SO item type ID: 10=Sale, 12=Drop Ship, 20=Credit Return', validValues: ['10', '12', '20'] },
        'IncomeAccount': { type: 'Text', required: false, desc: 'Income account' },

        // Product - Physical Properties (all Text type)
        'ProductWeight': { type: 'Text', required: false, desc: 'Product weight' },
        'ProductWeightUOM': { type: 'Text', required: false, desc: 'Product weight UOM', validateUOM: true },
        'ProductWidth': { type: 'Text', required: false, desc: 'Product width' },
        'ProductHeight': { type: 'Text', required: false, desc: 'Product height' },
        'ProductLen': { type: 'Text', required: false, desc: 'Product length' },
        'ProductSizeUOM': { type: 'Text', required: false, desc: 'Product size UOM', validateUOM: true },
        'ProductPictureURL': { type: 'Text', required: false, desc: 'Product picture URL (import only)' },

        // Vendor Pricing Information
        'Vendor': { type: 'Text', required: false, desc: 'Vendor name (41 chars / 30 chars max)', validateVendor: true },
        'DefaultVendor': { type: 'Text', required: false, desc: 'Whether this is the default vendor' },
        'VendorPartNumber': { type: 'Text', required: false, desc: 'Vendor part number (70 chars / 30 chars max)' },
        'Cost': { type: 'Decimal', required: false, desc: 'Vendor cost (numeric)' },
        'VendorUOM': { type: 'Text', required: false, desc: 'Vendor UOM (10 chars max)', validateUOM: true }
    };

    // Global state
    let csvData = [];
    let csvHeaders = [];
    let validationResults = [];
    let consolidatedIssues = {};
    let fishbowlData = {
        uoms: [],
        uomDetails: [], // Full UOM details including type
        vendors: [],
        customFields: [],
        uomConversions: [],
        taxCodes: [],
        partTypes: []
    };

    // Performance optimization settings (configurable via settings offcanvas)
    let BATCH_SIZE = 200; // Process 200 rows at a time
    let ROW_HEIGHT = 35; // Approximate height of each table row in pixels
    let BUFFER_ROWS = 20; // Extra rows to render above/below viewport
    let VIRTUAL_SCROLL_THRESHOLD = 500; // Enable virtual scrolling when rows exceed this number
    let DEBOUNCE_DELAY = 500; // Delay before revalidating after edits
    let STRICT_MODE = false; // Validation strictness

    // Virtual scrolling state
    let virtualScrollState = {
        enabled: false,
        scrollTop: 0,
        viewportHeight: 500,
        totalRows: 0,
        visibleStartIndex: 0,
        visibleEndIndex: 0
    };

    // Sorting state
    let sortState = {
        column: null,
        direction: 'asc' // 'asc' or 'desc'
    };

    // Debounce timer
    let debounceTimer = null;

    // ============================================
    // Initialization
    // ============================================

    window.onload = function() {
        loadFishbowlReferenceData();
        populateColumnReference();
        setupDragAndDrop();
    };

    function setupDragAndDrop() {
        const uploadSection = document.getElementById('uploadSection');

        uploadSection.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.classList.remove('dragover');

            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].name.endsWith('.csv')) {
                processFile(files[0]);
            } else {
                alert('Please drop a CSV file.');
            }
        });
    }

    // ============================================
    // Fishbowl Data Loading
    // ============================================

    function loadFishbowlReferenceData() {
        try {
            // Load UOMs with type information
            console.log('Loading UOMs...');
            let uomQuery = `SELECT code, name, uomtype FROM uom WHERE activeflag = 1 ORDER BY code`;
            console.log('UOM query:', uomQuery);
            let uomResult = runQuery(uomQuery);
            console.log('UOM query result (raw):', uomResult);
            console.log('UOM result type:', typeof uomResult);
            console.log('UOM result is null?:', uomResult === null);
            console.log('UOM result is undefined?:', uomResult === undefined);
            console.log('UOM result is empty string?:', uomResult === '');

            if (!uomResult) {
                console.warn('UOM query returned null, undefined, or empty string');
                fishbowlData.uoms = [];
                fishbowlData.uomDetails = [];
            } else {
                let uoms = JSON.parse(uomResult);
                console.log('UOM query result (parsed):', uoms);
                if (uoms && !Array.isArray(uoms)) uoms = [uoms];
                fishbowlData.uoms = uoms.map(u => u.code);
                fishbowlData.uomDetails = uoms; // Store full details including type
            }

            // Load Vendors
            console.log('Loading Vendors...');
            let vendorQuery = `SELECT name FROM vendor WHERE activeflag = 1 ORDER BY name`;
            console.log('Vendor query:', vendorQuery);
            let vendorResult = runQuery(vendorQuery);
            console.log('Vendor query result (raw):', vendorResult);
            console.log('Vendor result type:', typeof vendorResult);

            if (!vendorResult) {
                console.warn('Vendor query returned null, undefined, or empty string');
                fishbowlData.vendors = [];
            } else {
                let vendors = JSON.parse(vendorResult);
                console.log('Vendor query result (parsed):', vendors);
                if (vendors && !Array.isArray(vendors)) vendors = [vendors];
                fishbowlData.vendors = vendors.map(v => v.name);
            }

            // Load Custom Fields (for Part)
            console.log('Loading Custom Fields...');
            let cfQuery = `SELECT name FROM customfield WHERE tableid IN (SELECT id FROM systables WHERE name = 'Part') AND activeflag = 1`;
            let cfResult = runQuery(cfQuery);
            console.log('Custom Field query result:', cfResult);
            let customFields = cfResult ? JSON.parse(cfResult) : [];
            if (customFields && !Array.isArray(customFields)) customFields = [customFields];
            fishbowlData.customFields = customFields.map(cf => cf.name);

            // Load UOM Conversions
            console.log('Loading UOM Conversions...');
            let convQuery = `SELECT
                u1.code as fromUom,
                u2.code as toUom
            FROM uomconversion uc
            INNER JOIN uom u1 ON uc.touomid = u1.id
            INNER JOIN uom u2 ON uc.fromuomid = u2.id`;
            let convResult = runQuery(convQuery);
            console.log('UOM Conversion query result:', convResult);
            let conversions = convResult ? JSON.parse(convResult) : [];
            if (conversions && !Array.isArray(conversions)) conversions = [conversions];
            fishbowlData.uomConversions = conversions.map(c => c.fromUom + '->' + c.toUom);

            // Load Tax Codes
            console.log('Loading Tax Codes...');
            let taxQuery = `SELECT code, name FROM taxrate WHERE activeflag = 1 ORDER BY name`;
            console.log('Tax query:', taxQuery);
            let taxResult = runQuery(taxQuery);
            console.log('Tax Code query result (raw):', taxResult);
            console.log('Tax Code result type:', typeof taxResult);

            if (!taxResult) {
                console.warn('Tax query returned null or undefined');
                fishbowlData.taxCodes = [];
            } else {
                let taxCodes = JSON.parse(taxResult);
                console.log('Tax Code query result (parsed):', taxCodes);
                if (taxCodes && !Array.isArray(taxCodes)) taxCodes = [taxCodes];
                fishbowlData.taxCodes = taxCodes; // Keep objects with code and name
            }

            // Load Part Types
            console.log('Loading Part Types...');
            let partTypeQuery = `SELECT id, name FROM parttype ORDER BY name`;
            console.log('Part Type query:', partTypeQuery);
            let partTypeResult = runQuery(partTypeQuery);
            console.log('Part Type query result (raw):', partTypeResult);

            if (!partTypeResult) {
                console.warn('Part Type query returned null or undefined');
                fishbowlData.partTypes = [];
            } else {
                let partTypes = JSON.parse(partTypeResult);
                console.log('Part Type query result (parsed):', partTypes);
                if (partTypes && !Array.isArray(partTypes)) partTypes = [partTypes];
                fishbowlData.partTypes = partTypes; // Keep objects with id and name
            }

            console.log('Loaded Fishbowl reference data:', {
                uoms: fishbowlData.uoms.length,
                vendors: fishbowlData.vendors.length,
                customFields: fishbowlData.customFields.length,
                uomConversions: fishbowlData.uomConversions.length,
                taxCodes: fishbowlData.taxCodes.length,
                partTypes: fishbowlData.partTypes.length
            });

        } catch (e) {
            console.error('Error loading Fishbowl reference data:', e);
            alert('Error loading reference data from Fishbowl: ' + e.message + '\n\nCheck console for details.');
            // Continue with empty data - validation will still work for format checks
        }
    }

    // ============================================
    // File Processing
    // ============================================

    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file) {
            processFile(file);
        }
    }

    function processFile(file) {
        showLoading('Reading file...');
        document.getElementById('fileName').textContent = file.name;

        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                showLoading('Parsing CSV...');
                parseCSV(e.target.result);

                showLoading('Validating data...');
                await validateData(); // Now async!

                showLoading('Rendering results...');
                renderResults();

                hideLoading();

            } catch (err) {
                hideLoading();
                hideProgress();
                alert('Error processing file: ' + err.message);
                console.error(err);
            }
        };
        reader.onerror = function() {
            hideLoading();
            alert('Error reading file');
        };
        reader.readAsText(file);
    }

    function parseCSV(text) {
        csvData = [];
        csvHeaders = [];

        // Handle different line endings
        const lines = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n');

        if (lines.length === 0) {
            throw new Error('Empty file');
        }

        // Parse header row
        csvHeaders = parseCSVLine(lines[0]);

        // Parse data rows
        for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (line === '') continue;

            const values = parseCSVLine(line);
            const row = { _rowNum: i + 1 };

            csvHeaders.forEach((header, index) => {
                row[header] = values[index] !== undefined ? values[index] : '';
            });

            csvData.push(row);
        }

        console.log('Parsed ' + csvData.length + ' rows with ' + csvHeaders.length + ' columns');
    }

    function parseCSVLine(line) {
        const result = [];
        let current = '';
        let inQuotes = false;

        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            const nextChar = line[i + 1];

            if (inQuotes) {
                if (char === '"' && nextChar === '"') {
                    // Escaped quote
                    current += '"';
                    i++;
                } else if (char === '"') {
                    // End of quoted field
                    inQuotes = false;
                } else {
                    current += char;
                }
            } else {
                if (char === '"') {
                    inQuotes = true;
                } else if (char === ',') {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
        }

        result.push(current.trim());
        return result;
    }

    // ============================================
    // Validation
    // ============================================

    // Validate a single row - helper function
    function validateRow(row, index, missingDeps) {
        const rowResult = {
            rowNum: row._rowNum,
            rowIndex: index,
            status: 'valid',
            errors: [],
            warnings: [],
            cellErrors: {},
            cellWarnings: {}
        };

        // Check all required fields - these generate WARNINGS
        const requiredFields = ['PartNumber', 'PartDescription', 'UOM', 'PartTypeID', 'Active', 'PartTaxCode'];
        requiredFields.forEach(field => {
            if (!row[field] || row[field].trim() === '') {
                rowResult.warnings.push({
                    field: field,
                    message: `Required field is missing`,
                    suggestion: `Provide a value for ${field}`
                });
                rowResult.cellWarnings[field] = true;
            }
        });

        // Validate each column - validation failures generate ERRORS
        csvHeaders.forEach(header => {
            const value = row[header];
            if (!value || value.trim() === '') return; // Skip empty values

            // Check if it's a custom field
            if (header.startsWith('CF-')) {
                const cfName = header.substring(3);
                if (fishbowlData.customFields.length > 0 && !fishbowlData.customFields.includes(cfName)) {
                    rowResult.errors.push({
                        field: header,
                        message: `Custom field "${cfName}" does not exist in Fishbowl`,
                        suggestion: 'Create this custom field in Fishbowl first, or remove this column'
                    });
                    rowResult.cellErrors[header] = true;
                    missingDeps.customFields.add(cfName);
                }
                return;
            }

            const colDef = PPP_COLUMNS[header];
            if (!colDef) {
                // Unknown column - Fishbowl will ignore it, we'll skip validation
                return;
            }

            // Type validation (only if value is not empty)
            const typeError = validateType(value, colDef.type, header);
            if (typeError) {
                rowResult.errors.push(typeError);
                rowResult.cellErrors[header] = true;
            }

            // Valid values check
            if (colDef.validValues && !colDef.validValues.includes(value)) {
                rowResult.errors.push({
                    field: header,
                    message: `Invalid value "${value}"`,
                    suggestion: `Valid values: ${colDef.validValues.join(', ')}`
                });
                rowResult.cellErrors[header] = true;
            }

            // UOM validation
            if (colDef.validateUOM && fishbowlData.uoms.length > 0) {
                if (!fishbowlData.uoms.includes(value)) {
                    rowResult.errors.push({
                        field: header,
                        message: `UOM "${value}" does not exist in Fishbowl`,
                        suggestion: 'Create this UOM first, or use an existing one'
                    });
                    rowResult.cellErrors[header] = true;
                    missingDeps.uoms.add(value);
                }
            }

            // Vendor validation
            if (colDef.validateVendor && fishbowlData.vendors.length > 0) {
                if (!fishbowlData.vendors.some(v => v.toLowerCase() === value.toLowerCase())) {
                    rowResult.errors.push({
                        field: header,
                        message: `Vendor "${value}" does not exist in Fishbowl`,
                        suggestion: 'Create this vendor first, or check spelling'
                    });
                    rowResult.cellErrors[header] = true;
                    missingDeps.vendors.add(value);
                }
            }

            // Tax Code validation
            if (colDef.validateTaxCode && fishbowlData.taxCodes.length > 0) {
                if (!fishbowlData.taxCodes.some(tc => tc.code.toLowerCase() === value.toLowerCase())) {
                    rowResult.errors.push({
                        field: header,
                        message: `Tax code "${value}" does not exist in Fishbowl`,
                        suggestion: 'Select a valid tax code or create this tax code first'
                    });
                    rowResult.cellErrors[header] = true;
                }
            }
        });

        // Check UOM conversions if multiple UOMs are specified
        const partUom = row['UOM'] ? row['UOM'] : null;
        const productUom = row['ProductUOM'] ? row['ProductUOM'] : null;
        const vendorUom = row['VendorUOM'] ? row['VendorUOM'] : null;

        if (partUom && productUom && partUom !== productUom) {
            const convKey = partUom + '->' + productUom;
            const revConvKey = productUom + '->' + partUom;
            if (fishbowlData.uomConversions.length > 0 &&
                !fishbowlData.uomConversions.includes(convKey) &&
                !fishbowlData.uomConversions.includes(revConvKey)) {
                rowResult.warnings.push({
                    field: 'ProductUOM',
                    message: `UOM conversion from ${partUom} to ${productUom} may not exist`,
                    suggestion: 'Ensure UOM conversion exists in Fishbowl'
                });
                rowResult.cellWarnings['ProductUOM'] = true;
                missingDeps.uomConversions.add(partUom + ' <-> ' + productUom);
            }
        }

        if (partUom && vendorUom && partUom !== vendorUom) {
            const convKey = partUom + '->' + vendorUom;
            const revConvKey = vendorUom + '->' + partUom;
            if (fishbowlData.uomConversions.length > 0 &&
                !fishbowlData.uomConversions.includes(convKey) &&
                !fishbowlData.uomConversions.includes(revConvKey)) {
                rowResult.warnings.push({
                    field: 'VendorUOM',
                    message: `UOM conversion from ${partUom} to ${vendorUom} may not exist`,
                    suggestion: 'Ensure UOM conversion exists in Fishbowl'
                });
                rowResult.cellWarnings['VendorUOM'] = true;
                missingDeps.uomConversions.add(partUom + ' <-> ' + vendorUom);
            }
        }

        // Set overall status
        if (rowResult.errors.length > 0) {
            rowResult.status = 'error';
        } else if (rowResult.warnings.length > 0) {
            rowResult.status = 'warning';
        }

        return rowResult;
    }

    // Batched async validation with progress indicator
    async function validateData() {
        validationResults = [];

        const missingDeps = {
            uoms: new Set(),
            vendors: new Set(),
            customFields: new Set(),
            uomConversions: new Set()
        };

        const totalRows = csvData.length;
        const enableVirtualScroll = totalRows > 500; // Enable virtual scroll for large datasets

        console.log(`Validating ${totalRows} rows (batch size: ${BATCH_SIZE})...`);

        // Process rows in batches
        for (let i = 0; i < totalRows; i += BATCH_SIZE) {
            const batchEnd = Math.min(i + BATCH_SIZE, totalRows);
            const batch = csvData.slice(i, batchEnd);

            // Validate batch
            batch.forEach((row, batchIndex) => {
                const globalIndex = i + batchIndex;
                const rowResult = validateRow(row, globalIndex, missingDeps);
                validationResults.push(rowResult);
            });

            // Update progress
            showProgress(batchEnd, totalRows);

            // Allow UI to update between batches (prevents freezing)
            if (batchEnd < totalRows) {
                await sleep(10);
            }
        }

        // Enable/disable virtual scrolling based on dataset size
        virtualScrollState.enabled = enableVirtualScroll;
        virtualScrollState.totalRows = totalRows;

        console.log(`Validation complete. Virtual scrolling: ${enableVirtualScroll ? 'enabled' : 'disabled'}`);
        hideProgress();
    }

    function validateType(value, type, field) {
        switch (type) {
            case 'Integer':
                if (!/^-?\d+$/.test(value)) {
                    return {
                        field: field,
                        message: `"${value}" is not a valid integer`,
                        suggestion: 'Use whole numbers only (e.g., 1, 10, 100)'
                    };
                }
                break;

            case 'Decimal':
            case 'Currency':
            case 'Percentage':
                // Remove currency symbols and commas for validation
                const cleanValue = value.replace(/[$,]/g, '');
                if (!/^-?\d*\.?\d+$/.test(cleanValue)) {
                    return {
                        field: field,
                        message: `"${value}" is not a valid number`,
                        suggestion: 'Use numeric format (e.g., 10.50)'
                    };
                }
                break;

            case 'Boolean':
                const boolValues = ['true', 'false', '1', '0', 'yes', 'no'];
                if (!boolValues.includes(value.toLowerCase())) {
                    return {
                        field: field,
                        message: `"${value}" is not a valid boolean`,
                        suggestion: 'Use true/false, 1/0, or yes/no'
                    };
                }
                break;

            case 'Date':
                // Basic date validation - could be enhanced
                const dateRegex = /^\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}$|^\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2}$/;
                if (!dateRegex.test(value)) {
                    return {
                        field: field,
                        message: `"${value}" is not a valid date format`,
                        suggestion: 'Use MM/DD/YYYY or YYYY-MM-DD format'
                    };
                }
                break;
        }
        return null;
    }

    // ============================================
    // Rendering
    // ============================================

    function renderResults() {
        // Show sections
        document.getElementById('summaryStats').classList.remove('hidden');
        document.getElementById('filterControls').classList.remove('hidden');
        document.getElementById('resultsSection').classList.remove('hidden');
        document.getElementById('actionButtons').classList.remove('hidden');

        // Update stats
        const totalRows = validationResults.length;
        const validRows = validationResults.filter(r => r.status === 'valid').length;
        const warningRows = validationResults.filter(r => r.status === 'warning').length;
        const errorRows = validationResults.filter(r => r.status === 'error').length;

        document.getElementById('statTotal').textContent = totalRows;
        document.getElementById('statValid').textContent = validRows;
        document.getElementById('statWarning').textContent = warningRows;
        document.getElementById('statError').textContent = errorRows;

        // Enable/disable export buttons
        document.getElementById('exportValidBtn').disabled = validRows === 0;

        // Consolidate and render issues
        consolidateIssues();
        renderConsolidatedIssues();

        // Render table with default filter (errors only)
        applyFilters();
    }

    // ============================================
    // Consolidated Issues
    // ============================================

    function consolidateIssues() {
        consolidatedIssues = {};

        validationResults.forEach(result => {
            // Consolidate errors
            result.errors.forEach(error => {
                const key = `${error.field}:${error.message}`;
                if (!consolidatedIssues[key]) {
                    consolidatedIssues[key] = {
                        type: 'error',
                        field: error.field,
                        message: error.message,
                        suggestion: error.suggestion,
                        values: new Set(),
                        rowCount: 0
                    };
                }
                // Track unique values that caused the issue
                const row = csvData[result.rowIndex];
                if (row[error.field]) {
                    consolidatedIssues[key].values.add(row[error.field]);
                }
                consolidatedIssues[key].rowCount++;
            });

            // Consolidate warnings
            result.warnings.forEach(warning => {
                const key = `${warning.field}:${warning.message}`;
                if (!consolidatedIssues[key]) {
                    consolidatedIssues[key] = {
                        type: 'warning',
                        field: warning.field,
                        message: warning.message,
                        suggestion: warning.suggestion,
                        values: new Set(),
                        rowCount: 0
                    };
                }
                const row = csvData[result.rowIndex];
                if (row[warning.field]) {
                    consolidatedIssues[key].values.add(row[warning.field]);
                }
                consolidatedIssues[key].rowCount++;
            });
        });
    }

    function renderConsolidatedIssues() {
        const panel = document.getElementById('consolidatedIssues');
        const content = document.getElementById('consolidatedIssuesContent');

        // Sort issues by row count (most frequent first)
        const sortedIssues = Object.values(consolidatedIssues).sort((a, b) => b.rowCount - a.rowCount);

        if (sortedIssues.length === 0) {
            panel.classList.add('hidden');
            return;
        }

        panel.classList.remove('hidden');

        let html = '';
        sortedIssues.forEach(issue => {
            const groupClass = issue.type === 'warning' ? 'warning-group' : '';
            const valuesArray = Array.from(issue.values);

            // Determine action buttons based on issue type
            let actionButtons = '';

            // Missing required fields (warnings)
            if (issue.field === 'Active' && issue.message.includes('Required field is missing')) {
                actionButtons = `
                    <button class="btn btn-sm btn-success issue-action-btn" onclick="setActiveToTrue()" title="Set all empty Active cells to TRUE">
                        <i class="bi bi-check-circle"></i> Set to TRUE
                    </button>
                    <button class="btn btn-sm btn-danger issue-action-btn" onclick="setActiveToFalse()" title="Set all empty Active cells to FALSE">
                        <i class="bi bi-x-circle"></i> Set to FALSE
                    </button>
                `;
            } else if (issue.field === 'PartTaxCode' && issue.message.includes('Required field is missing')) {
                actionButtons = `
                    <button class="issue-action-btn fix" onclick="fillPartTaxCode()" title="Fill in tax codes from dropdown">
                        üìã Select Tax Code
                    </button>
                `;
            } else if (issue.field === 'PartTypeID' && issue.message.includes('Required field is missing')) {
                actionButtons = `
                    <button class="issue-action-btn fix" onclick="fillPartTypeID()" title="Fill in part type from dropdown">
                        üìã Select Part Type
                    </button>
                `;
            } else if (issue.field === 'UOM' && issue.message.includes('Required field is missing')) {
                actionButtons = `
                    <button class="issue-action-btn fix" onclick="fillUOM()" title="Fill in UOM from dropdown">
                        üìã Select UOM
                    </button>
                `;
            }
            // Validation errors
            else if (issue.message.includes('UOM') && issue.message.includes('does not exist')) {
                const uomValues = JSON.stringify(Array.from(issue.values));
                actionButtons = `
                    <button class="issue-action-btn create" onclick='createUOM(${uomValues})' title="Create these UOM(s) in Fishbowl">
                        ‚ûï Create UOM
                    </button>
                    <button class="issue-action-btn map" onclick="mapUOM()" title="Map to existing UOM">
                        üîó Map to Existing
                    </button>
                `;
            } else if (issue.message.includes('Vendor') && issue.message.includes('does not exist')) {
                actionButtons = `
                    <button class="issue-action-btn create" onclick="createVendor()" title="Create missing vendor(s) in Fishbowl">
                        ‚ûï Create Vendor
                    </button>
                    <button class="issue-action-btn map" onclick="mapVendor()" title="Map to existing vendor">
                        üîó Map to Existing
                    </button>
                `;
            } else if (issue.message.includes('Tax code') && issue.message.includes('does not exist')) {
                actionButtons = `
                    <button class="issue-action-btn map" onclick="mapTaxCode()" title="Map to existing tax code">
                        üîó Map to Existing
                    </button>
                `;
            } else if (issue.message.includes('Custom field') && issue.message.includes('does not exist')) {
                actionButtons = `
                    <button class="issue-action-btn create" onclick="createCustomField()" title="Create missing custom field in Fishbowl">
                        ‚ûï Create Custom Field
                    </button>
                `;
            } else if (issue.message.includes('Invalid value') || issue.message.includes('not a valid')) {
                actionButtons = `
                    <button class="issue-action-btn fix" onclick="fixValues()" title="Fix invalid values">
                        üîß Fix Values
                    </button>
                `;
            } else if (issue.message.includes('conversion') && issue.message.includes('may not exist')) {
                actionButtons = `
                    <button class="issue-action-btn create" onclick="createUOMConversion()" title="Create UOM conversion in Fishbowl">
                        ‚ûï Create Conversion
                    </button>
                `;
            }

            html += `
                <div class="issue-group ${groupClass}">
                    <div class="issue-group-header">
                        <div>
                            <span class="issue-group-title">${issue.field}: ${issue.message}</span>
                            <span class="issue-count">${issue.rowCount} row${issue.rowCount > 1 ? 's' : ''}</span>
                        </div>
                        ${actionButtons ? `<div class="issue-actions">${actionButtons}</div>` : ''}
                    </div>
                    ${valuesArray.length > 0 ? `
                        <div class="issue-items">
                            ${valuesArray.slice(0, 10).map(v => `<span class="issue-value">${escapeHtml(v)}</span>`).join('')}
                            ${valuesArray.length > 10 ? `<span class="issue-value">+${valuesArray.length - 10} more</span>` : ''}
                        </div>
                    ` : ''}
                    ${issue.suggestion ? `<div style="color: var(--fb-success); font-size: 12px; margin-top: 5px;">üí° ${issue.suggestion}</div>` : ''}
                </div>
            `;
        });

        content.innerHTML = html;
    }

    // Action button handlers - Fill missing required fields

    function setActiveToTrue() {
        if (csvData.length === 0) {
            alert('No data loaded.');
            return;
        }

        let count = 0;
        csvData.forEach(row => {
            if (!row['Active'] || row['Active'].trim() === '') {
                row['Active'] = 'TRUE';
                count++;
            }
        });

        if (count > 0) {
            alert(`Set ${count} empty Active cells to TRUE`);
            revalidateData();
        } else {
            alert('No empty Active cells found.');
        }
    }

    function setActiveToFalse() {
        if (csvData.length === 0) {
            alert('No data loaded.');
            return;
        }

        let count = 0;
        csvData.forEach(row => {
            if (!row['Active'] || row['Active'].trim() === '') {
                row['Active'] = 'FALSE';
                count++;
            }
        });

        if (count > 0) {
            alert(`Set ${count} empty Active cells to FALSE`);
            revalidateData();
        } else {
            alert('No empty Active cells found.');
        }
    }

    function fillPartTaxCode() {
        if (csvData.length === 0) {
            alert('No data loaded.');
            return;
        }

        if (fishbowlData.taxCodes.length === 0) {
            alert('No tax codes loaded from Fishbowl. Please check your database connection.');
            return;
        }

        // Count empty cells
        const emptyCount = csvData.filter(row => !row['PartTaxCode'] || row['PartTaxCode'].trim() === '').length;
        if (emptyCount === 0) {
            alert('No empty PartTaxCode cells found.');
            return;
        }

        // Build dropdown options (show name, but use code)
        const options = fishbowlData.taxCodes
            .map(tc => `<option value="${escapeHtml(tc.code)}">${escapeHtml(tc.name)} (${escapeHtml(tc.code)})</option>`)
            .join('');

        showModal(
            'Fill PartTaxCode',
            `
                <p>Select a tax code to fill ${emptyCount} empty PartTaxCode cells:</p>
                <select id="modalSelect" style="width: 100%; padding: 8px; font-size: 14px; margin-top: 10px;">
                    <option value="">-- Select Tax Code --</option>
                    ${options}
                </select>
            `,
            function() {
                const selectedCode = document.getElementById('modalSelect').value;
                if (!selectedCode) {
                    alert('Please select a tax code.');
                    return false;
                }

                let count = 0;
                csvData.forEach(row => {
                    if (!row['PartTaxCode'] || row['PartTaxCode'].trim() === '') {
                        row['PartTaxCode'] = selectedCode;
                        count++;
                    }
                });

                alert(`Filled ${count} empty PartTaxCode cells with "${selectedCode}"`);
                revalidateData();
                return true;
            }
        );
    }

    function fillPartTypeID() {
        if (csvData.length === 0) {
            alert('No data loaded.');
            return;
        }

        if (fishbowlData.partTypes.length === 0) {
            alert('No part types loaded from Fishbowl. Please check your database connection.');
            return;
        }

        // Count empty cells
        const emptyCount = csvData.filter(row => !row['PartTypeID'] || row['PartTypeID'].trim() === '').length;
        if (emptyCount === 0) {
            alert('No empty PartTypeID cells found.');
            return;
        }

        // Build dropdown options (show name, but use id)
        const options = fishbowlData.partTypes
            .map(pt => `<option value="${pt.id}">${escapeHtml(pt.name)} (${pt.id})</option>`)
            .join('');

        showModal(
            'Fill PartTypeID',
            `
                <p>Select a part type to fill ${emptyCount} empty PartTypeID cells:</p>
                <select id="modalSelect" style="width: 100%; padding: 8px; font-size: 14px; margin-top: 10px;">
                    <option value="">-- Select Part Type --</option>
                    ${options}
                </select>
            `,
            function() {
                const selectedId = document.getElementById('modalSelect').value;
                if (!selectedId) {
                    alert('Please select a part type.');
                    return false;
                }

                let count = 0;
                csvData.forEach(row => {
                    if (!row['PartTypeID'] || row['PartTypeID'].trim() === '') {
                        row['PartTypeID'] = selectedId;
                        count++;
                    }
                });

                alert(`Filled ${count} empty PartTypeID cells with "${selectedId}"`);
                revalidateData();
                return true;
            }
        );
    }

    function fillUOM() {
        if (csvData.length === 0) {
            alert('No data loaded.');
            return;
        }

        if (fishbowlData.uoms.length === 0) {
            alert('No UOMs loaded from Fishbowl. Please check your database connection.');
            return;
        }

        // Count empty cells
        const emptyCount = csvData.filter(row => !row['UOM'] || row['UOM'].trim() === '').length;
        if (emptyCount === 0) {
            alert('No empty UOM cells found.');
            return;
        }

        // Build dropdown options (use UOM code/name)
        const options = fishbowlData.uoms
            .map(uom => `<option value="${escapeHtml(uom)}">${escapeHtml(uom)}</option>`)
            .join('');

        showModal(
            'Fill UOM',
            `
                <p>Select a UOM to fill ${emptyCount} empty UOM cells:</p>
                <select id="modalSelect" style="width: 100%; padding: 8px; font-size: 14px; margin-top: 10px;">
                    <option value="">-- Select UOM --</option>
                    ${options}
                </select>
            `,
            function() {
                const selectedUom = document.getElementById('modalSelect').value;
                if (!selectedUom) {
                    alert('Please select a UOM.');
                    return false;
                }

                let count = 0;
                csvData.forEach(row => {
                    if (!row['UOM'] || row['UOM'].trim() === '') {
                        row['UOM'] = selectedUom;
                        count++;
                    }
                });

                alert(`Filled ${count} empty UOM cells with "${selectedUom}"`);
                revalidateData();
                return true;
            }
        );
    }

    // Bootstrap Modal Helper
    function showModal(title, content, onConfirm, options = {}) {
        const modalId = 'dynamicModal' + Date.now();
        const size = options.size || ''; // '', 'modal-lg', 'modal-xl'
        const confirmText = options.confirmText || 'Apply';
        const cancelText = options.cancelText || 'Cancel';
        const confirmClass = options.confirmClass || 'btn-primary';

        // Create Bootstrap modal HTML
        const modalHtml = `
            <div class="modal fade" id="${modalId}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog ${size}">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">${title}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            ${content}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">${cancelText}</button>
                            <button type="button" class="btn ${confirmClass}" id="${modalId}Confirm">${confirmText}</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Add modal to DOM
        const modalContainer = document.createElement('div');
        modalContainer.innerHTML = modalHtml;
        document.body.appendChild(modalContainer.firstElementChild);

        // Initialize Bootstrap modal
        const modalElement = document.getElementById(modalId);
        const bsModal = new bootstrap.Modal(modalElement);

        // Handle confirm button
        document.getElementById(modalId + 'Confirm').onclick = function() {
            const shouldClose = onConfirm ? onConfirm() : true;
            if (shouldClose !== false) {
                bsModal.hide();
            }
        };

        // Clean up after modal is hidden
        modalElement.addEventListener('hidden.bs.modal', function() {
            document.body.removeChild(modalElement);
        });

        // Show modal
        bsModal.show();

        return bsModal;
    }

    // Create/map missing data
    function createUOM(specificUOMs) {
        let missingList;

        // If specific UOMs are provided (from button click), use only those
        if (specificUOMs && Array.isArray(specificUOMs) && specificUOMs.length > 0) {
            missingList = specificUOMs;
            console.log('Creating specific UOMs:', missingList);
        } else {
            // Otherwise, extract all missing UOMs from consolidated issues
            const missingUOMs = new Set();

            // Look for UOM errors in consolidated issues
            Object.keys(consolidatedIssues).forEach(key => {
                const issue = consolidatedIssues[key];
                if (issue.field === 'UOM' && issue.message.includes('does not exist')) {
                    // Add all the invalid UOM values
                    issue.values.forEach(val => missingUOMs.add(val));
                }
            });

            console.log('Missing UOMs found:', Array.from(missingUOMs));

            if (missingUOMs.size === 0) {
                alert('No missing UOMs found. All UOMs in your dataset already exist in Fishbowl.');
                return;
            }

            missingList = Array.from(missingUOMs);
        }

        // Build Bootstrap modal form
        let formHtml = `
            <div class="alert alert-warning mb-3">
                <i class="bi bi-exclamation-triangle-fill"></i> Each UOM requires a Name, Abbreviation, and Type.
            </div>
            <div style="max-height: 500px; overflow-y: auto;">
        `;

        missingList.forEach((uomName, idx) => {
            formHtml += `
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0"><i class="bi bi-tag"></i> UOM #${idx + 1}</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                Name <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control uom-name" data-index="${idx}"
                                value="${escapeHtml(uomName)}" maxlength="30" required />
                            <small class="form-text text-muted">Max 30 characters</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                Abbreviation <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control uom-abbrev" data-index="${idx}"
                                value="${escapeHtml(uomName.substring(0, 4))}" maxlength="10" required />
                            <small class="form-text text-muted">Max 10 characters (4 recommended for reports)</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                Type <span class="text-danger">*</span>
                            </label>
                            <select class="form-select uom-type" data-index="${idx}" required>
                                <option value="">-- Select Type --</option>
                                <option value="1" selected>Count</option>
                                <option value="2">Weight</option>
                                <option value="3">Length</option>
                                <option value="4">Area</option>
                                <option value="5">Volume</option>
                                <option value="6">Time</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;
        });

        formHtml += '</div>';

        showModal('Create UOMs', formHtml, function() {
            // Validate and collect data
            const uomsToCreate = [];
            let hasErrors = false;

            for (let i = 0; i < missingList.length; i++) {
                const nameInput = document.querySelector(`.uom-name[data-index="${i}"]`);
                const abbrevInput = document.querySelector(`.uom-abbrev[data-index="${i}"]`);
                const typeSelect = document.querySelector(`.uom-type[data-index="${i}"]`);

                const name = nameInput.value.trim();
                const abbrev = abbrevInput.value.trim();
                const typeID = typeSelect.value;

                // Validate
                if (!name) {
                    alert(`UOM #${i + 1}: Name is required`);
                    nameInput.focus();
                    hasErrors = true;
                    return false;
                }

                if (!abbrev) {
                    alert(`UOM #${i + 1}: Abbreviation is required`);
                    abbrevInput.focus();
                    hasErrors = true;
                    return false;
                }

                if (!typeID) {
                    alert(`UOM #${i + 1}: Type is required`);
                    typeSelect.focus();
                    hasErrors = true;
                    return false;
                }

                uomsToCreate.push({
                    Name: name,
                    Abbrev: abbrev,
                    UomTypeID: typeID,
                    Active: 'true',
                    ReadOnly: 'false',
                    Details: ''
                });
            }

            if (hasErrors) return false;

            // Confirm
            if (!confirm(`Create ${uomsToCreate.length} UOM(s) in Fishbowl?`)) {
                return false;
            }

            // Build CSV rows (data only, no header row for API)
            const headers = ['Name', 'Abbrev', 'UomTypeID', 'Active', 'ReadOnly', 'Details'];
            let rows = [];

            // Data rows only (API doesn't expect header row)
            uomsToCreate.forEach(uom => {
                const values = headers.map(h => {
                    const value = uom[h] || '';
                    return '"' + String(value).replace(/"/g, '""') + '"';
                });
                rows.push(values.join(','));
            });

            // Build API request
            const payload = {
                "ImportRq": {
                    "Type": "ImportUnitsOfMeasure",
                    "Rows": {
                        "Row": rows
                    }
                }
            };

            console.log('Create UOM Request - Type:', payload.ImportRq.Type);
            console.log('Create UOM Request - Row Count:', rows.length);
            console.log('Create UOM Request - First 3 rows:', rows.slice(0, 3));
            console.log('Create UOM Request - Full Payload:', JSON.stringify(payload, null, 2));

            showLoading('Creating UOMs in Fishbowl...');

            try {
                const response = runApiRequest('ImportRq', JSON.stringify(payload));
                console.log('Create UOM Response (raw):', response);
                console.log('Create UOM Response (type):', typeof response);
                hideLoading();

                if (!response) {
                    alert('Create UOM failed: No response from API');
                    return false;
                }

                const result = typeof response === 'string' ? JSON.parse(response) : response;
                console.log('Create UOM Response (parsed):', result);

                if (result && result.ImportRs && result.ImportRs.statusCode === 1000) {
                    alert(`Successfully created ${uomsToCreate.length} UOM(s) in Fishbowl!\n\nRevalidating data...`);

                    // Reload UOMs and revalidate to clear errors
                    loadFishbowlReferenceData();
                    revalidateData();

                    return true;
                } else {
                    let errorMsg = 'Create UOM failed';
                    if (result && result.ImportRs) {
                        errorMsg += `\nStatus Code: ${result.ImportRs.statusCode}`;
                        if (result.ImportRs.statusMessage) {
                            errorMsg += `\nMessage: ${result.ImportRs.statusMessage}`;
                        }
                    }
                    console.error('Create UOM Error Details:', result);
                    alert(errorMsg);
                    return false;
                }
            } catch (error) {
                hideLoading();
                console.error('Error creating UOMs:', error);
                alert('Error creating UOMs: ' + error.message);
                return false;
            }
        });
    }

    function mapUOM() {
        if (csvData.length === 0) {
            alert('No data loaded.');
            return;
        }

        if (fishbowlData.uoms.length === 0) {
            alert('No UOMs loaded from Fishbowl. Please check your database connection.');
            return;
        }

        // Find all invalid UOMs
        const invalidUoms = new Set();
        validationResults.forEach(result => {
            result.errors.forEach(error => {
                if (error.field && (error.field === 'UOM' || error.field.includes('UOM')) &&
                    error.message.includes('does not exist')) {
                    const row = csvData[result.rowIndex];
                    if (row[error.field]) {
                        invalidUoms.add(row[error.field]);
                    }
                }
            });
        });

        if (invalidUoms.size === 0) {
            alert('No invalid UOMs found.');
            return;
        }

        // Build Bootstrap mapping UI
        const invalidList = Array.from(invalidUoms);
        const uomOptions = fishbowlData.uoms
            .map(uom => `<option value="${escapeHtml(uom)}">${escapeHtml(uom)}</option>`)
            .join('');

        let mappingHtml = `
            <div class="alert alert-info mb-3">
                <i class="bi bi-arrow-left-right"></i> Map each invalid UOM to an existing one in Fishbowl.
            </div>
            <div style="max-height: 400px; overflow-y: auto;">
        `;

        invalidList.forEach(invalid => {
            mappingHtml += `
                <div class="card mb-2">
                    <div class="card-body py-2">
                        <div class="row align-items-center">
                            <div class="col-4">
                                <span class="badge bg-danger">${escapeHtml(invalid)}</span>
                            </div>
                            <div class="col-1 text-center">
                                <i class="bi bi-arrow-right"></i>
                            </div>
                            <div class="col-7">
                                <select class="form-select form-select-sm uom-mapping" data-invalid="${escapeHtml(invalid)}" required>
                                    <option value="">-- Select UOM --</option>
                                    ${uomOptions}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        mappingHtml += '</div>';

        showModal(
            'Map Invalid UOMs',
            mappingHtml,
            function() {
                const mappings = {};
                const selects = document.querySelectorAll('.uom-mapping');

                selects.forEach(select => {
                    const invalid = select.getAttribute('data-invalid');
                    const valid = select.value;
                    if (valid) {
                        mappings[invalid] = valid;
                    }
                });

                if (Object.keys(mappings).length === 0) {
                    alert('No mappings selected.');
                    return false;
                }

                // Apply mappings
                let count = 0;
                csvData.forEach(row => {
                    csvHeaders.forEach(header => {
                        if ((header === 'UOM' || header.includes('UOM')) && row[header] && mappings[row[header]]) {
                            row[header] = mappings[row[header]];
                            count++;
                        }
                    });
                });

                alert(`Mapped ${count} UOM values`);
                revalidateData();
                return true;
            }
        );
    }

    function createVendor() {
        alert('Create Vendor functionality will be implemented here');
    }

    function mapVendor() {
        if (csvData.length === 0) {
            alert('No data loaded.');
            return;
        }

        if (fishbowlData.vendors.length === 0) {
            alert('No vendors loaded from Fishbowl. Please check your database connection.');
            return;
        }

        // Find all invalid vendors
        const invalidVendors = new Set();
        validationResults.forEach(result => {
            result.errors.forEach(error => {
                if (error.field === 'Vendor' && error.message.includes('does not exist')) {
                    const row = csvData[result.rowIndex];
                    if (row[error.field]) {
                        invalidVendors.add(row[error.field]);
                    }
                }
            });
        });

        if (invalidVendors.size === 0) {
            alert('No invalid vendors found.');
            return;
        }

        // Build Bootstrap mapping UI
        const invalidList = Array.from(invalidVendors);
        const vendorOptions = fishbowlData.vendors
            .map(vendor => `<option value="${escapeHtml(vendor)}">${escapeHtml(vendor)}</option>`)
            .join('');

        let mappingHtml = `
            <div class="alert alert-info mb-3">
                <i class="bi bi-arrow-left-right"></i> Map each invalid vendor to an existing one in Fishbowl.
            </div>
            <div style="max-height: 400px; overflow-y: auto;">
        `;

        invalidList.forEach(invalid => {
            mappingHtml += `
                <div class="card mb-2">
                    <div class="card-body py-2">
                        <div class="row align-items-center">
                            <div class="col-4">
                                <span class="badge bg-danger">${escapeHtml(invalid)}</span>
                            </div>
                            <div class="col-1 text-center">
                                <i class="bi bi-arrow-right"></i>
                            </div>
                            <div class="col-7">
                                <select class="form-select form-select-sm vendor-mapping" data-invalid="${escapeHtml(invalid)}" required>
                                    <option value="">-- Select Vendor --</option>
                                    ${vendorOptions}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        mappingHtml += '</div>';

        showModal(
            'Map Invalid Vendors',
            mappingHtml,
            function() {
                const mappings = {};
                const selects = document.querySelectorAll('.vendor-mapping');

                selects.forEach(select => {
                    const invalid = select.getAttribute('data-invalid');
                    const valid = select.value;
                    if (valid) {
                        mappings[invalid] = valid;
                    }
                });

                if (Object.keys(mappings).length === 0) {
                    alert('No mappings selected.');
                    return false;
                }

                // Apply mappings
                let count = 0;
                csvData.forEach(row => {
                    if (row['Vendor'] && mappings[row['Vendor']]) {
                        row['Vendor'] = mappings[row['Vendor']];
                        count++;
                    }
                });

                alert(`Mapped ${count} vendor values`);
                revalidateData();
                return true;
            }
        );
    }

    function mapTaxCode() {
        if (csvData.length === 0) {
            alert('No data loaded.');
            return;
        }

        if (fishbowlData.taxCodes.length === 0) {
            alert('No tax codes loaded from Fishbowl. Please check your database connection.');
            return;
        }

        // Find all invalid tax codes
        const invalidTaxCodes = new Set();
        validationResults.forEach(result => {
            result.errors.forEach(error => {
                if (error.field === 'PartTaxCode' && error.message.includes('does not exist')) {
                    const row = csvData[result.rowIndex];
                    if (row[error.field]) {
                        invalidTaxCodes.add(row[error.field]);
                    }
                }
            });
        });

        if (invalidTaxCodes.size === 0) {
            alert('No invalid tax codes found.');
            return;
        }

        // Build mapping UI
        const invalidList = Array.from(invalidTaxCodes);
        const taxOptions = fishbowlData.taxCodes
            .map(tc => `<option value="${escapeHtml(tc.code)}">${escapeHtml(tc.name)} (${escapeHtml(tc.code)})</option>`)
            .join('');

        let mappingHtml = '<div style="max-height: 400px; overflow-y: auto;">';
        mappingHtml += '<p>Map invalid tax codes to existing ones:</p>';
        invalidList.forEach(invalid => {
            mappingHtml += `
                <div style="margin: 10px 0; display: flex; align-items: center; gap: 10px;">
                    <strong style="width: 150px;">${escapeHtml(invalid)}</strong>
                    <span>‚Üí</span>
                    <select class="tax-mapping" data-invalid="${escapeHtml(invalid)}" style="flex: 1; padding: 6px;">
                        <option value="">-- Select Tax Code --</option>
                        ${taxOptions}
                    </select>
                </div>
            `;
        });
        mappingHtml += '</div>';

        showModal(
            'Map Invalid Tax Codes',
            mappingHtml,
            function() {
                const mappings = {};
                const selects = document.querySelectorAll('.tax-mapping');

                selects.forEach(select => {
                    const invalid = select.getAttribute('data-invalid');
                    const valid = select.value;
                    if (valid) {
                        mappings[invalid] = valid;
                    }
                });

                if (Object.keys(mappings).length === 0) {
                    alert('No mappings selected.');
                    return false;
                }

                // Apply mappings
                let count = 0;
                csvData.forEach(row => {
                    if (row['PartTaxCode'] && mappings[row['PartTaxCode']]) {
                        row['PartTaxCode'] = mappings[row['PartTaxCode']];
                        count++;
                    }
                });

                alert(`Mapped ${count} tax code values`);
                revalidateData();
                return true;
            }
        );
    }

    function createCustomField() {
        alert('Create Custom Field functionality will be implemented here');
    }

    function fixValues() {
        alert('Fix Values functionality will be implemented here');
    }

    function createUOMConversion() {
        // Debug logging
        console.log('createUOMConversion called');
        console.log('fishbowlData:', fishbowlData);
        console.log('fishbowlData.uomDetails:', fishbowlData.uomDetails);
        console.log('fishbowlData.uomDetails type:', typeof fishbowlData.uomDetails);
        console.log('fishbowlData.uomDetails.length:', fishbowlData.uomDetails?.length);
        console.log('fishbowlData.uoms:', fishbowlData.uoms);
        console.log('fishbowlData.uoms.length:', fishbowlData.uoms?.length);

        if (!fishbowlData.uomDetails || fishbowlData.uomDetails.length === 0) {
            alert('No UOMs loaded. Please ensure UOMs are loaded from Fishbowl.');
            return;
        }

        // Build UOM type name mapping
        const uomTypeNames = {
            1: 'Count',
            2: 'Weight',
            3: 'Length',
            4: 'Area',
            5: 'Volume',
            6: 'Time'
        };

        // Build Bootstrap modal form
        let formHtml = `
            <div class="alert alert-info mb-3">
                <i class="bi bi-info-circle-fill"></i> UOMs must be of the same type to convert between them.
            </div>
            <div style="max-height: 500px; overflow-y: auto;">
                <div class="card">
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="fromUOM" class="form-label fw-bold">
                                From UOM <span class="text-danger">*</span>
                            </label>
                            <select id="fromUOM" class="form-select" onchange="filterToUOM()" required>
                                <option value="">-- Select From UOM --</option>
                                ${fishbowlData.uomDetails.map(uom =>
                                    `<option value="${escapeHtml(uom.code)}" data-type="${uom.uomtype}">${escapeHtml(uom.code)} (${uomTypeNames[uom.uomtype]})</option>`
                                ).join('')}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="toUOM" class="form-label fw-bold">
                                To UOM <span class="text-danger">*</span>
                            </label>
                            <select id="toUOM" class="form-select" onchange="updateToUOMLabel()" required>
                                <option value="">-- Select To UOM --</option>
                            </select>
                            <small class="form-text text-muted" id="toUOMHint">Select From UOM first</small>
                        </div>

                        <div class="card bg-light mt-4">
                            <div class="card-header">
                                <strong><i class="bi bi-calculator"></i> Conversion Formula</strong>
                            </div>
                            <div class="card-body">
                                <div class="d-flex align-items-center gap-2 mb-3">
                                    <span class="badge bg-secondary">1</span>
                                    <span>√ó</span>
                                    <span id="toUOMLabel" class="badge bg-primary fs-6">___</span>
                                    <span>=</span>
                                    <input type="number" id="conversionValue" class="form-control form-control-lg text-center fw-bold"
                                        placeholder="1000" step="any" min="0" style="max-width: 150px;" required />
                                    <span id="fromUOMLabel" class="badge bg-primary fs-6">___</span>
                                </div>
                                <div class="alert alert-secondary mb-0 py-2">
                                    <small><i class="bi bi-lightbulb"></i> Example: 1 √ó Box = 1000 Each</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Add filter function to window scope
        window.filterToUOM = function() {
            const fromSelect = document.getElementById('fromUOM');
            const toSelect = document.getElementById('toUOM');
            const fromUOMLabel = document.getElementById('fromUOMLabel');
            const selectedOption = fromSelect.options[fromSelect.selectedIndex];

            if (!selectedOption || !selectedOption.value) {
                toSelect.innerHTML = '<option value="">-- Select To UOM --</option>';
                fromUOMLabel.textContent = '___';
                return;
            }

            const selectedType = selectedOption.dataset.type;
            const fromUOMCode = selectedOption.value;
            fromUOMLabel.textContent = fromUOMCode;

            // Filter To UOM by same type, excluding the From UOM
            const filteredUOMs = fishbowlData.uomDetails.filter(uom =>
                uom.uomtype == selectedType && uom.code !== fromUOMCode
            );

            toSelect.innerHTML = '<option value="">-- Select To UOM --</option>' +
                filteredUOMs.map(uom =>
                    `<option value="${escapeHtml(uom.code)}">${escapeHtml(uom.code)}</option>`
                ).join('');

            document.getElementById('toUOMHint').textContent =
                filteredUOMs.length > 0 ? `${filteredUOMs.length} ${uomTypeNames[selectedType]} UOMs available` : 'No matching UOMs';
        };

        // Add change handler for To UOM
        window.updateToUOMLabel = function() {
            const toSelect = document.getElementById('toUOM');
            const toUOMLabel = document.getElementById('toUOMLabel');
            toUOMLabel.textContent = toSelect.value || '___';
        };

        showModal('Create UOM Conversion', formHtml, function() {
            // Validate
            const fromUOM = document.getElementById('fromUOM').value;
            const toUOM = document.getElementById('toUOM').value;
            const conversionValue = parseFloat(document.getElementById('conversionValue').value);

            if (!fromUOM) {
                alert('Please select From UOM');
                document.getElementById('fromUOM').focus();
                return false;
            }

            if (!toUOM) {
                alert('Please select To UOM');
                document.getElementById('toUOM').focus();
                return false;
            }

            if (!conversionValue || conversionValue <= 0) {
                alert('Please enter a valid conversion value (greater than 0)');
                document.getElementById('conversionValue').focus();
                return false;
            }

            // Confirm
            if (!confirm(`Create conversion: 1 ${toUOM} = ${conversionValue} ${fromUOM}?`)) {
                return false;
            }

            // Build conversion data
            // Factor = number of FromUOM units per one ToUOM unit (e.g., 1000 ea per 1 BX1000)
            // Multiply = always 1 for standard conversions
            const conversion = {
                FromUOM: fromUOM,
                ToUOM: toUOM,
                Multiply: 1,
                Factor: conversionValue,
                Description: `1 ${toUOM} = ${conversionValue} ${fromUOM}`
            };

            // Query import headers to get the correct format
            console.log('Querying import headers for ImportUnitOfMeasureConversions...');
            const headerPayload = {
                "ImportHeaderRq": {
                    "Type": "ImportUnitOfMeasureConversions"
                }
            };

            try {
                const headerResponse = runApiRequest('ImportHeaderRq', JSON.stringify(headerPayload));
                console.log('Import Headers Response:', headerResponse);

                if (headerResponse) {
                    const headerResult = typeof headerResponse === 'string' ? JSON.parse(headerResponse) : headerResponse;
                    console.log('Import Headers Parsed:', headerResult);

                    if (headerResult && headerResult.ImportHeaderRs && headerResult.ImportHeaderRs.Header) {
                        console.log('Expected CSV Headers:', headerResult.ImportHeaderRs.Header);
                    }
                }
            } catch (e) {
                console.error('Error querying import headers:', e);
            }

            // Build CSV rows with correct column order from ImportHeaderRs
            // Expected order: ToUOM, FromUOM, Description, Factor, Multiply
            const headers = ['ToUOM', 'FromUOM', 'Description', 'Factor', 'Multiply'];
            let rows = [];

            // Header row (required by API)
            rows.push(headers.map(h => '"' + h + '"').join(','));

            // Data row
            const values = headers.map(h => {
                const value = conversion[h] || '';
                return '"' + String(value).replace(/"/g, '""') + '"';
            });
            rows.push(values.join(','));

            // Build API request
            const payload = {
                "ImportRq": {
                    "Type": "ImportUnitOfMeasureConversions",
                    "Rows": {
                        "Row": rows
                    }
                }
            };

            console.log('Create UOM Conversion Request:', payload);
            console.log('Conversion CSV:', rows);
            showLoading('Creating UOM conversion in Fishbowl...');

            try {
                const response = runApiRequest('ImportRq', JSON.stringify(payload));
                console.log('Create UOM Conversion Response:', response);
                hideLoading();

                if (!response) {
                    alert('Create UOM Conversion failed: No response from API');
                    return false;
                }

                const result = typeof response === 'string' ? JSON.parse(response) : response;

                if (result && result.ImportRs && result.ImportRs.statusCode === 1000) {
                    alert(`Successfully created UOM conversion!\n\n1 ${toUOM} = ${conversionValue} ${fromUOM}\n\nRevalidating data...`);

                    // Reload conversions and revalidate
                    loadFishbowlReferenceData();
                    revalidateData();

                    return true;
                } else {
                    let errorMsg = 'Create UOM Conversion failed';
                    if (result && result.ImportRs) {
                        errorMsg += `\nStatus Code: ${result.ImportRs.statusCode}`;
                        if (result.ImportRs.statusMessage) {
                            errorMsg += `\nMessage: ${result.ImportRs.statusMessage}`;
                        }
                    }
                    console.error('Create UOM Conversion Error:', result);
                    alert(errorMsg);
                    return false;
                }
            } catch (error) {
                hideLoading();
                console.error('Error creating UOM conversion:', error);
                alert('Error creating UOM conversion: ' + error.message);
                return false;
            }
        });
    }

    // ============================================
    // Column Sorting and Quick Fill
    // ============================================

    function sortBy(column) {
        // Toggle direction if same column, otherwise default to ascending
        if (sortState.column === column) {
            sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
        } else {
            sortState.column = column;
            sortState.direction = 'asc';
        }

        // Sort validationResults based on column
        validationResults.sort((a, b) => {
            let aVal, bVal;

            if (column === 'rowNum') {
                aVal = a.rowNum;
                bVal = b.rowNum;
            } else {
                // Get values from csvData
                aVal = csvData[a.rowIndex][column] || '';
                bVal = csvData[b.rowIndex][column] || '';

                // Convert to lowercase for case-insensitive string comparison
                if (typeof aVal === 'string') aVal = aVal.toLowerCase();
                if (typeof bVal === 'string') bVal = bVal.toLowerCase();
            }

            // Compare
            if (aVal < bVal) return sortState.direction === 'asc' ? -1 : 1;
            if (aVal > bVal) return sortState.direction === 'asc' ? 1 : -1;
            return 0;
        });

        // Re-render with current filters
        applyFilters();
    }

    function quickFillColumn(column, value) {
        if (!value) return; // Empty selection, do nothing

        // Count ALL empty cells across entire dataset
        let emptyCount = 0;
        let nonEmptyCount = 0;
        let sampleNonEmpty = [];

        csvData.forEach(row => {
            const cellValue = row[column];
            // Check if empty: undefined, null, empty string, or whitespace only
            if (cellValue === undefined || cellValue === null || cellValue === '' || (typeof cellValue === 'string' && cellValue.trim() === '')) {
                emptyCount++;
            } else {
                nonEmptyCount++;
                // Collect sample of non-empty values for debugging
                if (sampleNonEmpty.length < 5) {
                    sampleNonEmpty.push(`"${cellValue}" (length: ${cellValue.length})`);
                }
            }
        });

        console.log(`Quick-fill check: Column="${column}", Value="${value}", EmptyCount=${emptyCount}, NonEmptyCount=${nonEmptyCount}, TotalRows=${csvData.length}`);
        if (sampleNonEmpty.length > 0) {
            console.log(`Sample non-empty ${column} values:`, sampleNonEmpty.join(', '));
        }

        if (emptyCount === 0) {
            alert(`No empty ${column} cells found in the dataset.\n\nAll cells contain values. Check debug console for details.`);
            return;
        }

        // Confirm with user - make it clear it fills ALL rows (including hidden)
        const msg = `Fill ${emptyCount} empty ${column} cells with "${value}"?\n\nThis will fill ALL empty cells across the entire dataset\n(including rows not currently visible due to filters).`;
        if (!confirm(msg)) {
            return;
        }

        // Fill ALL empty cells
        let filledCount = 0;
        csvData.forEach(row => {
            const cellValue = row[column];
            if (cellValue === undefined || cellValue === null || cellValue === '' || (typeof cellValue === 'string' && cellValue.trim() === '')) {
                row[column] = value;
                filledCount++;
            }
        });

        console.log(`Quick-filled ${filledCount} ${column} cells with "${value}"`);

        // Re-validate immediately (not debounced) to ensure changes are applied
        revalidateData();

        // Reset dropdown
        event.target.value = '';
    }

    function replaceAllInColumn(column, oldValue, newValue) {
        if (!newValue) return; // Empty selection, do nothing

        // Count cells that match oldValue
        let matchCount = 0;
        csvData.forEach(row => {
            const cellValue = row[column];
            if (cellValue === oldValue) {
                matchCount++;
            }
        });

        console.log(`Replace-all check: Column="${column}", OldValue="${oldValue}", NewValue="${newValue}", MatchCount=${matchCount}, TotalRows=${csvData.length}`);

        if (matchCount === 0) {
            alert(`No cells found with value "${oldValue}" in column ${column}.`);
            return;
        }

        // Confirm with user
        const msg = `Replace ${matchCount} cells containing "${oldValue}" with "${newValue}" in column ${column}?`;
        if (!confirm(msg)) {
            return;
        }

        // Replace all matching cells
        let replacedCount = 0;
        csvData.forEach(row => {
            const cellValue = row[column];
            if (cellValue === oldValue) {
                row[column] = newValue;
                replacedCount++;
            }
        });

        console.log(`Replaced ${replacedCount} ${column} cells: "${oldValue}" ‚Üí "${newValue}"`);

        // Re-validate immediately (not debounced) to ensure changes are applied
        revalidateData();

        // Reset dropdown
        event.target.value = '';
    }

    // Handler for column actions (fill or replace)
    function handleColumnAction(column, actionValue) {
        if (!actionValue) return;

        // Parse action: "FILL:value" or "REPLACE:oldValue:newValue"
        if (actionValue.startsWith('FILL:')) {
            const value = actionValue.substring(5);
            quickFillColumn(column, value);
        } else if (actionValue.startsWith('REPLACE:')) {
            const parts = actionValue.substring(8).split(':');
            if (parts.length === 2) {
                replaceAllInColumn(column, parts[0], parts[1]);
            }
        }
    }

    // ============================================
    // Results Table Rendering
    // ============================================

    function renderTable(results) {
        const thead = document.getElementById('tableHeader');
        const tbody = document.getElementById('tableBody');
        const tableContainer = document.querySelector('.results-table-container');

        // Build header - show status, row number, then visible columns (limit to avoid overflow)
        let visibleHeaders = ['PartNumber', 'PartDescription'];

        // Add other headers that have data
        csvHeaders.forEach(header => {
            if (!visibleHeaders.includes(header)) {
                const hasData = csvData.some(row => row[header] && row[header].trim() !== '');
                if (hasData) {
                    visibleHeaders.push(header);
                }
            }
        });

        // Limit columns for display (show first 10)
        const displayHeaders = visibleHeaders.slice(0, 10);
        const hasMoreColumns = visibleHeaders.length > 10;

        // Build sortable headers with quick-fill dropdowns
        let headerRow1 = '<tr>';
        headerRow1 += '<th class="row-status">Status</th>';
        headerRow1 += '<th onclick="sortBy(\'rowNum\')" style="cursor: pointer;">Row ' + (sortState.column === 'rowNum' ? (sortState.direction === 'asc' ? '‚ñ≤' : '‚ñº') : '') + '</th>';

        displayHeaders.forEach(h => {
            const sortIndicator = sortState.column === h ? (sortState.direction === 'asc' ? '‚ñ≤' : '‚ñº') : '';
            headerRow1 += `<th onclick="sortBy('${h}')" style="cursor: pointer;">${h} ${sortIndicator}</th>`;
        });

        if (hasMoreColumns) headerRow1 += '<th>...</th>';
        headerRow1 += '<th>Issues</th>';
        headerRow1 += '</tr>';

        // Second row: Quick-fill dropdowns for applicable columns
        let headerRow2 = '<tr class="quick-fill-row">';
        headerRow2 += '<th></th><th></th>'; // Status and Row columns

        displayHeaders.forEach(h => {
            const colDef = PPP_COLUMNS[h];
            let dropdown = '';

            // Add dropdown for columns with valid values or specific known columns
            if (h === 'Active') {
                dropdown = `<select onchange="quickFillColumn('${h}', this.value)" style="width: 100%; font-size: 11px; padding: 2px;">
                    <option value="">Quick Fill...</option>
                    <option value="TRUE">Fill empty ‚Üí TRUE</option>
                    <option value="FALSE">Fill empty ‚Üí FALSE</option>
                </select>`;
            } else if (h === 'PartTaxCode' && fishbowlData.taxCodes.length > 0) {
                const taxOpts = fishbowlData.taxCodes.map(tc =>
                    `<option value="${escapeHtml(tc.code)}">${escapeHtml(tc.name)}</option>`
                ).join('');
                dropdown = `<select onchange="quickFillColumn('${h}', this.value)" style="width: 100%; font-size: 11px; padding: 2px;">
                    <option value="">Quick Fill...</option>
                    ${taxOpts}
                </select>`;
            } else if (h === 'PartTypeID' && fishbowlData.partTypes.length > 0) {
                const ptOpts = fishbowlData.partTypes.map(pt =>
                    `<option value="${pt.id}">${escapeHtml(pt.name)}</option>`
                ).join('');
                dropdown = `<select onchange="quickFillColumn('${h}', this.value)" style="width: 100%; font-size: 11px; padding: 2px;">
                    <option value="">Quick Fill...</option>
                    ${ptOpts}
                </select>`;
            } else if (h === 'UOM' && fishbowlData.uoms.length > 0) {
                // Find invalid UOM values in dataset
                const invalidUOMs = new Set();
                csvData.forEach(row => {
                    const uomVal = row[h];
                    if (uomVal && uomVal.trim() !== '' && !fishbowlData.uoms.includes(uomVal)) {
                        invalidUOMs.add(uomVal);
                    }
                });

                // Fill options
                const fillOpts = fishbowlData.uoms.map(uom =>
                    `<option value="FILL:${escapeHtml(uom)}">Fill empty ‚Üí ${escapeHtml(uom)}</option>`
                ).join('');

                // Replace options for invalid values
                let replaceOpts = '';
                if (invalidUOMs.size > 0) {
                    replaceOpts = Array.from(invalidUOMs).map(invalidUOM => {
                        // For each invalid UOM, offer to replace with each valid UOM
                        const subOpts = fishbowlData.uoms.slice(0, 3).map(validUOM => // Limit to first 3 to avoid huge dropdown
                            `<option value="REPLACE:${escapeHtml(invalidUOM)}:${escapeHtml(validUOM)}">Replace "${escapeHtml(invalidUOM)}" ‚Üí ${escapeHtml(validUOM)}</option>`
                        ).join('');
                        return subOpts;
                    }).join('');
                }

                dropdown = `<select onchange="handleColumnAction('${h}', this.value); this.value='';" style="width: 100%; font-size: 11px; padding: 2px;">
                    <option value="">Actions...</option>
                    <optgroup label="Fill Empty">
                        ${fillOpts}
                    </optgroup>
                    ${replaceOpts ? `<optgroup label="Replace Invalid">${replaceOpts}</optgroup>` : ''}
                </select>`;
            } else if (colDef && colDef.validValues) {
                const valOpts = colDef.validValues.map(v =>
                    `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`
                ).join('');
                dropdown = `<select onchange="quickFillColumn('${h}', this.value)" style="width: 100%; font-size: 11px; padding: 2px;">
                    <option value="">Quick Fill...</option>
                    ${valOpts}
                </select>`;
            }

            headerRow2 += `<th style="padding: 2px;">${dropdown}</th>`;
        });

        if (hasMoreColumns) headerRow2 += '<th></th>';
        headerRow2 += '<th></th>'; // Issues column
        headerRow2 += '</tr>';

        thead.innerHTML = headerRow1 + headerRow2;

        // Virtual scrolling: determine which rows to render
        let rowsToRender = results;
        let startIndex = 0;
        let endIndex = results.length;

        if (virtualScrollState.enabled && tableContainer) {
            // Calculate visible range based on scroll position
            const scrollTop = virtualScrollState.scrollTop;
            const viewportHeight = virtualScrollState.viewportHeight;

            startIndex = Math.floor(scrollTop / ROW_HEIGHT) - BUFFER_ROWS;
            endIndex = Math.ceil((scrollTop + viewportHeight) / ROW_HEIGHT) + BUFFER_ROWS;

            startIndex = Math.max(0, startIndex);
            endIndex = Math.min(results.length, endIndex);

            rowsToRender = results.slice(startIndex, endIndex);

            virtualScrollState.visibleStartIndex = startIndex;
            virtualScrollState.visibleEndIndex = endIndex;
        }

        // Build body
        let html = '';

        // Add top spacer for virtual scrolling
        if (virtualScrollState.enabled && startIndex > 0) {
            const spacerHeight = startIndex * ROW_HEIGHT;
            html += `<tr><td colspan="${displayHeaders.length + 4}" style="height: ${spacerHeight}px; padding: 0;"></td></tr>`;
        }

        rowsToRender.forEach((result, displayIdx) => {
            const idx = virtualScrollState.enabled ? startIndex + displayIdx : displayIdx;
            const row = csvData[result.rowIndex];
            const rowClass = result.status === 'error' ? 'row-error' :
                            (result.status === 'warning' ? 'row-warning' : '');
            const statusIcon = result.status === 'valid' ? '‚úÖ' :
                              (result.status === 'warning' ? '‚ö†Ô∏è' : '‚ùå');
            const statusClass = result.status;

            html += `<tr class="${rowClass}" id="row-${idx}">`;
            html += `<td class="row-status"><span class="status-icon ${statusClass}">${statusIcon}</span></td>`;
            html += `<td>${result.rowNum}</td>`;

            displayHeaders.forEach(header => {
                const value = row[header] || '';
                const cellClass = result.cellErrors[header] ? 'cell-error' :
                                 (result.cellWarnings[header] ? 'cell-warning' : '');

                // Make certain fields editable with dropdowns
                if (header === 'Active') {
                    html += `<td class="${cellClass}" style="min-width: 120px;">
                        <select onchange="updateCell(${result.rowIndex}, '${header}', this.value)" style="width: 100%; padding: 4px;">
                            <option value="" ${value === '' ? 'selected' : ''}></option>
                            <option value="TRUE" ${value === 'TRUE' ? 'selected' : ''}>TRUE</option>
                            <option value="FALSE" ${value === 'FALSE' ? 'selected' : ''}>FALSE</option>
                        </select>
                    </td>`;
                } else if (header === 'PartTaxCode') {
                    if (fishbowlData.taxCodes.length > 0) {
                        const taxOptions = fishbowlData.taxCodes
                            .map(tc => `<option value="${escapeHtml(tc.code)}" ${value === tc.code ? 'selected' : ''}>${escapeHtml(tc.name)} (${escapeHtml(tc.code)})</option>`)
                            .join('');
                        html += `<td class="${cellClass}">
                            <select onchange="updateCell(${result.rowIndex}, '${header}', this.value)" style="width: 100%; padding: 2px; font-size: 11px;">
                                <option value="" ${value === '' ? 'selected' : ''}></option>
                                ${taxOptions}
                            </select>
                        </td>`;
                    } else {
                        html += `<td class="${cellClass}">${escapeHtml(value)}</td>`;
                    }
                } else if (header === 'PartTypeID') {
                    if (fishbowlData.partTypes.length > 0) {
                        const ptOptions = fishbowlData.partTypes
                            .map(pt => `<option value="${pt.id}" ${value == pt.id ? 'selected' : ''}>${escapeHtml(pt.name)} (${pt.id})</option>`)
                            .join('');
                        html += `<td class="${cellClass}" style="min-width: 150px;">
                            <select onchange="updateCell(${result.rowIndex}, '${header}', this.value)" style="width: 100%; padding: 4px; font-size: 11px;">
                                <option value="" ${value === '' ? 'selected' : ''}></option>
                                ${ptOptions}
                            </select>
                        </td>`;
                    } else {
                        html += `<td class="${cellClass}">${escapeHtml(value)}</td>`;
                    }
                } else if (header === 'UOM') {
                    if (fishbowlData.uoms.length > 0) {
                        const uomOptions = fishbowlData.uoms
                            .map(uom => `<option value="${escapeHtml(uom)}" ${value === uom ? 'selected' : ''}>${escapeHtml(uom)}</option>`)
                            .join('');
                        html += `<td class="${cellClass}" style="min-width: 120px;">
                            <select onchange="updateCell(${result.rowIndex}, '${header}', this.value)" style="width: 100%; padding: 4px; font-size: 11px;">
                                <option value="" ${value === '' ? 'selected' : ''}></option>
                                ${uomOptions}
                            </select>
                        </td>`;
                    } else {
                        html += `<td class="${cellClass}">${escapeHtml(value)}</td>`;
                    }
                } else {
                    html += `<td class="${cellClass}">${escapeHtml(value)}</td>`;
                }
            });

            if (hasMoreColumns) {
                html += `<td style="color: var(--fb-text-secondary); font-style: italic;">+${visibleHeaders.length - 10} cols</td>`;
            }

            // Issues column
            const totalIssues = result.errors.length + result.warnings.length;
            if (totalIssues > 0) {
                html += `<td>
                    <button class="expand-btn" onclick="toggleRowDetails(${idx})">
                        ${totalIssues} issue${totalIssues > 1 ? 's' : ''} ‚ñº
                    </button>
                </td>`;
            } else {
                html += `<td style="color: var(--fb-success);">None</td>`;
            }

            html += `</tr>`;

            // Hidden details row
            if (totalIssues > 0) {
                html += `<tr class="row-details" id="details-${idx}">
                    <td colspan="${displayHeaders.length + 4}">
                        <div class="error-details">
                            ${result.errors.map(e => `
                                <div class="error-item">
                                    <span class="error-field">${e.field}:</span>
                                    <span class="error-message">${e.message}</span>
                                    ${e.suggestion ? `<span class="error-suggestion">üí° ${e.suggestion}</span>` : ''}
                                </div>
                            `).join('')}
                            ${result.warnings.map(w => `
                                <div class="error-item warning-item">
                                    <span class="error-field" style="color: var(--fb-warning);">${w.field}:</span>
                                    <span class="error-message">${w.message}</span>
                                    ${w.suggestion ? `<span class="error-suggestion">üí° ${w.suggestion}</span>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </td>
                </tr>`;
            }
        });

        // Add bottom spacer for virtual scrolling
        if (virtualScrollState.enabled && endIndex < results.length) {
            const remainingRows = results.length - endIndex;
            const spacerHeight = remainingRows * ROW_HEIGHT;
            html += `<tr><td colspan="${displayHeaders.length + 4}" style="height: ${spacerHeight}px; padding: 0;"></td></tr>`;
        }

        tbody.innerHTML = html;

        // Setup scroll listener for virtual scrolling (only once)
        if (virtualScrollState.enabled && tableContainer && !tableContainer.dataset.scrollListenerAttached) {
            tableContainer.addEventListener('scroll', handleTableScroll);
            tableContainer.dataset.scrollListenerAttached = 'true';
            console.log('Virtual scroll listener attached');
        }
    }

    // Handle table scroll for virtual scrolling
    function handleTableScroll() {
        const tableContainer = document.querySelector('.results-table-container');
        if (!tableContainer || !virtualScrollState.enabled) return;

        virtualScrollState.scrollTop = tableContainer.scrollTop;
        virtualScrollState.viewportHeight = tableContainer.clientHeight;

        // Re-render only visible rows
        const statusFilter = document.getElementById('filterStatus').value;
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();

        let filtered = validationResults.filter(result => {
            // Status filter
            if (statusFilter !== 'all') {
                if (statusFilter === 'errors' && result.status !== 'error') return false;
                if (statusFilter === 'warnings' && result.status !== 'warning') return false;
                if (statusFilter === 'valid' && result.status !== 'valid') return false;
            }

            // Search filter
            if (searchTerm) {
                const row = csvData[result.rowIndex];
                const rowText = Object.values(row).join(' ').toLowerCase();
                if (!rowText.includes(searchTerm)) return false;
            }

            return true;
        });

        renderTable(filtered);
    }

    function toggleRowDetails(idx) {
        const detailsRow = document.getElementById('details-' + idx);
        if (detailsRow) {
            detailsRow.classList.toggle('expanded');
        }
    }

    // Debounced re-validation function
    const debouncedRevalidate = debounce(async function() {
        showLoading('Re-validating...');
        await validateData();
        renderResults();
        hideLoading();
    }, 500);

    function updateCell(rowIndex, field, newValue) {
        if (rowIndex >= 0 && rowIndex < csvData.length) {
            csvData[rowIndex][field] = newValue;
            // Re-validate after cell update (debounced to avoid re-validating on every keystroke)
            debouncedRevalidate();
        }
    }

    function escapeHtml(text) {
        if (!text) return '';
        return text
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;');
    }

    // ============================================
    // Filtering
    // ============================================

    function applyFilters() {
        const statusFilter = document.getElementById('filterStatus').value;
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();

        let filtered = validationResults.filter(result => {
            // Status filter
            if (statusFilter !== 'all') {
                if (statusFilter === 'errors' && result.status !== 'error') return false;
                if (statusFilter === 'warnings' && result.status !== 'warning') return false;
                if (statusFilter === 'valid' && result.status !== 'valid') return false;
            }

            // Search filter
            if (searchTerm) {
                const row = csvData[result.rowIndex];
                const rowText = Object.values(row).join(' ').toLowerCase();
                if (!rowText.includes(searchTerm)) return false;
            }

            return true;
        });

        renderTable(filtered);
    }

    // ============================================
    // Export Functions
    // ============================================

    function exportValidRows() {
        const validResults = validationResults.filter(r => r.status === 'valid');
        if (validResults.length === 0) {
            alert('No valid rows to export.');
            return;
        }

        const validRows = validResults.map(r => csvData[r.rowIndex]);
        exportCSV(validRows, 'PPP_Valid_Rows.csv');
    }

    function exportAllWithFixes() {
        // Export all rows with a comment column for issues
        const exportData = csvData.map((row, idx) => {
            const result = validationResults[idx];
            const newRow = { ...row };

            // Add issues as a comment
            if (result.errors.length > 0 || result.warnings.length > 0) {
                const issues = [
                    ...result.errors.map(e => `ERROR: ${e.field} - ${e.message}`),
                    ...result.warnings.map(w => `WARNING: ${w.field} - ${w.message}`)
                ];
                newRow['_ValidationIssues'] = issues.join('; ');
            } else {
                newRow['_ValidationIssues'] = 'OK';
            }

            return newRow;
        });

        exportCSV(exportData, 'PPP_Validated.csv', [...csvHeaders, '_ValidationIssues']);
    }

    function exportCSV(data, filename, headers) {
        headers = headers || csvHeaders;

        let csv = headers.map(h => '"' + h.replace(/"/g, '""') + '"').join(',') + '\n';

        data.forEach(row => {
            const values = headers.map(h => {
                let value = row[h] || '';
                // Escape quotes and wrap in quotes
                value = '"' + String(value).replace(/"/g, '""') + '"';
                return value;
            });
            csv += values.join(',') + '\n';
        });

        // Download
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(url);
    }

    function importToFishbowl() {
        // Get valid rows only
        const validResults = validationResults.filter(r => r.status === 'valid');

        if (validResults.length === 0) {
            alert('No valid rows to import. Please fix all errors and warnings first.');
            return;
        }

        const validRows = validResults.map(r => csvData[r.rowIndex]);

        if (!confirm(`Import ${validRows.length} valid rows to Fishbowl?\n\nThis will create/update parts, products, and vendor pricing in Fishbowl.`)) {
            return;
        }

        showLoading('Preparing data for import...');

        try {
            // Build rows array in the format expected by Fishbowl API
            let rows = [];

            // Header row
            rows.push(csvHeaders.map(h => '"' + h.replace(/"/g, '""') + '"').join(','));

            // Data rows
            validRows.forEach(function(row) {
                const values = csvHeaders.map(h => {
                    let value = row[h] || '';
                    value = '"' + String(value).replace(/"/g, '""') + '"';
                    return value;
                });
                rows.push(values.join(','));
            });

            // Build API request payload
            let payload = {
                "ImportRq": {
                    "Type": "ImportPartProductAndVendorPricing",
                    "Rows": {
                        "Row": rows
                    }
                }
            };

            console.log('Import Request:', payload);
            console.log('First 3 rows:', rows.slice(0, 3));

            showLoading('Importing ' + validRows.length + ' rows to Fishbowl...');

            // Call the Fishbowl API
            let response = runApiRequest('ImportRq', JSON.stringify(payload));
            console.log('Import Response (raw):', response);

            hideLoading();

            if (!response) {
                alert('Import failed: No response from API');
                return;
            }

            // Parse response
            let result = typeof response === 'string' ? JSON.parse(response) : response;
            console.log('Import Result (parsed):', result);

            // Check for success
            if (result && result.ImportRs && result.ImportRs.statusCode === 1000) {
                alert('Successfully imported ' + validRows.length + ' rows to Fishbowl!');

                // Optionally clear data after successful import
                if (confirm('Import successful! Clear the validator?')) {
                    clearData();
                }
            } else {
                let errorMsg = 'Import failed';
                let statusMessage = '';

                if (result && result.ImportRs && result.ImportRs.statusMessage) {
                    statusMessage = result.ImportRs.statusMessage;
                    errorMsg += ': ' + statusMessage;
                } else if (result && result.ErrorRs && result.ErrorRs.statusMessage) {
                    statusMessage = result.ErrorRs.statusMessage;
                    errorMsg += ': ' + statusMessage;
                } else {
                    errorMsg += ': ' + JSON.stringify(result);
                }

                // Try to extract line number from error message
                let lineNumberMatch = statusMessage.match(/Line Number:\s*(\d+)/i);
                if (lineNumberMatch && lineNumberMatch[1]) {
                    let csvLineNum = parseInt(lineNumberMatch[1]);
                    let arrayIndex = csvLineNum - 1;

                    if (arrayIndex >= 0 && arrayIndex < rows.length) {
                        errorMsg += '\n\nError on CSV line ' + csvLineNum + ':\n' + rows[arrayIndex];
                        console.error('Error on CSV line ' + csvLineNum + ' (array index ' + arrayIndex + '): ' + rows[arrayIndex]);
                    }
                }

                alert(errorMsg);
            }

        } catch (error) {
            hideLoading();
            console.error('Error during import:', error);
            alert('Import error: ' + error.message);
        }
    }

    // ============================================
    // Utility Functions
    // ============================================

    async function revalidateData() {
        if (csvData.length === 0) {
            alert('No data to validate. Please upload a file first.');
            return;
        }

        showLoading('Re-loading Fishbowl data...');
        loadFishbowlReferenceData();

        showLoading('Re-validating...');
        await validateData(); // Now async!

        showLoading('Rendering results...');
        renderResults();

        hideLoading();
    }

    function clearData() {
        csvData = [];
        csvHeaders = [];
        validationResults = [];
        consolidatedIssues = {};

        document.getElementById('fileName').textContent = '';
        document.getElementById('fileInput').value = '';
        document.getElementById('summaryStats').classList.add('hidden');
        document.getElementById('filterControls').classList.add('hidden');
        document.getElementById('resultsSection').classList.add('hidden');
        document.getElementById('actionButtons').classList.add('hidden');
        document.getElementById('consolidatedIssues').classList.add('hidden');
        document.getElementById('tableBody').innerHTML = '';
    }

    function showLoading(text) {
        document.getElementById('loadingText').textContent = text || 'Processing...';
        document.getElementById('loadingOverlay').classList.remove('hidden');
    }

    function hideLoading() {
        document.getElementById('loadingOverlay').classList.add('hidden');
    }

    // ============================================
    // Column Reference
    // ============================================

    function populateColumnReference() {
        const container = document.getElementById('columnRefContent');
        if (!container) return;

        let html = '';

        Object.entries(PPP_COLUMNS).forEach(([name, def]) => {
            const required = def.required ? '<span class="badge bg-danger ms-2">Required</span>' : '';
            const validValuesHtml = def.validValues ?
                `<div class="mt-2"><small class="text-info"><strong>Valid values:</strong> ${def.validValues.join(', ')}</small></div>` : '';

            html += `
                <div class="card card-compact mb-2">
                    <div class="card-body">
                        <h6 class="card-title mb-1">
                            ${name}
                            <span class="badge bg-secondary ms-2">${def.type}</span>
                            ${required}
                        </h6>
                        <p class="card-text mb-0"><small>${def.desc}</small></p>
                        ${validValuesHtml}
                    </div>
                </div>
            `;
        });

        // Add note about custom fields
        html += `
            <div class="card card-compact mb-2 border-warning">
                <div class="card-body bg-warning bg-opacity-10">
                    <h6 class="card-title mb-1">
                        CF-*
                        <span class="badge bg-secondary ms-2">Custom Field</span>
                    </h6>
                    <p class="card-text mb-0"><small>Any column starting with "CF-" is treated as a custom field. The field name after "CF-" must match an existing custom field in Fishbowl.</small></p>
                </div>
            </div>
        `;

        container.innerHTML = html;
    }

    // Column reference toggle is now handled by Bootstrap offcanvas
    function toggleColumnReference() {
        // Deprecated - kept for compatibility
        const toggle = document.getElementById('refToggle');
        if (!toggle) return;

        const grid = document.getElementById('columnGrid');
        if (!grid) return;

        if (grid.classList.contains('hidden')) {
            grid.classList.remove('hidden');
            toggle.textContent = '‚ñº';
        } else {
            grid.classList.add('hidden');
            toggle.textContent = '‚ñ∂';
        }
    }

    // ============================================
    // Configuration Update Functions
    // ============================================

    function updateBatchSize(value) {
        const numValue = parseInt(value, 10);
        if (numValue >= 50 && numValue <= 1000) {
            BATCH_SIZE = numValue;
            console.log(`Batch size updated to: ${BATCH_SIZE}`);
        }
    }

    function updateRowHeight(value) {
        const numValue = parseInt(value, 10);
        if (numValue >= 25 && numValue <= 60) {
            ROW_HEIGHT = numValue;
            console.log(`Row height updated to: ${ROW_HEIGHT}`);
            // Re-render if data is loaded
            if (csvData.length > 0) {
                renderTable(validationResults);
            }
        }
    }

    function updateBufferRows(value) {
        const numValue = parseInt(value, 10);
        if (numValue >= 5 && numValue <= 50) {
            BUFFER_ROWS = numValue;
            console.log(`Buffer rows updated to: ${BUFFER_ROWS}`);
        }
    }

    function updateVirtualScrollThreshold(value) {
        const numValue = parseInt(value, 10);
        if (numValue >= 100 && numValue <= 2000) {
            VIRTUAL_SCROLL_THRESHOLD = numValue;
            console.log(`Virtual scroll threshold updated to: ${VIRTUAL_SCROLL_THRESHOLD}`);
            // Re-render if data is loaded
            if (csvData.length > 0) {
                renderTable(validationResults);
            }
        }
    }

    function updateDebounceDelay(value) {
        const numValue = parseInt(value, 10);
        if (numValue >= 100 && numValue <= 2000) {
            DEBOUNCE_DELAY = numValue;
            console.log(`Debounce delay updated to: ${DEBOUNCE_DELAY}ms`);
            // Recreate debounced function with new delay
            debouncedRevalidate = debounce(revalidateData, DEBOUNCE_DELAY);
        }
    }

    function updateStrictMode(value) {
        STRICT_MODE = value === 'true';
        console.log(`Strict mode: ${STRICT_MODE ? 'enabled' : 'disabled'}`);
        // Re-validate if data is loaded
        if (csvData.length > 0) {
            revalidateData();
        }
    }
    </script>

    <!-- Bootstrap 5.3 JS Bundle (includes Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
