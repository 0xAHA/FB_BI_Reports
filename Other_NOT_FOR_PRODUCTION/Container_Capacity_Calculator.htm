<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Container Capacity Calculator - Fishbowl BI</title>

    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        /* ============================================
           GLOBAL STYLES & CSS VARIABLES
           ============================================ */
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        :root {
            --color-primary: #2d9cdb;
            --color-primary-dark: #1e7bb4;
            --color-sidebar: #06162d;
            --color-sidebar-hover: #0a1f3d;
        }

        /* ============================================
           TAILWIND COLOR OVERRIDES
           ============================================ */
        .bg-indigo-600 { background-color: var(--color-primary) !important; }
        .bg-indigo-50 { background-color: rgba(45, 156, 219, 0.1) !important; }
        .hover\:bg-indigo-700:hover { background-color: var(--color-primary-dark) !important; }
        .hover\:bg-indigo-50:hover { background-color: rgba(45, 156, 219, 0.1) !important; }
        .text-indigo-600 { color: var(--color-primary) !important; }
        .text-indigo-700 { color: var(--color-primary-dark) !important; }
        .border-indigo-200 { border-color: rgba(45, 156, 219, 0.3) !important; }
        .border-indigo-300 { border-color: rgba(45, 156, 219, 0.4) !important; }
        .hover\:text-indigo-600:hover { color: var(--color-primary) !important; }
        .focus\:ring-indigo-100:focus { --tw-ring-color: rgba(45, 156, 219, 0.2) !important; }
        .focus\:ring-indigo-500:focus { --tw-ring-color: var(--color-primary) !important; }
        .focus\:border-indigo-300:focus { border-color: rgba(45, 156, 219, 0.4) !important; }

        /* ============================================
           CUSTOM SCROLLBAR
           ============================================ */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* ============================================
           LOADING SPINNER
           ============================================ */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner {
            border: 3px solid #f1f5f9;
            border-top: 3px solid var(--color-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        /* ============================================
           D3 / SVG CHART STYLES
           ============================================ */
        .axis line, .axis path {
            stroke: #cbd5e1;
            shape-rendering: crispEdges;
        }
        .axis text {
            fill: #64748b;
            font-size: 11px;
            font-weight: 500;
        }
        .tooltip {
            position: absolute;
            background: rgba(15, 23, 42, 0.95);
            color: white;
            padding: 12px 16px;
            border-radius: 10px;
            pointer-events: none;
            font-size: 13px;
            line-height: 1.6;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .tooltip-label {
            color: #94a3b8;
            display: inline-block;
            min-width: 80px;
            font-weight: 500;
        }
        .tooltip-value {
            color: #ffffff;
            font-weight: 600;
            margin-left: 8px;
        }

        /* ============================================
           ORDER LINK STYLES
           ============================================ */
        .order-link {
            color: var(--color-primary);
            text-decoration: none;
            font-weight: 600;
            transition: color 0.2s ease;
            cursor: pointer;
        }
        .order-link:hover {
            color: var(--color-primary-dark);
            text-decoration: underline;
        }

        /* ============================================
           TABLE STYLES
           ============================================ */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        .data-table th {
            background-color: #f8fafc;
            padding: 10px 12px;
            text-align: left;
            font-size: 11px;
            font-weight: 700;
            color: #475569;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }
        .data-table th:hover {
            background-color: #e9ecef;
        }
        .data-table th .sort-icon {
            margin-left: 4px;
            font-size: 10px;
            color: #94a3b8;
        }
        .data-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 13px;
            color: #334155;
        }
        .data-table tbody tr:hover {
            background-color: #f0f9ff;
        }
        .data-table tbody tr:nth-child(even) {
            background-color: #fafafa;
        }
        .data-table tbody tr:nth-child(even):hover {
            background-color: #f0f9ff;
        }

        /* ============================================
           PO SELECTION LIST
           ============================================ */
        .po-list-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer;
            transition: background-color 0.15s;
        }
        .po-list-item:hover {
            background-color: #f0f9ff;
        }
        .po-list-item.selected {
            background-color: rgba(45, 156, 219, 0.08);
            border-left: 3px solid var(--color-primary);
        }
        .po-list-item input[type="checkbox"] {
            accent-color: var(--color-primary);
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        /* ============================================
           ISOMETRIC CONTAINER SVG
           ============================================ */
        .container-face {
            stroke: #475569;
            stroke-width: 1.5;
            stroke-linejoin: round;
        }
        .container-top { fill: rgba(148, 163, 184, 0.25); }
        .container-right { fill: rgba(100, 116, 139, 0.20); }
        .container-front { fill: rgba(71, 85, 105, 0.15); }

        .fill-volume {
            stroke: none;
            transition: all 0.6s ease-in-out;
        }
        .fill-top { fill: rgba(45, 156, 219, 0.55); }
        .fill-right { fill: rgba(30, 123, 180, 0.50); }
        .fill-front { fill: rgba(45, 156, 219, 0.40); }

        .container-edge {
            stroke: #334155;
            stroke-width: 1;
            stroke-dasharray: 6,3;
            fill: none;
        }

        /* ============================================
           CAPACITY BAR
           ============================================ */
        .capacity-bar-bg {
            fill: #e2e8f0;
            rx: 6;
            ry: 6;
        }
        .capacity-bar-fill {
            rx: 6;
            ry: 6;
            transition: width 0.6s ease-in-out, fill 0.3s;
        }

        /* ============================================
           DIMENSION INPUT STYLES (for manual override)
           ============================================ */
        .dim-input {
            width: 70px;
            padding: 3px 6px;
            font-size: 12px;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            text-align: right;
        }
        .dim-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(45, 156, 219, 0.2);
        }

        /* ============================================
           STATUS BADGES
           ============================================ */
        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        .status-issued { background: #d4edda; color: #155724; }
        .status-partial { background: #cce5ff; color: #004085; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-picking { background: #e2e3f1; color: #383d6e; }

        /* ============================================
           RESPONSIVE CONTAINER VIS
           ============================================ */
        #containerVis {
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>

<body class="bg-slate-50">
    <div class="flex flex-col h-screen">

        <!-- ============================================
             HEADER
             ============================================ -->
        <header class="h-20 bg-white border-b border-slate-200 px-8 flex items-center justify-between flex-shrink-0 z-20 shadow-sm">
            <div class="flex items-center gap-6">
                <div>
                    <h1 class="text-xl font-bold text-slate-900">
                        Container Capacity Calculator
                    </h1>
                    <p class="text-xs text-slate-500 mt-0.5">Estimate shipping container fill from purchase order line items</p>
                </div>

                <!-- KPI Cards - populated dynamically -->
                <div id="kpiCards" class="hidden lg:flex items-center gap-3">
                    <!-- Volume Used -->
                    <div class="px-3 py-1.5 bg-indigo-50 border border-indigo-200 rounded-lg">
                        <div class="text-[10px] font-semibold text-indigo-600 uppercase tracking-wide">Volume Used</div>
                        <div id="kpiVolumeUsed" class="text-lg font-bold text-slate-900">0 m&sup3;</div>
                    </div>
                    <!-- Capacity % -->
                    <div class="px-3 py-1.5 bg-indigo-50 border border-indigo-200 rounded-lg">
                        <div class="text-[10px] font-semibold text-indigo-600 uppercase tracking-wide">Capacity</div>
                        <div id="kpiCapacity" class="text-lg font-bold text-slate-900">0%</div>
                    </div>
                    <!-- Weight -->
                    <div class="px-3 py-1.5 bg-indigo-50 border border-indigo-200 rounded-lg">
                        <div class="text-[10px] font-semibold text-indigo-600 uppercase tracking-wide">Est. Weight</div>
                        <div id="kpiWeight" class="text-lg font-bold text-slate-900">0 kg</div>
                    </div>
                    <!-- Items -->
                    <div class="px-3 py-1.5 bg-indigo-50 border border-indigo-200 rounded-lg">
                        <div class="text-[10px] font-semibold text-indigo-600 uppercase tracking-wide">Line Items</div>
                        <div id="kpiItems" class="text-lg font-bold text-slate-900">0</div>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <button onclick="exportToCSV()"
                    class="px-3 py-2 bg-slate-100 hover:bg-slate-200 border border-slate-300 text-slate-700 rounded-lg text-xs font-semibold transition-colors flex items-center gap-2">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Export CSV
                </button>
                <button onclick="recalculate()"
                    class="px-3 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-xs font-semibold transition-colors flex items-center gap-2">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                    </svg>
                    Calculate
                </button>
                <button onclick="loadPurchaseOrders()"
                    class="p-2.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-xl transition-all" title="Refresh PO Data">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                </button>
            </div>
        </header>

        <!-- ============================================
             MAIN CONTENT
             ============================================ -->
        <div class="flex-1 overflow-y-auto custom-scrollbar">
            <div class="p-4 lg:p-8">

                <!-- ROW 1: Container Selection + PO Selection -->
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-4">

                    <!-- Container Type Selection Card -->
                    <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-4">
                        <h3 class="text-base font-bold text-slate-800 flex items-center gap-2 mb-3">
                            <svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                            </svg>
                            Container Type
                        </h3>

                        <div class="space-y-2">
                            <label class="block text-[11px] font-semibold text-slate-600 uppercase tracking-wide">Select Container</label>
                            <select id="containerType" onchange="onContainerTypeChange()"
                                class="w-full px-2.5 py-2 bg-slate-50 border border-slate-300 rounded-lg text-sm font-medium text-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300">
                                <option value="20ft">20ft Standard</option>
                                <option value="40ft" selected>40ft Standard</option>
                                <option value="40ft_hc">40ft High Cube</option>
                                <option value="custom">Custom Dimensions</option>
                            </select>

                            <!-- Container Dimensions Display / Edit -->
                            <div class="mt-3 p-3 bg-slate-50 rounded-lg border border-slate-200">
                                <div class="text-[11px] font-semibold text-slate-500 uppercase mb-2">Internal Dimensions</div>
                                <div class="grid grid-cols-3 gap-2 text-center">
                                    <div>
                                        <label class="text-[10px] text-slate-400 block">Length</label>
                                        <input type="number" id="dimLength" class="dim-input w-full" step="0.01" onchange="onDimensionChange()">
                                        <span class="text-[10px] text-slate-400">m</span>
                                    </div>
                                    <div>
                                        <label class="text-[10px] text-slate-400 block">Width</label>
                                        <input type="number" id="dimWidth" class="dim-input w-full" step="0.01" onchange="onDimensionChange()">
                                        <span class="text-[10px] text-slate-400">m</span>
                                    </div>
                                    <div>
                                        <label class="text-[10px] text-slate-400 block">Height</label>
                                        <input type="number" id="dimHeight" class="dim-input w-full" step="0.01" onchange="onDimensionChange()">
                                        <span class="text-[10px] text-slate-400">m</span>
                                    </div>
                                </div>
                                <div class="mt-2 text-center">
                                    <span class="text-xs text-slate-500">Total Volume: </span>
                                    <span id="totalVolume" class="text-sm font-bold text-slate-800">0.00 m&sup3;</span>
                                </div>
                                <div class="mt-1 text-center">
                                    <span class="text-xs text-slate-500">Max Payload: </span>
                                    <span id="maxPayload" class="text-sm font-bold text-slate-800">0 kg</span>
                                </div>
                            </div>

                            <!-- Unit of Measure for Part Dimensions -->
                            <div class="mt-3">
                                <label class="block text-[11px] font-semibold text-slate-600 uppercase tracking-wide mb-1">Part Dimension UoM</label>
                                <select id="partDimUnit" onchange="recalculate()"
                                    class="w-full px-2.5 py-1.5 bg-slate-50 border border-slate-300 rounded-lg text-sm font-medium text-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300">
                                    <option value="mm">Millimetres (mm)</option>
                                    <option value="cm">Centimetres (cm)</option>
                                    <option value="m">Metres (m)</option>
                                    <option value="in" selected>Inches (in)</option>
                                    <option value="ft">Feet (ft)</option>
                                </select>
                            </div>

                            <!-- Weight UoM -->
                            <div class="mt-2">
                                <label class="block text-[11px] font-semibold text-slate-600 uppercase tracking-wide mb-1">Part Weight UoM</label>
                                <select id="partWeightUnit" onchange="recalculate()"
                                    class="w-full px-2.5 py-1.5 bg-slate-50 border border-slate-300 rounded-lg text-sm font-medium text-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300">
                                    <option value="kg" selected>Kilograms (kg)</option>
                                    <option value="lb">Pounds (lb)</option>
                                    <option value="g">Grams (g)</option>
                                    <option value="oz">Ounces (oz)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Purchase Order Selection Card -->
                    <div class="lg:col-span-3 bg-white rounded-2xl shadow-md border border-slate-300 p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-base font-bold text-slate-800 flex items-center gap-2">
                                <svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                                </svg>
                                Select Purchase Orders
                                <span id="selectedPOCount" class="ml-2 px-2 py-0.5 text-[10px] bg-indigo-50 text-indigo-600 rounded-full font-bold">0 selected</span>
                            </h3>
                            <div class="flex items-center gap-2">
                                <!-- PO Search -->
                                <input type="text" id="poSearch" placeholder="Search POs..." onkeyup="filterPOList()"
                                    class="px-3 py-1.5 bg-slate-50 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300" style="width: 200px;">
                                <!-- Vendor Filter -->
                                <select id="vendorFilter" onchange="filterPOList()"
                                    class="px-2.5 py-1.5 bg-slate-50 border border-slate-300 rounded-lg text-sm font-medium text-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300">
                                    <option value="%">All Vendors</option>
                                </select>
                                <button onclick="selectAllVisible()" class="px-2 py-1.5 text-xs bg-slate-100 hover:bg-slate-200 border border-slate-300 text-slate-600 rounded-lg font-semibold transition-colors">
                                    Select All
                                </button>
                                <button onclick="deselectAll()" class="px-2 py-1.5 text-xs bg-slate-100 hover:bg-slate-200 border border-slate-300 text-slate-600 rounded-lg font-semibold transition-colors">
                                    Clear
                                </button>
                            </div>
                        </div>

                        <!-- PO List (scrollable) -->
                        <div id="poListContainer" class="border border-slate-200 rounded-lg overflow-y-auto custom-scrollbar" style="max-height: 220px;">
                            <div class="p-4 text-center text-slate-400 text-sm italic">Loading purchase orders...</div>
                        </div>

                        <!-- Info note about custom field -->
                        <div class="mt-2 flex items-start gap-2 text-xs text-slate-500">
                            <svg class="w-4 h-4 text-amber-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <span>
                                Only POs with a value in the <strong>container/shipping custom field</strong> are shown.
                                Part dimensions (L&times;W&times;H) and weight are read from Fishbowl product custom fields.
                                <!-- TODO: Make the custom field name configurable via BI property -->
                            </span>
                        </div>
                    </div>
                </div>

                <!-- ROW 2: Isometric Container Visualisation + Capacity Summary -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">

                    <!-- Isometric 3D Container Visualisation -->
                    <div class="lg:col-span-2 bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                                <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                                </svg>
                                Container Visualisation
                            </h3>
                            <div id="fillPercentLabel" class="text-2xl font-bold text-slate-300">0%</div>
                        </div>
                        <div id="containerVis" style="height: 350px; position: relative;"></div>
                    </div>

                    <!-- Capacity Breakdown -->
                    <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                        <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2 mb-4">
                            <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                            Capacity Summary
                        </h3>

                        <!-- Volume Gauge -->
                        <div class="mb-5">
                            <div class="flex justify-between text-xs text-slate-500 mb-1">
                                <span>Volume</span>
                                <span id="volumeSummary">0.00 / 0.00 m&sup3;</span>
                            </div>
                            <svg id="volumeBar" width="100%" height="20">
                                <rect class="capacity-bar-bg" width="100%" height="16" y="2"/>
                                <rect id="volumeBarFill" class="capacity-bar-fill" width="0%" height="16" y="2" fill="#2d9cdb"/>
                            </svg>
                            <div id="volumePercent" class="text-right text-xs font-bold text-slate-600 mt-1">0%</div>
                        </div>

                        <!-- Weight Gauge -->
                        <div class="mb-5">
                            <div class="flex justify-between text-xs text-slate-500 mb-1">
                                <span>Weight</span>
                                <span id="weightSummary">0 / 0 kg</span>
                            </div>
                            <svg id="weightBar" width="100%" height="20">
                                <rect class="capacity-bar-bg" width="100%" height="16" y="2"/>
                                <rect id="weightBarFill" class="capacity-bar-fill" width="0%" height="16" y="2" fill="#10b981"/>
                            </svg>
                            <div id="weightPercent" class="text-right text-xs font-bold text-slate-600 mt-1">0%</div>
                        </div>

                        <!-- Breakdown by PO -->
                        <div class="mt-4">
                            <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wide mb-2">Volume by PO</h4>
                            <div id="poBreakdownChart" style="height: 200px;"></div>
                        </div>

                        <!-- Warnings -->
                        <div id="warningsPanel" class="mt-4 hidden">
                            <div class="p-3 bg-amber-50 border border-amber-200 rounded-lg">
                                <div class="flex items-center gap-2 text-amber-700 text-xs font-semibold mb-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                                    </svg>
                                    Warnings
                                </div>
                                <ul id="warningsList" class="text-xs text-amber-600 space-y-1 list-disc list-inside"></ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ROW 3: Parts Detail Table -->
                <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-base font-bold text-slate-800 flex items-center gap-2">
                            <svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
                            </svg>
                            Line Item Details
                            <span id="partsCount" class="ml-2 px-2 py-0.5 text-[10px] bg-slate-100 text-slate-600 rounded-full font-bold">0 items</span>
                        </h3>
                        <div class="flex items-center gap-2">
                            <input type="text" id="partsSearch" placeholder="Search parts..." onkeyup="filterPartsTable()"
                                class="px-3 py-1.5 bg-slate-50 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300" style="width: 200px;">
                            <label class="flex items-center gap-1.5 text-xs text-slate-600 whitespace-nowrap">
                                <input type="checkbox" id="hideNoDims" onchange="filterPartsTable()" class="accent-[#2d9cdb]">
                                Hide missing dims
                            </label>
                        </div>
                    </div>

                    <div class="overflow-auto custom-scrollbar" style="max-height: 400px;">
                        <table class="data-table" id="partsTable">
                            <thead>
                                <tr>
                                    <th onclick="sortParts('poNum')">PO # <span class="sort-icon">&#8645;</span></th>
                                    <th onclick="sortParts('partNum')">Part # <span class="sort-icon">&#8645;</span></th>
                                    <th onclick="sortParts('partDesc')">Description <span class="sort-icon">&#8645;</span></th>
                                    <th onclick="sortParts('qty')" class="text-right">Qty <span class="sort-icon">&#8645;</span></th>
                                    <th onclick="sortParts('length')" class="text-right">L <span class="sort-icon">&#8645;</span></th>
                                    <th onclick="sortParts('width')" class="text-right">W <span class="sort-icon">&#8645;</span></th>
                                    <th onclick="sortParts('height')" class="text-right">H <span class="sort-icon">&#8645;</span></th>
                                    <th onclick="sortParts('unitWeight')" class="text-right">Unit Wt <span class="sort-icon">&#8645;</span></th>
                                    <th onclick="sortParts('unitVolume')" class="text-right">Unit Vol (m&sup3;) <span class="sort-icon">&#8645;</span></th>
                                    <th onclick="sortParts('totalVolume')" class="text-right">Total Vol (m&sup3;) <span class="sort-icon">&#8645;</span></th>
                                    <th onclick="sortParts('totalWeight')" class="text-right">Total Wt (kg) <span class="sort-icon">&#8645;</span></th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="partsTableBody">
                                <tr>
                                    <td colspan="12" class="text-center text-slate-400 py-8 italic">Select purchase orders above to view line items</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Debug Console -->
                <div id="debugConsoleContainer" class="mt-6" style="display: none;">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                        <button onclick="toggleDebugConsole()" class="w-full px-6 py-3 flex items-center justify-between hover:bg-slate-50 transition-colors">
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/>
                                </svg>
                                <span class="text-sm font-semibold text-slate-700">Debug Console</span>
                            </div>
                            <svg id="debugChevron" class="w-5 h-5 text-slate-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <div id="debugContent" class="hidden border-t border-slate-200">
                            <div class="bg-slate-900 px-4 py-2 flex items-center justify-between">
                                <span class="text-xs text-slate-400 font-mono">Query & Application Diagnostics</span>
                                <button onclick="clearDebugLog()" class="text-xs text-slate-400 hover:text-white transition-colors">Clear</button>
                            </div>
                            <div id="debugLog" class="bg-slate-950 text-slate-200 p-4 font-mono text-xs max-h-96 overflow-y-auto custom-scrollbar">
                                <div class="text-slate-500 italic">Waiting for initialization...</div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- ============================================
         TOOLTIP
         ============================================ -->
    <div id="tooltip" class="tooltip"></div>

    <!-- ============================================
         LOADING OVERLAY
         ============================================ -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-xl p-8 flex flex-col items-center gap-4 shadow-2xl">
            <div class="spinner"></div>
            <p class="text-slate-700 font-semibold">Loading data...</p>
        </div>
    </div>

    <!-- ============================================
         JAVASCRIPT
         ============================================ -->
    <script>
        'use strict';

        /* ============================================
           CONFIGURATION & CONSTANTS
           ============================================ */

        // Standard container internal dimensions in metres and max payload in kg
        const CONTAINER_SPECS = {
            '20ft':    { length: 5.90,  width: 2.35, height: 2.39, maxPayload: 25000, label: "20ft Standard" },
            '40ft':    { length: 12.03, width: 2.35, height: 2.39, maxPayload: 27600, label: "40ft Standard" },
            '40ft_hc': { length: 12.03, width: 2.35, height: 2.69, maxPayload: 26580, label: "40ft High Cube" },
            'custom':  { length: 12.03, width: 2.35, height: 2.39, maxPayload: 30000, label: "Custom" }
        };

        // Conversion factors to metres
        const DIM_TO_METRES = {
            'mm': 0.001,
            'cm': 0.01,
            'm':  1,
            'in': 0.0254,
            'ft': 0.3048
        };

        // Conversion factors to kilograms
        const WEIGHT_TO_KG = {
            'kg': 1,
            'lb': 0.453592,
            'g':  0.001,
            'oz': 0.0283495
        };

        // Fishbowl configuration
        const BI_SHOW_DEBUG_PROP = typeof getProperty === 'function' ? getProperty('BI_SHOW_DEBUG', 'false') : 'false';
        const DEBUG_MODE = BI_SHOW_DEBUG_PROP === 'true' || BI_SHOW_DEBUG_PROP === true;

        // Custom field name for identifying container-eligible POs
        // TODO: Make configurable via Fishbowl property e.g. BI_CONTAINER_CUSTOM_FIELD
        const CONTAINER_CUSTOM_FIELD = typeof getProperty === 'function'
            ? getProperty('BI_CONTAINER_CUSTOM_FIELD', 'Container')
            : 'Container';

        // Custom field names for part dimensions (on the Product)
        // TODO: Confirm exact custom field names with client
        const PART_LENGTH_FIELD = typeof getProperty === 'function'
            ? getProperty('BI_PART_LENGTH_FIELD', 'Length')
            : 'Length';
        const PART_WIDTH_FIELD = typeof getProperty === 'function'
            ? getProperty('BI_PART_WIDTH_FIELD', 'Width')
            : 'Width';
        const PART_HEIGHT_FIELD = typeof getProperty === 'function'
            ? getProperty('BI_PART_HEIGHT_FIELD', 'Height')
            : 'Height';
        const PART_WEIGHT_FIELD = typeof getProperty === 'function'
            ? getProperty('BI_PART_WEIGHT_FIELD', 'Weight')
            : 'Weight';

        /* ============================================
           GLOBAL STATE
           ============================================ */
        let allPurchaseOrders = [];    // All eligible POs
        let selectedPOIds = new Set(); // Set of selected PO IDs
        let lineItems = [];            // Calculated line items from selected POs
        let filteredLineItems = [];    // After search/filter
        let partsSortColumn = 'poNum';
        let partsSortDirection = 'asc';

        /* ============================================
           UTILITY FUNCTIONS
           ============================================ */

        function debugLog(message, type) {
            if (!DEBUG_MODE) return;
            var timestamp = new Date().toLocaleTimeString();
            var logDiv = document.getElementById('debugLog');
            var placeholder = logDiv.querySelector('.italic');
            if (placeholder) logDiv.innerHTML = '';

            var colors = {
                'info': '#60a5fa', 'success': '#34d399', 'warning': '#fbbf24',
                'error': '#f87171', 'query': '#a78bfa'
            };

            var entry = document.createElement('div');
            entry.style.marginBottom = '4px';
            entry.innerHTML = '<span style="color: #64748b;">[' + timestamp + ']</span> <span style="color: ' + (colors[type] || '#e2e8f0') + ';">' + message + '</span>';
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearDebugLog() {
            document.getElementById('debugLog').innerHTML = '<div class="text-slate-500 italic">Log cleared...</div>';
        }

        function toggleDebugConsole() {
            var content = document.getElementById('debugContent');
            var chevron = document.getElementById('debugChevron');
            content.classList.toggle('hidden');
            chevron.style.transform = content.classList.contains('hidden') ? '' : 'rotate(180deg)';
        }

        function escapeSQL(str) {
            if (str === null || str === undefined) return '';
            return String(str).replace(/'/g, "''");
        }

        function formatNumber(value, decimals) {
            if (decimals === undefined) decimals = 2;
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            }).format(value);
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        /* ============================================
           CONTAINER DIMENSION MANAGEMENT
           ============================================ */

        function getContainerSpec() {
            return {
                length: parseFloat(document.getElementById('dimLength').value) || 0,
                width:  parseFloat(document.getElementById('dimWidth').value) || 0,
                height: parseFloat(document.getElementById('dimHeight').value) || 0,
                maxPayload: parseFloat(document.getElementById('maxPayload').textContent) || 0
            };
        }

        function getContainerVolume() {
            var spec = getContainerSpec();
            return spec.length * spec.width * spec.height;
        }

        function onContainerTypeChange() {
            var type = document.getElementById('containerType').value;
            var spec = CONTAINER_SPECS[type];
            var isCustom = (type === 'custom');

            document.getElementById('dimLength').value = spec.length;
            document.getElementById('dimWidth').value = spec.width;
            document.getElementById('dimHeight').value = spec.height;
            document.getElementById('dimLength').readOnly = !isCustom;
            document.getElementById('dimWidth').readOnly = !isCustom;
            document.getElementById('dimHeight').readOnly = !isCustom;

            var vol = spec.length * spec.width * spec.height;
            document.getElementById('totalVolume').textContent = formatNumber(vol) + ' m\u00B3';
            document.getElementById('maxPayload').textContent = formatNumber(spec.maxPayload, 0) + ' kg';

            recalculate();
        }

        function onDimensionChange() {
            // Force dropdown to "custom" if user edits dimensions
            document.getElementById('containerType').value = 'custom';
            var l = parseFloat(document.getElementById('dimLength').value) || 0;
            var w = parseFloat(document.getElementById('dimWidth').value) || 0;
            var h = parseFloat(document.getElementById('dimHeight').value) || 0;
            document.getElementById('totalVolume').textContent = formatNumber(l * w * h) + ' m\u00B3';
            recalculate();
        }

        /* ============================================
           PURCHASE ORDER LOADING
           ============================================ */

        function loadPurchaseOrders() {
            debugLog('Loading eligible purchase orders...', 'info');
            showLoading(true);

            try {
                var currentUser = JSON.parse(getUser());
                var userId = currentUser.id;

                // Query open POs that have a value in the container custom field
                // The custom field is on the PO header via CustomField table
                // TODO: Verify the exact join path for PO custom fields with client's Fishbowl schema
                var query =
                    "SELECT " +
                    "    Po.Id AS id, " +
                    "    Po.Num AS num, " +
                    "    Po.CustomerSO AS customerSO, " +
                    "    Po.DateIssued AS dateIssued, " +
                    "    Po.DateFirstShip AS dateScheduled, " +
                    "    Po.TotalPrice AS totalPrice, " +
                    "    Vendor.Name AS vendorName, " +
                    "    PoStatus.Name AS statusName, " +
                    "    cf.Info AS containerInfo " +
                    "FROM Po " +
                    "LEFT JOIN Vendor ON Po.VendorId = Vendor.Id " +
                    "LEFT JOIN PoStatus ON Po.StatusId = PoStatus.Id " +
                    "LEFT JOIN CustomField cf ON cf.RecordId = Po.Id " +
                    "    AND cf.TableName = 'PO' " +
                    "    AND cf.FieldName = '" + escapeSQL(CONTAINER_CUSTOM_FIELD) + "' " +
                    "INNER JOIN UserToLG ON Po.LocationGroupId = UserToLG.LocationGroupId " +
                    "    AND UserToLG.UserId = " + userId + " " +
                    "WHERE PoStatus.Name IN ('Issued', 'Partial', 'Picking', 'Picked', 'Pending Approval') " +
                    "    AND cf.Info IS NOT NULL AND cf.Info != '' " +
                    "ORDER BY Po.Num DESC";

                debugLog('SQL: ' + query.substring(0, 120) + '...', 'query');
                var result = JSON.parse(runQuery(query));
                debugLog('Loaded ' + result.length + ' eligible POs', 'success');

                allPurchaseOrders = result;
                populateVendorFilter();
                renderPOList();

            } catch (error) {
                debugLog('ERROR loading POs: ' + error.message, 'error');

                // Demo / development fallback data
                allPurchaseOrders = getDemoPurchaseOrders();
                debugLog('Using demo data (' + allPurchaseOrders.length + ' POs)', 'warning');
                populateVendorFilter();
                renderPOList();
            } finally {
                showLoading(false);
            }
        }

        function populateVendorFilter() {
            var vendors = {};
            allPurchaseOrders.forEach(function(po) {
                if (po.vendorName) vendors[po.vendorName] = true;
            });

            var sel = document.getElementById('vendorFilter');
            sel.innerHTML = '<option value="%">All Vendors</option>';
            Object.keys(vendors).sort().forEach(function(v) {
                sel.innerHTML += '<option value="' + v.replace(/"/g, '&quot;') + '">' + v + '</option>';
            });
        }

        function filterPOList() {
            renderPOList();
        }

        function renderPOList() {
            var container = document.getElementById('poListContainer');
            var searchTerm = (document.getElementById('poSearch').value || '').toLowerCase();
            var vendorFilter = document.getElementById('vendorFilter').value;

            var filtered = allPurchaseOrders.filter(function(po) {
                if (searchTerm && (po.num || '').toLowerCase().indexOf(searchTerm) === -1 &&
                    (po.vendorName || '').toLowerCase().indexOf(searchTerm) === -1 &&
                    (po.containerInfo || '').toLowerCase().indexOf(searchTerm) === -1) {
                    return false;
                }
                if (vendorFilter !== '%' && po.vendorName !== vendorFilter) return false;
                return true;
            });

            if (filtered.length === 0) {
                container.innerHTML = '<div class="p-4 text-center text-slate-400 text-sm italic">No matching purchase orders found</div>';
                return;
            }

            var html = '';
            filtered.forEach(function(po) {
                var isSelected = selectedPOIds.has(po.id);
                var checkedAttr = isSelected ? 'checked' : '';
                var selectedClass = isSelected ? ' selected' : '';
                var statusClass = 'status-badge';
                if (po.statusName === 'Issued') statusClass += ' status-issued';
                else if (po.statusName === 'Partial') statusClass += ' status-partial';
                else if (po.statusName === 'Pending Approval') statusClass += ' status-pending';
                else if (po.statusName === 'Picking' || po.statusName === 'Picked') statusClass += ' status-picking';

                html += '<div class="po-list-item' + selectedClass + '" onclick="togglePOSelection(' + po.id + ', this)">' +
                    '<input type="checkbox" ' + checkedAttr + ' onclick="event.stopPropagation(); togglePOSelection(' + po.id + ', this.parentElement)">' +
                    '<div class="flex-1 grid grid-cols-5 gap-2 items-center text-sm">' +
                    '  <span class="font-semibold text-slate-800">' + (po.num || '') + '</span>' +
                    '  <span class="text-slate-600 truncate">' + (po.vendorName || '') + '</span>' +
                    '  <span class="' + statusClass + '">' + (po.statusName || '') + '</span>' +
                    '  <span class="text-slate-500 text-xs">' + (po.containerInfo || '') + '</span>' +
                    '  <span class="text-slate-400 text-xs text-right">' + (po.dateScheduled ? moment(po.dateScheduled).format('MMM D, YYYY') : '') + '</span>' +
                    '</div>' +
                    '</div>';
            });

            container.innerHTML = html;
            updateSelectedCount();
        }

        function togglePOSelection(poId, element) {
            if (selectedPOIds.has(poId)) {
                selectedPOIds.delete(poId);
            } else {
                selectedPOIds.add(poId);
            }
            renderPOList();
            loadLineItemsForSelectedPOs();
        }

        function selectAllVisible() {
            var searchTerm = (document.getElementById('poSearch').value || '').toLowerCase();
            var vendorFilter = document.getElementById('vendorFilter').value;

            allPurchaseOrders.forEach(function(po) {
                var matchesSearch = !searchTerm ||
                    (po.num || '').toLowerCase().indexOf(searchTerm) !== -1 ||
                    (po.vendorName || '').toLowerCase().indexOf(searchTerm) !== -1;
                var matchesVendor = vendorFilter === '%' || po.vendorName === vendorFilter;
                if (matchesSearch && matchesVendor) {
                    selectedPOIds.add(po.id);
                }
            });
            renderPOList();
            loadLineItemsForSelectedPOs();
        }

        function deselectAll() {
            selectedPOIds.clear();
            renderPOList();
            lineItems = [];
            filteredLineItems = [];
            renderPartsTable();
            recalculate();
        }

        function updateSelectedCount() {
            document.getElementById('selectedPOCount').textContent = selectedPOIds.size + ' selected';
        }

        /* ============================================
           LINE ITEM LOADING
           ============================================ */

        function loadLineItemsForSelectedPOs() {
            if (selectedPOIds.size === 0) {
                lineItems = [];
                filteredLineItems = [];
                renderPartsTable();
                recalculate();
                return;
            }

            debugLog('Loading line items for ' + selectedPOIds.size + ' POs...', 'info');

            try {
                var poIds = Array.from(selectedPOIds).join(',');

                // Query PO items with part dimension custom fields
                // TODO: Verify exact custom field join for Part/Product dimensions
                var query =
                    "SELECT " +
                    "    Po.Num AS poNum, " +
                    "    PoItem.Id AS poItemId, " +
                    "    Part.Num AS partNum, " +
                    "    Part.Description AS partDesc, " +
                    "    PoItem.QtyToFulfill AS qty, " +
                    "    PoItemStatus.Name AS itemStatus, " +
                    "    cfLen.Info AS partLength, " +
                    "    cfWid.Info AS partWidth, " +
                    "    cfHt.Info AS partHeight, " +
                    "    cfWt.Info AS partWeight " +
                    "FROM PoItem " +
                    "INNER JOIN Po ON PoItem.PoId = Po.Id " +
                    "LEFT JOIN Part ON PoItem.PartId = Part.Id " +
                    "LEFT JOIN PoItemStatus ON PoItem.StatusId = PoItemStatus.Id " +
                    "LEFT JOIN CustomField cfLen ON cfLen.RecordId = Part.Id AND cfLen.TableName = 'PART' AND cfLen.FieldName = '" + escapeSQL(PART_LENGTH_FIELD) + "' " +
                    "LEFT JOIN CustomField cfWid ON cfWid.RecordId = Part.Id AND cfWid.TableName = 'PART' AND cfWid.FieldName = '" + escapeSQL(PART_WIDTH_FIELD) + "' " +
                    "LEFT JOIN CustomField cfHt ON cfHt.RecordId = Part.Id AND cfHt.TableName = 'PART' AND cfHt.FieldName = '" + escapeSQL(PART_HEIGHT_FIELD) + "' " +
                    "LEFT JOIN CustomField cfWt ON cfWt.RecordId = Part.Id AND cfWt.TableName = 'PART' AND cfWt.FieldName = '" + escapeSQL(PART_WEIGHT_FIELD) + "' " +
                    "WHERE Po.Id IN (" + poIds + ") " +
                    "    AND PoItemStatus.Name NOT IN ('Voided') " +
                    "ORDER BY Po.Num, Part.Num";

                debugLog('SQL: ' + query.substring(0, 120) + '...', 'query');
                var result = JSON.parse(runQuery(query));
                debugLog('Loaded ' + result.length + ' line items', 'success');
                lineItems = result;

            } catch (error) {
                debugLog('ERROR loading line items: ' + error.message, 'error');
                // Demo fallback
                lineItems = getDemoLineItems();
                debugLog('Using demo line items (' + lineItems.length + ')', 'warning');
            }

            filterPartsTable();
            recalculate();
        }

        /* ============================================
           CALCULATION ENGINE
           ============================================ */

        function recalculate() {
            var containerVol = getContainerVolume();
            var containerSpec = getContainerSpec();
            var dimFactor = DIM_TO_METRES[document.getElementById('partDimUnit').value] || 0.0254;
            var weightFactor = WEIGHT_TO_KG[document.getElementById('partWeightUnit').value] || 1;

            var totalVolumeUsed = 0;
            var totalWeightUsed = 0;
            var missingDimCount = 0;
            var missingWeightCount = 0;
            var poVolumes = {};

            lineItems.forEach(function(item) {
                var l = parseFloat(item.partLength) || 0;
                var w = parseFloat(item.partWidth) || 0;
                var h = parseFloat(item.partHeight) || 0;
                var wt = parseFloat(item.partWeight) || 0;
                var qty = parseFloat(item.qty) || 0;

                // Convert to metres
                var lm = l * dimFactor;
                var wm = w * dimFactor;
                var hm = h * dimFactor;
                var wtKg = wt * weightFactor;

                var unitVol = lm * wm * hm;
                var totalVol = unitVol * qty;
                var totalWt = wtKg * qty;

                // Store calculated values on the item for the table
                item._unitVolume = unitVol;
                item._totalVolume = totalVol;
                item._unitWeight = wtKg;
                item._totalWeight = totalWt;
                item._hasDims = (l > 0 && w > 0 && h > 0);

                if (!item._hasDims) missingDimCount++;
                if (wt === 0) missingWeightCount++;

                totalVolumeUsed += totalVol;
                totalWeightUsed += totalWt;

                // Track by PO
                var poKey = item.poNum || 'Unknown';
                if (!poVolumes[poKey]) poVolumes[poKey] = 0;
                poVolumes[poKey] += totalVol;
            });

            // Calculate percentages
            var volumePercent = containerVol > 0 ? (totalVolumeUsed / containerVol) * 100 : 0;
            var maxPayload = parseFloat(document.getElementById('maxPayload').textContent) || 0;
            var weightPercent = maxPayload > 0 ? (totalWeightUsed / maxPayload) * 100 : 0;

            // Update KPI cards
            document.getElementById('kpiVolumeUsed').textContent = formatNumber(totalVolumeUsed) + ' m\u00B3';
            document.getElementById('kpiCapacity').textContent = formatNumber(volumePercent, 1) + '%';
            document.getElementById('kpiCapacity').className = 'text-lg font-bold ' +
                (volumePercent > 100 ? 'text-red-600' : volumePercent > 80 ? 'text-amber-600' : 'text-slate-900');
            document.getElementById('kpiWeight').textContent = formatNumber(totalWeightUsed, 0) + ' kg';
            document.getElementById('kpiItems').textContent = lineItems.length;

            // Update capacity bars
            var volBarPct = Math.min(volumePercent, 100);
            document.getElementById('volumeBarFill').setAttribute('width', volBarPct + '%');
            document.getElementById('volumeBarFill').setAttribute('fill',
                volumePercent > 100 ? '#ef4444' : volumePercent > 80 ? '#f59e0b' : '#2d9cdb');
            document.getElementById('volumeSummary').textContent =
                formatNumber(totalVolumeUsed) + ' / ' + formatNumber(containerVol) + ' m\u00B3';
            document.getElementById('volumePercent').textContent = formatNumber(volumePercent, 1) + '%';

            var wtBarPct = Math.min(weightPercent, 100);
            document.getElementById('weightBarFill').setAttribute('width', wtBarPct + '%');
            document.getElementById('weightBarFill').setAttribute('fill',
                weightPercent > 100 ? '#ef4444' : weightPercent > 80 ? '#f59e0b' : '#10b981');
            document.getElementById('weightSummary').textContent =
                formatNumber(totalWeightUsed, 0) + ' / ' + formatNumber(maxPayload, 0) + ' kg';
            document.getElementById('weightPercent').textContent = formatNumber(weightPercent, 1) + '%';

            // Fill percent label on the 3D view
            document.getElementById('fillPercentLabel').textContent = formatNumber(volumePercent, 1) + '%';
            document.getElementById('fillPercentLabel').className = 'text-2xl font-bold ' +
                (volumePercent > 100 ? 'text-red-500' : volumePercent > 80 ? 'text-amber-500' : volumePercent > 0 ? 'text-indigo-500' : 'text-slate-300');

            // Warnings
            var warnings = [];
            if (volumePercent > 100) warnings.push('Total volume exceeds container capacity by ' + formatNumber(volumePercent - 100, 1) + '%');
            if (weightPercent > 100) warnings.push('Total weight exceeds max payload by ' + formatNumber(weightPercent - 100, 1) + '%');
            if (missingDimCount > 0) warnings.push(missingDimCount + ' item(s) have missing dimensions and are not included in volume calculation');
            if (missingWeightCount > 0) warnings.push(missingWeightCount + ' item(s) have missing weight data');

            var warningsPanel = document.getElementById('warningsPanel');
            var warningsList = document.getElementById('warningsList');
            if (warnings.length > 0) {
                warningsPanel.classList.remove('hidden');
                warningsList.innerHTML = warnings.map(function(w) { return '<li>' + w + '</li>'; }).join('');
            } else {
                warningsPanel.classList.add('hidden');
            }

            // Render visualisations
            renderIsometricContainer(volumePercent / 100);
            renderPOBreakdownChart(poVolumes, containerVol);
            filterPartsTable();
        }

        /* ============================================
           ISOMETRIC CONTAINER SVG (D3)
           ============================================ */

        function renderIsometricContainer(fillRatio) {
            fillRatio = Math.max(0, Math.min(fillRatio, 1.2)); // allow slight overflow visual

            var container = document.getElementById('containerVis');
            var rect = container.getBoundingClientRect();
            var svgWidth = rect.width || 600;
            var svgHeight = 350;

            // Clear previous
            d3.select('#containerVis').selectAll('*').remove();

            var svg = d3.select('#containerVis')
                .append('svg')
                .attr('width', svgWidth)
                .attr('height', svgHeight);

            // Isometric projection helper
            // angle = 30 degrees for standard isometric
            var angle = Math.PI / 6; // 30 deg
            var cosA = Math.cos(angle);
            var sinA = Math.sin(angle);

            // Scale the container box to fit nicely
            var spec = getContainerSpec();
            var maxDim = Math.max(spec.length, spec.width, spec.height);
            var scale = maxDim > 0 ? Math.min(svgWidth * 0.35, svgHeight * 0.55) / maxDim : 30;

            var boxL = spec.length * scale;  // x-axis (goes right)
            var boxW = spec.width * scale;   // z-axis (goes left)
            var boxH = spec.height * scale;  // y-axis (goes up)

            // Center origin
            var cx = svgWidth / 2;
            var cy = svgHeight * 0.62;

            // Convert 3D (x,y,z) to 2D isometric (px, py)
            function iso(x, y, z) {
                return {
                    px: cx + (x - z) * cosA,
                    py: cy - y + (x + z) * sinA
                };
            }

            // 8 corners of the box: (x, y, z) where x=length, y=height, z=width
            var corners = {
                // bottom face
                A: iso(0, 0, 0),
                B: iso(boxL, 0, 0),
                C: iso(boxL, 0, boxW),
                D: iso(0, 0, boxW),
                // top face
                E: iso(0, boxH, 0),
                F: iso(boxL, boxH, 0),
                G: iso(boxL, boxH, boxW),
                H: iso(0, boxH, boxW)
            };

            // Helper to make polygon point string
            function pts() {
                var args = Array.prototype.slice.call(arguments);
                return args.map(function(p) { return p.px + ',' + p.py; }).join(' ');
            }

            var g = svg.append('g');

            // --- Filled volume (drawn first, behind the container wireframe) ---
            var fillH = boxH * Math.min(fillRatio, 1.0);
            var fE = iso(0, fillH, 0);
            var fF = iso(boxL, fillH, 0);
            var fG = iso(boxL, fillH, boxW);
            var fH = iso(0, fillH, boxW);

            if (fillRatio > 0) {
                // Front face of fill volume
                g.append('polygon')
                    .attr('points', pts(corners.A, corners.B, fF, fE))
                    .attr('class', 'fill-volume fill-front');

                // Right face of fill volume
                g.append('polygon')
                    .attr('points', pts(corners.B, corners.C, fG, fF))
                    .attr('class', 'fill-volume fill-right');

                // Top face of fill volume
                g.append('polygon')
                    .attr('points', pts(fE, fF, fG, fH))
                    .attr('class', 'fill-volume fill-top');

                // Left face of fill volume (visible through translucent container)
                g.append('polygon')
                    .attr('points', pts(corners.A, corners.D, fH, fE))
                    .attr('class', 'fill-volume')
                    .style('fill', 'rgba(45, 156, 219, 0.20)');

                // Overflow indicator - red stripe above container
                if (fillRatio > 1.0) {
                    var overflowH = boxH * (fillRatio - 1.0);
                    var oE = iso(0, boxH + overflowH, 0);
                    var oF = iso(boxL, boxH + overflowH, 0);
                    var oG = iso(boxL, boxH + overflowH, boxW);
                    var oH = iso(0, boxH + overflowH, boxW);

                    g.append('polygon')
                        .attr('points', pts(corners.E, corners.F, oF, oE))
                        .style('fill', 'rgba(239, 68, 68, 0.35)')
                        .style('stroke', '#ef4444')
                        .style('stroke-width', '1')
                        .style('stroke-dasharray', '4,3');

                    g.append('polygon')
                        .attr('points', pts(corners.F, corners.G, oG, oF))
                        .style('fill', 'rgba(239, 68, 68, 0.25)')
                        .style('stroke', '#ef4444')
                        .style('stroke-width', '1')
                        .style('stroke-dasharray', '4,3');

                    g.append('polygon')
                        .attr('points', pts(oE, oF, oG, oH))
                        .style('fill', 'rgba(239, 68, 68, 0.30)')
                        .style('stroke', '#ef4444')
                        .style('stroke-width', '1')
                        .style('stroke-dasharray', '4,3');
                }
            }

            // --- Container wireframe (translucent faces) ---
            // Back faces (drawn first so they appear behind)
            // Back-left face
            g.append('polygon')
                .attr('points', pts(corners.D, corners.C, corners.G, corners.H))
                .style('fill', 'rgba(148, 163, 184, 0.08)')
                .style('stroke', '#94a3b8')
                .style('stroke-width', '0.5')
                .style('stroke-dasharray', '4,4');

            // Back face
            g.append('polygon')
                .attr('points', pts(corners.A, corners.D, corners.H, corners.E))
                .style('fill', 'rgba(148, 163, 184, 0.06)')
                .style('stroke', '#94a3b8')
                .style('stroke-width', '0.5')
                .style('stroke-dasharray', '4,4');

            // Bottom face
            g.append('polygon')
                .attr('points', pts(corners.A, corners.B, corners.C, corners.D))
                .style('fill', 'rgba(100, 116, 139, 0.08)')
                .style('stroke', '#64748b')
                .style('stroke-width', '0.8');

            // Front face (visible, translucent)
            g.append('polygon')
                .attr('points', pts(corners.A, corners.B, corners.F, corners.E))
                .attr('class', 'container-face container-front');

            // Right face (visible, translucent)
            g.append('polygon')
                .attr('points', pts(corners.B, corners.C, corners.G, corners.F))
                .attr('class', 'container-face container-right');

            // Top face (visible, translucent)
            g.append('polygon')
                .attr('points', pts(corners.E, corners.F, corners.G, corners.H))
                .attr('class', 'container-face container-top');

            // Bold edges for the 3 visible front edges
            g.append('line')
                .attr('x1', corners.A.px).attr('y1', corners.A.py)
                .attr('x2', corners.B.px).attr('y2', corners.B.py)
                .style('stroke', '#334155').style('stroke-width', '2');
            g.append('line')
                .attr('x1', corners.B.px).attr('y1', corners.B.py)
                .attr('x2', corners.F.px).attr('y2', corners.F.py)
                .style('stroke', '#334155').style('stroke-width', '2');
            g.append('line')
                .attr('x1', corners.B.px).attr('y1', corners.B.py)
                .attr('x2', corners.C.px).attr('y2', corners.C.py)
                .style('stroke', '#334155').style('stroke-width', '2');

            // Dimension labels
            var fontSize = 11;

            // Length label (bottom front edge)
            var midAB = { px: (corners.A.px + corners.B.px) / 2, py: (corners.A.py + corners.B.py) / 2 };
            g.append('text')
                .attr('x', midAB.px).attr('y', midAB.py + 20)
                .attr('text-anchor', 'middle')
                .style('font-size', fontSize + 'px').style('fill', '#64748b').style('font-weight', '600')
                .text(formatNumber(spec.length) + 'm');

            // Width label (bottom right edge)
            var midBC = { px: (corners.B.px + corners.C.px) / 2, py: (corners.B.py + corners.C.py) / 2 };
            g.append('text')
                .attr('x', midBC.px + 15).attr('y', midBC.py + 5)
                .attr('text-anchor', 'start')
                .style('font-size', fontSize + 'px').style('fill', '#64748b').style('font-weight', '600')
                .text(formatNumber(spec.width) + 'm');

            // Height label (front right vertical edge)
            var midBF = { px: (corners.B.px + corners.F.px) / 2, py: (corners.B.py + corners.F.py) / 2 };
            g.append('text')
                .attr('x', midBF.px + 12).attr('y', midBF.py)
                .attr('text-anchor', 'start')
                .style('font-size', fontSize + 'px').style('fill', '#64748b').style('font-weight', '600')
                .text(formatNumber(spec.height) + 'm');

            // Fill level line (dashed horizontal across the fill top)
            if (fillRatio > 0 && fillRatio <= 1.0) {
                g.append('line')
                    .attr('x1', fE.px).attr('y1', fE.py)
                    .attr('x2', fF.px).attr('y2', fF.py)
                    .style('stroke', '#2d9cdb')
                    .style('stroke-width', '1.5')
                    .style('stroke-dasharray', '6,3');

                // Fill level text
                g.append('text')
                    .attr('x', fE.px - 10).attr('y', fE.py - 4)
                    .attr('text-anchor', 'end')
                    .style('font-size', '12px').style('fill', '#2d9cdb').style('font-weight', '700')
                    .text(formatNumber(fillRatio * 100, 0) + '%');
            }
        }

        /* ============================================
           PO BREAKDOWN CHART (D3 Horizontal Bars)
           ============================================ */

        function renderPOBreakdownChart(poVolumes, containerVol) {
            var container = document.getElementById('poBreakdownChart');
            d3.select('#poBreakdownChart').selectAll('*').remove();

            var entries = Object.keys(poVolumes).map(function(k) {
                return { po: k, volume: poVolumes[k] };
            }).sort(function(a, b) { return b.volume - a.volume; });

            if (entries.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-400 text-xs italic py-4">No data</div>';
                return;
            }

            var margin = { top: 5, right: 50, bottom: 5, left: 60 };
            var width = container.clientWidth - margin.left - margin.right;
            var barHeight = 22;
            var height = Math.max(entries.length * barHeight, 40);

            var svg = d3.select('#poBreakdownChart')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

            var maxVol = d3.max(entries, function(d) { return d.volume; }) || 1;

            var y = d3.scaleBand()
                .domain(entries.map(function(d) { return d.po; }))
                .range([0, height])
                .padding(0.2);

            var x = d3.scaleLinear()
                .domain([0, maxVol])
                .range([0, width]);

            svg.selectAll('.bar')
                .data(entries)
                .enter()
                .append('rect')
                .attr('x', 0)
                .attr('y', function(d) { return y(d.po); })
                .attr('width', function(d) { return x(d.volume); })
                .attr('height', y.bandwidth())
                .attr('rx', 3)
                .attr('fill', '#2d9cdb')
                .attr('opacity', 0.8);

            svg.selectAll('.label')
                .data(entries)
                .enter()
                .append('text')
                .attr('x', -4)
                .attr('y', function(d) { return y(d.po) + y.bandwidth() / 2; })
                .attr('dy', '0.35em')
                .attr('text-anchor', 'end')
                .style('font-size', '11px')
                .style('fill', '#334155')
                .style('font-weight', '600')
                .text(function(d) { return d.po; });

            svg.selectAll('.value')
                .data(entries)
                .enter()
                .append('text')
                .attr('x', function(d) { return x(d.volume) + 4; })
                .attr('y', function(d) { return y(d.po) + y.bandwidth() / 2; })
                .attr('dy', '0.35em')
                .style('font-size', '10px')
                .style('fill', '#64748b')
                .text(function(d) { return formatNumber(d.volume) + ' m\u00B3'; });
        }

        /* ============================================
           PARTS TABLE
           ============================================ */

        function filterPartsTable() {
            var searchTerm = (document.getElementById('partsSearch').value || '').toLowerCase();
            var hideNoDims = document.getElementById('hideNoDims').checked;

            filteredLineItems = lineItems.filter(function(item) {
                if (searchTerm &&
                    (item.partNum || '').toLowerCase().indexOf(searchTerm) === -1 &&
                    (item.partDesc || '').toLowerCase().indexOf(searchTerm) === -1 &&
                    (item.poNum || '').toLowerCase().indexOf(searchTerm) === -1) {
                    return false;
                }
                if (hideNoDims && !item._hasDims) return false;
                return true;
            });

            sortAndRenderParts();
        }

        function sortParts(column) {
            if (partsSortColumn === column) {
                partsSortDirection = partsSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                partsSortColumn = column;
                partsSortDirection = 'asc';
            }
            sortAndRenderParts();
        }

        function sortAndRenderParts() {
            var col = partsSortColumn;
            var dir = partsSortDirection;

            filteredLineItems.sort(function(a, b) {
                var aVal, bVal;
                switch (col) {
                    case 'qty': aVal = parseFloat(a.qty) || 0; bVal = parseFloat(b.qty) || 0; break;
                    case 'length': aVal = parseFloat(a.partLength) || 0; bVal = parseFloat(b.partLength) || 0; break;
                    case 'width': aVal = parseFloat(a.partWidth) || 0; bVal = parseFloat(b.partWidth) || 0; break;
                    case 'height': aVal = parseFloat(a.partHeight) || 0; bVal = parseFloat(b.partHeight) || 0; break;
                    case 'unitWeight': aVal = a._unitWeight || 0; bVal = b._unitWeight || 0; break;
                    case 'unitVolume': aVal = a._unitVolume || 0; bVal = b._unitVolume || 0; break;
                    case 'totalVolume': aVal = a._totalVolume || 0; bVal = b._totalVolume || 0; break;
                    case 'totalWeight': aVal = a._totalWeight || 0; bVal = b._totalWeight || 0; break;
                    default: aVal = (a[col] || '').toString().toLowerCase(); bVal = (b[col] || '').toString().toLowerCase();
                }
                if (aVal < bVal) return dir === 'asc' ? -1 : 1;
                if (aVal > bVal) return dir === 'asc' ? 1 : -1;
                return 0;
            });

            renderPartsTable();
        }

        function renderPartsTable() {
            var tbody = document.getElementById('partsTableBody');
            document.getElementById('partsCount').textContent = filteredLineItems.length + ' items';

            if (filteredLineItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" class="text-center text-slate-400 py-8 italic">' +
                    (lineItems.length === 0 ? 'Select purchase orders above to view line items' : 'No matching items') +
                    '</td></tr>';
                return;
            }

            var dimUnit = document.getElementById('partDimUnit').value;
            var html = '';

            filteredLineItems.forEach(function(item) {
                var dimClass = item._hasDims ? '' : ' style="color: #94a3b8; font-style: italic;"';
                var statusClass = 'status-badge';
                if (item.itemStatus === 'Fulfilled') statusClass += ' status-issued';
                else if (item.itemStatus === 'Partial') statusClass += ' status-partial';
                else if (item.itemStatus === 'Entered') statusClass += ' status-pending';

                html += '<tr' + dimClass + '>' +
                    '<td><a href="#" class="order-link" onclick="event.preventDefault(); openPO(\'' + escapeSQL(item.poNum) + '\')">' + (item.poNum || '') + '</a></td>' +
                    '<td class="font-medium">' + (item.partNum || '') + '</td>' +
                    '<td class="truncate" style="max-width: 200px;" title="' + (item.partDesc || '').replace(/"/g, '&quot;') + '">' + (item.partDesc || '') + '</td>' +
                    '<td class="text-right font-medium">' + formatNumber(parseFloat(item.qty) || 0, 0) + '</td>' +
                    '<td class="text-right">' + (item.partLength || '-') + '</td>' +
                    '<td class="text-right">' + (item.partWidth || '-') + '</td>' +
                    '<td class="text-right">' + (item.partHeight || '-') + '</td>' +
                    '<td class="text-right">' + (item.partWeight ? formatNumber(parseFloat(item.partWeight), 2) : '-') + '</td>' +
                    '<td class="text-right">' + (item._unitVolume > 0 ? formatNumber(item._unitVolume, 6) : '-') + '</td>' +
                    '<td class="text-right font-semibold">' + (item._totalVolume > 0 ? formatNumber(item._totalVolume, 4) : '-') + '</td>' +
                    '<td class="text-right">' + (item._totalWeight > 0 ? formatNumber(item._totalWeight, 1) : '-') + '</td>' +
                    '<td><span class="' + statusClass + '">' + (item.itemStatus || '') + '</span></td>' +
                    '</tr>';
            });

            // Totals row
            var totVol = 0, totWt = 0;
            filteredLineItems.forEach(function(item) {
                totVol += item._totalVolume || 0;
                totWt += item._totalWeight || 0;
            });

            html += '<tr style="background: #f0f9ff; font-weight: 700; border-top: 2px solid #2d9cdb;">' +
                '<td colspan="9" class="text-right">Totals:</td>' +
                '<td class="text-right">' + formatNumber(totVol, 4) + ' m\u00B3</td>' +
                '<td class="text-right">' + formatNumber(totWt, 1) + ' kg</td>' +
                '<td></td>' +
                '</tr>';

            tbody.innerHTML = html;
        }

        /* ============================================
           EXPORT
           ============================================ */

        function exportToCSV() {
            if (filteredLineItems.length === 0) {
                alert('No data to export. Please select purchase orders first.');
                return;
            }

            var dimUnit = document.getElementById('partDimUnit').value;
            var headers = ['PO #', 'Part #', 'Description', 'Qty',
                'Length (' + dimUnit + ')', 'Width (' + dimUnit + ')', 'Height (' + dimUnit + ')',
                'Unit Weight', 'Unit Volume (m3)', 'Total Volume (m3)', 'Total Weight (kg)', 'Status'];

            var rows = filteredLineItems.map(function(item) {
                return [
                    item.poNum, item.partNum, '"' + (item.partDesc || '').replace(/"/g, '""') + '"',
                    item.qty, item.partLength || '', item.partWidth || '', item.partHeight || '',
                    item.partWeight || '', item._unitVolume ? item._unitVolume.toFixed(6) : '',
                    item._totalVolume ? item._totalVolume.toFixed(4) : '',
                    item._totalWeight ? item._totalWeight.toFixed(1) : '',
                    item.itemStatus
                ].join(',');
            });

            var csv = headers.join(',') + '\n' + rows.join('\n');
            var blob = new Blob([csv], { type: 'text/csv' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'container_capacity_' + moment().format('YYYY-MM-DD') + '.csv';
            a.click();
            URL.revokeObjectURL(url);

            debugLog('Exported ' + filteredLineItems.length + ' items to CSV', 'success');
        }

        /* ============================================
           FISHBOWL MODULE OPENER
           ============================================ */

        function openPO(poNum) {
            if (typeof openModule === 'function') {
                openModule("Purchase Order", poNum);
            } else {
                debugLog('openModule not available (not running in Fishbowl)', 'warning');
            }
        }

        /* ============================================
           DEMO DATA (Development/Preview fallback)
           ============================================ */

        function getDemoPurchaseOrders() {
            return [
                { id: 1001, num: 'PO-5001', vendorName: 'Acme Steel Co.', statusName: 'Issued', containerInfo: '40ft HC', dateScheduled: '2026-03-15', totalPrice: 45000 },
                { id: 1002, num: 'PO-5002', vendorName: 'Pacific Parts Ltd.', statusName: 'Issued', containerInfo: '40ft STD', dateScheduled: '2026-03-20', totalPrice: 32000 },
                { id: 1003, num: 'PO-5003', vendorName: 'Acme Steel Co.', statusName: 'Partial', containerInfo: '20ft', dateScheduled: '2026-02-28', totalPrice: 18000 },
                { id: 1004, num: 'PO-5004', vendorName: 'Global Components Inc.', statusName: 'Issued', containerInfo: '40ft HC', dateScheduled: '2026-04-01', totalPrice: 67500 },
                { id: 1005, num: 'PO-5005', vendorName: 'Pacific Parts Ltd.', statusName: 'Pending Approval', containerInfo: '40ft STD', dateScheduled: '2026-04-10', totalPrice: 28000 }
            ];
        }

        function getDemoLineItems() {
            var items = [];
            var selectedPOs = allPurchaseOrders.filter(function(po) { return selectedPOIds.has(po.id); });

            var demoParts = [
                { partNum: 'BRKT-4020', partDesc: 'Steel Mounting Bracket', partLength: '16', partWidth: '12', partHeight: '4', partWeight: '2.8' },
                { partNum: 'SHAFT-200', partDesc: 'Drive Shaft Assembly', partLength: '48', partWidth: '6', partHeight: '6', partWeight: '8.5' },
                { partNum: 'PLATE-1010', partDesc: 'Base Plate 10x10', partLength: '10', partWidth: '10', partHeight: '0.5', partWeight: '4.2' },
                { partNum: 'HSG-MOTOR', partDesc: 'Motor Housing', partLength: '14', partWidth: '14', partHeight: '18', partWeight: '12.0' },
                { partNum: 'FLNG-6IN', partDesc: '6" Flange Adapter', partLength: '8', partWidth: '8', partHeight: '3', partWeight: '3.1' },
                { partNum: 'TUBE-3FT', partDesc: 'Steel Tube 3ft', partLength: '36', partWidth: '4', partHeight: '4', partWeight: '5.4' },
                { partNum: 'COVER-LG', partDesc: 'Large Equipment Cover', partLength: '24', partWidth: '18', partHeight: '2', partWeight: '6.0' },
                { partNum: 'VALVE-DN50', partDesc: 'Ball Valve DN50', partLength: '7', partWidth: '5', partHeight: '5', partWeight: '3.8' },
                { partNum: 'GASKET-SET', partDesc: 'Gasket Set (no dims)', partLength: '', partWidth: '', partHeight: '', partWeight: '0.3' },
                { partNum: 'BOLT-KIT', partDesc: 'Bolt Kit M12x50', partLength: '6', partWidth: '4', partHeight: '4', partWeight: '1.5' }
            ];

            selectedPOs.forEach(function(po) {
                var numItems = 3 + Math.floor(Math.random() * 4);
                for (var i = 0; i < numItems; i++) {
                    var dp = demoParts[Math.floor(Math.random() * demoParts.length)];
                    items.push({
                        poNum: po.num,
                        partNum: dp.partNum,
                        partDesc: dp.partDesc,
                        qty: String(Math.floor(Math.random() * 50) + 5),
                        itemStatus: ['Entered', 'Partial', 'Fulfilled'][Math.floor(Math.random() * 3)],
                        partLength: dp.partLength,
                        partWidth: dp.partWidth,
                        partHeight: dp.partHeight,
                        partWeight: dp.partWeight
                    });
                }
            });

            return items;
        }

        /* ============================================
           INITIALIZATION
           ============================================ */

        window.addEventListener('DOMContentLoaded', function() {
            debugLog('Initializing Container Capacity Calculator...', 'info');

            // Show debug console if enabled
            if (DEBUG_MODE) {
                document.getElementById('debugConsoleContainer').style.display = 'block';
                debugLog('Debug mode enabled', 'info');
            }

            // Set default container dimensions
            onContainerTypeChange();

            // Load purchase orders
            loadPurchaseOrders();

            // Render empty isometric container
            renderIsometricContainer(0);

            debugLog('Initialization complete', 'success');
        });

        // Handle window resize for responsive SVG
        window.addEventListener('resize', function() {
            var vol = getContainerVolume();
            if (vol > 0 && lineItems.length > 0) {
                var totalVol = 0;
                lineItems.forEach(function(item) { totalVol += item._totalVolume || 0; });
                renderIsometricContainer(totalVol / vol);
            } else {
                renderIsometricContainer(0);
            }
        });
    </script>
</body>
</html>
