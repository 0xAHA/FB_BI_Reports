<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Container Capacity Calculator - Fishbowl BI</title>

    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        /* ============================================
           GLOBAL STYLES & CSS VARIABLES
           ============================================ */
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        :root {
            --color-primary: #2d9cdb;
            --color-primary-dark: #1e7bb4;
            --color-sidebar: #06162d;
            --color-sidebar-hover: #0a1f3d;
        }

        /* ============================================
           TAILWIND COLOR OVERRIDES
           ============================================ */
        .bg-indigo-600 { background-color: var(--color-primary) !important; }
        .bg-indigo-50 { background-color: rgba(45, 156, 219, 0.1) !important; }
        .hover\:bg-indigo-700:hover { background-color: var(--color-primary-dark) !important; }
        .hover\:bg-indigo-50:hover { background-color: rgba(45, 156, 219, 0.1) !important; }
        .text-indigo-600 { color: var(--color-primary) !important; }
        .text-indigo-700 { color: var(--color-primary-dark) !important; }
        .border-indigo-200 { border-color: rgba(45, 156, 219, 0.3) !important; }
        .border-indigo-300 { border-color: rgba(45, 156, 219, 0.4) !important; }
        .hover\:text-indigo-600:hover { color: var(--color-primary) !important; }
        .focus\:ring-indigo-100:focus { --tw-ring-color: rgba(45, 156, 219, 0.2) !important; }
        .focus\:ring-indigo-500:focus { --tw-ring-color: var(--color-primary) !important; }
        .focus\:border-indigo-300:focus { border-color: rgba(45, 156, 219, 0.4) !important; }

        /* ============================================
           CUSTOM SCROLLBAR
           ============================================ */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* ============================================
           LOADING SPINNER
           ============================================ */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner {
            border: 3px solid #f1f5f9;
            border-top: 3px solid var(--color-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        /* ============================================
           D3 / SVG CHART STYLES
           ============================================ */
        .axis line, .axis path {
            stroke: #cbd5e1;
            shape-rendering: crispEdges;
        }
        .axis text {
            fill: #64748b;
            font-size: 11px;
            font-weight: 500;
        }
        .tooltip {
            position: absolute;
            background: rgba(15, 23, 42, 0.95);
            color: white;
            padding: 12px 16px;
            border-radius: 10px;
            pointer-events: none;
            font-size: 13px;
            line-height: 1.6;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .tooltip-label {
            color: #94a3b8;
            display: inline-block;
            min-width: 80px;
            font-weight: 500;
        }
        .tooltip-value {
            color: #ffffff;
            font-weight: 600;
            margin-left: 8px;
        }

        /* ============================================
           ORDER LINK STYLES
           ============================================ */
        .order-link {
            color: var(--color-primary);
            text-decoration: none;
            font-weight: 600;
            transition: color 0.2s ease;
            cursor: pointer;
        }
        .order-link:hover {
            color: var(--color-primary-dark);
            text-decoration: underline;
        }

        /* ============================================
           TABLE STYLES
           ============================================ */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        .data-table th {
            background-color: #f8fafc;
            padding: 10px 12px;
            text-align: left;
            font-size: 11px;
            font-weight: 700;
            color: #475569;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }
        .data-table th:hover {
            background-color: #e9ecef;
        }
        .data-table th .sort-icon {
            margin-left: 4px;
            font-size: 10px;
            color: #94a3b8;
        }
        .data-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 13px;
            color: #334155;
        }
        .data-table tbody tr:hover {
            background-color: #f0f9ff;
        }
        .data-table tbody tr:nth-child(even) {
            background-color: #fafafa;
        }
        .data-table tbody tr:nth-child(even):hover {
            background-color: #f0f9ff;
        }

        /* ============================================
           PO SELECTION LIST
           ============================================ */
        .po-list-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer;
            transition: background-color 0.15s;
        }
        .po-list-item:hover {
            background-color: #f0f9ff;
        }
        .po-list-item.selected {
            background-color: rgba(45, 156, 219, 0.08);
            border-left: 3px solid var(--color-primary);
        }
        .po-list-item input[type="checkbox"] {
            accent-color: var(--color-primary);
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        /* ============================================
           ISOMETRIC CONTAINER SVG
           ============================================ */
        .container-face {
            stroke: #475569;
            stroke-width: 1.5;
            stroke-linejoin: round;
        }
        .container-top { fill: rgba(148, 163, 184, 0.25); }
        .container-right { fill: rgba(100, 116, 139, 0.20); }
        .container-front { fill: rgba(71, 85, 105, 0.15); }

        .fill-volume {
            stroke: none;
            transition: all 0.6s ease-in-out;
        }
        .fill-top { fill: rgba(45, 156, 219, 0.55); }
        .fill-right { fill: rgba(30, 123, 180, 0.50); }
        .fill-front { fill: rgba(45, 156, 219, 0.40); }

        .container-edge {
            stroke: #334155;
            stroke-width: 1;
            stroke-dasharray: 6,3;
            fill: none;
        }

        /* ============================================
           CAPACITY BAR
           ============================================ */
        .capacity-bar-bg {
            fill: #e2e8f0;
            rx: 6;
            ry: 6;
        }
        .capacity-bar-fill {
            rx: 6;
            ry: 6;
            transition: width 0.6s ease-in-out, fill 0.3s;
        }

        /* ============================================
           DIMENSION INPUT STYLES (for manual override)
           ============================================ */
        .dim-input {
            width: 70px;
            padding: 3px 6px;
            font-size: 12px;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            text-align: right;
        }
        .dim-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(45, 156, 219, 0.2);
        }

        /* ============================================
           STATUS BADGES
           ============================================ */
        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        .status-issued { background: #d4edda; color: #155724; }
        .status-partial { background: #cce5ff; color: #004085; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-picking { background: #e2e3f1; color: #383d6e; }

        /* ============================================
           RESPONSIVE CONTAINER VIS
           ============================================ */
        #containerVis {
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        #containerVis svg {
            display: block;
            margin: 0 auto;
        }

        /* ============================================
           ZOOM CONTROLS
           ============================================ */
        .zoom-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #cbd5e1;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            color: #475569;
            transition: all 0.15s;
            user-select: none;
        }
        .zoom-btn:hover {
            background: #f0f9ff;
            border-color: var(--color-primary);
            color: var(--color-primary);
        }
        .zoom-btn:active {
            transform: scale(0.95);
        }

        /* ============================================
           CARTON STYLES
           ============================================ */
        .carton-front { stroke-width: 0.5; }
        .carton-right { stroke-width: 0.5; }
        .carton-top   { stroke-width: 0.5; }
    </style>
</head>

<body class="bg-slate-50">
    <div class="flex flex-col h-screen">

        <!-- ============================================
             HEADER
             ============================================ -->
        <header class="h-20 bg-white border-b border-slate-200 px-8 flex items-center justify-between flex-shrink-0 z-20 shadow-sm">
            <div class="flex items-center gap-6">
                <div>
                    <h1 class="text-xl font-bold text-slate-900">
                        Container Capacity Calculator
                    </h1>
                    <p class="text-xs text-slate-500 mt-0.5">Estimate shipping container fill from purchase order line items</p>
                </div>

                <!-- KPI Cards - populated dynamically -->
                <div id="kpiCards" class="hidden lg:flex items-center gap-3">
                    <div class="px-3 py-1.5 bg-indigo-50 border border-indigo-200 rounded-lg">
                        <div class="text-[10px] font-semibold text-indigo-600 uppercase tracking-wide">Volume Used</div>
                        <div id="kpiVolumeUsed" class="text-lg font-bold text-slate-900">0 m&sup3;</div>
                    </div>
                    <div class="px-3 py-1.5 bg-indigo-50 border border-indigo-200 rounded-lg">
                        <div class="text-[10px] font-semibold text-indigo-600 uppercase tracking-wide">Capacity</div>
                        <div id="kpiCapacity" class="text-lg font-bold text-slate-900">0%</div>
                    </div>
                    <div class="px-3 py-1.5 bg-indigo-50 border border-indigo-200 rounded-lg">
                        <div class="text-[10px] font-semibold text-indigo-600 uppercase tracking-wide">Est. Weight</div>
                        <div id="kpiWeight" class="text-lg font-bold text-slate-900">0 kg</div>
                    </div>
                    <div class="px-3 py-1.5 bg-indigo-50 border border-indigo-200 rounded-lg">
                        <div class="text-[10px] font-semibold text-indigo-600 uppercase tracking-wide">Line Items</div>
                        <div id="kpiItems" class="text-lg font-bold text-slate-900">0</div>
                    </div>
                    <!-- Containers Needed -->
                    <div class="px-3 py-1.5 bg-indigo-50 border border-indigo-200 rounded-lg">
                        <div class="text-[10px] font-semibold text-indigo-600 uppercase tracking-wide">Containers</div>
                        <div id="kpiContainers" class="text-lg font-bold text-slate-900">0</div>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <button onclick="exportToCSV()"
                    class="px-3 py-2 bg-slate-100 hover:bg-slate-200 border border-slate-300 text-slate-700 rounded-lg text-xs font-semibold transition-colors flex items-center gap-2">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Export CSV
                </button>
                <button onclick="recalculate()"
                    class="px-3 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-xs font-semibold transition-colors flex items-center gap-2">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                    </svg>
                    Calculate
                </button>
                <button onclick="loadPurchaseOrders()"
                    class="p-2.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-xl transition-all" title="Refresh PO Data">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                </button>
            </div>
        </header>

        <!-- ============================================
             MAIN CONTENT
             ============================================ -->
        <div class="flex-1 overflow-y-auto custom-scrollbar">
            <div class="p-4 lg:p-8">

                <!-- ROW 1: Container Config Bar + PO Selection -->
                <div class="grid grid-cols-1 gap-4 mb-4">

                    <!-- Compact Container Config Bar -->
                    <div class="bg-white rounded-2xl shadow-md border border-slate-300 px-4 py-3">
                        <div class="flex items-center gap-4 flex-wrap">
                            <!-- Container selector -->
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-indigo-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                                </svg>
                                <select id="containerType" onchange="onContainerTypeChange()"
                                    class="px-2.5 py-1.5 bg-slate-50 border border-slate-300 rounded-lg text-sm font-semibold text-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300">
                                    <option value="20ft">20ft Standard</option>
                                    <option value="40ft" selected>40ft Standard</option>
                                    <option value="40ft_hc">40ft High Cube</option>
                                    <option value="custom">Custom Dimensions</option>
                                </select>
                                <button onclick="openContainerSettings()" class="p-1.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-all" title="Container Settings">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    </svg>
                                </button>
                            </div>

                            <!-- Summary text -->
                            <div id="containerSummaryText" class="text-xs text-slate-500">
                                <span id="summaryDims">12.03 &times; 2.35 &times; 2.39m</span>
                                <span class="mx-1 text-slate-300">|</span>
                                <span id="summaryVolume">67.67 m&sup3;</span>
                                <span class="mx-1 text-slate-300">|</span>
                                <span id="summaryPayload">27,600 kg</span>
                            </div>

                            <!-- Divider -->
                            <div class="h-5 w-px bg-slate-200"></div>

                            <!-- UoM selectors side by side -->
                            <div class="flex items-center gap-2">
                                <label class="text-[10px] font-semibold text-slate-500 uppercase whitespace-nowrap">Dims</label>
                                <select id="partDimUnit" onchange="recalculate()"
                                    class="px-2 py-1 bg-slate-50 border border-slate-300 rounded text-xs font-medium text-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300">
                                </select>
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="text-[10px] font-semibold text-slate-500 uppercase whitespace-nowrap">Weight</label>
                                <select id="partWeightUnit" onchange="recalculate()"
                                    class="px-2 py-1 bg-slate-50 border border-slate-300 rounded text-xs font-medium text-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300">
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Purchase Order Selection Card -->
                    <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-base font-bold text-slate-800 flex items-center gap-2">
                                <svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                                </svg>
                                Select Purchase Orders
                                <span id="selectedPOCount" class="ml-2 px-2 py-0.5 text-[10px] bg-indigo-50 text-indigo-600 rounded-full font-bold">0 selected</span>
                            </h3>
                            <div class="flex items-center gap-2">
                                <input type="text" id="poSearch" placeholder="Search POs..." onkeyup="filterPOList()"
                                    class="px-3 py-1.5 bg-slate-50 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300" style="width: 200px;">
                                <select id="vendorFilter" onchange="filterPOList()"
                                    class="px-2.5 py-1.5 bg-slate-50 border border-slate-300 rounded-lg text-sm font-medium text-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300">
                                    <option value="%">All Vendors</option>
                                </select>
                                <button onclick="selectAllVisible()" class="px-2 py-1.5 text-xs bg-slate-100 hover:bg-slate-200 border border-slate-300 text-slate-600 rounded-lg font-semibold transition-colors">
                                    Select All
                                </button>
                                <button onclick="deselectAll()" class="px-2 py-1.5 text-xs bg-slate-100 hover:bg-slate-200 border border-slate-300 text-slate-600 rounded-lg font-semibold transition-colors">
                                    Clear
                                </button>
                            </div>
                        </div>

                        <div id="poListContainer" class="border border-slate-200 rounded-lg overflow-y-auto custom-scrollbar" style="max-height: 220px;">
                            <div class="p-4 text-center text-slate-400 text-sm italic">Loading purchase orders...</div>
                        </div>

                        <div class="mt-2 flex items-start gap-2 text-xs text-slate-500">
                            <svg class="w-4 h-4 text-amber-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <span>
                                Only POs with a value in the <strong>container/shipping custom field</strong> are shown.
                                Part dimensions (L&times;W&times;H) and weight are read from Fishbowl product custom fields.
                            </span>
                        </div>
                    </div>
                </div>

                <!-- ROW 2: Isometric Container Visualisation + Capacity Summary -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">

                    <!-- Isometric 3D Container Visualisation -->
                    <div class="lg:col-span-2 bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                                <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                                </svg>
                                Container Visualisation
                            </h3>
                            <div class="flex items-center gap-3">
                                <!-- Zoom Controls -->
                                <div class="flex items-center gap-1">
                                    <button class="zoom-btn" onclick="zoomContainer(-1)" title="Zoom Out">&#8722;</button>
                                    <span id="zoomLabel" class="text-xs text-slate-500 font-medium w-10 text-center">100%</span>
                                    <button class="zoom-btn" onclick="zoomContainer(1)" title="Zoom In">+</button>
                                    <button class="zoom-btn" onclick="zoomContainer(0)" title="Reset Zoom" style="font-size: 12px; margin-left: 2px;">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                                    </button>
                                </div>
                                <div id="fillPercentLabel" class="text-2xl font-bold text-slate-300">0%</div>
                            </div>
                        </div>
                        <div id="containerVis" style="height: 400px; position: relative; overflow: hidden;">
                            <!-- HTML dimension labels (not affected by SVG zoom) -->
                            <div id="labelLength" class="absolute text-xs font-semibold text-slate-500 pointer-events-none" style="display:none;"></div>
                            <div id="labelWidth" class="absolute text-xs font-semibold text-slate-500 pointer-events-none" style="display:none;"></div>
                            <div id="labelHeight" class="absolute text-xs font-semibold text-slate-500 pointer-events-none" style="display:none;"></div>
                            <div id="labelFillPct" class="absolute text-xs font-bold pointer-events-none" style="display:none; color: #2d9cdb;"></div>
                            <div id="labelHeightRestrict" class="absolute text-[10px] font-bold pointer-events-none" style="display:none; color: #f59e0b;"></div>
                        </div>
                    </div>

                    <!-- Capacity Breakdown -->
                    <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                        <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2 mb-4">
                            <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                            Capacity Summary
                        </h3>

                        <!-- Containers Needed Display -->
                        <div id="containersNeededPanel" class="mb-5 p-3 bg-slate-50 border border-slate-200 rounded-lg text-center">
                            <div class="text-[10px] font-semibold text-slate-500 uppercase tracking-wide">Containers Needed</div>
                            <div id="containersNeededDisplay" class="text-3xl font-bold text-slate-900 mt-1">0</div>
                            <div id="containersNeededDetail" class="text-xs text-slate-500 mt-1">-</div>
                        </div>

                        <!-- Volume Gauge -->
                        <div class="mb-5">
                            <div class="flex justify-between text-xs text-slate-500 mb-1">
                                <span>Volume</span>
                                <span id="volumeSummary">0.00 / 0.00 m&sup3;</span>
                            </div>
                            <svg id="volumeBar" width="100%" height="20">
                                <rect class="capacity-bar-bg" width="100%" height="16" y="2"/>
                                <rect id="volumeBarFill" class="capacity-bar-fill" width="0%" height="16" y="2" fill="#2d9cdb"/>
                            </svg>
                            <div id="volumePercent" class="text-right text-xs font-bold text-slate-600 mt-1">0%</div>
                        </div>

                        <!-- Weight Gauge -->
                        <div class="mb-5">
                            <div class="flex justify-between text-xs text-slate-500 mb-1">
                                <span>Weight</span>
                                <span id="weightSummary">0 / 0 kg</span>
                            </div>
                            <svg id="weightBar" width="100%" height="20">
                                <rect class="capacity-bar-bg" width="100%" height="16" y="2"/>
                                <rect id="weightBarFill" class="capacity-bar-fill" width="0%" height="16" y="2" fill="#10b981"/>
                            </svg>
                            <div id="weightPercent" class="text-right text-xs font-bold text-slate-600 mt-1">0%</div>
                        </div>

                        <!-- Height restriction info -->
                        <div id="heightRestrictionInfo" class="mb-4 hidden">
                            <div class="p-2 bg-amber-50 border border-amber-200 rounded-lg text-xs text-amber-700">
                                <strong>Height restricted:</strong> Usable height <span id="usableHeightDisplay">-</span>m
                                (fill <span id="restrictedFillDisplay">-</span>m + pallet <span id="restrictedPalletDisplay">-</span>m)
                            </div>
                        </div>

                        <!-- Breakdown by PO -->
                        <div class="mt-4">
                            <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wide mb-2">Volume by PO</h4>
                            <div id="poBreakdownChart" style="height: 200px;"></div>
                        </div>

                        <!-- Warnings -->
                        <div id="warningsPanel" class="mt-4 hidden">
                            <div class="p-3 bg-amber-50 border border-amber-200 rounded-lg">
                                <div class="flex items-center gap-2 text-amber-700 text-xs font-semibold mb-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                                    </svg>
                                    Warnings
                                </div>
                                <ul id="warningsList" class="text-xs text-amber-600 space-y-1 list-disc list-inside"></ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ROW 3: Parts Detail Table -->
                <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-base font-bold text-slate-800 flex items-center gap-2">
                            <svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
                            </svg>
                            Line Item Details
                            <span id="partsCount" class="ml-2 px-2 py-0.5 text-[10px] bg-slate-100 text-slate-600 rounded-full font-bold">0 items</span>
                        </h3>
                        <div class="flex items-center gap-2">
                            <input type="text" id="partsSearch" placeholder="Search parts..." onkeyup="filterPartsTable()"
                                class="px-3 py-1.5 bg-slate-50 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300" style="width: 200px;">
                            <label class="flex items-center gap-1.5 text-xs text-slate-600 whitespace-nowrap">
                                <input type="checkbox" id="hideNoDims" onchange="filterPartsTable()" class="accent-[#2d9cdb]">
                                Hide missing dims
                            </label>
                        </div>
                    </div>

                    <div class="overflow-auto custom-scrollbar" style="max-height: 400px;">
                        <table class="data-table" id="partsTable">
                            <thead>
                                <tr>
                                    <th onclick="sortParts('poNum')">PO # <span class="sort-icon">&#8645;</span></th>
                                    <th onclick="sortParts('partNum')">Part # <span class="sort-icon">&#8645;</span></th>
                                    <th onclick="sortParts('partDesc')">Description <span class="sort-icon">&#8645;</span></th>
                                    <th onclick="sortParts('qty')" class="text-right">Qty <span class="sort-icon">&#8645;</span></th>
                                    <th onclick="sortParts('length')" class="text-right">L <span class="sort-icon">&#8645;</span></th>
                                    <th onclick="sortParts('width')" class="text-right">W <span class="sort-icon">&#8645;</span></th>
                                    <th onclick="sortParts('height')" class="text-right">H <span class="sort-icon">&#8645;</span></th>
                                    <th onclick="sortParts('unitWeight')" class="text-right">Unit Wt <span class="sort-icon">&#8645;</span></th>
                                    <th onclick="sortParts('unitVolume')" class="text-right">Unit Vol (m&sup3;) <span class="sort-icon">&#8645;</span></th>
                                    <th onclick="sortParts('totalVolume')" class="text-right">Total Vol (m&sup3;) <span class="sort-icon">&#8645;</span></th>
                                    <th onclick="sortParts('totalWeight')" class="text-right">Total Wt (kg) <span class="sort-icon">&#8645;</span></th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="partsTableBody">
                                <tr>
                                    <td colspan="12" class="text-center text-slate-400 py-8 italic">Select purchase orders above to view line items</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Debug Console -->
                <div id="debugConsoleContainer" class="mt-6" style="display: none;">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                        <button onclick="toggleDebugConsole()" class="w-full px-6 py-3 flex items-center justify-between hover:bg-slate-50 transition-colors">
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/>
                                </svg>
                                <span class="text-sm font-semibold text-slate-700">Debug Console</span>
                            </div>
                            <svg id="debugChevron" class="w-5 h-5 text-slate-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <div id="debugContent" class="hidden border-t border-slate-200">
                            <div class="bg-slate-900 px-4 py-2 flex items-center justify-between">
                                <span class="text-xs text-slate-400 font-mono">Query & Application Diagnostics</span>
                                <button onclick="clearDebugLog()" class="text-xs text-slate-400 hover:text-white transition-colors">Clear</button>
                            </div>
                            <div id="debugLog" class="bg-slate-950 text-slate-200 p-4 font-mono text-xs max-h-96 overflow-y-auto custom-scrollbar">
                                <div class="text-slate-500 italic">Waiting for initialization...</div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- ============================================
         CONTAINER SETTINGS MODAL
         ============================================ -->
    <div id="containerSettingsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center" onclick="closeContainerSettings(event)">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md flex flex-col" onclick="event.stopPropagation()">
            <!-- Modal Header -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-slate-200">
                <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                    <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    Container Settings
                </h2>
                <button onclick="closeContainerSettings()" class="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg transition-all">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="px-6 py-5 space-y-5">
                <!-- Internal Dimensions -->
                <div>
                    <div class="text-xs font-bold text-slate-700 uppercase tracking-wide mb-2">Internal Dimensions (metres)</div>
                    <div class="grid grid-cols-3 gap-3">
                        <div>
                            <label class="text-[10px] text-slate-500 block mb-1">Length</label>
                            <input type="number" id="dimLength" class="dim-input w-full" step="0.01" onchange="onDimensionChange()">
                        </div>
                        <div>
                            <label class="text-[10px] text-slate-500 block mb-1">Width</label>
                            <input type="number" id="dimWidth" class="dim-input w-full" step="0.01" onchange="onDimensionChange()">
                        </div>
                        <div>
                            <label class="text-[10px] text-slate-500 block mb-1">Height</label>
                            <input type="number" id="dimHeight" class="dim-input w-full" step="0.01" onchange="onDimensionChange()">
                        </div>
                    </div>
                    <div class="mt-2 flex items-center justify-between text-xs text-slate-500">
                        <span>Total Volume: <strong id="totalVolume" class="text-slate-800">0.00 m&sup3;</strong></span>
                    </div>
                </div>

                <!-- Max Payload -->
                <div>
                    <div class="text-xs font-bold text-slate-700 uppercase tracking-wide mb-2">Max Payload</div>
                    <div class="flex items-center gap-2">
                        <input type="number" id="maxPayload" class="dim-input" step="100" value="0" onchange="recalculate()" style="width: 120px;">
                        <span class="text-xs text-slate-500">kg</span>
                    </div>
                </div>

                <!-- Height Restriction -->
                <div class="p-3 bg-amber-50 rounded-lg border border-amber-200">
                    <div class="flex items-center justify-between mb-2">
                        <div class="text-xs font-bold text-amber-700 uppercase tracking-wide">Height Restriction</div>
                        <label class="flex items-center gap-1.5 text-xs text-slate-700">
                            <input type="checkbox" id="enableHeightRestriction" onchange="recalculate()" class="accent-[#f59e0b]">
                            Enable
                        </label>
                    </div>
                    <div id="heightRestrictionInputs" class="grid grid-cols-2 gap-3" style="display: none;">
                        <div>
                            <label class="text-[10px] text-slate-500 block mb-1">Max Fill Height (m)</label>
                            <input type="number" id="maxFillHeight" class="dim-input w-full" step="0.01" value="2.10" onchange="recalculate()">
                        </div>
                        <div>
                            <label class="text-[10px] text-slate-500 block mb-1">Pallet Height (m)</label>
                            <input type="number" id="palletHeight" class="dim-input w-full" step="0.01" value="0.15" onchange="recalculate()">
                        </div>
                    </div>
                    <p class="text-[10px] text-amber-600 mt-2">Restrict usable volume for pallet stacking limits</p>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="px-6 py-3 border-t border-slate-200 flex justify-end">
                <button onclick="closeContainerSettings()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-semibold transition-colors">
                    Done
                </button>
            </div>
        </div>
    </div>

    <!-- ============================================
         TOOLTIP
         ============================================ -->
    <div id="tooltip" class="tooltip"></div>

    <!-- ============================================
         LOADING OVERLAY
         ============================================ -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-xl p-8 flex flex-col items-center gap-4 shadow-2xl">
            <div class="spinner"></div>
            <p class="text-slate-700 font-semibold">Loading data...</p>
        </div>
    </div>

    <!-- ============================================
         JAVASCRIPT
         ============================================ -->
    <script>
        'use strict';

        /* ============================================
           CONFIGURATION & CONSTANTS
           ============================================ */

        // Standard container internal dimensions in metres and max payload in kg
        const CONTAINER_SPECS = {
            '20ft':    { length: 5.90,  width: 2.35, height: 2.39, maxPayload: 25000, label: "20ft Standard" },
            '40ft':    { length: 12.03, width: 2.35, height: 2.39, maxPayload: 27600, label: "40ft Standard" },
            '40ft_hc': { length: 12.03, width: 2.35, height: 2.69, maxPayload: 26580, label: "40ft High Cube" },
            'custom':  { length: 12.03, width: 2.35, height: 2.39, maxPayload: 30000, label: "Custom" }
        };

        // Conversion factors to metres (used as fallback if UOM table query fails)
        const DIM_TO_METRES = {
            'mm': 0.001,
            'cm': 0.01,
            'm':  1,
            'in': 0.0254,
            'ft': 0.3048
        };

        // Conversion factors to kilograms (used as fallback if UOM table query fails)
        const WEIGHT_TO_KG = {
            'kg': 1,
            'lb': 0.453592,
            'g':  0.001,
            'oz': 0.0283495
        };

        // Fishbowl configuration
        const BI_SHOW_DEBUG_PROP = typeof getProperty === 'function' ? getProperty('BI_SHOW_DEBUG', 'false') : 'false';
        const DEBUG_MODE = BI_SHOW_DEBUG_PROP === 'true' || BI_SHOW_DEBUG_PROP === true;

        // Custom field name for identifying container-eligible POs
        const CONTAINER_CUSTOM_FIELD = typeof getProperty === 'function'
            ? getProperty('BI_CONTAINER_CUSTOM_FIELD', 'Container')
            : 'Container';

        // Custom field names for part dimensions (on the Product)
        const PART_LENGTH_FIELD = typeof getProperty === 'function'
            ? getProperty('BI_PART_LENGTH_FIELD', 'Length')
            : 'Length';
        const PART_WIDTH_FIELD = typeof getProperty === 'function'
            ? getProperty('BI_PART_WIDTH_FIELD', 'Width')
            : 'Width';
        const PART_HEIGHT_FIELD = typeof getProperty === 'function'
            ? getProperty('BI_PART_HEIGHT_FIELD', 'Height')
            : 'Height';
        const PART_WEIGHT_FIELD = typeof getProperty === 'function'
            ? getProperty('BI_PART_WEIGHT_FIELD', 'Weight')
            : 'Weight';

        /* ============================================
           GLOBAL STATE
           ============================================ */
        let allPurchaseOrders = [];
        let selectedPOIds = new Set();
        let lineItems = [];
        let filteredLineItems = [];
        let partsSortColumn = 'poNum';
        let partsSortDirection = 'asc';
        let containerZoom = 1.0;
        // UOM conversion maps loaded from Fishbowl (code -> multiplierToBase)
        let lengthUOMs = {};  // { code: { name, toMetres } }
        let weightUOMs = {};  // { code: { name, toKg } }

        /* ============================================
           UTILITY FUNCTIONS
           ============================================ */

        function debugLog(message, type) {
            if (!DEBUG_MODE) return;
            var timestamp = new Date().toLocaleTimeString();
            var logDiv = document.getElementById('debugLog');
            var placeholder = logDiv.querySelector('.italic');
            if (placeholder) logDiv.innerHTML = '';

            var colors = {
                'info': '#60a5fa', 'success': '#34d399', 'warning': '#fbbf24',
                'error': '#f87171', 'query': '#a78bfa'
            };

            var entry = document.createElement('div');
            entry.style.marginBottom = '4px';
            entry.innerHTML = '<span style="color: #64748b;">[' + timestamp + ']</span> <span style="color: ' + (colors[type] || '#e2e8f0') + ';">' + message + '</span>';
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearDebugLog() {
            document.getElementById('debugLog').innerHTML = '<div class="text-slate-500 italic">Log cleared...</div>';
        }

        function toggleDebugConsole() {
            var content = document.getElementById('debugContent');
            var chevron = document.getElementById('debugChevron');
            content.classList.toggle('hidden');
            chevron.style.transform = content.classList.contains('hidden') ? '' : 'rotate(180deg)';
        }

        function escapeSQL(str) {
            if (str === null || str === undefined) return '';
            return String(str).replace(/'/g, "''");
        }

        function formatNumber(value, decimals) {
            if (decimals === undefined) decimals = 2;
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            }).format(value);
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        /* ============================================
           UOM LOADING FROM FISHBOWL
           ============================================ */

        function loadUOMs() {
            debugLog('Loading UOMs from Fishbowl...', 'info');

            // Fallback UOM definitions
            var fallbackLength = [
                { code: 'mm', name: 'Millimetres (mm)', toMetres: 0.001 },
                { code: 'cm', name: 'Centimetres (cm)', toMetres: 0.01 },
                { code: 'm',  name: 'Metres (m)',       toMetres: 1 },
                { code: 'in', name: 'Inches (in)',      toMetres: 0.0254 },
                { code: 'ft', name: 'Feet (ft)',        toMetres: 0.3048 }
            ];
            var fallbackWeight = [
                { code: 'kg', name: 'Kilograms (kg)', toKg: 1 },
                { code: 'lb', name: 'Pounds (lb)',    toKg: 0.453592 },
                { code: 'g',  name: 'Grams (g)',      toKg: 0.001 },
                { code: 'oz', name: 'Ounces (oz)',    toKg: 0.0283495 }
            ];

            try {
                // Query UOMs from Fishbowl grouped by UOMType
                // UOMType: 2=Weight, 3=Length, 4=Area, 5=Volume
                // We need Length (3) for dimensions and Weight (2) for weight
                // UOM.Multiply gives the factor to convert to base UOM
                var query =
                    "SELECT " +
                    "    uom.Code AS code, " +
                    "    uom.Name AS name, " +
                    "    uom.Multiply AS multiply, " +
                    "    uomtype.Name AS typeName, " +
                    "    uomtype.Id AS typeId " +
                    "FROM UOM uom " +
                    "INNER JOIN UOMType uomtype ON uom.UOMType = uomtype.Id " +
                    "WHERE uomtype.Id IN (2, 3) " +
                    "ORDER BY uomtype.Id, uom.Name";

                debugLog('SQL (UOM): ' + query.substring(0, 100) + '...', 'query');
                var result = JSON.parse(runQuery(query));
                debugLog('Loaded ' + result.length + ' UOMs', 'success');

                // Separate into length and weight
                var fbLengthUOMs = [];
                var fbWeightUOMs = [];

                result.forEach(function(row) {
                    var typeId = parseInt(row.typeId);
                    var multiply = parseFloat(row.multiply) || 1;

                    if (typeId === 3) { // Length
                        // Fishbowl Multiply gives conversion factor; we need factor to metres
                        // Assumption: base length UOM in Fishbowl is metres (multiply=1 for metres)
                        // If not, this may need adjustment based on client's base UOM
                        fbLengthUOMs.push({
                            code: row.code,
                            name: row.name + ' (' + row.code + ')',
                            toMetres: multiply
                        });
                    } else if (typeId === 2) { // Weight
                        fbWeightUOMs.push({
                            code: row.code,
                            name: row.name + ' (' + row.code + ')',
                            toKg: multiply
                        });
                    }
                });

                // Use Fishbowl data if available, otherwise fallback
                if (fbLengthUOMs.length > 0) {
                    fallbackLength = fbLengthUOMs;
                    debugLog('Using ' + fbLengthUOMs.length + ' length UOMs from Fishbowl', 'success');
                }
                if (fbWeightUOMs.length > 0) {
                    fallbackWeight = fbWeightUOMs;
                    debugLog('Using ' + fbWeightUOMs.length + ' weight UOMs from Fishbowl', 'success');
                }

            } catch (error) {
                debugLog('UOM query failed, using fallback UOMs: ' + error.message, 'warning');
            }

            // Populate the dropdowns and maps
            var dimSelect = document.getElementById('partDimUnit');
            dimSelect.innerHTML = '';
            lengthUOMs = {};
            fallbackLength.forEach(function(u) {
                lengthUOMs[u.code] = u;
                var opt = document.createElement('option');
                opt.value = u.code;
                opt.textContent = u.name;
                dimSelect.appendChild(opt);
            });
            // Default to mm
            if (lengthUOMs['mm']) {
                dimSelect.value = 'mm';
            }

            var wtSelect = document.getElementById('partWeightUnit');
            wtSelect.innerHTML = '';
            weightUOMs = {};
            fallbackWeight.forEach(function(u) {
                weightUOMs[u.code] = u;
                var opt = document.createElement('option');
                opt.value = u.code;
                opt.textContent = u.name;
                wtSelect.appendChild(opt);
            });
            // Default to kg
            if (weightUOMs['kg']) {
                wtSelect.value = 'kg';
            }
        }

        function getDimConversionFactor() {
            var code = document.getElementById('partDimUnit').value;
            if (lengthUOMs[code]) return lengthUOMs[code].toMetres;
            return DIM_TO_METRES[code] || 0.001; // fallback to mm
        }

        function getWeightConversionFactor() {
            var code = document.getElementById('partWeightUnit').value;
            if (weightUOMs[code]) return weightUOMs[code].toKg;
            return WEIGHT_TO_KG[code] || 1; // fallback to kg
        }

        /* ============================================
           CONTAINER DIMENSION MANAGEMENT
           ============================================ */

        function getContainerSpec() {
            return {
                length: parseFloat(document.getElementById('dimLength').value) || 0,
                width:  parseFloat(document.getElementById('dimWidth').value) || 0,
                height: parseFloat(document.getElementById('dimHeight').value) || 0,
                maxPayload: parseFloat(document.getElementById('maxPayload').value) || 0
            };
        }

        function getEffectiveHeight() {
            var spec = getContainerSpec();
            if (document.getElementById('enableHeightRestriction').checked) {
                var maxFill = parseFloat(document.getElementById('maxFillHeight').value) || spec.height;
                maxFill = Math.min(maxFill, spec.height); // Never exceed container height
                var pallet = parseFloat(document.getElementById('palletHeight').value) || 0;
                return Math.max(0, Math.min(maxFill - pallet, spec.height));
            }
            return spec.height;
        }

        function getContainerVolume() {
            var spec = getContainerSpec();
            var effectiveH = getEffectiveHeight();
            return spec.length * spec.width * effectiveH;
        }

        function onContainerTypeChange() {
            var type = document.getElementById('containerType').value;
            var spec = CONTAINER_SPECS[type];
            var isCustom = (type === 'custom');

            document.getElementById('dimLength').value = spec.length;
            document.getElementById('dimWidth').value = spec.width;
            document.getElementById('dimHeight').value = spec.height;
            document.getElementById('dimLength').readOnly = !isCustom;
            document.getElementById('dimWidth').readOnly = !isCustom;
            document.getElementById('dimHeight').readOnly = !isCustom;

            var vol = spec.length * spec.width * spec.height;
            document.getElementById('totalVolume').textContent = formatNumber(vol) + ' m\u00B3';
            document.getElementById('maxPayload').value = spec.maxPayload;

            updateContainerSummaryText();
            recalculate();
        }

        function onDimensionChange() {
            document.getElementById('containerType').value = 'custom';
            var l = parseFloat(document.getElementById('dimLength').value) || 0;
            var w = parseFloat(document.getElementById('dimWidth').value) || 0;
            var h = parseFloat(document.getElementById('dimHeight').value) || 0;
            document.getElementById('totalVolume').textContent = formatNumber(l * w * h) + ' m\u00B3';
            updateContainerSummaryText();
            recalculate();
        }

        function updateContainerSummaryText() {
            var l = parseFloat(document.getElementById('dimLength').value) || 0;
            var w = parseFloat(document.getElementById('dimWidth').value) || 0;
            var h = parseFloat(document.getElementById('dimHeight').value) || 0;
            var vol = l * w * h;
            var payload = parseFloat(document.getElementById('maxPayload').value) || 0;

            document.getElementById('summaryDims').innerHTML = '<span class="text-slate-400">(L)</span> ' + formatNumber(l) + ' &times; <span class="text-slate-400">(W)</span> ' + formatNumber(w) + ' &times; <span class="text-slate-400">(H)</span> ' + formatNumber(h) + 'm';
            document.getElementById('summaryVolume').textContent = formatNumber(vol) + ' m\u00B3';
            document.getElementById('summaryPayload').textContent = formatNumber(payload, 0) + ' kg';
        }

        /* ============================================
           CONTAINER SETTINGS MODAL
           ============================================ */

        function openContainerSettings() {
            var modal = document.getElementById('containerSettingsModal');
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
        }

        function closeContainerSettings(event) {
            if (event && event.target && event.target !== document.getElementById('containerSettingsModal')) return;
            var modal = document.getElementById('containerSettingsModal');
            modal.classList.add('hidden');
            modal.style.display = '';
            updateContainerSummaryText();
        }

        /* ============================================
           ZOOM CONTROLS
           ============================================ */

        function zoomContainer(direction) {
            if (direction === 0) {
                containerZoom = 1.0;
            } else if (direction > 0) {
                containerZoom = Math.min(containerZoom + 0.15, 2.5);
            } else {
                containerZoom = Math.max(containerZoom - 0.15, 0.4);
            }
            document.getElementById('zoomLabel').textContent = Math.round(containerZoom * 100) + '%';
            rerenderContainer();
        }

        function rerenderContainer() {
            var vol = getContainerVolume();
            if (vol > 0 && lineItems.length > 0) {
                var totalVol = 0;
                lineItems.forEach(function(item) { totalVol += item._totalVolume || 0; });
                renderIsometricContainer(totalVol / vol);
            } else {
                renderIsometricContainer(0);
            }
        }

        /* ============================================
           HEIGHT RESTRICTION TOGGLE
           ============================================ */

        // Called by the checkbox
        document.addEventListener('DOMContentLoaded', function() {
            var chk = document.getElementById('enableHeightRestriction');
            if (chk) {
                chk.addEventListener('change', function() {
                    document.getElementById('heightRestrictionInputs').style.display = this.checked ? 'grid' : 'none';
                });
            }
        });

        /* ============================================
           PURCHASE ORDER LOADING
           ============================================ */

        function loadPurchaseOrders() {
            debugLog('Loading eligible purchase orders...', 'info');
            showLoading(true);

            try {
                var currentUser = JSON.parse(getUser());
                var userId = currentUser.id;

                var query =
                    "SELECT " +
                    "    Po.Id AS id, " +
                    "    Po.Num AS num, " +
                    "    Po.CustomerSO AS customerSO, " +
                    "    Po.DateIssued AS dateIssued, " +
                    "    Po.DateFirstShip AS dateScheduled, " +
                    "    Po.TotalPrice AS totalPrice, " +
                    "    Vendor.Name AS vendorName, " +
                    "    PoStatus.Name AS statusName, " +
                    "    cf.Info AS containerInfo " +
                    "FROM Po " +
                    "LEFT JOIN Vendor ON Po.VendorId = Vendor.Id " +
                    "LEFT JOIN PoStatus ON Po.StatusId = PoStatus.Id " +
                    "LEFT JOIN CustomField cf ON cf.RecordId = Po.Id " +
                    "    AND cf.TableName = 'PO' " +
                    "    AND cf.FieldName = '" + escapeSQL(CONTAINER_CUSTOM_FIELD) + "' " +
                    "INNER JOIN UserToLG ON Po.LocationGroupId = UserToLG.LocationGroupId " +
                    "    AND UserToLG.UserId = " + userId + " " +
                    "WHERE PoStatus.Name IN ('Issued', 'Partial', 'Picking', 'Picked', 'Pending Approval') " +
                    "    AND cf.Info IS NOT NULL AND cf.Info != '' " +
                    "ORDER BY Po.Num DESC";

                debugLog('SQL: ' + query.substring(0, 120) + '...', 'query');
                var result = JSON.parse(runQuery(query));
                debugLog('Loaded ' + result.length + ' eligible POs', 'success');

                allPurchaseOrders = result;
                populateVendorFilter();
                renderPOList();

            } catch (error) {
                debugLog('ERROR loading POs: ' + error.message, 'error');
                allPurchaseOrders = getDemoPurchaseOrders();
                debugLog('Using demo data (' + allPurchaseOrders.length + ' POs)', 'warning');
                populateVendorFilter();
                renderPOList();
            } finally {
                showLoading(false);
            }
        }

        function populateVendorFilter() {
            var vendors = {};
            allPurchaseOrders.forEach(function(po) {
                if (po.vendorName) vendors[po.vendorName] = true;
            });

            var sel = document.getElementById('vendorFilter');
            sel.innerHTML = '<option value="%">All Vendors</option>';
            Object.keys(vendors).sort().forEach(function(v) {
                sel.innerHTML += '<option value="' + v.replace(/"/g, '&quot;') + '">' + v + '</option>';
            });
        }

        function filterPOList() {
            renderPOList();
        }

        function renderPOList() {
            var container = document.getElementById('poListContainer');
            var searchTerm = (document.getElementById('poSearch').value || '').toLowerCase();
            var vendorFilter = document.getElementById('vendorFilter').value;

            var filtered = allPurchaseOrders.filter(function(po) {
                if (searchTerm && (po.num || '').toLowerCase().indexOf(searchTerm) === -1 &&
                    (po.vendorName || '').toLowerCase().indexOf(searchTerm) === -1 &&
                    (po.containerInfo || '').toLowerCase().indexOf(searchTerm) === -1) {
                    return false;
                }
                if (vendorFilter !== '%' && po.vendorName !== vendorFilter) return false;
                return true;
            });

            if (filtered.length === 0) {
                container.innerHTML = '<div class="p-4 text-center text-slate-400 text-sm italic">No matching purchase orders found</div>';
                return;
            }

            var html = '';
            filtered.forEach(function(po) {
                var isSelected = selectedPOIds.has(po.id);
                var checkedAttr = isSelected ? 'checked' : '';
                var selectedClass = isSelected ? ' selected' : '';
                var statusClass = 'status-badge';
                if (po.statusName === 'Issued') statusClass += ' status-issued';
                else if (po.statusName === 'Partial') statusClass += ' status-partial';
                else if (po.statusName === 'Pending Approval') statusClass += ' status-pending';
                else if (po.statusName === 'Picking' || po.statusName === 'Picked') statusClass += ' status-picking';

                html += '<div class="po-list-item' + selectedClass + '" onclick="togglePOSelection(' + po.id + ', this)">' +
                    '<input type="checkbox" ' + checkedAttr + ' onclick="event.stopPropagation(); togglePOSelection(' + po.id + ', this.parentElement)">' +
                    '<div class="flex-1 grid grid-cols-5 gap-2 items-center text-sm">' +
                    '  <span class="font-semibold text-slate-800">' + (po.num || '') + '</span>' +
                    '  <span class="text-slate-600 truncate">' + (po.vendorName || '') + '</span>' +
                    '  <span class="' + statusClass + '">' + (po.statusName || '') + '</span>' +
                    '  <span class="text-slate-500 text-xs">' + (po.containerInfo || '') + '</span>' +
                    '  <span class="text-slate-400 text-xs text-right">' + (po.dateScheduled ? moment(po.dateScheduled).format('MMM D, YYYY') : '') + '</span>' +
                    '</div>' +
                    '</div>';
            });

            container.innerHTML = html;
            updateSelectedCount();
        }

        function togglePOSelection(poId, element) {
            if (selectedPOIds.has(poId)) {
                selectedPOIds.delete(poId);
            } else {
                selectedPOIds.add(poId);
            }
            renderPOList();
            loadLineItemsForSelectedPOs();
        }

        function selectAllVisible() {
            var searchTerm = (document.getElementById('poSearch').value || '').toLowerCase();
            var vendorFilter = document.getElementById('vendorFilter').value;

            allPurchaseOrders.forEach(function(po) {
                var matchesSearch = !searchTerm ||
                    (po.num || '').toLowerCase().indexOf(searchTerm) !== -1 ||
                    (po.vendorName || '').toLowerCase().indexOf(searchTerm) !== -1;
                var matchesVendor = vendorFilter === '%' || po.vendorName === vendorFilter;
                if (matchesSearch && matchesVendor) {
                    selectedPOIds.add(po.id);
                }
            });
            renderPOList();
            loadLineItemsForSelectedPOs();
        }

        function deselectAll() {
            selectedPOIds.clear();
            renderPOList();
            lineItems = [];
            filteredLineItems = [];
            renderPartsTable();
            recalculate();
        }

        function updateSelectedCount() {
            document.getElementById('selectedPOCount').textContent = selectedPOIds.size + ' selected';
        }

        /* ============================================
           LINE ITEM LOADING
           ============================================ */

        function loadLineItemsForSelectedPOs() {
            if (selectedPOIds.size === 0) {
                lineItems = [];
                filteredLineItems = [];
                renderPartsTable();
                recalculate();
                return;
            }

            debugLog('Loading line items for ' + selectedPOIds.size + ' POs...', 'info');

            try {
                var poIds = Array.from(selectedPOIds).join(',');

                var query =
                    "SELECT " +
                    "    Po.Num AS poNum, " +
                    "    PoItem.Id AS poItemId, " +
                    "    Part.Num AS partNum, " +
                    "    Part.Description AS partDesc, " +
                    "    PoItem.QtyToFulfill AS qty, " +
                    "    PoItemStatus.Name AS itemStatus, " +
                    "    cfLen.Info AS partLength, " +
                    "    cfWid.Info AS partWidth, " +
                    "    cfHt.Info AS partHeight, " +
                    "    cfWt.Info AS partWeight " +
                    "FROM PoItem " +
                    "INNER JOIN Po ON PoItem.PoId = Po.Id " +
                    "LEFT JOIN Part ON PoItem.PartId = Part.Id " +
                    "LEFT JOIN PoItemStatus ON PoItem.StatusId = PoItemStatus.Id " +
                    "LEFT JOIN CustomField cfLen ON cfLen.RecordId = Part.Id AND cfLen.TableName = 'PART' AND cfLen.FieldName = '" + escapeSQL(PART_LENGTH_FIELD) + "' " +
                    "LEFT JOIN CustomField cfWid ON cfWid.RecordId = Part.Id AND cfWid.TableName = 'PART' AND cfWid.FieldName = '" + escapeSQL(PART_WIDTH_FIELD) + "' " +
                    "LEFT JOIN CustomField cfHt ON cfHt.RecordId = Part.Id AND cfHt.TableName = 'PART' AND cfHt.FieldName = '" + escapeSQL(PART_HEIGHT_FIELD) + "' " +
                    "LEFT JOIN CustomField cfWt ON cfWt.RecordId = Part.Id AND cfWt.TableName = 'PART' AND cfWt.FieldName = '" + escapeSQL(PART_WEIGHT_FIELD) + "' " +
                    "WHERE Po.Id IN (" + poIds + ") " +
                    "    AND PoItemStatus.Name NOT IN ('Voided') " +
                    "ORDER BY Po.Num, Part.Num";

                debugLog('SQL: ' + query.substring(0, 120) + '...', 'query');
                var result = JSON.parse(runQuery(query));
                debugLog('Loaded ' + result.length + ' line items', 'success');
                lineItems = result;

            } catch (error) {
                debugLog('ERROR loading line items: ' + error.message, 'error');
                lineItems = getDemoLineItems();
                debugLog('Using demo line items (' + lineItems.length + ')', 'warning');
            }

            filterPartsTable();
            recalculate();
        }

        /* ============================================
           CALCULATION ENGINE
           ============================================ */

        function recalculate() {
            updateContainerSummaryText();
            var spec = getContainerSpec();
            var effectiveH = getEffectiveHeight();
            var containerVol = spec.length * spec.width * effectiveH;
            var dimFactor = getDimConversionFactor();
            var weightFactor = getWeightConversionFactor();

            // Update height restriction info display
            var hrEnabled = document.getElementById('enableHeightRestriction').checked;
            var hrInfo = document.getElementById('heightRestrictionInfo');
            if (hrEnabled) {
                hrInfo.classList.remove('hidden');
                var mfh = parseFloat(document.getElementById('maxFillHeight').value) || spec.height;
                var ph = parseFloat(document.getElementById('palletHeight').value) || 0;
                document.getElementById('usableHeightDisplay').textContent = formatNumber(effectiveH);
                document.getElementById('restrictedFillDisplay').textContent = formatNumber(mfh - ph);
                document.getElementById('restrictedPalletDisplay').textContent = formatNumber(ph);
            } else {
                hrInfo.classList.add('hidden');
            }

            var totalVolumeUsed = 0;
            var totalWeightUsed = 0;
            var missingDimCount = 0;
            var missingWeightCount = 0;
            var poVolumes = {};

            lineItems.forEach(function(item) {
                var l = parseFloat(item.partLength) || 0;
                var w = parseFloat(item.partWidth) || 0;
                var h = parseFloat(item.partHeight) || 0;
                var wt = parseFloat(item.partWeight) || 0;
                var qty = parseFloat(item.qty) || 0;

                var lm = l * dimFactor;
                var wm = w * dimFactor;
                var hm = h * dimFactor;
                var wtKg = wt * weightFactor;

                var unitVol = lm * wm * hm;
                var totalVol = unitVol * qty;
                var totalWt = wtKg * qty;

                item._unitVolume = unitVol;
                item._totalVolume = totalVol;
                item._unitWeight = wtKg;
                item._totalWeight = totalWt;
                item._hasDims = (l > 0 && w > 0 && h > 0);

                if (!item._hasDims) missingDimCount++;
                if (wt === 0) missingWeightCount++;

                totalVolumeUsed += totalVol;
                totalWeightUsed += totalWt;

                var poKey = item.poNum || 'Unknown';
                if (!poVolumes[poKey]) poVolumes[poKey] = 0;
                poVolumes[poKey] += totalVol;
            });

            var volumePercent = containerVol > 0 ? (totalVolumeUsed / containerVol) * 100 : 0;
            var maxPayload = parseFloat(document.getElementById('maxPayload').value) || 0;
            var weightPercent = maxPayload > 0 ? (totalWeightUsed / maxPayload) * 100 : 0;

            // Calculate containers needed (driven by whichever is the tighter constraint)
            var containersByVolume = containerVol > 0 ? totalVolumeUsed / containerVol : 0;
            var containersByWeight = maxPayload > 0 ? totalWeightUsed / maxPayload : 0;
            var containersNeeded = Math.max(containersByVolume, containersByWeight);
            var containersWhole = Math.ceil(containersNeeded);
            var limitingFactor = containersByVolume >= containersByWeight ? 'volume' : 'weight';

            // Update Containers Needed display
            if (containersNeeded > 0) {
                document.getElementById('containersNeededDisplay').textContent = formatNumber(containersNeeded, 1);
                document.getElementById('containersNeededDisplay').className = 'text-3xl font-bold mt-1 ' +
                    (containersNeeded > 1 ? 'text-amber-600' : 'text-green-600');
                var detailText = containersWhole + ' container' + (containersWhole !== 1 ? 's' : '') + ' needed';
                if (containersNeeded > 1) {
                    detailText += ' (limited by ' + limitingFactor + ')';
                }
                document.getElementById('containersNeededDetail').textContent = detailText;
            } else {
                document.getElementById('containersNeededDisplay').textContent = '0';
                document.getElementById('containersNeededDisplay').className = 'text-3xl font-bold mt-1 text-slate-900';
                document.getElementById('containersNeededDetail').textContent = 'Select POs to calculate';
            }

            // Update KPIs
            document.getElementById('kpiVolumeUsed').textContent = formatNumber(totalVolumeUsed) + ' m\u00B3';
            document.getElementById('kpiCapacity').textContent = formatNumber(volumePercent, 1) + '%';
            document.getElementById('kpiCapacity').className = 'text-lg font-bold ' +
                (volumePercent > 100 ? 'text-red-600' : volumePercent > 80 ? 'text-amber-600' : 'text-slate-900');
            document.getElementById('kpiWeight').textContent = formatNumber(totalWeightUsed, 0) + ' kg';
            document.getElementById('kpiItems').textContent = lineItems.length;
            document.getElementById('kpiContainers').textContent = containersNeeded > 0 ? formatNumber(containersNeeded, 1) : '0';
            document.getElementById('kpiContainers').className = 'text-lg font-bold ' +
                (containersNeeded > 1 ? 'text-amber-600' : 'text-slate-900');

            // Update capacity bars
            var volBarPct = Math.min(volumePercent, 100);
            document.getElementById('volumeBarFill').setAttribute('width', volBarPct + '%');
            document.getElementById('volumeBarFill').setAttribute('fill',
                volumePercent > 100 ? '#ef4444' : volumePercent > 80 ? '#f59e0b' : '#2d9cdb');
            document.getElementById('volumeSummary').textContent =
                formatNumber(totalVolumeUsed) + ' / ' + formatNumber(containerVol) + ' m\u00B3';
            document.getElementById('volumePercent').textContent = formatNumber(volumePercent, 1) + '%';

            var wtBarPct = Math.min(weightPercent, 100);
            document.getElementById('weightBarFill').setAttribute('width', wtBarPct + '%');
            document.getElementById('weightBarFill').setAttribute('fill',
                weightPercent > 100 ? '#ef4444' : weightPercent > 80 ? '#f59e0b' : '#10b981');
            document.getElementById('weightSummary').textContent =
                formatNumber(totalWeightUsed, 0) + ' / ' + formatNumber(maxPayload, 0) + ' kg';
            document.getElementById('weightPercent').textContent = formatNumber(weightPercent, 1) + '%';

            document.getElementById('fillPercentLabel').textContent = formatNumber(volumePercent, 1) + '%';
            document.getElementById('fillPercentLabel').className = 'text-2xl font-bold ' +
                (volumePercent > 100 ? 'text-red-500' : volumePercent > 80 ? 'text-amber-500' : volumePercent > 0 ? 'text-indigo-500' : 'text-slate-300');

            // Warnings
            var warnings = [];
            if (volumePercent > 100) warnings.push('Total volume exceeds container capacity by ' + formatNumber(volumePercent - 100, 1) + '%');
            if (weightPercent > 100) warnings.push('Total weight exceeds max payload by ' + formatNumber(weightPercent - 100, 1) + '%');
            if (missingDimCount > 0) warnings.push(missingDimCount + ' item(s) have missing dimensions and are not included in volume calculation');
            if (missingWeightCount > 0) warnings.push(missingWeightCount + ' item(s) have missing weight data');
            if (hrEnabled) warnings.push('Height restriction active: usable height ' + formatNumber(effectiveH) + 'm (of ' + formatNumber(spec.height) + 'm total)');
            if (containersNeeded > 1) warnings.push('Estimated ' + formatNumber(containersNeeded, 1) + ' containers needed (' + containersWhole + ' whole) - limited by ' + limitingFactor);

            var warningsPanel = document.getElementById('warningsPanel');
            var warningsList = document.getElementById('warningsList');
            if (warnings.length > 0) {
                warningsPanel.classList.remove('hidden');
                warningsList.innerHTML = warnings.map(function(w) { return '<li>' + w + '</li>'; }).join('');
            } else {
                warningsPanel.classList.add('hidden');
            }

            // Render visualisations
            renderIsometricContainer(volumePercent / 100);
            renderPOBreakdownChart(poVolumes, containerVol);
            filterPartsTable();
        }

        /* ============================================
           ISOMETRIC CONTAINER SVG (D3) WITH CARTONS
           ============================================ */

        function renderIsometricContainer(fillRatio) {
            fillRatio = Math.max(0, Math.min(fillRatio, 1.2));

            var containerEl = document.getElementById('containerVis');
            var cRect = containerEl.getBoundingClientRect();
            var svgWidth = cRect.width || 600;
            var svgHeight = cRect.height || 400;

            // Remove only the SVG, preserve HTML label divs
            d3.select('#containerVis').selectAll('svg').remove();

            // Virtual coordinate space - viewBox will scale to fit
            var vW = 1000;
            var vH = 800;

            var svg = d3.select('#containerVis')
                .append('svg')
                .attr('width', '100%')
                .attr('height', '100%')
                .attr('preserveAspectRatio', 'xMidYMid meet');

            // Dimetric projection: slightly different angles for x/z axes
            // so the rear bottom edge doesn't visually overlap the front top edge
            var angleX = Math.PI / 7;   // ~25.7 for length axis (shallower)
            var angleZ = Math.PI / 5;   // 36 for width axis (steeper)
            var cosAx = Math.cos(angleX);
            var sinAx = Math.sin(angleX);
            var cosAz = Math.cos(angleZ);
            var sinAz = Math.sin(angleZ);

            var spec = getContainerSpec();
            var effectiveH = getEffectiveHeight();
            var maxDim = Math.max(spec.length, spec.width, spec.height);
            var baseScale = maxDim > 0 ? Math.min(vW * 0.35, vH * 0.45) / maxDim : 30;
            var scale = baseScale * containerZoom;

            var boxL = spec.length * scale;
            var boxW = spec.width * scale;
            var boxH = spec.height * scale;
            var effectiveBoxH = effectiveH * scale;

            var cx = vW / 2;
            var cy = vH * 0.58;

            function iso(x, y, z) {
                return {
                    px: cx + x * cosAx - z * cosAz,
                    py: cy - y + x * sinAx + z * sinAz
                };
            }

            var corners = {
                A: iso(0, 0, 0),       B: iso(boxL, 0, 0),
                C: iso(boxL, 0, boxW), D: iso(0, 0, boxW),
                E: iso(0, boxH, 0),    F: iso(boxL, boxH, 0),
                G: iso(boxL, boxH, boxW), H: iso(0, boxH, boxW)
            };

            function pts() {
                var args = Array.prototype.slice.call(arguments);
                return args.map(function(p) { return p.px + ',' + p.py; }).join(' ');
            }

            var g = svg.append('g');

            // --- PALLETS inside the container (filling from rear) ---
            if (fillRatio > 0) {
                renderPallets(g, iso, pts, boxL, boxW, effectiveBoxH, scale, Math.min(fillRatio, 1.0));
            }

            // Overflow indicator
            if (fillRatio > 1.0) {
                var overflowH = effectiveBoxH * (fillRatio - 1.0);
                var oBaseY = effectiveBoxH;
                var oE = iso(0, oBaseY + overflowH, 0);
                var oF = iso(boxL, oBaseY + overflowH, 0);
                var oG = iso(boxL, oBaseY + overflowH, boxW);
                var eE = iso(0, oBaseY, 0);
                var eF = iso(boxL, oBaseY, 0);
                var eG = iso(boxL, oBaseY, boxW);

                g.append('polygon').attr('points', pts(eE, eF, oF, oE))
                    .style('fill', 'rgba(239, 68, 68, 0.30)').style('stroke', '#ef4444')
                    .style('stroke-width', '1').style('stroke-dasharray', '4,3');
                g.append('polygon').attr('points', pts(eF, eG, oG, oF))
                    .style('fill', 'rgba(239, 68, 68, 0.22)').style('stroke', '#ef4444')
                    .style('stroke-width', '1').style('stroke-dasharray', '4,3');
                g.append('polygon').attr('points', pts(oE, oF, oG, iso(0, oBaseY + overflowH, boxW)))
                    .style('fill', 'rgba(239, 68, 68, 0.25)').style('stroke', '#ef4444')
                    .style('stroke-width', '1').style('stroke-dasharray', '4,3');
            }

            // --- Container wireframe ---
            g.append('polygon').attr('points', pts(corners.D, corners.C, corners.G, corners.H))
                .style('fill', 'rgba(148, 163, 184, 0.08)').style('stroke', '#94a3b8')
                .style('stroke-width', '0.5').style('stroke-dasharray', '4,4');
            g.append('polygon').attr('points', pts(corners.A, corners.D, corners.H, corners.E))
                .style('fill', 'rgba(148, 163, 184, 0.06)').style('stroke', '#94a3b8')
                .style('stroke-width', '0.5').style('stroke-dasharray', '4,4');
            g.append('polygon').attr('points', pts(corners.A, corners.B, corners.C, corners.D))
                .style('fill', 'rgba(100, 116, 139, 0.08)').style('stroke', '#64748b').style('stroke-width', '0.8');
            g.append('polygon').attr('points', pts(corners.A, corners.B, corners.F, corners.E))
                .attr('class', 'container-face container-front');
            g.append('polygon').attr('points', pts(corners.B, corners.C, corners.G, corners.F))
                .attr('class', 'container-face container-right');
            g.append('polygon').attr('points', pts(corners.E, corners.F, corners.G, corners.H))
                .attr('class', 'container-face container-top');

            // Bold front edges
            g.append('line').attr('x1', corners.A.px).attr('y1', corners.A.py)
                .attr('x2', corners.B.px).attr('y2', corners.B.py)
                .style('stroke', '#334155').style('stroke-width', '2');
            g.append('line').attr('x1', corners.B.px).attr('y1', corners.B.py)
                .attr('x2', corners.F.px).attr('y2', corners.F.py)
                .style('stroke', '#334155').style('stroke-width', '2');
            g.append('line').attr('x1', corners.B.px).attr('y1', corners.B.py)
                .attr('x2', corners.C.px).attr('y2', corners.C.py)
                .style('stroke', '#334155').style('stroke-width', '2');

            // Height restriction line on all 4 sides (if enabled)
            if (document.getElementById('enableHeightRestriction').checked && effectiveBoxH < boxH) {
                var rE = iso(0, effectiveBoxH, 0);
                var rF = iso(boxL, effectiveBoxH, 0);
                var rG = iso(boxL, effectiveBoxH, boxW);
                var rH = iso(0, effectiveBoxH, boxW);
                // Front: EF
                g.append('line').attr('x1', rE.px).attr('y1', rE.py)
                    .attr('x2', rF.px).attr('y2', rF.py)
                    .style('stroke', '#f59e0b').style('stroke-width', '1.5').style('stroke-dasharray', '8,4');
                // Right: FG
                g.append('line').attr('x1', rF.px).attr('y1', rF.py)
                    .attr('x2', rG.px).attr('y2', rG.py)
                    .style('stroke', '#f59e0b').style('stroke-width', '1.5').style('stroke-dasharray', '8,4');
                // Back: GH
                g.append('line').attr('x1', rG.px).attr('y1', rG.py)
                    .attr('x2', rH.px).attr('y2', rH.py)
                    .style('stroke', '#f59e0b').style('stroke-width', '1.5').style('stroke-dasharray', '8,4');
                // Left: HE
                g.append('line').attr('x1', rH.px).attr('y1', rH.py)
                    .attr('x2', rE.px).attr('y2', rE.py)
                    .style('stroke', '#f59e0b').style('stroke-width', '1.5').style('stroke-dasharray', '8,4');
            }

            // Fill level line (SVG only - no text in SVG)
            if (fillRatio > 0 && fillRatio <= 1.0) {
                var fE = iso(0, effectiveBoxH * fillRatio, 0);
                var fF = iso(boxL, effectiveBoxH * fillRatio, 0);
                g.append('line').attr('x1', fE.px).attr('y1', fE.py)
                    .attr('x2', fF.px).attr('y2', fF.py)
                    .style('stroke', '#2d9cdb').style('stroke-width', '1.5').style('stroke-dasharray', '6,3');
            }

            // Set viewBox from content bounding box
            var svgNode = svg.node();
            var gNode = g.node();
            if (gNode) {
                var bbox = gNode.getBBox();
                var pad = 20;
                var vbX = bbox.x - pad;
                var vbY = bbox.y - pad;
                var vbW = bbox.width + pad * 2;
                var vbH = bbox.height + pad * 2;
                svgNode.setAttribute('viewBox', vbX + ' ' + vbY + ' ' + vbW + ' ' + vbH);
            }

            // --- Position HTML labels outside SVG (fixed font size) ---
            positionHTMLLabels(svgNode, corners, spec, effectiveH, effectiveBoxH, boxH, fillRatio);
        }

        /* ============================================
           HTML LABEL POSITIONING
           ============================================ */

        function positionHTMLLabels(svgNode, corners, spec, effectiveH, effectiveBoxH, boxH, fillRatio) {
            var containerEl = document.getElementById('containerVis');
            var cRect = containerEl.getBoundingClientRect();
            if (!svgNode || !cRect.width) return;

            // Convert SVG viewBox coords to pixel coords in the container div
            var viewBox = svgNode.getAttribute('viewBox');
            if (!viewBox) return;
            var vb = viewBox.split(' ').map(Number);
            var vbX = vb[0], vbY = vb[1], vbW = vb[2], vbH = vb[3];

            // SVG preserveAspectRatio=xMidYMid meet: compute actual rendered area
            var svgAspect = vbW / vbH;
            var divAspect = cRect.width / cRect.height;
            var renderW, renderH, offsetX, offsetY;
            if (divAspect > svgAspect) {
                // div is wider - svg height fills, width is centred
                renderH = cRect.height;
                renderW = renderH * svgAspect;
                offsetX = (cRect.width - renderW) / 2;
                offsetY = 0;
            } else {
                // div is taller - svg width fills, height is centred
                renderW = cRect.width;
                renderH = renderW / svgAspect;
                offsetX = 0;
                offsetY = (cRect.height - renderH) / 2;
            }

            function toPixel(svgPt) {
                return {
                    x: offsetX + ((svgPt.px - vbX) / vbW) * renderW,
                    y: offsetY + ((svgPt.py - vbY) / vbH) * renderH
                };
            }

            // Length label (bottom front edge, below)
            var midAB = { px: (corners.A.px + corners.B.px) / 2, py: (corners.A.py + corners.B.py) / 2 };
            var pxLength = toPixel(midAB);
            var lbl = document.getElementById('labelLength');
            lbl.textContent = formatNumber(spec.length) + 'm';
            lbl.style.display = 'block';
            lbl.style.left = pxLength.x + 'px';
            lbl.style.top = (pxLength.y + 8) + 'px';
            lbl.style.transform = 'translateX(-50%)';

            // Width label (bottom right edge)
            var midBC = { px: (corners.B.px + corners.C.px) / 2, py: (corners.B.py + corners.C.py) / 2 };
            var pxWidth = toPixel(midBC);
            var wLbl = document.getElementById('labelWidth');
            wLbl.textContent = formatNumber(spec.width) + 'm';
            wLbl.style.display = 'block';
            wLbl.style.left = (pxWidth.x + 10) + 'px';
            wLbl.style.top = (pxWidth.y - 2) + 'px';

            // Height label (front right vertical edge)
            var midBF = { px: (corners.B.px + corners.F.px) / 2, py: (corners.B.py + corners.F.py) / 2 };
            var pxHeight = toPixel(midBF);
            var hLbl = document.getElementById('labelHeight');
            hLbl.textContent = formatNumber(spec.height) + 'm';
            hLbl.style.display = 'block';
            hLbl.style.left = (pxHeight.x + 10) + 'px';
            hLbl.style.top = (pxHeight.y - 6) + 'px';

            // Fill % label (left of fill line)
            var fLbl = document.getElementById('labelFillPct');
            if (fillRatio > 0 && fillRatio <= 1.0) {
                var fY = effectiveBoxH * fillRatio;
                // iso(0, fY, 0) - but we need the actual point
                var fPt = { px: corners.A.px, py: corners.A.py - fY + 0 }; // simplified: use corner A's x, shifted up
                // Actually recompute properly using the same formula
                var cx = (corners.A.px + corners.B.px + corners.D.px - corners.C.px) / 2; // approximate centre
                fPt = { px: corners.A.px - (corners.B.px - corners.A.px) * 0.0, py: corners.A.py };
                // Better: the fill line left end is at iso(0, fY, 0) relative to container
                // The viewBox-scaled point for iso(0, fY, 0):
                var fillLeftSvg = {
                    px: corners.A.px,
                    py: corners.A.py - fY
                };
                // Actually corners.A = iso(0,0,0), so iso(0, fY, 0).py = corners.A.py - fY
                var pxFill = toPixel(fillLeftSvg);
                fLbl.textContent = formatNumber(fillRatio * 100, 0) + '%';
                fLbl.style.display = 'block';
                fLbl.style.left = (pxFill.x - 8) + 'px';
                fLbl.style.top = (pxFill.y - 8) + 'px';
                fLbl.style.transform = 'translateX(-100%)';
            } else {
                fLbl.style.display = 'none';
            }

            // Height restriction label
            var hrLbl = document.getElementById('labelHeightRestrict');
            if (document.getElementById('enableHeightRestriction').checked && effectiveBoxH < boxH) {
                var hrSvg = { px: corners.A.px, py: corners.A.py - effectiveBoxH };
                var pxHr = toPixel(hrSvg);
                hrLbl.textContent = 'Max fill ' + formatNumber(effectiveH) + 'm';
                hrLbl.style.display = 'block';
                hrLbl.style.left = (pxHr.x - 8) + 'px';
                hrLbl.style.top = (pxHr.y - 8) + 'px';
                hrLbl.style.transform = 'translateX(-100%)';
            } else {
                hrLbl.style.display = 'none';
            }
        }

        /* ============================================
           CARTON RENDERING - COMPLETE BOXES
           ============================================ */

        function renderPallets(g, iso, pts, boxL, boxW, effectiveBoxH, scale, fillRatio) {
            if (fillRatio <= 0 || effectiveBoxH <= 0) return;

            // Standard Australian pallet: 1.165m  1.165m
            // Fits 2-across in standard containers (2  1.165 = 2.33m  2.35m width)
            var palletLenM = 1.165;
            var palletWidM = 1.165;
            var palletBaseHM = 0.15; // Pallet deck height in metres

            var palletL = palletLenM * scale;
            var palletW = palletWidM * scale;
            var palletBaseH = Math.min(palletBaseHM * scale, effectiveBoxH * 0.08);

            // How many pallets fit in each direction
            var nL = Math.max(1, Math.floor(boxL / palletL));
            var nW = Math.max(1, Math.floor(boxW / palletW));

            // Actual pallet size snapped to fill container evenly
            var actualPL = boxL / nL;
            var actualPW = boxW / nW;

            var totalPositions = nL * nW;
            var exactFilled = totalPositions * fillRatio;
            var fullPallets = Math.floor(exactFilled);
            var partialFraction = exactFilled - fullPallets;

            var gap = Math.max(0.5, scale * 0.008);
            var goodsH = effectiveBoxH - palletBaseH;

            // Pallet base colours (wooden)
            var baseCol = {
                front: 'rgba(139, 90, 43, 0.85)', right: 'rgba(120, 75, 35, 0.80)',
                top: 'rgba(160, 110, 60, 0.88)', left: 'rgba(145, 95, 48, 0.70)',
                back: 'rgba(110, 70, 30, 0.60)', stroke: 'rgba(80, 50, 15, 0.55)'
            };

            // Goods colours - alternating for visual variety
            var goodsColors = [
                { front: 'rgba(180, 140, 80, 0.75)', right: 'rgba(150, 115, 55, 0.70)', top: 'rgba(205, 170, 105, 0.78)',
                  left: 'rgba(195, 158, 95, 0.58)', back: 'rgba(170, 130, 70, 0.52)',
                  stroke: 'rgba(110, 80, 30, 0.50)' },
                { front: 'rgba(170, 130, 70, 0.70)', right: 'rgba(140, 105, 45, 0.65)', top: 'rgba(195, 160, 95, 0.72)',
                  left: 'rgba(185, 148, 85, 0.52)', back: 'rgba(160, 120, 60, 0.47)',
                  stroke: 'rgba(100, 70, 25, 0.48)' },
                { front: 'rgba(190, 150, 90, 0.72)', right: 'rgba(160, 125, 65, 0.68)', top: 'rgba(215, 180, 115, 0.76)',
                  left: 'rgba(205, 168, 105, 0.55)', back: 'rgba(180, 140, 80, 0.50)',
                  stroke: 'rgba(120, 90, 35, 0.50)' }
            ];

            // Render back-to-front for correct overlap: high z (rear) first, low x first
            for (var iz = nW - 1; iz >= 0; iz--) {
                for (var ix = 0; ix < nL; ix++) {
                    // Fill from rear: rear row (iz=nW-1) fills first
                    var fillIdx = (nW - 1 - iz) * nL + ix;
                    var isFull = fillIdx < fullPallets;
                    var isPartial = (fillIdx === fullPallets) && partialFraction > 0.02;

                    var x0 = ix * actualPL + gap;
                    var z0 = iz * actualPW + gap;
                    var pL = actualPL - gap * 2;
                    var pW = actualPW - gap * 2;
                    if (pL <= 0 || pW <= 0) continue;

                    // --- Pallet base (always drawn for all positions) ---
                    var bA = iso(x0, 0, z0);
                    var bB = iso(x0 + pL, 0, z0);
                    var bC = iso(x0 + pL, 0, z0 + pW);
                    var bD = iso(x0, 0, z0 + pW);
                    var bE = iso(x0, palletBaseH, z0);
                    var bF = iso(x0 + pL, palletBaseH, z0);
                    var bG = iso(x0 + pL, palletBaseH, z0 + pW);
                    var bH = iso(x0, palletBaseH, z0 + pW);

                    // Hidden faces first
                    g.append('polygon').attr('points', pts(bD, bC, bG, bH))
                        .style('fill', baseCol.back).style('stroke', baseCol.stroke).style('stroke-width', '0.3');
                    g.append('polygon').attr('points', pts(bA, bD, bH, bE))
                        .style('fill', baseCol.left).style('stroke', baseCol.stroke).style('stroke-width', '0.3');
                    // Visible faces
                    g.append('polygon').attr('points', pts(bA, bB, bF, bE))
                        .style('fill', baseCol.front).style('stroke', baseCol.stroke).style('stroke-width', '0.5');
                    g.append('polygon').attr('points', pts(bB, bC, bG, bF))
                        .style('fill', baseCol.right).style('stroke', baseCol.stroke).style('stroke-width', '0.5');
                    g.append('polygon').attr('points', pts(bE, bF, bG, bH))
                        .style('fill', baseCol.top).style('stroke', baseCol.stroke).style('stroke-width', '0.5');

                    // Slat lines on pallet top (decorative)
                    for (var s = 0; s < 3; s++) {
                        var slatZ = z0 + pW * (0.15 + s * 0.35);
                        var sS = iso(x0, palletBaseH, slatZ);
                        var sE2 = iso(x0 + pL, palletBaseH, slatZ);
                        g.append('line').attr('x1', sS.px).attr('y1', sS.py)
                            .attr('x2', sE2.px).attr('y2', sE2.py)
                            .style('stroke', baseCol.stroke).style('stroke-width', '0.5');
                    }

                    // --- Goods on pallet (if filled) ---
                    if (isFull || isPartial) {
                        var gH = isPartial ? goodsH * partialFraction : goodsH;
                        if (gH <= 0) continue;

                        var col = goodsColors[(ix + iz) % goodsColors.length];
                        var baseY = palletBaseH;

                        var gA = iso(x0, baseY, z0);
                        var gB = iso(x0 + pL, baseY, z0);
                        var gC = iso(x0 + pL, baseY, z0 + pW);
                        var gD = iso(x0, baseY, z0 + pW);
                        var gE = iso(x0, baseY + gH, z0);
                        var gF = iso(x0 + pL, baseY + gH, z0);
                        var gG = iso(x0 + pL, baseY + gH, z0 + pW);
                        var gH2 = iso(x0, baseY + gH, z0 + pW);

                        // Hidden faces
                        g.append('polygon').attr('points', pts(gD, gC, gG, gH2))
                            .style('fill', col.back).style('stroke', col.stroke).style('stroke-width', '0.3');
                        g.append('polygon').attr('points', pts(gA, gD, gH2, gE))
                            .style('fill', col.left).style('stroke', col.stroke).style('stroke-width', '0.3');
                        // Visible faces
                        g.append('polygon').attr('points', pts(gA, gB, gF, gE))
                            .style('fill', col.front).style('stroke', col.stroke).style('stroke-width', '0.5');
                        g.append('polygon').attr('points', pts(gB, gC, gG, gF))
                            .style('fill', col.right).style('stroke', col.stroke).style('stroke-width', '0.5');
                        g.append('polygon').attr('points', pts(gE, gF, gG, gH2))
                            .style('fill', col.top).style('stroke', col.stroke).style('stroke-width', '0.5');

                        // Shrink-wrap strap lines (decorative)
                        if (gH > 5) {
                            var strapY = baseY + gH * 0.45;
                            var stFS = iso(x0, strapY, z0);
                            var stFE = iso(x0 + pL, strapY, z0);
                            g.append('line').attr('x1', stFS.px).attr('y1', stFS.py)
                                .attr('x2', stFE.px).attr('y2', stFE.py)
                                .style('stroke', 'rgba(0,0,0,0.10)').style('stroke-width', Math.max(1, gH * 0.025));
                            var stRS = iso(x0 + pL, strapY, z0);
                            var stRE = iso(x0 + pL, strapY, z0 + pW);
                            g.append('line').attr('x1', stRS.px).attr('y1', stRS.py)
                                .attr('x2', stRE.px).attr('y2', stRE.py)
                                .style('stroke', 'rgba(0,0,0,0.08)').style('stroke-width', Math.max(1, gH * 0.025));
                        }
                    }
                }
            }
        }

        /* ============================================
           PO BREAKDOWN CHART (D3 Horizontal Bars)
           ============================================ */

        function renderPOBreakdownChart(poVolumes, containerVol) {
            var container = document.getElementById('poBreakdownChart');
            d3.select('#poBreakdownChart').selectAll('*').remove();

            var entries = Object.keys(poVolumes).map(function(k) {
                return { po: k, volume: poVolumes[k] };
            }).sort(function(a, b) { return b.volume - a.volume; });

            if (entries.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-400 text-xs italic py-4">No data</div>';
                return;
            }

            var margin = { top: 5, right: 50, bottom: 5, left: 60 };
            var width = container.clientWidth - margin.left - margin.right;
            var barHeight = 22;
            var height = Math.max(entries.length * barHeight, 40);

            var svg = d3.select('#poBreakdownChart')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

            var maxVol = d3.max(entries, function(d) { return d.volume; }) || 1;

            var y = d3.scaleBand()
                .domain(entries.map(function(d) { return d.po; }))
                .range([0, height])
                .padding(0.2);

            var x = d3.scaleLinear()
                .domain([0, maxVol])
                .range([0, width]);

            svg.selectAll('.bar')
                .data(entries).enter().append('rect')
                .attr('x', 0)
                .attr('y', function(d) { return y(d.po); })
                .attr('width', function(d) { return x(d.volume); })
                .attr('height', y.bandwidth())
                .attr('rx', 3).attr('fill', '#2d9cdb').attr('opacity', 0.8);

            svg.selectAll('.label')
                .data(entries).enter().append('text')
                .attr('x', -4)
                .attr('y', function(d) { return y(d.po) + y.bandwidth() / 2; })
                .attr('dy', '0.35em').attr('text-anchor', 'end')
                .style('font-size', '11px').style('fill', '#334155').style('font-weight', '600')
                .text(function(d) { return d.po; });

            svg.selectAll('.value')
                .data(entries).enter().append('text')
                .attr('x', function(d) { return x(d.volume) + 4; })
                .attr('y', function(d) { return y(d.po) + y.bandwidth() / 2; })
                .attr('dy', '0.35em')
                .style('font-size', '10px').style('fill', '#64748b')
                .text(function(d) { return formatNumber(d.volume) + ' m\u00B3'; });
        }

        /* ============================================
           PARTS TABLE
           ============================================ */

        function filterPartsTable() {
            var searchTerm = (document.getElementById('partsSearch').value || '').toLowerCase();
            var hideNoDims = document.getElementById('hideNoDims').checked;

            filteredLineItems = lineItems.filter(function(item) {
                if (searchTerm &&
                    (item.partNum || '').toLowerCase().indexOf(searchTerm) === -1 &&
                    (item.partDesc || '').toLowerCase().indexOf(searchTerm) === -1 &&
                    (item.poNum || '').toLowerCase().indexOf(searchTerm) === -1) {
                    return false;
                }
                if (hideNoDims && !item._hasDims) return false;
                return true;
            });

            sortAndRenderParts();
        }

        function sortParts(column) {
            if (partsSortColumn === column) {
                partsSortDirection = partsSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                partsSortColumn = column;
                partsSortDirection = 'asc';
            }
            sortAndRenderParts();
        }

        function sortAndRenderParts() {
            var col = partsSortColumn;
            var dir = partsSortDirection;

            filteredLineItems.sort(function(a, b) {
                var aVal, bVal;
                switch (col) {
                    case 'qty': aVal = parseFloat(a.qty) || 0; bVal = parseFloat(b.qty) || 0; break;
                    case 'length': aVal = parseFloat(a.partLength) || 0; bVal = parseFloat(b.partLength) || 0; break;
                    case 'width': aVal = parseFloat(a.partWidth) || 0; bVal = parseFloat(b.partWidth) || 0; break;
                    case 'height': aVal = parseFloat(a.partHeight) || 0; bVal = parseFloat(b.partHeight) || 0; break;
                    case 'unitWeight': aVal = a._unitWeight || 0; bVal = b._unitWeight || 0; break;
                    case 'unitVolume': aVal = a._unitVolume || 0; bVal = b._unitVolume || 0; break;
                    case 'totalVolume': aVal = a._totalVolume || 0; bVal = b._totalVolume || 0; break;
                    case 'totalWeight': aVal = a._totalWeight || 0; bVal = b._totalWeight || 0; break;
                    default: aVal = (a[col] || '').toString().toLowerCase(); bVal = (b[col] || '').toString().toLowerCase();
                }
                if (aVal < bVal) return dir === 'asc' ? -1 : 1;
                if (aVal > bVal) return dir === 'asc' ? 1 : -1;
                return 0;
            });

            renderPartsTable();
        }

        function renderPartsTable() {
            var tbody = document.getElementById('partsTableBody');
            document.getElementById('partsCount').textContent = filteredLineItems.length + ' items';

            if (filteredLineItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" class="text-center text-slate-400 py-8 italic">' +
                    (lineItems.length === 0 ? 'Select purchase orders above to view line items' : 'No matching items') +
                    '</td></tr>';
                return;
            }

            var html = '';

            filteredLineItems.forEach(function(item) {
                var dimClass = item._hasDims ? '' : ' style="color: #94a3b8; font-style: italic;"';
                var statusClass = 'status-badge';
                if (item.itemStatus === 'Fulfilled') statusClass += ' status-issued';
                else if (item.itemStatus === 'Partial') statusClass += ' status-partial';
                else if (item.itemStatus === 'Entered') statusClass += ' status-pending';

                var escapedPoNum = (item.poNum || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                var escapedPartNum = (item.partNum || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');

                html += '<tr' + dimClass + '>' +
                    '<td><a href="#" class="order-link" onclick="event.preventDefault(); openModule(\'Purchase Order\', \'' + escapedPoNum + '\')">' + (item.poNum || '') + '</a></td>' +
                    '<td><a href="#" class="order-link" onclick="event.preventDefault(); openModule(\'Part\', \'' + escapedPartNum + '\')">' + (item.partNum || '') + '</a></td>' +
                    '<td class="truncate" style="max-width: 200px;" title="' + (item.partDesc || '').replace(/"/g, '&quot;') + '">' + (item.partDesc || '') + '</td>' +
                    '<td class="text-right font-medium">' + formatNumber(parseFloat(item.qty) || 0, 0) + '</td>' +
                    '<td class="text-right">' + (item.partLength || '-') + '</td>' +
                    '<td class="text-right">' + (item.partWidth || '-') + '</td>' +
                    '<td class="text-right">' + (item.partHeight || '-') + '</td>' +
                    '<td class="text-right">' + (item.partWeight ? formatNumber(parseFloat(item.partWeight), 2) : '-') + '</td>' +
                    '<td class="text-right">' + (item._unitVolume > 0 ? formatNumber(item._unitVolume, 6) : '-') + '</td>' +
                    '<td class="text-right font-semibold">' + (item._totalVolume > 0 ? formatNumber(item._totalVolume, 4) : '-') + '</td>' +
                    '<td class="text-right">' + (item._totalWeight > 0 ? formatNumber(item._totalWeight, 1) : '-') + '</td>' +
                    '<td><span class="' + statusClass + '">' + (item.itemStatus || '') + '</span></td>' +
                    '</tr>';
            });

            // Totals row
            var totVol = 0, totWt = 0;
            filteredLineItems.forEach(function(item) {
                totVol += item._totalVolume || 0;
                totWt += item._totalWeight || 0;
            });

            html += '<tr style="background: #f0f9ff; font-weight: 700; border-top: 2px solid #2d9cdb;">' +
                '<td colspan="9" class="text-right">Totals:</td>' +
                '<td class="text-right">' + formatNumber(totVol, 4) + ' m\u00B3</td>' +
                '<td class="text-right">' + formatNumber(totWt, 1) + ' kg</td>' +
                '<td></td>' +
                '</tr>';

            tbody.innerHTML = html;
        }

        /* ============================================
           EXPORT
           ============================================ */

        function exportToCSV() {
            if (filteredLineItems.length === 0) {
                alert('No data to export. Please select purchase orders first.');
                return;
            }

            var dimUnit = document.getElementById('partDimUnit').value;
            var headers = ['PO #', 'Part #', 'Description', 'Qty',
                'Length (' + dimUnit + ')', 'Width (' + dimUnit + ')', 'Height (' + dimUnit + ')',
                'Unit Weight', 'Unit Volume (m3)', 'Total Volume (m3)', 'Total Weight (kg)', 'Status'];

            var rows = filteredLineItems.map(function(item) {
                return [
                    item.poNum, item.partNum, '"' + (item.partDesc || '').replace(/"/g, '""') + '"',
                    item.qty, item.partLength || '', item.partWidth || '', item.partHeight || '',
                    item.partWeight || '', item._unitVolume ? item._unitVolume.toFixed(6) : '',
                    item._totalVolume ? item._totalVolume.toFixed(4) : '',
                    item._totalWeight ? item._totalWeight.toFixed(1) : '',
                    item.itemStatus
                ].join(',');
            });

            var csv = headers.join(',') + '\n' + rows.join('\n');
            var blob = new Blob([csv], { type: 'text/csv' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'container_capacity_' + moment().format('YYYY-MM-DD') + '.csv';
            a.click();
            URL.revokeObjectURL(url);

            debugLog('Exported ' + filteredLineItems.length + ' items to CSV', 'success');
        }

        /* ============================================
           DEMO DATA (Development/Preview fallback)
           ============================================ */

        function getDemoPurchaseOrders() {
            return [
                { id: 1001, num: 'PO-5001', vendorName: 'Acme Steel Co.', statusName: 'Issued', containerInfo: '40ft HC', dateScheduled: '2026-03-15', totalPrice: 45000 },
                { id: 1002, num: 'PO-5002', vendorName: 'Pacific Parts Ltd.', statusName: 'Issued', containerInfo: '40ft STD', dateScheduled: '2026-03-20', totalPrice: 32000 },
                { id: 1003, num: 'PO-5003', vendorName: 'Acme Steel Co.', statusName: 'Partial', containerInfo: '20ft', dateScheduled: '2026-02-28', totalPrice: 18000 },
                { id: 1004, num: 'PO-5004', vendorName: 'Global Components Inc.', statusName: 'Issued', containerInfo: '40ft HC', dateScheduled: '2026-04-01', totalPrice: 67500 },
                { id: 1005, num: 'PO-5005', vendorName: 'Pacific Parts Ltd.', statusName: 'Pending Approval', containerInfo: '40ft STD', dateScheduled: '2026-04-10', totalPrice: 28000 }
            ];
        }

        function getDemoLineItems() {
            var items = [];
            var selectedPOs = allPurchaseOrders.filter(function(po) { return selectedPOIds.has(po.id); });

            // Demo dims are in mm (default UoM is now mm)
            var demoParts = [
                { partNum: 'BRKT-4020', partDesc: 'Steel Mounting Bracket',  partLength: '406', partWidth: '305', partHeight: '102', partWeight: '2.8' },
                { partNum: 'SHAFT-200', partDesc: 'Drive Shaft Assembly',    partLength: '1219', partWidth: '152', partHeight: '152', partWeight: '8.5' },
                { partNum: 'PLATE-1010', partDesc: 'Base Plate 10x10',       partLength: '254', partWidth: '254', partHeight: '13',  partWeight: '4.2' },
                { partNum: 'HSG-MOTOR', partDesc: 'Motor Housing',           partLength: '356', partWidth: '356', partHeight: '457', partWeight: '12.0' },
                { partNum: 'FLNG-6IN', partDesc: '6" Flange Adapter',        partLength: '203', partWidth: '203', partHeight: '76',  partWeight: '3.1' },
                { partNum: 'TUBE-3FT', partDesc: 'Steel Tube 3ft',           partLength: '914', partWidth: '102', partHeight: '102', partWeight: '5.4' },
                { partNum: 'COVER-LG', partDesc: 'Large Equipment Cover',    partLength: '610', partWidth: '457', partHeight: '51',  partWeight: '6.0' },
                { partNum: 'VALVE-DN50', partDesc: 'Ball Valve DN50',         partLength: '178', partWidth: '127', partHeight: '127', partWeight: '3.8' },
                { partNum: 'GASKET-SET', partDesc: 'Gasket Set (no dims)',    partLength: '',    partWidth: '',    partHeight: '',    partWeight: '0.3' },
                { partNum: 'BOLT-KIT', partDesc: 'Bolt Kit M12x50',          partLength: '152', partWidth: '102', partHeight: '102', partWeight: '1.5' }
            ];

            selectedPOs.forEach(function(po) {
                var numItems = 3 + Math.floor(Math.random() * 4);
                for (var i = 0; i < numItems; i++) {
                    var dp = demoParts[Math.floor(Math.random() * demoParts.length)];
                    items.push({
                        poNum: po.num,
                        partNum: dp.partNum,
                        partDesc: dp.partDesc,
                        qty: String(Math.floor(Math.random() * 50) + 5),
                        itemStatus: ['Entered', 'Partial', 'Fulfilled'][Math.floor(Math.random() * 3)],
                        partLength: dp.partLength,
                        partWidth: dp.partWidth,
                        partHeight: dp.partHeight,
                        partWeight: dp.partWeight
                    });
                }
            });

            return items;
        }

        /* ============================================
           INITIALIZATION
           ============================================ */

        window.addEventListener('DOMContentLoaded', function() {
            debugLog('Initializing Container Capacity Calculator...', 'info');

            if (DEBUG_MODE) {
                document.getElementById('debugConsoleContainer').style.display = 'block';
                debugLog('Debug mode enabled', 'info');
            }

            // Load UOMs from Fishbowl (or use fallbacks)
            loadUOMs();

            // Set default container dimensions
            onContainerTypeChange();

            // Load purchase orders
            loadPurchaseOrders();

            // Render empty isometric container
            renderIsometricContainer(0);

            debugLog('Initialization complete', 'success');
        });

        // Handle window resize
        window.addEventListener('resize', function() {
            rerenderContainer();
        });
    </script>
</body>
</html>
