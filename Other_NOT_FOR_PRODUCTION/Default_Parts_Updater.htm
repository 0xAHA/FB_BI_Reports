<!DOCTYPE html>
<html lang="en">
<head>
    <!-- DataTables CDN Links -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs4-4.1.1/jq-3.3.1/jszip-2.5.0/dt-1.10.20/b-1.6.1/b-colvis-1.6.1/b-html5-1.6.1/b-print-1.6.1/cr-1.5.2/fh-3.1.6/r-2.2.3/sc-2.0.1/datatables.min.css"/>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/v/bs4-4.1.1/jq-3.3.1/jszip-2.5.0/dt-1.10.20/b-1.6.1/b-colvis-1.6.1/b-html5-1.6.1/b-print-1.6.1/cr-1.5.2/fh-3.1.6/r-2.2.3/sc-2.0.1/datatables.min.js"></script>

    <!-- Fishbowl Theme CSS -->
    <!-- <link rel="stylesheet" type="text/css" href="fishbowl-theme.css"/> -->
    
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Default Parts Location Manager</title>

    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Fishbowl Modern Theme (overrides Bootstrap) -->
    <style>
        {% Style fishbowl-theme-modern %}
    </style>

    <style>
        /* Page-specific overrides */

        .page-header {
            background: linear-gradient(135deg, var(--fb-primary) 0%, var(--fb-primary-light) 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stats-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }

        .stats-number {
            font-size: 2rem;
            font-weight: 600;
            color: var(--fb-primary);
        }

        .location-select {
            width: 100%;
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
        }

        .location-select:focus {
            border-color: var(--fb-primary);
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(21, 101, 192, 0.25);
        }

        .custom-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .custom-table thead {
            background-color: var(--fb-primary);
            color: white;
        }

        .custom-table thead th {
            border: none;
            padding: 1rem;
            font-weight: 600;
        }

        .custom-table tbody tr {
            border-bottom: 1px solid #e9ecef;
        }

        .custom-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .custom-table tbody td {
            padding: 0.75rem 1rem;
            vertical-align: middle;
        }

        .part-number {
            font-weight: 600;
            color: var(--fb-primary);
        }

        .action-buttons {
            position: sticky;
            bottom: 0;
            background: white;
            padding: 1.5rem;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            border-top: 1px solid #e9ecef;
            z-index: 100;
        }

        .btn-import {
            background-color: var(--fb-success);
            border-color: var(--fb-success);
            color: white;
            padding: 0.75rem 2rem;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .btn-import:hover {
            background-color: #1B5E20;
            border-color: #1B5E20;
            color: white;
        }

        .btn-import:disabled {
            background-color: #9E9E9E;
            border-color: #9E9E9E;
        }

        .alert-custom {
            border-radius: 8px;
            border-left: 4px solid;
            padding: 1rem 1.5rem;
        }

        .mode-selector {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .mode-option {
            border: 2px solid #e9ecef;
            padding: 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mode-option:hover {
            border-color: var(--fb-primary-light);
            background-color: #f8f9fa;
        }

        .mode-option.active {
            border-color: var(--fb-primary);
            background-color: rgba(21, 101, 192, 0.05);
        }

        .mode-option input[type="radio"] {
            width: 1.25rem;
            height: 1.25rem;
            accent-color: var(--fb-primary);
        }

        .badge-custom {
            padding: 0.4rem 0.8rem;
            font-weight: 600;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="page-header">
        <div class="container-fluid px-4">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-2"><i class="bi bi-geo-alt-fill"></i> Default Parts Location Manager</h1>
                    <p class="mb-0 opacity-75">Configure default locations for inventory parts across location groups</p>
                </div>
                <div class="col-md-4 text-md-end">
                    <span class="badge bg-light text-dark badge-custom">
                        <i class="bi bi-database-fill"></i> Fishbowl Inventory
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid px-4 pb-5">
        <!-- Stats Row -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="text-muted small mb-1">Parts to Configure</div>
                            <div class="stats-number" id="recordCount">0</div>
                        </div>
                        <div class="text-primary" style="font-size: 2.5rem;">
                            <i class="bi bi-box-seam"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="text-muted small mb-1">Ready to Import</div>
                            <div class="stats-number text-success" id="readyCount">0</div>
                        </div>
                        <div class="text-success" style="font-size: 2.5rem;">
                            <i class="bi bi-check-circle-fill"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="text-muted small mb-1">Location Groups</div>
                            <div class="stats-number text-info" id="locationGroupCount">0</div>
                        </div>
                        <div class="text-info" style="font-size: 2.5rem;">
                            <i class="bi bi-diagram-3-fill"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="text-muted small mb-1">Mode</div>
                            <div class="small fw-bold" id="currentMode">Default Locations</div>
                        </div>
                        <div class="text-warning" style="font-size: 2.5rem;">
                            <i class="bi bi-toggles"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mode Selector -->
        <div class="mode-selector">
            <h5 class="mb-3"><i class="bi bi-sliders"></i> Location Assignment Mode</h5>
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="mode-option active" id="modeDefault" onclick="setMode('default')">
                        <div class="d-flex align-items-start">
                            <input type="radio" name="mode" value="default" checked class="me-3 mt-1">
                            <div>
                                <h6 class="mb-2"><i class="bi bi-magic"></i> Automatic Default Locations</h6>
                                <p class="text-muted small mb-0">
                                    Use the default stock location (type 10) configured for each location group.
                                    This is the fastest method for standard warehouse setups.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mode-option" id="modeManual" onclick="setMode('manual')">
                        <div class="d-flex align-items-start">
                            <input type="radio" name="mode" value="manual" class="me-3 mt-1">
                            <div>
                                <h6 class="mb-2"><i class="bi bi-hand-index"></i> Manual Location Selection</h6>
                                <p class="text-muted small mb-0">
                                    Choose specific locations for each part and location group combination.
                                    Useful for non-standard or specialized storage requirements.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Messages -->
        <div id="statusMessage" style="display: none;"></div>

        <!-- Data Table -->
        <div class="custom-table">
            <table class="table table-hover mb-0" id="report-table">
                <thead>
                    <tr>
                        <th style="width: 30%;">Part Number</th>
                        <th style="width: 35%;">Location</th>
                        <th style="width: 35%;">Location Group</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Table rows will be populated here -->
                </tbody>
            </table>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <div class="container-fluid">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <div class="text-muted">
                            <i class="bi bi-info-circle"></i>
                            Review the locations above and click Import to apply changes to Fishbowl
                        </div>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <button class="btn btn-outline-secondary me-2" onclick="refreshData()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                        <button class="btn btn-import" id="importButton" onclick="importDefaultLocations()">
                            <i class="bi bi-cloud-upload-fill"></i> Import to Fishbowl
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5.3 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    let dataset = [];
    let availableLocations = {};  // Cache of locations per location group
    let currentMode = 'default';  // 'default' or 'manual'

    // Load available locations for all location groups
    function loadAvailableLocations() {
        try {
            let query = `SELECT
                lg.id as locationgroupid,
                lg.name as locationgroupname,
                loc.id as locationid,
                loc.name as locationname,
                loc.typeid as locationtype,
                loc.defaultflag as isdefault
            FROM locationgroup lg
            INNER JOIN location loc ON loc.locationgroupid = lg.id
            WHERE lg.activeflag = 1
                AND loc.activeflag = 1
            ORDER BY lg.name, loc.defaultflag DESC, loc.name`;

            let result = JSON.parse(runQuery(query));

            // Organize by location group
            availableLocations = {};
            result.forEach(function(row) {
                if (!availableLocations[row.locationgroupid]) {
                    availableLocations[row.locationgroupid] = {
                        name: row.locationgroupname,
                        locations: []
                    };
                }
                availableLocations[row.locationgroupid].locations.push({
                    id: row.locationid,
                    name: row.locationname,
                    type: row.locationtype,
                    isDefault: row.isdefault === 1,
                    isStock: row.locationtype === 10
                });
            });

            console.log('Loaded locations for', Object.keys(availableLocations).length, 'location groups');
        } catch(e) {
            console.error('Error loading available locations:', e);
        }
    }

    function getData() {
        let query = `SELECT
            part.num as partnum,
            part.id as partid,
            loc.name as location,
            loc.id as locationid,
            locationgroup.name as locationgroup,
            locationgroup.id as locationgroupid
        FROM part
        CROSS JOIN locationgroup
        INNER JOIN location loc ON loc.locationgroupid = locationgroup.id
            AND loc.typeid = 10
            AND loc.defaultflag = 1
        LEFT JOIN defaultlocation ON defaultlocation.partid = part.id
            AND defaultlocation.locationgroupid = locationgroup.id
        WHERE part.typeid = 10
            AND defaultlocation.id IS NULL
            AND locationgroup.activeFlag = 1
        ORDER BY part.num, locationgroup.name`;

        console.log('Executing query:', query);
        let result = JSON.parse(runQuery(query));
        console.log('Query results:', result.length, 'rows');
        return result;
    }

    function setMode(mode) {
        currentMode = mode;

        // Update UI
        document.getElementById('modeDefault').classList.toggle('active', mode === 'default');
        document.getElementById('modeManual').classList.toggle('active', mode === 'manual');
        document.querySelector('input[value="default"]').checked = (mode === 'default');
        document.querySelector('input[value="manual"]').checked = (mode === 'manual');
        document.getElementById('currentMode').textContent = mode === 'default' ? 'Default Locations' : 'Manual Selection';

        // Redraw table with appropriate controls
        drawTable();
    }

    function createLocationDropdown(row) {
        let lgId = row.locationgroupid;
        let lgData = availableLocations[lgId];

        if (!lgData) {
            return `<select class="location-select" disabled><option>No locations available</option></select>`;
        }

        let options = lgData.locations.map(function(loc) {
            let label = loc.name;
            if (loc.isDefault && loc.isStock) {
                label += ' (Default Stock)';
            } else if (loc.isStock) {
                label += ' (Stock)';
            }

            let selected = loc.name === row.location ? 'selected' : '';
            return `<option value="${loc.name}" ${selected}>${label}</option>`;
        }).join('');

        return `<select class="location-select" onchange="updateLocation(this, '${row.partnum}', '${row.locationgroup}')">${options}</select>`;
    }

    function updateLocation(selectElement, partnum, locationgroup) {
        let newLocation = selectElement.value;

        // Update the dataset
        let item = dataset.find(function(row) {
            return row.partnum === partnum && row.locationgroup === locationgroup;
        });

        if (item) {
            item.location = newLocation;
            console.log('Updated', partnum, 'in', locationgroup, 'to location:', newLocation);
            updateStats();
        }
    }

    function drawTable() {
        let tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';

        if (dataset.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="3" class="text-center text-muted py-5">
                        <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                        <div class="mt-3">No parts found that need default locations</div>
                        <div class="small">All parts already have default locations configured</div>
                    </td>
                </tr>
            `;
            return;
        }

        dataset.forEach(function(row) {
            let tr = document.createElement('tr');

            // Part Number
            let tdPart = document.createElement('td');
            tdPart.innerHTML = `<span class="part-number">${row.partnum}</span>`;
            tr.appendChild(tdPart);

            // Location (editable in manual mode)
            let tdLocation = document.createElement('td');
            if (currentMode === 'manual') {
                tdLocation.innerHTML = createLocationDropdown(row);
            } else {
                tdLocation.innerHTML = `<span class="badge bg-primary">${row.location}</span>`;
            }
            tr.appendChild(tdLocation);

            // Location Group
            let tdGroup = document.createElement('td');
            tdGroup.textContent = row.locationgroup;
            tr.appendChild(tdGroup);

            tbody.appendChild(tr);
        });

        updateStats();
    }

    function updateStats() {
        document.getElementById('recordCount').textContent = dataset.length;
        document.getElementById('readyCount').textContent = dataset.length;

        // Count unique location groups
        let uniqueGroups = new Set(dataset.map(function(row) { return row.locationgroup; }));
        document.getElementById('locationGroupCount').textContent = uniqueGroups.size;
    }

    function showStatus(message, type) {
        const statusDiv = document.getElementById('statusMessage');
        statusDiv.style.display = 'block';

        let iconClass = '';
        let alertClass = '';

        if (type === 'success') {
            iconClass = 'bi-check-circle-fill';
            alertClass = 'alert-success alert-custom';
        } else if (type === 'error') {
            iconClass = 'bi-exclamation-triangle-fill';
            alertClass = 'alert-danger alert-custom';
        } else if (type === 'info') {
            iconClass = 'bi-info-circle-fill';
            alertClass = 'alert-info alert-custom';
        }

        statusDiv.className = `alert ${alertClass} mb-4`;
        statusDiv.innerHTML = `<i class="bi ${iconClass} me-2"></i>${message}`;

        // Auto-hide success messages after 5 seconds
        if (type === 'success') {
            setTimeout(function() {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // Scroll to top to show message
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function refreshData() {
        dataset = getData();
        drawTable();
        showStatus('Data refreshed successfully', 'success');
    }

    function importDefaultLocations() {
        const button = document.getElementById('importButton');

        if (dataset.length === 0) {
            showStatus('No records to import! All parts already have default locations configured.', 'error');
            return;
        }

        // Disable button during import
        button.disabled = true;
        button.innerHTML = '<i class="bi bi-hourglass-split"></i> Importing...';
        showStatus('Preparing import data...', 'info');

        try {
            // Build rows array in the format expected by Fishbowl API
            let rows = [
                '"partnum","location","locationgroup"'
            ];

            dataset.forEach(function(row) {
                rows.push(
                    '"' + row.partnum + '",' +
                    '"' + row.location + '",' +
                    '"' + row.locationgroup + '"'
                );
            });

            // Build API request payload
            let payload = {
                "ImportRq": {
                    "Type": "ImportDefaultLocations",
                    "Rows": {
                        "Row": rows
                    }
                }
            };

            console.log('Import Request:', payload);
            showStatus(`Importing ${dataset.length} default locations to Fishbowl...`, 'info');

            // Call the Fishbowl API
            let response = runApiRequest('ImportRq', JSON.stringify(payload));
            console.log('Import Response (raw):', response);

            if (!response) {
                showStatus('Import failed: No response from API. Please check your connection to Fishbowl.', 'error');
                button.disabled = false;
                button.innerHTML = '<i class="bi bi-cloud-upload-fill"></i> Import to Fishbowl';
                return;
            }

            // Parse response
            let result = typeof response === 'string' ? JSON.parse(response) : response;
            console.log('Import Result (parsed):', result);

            // Check for success
            if (result && result.ImportRs && result.ImportRs.statusCode === 1000) {
                showStatus(
                    `<strong>Success!</strong> Successfully imported ${dataset.length} default locations to Fishbowl. ` +
                    `<button class="btn btn-sm btn-light ms-3" onclick="refreshData()">Refresh Data</button>`,
                    'success'
                );

                // Refresh the table after successful import
                setTimeout(function() {
                    refreshData();
                }, 3000);
            } else {
                let errorMsg = '<strong>Import Failed</strong><br>';
                let statusMessage = '';

                if (result && result.ImportRs && result.ImportRs.statusMessage) {
                    statusMessage = result.ImportRs.statusMessage;
                    errorMsg += statusMessage;
                } else if (result && result.ErrorRs && result.ErrorRs.statusMessage) {
                    statusMessage = result.ErrorRs.statusMessage;
                    errorMsg += statusMessage;
                } else {
                    errorMsg += 'Unknown error: ' + JSON.stringify(result);
                }

                // Try to extract line number from error message
                let lineNumberMatch = statusMessage.match(/Line Number:\s*(\d+)/i);
                if (lineNumberMatch && lineNumberMatch[1]) {
                    let csvLineNum = parseInt(lineNumberMatch[1]);
                    let arrayIndex = csvLineNum - 1;

                    if (arrayIndex >= 0 && arrayIndex < rows.length) {
                        console.error('Error on CSV line ' + csvLineNum + ': ' + rows[arrayIndex]);

                        let contextStart = Math.max(0, arrayIndex - 2);
                        let contextEnd = Math.min(rows.length - 1, arrayIndex + 2);

                        errorMsg += '<div class="mt-3"><strong>CSV Context:</strong><pre class="bg-dark text-light p-3 rounded mt-2" style="font-size: 0.875rem;">';
                        for (let i = contextStart; i <= contextEnd; i++) {
                            let prefix = i === arrayIndex ? '>>> ' : '    ';
                            let color = i === arrayIndex ? 'color: #ff6b6b; font-weight: bold;' : '';
                            errorMsg += `<div style="${color}">${prefix}Line ${i + 1}: ${rows[i]}</div>`;
                        }
                        errorMsg += '</pre></div>';
                    }
                }

                showStatus(errorMsg, 'error');
            }

        } catch (error) {
            console.error('Error during import:', error);
            showStatus('<strong>Import Error:</strong> ' + error.message, 'error');
        } finally {
            // Re-enable button
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-cloud-upload-fill"></i> Import to Fishbowl';
        }
    }

    // Initialize on page load
    window.addEventListener('DOMContentLoaded', function() {
        loadAvailableLocations();
        dataset = getData();
        drawTable();
    });

    const displayHeader = typeof $CHECK !== 'undefined' ? $CHECK{Display_header|true} : true;
    </script>
</body>
</html>