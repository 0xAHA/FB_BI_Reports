<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manufacturing Capacity Planning (beta)</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- Moment.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Gantt Chart Styles */
        .wo-bar { cursor: move; transition: opacity 0.2s; }
        .wo-bar:hover { opacity: 0.9; }
        .wo-bar.dragging { opacity: 0.6; }

        .dependency-arrow { pointer-events: none; }
        .dependency-arrow.conflict { stroke: #ef4444; }

        /* Capacity Table */
        .capacity-table-wrapper {
            cursor: grab;
            user-select: none;
        }
        .capacity-table-wrapper:active { cursor: grabbing; }

        .capacity-wo-bar {
            cursor: move;
            transition: transform 0.2s;
        }
        .capacity-wo-bar:hover {
            transform: translateY(-2px);
        }

        /* Toast Container */
        .toast-container {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .toast {
            min-width: 300px;
            padding: 1rem;
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border-left: 4px solid;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toast.success { border-color: #10b981; }
        .toast.error { border-color: #ef4444; }
        .toast.info { border-color: #6366f1; }

        /* Modal/Offcanvas */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9998;
            display: none;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.show { display: block; }

        .offcanvas {
            position: fixed;
            top: 0;
            right: -500px;
            width: 500px;
            height: 100%;
            background: white;
            z-index: 9999;
            transition: right 0.3s ease-out;
            box-shadow: -10px 0 25px rgba(0, 0, 0, 0.1);
        }

        .offcanvas.show { right: 0; }

        /* Loading Spinner */
        .spinner {
            border: 3px solid #e2e8f0;
            border-top-color: #6366f1;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Sidebar transition */
        .sidebar-collapsed { width: 5rem; }
        .sidebar-expanded { width: 16rem; }
    </style>
</head>
<body class="bg-slate-50">
    <!-- Toast Container -->
    <div class="toast-container"></div>

    <!-- Modal Overlay -->
    <div class="modal-overlay" id="modalOverlay"></div>

    <!-- Settings Offcanvas -->
    <div class="offcanvas custom-scrollbar" id="settingsOffcanvas">
        <div class="h-full flex flex-col">
            <div class="flex items-center justify-between p-6 border-b border-slate-200">
                <h2 class="text-xl font-bold text-slate-800">Settings</h2>
                <button onclick="closeOffcanvas('settingsOffcanvas')" class="p-2 hover:bg-slate-100 rounded-lg transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-6 space-y-6">
                <div class="space-y-4">
                    <h3 class="text-sm font-bold text-slate-700 uppercase tracking-wider">Schedule Options</h3>
                    <label class="flex items-center justify-between p-4 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100 transition-colors">
                        <span class="text-sm font-medium text-slate-700">Skip Weekends</span>
                        <input type="checkbox" id="skipWeekendsToggle" checked class="w-5 h-5 text-indigo-600 rounded">
                    </label>
                    <label class="flex items-center justify-between p-4 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100 transition-colors">
                        <span class="text-sm font-medium text-slate-700">Allow Same-Day Dependency Starts</span>
                        <input type="checkbox" id="sameDayStartsToggle" class="w-5 h-5 text-indigo-600 rounded">
                    </label>
                </div>

                <div class="space-y-4">
                    <h3 class="text-sm font-bold text-slate-700 uppercase tracking-wider">Display</h3>
                    <label class="flex items-center justify-between p-4 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100 transition-colors">
                        <span class="text-sm font-medium text-slate-700">Show Dependency Arrows</span>
                        <input type="checkbox" id="showArrowsToggle" checked class="w-5 h-5 text-indigo-600 rounded">
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Instructions Offcanvas -->
    <div class="offcanvas custom-scrollbar" id="instructionsOffcanvas">
        <div class="h-full flex flex-col">
            <div class="flex items-center justify-between p-6 border-b border-slate-200">
                <h2 class="text-xl font-bold text-slate-800">Instructions</h2>
                <button onclick="closeOffcanvas('instructionsOffcanvas')" class="p-2 hover:bg-slate-100 rounded-lg transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-6 space-y-6">
                <div class="space-y-3">
                    <h3 class="text-sm font-bold text-slate-700 uppercase tracking-wider">About This Tool</h3>
                    <p class="text-sm text-slate-600 leading-relaxed">Manufacturing Capacity Planning (beta) provides three interactive views for visualizing and managing work order schedules:</p>
                    <ul class="text-sm text-slate-600 space-y-2 ml-4">
                        <li class="flex items-start gap-2">
                            <span class="text-indigo-600 mt-1">•</span>
                            <span><strong>MO Gantt View:</strong> Groups work orders by Manufacturing Order</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="text-indigo-600 mt-1">•</span>
                            <span><strong>Category View:</strong> Groups work orders by manufacturing category (swim lanes)</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="text-indigo-600 mt-1">•</span>
                            <span><strong>Capacity Planning:</strong> Weekly calendar view with drag-and-drop scheduling and capacity tracking</span>
                        </li>
                    </ul>
                </div>

                <div class="space-y-3">
                    <h3 class="text-sm font-bold text-slate-700 uppercase tracking-wider">MO Gantt & Category Views</h3>
                    <ul class="text-sm text-slate-600 space-y-2 ml-4">
                        <li class="flex items-start gap-2">
                            <span class="text-indigo-600 mt-1">•</span>
                            <span><strong>Drag WO:</strong> Click and drag work order bars to reschedule</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="text-indigo-600 mt-1">•</span>
                            <span><strong>Resize WO:</strong> Drag left/right edge to adjust dates</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="text-indigo-600 mt-1">•</span>
                            <span><strong>Navigate:</strong> Scroll or drag the timeline</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="text-indigo-600 mt-1">•</span>
                            <span><strong>Zoom:</strong> Use zoom buttons or scroll wheel</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="text-indigo-600 mt-1">•</span>
                            <span><strong>Undo/Redo:</strong> Use toolbar buttons (50-step history)</span>
                        </li>
                    </ul>
                </div>

                <div class="space-y-3">
                    <h3 class="text-sm font-bold text-slate-700 uppercase tracking-wider">Capacity Planning View</h3>
                    <ul class="text-sm text-slate-600 space-y-2 ml-4">
                        <li class="flex items-start gap-2">
                            <span class="text-indigo-600 mt-1">•</span>
                            <span><strong>Navigate Weeks:</strong> Click Week buttons or drag the table</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="text-indigo-600 mt-1">•</span>
                            <span><strong>Drag WO:</strong> Drag and drop work orders between days/categories</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="text-indigo-600 mt-1">•</span>
                            <span><strong>Adjust Capacity:</strong> Click gear icon to set daily labor hours</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="h-screen flex overflow-hidden">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar-expanded bg-slate-900 text-white flex flex-col transition-all duration-300 shadow-2xl border-r border-slate-800 flex-shrink-0">
            <div class="p-6 flex items-center justify-between border-b border-white/5 h-20">
                <div class="flex items-center gap-3 sidebar-title">
                    <div class="p-2 bg-indigo-600 rounded-lg">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-base font-bold leading-none tracking-tight">CapacityPro</h1>
                        <span class="text-[10px] text-slate-400 uppercase tracking-widest">Analytics</span>
                    </div>
                </div>
                <button onclick="toggleSidebar()" class="p-1.5 hover:bg-white/10 rounded-lg text-slate-400 hover:text-white transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
            </div>

            <nav class="flex-1 p-4 space-y-1 overflow-y-auto mt-4 custom-scrollbar">
                <button onclick="switchView('mo')" id="nav-mo" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium transition-all bg-indigo-600 text-white shadow-lg shadow-indigo-900/20">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    <span class="sidebar-text">MO Gantt</span>
                </button>

                <button onclick="switchView('category')" id="nav-category" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium transition-all text-slate-400 hover:bg-slate-800 hover:text-slate-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"></path>
                    </svg>
                    <span class="sidebar-text">Category View</span>
                </button>

                <button onclick="switchView('capacity')" id="nav-capacity" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium transition-all text-slate-400 hover:bg-slate-800 hover:text-slate-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <span class="sidebar-text">Capacity Planning</span>
                </button>
            </nav>

            <div class="p-4 border-t border-white/5">
                <div class="bg-slate-800/50 rounded-xl p-4 sidebar-status">
                    <div class="flex items-center gap-2 text-xs font-semibold text-indigo-300 mb-2">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0"></path>
                        </svg>
                        System Status
                    </div>
                    <div class="text-[10px] text-slate-400">Bridge Connected</div>
                    <div class="text-[10px] text-slate-400 mt-1">v3.0.0 Beta</div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col min-w-0 h-screen overflow-hidden bg-slate-50">
            <!-- Header -->
            <header class="h-20 bg-white border-b border-slate-200 px-8 flex items-center justify-between flex-shrink-0 z-20 shadow-sm">
                <div class="flex items-center gap-6 flex-1">
                    <h2 id="viewTitle" class="text-xl font-bold text-slate-800 hidden md:block">MO Gantt View</h2>
                    <div class="h-6 w-px bg-slate-200 hidden md:block"></div>
                    <div class="relative w-full max-w-md group">
                        <svg class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-indigo-600 transition-colors w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <input
                            type="text"
                            id="searchInput"
                            placeholder="Search work orders..."
                            class="w-full bg-slate-50 border-none rounded-xl py-2.5 pl-10 pr-4 text-sm font-medium focus:bg-white focus:ring-2 focus:ring-indigo-100 transition-all outline-none text-slate-600"
                        />
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="openOffcanvas('settingsOffcanvas')" class="p-2.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-xl transition-all" title="Settings">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                    </button>
                    <button onclick="openOffcanvas('instructionsOffcanvas')" class="p-2.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-xl transition-all" title="Instructions">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                        </svg>
                    </button>
                    <button onclick="loadWorkOrders()" id="refreshBtn" class="p-2.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-xl transition-all" title="Refresh Data">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                    </button>
                    <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-700 font-bold text-xs border border-indigo-200 shadow-sm">
                        FB
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <div class="flex-1 overflow-y-auto custom-scrollbar p-4 lg:p-8 space-y-8">
                <!-- KPI Cards -->
                <div id="kpiCards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- Will be populated dynamically -->
                </div>

                <!-- Gantt/Category View Container -->
                <div id="ganttContainer" class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
                        <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                            <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            <span id="ganttTitle">Production Schedule</span>
                        </h3>

                        <div class="flex items-center gap-2">
                            <!-- MO Filter (shown in MO view) -->
                            <div id="moFilterContainer" class="flex items-center gap-2 bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-200">
                                <svg class="w-3.5 h-3.5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                                </svg>
                                <select id="moFilter" class="bg-transparent border-none text-xs font-semibold text-slate-600 outline-none cursor-pointer">
                                    <option value="all">All MOs</option>
                                </select>
                            </div>

                            <!-- Zoom Controls -->
                            <div class="flex items-center gap-1 bg-slate-50 px-2 py-1.5 rounded-lg border border-slate-200">
                                <button onclick="zoomOut()" class="p-1 hover:bg-white rounded transition-colors text-slate-600" title="Zoom Out">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7"></path>
                                    </svg>
                                </button>
                                <button onclick="zoomIn()" class="p-1 hover:bg-white rounded transition-colors text-slate-600" title="Zoom In">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path>
                                    </svg>
                                </button>
                            </div>

                            <!-- Undo/Redo -->
                            <div class="flex items-center gap-1 bg-slate-50 px-2 py-1.5 rounded-lg border border-slate-200">
                                <button id="undoBtn" onclick="undo()" disabled class="p-1 hover:bg-white rounded transition-colors text-slate-600 disabled:opacity-30 disabled:cursor-not-allowed" title="Undo">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
                                    </svg>
                                </button>
                                <button id="redoBtn" onclick="redo()" disabled class="p-1 hover:bg-white rounded transition-colors text-slate-600 disabled:opacity-30 disabled:cursor-not-allowed" title="Redo">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 10h-10a8 8 0 00-8 8v2m18-10l-6-6m6 6l-6 6"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Gantt Chart SVG -->
                    <div id="ganttWrapper" class="overflow-x-auto custom-scrollbar">
                        <svg id="ganttSvg" class="w-full"></svg>
                    </div>
                </div>

                <!-- Capacity Planning View Container -->
                <div id="capacityContainer" style="display: none;">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-slate-800">Weekly Capacity Planning</h3>
                            <div class="flex items-center gap-2">
                                <button onclick="changeCapacityWeek(-1)" class="px-3 py-2 bg-slate-50 hover:bg-slate-100 border border-slate-200 rounded-lg text-sm font-medium transition-colors">
                                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path>
                                    </svg>
                                    Week
                                </button>
                                <span id="capacityWeekDisplay" class="text-sm font-semibold text-slate-600 px-4"></span>
                                <button onclick="changeCapacityWeek(1)" class="px-3 py-2 bg-slate-50 hover:bg-slate-100 border border-slate-200 rounded-lg text-sm font-medium transition-colors">
                                    Week
                                    <svg class="w-4 h-4 inline ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <div class="capacity-table-wrapper overflow-auto custom-scrollbar" style="max-height: 800px;">
                            <table id="capacityTable" class="w-full border-collapse">
                                <!-- Will be populated dynamically -->
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

<script>
// ============================================
// GLOBAL VARIABLES
// ============================================
let allWorkOrders = [];
let filteredWorkOrders = [];
let manufacturingOrders = [];
let categories = [];
let stagingDependencies = [];
let conflicts = new Set();

let viewMode = 'mo'; // 'mo', 'category', 'capacity'
let currentCapacityWeek = null;
let capacitySettings = { categories: [] };

// Undo/Redo
let undoStack = [];
let redoStack = [];
const MAX_UNDO_STACK = 50;

// D3 Gantt Settings
let ganttScale = 80; // pixels per day
let ganttStartDate = moment().startOf('isoWeek');
let ganttEndDate = moment().startOf('isoWeek').add(14, 'days');

// Settings
let skipWeekends = true;
let allowSameDayStarts = false;
let showArrows = true;

// ============================================
// UTILITY FUNCTIONS
// ============================================
function debugLog(type, message, ...args) {
    const timestamp = moment().format('HH:mm:ss.SSS');
    const prefix = `[${timestamp}] [${type.toUpperCase()}]`;
    console.log(prefix, message, ...args);
}

function showToast(message, type = 'info', duration = 3000) {
    const container = document.querySelector('.toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;

    const icon = type === 'success' ? '✓' : type === 'error' ? '✕' : 'ℹ';
    toast.innerHTML = `
        <div class="flex items-center gap-3">
            <span class="text-lg">${icon}</span>
            <span class="text-sm font-medium text-slate-700">${message}</span>
        </div>
    `;

    container.appendChild(toast);

    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
    }, duration);
}

function openOffcanvas(id) {
    document.getElementById('modalOverlay').classList.add('show');
    document.getElementById(id).classList.add('show');
}

function closeOffcanvas(id) {
    document.getElementById('modalOverlay').classList.remove('show');
    document.getElementById(id).classList.remove('show');
}

// Close offcanvas on overlay click
document.getElementById('modalOverlay').addEventListener('click', () => {
    document.querySelectorAll('.offcanvas').forEach(el => el.classList.remove('show'));
    document.getElementById('modalOverlay').classList.remove('show');
});

function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.toggle('sidebar-collapsed');
    sidebar.classList.toggle('sidebar-expanded');

    // Hide text when collapsed
    const texts = sidebar.querySelectorAll('.sidebar-text');
    const title = sidebar.querySelector('.sidebar-title');
    const status = sidebar.querySelector('.sidebar-status');

    if (sidebar.classList.contains('sidebar-collapsed')) {
        texts.forEach(t => t.style.display = 'none');
        title.style.display = 'none';
        if (status) status.style.display = 'none';
    } else {
        texts.forEach(t => t.style.display = '');
        title.style.display = '';
        if (status) status.style.display = '';
    }
}

// ============================================
// DATA LOADING (Fishbowl API)
// ============================================
async function loadWorkOrders() {
    debugLog('info', 'Loading work orders from Fishbowl...');
    document.getElementById('refreshBtn').style.opacity = '0.5';

    try {
        // Simulate Fishbowl API call (replace with actual implementation)
        const query = `
            SELECT
                wo.id AS wo_id,
                wo.num AS wo_num,
                wo.statusId AS wo_status,
                status.name AS wo_status_name,
                wo.dateScheduledToStart AS date_scheduled_start,
                wo.dateScheduled AS date_scheduled,
                wo.dateFinished AS date_finished,
                mo.num AS mo_num,
                mo.dateScheduled AS mo_date_scheduled,
                cat.name AS category_name,
                cat.color AS category_color,
                wo.qtyTarget AS qty_target
            FROM wo
            JOIN status ON wo.statusId = status.id
            LEFT JOIN mo ON wo.moId = mo.id
            LEFT JOIN part ON wo.partId = part.id
            LEFT JOIN manufacturingcategory cat ON part.partTypeId = cat.id
            WHERE wo.statusId IN (10, 20, 30, 40)
            ORDER BY wo.dateScheduledToStart ASC
        `;

        // Mock data for now
        allWorkOrders = generateMockData();

        // Extract unique MOs and categories
        const uniqueMOs = [...new Set(allWorkOrders.map(wo => wo.mo_num))].sort();
        manufacturingOrders = uniqueMOs.map(mo => ({ mo_num: mo }));

        const catMap = new Map();
        allWorkOrders.forEach(wo => {
            if (wo.category_name && !catMap.has(wo.category_name)) {
                catMap.set(wo.category_name, {
                    name: wo.category_name,
                    color: wo.category_color || '#6366f1'
                });
            }
        });
        categories = Array.from(catMap.values());

        // Load dependencies (mock)
        stagingDependencies = [];

        filteredWorkOrders = [...allWorkOrders];

        updateMOFilter();
        updateKPIs();
        renderCurrentView();

        showToast('Data loaded successfully', 'success');
    } catch (error) {
        debugLog('error', 'Failed to load work orders', error);
        showToast('Failed to load data: ' + error.message, 'error');
    } finally {
        document.getElementById('refreshBtn').style.opacity = '1';
    }
}

function generateMockData() {
    const statuses = [
        { id: 10, name: 'Entered' },
        { id: 20, name: 'In Progress' },
        { id: 40, name: 'Fulfilled' }
    ];

    const categories = [
        { name: 'Fabrication', color: '#3b82f6' },
        { name: 'Machining', color: '#10b981' },
        { name: 'Assembly', color: '#f59e0b' },
        { name: 'Quality Control', color: '#8b5cf6' }
    ];

    const mockWOs = [];
    const today = moment();

    for (let i = 1; i <= 20; i++) {
        const mo = `MO-${1000 + Math.floor(i / 3)}`;
        const cat = categories[i % categories.length];
        const status = statuses[i % statuses.length];
        const startOffset = Math.floor(i / 2) - 5;
        const duration = 2 + (i % 4);

        mockWOs.push({
            wo_id: i,
            wo_num: `WO-${2000 + i}`,
            wo_status: status.id,
            wo_status_name: status.name,
            date_scheduled_start: today.clone().add(startOffset, 'days').format('YYYY-MM-DD[T]08:00:00'),
            date_scheduled: today.clone().add(startOffset + duration, 'days').format('YYYY-MM-DD[T]17:00:00'),
            date_finished: status.id === 40 ? today.clone().add(startOffset + duration - 1, 'days').format('YYYY-MM-DD[T]15:00:00') : null,
            mo_num: mo,
            mo_date_scheduled: today.clone().add(startOffset + duration + 2, 'days').format('YYYY-MM-DD[T]17:00:00'),
            category_name: cat.name,
            category_color: cat.color,
            qty_target: 100
        });
    }

    return mockWOs;
}

function updateMOFilter() {
    const select = document.getElementById('moFilter');
    select.innerHTML = '<option value="all">All MOs</option>';

    const uniqueMOs = [...new Set(allWorkOrders.map(wo => wo.mo_num))].sort();
    uniqueMOs.forEach(mo => {
        const option = document.createElement('option');
        option.value = mo;
        option.textContent = mo;
        select.appendChild(option);
    });
}

// ============================================
// KPI DASHBOARD
// ============================================
function updateKPIs() {
    const container = document.getElementById('kpiCards');

    const activeJobs = filteredWorkOrders.filter(wo => wo.wo_status === 20).length;
    const plannedJobs = filteredWorkOrders.filter(wo => wo.wo_status === 10).length;
    const fulfilledJobs = filteredWorkOrders.filter(wo => wo.wo_status === 40).length;
    const totalJobs = filteredWorkOrders.length;

    const kpis = [
        {
            title: 'Active Jobs',
            value: activeJobs,
            color: 'indigo',
            icon: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>`
        },
        {
            title: 'Planned',
            value: plannedJobs,
            color: 'amber',
            icon: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>`
        },
        {
            title: 'Fulfilled',
            value: fulfilledJobs,
            color: 'emerald',
            icon: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>`
        },
        {
            title: 'Total Jobs',
            value: totalJobs,
            color: 'slate',
            icon: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>`
        }
    ];

    const colorClasses = {
        indigo: 'bg-indigo-50 text-indigo-600',
        emerald: 'bg-emerald-50 text-emerald-600',
        amber: 'bg-amber-50 text-amber-600',
        slate: 'bg-slate-50 text-slate-600',
        rose: 'bg-rose-50 text-rose-600'
    };

    container.innerHTML = kpis.map(kpi => `
        <div class="bg-white rounded-xl p-5 shadow-sm border border-slate-100 flex items-start justify-between">
            <div>
                <p class="text-slate-500 text-xs font-semibold uppercase tracking-wider mb-1">${kpi.title}</p>
                <h3 class="text-2xl font-bold text-slate-800">${kpi.value}</h3>
            </div>
            <div class="${colorClasses[kpi.color]} p-3 rounded-xl">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    ${kpi.icon}
                </svg>
            </div>
        </div>
    `).join('');
}

// ============================================
// VIEW SWITCHING
// ============================================
function switchView(mode) {
    viewMode = mode;

    // Update navigation
    document.querySelectorAll('.nav-item').forEach(btn => {
        btn.classList.remove('bg-indigo-600', 'text-white', 'shadow-lg', 'shadow-indigo-900/20');
        btn.classList.add('text-slate-400', 'hover:bg-slate-800', 'hover:text-slate-200');
    });

    const activeBtn = document.getElementById(`nav-${mode}`);
    activeBtn.classList.remove('text-slate-400', 'hover:bg-slate-800', 'hover:text-slate-200');
    activeBtn.classList.add('bg-indigo-600', 'text-white', 'shadow-lg', 'shadow-indigo-900/20');

    // Update view title
    const titles = {
        mo: 'MO Gantt View',
        category: 'Category View',
        capacity: 'Capacity Planning'
    };
    document.getElementById('viewTitle').textContent = titles[mode];

    // Show/hide appropriate containers
    if (mode === 'capacity') {
        document.getElementById('ganttContainer').style.display = 'none';
        document.getElementById('capacityContainer').style.display = 'block';
        document.getElementById('moFilterContainer').style.display = 'none';

        if (!currentCapacityWeek) {
            currentCapacityWeek = moment().startOf('isoWeek');
        }
        buildCapacityTable(currentCapacityWeek);
    } else {
        document.getElementById('ganttContainer').style.display = 'block';
        document.getElementById('capacityContainer').style.display = 'none';
        document.getElementById('moFilterContainer').style.display = mode === 'mo' ? 'flex' : 'none';

        renderGanttChart();
    }
}

function renderCurrentView() {
    if (viewMode === 'capacity') {
        if (currentCapacityWeek) {
            buildCapacityTable(currentCapacityWeek);
        }
    } else {
        renderGanttChart();
    }
}

// ============================================
// CUSTOM D3 GANTT CHART
// ============================================
function renderGanttChart() {
    debugLog('info', `Rendering ${viewMode} Gantt chart...`);

    const svg = d3.select('#ganttSvg');
    svg.selectAll('*').remove();

    if (filteredWorkOrders.length === 0) {
        svg.append('text')
            .attr('x', '50%')
            .attr('y', 100)
            .attr('text-anchor', 'middle')
            .attr('class', 'text-slate-400 text-sm')
            .text('No work orders to display');
        return;
    }

    // Dimensions
    const margin = { top: 60, right: 40, bottom: 40, left: 200 };
    const dayWidth = ganttScale;
    const days = moment(ganttEndDate).diff(ganttStartDate, 'days') + 1;
    const width = days * dayWidth + margin.left + margin.right;
    const rowHeight = 50;

    // Build groups based on view mode
    let groups = [];
    if (viewMode === 'mo') {
        const moNums = [...new Set(filteredWorkOrders.map(wo => wo.mo_num))].sort();
        groups = moNums.map(mo => ({
            id: mo,
            name: mo,
            wos: filteredWorkOrders.filter(wo => wo.mo_num === mo)
        }));
    } else {
        const catNames = [...new Set(filteredWorkOrders.map(wo => wo.category_name))].sort();
        groups = catNames.map(cat => ({
            id: cat,
            name: cat,
            color: filteredWorkOrders.find(wo => wo.category_name === cat)?.category_color || '#6366f1',
            wos: filteredWorkOrders.filter(wo => wo.category_name === cat)
        }));
    }

    const height = groups.length * rowHeight + margin.top + margin.bottom;

    svg.attr('width', width).attr('height', height);

    // Scales
    const xScale = d3.scaleTime()
        .domain([ganttStartDate.toDate(), ganttEndDate.toDate()])
        .range([margin.left, width - margin.right]);

    const yScale = d3.scaleBand()
        .domain(groups.map(g => g.id))
        .range([margin.top, height - margin.bottom])
        .padding(0.2);

    // Grid lines (vertical days)
    const gridGroup = svg.append('g').attr('class', 'grid');
    let currentDay = ganttStartDate.clone();
    while (currentDay.isSameOrBefore(ganttEndDate)) {
        gridGroup.append('line')
            .attr('x1', xScale(currentDay.toDate()))
            .attr('x2', xScale(currentDay.toDate()))
            .attr('y1', margin.top)
            .attr('y2', height - margin.bottom)
            .attr('stroke', '#f1f5f9')
            .attr('stroke-width', 1);
        currentDay.add(1, 'day');
    }

    // Today marker
    const todayX = xScale(moment().toDate());
    if (todayX >= margin.left && todayX <= width - margin.right) {
        svg.append('line')
            .attr('x1', todayX)
            .attr('x2', todayX)
            .attr('y1', margin.top)
            .attr('y2', height - margin.bottom)
            .attr('stroke', '#ef4444')
            .attr('stroke-width', 2)
            .attr('stroke-dasharray', '5,5');
    }

    // Row backgrounds
    svg.selectAll('.row-bg')
        .data(groups)
        .enter()
        .append('rect')
        .attr('class', 'row-bg')
        .attr('x', margin.left)
        .attr('y', d => yScale(d.id))
        .attr('width', width - margin.left - margin.right)
        .attr('height', yScale.bandwidth())
        .attr('fill', '#ffffff')
        .attr('rx', 4);

    // Group labels
    svg.selectAll('.group-label')
        .data(groups)
        .enter()
        .append('text')
        .attr('class', 'group-label')
        .attr('x', margin.left - 10)
        .attr('y', d => yScale(d.id) + yScale.bandwidth() / 2)
        .attr('text-anchor', 'end')
        .attr('alignment-baseline', 'middle')
        .attr('font-size', '13px')
        .attr('font-weight', '600')
        .attr('fill', '#334155')
        .text(d => d.name);

    // Date header
    const headerGroup = svg.append('g').attr('transform', `translate(0, ${margin.top - 10})`);
    currentDay = ganttStartDate.clone();
    while (currentDay.isSameOrBefore(ganttEndDate)) {
        headerGroup.append('text')
            .attr('x', xScale(currentDay.toDate()) + dayWidth / 2)
            .attr('y', -20)
            .attr('text-anchor', 'middle')
            .attr('font-size', '11px')
            .attr('font-weight', '600')
            .attr('fill', '#64748b')
            .text(currentDay.format('ddd D'));

        currentDay.add(1, 'day');
    }

    // WO Bars
    groups.forEach(group => {
        group.wos.forEach(wo => {
            const start = moment(wo.date_scheduled_start);
            const end = moment(wo.date_scheduled);

            const x = xScale(start.toDate());
            const barWidth = Math.max(10, xScale(end.toDate()) - x);
            const y = yScale(group.id);
            const barHeight = yScale.bandwidth();

            const statusColors = {
                10: { fill: '#e0e7ff', stroke: '#6366f1' },
                20: { fill: '#6366f1', stroke: '#4f46e5' },
                40: { fill: '#10b981', stroke: '#059669' }
            };

            const colors = statusColors[wo.wo_status] || statusColors[10];

            // Bar
            const bar = svg.append('rect')
                .attr('class', 'wo-bar')
                .attr('x', x)
                .attr('y', y)
                .attr('width', barWidth)
                .attr('height', barHeight)
                .attr('rx', 6)
                .attr('fill', colors.fill)
                .attr('stroke', colors.stroke)
                .attr('stroke-width', 2)
                .attr('data-wo-id', wo.wo_id)
                .style('filter', 'drop-shadow(0 2px 4px rgba(0,0,0,0.1))')
                .style('cursor', 'move');

            // Label
            svg.append('text')
                .attr('x', x + 8)
                .attr('y', y + barHeight / 2)
                .attr('alignment-baseline', 'middle')
                .attr('font-size', '11px')
                .attr('font-weight', '600')
                .attr('fill', wo.wo_status === 20 ? '#ffffff' : '#334155')
                .attr('pointer-events', 'none')
                .text(wo.wo_num);
        });
    });

    debugLog('success', `Gantt chart rendered with ${filteredWorkOrders.length} WOs`);
}

// ============================================
// ZOOM CONTROLS
// ============================================
function zoomIn() {
    ganttScale = Math.min(200, ganttScale + 20);
    renderGanttChart();
}

function zoomOut() {
    ganttScale = Math.max(40, ganttScale - 20);
    renderGanttChart();
}

// ============================================
// CAPACITY PLANNING VIEW
// ============================================
function buildCapacityTable(weekStart) {
    debugLog('info', 'Building capacity table...');
    // Placeholder - will implement full capacity table
    const container = document.getElementById('capacityTable');
    container.innerHTML = `
        <thead>
            <tr class="bg-slate-50">
                <th class="p-4 text-left font-semibold text-slate-700">Category</th>
                ${[0,1,2,3,4,5,6].map(day => `
                    <th class="p-4 text-center font-semibold text-slate-700">
                        ${weekStart.clone().add(day, 'days').format('ddd D')}
                    </th>
                `).join('')}
            </tr>
        </thead>
        <tbody>
            <tr>
                <td colspan="8" class="p-8 text-center text-slate-400">
                    Capacity planning table coming soon...
                </td>
            </tr>
        </tbody>
    `;

    const display = document.getElementById('capacityWeekDisplay');
    display.textContent = `${weekStart.format('MMM D')} - ${weekStart.clone().add(6, 'days').format('MMM D, YYYY')}`;
}

function changeCapacityWeek(direction) {
    currentCapacityWeek = currentCapacityWeek.clone().add(direction, 'weeks');
    buildCapacityTable(currentCapacityWeek);
}

// ============================================
// UNDO/REDO
// ============================================
function undo() {
    if (undoStack.length === 0) return;
    const state = undoStack.pop();
    redoStack.push(captureState());
    restoreState(state);
    updateUndoRedoButtons();
}

function redo() {
    if (redoStack.length === 0) return;
    const state = redoStack.pop();
    undoStack.push(captureState());
    restoreState(state);
    updateUndoRedoButtons();
}

function captureState() {
    return JSON.stringify(allWorkOrders);
}

function restoreState(state) {
    allWorkOrders = JSON.parse(state);
    filteredWorkOrders = [...allWorkOrders];
    renderCurrentView();
}

function updateUndoRedoButtons() {
    document.getElementById('undoBtn').disabled = undoStack.length === 0;
    document.getElementById('redoBtn').disabled = redoStack.length === 0;
}

// ============================================
// FILTERS
// ============================================
document.getElementById('moFilter').addEventListener('change', (e) => {
    const moNum = e.target.value;
    if (moNum === 'all') {
        filteredWorkOrders = [...allWorkOrders];
    } else {
        filteredWorkOrders = allWorkOrders.filter(wo => wo.mo_num === moNum);
    }
    updateKPIs();
    renderGanttChart();
});

document.getElementById('searchInput').addEventListener('input', (e) => {
    const term = e.target.value.toLowerCase();
    if (!term) {
        filteredWorkOrders = [...allWorkOrders];
    } else {
        filteredWorkOrders = allWorkOrders.filter(wo =>
            wo.wo_num.toLowerCase().includes(term) ||
            wo.mo_num.toLowerCase().includes(term) ||
            (wo.category_name && wo.category_name.toLowerCase().includes(term))
        );
    }
    updateKPIs();
    renderCurrentView();
});

// ============================================
// SETTINGS
// ============================================
document.getElementById('skipWeekendsToggle').addEventListener('change', (e) => {
    skipWeekends = e.target.checked;
});

document.getElementById('sameDayStartsToggle').addEventListener('change', (e) => {
    allowSameDayStarts = e.target.checked;
});

document.getElementById('showArrowsToggle').addEventListener('change', (e) => {
    showArrows = e.target.checked;
    renderGanttChart();
});

// ============================================
// INITIALIZATION
// ============================================
window.addEventListener('DOMContentLoaded', () => {
    debugLog('info', 'Application starting...');
    loadWorkOrders();
});
</script>
</body>
</html>
