<!DOCTYPE html>
<html lang="en">
<head>
    <!-- DataTables CDN Links (previously from Template) -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs4-4.1.1/jq-3.3.1/jszip-2.5.0/dt-1.10.20/b-1.6.1/b-colvis-1.6.1/b-html5-1.6.1/b-print-1.6.1/cr-1.5.2/fh-3.1.6/r-2.2.3/sc-2.0.1/datatables.min.css"/>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/v/bs4-4.1.1/jq-3.3.1/jszip-2.5.0/dt-1.10.20/b-1.6.1/b-colvis-1.6.1/b-html5-1.6.1/b-print-1.6.1/cr-1.5.2/fh-3.1.6/r-2.2.3/sc-2.0.1/datatables.min.js"></script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Reorder Monitor</title>
    <style>
        /* Print Landscape Styles */
        @media print {
            html, body {
                height: 100%;
                width: 100%;
                margin: 0;
                padding: 0;
                overflow: hidden;
            }
            #button {
                display: none !important;
            }
            @page {
                size: Letter landscape;
            }
        }

        /* Main Inventory Watch List Styles */
        .dot {
            height: 20px;
            width: 20px;
            border-radius: 50%;
            display: inline-block;
        }
        .fb10 {
            background-color: #28a745 !important;
            z-index: 99;
        }
        .fb20 {
            background-color: #ffc107;
            z-index: 99;
        }
        .fb30 {
            background-color: #dc3545;
            z-index: 99;
        }
        tr > td.stateText {
            color: rgba(0,0,0,0);
            font-size: 1px;
            text-align: center;
        }
        optgroup {
            background: #d3d3d3;
        }
        .selector {
            width: 100%;
            margin-bottom: 5px;
        }
        .csv-button-margin {
            margin-bottom: 10px;
        }
        body {
            height: 100%;
            font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
            margin: 15px;
            padding: 0;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: #f1f1f1;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
            z-index: 9999;
        }

        .show {
            display: block;
        }
        div.love-on-top {
            z-index: 2;
            position: relative;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            padding-top: 100px;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0, 0, 0);
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            width: 80%;
        }

        .close {
            color: #aaaaaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }

        div.columnWrapper {
            position: relative;
            float: left;
            margin: 5px;
            text-align: center;
            display: inline-block;
        }
        div.columnWrapper:hover img {
            opacity: 0.5;
        }
        div.columnWrapper:hover button {
            display: block;
        }
        div.columnWrapper button {
            position: absolute;
            display: none;
        }
        div.columnWrapper button.delete {
            top: 1px;
            left: 83%;
            background: lightgray;
            opacity: 0.5;
            text-align: center;
        }
        div.columnWrapper button.delete:hover {
            background: gray;
        }

        .hide-button {
            float: right;
            margin-top: -13px;
            font-size: 11px;
            font-family: helvetica;
            color: gray;
        }
        input.columnTitle {
            margin: 3px;
            text-align: center;
            width: 75%;
        }
        div.columnPreview {
            display: inline-block;
            min-width: 50px;
            overflow: stretch;
        }
        div.inline {
            margin-right: 10px;
            display: inline-block;
            margin-bottom: 15px;
            vertical-align: top;
        }
        div.header {
            margin-top: 20px;
        }
        .overflowHidden {
            overflow: hidden;
        }

        #chartContainer {
            position: relative;
            height: 85%;
            width: 100vw;
            padding-top: 20px;
        }

        @media (max-height: 450px) {
            #chartContainer {
                height: 75%;
            }
        }

        @media (max-height: 300px) {
            #chartContainer {
                height: 70%;
            }
        }

        #title {
            font-size: 24px;
        }

        #headerContainer {
            text-align: center;
        }

        .wrapper {
            position: relative;
        }
        div.button-wrapper {
            text-align: center;
        }
        div.column-preview-body {
            height: 105px;
        }
        .scrolling {
            overflow: auto;
            white-space: nowrap;
        }

        /* DataTables Base Styles */
        table.dataTable {
            width: 100%;
            margin: 0 auto;
            clear: both;
            border-collapse: separate;
            border-spacing: 0;
        }
        table.dataTable thead th,
        table.dataTable tfoot th {
            font-weight: bold;
        }
        table.dataTable thead th,
        table.dataTable thead td {
            padding: 10px 18px;
            border-bottom: 1px solid #111111;
            background-color: #eaeaea;
            font-size: 14px;
        }
        table.dataTable thead th:active,
        table.dataTable thead td:active {
            outline: none;
        }
        table.dataTable tfoot th,
        table.dataTable tfoot td {
            padding: 10px 18px 6px 18px;
            border-top: 1px solid #111111;
        }
        table.dataTable thead .sorting,
        table.dataTable thead .sorting_asc,
        table.dataTable thead .sorting_desc,
        table.dataTable thead .sorting_asc_disabled,
        table.dataTable thead .sorting_desc_disabled {
            cursor: pointer;
            background-repeat: no-repeat;
            background-position: center right;
        }
        table.dataTable tbody tr {
            background-color: white;
            font-size: 13px;
        }
        table.dataTable tbody tr.selected {
            background-color: #b0bed9;
        }
        table.dataTable tbody th,
        table.dataTable tbody td {
            padding: 8px 10px;
        }
        table.dataTable.row-border tbody th,
        table.dataTable.row-border tbody td,
        table.dataTable.display tbody th,
        table.dataTable.display tbody td {
            border-top: 1px solid #dddddd;
        }
        table.dataTable.row-border tbody tr:first-child th,
        table.dataTable.row-border tbody tr:first-child td,
        table.dataTable.display tbody tr:first-child th,
        table.dataTable.display tbody tr:first-child td {
            border-top: none;
        }
        table.dataTable.stripe tbody tr.odd,
        table.dataTable.display tbody tr.odd {
            background-color: #f9f9f9;
        }
        table.dataTable.hover tbody tr:hover,
        table.dataTable.display tbody tr:hover {
            background-color: whitesmoke;
        }
        table.dataTable.no-footer {
            border-bottom: 1px solid #111111;
        }
        table.dataTable.nowrap th,
        table.dataTable.nowrap td {
            white-space: nowrap;
        }
        table.dataTable th.dt-left,
        table.dataTable td.dt-left {
            text-align: left;
        }
        table.dataTable th.dt-center,
        table.dataTable td.dt-center,
        table.dataTable td.dataTables_empty {
            text-align: center;
        }
        table.dataTable th.dt-right,
        table.dataTable td.dt-right {
            text-align: right;
        }

        table.dataTable,
        table.dataTable th,
        table.dataTable td {
            box-sizing: content-box;
        }

        /* DataTables Wrapper */
        .dataTables_wrapper {
            position: relative;
            clear: both;
            zoom: 1;
        }
        .dataTables_wrapper .dataTables_length {
            float: left;
        }
        .dataTables_wrapper .dataTables_filter {
            float: right;
        }
        .dataTables_wrapper .dataTables_filter input {
            margin-left: 0.5em;
        }
        .dataTables_wrapper .dataTables_info {
            clear: both;
            float: left;
            padding-top: 0.755em;
        }
        .dataTables_wrapper .dataTables_paginate {
            float: right;
            text-align: right;
            padding-top: 0.25em;
        }
        .dataTables_wrapper .dataTables_paginate .paginate_button {
            box-sizing: border-box;
            display: inline-block;
            min-width: 1.5em;
            margin-left: 2px;
            text-align: center;
            text-decoration: none !important;
            cursor: pointer;
            color: #333333 !important;
            border: 1px solid transparent;
            border-radius: 2px;
        }
        .dataTables_wrapper .dataTables_paginate .paginate_button.current,
        .dataTables_wrapper .dataTables_paginate .paginate_button.current:hover {
            color: #333333 !important;
            border: 1px solid #979797;
            background-color: white;
            background: linear-gradient(to bottom, white 0%, gainsboro 100%);
        }
        .dataTables_wrapper .dataTables_paginate .paginate_button.disabled,
        .dataTables_wrapper .dataTables_paginate .paginate_button.disabled:hover,
        .dataTables_wrapper .dataTables_paginate .paginate_button.disabled:active {
            cursor: default;
            color: #666 !important;
            border: 1px solid transparent;
            background: transparent;
            box-shadow: none;
        }
        .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
            color: white !important;
            border: 1px solid #d9d9d9;
            background: linear-gradient(to bottom, white 0%, #d9d9d9 100%);
        }
        .dataTables_wrapper .dataTables_paginate .paginate_button:active {
            outline: none;
            background: linear-gradient(to bottom, #f3f3f3 0%, #d4d4d4 100%);
            box-shadow: inset 0 0 3px #111;
        }
        .dataTables_wrapper .dataTables_paginate .ellipsis {
            padding: 0 1em;
        }
        .dataTables_wrapper .dataTables_length,
        .dataTables_wrapper .dataTables_filter,
        .dataTables_wrapper .dataTables_info,
        .dataTables_wrapper .dataTables_processing,
        .dataTables_wrapper .dataTables_paginate {
            color: #333333;
        }
        .dataTables_wrapper .dataTables_scroll {
            clear: both;
        }
        .dataTables_wrapper.no-footer .dataTables_scrollBody {
            border-bottom: 1px solid #111111;
        }
        .dataTables_wrapper:after {
            visibility: hidden;
            display: block;
            content: "";
            clear: both;
            height: 0;
        }

        @media screen and (max-width: 767px) {
            .dataTables_wrapper .dataTables_info,
            .dataTables_wrapper .dataTables_paginate {
                float: none;
                text-align: center;
            }
            .dataTables_wrapper .dataTables_paginate {
                margin-top: 0.5em;
            }
        }
        @media screen and (max-width: 640px) {
            .dataTables_wrapper .dataTables_length,
            .dataTables_wrapper .dataTables_filter {
                float: none;
                text-align: center;
            }
            .dataTables_wrapper .dataTables_filter {
                margin-top: 0.5em;
            }
        }

        /* Custom Overrides */
        table.dataTable {
            width: 100% !important;
            table-layout: fixed;
        }
        table.dataTable thead th.dt-center,
        table.dataTable thead td.dt-center {
            text-align: center;
        }
        table.dataTable tbody td.dt-center {
            text-align: center;
        }
        table.dataTable tbody td {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Column Grouping Styles */
        .group-status {
            background-color: #f0f4f8 !important;
            border-right: 2px solid #d0d9e0;
        }
        table.dataTable thead th.group-status {
            background-color: #e3eaf1 !important;
            font-weight: bold;
            text-align: center !important;
        }

        .group-part-info {
            background-color: #f8f8f8 !important;
            border-right: 2px solid #d8d8d8;
        }
        table.dataTable thead th.group-part-info {
            background-color: #ebebeb !important;
            font-weight: bold;
            text-align: center !important;
        }

        .group-inventory-key {
            background-color: #fef9f0 !important;
            border-right: 2px solid #e8d9c0;
        }
        table.dataTable thead th.group-inventory-key {
            background-color: #f5ebd8 !important;
            font-weight: bold;
            text-align: center !important;
        }

        .group-reorder-params {
            background-color: #f0f7f0 !important;
            border-right: 2px solid #d5e5d5;
        }
        table.dataTable thead th.group-reorder-params {
            background-color: #e3f0e3 !important;
            font-weight: bold;
            text-align: center !important;
        }

        .group-allocation {
            background-color: #f7f3f8 !important;
        }
        table.dataTable thead th.group-allocation {
            background-color: #ebe5ed !important;
            font-weight: bold;
            text-align: center !important;
        }

        /* Capacity Bar Styles */
        .capacity-bar-container {
            width: 100%;
            height: 24px;
            position: relative;
            background: linear-gradient(to right,
                #ffebee 0%, #ffebee 10%,
                #e8f5e9 10%, #e8f5e9 90%,
                #e3f2fd 90%, #e3f2fd 100%);
            border: 1px solid #ccc;
            border-radius: 3px;
            margin: 2px 0;
        }
        .capacity-bar-track {
            position: absolute;
            top: 50%;
            left: 10%;
            right: 10%;
            height: 4px;
            background-color: #666;
            transform: translateY(-50%);
        }
        .capacity-tick {
            position: absolute;
            width: 2px;
            height: 16px;
            background-color: #333;
            top: 50%;
            transform: translate(-50%, -50%);
        }
        .capacity-marker {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #ff5722;
            border: 2px solid #fff;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            box-shadow: 0 0 3px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>
    <div class="overflowHidden" style="position: relative; height: 100%; width: 100%">
        <div id="headerContainer" style="float: left;">
            <h1>Inventory Reorder Monitor</h1>
        </div>
        <div id="bodyContainer">
            <div id="body">

            <table id=report-table class='display' style='width:100%'></table>
            </div>
        </div>
    </div>
    <script>
    let partNum = '$PART{Part|%|General}';
    if (!partNum || partNum == '' || partNum == -1 || partNum == 'EFT') {
        partNum = '%';
    }
    
    let vendorId = '$VEND{Vendor|%|General}';
    vendorId == -1 ? (vendorId = '%') : true;
    if (!vendorId || vendorId == '' || vendorId == '%') {
        vendorId = '%';
    }
    
    
    let locationGroupId = '$LG{Location_Group|%|General}';
    locationGroupId == -1 ? (locationGroupId = '%') : true;
    let user = JSON.parse(getUser());
    let currentUser = user.id;

    // Filter checkboxes
    const hideOverstocked = $CHECK{Hide_Overstocked|false};
    const hideAdequate = $CHECK{Hide_Adequately_Stocked|false};
    const hideApproaching = $CHECK{Hide_Approaching_Reorder|false};

    let dataset;
    
    function monitor() {
      function getData() {
        let query = `SELECT
          base.refresh,
          base.partid,
          base.partnum,
          base.partdescription,
          base.vendorname,
          base.locationgroup,
          base.uom,
          base.reorderpoint,
          base.orderuptolevel,
          base.onhand,
          base.available,
          base.committed,
          base.allocated,
          base.\`not available\`,
          base.\`on order\`,

          GREATEST(0, base.orderuptolevel - (base.available - base.committed)) as recommendedorderqty,

          -- Capacity % with division-by-zero protection
          CASE
            WHEN base.orderuptolevel = base.reorderpoint THEN
              CASE
                WHEN base.available > base.orderuptolevel THEN 150
                WHEN base.available = base.orderuptolevel THEN 100
                ELSE 0
              END
            ELSE
              ROUND(
                ((base.available - base.reorderpoint) / (base.orderuptolevel - base.reorderpoint)) * 100,
                1
              )
          END as capacitypct,

         (CASE
              WHEN base.available > base.orderuptolevel THEN 'fb10'
              WHEN base.available < base.reorderpoint THEN 'fb40'
              WHEN base.available >= base.reorderpoint
                   AND base.available <= (base.reorderpoint + (0.2 * (base.orderuptolevel - base.reorderpoint))) THEN 'fb30'
              ELSE 'fb20'
          END) as state,
          (CASE
            WHEN base.available > base.orderuptolevel THEN '4-Overstocked'
            WHEN base.available < base.reorderpoint THEN '1-Critical'
            WHEN base.available >= base.reorderpoint
                 AND base.available <= (base.reorderpoint + (0.2 * (base.orderuptolevel - base.reorderpoint))) THEN '2-Alert'
            ELSE '3-Good'
        END) as statetext

        FROM (
          SELECT
            COALESCE((SELECT (sysvalue) * 1000 FROM sysproperties WHERE syskey = 'Refresh Rate'),300000) as refresh,
            part.id as partid,
            part.num as partnum,
            part.description as partdescription,
            COALESCE(vendor.name,'No Default Vendor') as vendorname,
            COALESCE(locationgroup.name,'Company Wide') as locationgroup,
            coalesce(uom.code,'') as uom,
            partreorder.reorderpoint as reorderpoint,
            partreorder.orderuptolevel as orderuptolevel,

            (CASE WHEN partreorder.locationgroupid IS NOT NULL THEN coalesce(qtyonhand.qty,0) ELSE coalesce(totals.qtyonhand, 0) END) as onhand,

            (CASE WHEN partreorder.locationgroupid IS NOT NULL
              THEN coalesce(IF(coalesce(qtyonhand.qty,0) - coalesce(qtyallocated.qty,0) - coalesce(qtynotavailable.qty,0) + coalesce(qtydropship.qty,0) < 0,0,coalesce(qtyonhand.qty,0) - coalesce(qtyallocated.qty,0) - coalesce(qtynotavailable.qty,0) + coalesce(qtydropship.qty,0)),0)
              ELSE coalesce(totals.qtyavailable, 0)
            END) as available,

            (CASE WHEN partreorder.locationgroupid IS NOT NULL THEN coalesce(qtycommitted.qty,0) ELSE coalesce((SELECT sum(qty) FROM qtycommitted qtyc WHERE qtyc.partid = part.id GROUP BY partid),0) END) as committed,
            (CASE WHEN partreorder.locationgroupid IS NOT NULL THEN coalesce(qtyallocated.qty,0) ELSE coalesce(totals.qtyallocated, 0) END) as allocated,
            (CASE WHEN partreorder.locationgroupid IS NOT NULL THEN coalesce(qtynotavailable.qty,0) ELSE coalesce(totals.qtynotavailable, 0) END) as \`not available\`,
            (CASE WHEN partreorder.locationgroupid IS NOT NULL THEN coalesce(qtyonorder.qty,0) ELSE coalesce(totals.qtyonorder, 0) END) as \`on order\`

          FROM partreorder

            INNER JOIN part ON partreorder.partid = part.id
            INNER JOIN uom ON part.uomid = uom.id
            LEFT OUTER JOIN vendorparts ON (part.id = vendorparts.partid AND vendorparts.defaultflag = 1)
            LEFT OUTER JOIN vendor ON vendorparts.vendorid = vendor.id
            LEFT OUTER JOIN locationgroup ON partreorder.locationgroupid = locationgroup.id
            left outer join qtyonhand on (part.id = qtyonhand.partid and locationgroup.id = qtyonhand.locationgroupid)
            left outer join qtycommitted on (part.id = qtycommitted.partid and locationgroup.id = qtycommitted.locationgroupid)
            left outer join qtyallocated on (part.id = qtyallocated.partid and locationgroup.id = qtyallocated.locationgroupid)
            left outer join qtyonorder on (part.id = qtyonorder.partid and locationgroup.id = qtyonorder.locationgroupid)
            left outer join qtynotavailable on (part.id = qtynotavailable.partid and locationgroup.id = qtynotavailable.locationgroupid)
            left outer join qtydropship on (part.id = qtydropship.partid and locationgroup.id = qtydropship.locationgroupid)
            left outer join (select coalesce(sum(qti.qtyonhand),0) as qtyonhand,
                        coalesce(sum(qti.qtyallocated),0) as qtyallocated,
                        coalesce(sum(qti.qtyonorder),0) as qtyonorder,
                        if(coalesce((sum(qti.qtyonhand) - sum(qti.qtyallocated) - sum(qti.qtynotavailable) + sum(qti.qtydropship)),0) < 0,0,coalesce((sum(qti.qtyonhand) - sum(qti.qtyallocated) - sum(qti.qtynotavailable) + sum(qti.qtydropship)),0)) as qtyavailable,
                        coalesce(sum(qti.qtynotavailable),0) as qtynotavailable,
                        coalesce(sum(qti.qtydropship),0) as qtydropship, qti.partid
                    from qtyinventorytotals qti
                    group by qti.partid) as totals on part.id = totals.partid

          WHERE part.id LIKE '${partNum}'
                  AND COALESCE(locationgroup.id,'') LIKE '${locationGroupId}'
                  AND ('${vendorId}' = '%' OR vendor.id = '${vendorId}')
                  AND partreorder.reorderpoint IS NOT NULL
                  AND partreorder.orderuptolevel IS NOT NULL
                  AND partreorder.reorderpoint > 0
                  AND partreorder.orderuptolevel > 0
        ) as base
        ORDER BY
                CASE WHEN base.vendorname = 'No Default Vendor' THEN 1 ELSE 0 END,
                base.vendorname,
                (CASE
                  WHEN base.available > base.orderuptolevel THEN 'fb10'
                  WHEN base.available < base.reorderpoint THEN 'fb40'
                  WHEN base.available >= base.reorderpoint
                       AND base.available <= (base.reorderpoint + (0.2 * (base.orderuptolevel - base.reorderpoint))) THEN 'fb30'
                  ELSE 'fb20'
                END) DESC,
                base.partnum`;
    
        console.log(query);
        let dataset = JSON.parse(runQuery(query));
        console.log(dataset);
        return dataset;
      }
    
      function applyFilters(data) {
        return data.filter(function(row) {
          // Overstocked: state === 'fb10' or capacity > 100
          if (hideOverstocked && (row.state === 'fb10' || row.capacitypct > 100)) {
            return false;
          }

          // Adequately stocked: capacity > 20 (but not overstocked)
          if (hideAdequate && row.capacitypct > 20 && row.state !== 'fb10' && row.capacitypct <= 100) {
            return false;
          }

          // Approaching reorder point: capacity 0-20%
          if (hideApproaching && row.capacitypct >= 0 && row.capacitypct <= 20) {
            return false;
          }

          return true;
        });
      }

      function drawTable() {
        dataset = getData();

        // Apply filters
        let filteredData = applyFilters(dataset);

        // Insert vendor header rows
        let groupedData = [];
        let currentVendor = null;


        let vendorFilter = $('#vendorFilter').val()?.toLowerCase() || '';
        groupedData = groupedData.filter(row => {
          if (row.isVendorHeader) return true;
          return row.vendorname?.toLowerCase().includes(vendorFilter);
        });


        filteredData.forEach(function(row) {
          if (row.vendorname !== currentVendor) {
            currentVendor = row.vendorname;
            groupedData.push({
              isVendorHeader: true,
              vendorname: currentVendor
            });
          }
          groupedData.push(row);
        });
    
        let table = $('#report-table');
        table.empty();
        
        $(window).on('resize scroll', function() {
          table.columns.adjust();
        });
        
        table.DataTable({
          dom: 'B<"clear">lfrtip',
          data: groupedData,
          ordering: false,
          autoWidth: false,
          pageLength: 100,
          columns: [
            {
              title: '<span title="Vendor grouping indicator">',
              data: 'vendorname',
              defaultContent: '',
              width: '1%',
              render: function(data, type, row) {
                if (row.isVendorHeader) return data;
                return '';
              },
              createdCell: function(td, cellData, rowData, row, col) {
                if (rowData.isVendorHeader) {
                  $(td).attr('colspan', 15);
                  $(td).css({
                    'background-color': '#e8e8e8',
                    'font-weight': 'bold',
                    'padding': '8px 10px',
                    'font-size': '13px',
                    'border-top': '2px solid #ccc'
                  });
                  $(td).html('&#x1F4E6; ' + rowData.vendorname);
                  $(td).nextAll().remove();
                } else {
                  $(td).css({
                    'padding': '2px',
                    'width': '1%',
                    'max-width': '10px'
                  });
                }
              }
            },
            {
              title: '<span title="Visual indicator of inventory status: Critical (red), Alert (orange), Good (green), or Overstocked (blue)">State</span>',
              data: 'statetext',
              defaultContent: '',
              className: 'stateText dt-center group-status',
              width: '4%',
              createdCell: function(td, cellData, rowData, row, col) {
                if (rowData.isVendorHeader) return;
                let statecircle = document.createElement('div');
                console.log(statecircle);
                statecircle.setAttribute('partid', rowData.partid);
                td.append(statecircle);
                statecircle.classList.add(rowData.state);
                statecircle.classList.add('dot');
                // Add inline colors for all states to ensure they display
                if (rowData.state === 'fb40') {
                  statecircle.style.backgroundColor = 'red';
                } else if (rowData.state === 'fb30') {
                  statecircle.style.backgroundColor = 'orange';
                } else if (rowData.state === 'fb20') {
                  statecircle.style.backgroundColor = 'green';
                } else if (rowData.state === 'fb10') {
                  statecircle.style.backgroundColor = 'blue';
                }
              }
            },
            {
              title: '<span title="Percentage of inventory capacity: (Available - Reorder Point) / (Order Up To - Reorder Point) Ã— 100">Capacity %</span>',
              data: 'capacitypct',
              defaultContent: '',
              className: 'dt-center group-status',
              width: '12%',
              render: function(data, type, row) {
                if (row.isVendorHeader) return '';
                if (type === 'display') {
                  // Calculate marker position (10% to 90% represents 0% to 100% capacity)
                  let markerPos = 10 + (Math.max(0, Math.min(100, data)) * 0.8);

                  // Determine text and color
                  let text, color;
                  if (row.state === 'fb10' || data > 100) {
                    text = 'Overstocked';
                    color = 'blue';
                    markerPos = Math.min(95, 10 + (data * 0.8)); // Can go beyond 90%
                  } else if (data < 0) {
                    text = data + '%';
                    color = 'red';
                    markerPos = Math.max(5, 10 + (data * 0.8)); // Can go below 10%
                  } else {
                    text = data + '%';
                    color = data <= 20 ? 'orange' : 'green';
                  }

                  return '<div style="display: flex; flex-direction: column; align-items: center;">' +
                    '<span style="color: ' + color + '; font-size: 11px; font-weight: bold; margin-bottom: 2px;">' + text + '</span>' +
                    '<div class="capacity-bar-container">' +
                      '<div class="capacity-bar-track"></div>' +
                      '<div class="capacity-tick" style="left: 10%;"></div>' +  // Reorder Point (0%)
                      '<div class="capacity-tick" style="left: 90%;"></div>' +  // Order Up To (100%)
                      '<div class="capacity-marker" style="left: ' + markerPos + '%;"></div>' +  // Available marker
                    '</div>' +
                    '</div>';
                }
                return data;
              }
            },
            {
              title: '<span title="Unique part identifier/SKU">Part Number</span>',
              data: 'partnum',
              defaultContent: '',
              width: '8%',
              className: 'group-part-info',
              render: function(data, type, row) {
                if (row.isVendorHeader) return '';
                if (type === 'display') {
                  return '<strong>' + data + '</strong>';
                }
                return data;
              }
            },
            {
              title: '<span title="Descriptive name of the part">Part Description</span>',
              data: 'partdescription',
              defaultContent: '',
              width: '15%',
              className: 'group-part-info',
              render: function(data, type, row) {
                if (row.isVendorHeader) return '';
                if (type === 'display') {
                  return '<strong>' + data + '</strong>';
                }
                return data;
              }
            },
            { title: '<span title="Unit of Measure for quantity tracking">UOM</span>', data: 'uom', defaultContent: '', width: '4%', className: 'dt-center group-part-info' },
            { title: '<span title="Total physical quantity currently in stock">On Hand</span>', data: 'onhand', defaultContent: '', width: '6%', className: 'dt-center group-inventory-key' },
            { title: '<span title="Quantity available for use: On Hand - Allocated - Not Available + Dropship">Available</span>', data: 'available', defaultContent: '', width: '6%', className: 'dt-center group-inventory-key' },
            {
                      title: '<span title="Recommended quantity to order to reach Order Up To level: Order Up To - (Available - Committed)">Qty to Order</span>',
                      data: 'recommendedorderqty',
                      defaultContent: '',
                      width: '8%',
                      className: 'dt-center group-inventory-key',
                      render: function(data, type, row) {
                        if (row.isVendorHeader) return '';
                        if (type === 'display' && data > 0) {
                          return '<strong>' + data + '</strong>';
                        }
                        return data;
                      }
                    },
            { title: '<span title="Minimum inventory threshold that triggers a reorder alert">Reorder Point</span>', data: 'reorderpoint', defaultContent: '', width: '6%', className: 'dt-center group-reorder-params' },
            { title: '<span title="Target maximum inventory level when reordering">Order Up To</span>', data: 'orderuptolevel', defaultContent: '', width: '6%', className: 'dt-center group-reorder-params' },
            { title: '<span title="Quantity committed to sales orders">Committed</span>', data: 'committed', defaultContent: '', width: '6%', className: 'dt-center group-allocation' },
            { title: '<span title="Quantity allocated for work orders or manufacturing builds">Allocated</span>', data: 'allocated', defaultContent: '', width: '6%', className: 'dt-center group-allocation' },
            { title: '<span title="Quantity on hand but flagged as not available for use">Not Available</span>', data: 'not available', defaultContent: '', width: '6%', className: 'dt-center group-allocation' },
            { title: '<span title="Quantity on purchase orders not yet received">On Order</span>', data: 'on order', defaultContent: '', width: '6%', className: 'dt-center group-allocation' }
          ],
          fixedHeader: true,
          colReorder: false,
          pagingType: 'simple',
          responsive: false,
          deferRender: true,
          buttons: ['csv'],
          language: {
            paginate: {
              previous: 'PREV',
              next: 'NEXT'
            }
          }
        });
      }
    
      function refreshTable() {
        console.time('refreshRate');
        let table = $('#report-table').DataTable();
        dataset = getData();

        // Apply filters
        let filteredData = applyFilters(dataset);





        // Insert vendor header rows
        let groupedData = [];
        let currentVendor = null;

        filteredData.forEach(function(row) {
          if (row.vendorname !== currentVendor) {
            currentVendor = row.vendorname;
            groupedData.push({
              isVendorHeader: true,
              vendorname: currentVendor
            });
          }
          groupedData.push(row);
        });
        
        table.clear();
        
        
    
        table.rows.add(groupedData);
        table.draw(false);
        console.timeEnd('refreshRate');
        setTimeout(refreshTable, dataset[0].refresh);
      }
    
      drawTable();
      $(".dt-buttons").addClass( "csv-button-margin" );
      console.log(dataset[0].refresh);
      setTimeout(refreshTable, dataset[0].refresh);
    }

    $(document).ready(function() {
      monitor();
    });
    const displayHeader = $CHECK{Display_header|true};
    
    let headerContainer = document.getElementById('headerContainer');
    displayHeader ? headerContainer.style.display = 'block' : headerContainer.style.display = 'none';

    </script>
</body>
</html>
