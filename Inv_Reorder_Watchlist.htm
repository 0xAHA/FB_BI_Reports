<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Reorder Monitor - Fishbowl Advanced</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- D3.js v7 -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <!-- DataTables CDN Links -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs4-4.1.1/jq-3.3.1/jszip-2.5.0/dt-1.10.20/b-1.6.1/b-colvis-1.6.1/b-html5-1.6.1/b-print-1.6.1/cr-1.5.2/fh-3.1.6/r-2.2.3/sc-2.0.1/datatables.min.css"/>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/v/bs4-4.1.1/jq-3.3.1/jszip-2.5.0/dt-1.10.20/b-1.6.1/b-colvis-1.6.1/b-html5-1.6.1/b-print-1.6.1/cr-1.5.2/fh-3.1.6/r-2.2.3/sc-2.0.1/datatables.min.js"></script>
    <style>
        /* ============================================
           Base Styles (matching Sales Dashboard)
           ============================================ */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        /* Custom Brand Colors (matching Sales Dashboard) */
        :root {
            --color-primary: #2d9cdb;
            --color-primary-dark: #1e7bb4;
            --color-sidebar: #06162d;
            --color-sidebar-hover: #0a1f3d;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Override Tailwind indigo with custom blue */
        .bg-indigo-600 { background-color: var(--color-primary) !important; }
        .bg-indigo-50 { background-color: rgba(45, 156, 219, 0.1) !important; }
        .text-indigo-600 { color: var(--color-primary) !important; }
        .text-indigo-700 { color: var(--color-primary-dark) !important; }
        .border-indigo-200 { border-color: rgba(45, 156, 219, 0.3) !important; }
        .hover\:text-indigo-600:hover { color: var(--color-primary) !important; }
        .hover\:bg-indigo-50:hover { background-color: rgba(45, 156, 219, 0.1) !important; }

        /* ============================================
           DataTables Overrides
           ============================================ */
        table.dataTable {
            table-layout: fixed;
            font-size: 12px;
            border-collapse: separate;
            border-spacing: 0;
        }

        table.dataTable thead th {
            font-size: 12px;
            padding: 12px 8px;
            background-color: #f8f9fa !important;
            color: #475569 !important;
            font-weight: 600;
            border: none;
            border-bottom: 2px solid #e2e8f0;
            text-align: center;
            white-space: normal;
            line-height: 1.3;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        table.dataTable thead th:first-child {
            border-top-left-radius: 0px;
        }

        table.dataTable thead th:last-child {
            border-top-right-radius: 0px;
        }

        table.dataTable tbody td {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 12px;
            padding: 8px;
            border-bottom: 1px solid #e2e8f0;
        }

        /* Center aligned columns */
        table.dataTable tbody td.dt-center {
            text-align: center;
        }

        /* Right aligned columns */
        table.dataTable tbody td.dt-right {
            text-align: right;
        }

        table.dataTable tbody tr {
            background-color: white;
            transition: background-color 0.15s ease;
        }

        table.dataTable tbody tr:hover {
            background-color: #f8fafc;
        }

        /* Vendor Group Header Row */
        .vendor-group-header td {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%) !important;
            font-weight: 700;
            padding: 12px !important;
            font-size: 13px;
            border-top: 2px solid var(--color-primary);
            border-bottom: 1px solid #cbd5e1;
            color: #1e293b;
        }

        /* Clickable Links */
        .item-link {
            color: #2d9cdb;
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }

        .item-link:hover {
            text-decoration: underline;
            color: #1e7bb4;
        }

        /* Expandable Row Styling */
        .expandable-row {
            cursor: pointer;
        }

        .expandable-row:hover {
            background-color: #f0f9ff !important;
        }

        .expand-icon {
            transition: transform 0.2s ease;
            display: inline-block;
        }

        .expand-icon.expanded {
            transform: rotate(90deg);
        }

        /* Location Group Detail Row */
        .location-detail-row td {
            background-color: #f8fafc !important;
            font-size: 11px;
            padding: 4px 8px !important;
            border-bottom: 1px solid #e2e8f0;
        }

        .location-detail-row:last-child td {
            border-bottom: 2px solid #cbd5e1;
        }

        .location-detail-table {
            width: 100%;
            font-size: 11px;
        }

        .location-detail-table th {
            text-align: left;
            font-weight: 600;
            color: #64748b;
            padding: 4px 8px;
            border-bottom: 1px solid #e2e8f0;
        }

        .location-detail-table td {
            padding: 4px 8px;
            border-bottom: 1px solid #f1f5f9;
        }

        /* Column Group Styling */
        .group-status {
            background-color: #e0f2fe !important;
        }

        .group-part-info {
            background-color: #f1f5f9 !important;
        }

        .group-inventory-key {
            background-color: #fef3c7 !important;
        }

        .group-reorder-params {
            background-color: #dcfce7 !important;
        }

        .group-allocation {
            background-color: #fafafa !important;
        }

        /* DataTables Controls */
        .dataTables_wrapper .dataTables_length {
            float: left;
            margin-bottom: 16px;
            font-size: 11px;
        }

        .dataTables_wrapper .dataTables_length select {
            padding: 3px 24px 3px 8px;
            border: 1px solid #cbd5e1;
            border-radius: 3px;
            font-size: 11px;
            margin: 0 4px;
            background-color: white;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23475569' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 6px center;
            background-size: 10px;
            cursor: pointer;
        }

        .dataTables_wrapper .dataTables_length select:focus {
            outline: none;
            border-color: #2d9cdb;
            box-shadow: none;
        }

        .dataTables_wrapper .dataTables_filter {
            float: right;
            margin-bottom: 16px;
            font-size: 11px;
        }

        .dataTables_wrapper .dataTables_filter input {
            margin-left: 8px;
            padding: 3px 8px;
            border: 1px solid #cbd5e1;
            border-radius: 3px;
            font-size: 11px;
            transition: all 0.2s ease;
        }

        .dataTables_wrapper .dataTables_filter input:focus {
            outline: none;
            border-color: #2d9cdb;
            box-shadow: none;
        }

        /* DataTables Buttons */
        .dt-buttons {
            float: right;
            margin-bottom: 16px;
            margin-right: 16px;
        }

        .dt-buttons .dt-button {
            font-size: 11px !important;
            padding: 3px 8px !important;
            margin-left: 8px !important;
            background-color: white !important;
            color: #2d9cdb !important;
            border: 1px solid #cbd5e1 !important;
            border-radius: 3px !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
            font-weight: 500 !important;
            background-image: none !important;
            text-shadow: none !important;
            box-shadow: none !important;
        }

        .dt-buttons .dt-button:hover {
            background-color: #f8fafc !important;
            color: #1e7bb4 !important;
            border-color: #2d9cdb !important;
            box-shadow: none !important;
        }

        .dt-buttons .dt-button:active,
        .dt-buttons .dt-button:focus {
            background-color: #f8fafc !important;
            color: #1e7bb4 !important;
            border-color: #2d9cdb !important;
            box-shadow: none !important;
            outline: none !important;
        }

        /* More specific selectors for DataTables buttons */
        .dt-button.buttons-csv,
        .dt-button.buttons-print,
        a.dt-button.buttons-csv,
        a.dt-button.buttons-print,
        button.dt-button.buttons-csv,
        button.dt-button.buttons-print {
            font-size: 11px !important;
            padding: 3px 8px !important;
            margin-left: 8px !important;
            background-color: white !important;
            color: #2d9cdb !important;
            border: 1px solid #cbd5e1 !important;
            border-radius: 3px !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
            font-weight: 500 !important;
            background-image: none !important;
            text-shadow: none !important;
            box-shadow: none !important;
        }

        .dt-button.buttons-csv:hover,
        .dt-button.buttons-print:hover,
        a.dt-button.buttons-csv:hover,
        a.dt-button.buttons-print:hover,
        button.dt-button.buttons-csv:hover,
        button.dt-button.buttons-print:hover {
            background-color: #f8fafc !important;
            color: #1e7bb4 !important;
            border-color: #2d9cdb !important;
            box-shadow: none !important;
        }

        .dt-button.buttons-csv:active,
        .dt-button.buttons-print:active,
        .dt-button.buttons-csv:focus,
        .dt-button.buttons-print:focus {
            background-color: #f8fafc !important;
            color: #1e7bb4 !important;
            border-color: #2d9cdb !important;
            box-shadow: none !important;
            outline: none !important;
        }

        /* Custom button class */
        .btn-custom-blue {
            font-size: 11px !important;
            padding: 3px 8px !important;
            margin-left: 8px !important;
            background-color: white !important;
            color: #2d9cdb !important;
            border: 1px solid #cbd5e1 !important;
            border-radius: 3px !important;
            cursor: pointer !important;
            font-weight: 500 !important;
            background-image: none !important;
            text-shadow: none !important;
            box-shadow: none !important;
        }

        .btn-custom-blue:hover {
            background-color: #f8fafc !important;
            color: #1e7bb4 !important;
            border-color: #2d9cdb !important;
            box-shadow: none !important;
        }

        /* Hide DataTables buttons (we use custom buttons) */
        .dt-buttons {
            display: none !important;
        }

        .dataTables_wrapper .dataTables_info {
            color: #666;
            font-size: 11px;
        }

        .dataTables_wrapper .dataTables_paginate {
            color: #666;
            font-size: 11px;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button {
            padding: 4px 10px;
            margin-left: 4px;
            border-radius: 3px;
            border: 1px solid #ccc;
            background-color: white;
            color: #333 !important;
            transition: all 0.2s ease;
            font-size: 11px;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
            background-color: #f0f0f0 !important;
            color: #333 !important;
            border-color: #999;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            background-color: #2d9cdb !important;
            color: white !important;
            border-color: #2d9cdb;
        }

        /* ============================================
           Enhanced Print Styles
           ============================================ */
        @media print {
            html, body {
                overflow: visible;
            }

            @page {
                size: A4 landscape;
                margin: 0.5in;
            }

            .dataTables_wrapper .dataTables_length,
            .dataTables_wrapper .dataTables_filter,
            .dataTables_wrapper .dataTables_info,
            .dataTables_wrapper .dataTables_paginate,
            .dataTables_wrapper .dataTables_processing,
            .dt-buttons,
            button,
            .btn,
            header {
                display: none !important;
            }

            #headerContainer h1 {
                font-size: 18pt;
                margin: 0 0 10px 0;
                color: #000;
            }

            table.dataTable {
                width: 100% !important;
                font-size: 7pt;
            }

            table.dataTable thead th {
                background-color: #f8f9fa !important;
                color: #475569 !important;
                font-size: 6.5pt;
                padding: 3px 2px;
                border: 1px solid #ccc;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            table.dataTable tbody td {
                font-size: 7pt;
                padding: 2px 1px;
                border: 1px solid #ccc;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .vendor-group-header td {
                background: linear-gradient(135deg, #e8e8e8 0%, #d0d0d0 100%) !important;
                font-weight: bold;
                font-size: 7.5pt;
                padding: 4px 2px !important;
                border: 1px solid #000 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            table.dataTable tbody tr {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body class="bg-slate-50">
    <div class="flex flex-col h-screen">
        <!-- Header (matching Sales Dashboard) -->
        <header id="headerContainer" class="h-20 bg-white border-b border-slate-200 px-8 flex items-center justify-between flex-shrink-0 z-20 shadow-sm">
            <div class="flex items-center gap-6">
                <div>
                    <h1 class="text-xl font-bold text-slate-900">Inventory Reorder Monitor</h1>
                    <p class="text-xs text-slate-500 mt-0.5">Real-time inventory reorder tracking and capacity monitoring</p>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <!-- Help Button -->
                <button onclick="toggleInstructions()" class="px-3 py-2 bg-slate-100 hover:bg-slate-200 border border-slate-300 rounded-lg text-sm font-medium transition-colors" title="View Usage Guide">
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Help
                </button>

                <!-- Refresh Button -->
                <button onclick="refreshTable()" class="p-2.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-xl transition-all" title="Refresh Data">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                </button>
            </div>
        </header>

        <!-- Content Area -->
        <div class="flex-1 overflow-y-auto custom-scrollbar p-4 lg:p-8">
            <!-- Instructions Panel (hidden by default) -->
            <div id="instructionsPanel" class="bg-white rounded-2xl shadow-md border border-slate-300 p-6 mb-6" style="display: none;">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Usage Guide
                    </h2>
                    <button onclick="toggleInstructions()" class="text-slate-400 hover:text-slate-600 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-sm font-bold text-slate-700 mb-2">Report Purpose</h3>
                        <p class="text-sm text-slate-600 mb-4">This report monitors inventory levels for parts with configured reorder points, displaying current stock status and recommended order quantities to maintain optimal inventory levels.</p>

                        <h3 class="text-sm font-bold text-slate-700 mb-2">Key Metrics</h3>
                        <div class="text-sm text-slate-600 space-y-1">
                            <p><strong>Available:</strong> On Hand - Allocated - Not Available + Dropship</p>
                            <p><strong>Qty to Order:</strong> Order Up To - (Available - Committed)</p>
                            <p><strong>Reorder Point:</strong> Minimum threshold triggering reorder alert</p>
                            <p><strong>Order Up To:</strong> Target maximum inventory level</p>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-sm font-bold text-slate-700 mb-3">Status Indicators</h3>
                        <p class="text-sm text-slate-600 mb-3">The Status column uses color-coded cells with gradient fills representing capacity percentage:</p>
                        <div class="space-y-3">
                            <div class="flex items-center gap-3">
                                <div class="w-20 h-8 rounded flex items-center justify-center text-white text-xs font-semibold" style="background: linear-gradient(to left, #C62828 75%, #EF9A9A 75%); text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">-75%</div>
                                <div class="flex-1 text-xs">
                                    <strong class="text-slate-700">Critical</strong>
                                    <p class="text-slate-500">Below reorder point - fills from right (negative values)</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="w-20 h-8 rounded flex items-center justify-center text-white text-xs font-semibold" style="background: linear-gradient(to right, #F57C00 20%, #FFCC80 20%); text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">20%</div>
                                <div class="flex-1 text-xs">
                                    <strong class="text-slate-700">Alert</strong>
                                    <p class="text-slate-500">Within 20% above reorder point - order soon</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="w-20 h-8 rounded flex items-center justify-center text-white text-xs font-semibold" style="background: linear-gradient(to right, #2E7D32 60%, #A5D6A7 60%); text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">60%</div>
                                <div class="flex-1 text-xs">
                                    <strong class="text-slate-700">Good</strong>
                                    <p class="text-slate-500">Adequate stock levels</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="w-24 h-8 rounded flex items-center justify-center text-white text-xs font-semibold" style="background: #1976D2; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">Overstocked</div>
                                <div class="flex-1 text-xs">
                                    <strong class="text-slate-700">Overstocked</strong>
                                    <p class="text-slate-500">Above order up to level</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Column Filters -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 mb-4">
                <div class="flex flex-wrap gap-3 items-end">
                    <div class="flex-1 min-w-[120px]">
                        <label class="block text-xs font-medium text-slate-600 mb-1">Part Number</label>
                        <input type="text" id="filterPartNum" class="w-full px-2 py-1 text-sm border border-slate-300 rounded" placeholder="Filter..." onkeyup="applyColumnFilters()">
                    </div>
                    <div class="flex-1 min-w-[150px]">
                        <label class="block text-xs font-medium text-slate-600 mb-1">Description</label>
                        <input type="text" id="filterDescription" class="w-full px-2 py-1 text-sm border border-slate-300 rounded" placeholder="Filter..." onkeyup="applyColumnFilters()">
                    </div>
                    <div class="flex-1 min-w-[120px]">
                        <label class="block text-xs font-medium text-slate-600 mb-1">Vendor</label>
                        <input type="text" id="filterVendor" class="w-full px-2 py-1 text-sm border border-slate-300 rounded" placeholder="Filter..." onkeyup="applyColumnFilters()">
                    </div>
                    <div id="locationFilterContainer" class="flex-1 min-w-[140px]" style="display: none;">
                        <label class="block text-xs font-medium text-slate-600 mb-1">Location Group</label>
                        <div class="relative">
                            <button type="button" id="locationFilterBtn" onclick="toggleLocationDropdown()" class="w-full px-2 py-1 text-sm border border-slate-300 rounded bg-white text-left flex justify-between items-center">
                                <span id="locationFilterLabel">All</span>
                                <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>
                            <div id="locationDropdown" class="hidden absolute z-50 mt-1 w-full bg-white border border-slate-300 rounded shadow-lg max-h-48 overflow-y-auto">
                                <!-- Location checkboxes will be populated dynamically -->
                            </div>
                        </div>
                    </div>
                    <div class="flex-1 min-w-[140px]">
                        <label class="block text-xs font-medium text-slate-600 mb-1">Status</label>
                        <div class="relative">
                            <button type="button" id="statusFilterBtn" onclick="toggleStatusDropdown()" class="w-full px-2 py-1 text-sm border border-slate-300 rounded bg-white text-left flex justify-between items-center">
                                <span id="statusFilterLabel">All</span>
                                <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>
                            <div id="statusDropdown" class="hidden absolute z-50 mt-1 w-full bg-white border border-slate-300 rounded shadow-lg">
                                <label class="flex items-center px-2 py-1 hover:bg-slate-50 cursor-pointer text-sm">
                                    <input type="checkbox" value="fb40" class="status-checkbox mr-2" onchange="updateStatusFilter()"> Critical
                                </label>
                                <label class="flex items-center px-2 py-1 hover:bg-slate-50 cursor-pointer text-sm">
                                    <input type="checkbox" value="fb30" class="status-checkbox mr-2" onchange="updateStatusFilter()"> Alert
                                </label>
                                <label class="flex items-center px-2 py-1 hover:bg-slate-50 cursor-pointer text-sm">
                                    <input type="checkbox" value="fb20" class="status-checkbox mr-2" onchange="updateStatusFilter()"> Good
                                </label>
                                <label class="flex items-center px-2 py-1 hover:bg-slate-50 cursor-pointer text-sm">
                                    <input type="checkbox" value="fb10" class="status-checkbox mr-2" onchange="updateStatusFilter()"> Overstocked
                                </label>
                                <label class="flex items-center px-2 py-1 hover:bg-slate-50 cursor-pointer text-sm">
                                    <input type="checkbox" value="norop" class="status-checkbox mr-2" onchange="updateStatusFilter()"> No ROP/OUL
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-1">
                        <button onclick="clearColumnFilters()" class="px-3 py-1 text-sm bg-slate-100 hover:bg-slate-200 text-slate-700 rounded border border-slate-300">Clear</button>
                        <button onclick="exportToCSV()" class="p-1.5 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded border border-slate-300" title="Export CSV">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        </button>
                        <button onclick="printTable()" class="p-1.5 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded border border-slate-300" title="Print">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Table Container -->
            <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                <table id="report-table" class="display" style="width:100%"></table>
            </div>
        </div>
    </div>
    <script>
    let partNum = '$PART{Part|%|General}';
    if (!partNum || partNum == '' || partNum == -1 || partNum == '%') {
        partNum = '%';
    }

    let vendorId = '$VEND{Vendor|%|General}';
    vendorId == -1 ? (vendorId = '%') : true;
    if (!vendorId || vendorId == '' || vendorId == '%') {
        vendorId = '%';
    }


    let locationGroupId = '$LG{Location_Group|%|General}';
    locationGroupId == -1 ? (locationGroupId = '%') : true;
    let user = JSON.parse(getUser());
    let currentUser = user.id;

    // Filter checkboxes
    const hideOverstocked = $CHECK{Hide_Overstocked|false};
    const hideAdequate = $CHECK{Hide_Adequately_Stocked|false};
    const hideApproaching = $CHECK{Hide_Approaching_Reorder|false};
    const includeNoRopOul = $CHECK{Include_No_ROP_OUL|false};

    let dataset;

    function monitor() {
      function getData() {
        let query = `SELECT
          base.refresh,
          base.partid,
          base.partnum,
          base.partdescription,
          base.vendorname,
          base.locationgroupid,
          base.locationgroup,
          base.uom,
          base.reorderpoint,
          base.orderuptolevel,
          base.onhand,
          base.available,
          base.committed,
          base.allocated,
          base.\`not available\`,
          base.\`on order\`,

          CASE
            WHEN base.reorderpoint IS NULL OR base.orderuptolevel IS NULL OR base.reorderpoint = 0 OR base.orderuptolevel = 0 THEN 0
            ELSE GREATEST(0, base.orderuptolevel - (base.available - base.committed))
          END as recommendedorderqty,

          -- Capacity % with division-by-zero protection and no ROP/OUL handling
          -- Negative values are scaled as percentage between 0 and ROP (e.g., ROP=50, available=40 gives -20%)
          CASE
            WHEN base.reorderpoint IS NULL OR base.orderuptolevel IS NULL OR base.reorderpoint = 0 OR base.orderuptolevel = 0 THEN NULL
            WHEN base.orderuptolevel = base.reorderpoint THEN
              CASE
                WHEN base.available > base.orderuptolevel THEN 150
                WHEN base.available = base.orderuptolevel THEN 100
                ELSE ROUND(-1 * ((base.reorderpoint - base.available) / base.reorderpoint) * 100, 1)
              END
            WHEN base.available < base.reorderpoint THEN
              ROUND(-1 * ((base.reorderpoint - base.available) / base.reorderpoint) * 100, 1)
            ELSE
              ROUND(
                ((base.available - base.reorderpoint) / (base.orderuptolevel - base.reorderpoint)) * 100,
                1
              )
          END as capacitypct,

         (CASE
              WHEN base.reorderpoint IS NULL OR base.orderuptolevel IS NULL OR base.reorderpoint = 0 OR base.orderuptolevel = 0 THEN 'norop'
              WHEN base.available > base.orderuptolevel THEN 'fb10'
              WHEN base.available < base.reorderpoint THEN 'fb40'
              WHEN base.available >= base.reorderpoint
                   AND base.available <= (base.reorderpoint + (0.2 * (base.orderuptolevel - base.reorderpoint))) THEN 'fb30'
              ELSE 'fb20'
          END) as state,
          (CASE
            WHEN base.reorderpoint IS NULL OR base.orderuptolevel IS NULL OR base.reorderpoint = 0 OR base.orderuptolevel = 0 THEN '5-No ROP/OUL'
            WHEN base.available > base.orderuptolevel THEN '4-Overstocked'
            WHEN base.available < base.reorderpoint THEN '1-Critical'
            WHEN base.available >= base.reorderpoint
                 AND base.available <= (base.reorderpoint + (0.2 * (base.orderuptolevel - base.reorderpoint))) THEN '2-Alert'
            ELSE '3-Good'
        END) as statetext

        FROM (
          SELECT
            COALESCE((SELECT (sysvalue) * 1000 FROM sysproperties WHERE syskey = 'Refresh Rate'),300000) as refresh,
            part.id as partid,
            part.num as partnum,
            part.description as partdescription,
            COALESCE(vendor.name,'No Default Vendor') as vendorname,
            partreorder.locationgroupid as locationgroupid,
            COALESCE(locationgroup.name,'Company Wide') as locationgroup,
            coalesce(uom.code,'') as uom,
            partreorder.reorderpoint as reorderpoint,
            partreorder.orderuptolevel as orderuptolevel,

            (CASE WHEN partreorder.locationgroupid IS NOT NULL THEN coalesce(qtyonhand.qty,0) ELSE coalesce(totals.qtyonhand, 0) END) as onhand,

            (CASE WHEN partreorder.locationgroupid IS NOT NULL
              THEN coalesce(IF(coalesce(qtyonhand.qty,0) - coalesce(qtyallocated.qty,0) - coalesce(qtynotavailable.qty,0) + coalesce(qtydropship.qty,0) < 0,0,coalesce(qtyonhand.qty,0) - coalesce(qtyallocated.qty,0) - coalesce(qtynotavailable.qty,0) + coalesce(qtydropship.qty,0)),0)
              ELSE coalesce(totals.qtyavailable, 0)
            END) as available,

            (CASE WHEN partreorder.locationgroupid IS NOT NULL THEN coalesce(qtycommitted.qty,0) ELSE coalesce((SELECT sum(qty) FROM qtycommitted qtyc WHERE qtyc.partid = part.id GROUP BY partid),0) END) as committed,
            (CASE WHEN partreorder.locationgroupid IS NOT NULL THEN coalesce(qtyallocated.qty,0) ELSE coalesce(totals.qtyallocated, 0) END) as allocated,
            (CASE WHEN partreorder.locationgroupid IS NOT NULL THEN coalesce(qtynotavailable.qty,0) ELSE coalesce(totals.qtynotavailable, 0) END) as \`not available\`,
            (CASE WHEN partreorder.locationgroupid IS NOT NULL THEN coalesce(qtyonorder.qty,0) ELSE coalesce(totals.qtyonorder, 0) END) as \`on order\`

          FROM part

            INNER JOIN uom ON part.uomid = uom.id
            LEFT OUTER JOIN partreorder ON part.id = partreorder.partid
            LEFT OUTER JOIN vendorparts ON (part.id = vendorparts.partid AND vendorparts.defaultflag = 1)
            LEFT OUTER JOIN vendor ON vendorparts.vendorid = vendor.id
            LEFT OUTER JOIN locationgroup ON partreorder.locationgroupid = locationgroup.id
            left outer join qtyonhand on (part.id = qtyonhand.partid and locationgroup.id = qtyonhand.locationgroupid)
            left outer join qtycommitted on (part.id = qtycommitted.partid and locationgroup.id = qtycommitted.locationgroupid)
            left outer join qtyallocated on (part.id = qtyallocated.partid and locationgroup.id = qtyallocated.locationgroupid)
            left outer join qtyonorder on (part.id = qtyonorder.partid and locationgroup.id = qtyonorder.locationgroupid)
            left outer join qtynotavailable on (part.id = qtynotavailable.partid and locationgroup.id = qtynotavailable.locationgroupid)
            left outer join qtydropship on (part.id = qtydropship.partid and locationgroup.id = qtydropship.locationgroupid)
            left outer join (select coalesce(sum(qti.qtyonhand),0) as qtyonhand,
                        coalesce(sum(qti.qtyallocated),0) as qtyallocated,
                        coalesce(sum(qti.qtyonorder),0) as qtyonorder,
                        if(coalesce((sum(qti.qtyonhand) - sum(qti.qtyallocated) - sum(qti.qtynotavailable) + sum(qti.qtydropship)),0) < 0,0,coalesce((sum(qti.qtyonhand) - sum(qti.qtyallocated) - sum(qti.qtynotavailable) + sum(qti.qtydropship)),0)) as qtyavailable,
                        coalesce(sum(qti.qtynotavailable),0) as qtynotavailable,
                        coalesce(sum(qti.qtydropship),0) as qtydropship, qti.partid
                    from qtyinventorytotals qti
                    group by qti.partid) as totals on part.id = totals.partid

          WHERE part.id LIKE '${partNum}'
                  AND COALESCE(locationgroup.id,'') LIKE '${locationGroupId}'
                  AND ('${vendorId}' = '%' OR vendor.id = '${vendorId}')
                  ${!includeNoRopOul ? `
                  AND partreorder.reorderpoint IS NOT NULL
                  AND partreorder.orderuptolevel IS NOT NULL
                  AND partreorder.reorderpoint > 0
                  AND partreorder.orderuptolevel > 0
                  ` : ''}
        ) as base
        ORDER BY
                CASE WHEN base.vendorname = 'No Default Vendor' THEN 1 ELSE 0 END,
                base.vendorname,
                (CASE
                  WHEN base.reorderpoint IS NULL OR base.orderuptolevel IS NULL OR base.reorderpoint = 0 OR base.orderuptolevel = 0 THEN 'norop'
                  WHEN base.available > base.orderuptolevel THEN 'fb10'
                  WHEN base.available < base.reorderpoint THEN 'fb40'
                  WHEN base.available >= base.reorderpoint
                       AND base.available <= (base.reorderpoint + (0.2 * (base.orderuptolevel - base.reorderpoint))) THEN 'fb30'
                  ELSE 'fb20'
                END) DESC,
                base.partnum`;

        console.log(query);
        let dataset = JSON.parse(runQuery(query));
        console.log(dataset);
        return dataset;
      }

      function applyFilters(data, skipStatusFilter) {
        // Get column filter values
        var filterPartNum = ($('#filterPartNum').val() || '').toLowerCase();
        var filterDescription = ($('#filterDescription').val() || '').toLowerCase();
        var filterVendor = ($('#filterVendor').val() || '').toLowerCase();
        var selectedStatuses = getSelectedStatuses();
        var selectedLocations = getSelectedLocations();

        return data.filter(function(row) {
          // Overstocked: state === 'fb10' or capacity > 100
          if (hideOverstocked && (row.state === 'fb10' || row.capacitypct > 100)) {
            return false;
          }

          // Adequately stocked: capacity > 20 (but not overstocked)
          if (hideAdequate && row.capacitypct > 20 && row.state !== 'fb10' && row.capacitypct <= 100) {
            return false;
          }

          // Approaching reorder point: capacity 0-20%
          if (hideApproaching && row.capacitypct >= 0 && row.capacitypct <= 20) {
            return false;
          }

          // Column filters
          if (filterPartNum && !(row.partnum || '').toLowerCase().includes(filterPartNum)) {
            return false;
          }
          if (filterDescription && !(row.partdescription || '').toLowerCase().includes(filterDescription)) {
            return false;
          }
          if (filterVendor && !(row.vendorname || '').toLowerCase().includes(filterVendor)) {
            return false;
          }
          // Location filter (multi-select)
          if (selectedLocations.length > 0 && selectedLocations.indexOf(row.locationgroup) === -1) {
            return false;
          }
          // Status filter - skip if we're aggregating first
          if (!skipStatusFilter && selectedStatuses.length > 0 && selectedStatuses.indexOf(row.state) === -1) {
            return false;
          }

          return true;
        });
      }

      // Filter aggregated data: keep parts that have at least one location matching status filter
      function filterAggregatedByStatus(aggregatedData, allData) {
        var selectedStatuses = getSelectedStatuses();
        if (selectedStatuses.length === 0) return aggregatedData;

        return aggregatedData.filter(function(aggRow) {
          // Find all raw rows for this part
          var partRows = allData.filter(function(row) {
            return row.partnum === aggRow.partnum && row.vendorname === aggRow.vendorname;
          });
          // Check if any location matches the status filter
          return partRows.some(function(row) {
            return selectedStatuses.indexOf(row.state) !== -1;
          });
        });
      }

      // Redraw table with current filters (without reinitializing DataTable)
      function redrawWithFilters() {
        let table = $('#report-table').DataTable();

        // Apply filters to current dataset (skip status filter for aggregation)
        let filteredData = applyFilters(dataset, true);

        // Aggregate by part for main display
        let aggregatedData = aggregateByPart(filteredData);

        // Filter aggregated data by status (show parts with ANY location matching status)
        aggregatedData = filterAggregatedByStatus(aggregatedData, dataset);

        // Insert vendor header rows
        let groupedData = [];
        let currentVendor = null;

        aggregatedData.forEach(function(row) {
          if (row.vendorname !== currentVendor) {
            currentVendor = row.vendorname;
            groupedData.push({
              isVendorHeader: true,
              vendorname: currentVendor
            });
          }
          groupedData.push(row);
        });

        table.clear();
        table.rows.add(groupedData);
        table.draw(false);
        table.columns.adjust();
      }

      // Apply column filters and redraw table
      function applyColumnFilters() {
        redrawWithFilters();
      }

      // Clear all column filters
      function clearColumnFilters() {
        $('#filterPartNum').val('');
        $('#filterDescription').val('');
        $('#filterVendor').val('');
        // Reset status checkboxes
        $('.status-checkbox').prop('checked', false);
        $('#statusFilterLabel').text('All');
        // Reset location checkboxes
        $('.location-checkbox').prop('checked', false);
        $('#locationFilterLabel').text('All');
        redrawWithFilters();
      }

      // Open Part in Fishbowl
      function openPart(partNum) {
        openModule("Part", partNum);
      }

      // Open Vendor in Fishbowl
      function openVendor(vendorName) {
        openModule("Vendor", vendorName);
      }

      // Toggle status dropdown visibility
      function toggleStatusDropdown() {
        var dropdown = document.getElementById('statusDropdown');
        dropdown.classList.toggle('hidden');
      }

      // Close dropdowns when clicking outside
      document.addEventListener('click', function(e) {
        // Close status dropdown
        var statusDropdown = document.getElementById('statusDropdown');
        var statusBtn = document.getElementById('statusFilterBtn');
        if (statusDropdown && statusBtn && !statusDropdown.contains(e.target) && !statusBtn.contains(e.target)) {
          statusDropdown.classList.add('hidden');
        }
        // Close location dropdown
        var locationDropdown = document.getElementById('locationDropdown');
        var locationBtn = document.getElementById('locationFilterBtn');
        if (locationDropdown && locationBtn && !locationDropdown.contains(e.target) && !locationBtn.contains(e.target)) {
          locationDropdown.classList.add('hidden');
        }
      });

      // Update status filter label and apply filter
      function updateStatusFilter() {
        var checkboxes = document.querySelectorAll('.status-checkbox:checked');
        var label = document.getElementById('statusFilterLabel');
        if (checkboxes.length === 0) {
          label.textContent = 'All';
        } else if (checkboxes.length === 1) {
          label.textContent = checkboxes[0].parentElement.textContent.trim();
        } else {
          label.textContent = checkboxes.length + ' selected';
        }
        applyColumnFilters();
      }

      // Get selected status values
      function getSelectedStatuses() {
        var checkboxes = document.querySelectorAll('.status-checkbox:checked');
        return Array.from(checkboxes).map(function(cb) { return cb.value; });
      }

      // Toggle location dropdown visibility
      function toggleLocationDropdown() {
        var dropdown = document.getElementById('locationDropdown');
        dropdown.classList.toggle('hidden');
      }

      // Update location filter label and apply filter
      function updateLocationFilter() {
        var checkboxes = document.querySelectorAll('.location-checkbox:checked');
        var label = document.getElementById('locationFilterLabel');
        if (checkboxes.length === 0) {
          label.textContent = 'All';
        } else if (checkboxes.length === 1) {
          label.textContent = checkboxes[0].parentElement.textContent.trim();
        } else {
          label.textContent = checkboxes.length + ' selected';
        }
        applyColumnFilters();
      }

      // Get selected location values
      function getSelectedLocations() {
        var checkboxes = document.querySelectorAll('.location-checkbox:checked');
        return Array.from(checkboxes).map(function(cb) { return cb.value; });
      }

      // Check if data has location groups and populate filter
      function setupLocationFilter(data) {
        var locationGroups = {};
        var hasLocationGroups = false;

        data.forEach(function(row) {
          if (row.locationgroupid) {
            hasLocationGroups = true;
            if (!locationGroups[row.locationgroup]) {
              locationGroups[row.locationgroup] = row.locationgroupid;
            }
          }
        });

        var container = document.getElementById('locationFilterContainer');
        var dropdown = document.getElementById('locationDropdown');

        if (hasLocationGroups) {
          container.style.display = 'block';
          // Populate dropdown with location groups
          var html = '';
          Object.keys(locationGroups).sort().forEach(function(name) {
            html += '<label class="flex items-center px-2 py-1 hover:bg-slate-50 cursor-pointer text-sm">';
            html += '<input type="checkbox" value="' + name + '" class="location-checkbox mr-2" onchange="updateLocationFilter()"> ' + name;
            html += '</label>';
          });
          dropdown.innerHTML = html;
        } else {
          container.style.display = 'none';
        }

        return hasLocationGroups;
      }

      // Toggle expanded location details for a part
      function toggleLocationDetails(partNum, rowElement) {
        var tbody = rowElement.closest('tbody');
        var existingRows = tbody.querySelectorAll('tr[data-expanded-for="' + partNum + '"]');

        // Toggle expand icon
        var icon = rowElement.querySelector('.expand-icon');

        if (existingRows.length > 0) {
          existingRows.forEach(function(row) { row.remove(); });
          if (icon) icon.classList.remove('expanded');
          return;
        }

        if (icon) icon.classList.add('expanded');

        // Get location details for this part
        var partDetails = dataset.filter(function(row) {
          return row.partnum === partNum && row.locationgroupid;
        });

        if (partDetails.length === 0) return;

        // Apply status filter to drill-down rows if active
        var selectedStatuses = getSelectedStatuses();
        if (selectedStatuses.length > 0) {
          partDetails = partDetails.filter(function(row) {
            return selectedStatuses.indexOf(row.state) !== -1;
          });
        }

        if (partDetails.length === 0) return;

        // Create detail rows - one per location, with cells matching main table columns
        var lastInserted = rowElement;
        partDetails.forEach(function(detail, index) {
          // Status text - show percentage like main table (except norop and overstocked)
          var statusText;
          if (detail.state === 'norop') {
            statusText = 'No ROP/OUL';
          } else if (detail.state === 'fb10' || detail.capacitypct > 100) {
            statusText = 'Overstocked';
          } else {
            statusText = detail.capacitypct + '%';
          }

          // Get status colors matching main table
          var bgColor, lightColor;
          if (detail.state === 'norop') {
            bgColor = '#e2e8f0'; lightColor = '#e2e8f0';
          } else if (detail.state === 'fb10') {
            bgColor = '#1976D2'; lightColor = '#90CAF9';
          } else if (detail.state === 'fb20') {
            bgColor = '#2E7D32'; lightColor = '#A5D6A7';
          } else if (detail.state === 'fb30') {
            bgColor = '#F57C00'; lightColor = '#FFCC80';
          } else if (detail.state === 'fb40') {
            bgColor = '#C62828'; lightColor = '#EF9A9A';
          } else {
            bgColor = '#e2e8f0'; lightColor = '#e2e8f0';
          }

          var capacityPct = detail.capacitypct;
          var gradient;
          if (detail.state === 'norop') {
            gradient = bgColor;
          } else if (detail.state === 'fb10' || capacityPct > 100) {
            // Overstocked - always solid blue
            gradient = bgColor;
          } else if (capacityPct === null || capacityPct === undefined) {
            gradient = bgColor;
          } else if (capacityPct < 0) {
            var fillFromRight = Math.min(100, Math.abs(capacityPct));
            gradient = 'linear-gradient(to left, ' + bgColor + ' ' + fillFromRight + '%, ' + lightColor + ' ' + fillFromRight + '%)';
          } else {
            var fillPercent = Math.max(0, Math.min(100, capacityPct));
            gradient = 'linear-gradient(to right, ' + bgColor + ' ' + fillPercent + '%, ' + lightColor + ' ' + fillPercent + '%)';
          }

          var textColor = detail.state === 'norop' ? '#64748b' : '#FFFFFF';
          var textShadow = detail.state === 'norop' ? 'none' : '1px 1px 2px rgba(0,0,0,0.8)';
          var isLast = index === partDetails.length - 1;
          var borderStyle = isLast ? 'border-bottom: 2px solid #cbd5e1;' : 'border-bottom: 1px solid #e2e8f0;';

          var detailRow = document.createElement('tr');
          detailRow.setAttribute('data-expanded-for', partNum);
          detailRow.className = 'location-detail-row';
          detailRow.style.cssText = 'background-color: #f8fafc;';

          var html = '';
          // Col 1: Empty (vendor indicator space)
          html += '<td style="padding:2px; ' + borderStyle + ' background:#f8fafc !important;"></td>';
          // Col 2: Status with gradient
          html += '<td style="text-align:center; background:' + gradient + ' !important; color:' + textColor + ' !important; text-shadow:' + textShadow + '; font-weight:600; font-size:11px; padding:6px 4px; ' + borderStyle + '">' + statusText + '</td>';
          // Col 3: Location Group (in part number column)
          html += '<td style="text-align:left; padding:6px 8px; font-weight:500; font-size:11px; background:#f1f5f9 !important; ' + borderStyle + '">' + detail.locationgroup + '</td>';
          // Col 4: Empty (description column)
          html += '<td style="padding:6px 4px; background:#f1f5f9 !important; ' + borderStyle + '"></td>';
          // Col 5: UOM
          html += '<td style="text-align:center; font-size:11px; padding:6px 4px; ' + borderStyle + ' background:#f8fafc !important;">' + (detail.uom || '') + '</td>';
          // Col 6: On Hand
          html += '<td style="text-align:center; font-size:11px; padding:6px 4px; background:#fef3c7 !important; ' + borderStyle + '">' + formatNumber(detail.onhand) + '</td>';
          // Col 7: Available
          html += '<td style="text-align:center; font-size:11px; padding:6px 4px; background:#fef3c7 !important; ' + borderStyle + '">' + formatNumber(detail.available) + '</td>';
          // Col 8: Qty to Order
          html += '<td style="text-align:center; font-size:11px; padding:6px 4px; background:#fef3c7 !important; ' + borderStyle + '">' + formatNumber(detail.recommendedorderqty) + '</td>';
          // Col 9: ROP
          html += '<td style="text-align:center; font-size:11px; padding:6px 4px; background:#dcfce7 !important; ' + borderStyle + '">' + (detail.reorderpoint || '-') + '</td>';
          // Col 10: OUL
          html += '<td style="text-align:center; font-size:11px; padding:6px 4px; background:#dcfce7 !important; ' + borderStyle + '">' + (detail.orderuptolevel || '-') + '</td>';
          // Col 11: Committed
          html += '<td style="text-align:center; font-size:11px; padding:6px 4px; ' + borderStyle + ' background:#f8fafc !important;">' + formatNumber(detail.committed) + '</td>';
          // Col 12: Allocated
          html += '<td style="text-align:center; font-size:11px; padding:6px 4px; ' + borderStyle + ' background:#f8fafc !important;">' + formatNumber(detail.allocated) + '</td>';
          // Col 13: Not Available
          html += '<td style="text-align:center; font-size:11px; padding:6px 4px; ' + borderStyle + ' background:#f8fafc !important;">' + formatNumber(detail['not available']) + '</td>';
          // Col 14: On Order
          html += '<td style="text-align:center; font-size:11px; padding:6px 4px; ' + borderStyle + ' background:#f8fafc !important;">' + formatNumber(detail['on order']) + '</td>';

          detailRow.innerHTML = html;
          lastInserted.parentNode.insertBefore(detailRow, lastInserted.nextSibling);
          lastInserted = detailRow;
        });
      }

      // Format number helper
      function formatNumber(val) {
        if (val === null || val === undefined || val === '') return '0';
        var num = parseFloat(val);
        if (isNaN(num)) return '0';
        if (Number.isInteger(num)) return num.toString();
        return num.toFixed(2).replace(/\.?0+$/, '');
      }

      // Aggregate data by part number for parts with multiple location groups
      function aggregateByPart(data) {
        var partMap = {};
        var result = [];

        data.forEach(function(row) {
          var key = row.partnum + '|' + row.vendorname;

          if (!partMap[key]) {
            // First occurrence - clone the row
            partMap[key] = {
              refresh: row.refresh,
              partid: row.partid,
              partnum: row.partnum,
              partdescription: row.partdescription,
              vendorname: row.vendorname,
              locationgroupid: row.locationgroupid,
              locationgroup: row.locationgroup,
              uom: row.uom,
              reorderpoint: row.reorderpoint || 0,
              orderuptolevel: row.orderuptolevel || 0,
              onhand: parseFloat(row.onhand) || 0,
              available: parseFloat(row.available) || 0,
              committed: parseFloat(row.committed) || 0,
              allocated: parseFloat(row.allocated) || 0,
              'not available': parseFloat(row['not available']) || 0,
              'on order': parseFloat(row['on order']) || 0,
              recommendedorderqty: parseFloat(row.recommendedorderqty) || 0,
              capacitypct: row.capacitypct,
              state: row.state,
              statetext: row.statetext,
              hasMultipleLocations: false,
              locationCount: 1
            };
          } else {
            // Aggregate quantities
            partMap[key].onhand += parseFloat(row.onhand) || 0;
            partMap[key].available += parseFloat(row.available) || 0;
            partMap[key].committed += parseFloat(row.committed) || 0;
            partMap[key].allocated += parseFloat(row.allocated) || 0;
            partMap[key]['not available'] += parseFloat(row['not available']) || 0;
            partMap[key]['on order'] += parseFloat(row['on order']) || 0;
            partMap[key].recommendedorderqty += parseFloat(row.recommendedorderqty) || 0;
            partMap[key].reorderpoint += parseFloat(row.reorderpoint) || 0;
            partMap[key].orderuptolevel += parseFloat(row.orderuptolevel) || 0;
            partMap[key].hasMultipleLocations = true;
            partMap[key].locationCount++;
            // Set locationgroup to indicate multiple
            partMap[key].locationgroup = partMap[key].locationCount + ' Locations';
            // Recalculate state based on aggregated values
            partMap[key] = recalculateState(partMap[key]);
          }
        });

        // Convert map to array preserving order
        var seen = {};
        data.forEach(function(row) {
          var key = row.partnum + '|' + row.vendorname;
          if (!seen[key]) {
            seen[key] = true;
            result.push(partMap[key]);
          }
        });

        return result;
      }

      // Recalculate state for aggregated row
      function recalculateState(row) {
        if (!row.reorderpoint || !row.orderuptolevel || row.reorderpoint === 0 || row.orderuptolevel === 0) {
          row.state = 'norop';
          row.capacitypct = null;
        } else if (row.available > row.orderuptolevel) {
          row.state = 'fb10';
          row.capacitypct = 150;
        } else if (row.available < row.reorderpoint) {
          row.state = 'fb40';
          row.capacitypct = Math.round(-1 * ((row.reorderpoint - row.available) / row.reorderpoint) * 100 * 10) / 10;
        } else if (row.available <= row.reorderpoint + (0.2 * (row.orderuptolevel - row.reorderpoint))) {
          row.state = 'fb30';
          row.capacitypct = Math.round(((row.available - row.reorderpoint) / (row.orderuptolevel - row.reorderpoint)) * 100 * 10) / 10;
        } else {
          row.state = 'fb20';
          row.capacitypct = Math.round(((row.available - row.reorderpoint) / (row.orderuptolevel - row.reorderpoint)) * 100 * 10) / 10;
        }
        return row;
      }

      // Export to CSV using DataTables button
      function exportToCSV() {
        var table = $('#report-table').DataTable();
        table.button(0).trigger();
      }

      // Print table using DataTables button
      function printTable() {
        var table = $('#report-table').DataTable();
        table.button(1).trigger();
      }

      // Make functions globally accessible for inline event handlers
      window.applyColumnFilters = applyColumnFilters;
      window.clearColumnFilters = clearColumnFilters;
      window.openPart = openPart;
      window.openVendor = openVendor;
      window.toggleStatusDropdown = toggleStatusDropdown;
      window.updateStatusFilter = updateStatusFilter;
      window.toggleLocationDropdown = toggleLocationDropdown;
      window.updateLocationFilter = updateLocationFilter;
      window.toggleLocationDetails = toggleLocationDetails;
      window.exportToCSV = exportToCSV;
      window.printTable = printTable;

      function drawTable() {
        dataset = getData();

        // Setup location filter based on data
        var hasLocationGroups = setupLocationFilter(dataset);

        // Apply filters (skip status filter for aggregation)
        let filteredData = applyFilters(dataset, true);

        // Aggregate by part for main display (keeps raw data in dataset for drill-down)
        let aggregatedData = aggregateByPart(filteredData);

        // Filter aggregated data by status (show parts with ANY location matching status)
        aggregatedData = filterAggregatedByStatus(aggregatedData, dataset);

        // Insert vendor header rows
        let groupedData = [];
        let currentVendor = null;

        aggregatedData.forEach(function(row) {
          if (row.vendorname !== currentVendor) {
            currentVendor = row.vendorname;
            groupedData.push({
              isVendorHeader: true,
              vendorname: currentVendor
            });
          }
          groupedData.push(row);
        });

        let table = $('#report-table');
        table.empty();

        $(window).on('resize scroll', function() {
          table.columns.adjust();
        });

        let dataTable = table.DataTable({
          dom: 'Brt',
          data: groupedData,
          ordering: false,
          autoWidth: false,
          paging: false,
          scrollY: 'calc(100vh - 280px)',
          scrollCollapse: true,
          deferRender: true,
          buttons: [
            { extend: 'csv', className: 'dt-button-hidden' },
            { extend: 'print', className: 'dt-button-hidden' }
          ],
          columns: [
            {
              title: '<span title="Vendor grouping indicator">',
              data: 'vendorname',
              defaultContent: '',
              width: '1%',
              render: function(data, type, row) {
                if (row.isVendorHeader) return data;
                return '';
              },
              createdCell: function(td, cellData, rowData, row, col) {
                              if (rowData.isVendorHeader) {
                                $(td).attr('colspan', 14);
                                $(td).parent().addClass('vendor-group-header');
                                var vendorIcon = '<svg class="w-4 h-4 inline-block mr-2 align-text-bottom" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: #2d9cdb;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>';
                                var vendorDisplay = rowData.vendorname;
                                // Make vendor name clickable (except for "No Default Vendor")
                                if (rowData.vendorname && rowData.vendorname !== 'No Default Vendor') {
                                  vendorDisplay = '<a href="#" class="item-link" onclick="openVendor(\'' + rowData.vendorname.replace(/'/g, "\\'") + '\'); return false;">' + rowData.vendorname + '</a>';
                                }
                                $(td).html(vendorIcon + vendorDisplay);
                                $(td).nextAll().remove();
                              } else {
                                $(td).css({
                                  'padding': '2px',
                                  'width': '1%',
                                  'max-width': '10px'
                                });
                              }
                            }
            },
            {
              title: '<span title="Inventory status with capacity percentage">Status</span>',
              data: 'capacitypct',
              defaultContent: '',
              className: 'dt-center group-status',
              width: '8%',
              render: function(data, type, row) {
                if (row.isVendorHeader) return '';
                if (type === 'display') {
                  let text;
                  if (row.state === 'norop') {
                    text = 'No ROP/OUL';
                  } else if (row.state === 'fb10' || data > 100) {
                    text = 'Overstocked';
                  } else if (data < 0) {
                    text = data + '%';
                  } else {
                    text = data + '%';
                  }
                  return '<strong>' + text + '</strong>';
                }
                // For sorting, put norop at the end
                if (row.state === 'norop') return 999999;
                return data;
              },
              createdCell: function (td, cellData, rowData, row, col) {
                  if (rowData.isVendorHeader) return;

                  // Determine color based on state
                  let bgColor = '';
                  let lightColor = '';
                  if (rowData.state === 'norop') {
                      // No ROP/OUL - light grey background
                      td.style.setProperty('background', '#e2e8f0', 'important');
                      td.style.setProperty('color', '#64748b', 'important');
                      td.style.setProperty('font-weight', 'normal', 'important');
                      return;
                  } else if (rowData.state === 'fb10') {
                      bgColor = '#1976D2'; // Blue - Overstocked
                      lightColor = '#90CAF9'; // Darker light blue
                  } else if (rowData.state === 'fb20') {
                      bgColor = '#2E7D32'; // Green - Good
                      lightColor = '#A5D6A7'; // Darker light green
                  } else if (rowData.state === 'fb30') {
                      bgColor = '#F57C00'; // Orange - Alert
                      lightColor = '#FFCC80'; // Darker light orange
                  } else if (rowData.state === 'fb40') {
                      bgColor = '#C62828'; // Red - Critical
                      lightColor = '#EF9A9A'; // Darker light red
                  }

                  if (bgColor) {
                      // Calculate fill percentage (cap at 0-100 for display)
                      let fillPercent = Math.max(0, Math.min(100, cellData));
                      let gradient;

                      if (cellData < 0) {
                          // Negative - fill from right to left
                          let fillFromRight = Math.min(100, Math.abs(cellData));
                          gradient = 'linear-gradient(to left, ' + bgColor + ' ' + fillFromRight + '%, ' + lightColor + ' ' + fillFromRight + '%)';
                      } else if (cellData > 100) {
                          // Over 100% - full fill
                          gradient = bgColor;
                      } else {
                          // Normal - fill from left to right
                          gradient = 'linear-gradient(to right, ' + bgColor + ' ' + fillPercent + '%, ' + lightColor + ' ' + fillPercent + '%)';
                      }

                      td.style.setProperty('background', gradient, 'important');
                      td.style.setProperty('color', '#FFFFFF', 'important');
                      td.style.setProperty('font-weight', 'normal', 'important');
                      td.style.setProperty('text-shadow', '1px 1px 2px rgba(0,0,0,0.8)', 'important');
                  }
              }

            },
            {
              title: '<span title="Unique part identifier/SKU">Part Number</span>',
              data: 'partnum',
              defaultContent: '',
              width: '8%',
              className: 'dt-right group-part-info',
              render: function(data, type, row) {
                if (row.isVendorHeader) return '';
                if (type === 'display') {
                  // Check if part has multiple location groups
                  var hasLocations = row.hasMultipleLocations ? true : false;
                  var expandIcon = hasLocations ? '<svg class="expand-icon w-3 h-3 inline-block mr-1 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>' : '';
                  return expandIcon + '<a href="#" class="item-link" onclick="openPart(\'' + data.replace(/'/g, "\\'") + '\'); return false;"><strong>' + data + '</strong></a>';
                }
                return data;
              },
              createdCell: function(td, cellData, rowData, row, col) {
                if (rowData.isVendorHeader) return;
                if (rowData.hasMultipleLocations) {
                  $(td).addClass('expandable-row');
                  $(td).on('click', function(e) {
                    if (!$(e.target).hasClass('item-link')) {
                      toggleLocationDetails(rowData.partnum, $(this).closest('tr')[0]);
                    }
                  });
                }
              }
            },
            {
              title: '<span title="Descriptive name of the part">Part Description</span>',
              data: 'partdescription',
              defaultContent: '',
              width: '15%',
              className: 'group-part-info',
              render: function(data, type, row) {
                if (row.isVendorHeader) return '';
                if (type === 'display') {
                  return '<strong>' + data + '</strong>';
                }
                return data;
              }
            },
            {
              title: '<span title="Unit of Measure for quantity tracking">UOM</span>',
              data: 'uom',
              defaultContent: '',
              width: '4%',
              className: 'dt-center group-part-info',
              render: function(data, type, row) {
                if (row.isVendorHeader) return '';
                return data || '';
              }
            },
            { title: '<span title="Total physical quantity currently in stock">On Hand</span>', data: 'onhand', defaultContent: '', width: '6%', className: 'dt-center group-inventory-key',render: function (data, type, row) {

                if (row.isVendorHeader) return '';
                if (data === null || data === '' || data === undefined) return '';

                if (type === 'display' || type === 'filter') {

                    const num = parseFloat(data);

                    if (isNaN(num)) return '';

                    // If it's a whole number, show no decimals
                    if (Number.isInteger(num)) {
                        return num.toString();
                    }

                    // Otherwise show up to 2 decimals (no trailing zeros)
                    return num.toFixed(2).replace(/\.?0+$/, '');
                }

                return data;
            }
 },
            { title: '<span title="Quantity available for use: On Hand - Allocated - Not Available + Dropship">Available</span>', data: 'available', defaultContent: '', width: '6%', className: 'dt-center group-inventory-key',
                      render: function (data, type, row) {

                        if (row.isVendorHeader) return '';
                        if (data === null || data === '' || data === undefined) return '';

                        if (type === 'display' || type === 'filter') {

                            const num = parseFloat(data);

                            if (isNaN(num)) return '';

                            // If it's a whole number, show no decimals
                            if (Number.isInteger(num)) {
                                return num.toString();
                            }

                            // Otherwise show up to 2 decimals (no trailing zeros)
                            return num.toFixed(2).replace(/\.?0+$/, '');
                        }

                        return data;
                      }
             },
            { title: '<span title="Recommended quantity to order to reach Order Up To level: Order Up To - (Available - Committed)">Qty to Order</span>', data: 'recommendedorderqty', defaultContent: '', width: '8%', className: 'dt-center group-inventory-key',
                      render: function (data, type, row) {

                        if (row.isVendorHeader) return '';
                        if (data === null || data === '' || data === undefined) return '';

                        if (type === 'display' || type === 'filter') {

                            const num = parseFloat(data);

                            if (isNaN(num)) return '';

                            // If it's a whole number, show no decimals
                            if (Number.isInteger(num)) {
                                return num.toString();
                            }

                            // Otherwise show up to 2 decimals (no trailing zeros)
                            return num.toFixed(2).replace(/\.?0+$/, '');
                        }

                        return data;
                      }
            },
            { title: '<span title="Minimum inventory threshold that triggers a reorder alert">Reorder Point</span>', data: 'reorderpoint', defaultContent: '', width: '6%', className: 'dt-center group-reorder-params',
                      render: function (data, type, row) {

                        if (row.isVendorHeader) return '';
                        if (data === null || data === '' || data === undefined || data === 0) {
                            return type === 'display' ? '-' : '';
                        }

                        if (type === 'display' || type === 'filter') {

                            const num = parseFloat(data);

                            if (isNaN(num) || num === 0) return type === 'display' ? '-' : '';

                            // If it's a whole number, show no decimals
                            if (Number.isInteger(num)) {
                                return num.toString();
                            }

                            // Otherwise show up to 2 decimals (no trailing zeros)
                            return num.toFixed(2).replace(/\.?0+$/, '');
                        }

                        return data;
                      }
 },
            { title: '<span title="Target maximum inventory level when reordering">Order Up To</span>', data: 'orderuptolevel', defaultContent: '', width: '6%', className: 'dt-center group-reorder-params', render: function (data, type, row) {

     if (row.isVendorHeader) return '';
     if (data === null || data === '' || data === undefined || data === 0) {
         return type === 'display' ? '-' : '';
     }

     if (type === 'display' || type === 'filter') {

         const num = parseFloat(data);

         if (isNaN(num) || num === 0) return type === 'display' ? '-' : '';

         // If it's a whole number, show no decimals
         if (Number.isInteger(num)) {
             return num.toString();
         }

         // Otherwise show up to 2 decimals (no trailing zeros)
         return num.toFixed(2).replace(/\.?0+$/, '');
     }

     return data;
 }
 },
            { title: '<span title="Quantity committed to sales orders">Committed</span>', data: 'committed', defaultContent: '', width: '6%', className: 'dt-center group-allocation',render: function (data, type, row) {

     if (row.isVendorHeader) return '';
     if (data === null || data === '' || data === undefined) return '';

     if (type === 'display' || type === 'filter') {

         const num = parseFloat(data);

         if (isNaN(num)) return '';

         // If it's a whole number, show no decimals
         if (Number.isInteger(num)) {
             return num.toString();
         }

         // Otherwise show up to 2 decimals (no trailing zeros)
         return num.toFixed(2).replace(/\.?0+$/, '');
     }

     return data;
 }
 },
            { title: '<span title="Quantity allocated for work orders or manufacturing builds">Allocated</span>', data: 'allocated', defaultContent: '', width: '6%', className: 'dt-center group-allocation',render: function (data, type, row) {

                if (row.isVendorHeader) return '';
                if (data === null || data === '' || data === undefined) return '';

                if (type === 'display' || type === 'filter') {

                    const num = parseFloat(data);

                    if (isNaN(num)) return '';

                    // If it's a whole number, show no decimals
                    if (Number.isInteger(num)) {
                        return num.toString();
                    }

                    // Otherwise show up to 2 decimals (no trailing zeros)
                    return num.toFixed(2).replace(/\.?0+$/, '');
                }

                return data;
            }
 },
            { title: '<span title="Quantity on hand but flagged as not available for use">Not Available</span>', data: 'not available', defaultContent: '', width: '6%', className: 'dt-center group-allocation',render: function (data, type, row) {

                if (row.isVendorHeader) return '';
                if (data === null || data === '' || data === undefined) return '';

                if (type === 'display' || type === 'filter') {

                    const num = parseFloat(data);

                    if (isNaN(num)) return '';

                    // If it's a whole number, show no decimals
                    if (Number.isInteger(num)) {
                        return num.toString();
                    }

                    // Otherwise show up to 2 decimals (no trailing zeros)
                    return num.toFixed(2).replace(/\.?0+$/, '');
                }

                return data;
            }
 },
            { title: '<span title="Quantity on purchase orders not yet received">On Order</span>', data: 'on order', defaultContent: '', width: '6%', className: 'dt-center group-allocation',render: function (data, type, row) {

                if (row.isVendorHeader) return '';
                if (data === null || data === '' || data === undefined) return '';

                if (type === 'display' || type === 'filter') {

                    const num = parseFloat(data);

                    if (isNaN(num)) return '';

                    // If it's a whole number, show no decimals
                    if (Number.isInteger(num)) {
                        return num.toString();
                    }

                    // Otherwise show up to 2 decimals (no trailing zeros)
                    return num.toFixed(2).replace(/\.?0+$/, '');
                }

                return data;
            }
 }
          ],
          fixedHeader: true,
          colReorder: false,
          pagingType: 'simple',
          responsive: false,
          stateSave: false,
          language: {
            paginate: {
              previous: 'PREV',
              next: 'NEXT'
            }
          },
          drawCallback: function(settings) {
            // Force column width recalculation after draw to prevent skinny columns
            var api = this.api();
            api.columns.adjust();

            // Update vendor header colspans
            updateVendorHeaderColspan();
          }
        });

        // Update vendor header colspans based on visible columns
        function updateVendorHeaderColspan() {
          let visibleColCount = dataTable.columns(':visible').count();
          $('.vendor-group-header td').each(function() {
            $(this).attr('colspan', visibleColCount);
            // Remove any extra cells that were created
            $(this).nextAll().remove();
          });
        }

        // Update colspans initially
        updateVendorHeaderColspan();

        // Force initial column width adjustment
        dataTable.columns.adjust().draw(false);
      }

      function refreshTable() {
        console.time('refreshRate');
        let table = $('#report-table').DataTable();
        dataset = getData();

        // Setup location filter based on data
        setupLocationFilter(dataset);

        // Apply filters (skip status filter for aggregation)
        let filteredData = applyFilters(dataset, true);

        // Aggregate by part for main display
        let aggregatedData = aggregateByPart(filteredData);

        // Filter aggregated data by status (show parts with ANY location matching status)
        aggregatedData = filterAggregatedByStatus(aggregatedData, dataset);

        // Insert vendor header rows
        let groupedData = [];
        let currentVendor = null;

        aggregatedData.forEach(function(row) {
          if (row.vendorname !== currentVendor) {
            currentVendor = row.vendorname;
            groupedData.push({
              isVendorHeader: true,
              vendorname: currentVendor
            });
          }
          groupedData.push(row);
        });

        table.clear();

        table.rows.add(groupedData);
        table.draw(false);

        // Ensure columns maintain proper widths after refresh
        table.columns.adjust();

        console.timeEnd('refreshRate');
        setTimeout(refreshTable, dataset[0].refresh);
      }

      // Make refreshTable globally accessible
      window.refreshTable = refreshTable;

      drawTable();
      console.log(dataset[0].refresh);
      setTimeout(refreshTable, dataset[0].refresh);
    }

    $(document).ready(function() {
      monitor();
    });

    // Toggle instructions panel
    function toggleInstructions() {
      const panel = document.getElementById('instructionsPanel');
      if (panel.style.display === 'none') {
        panel.style.display = 'block';
      } else {
        panel.style.display = 'none';
      }
    }

    const displayHeader = $CHECK{Display_header|true};
    let headerContainer = document.getElementById('headerContainer');
    displayHeader ? headerContainer.style.display = 'flex' : headerContainer.style.display = 'none';

    </script>
</body>
</html>