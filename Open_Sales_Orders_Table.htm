<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open Sales Orders</title>

    <!-- Tabulator CSS -->
    <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet">

    <!-- Tabulator JS -->
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>

    <!-- Moment.js for date formatting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            font-size: 13px;
            padding: 8px;
            background: #f5f5f5;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding: 8px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .header h1 {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .btn {
            padding: 6px 12px;
            font-size: 12px;
            border: 1px solid #ccc;
            background: white;
            border-radius: 3px;
            cursor: pointer;
            font-weight: 500;
        }

        .btn:hover {
            background: #f0f0f0;
        }

        .btn-primary {
            background: #2d9cdb;
            color: white;
            border-color: #2d9cdb;
        }

        .btn-primary:hover {
            background: #1e7bb4;
        }

        #salesOrderTable {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }

        /* Tabulator overrides for tighter spacing */
        .tabulator .tabulator-header .tabulator-col {
            background: #f8f9fa;
            border-right: 1px solid #ddd;
        }

        .tabulator .tabulator-header .tabulator-col .tabulator-col-content {
            padding: 6px 8px;
        }

        .tabulator .tabulator-cell {
            padding: 4px 8px;
            border-right: 1px solid #e9ecef;
        }

        .tabulator .tabulator-row {
            min-height: 28px;
        }

        .tabulator .tabulator-row.tabulator-row-even {
            background-color: #f8f9fa;
        }

        .tabulator .tabulator-row:hover {
            background-color: #e3f2fd !important;
        }

        /* Order number link styling */
        .order-link {
            color: #2d9cdb;
            text-decoration: none;
            font-weight: 600;
        }

        .order-link:hover {
            text-decoration: underline;
            color: #1e7bb4;
        }

        /* Status badges */
        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-estimate {
            background: #fff3cd;
            color: #856404;
        }

        .status-inprogress {
            background: #cce5ff;
            color: #004085;
        }

        .status-issued {
            background: #d4edda;
            color: #155724;
        }

        /* Loading overlay */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-content {
            background: white;
            padding: 20px 30px;
            border-radius: 8px;
            text-align: center;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2d9cdb;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .filter-info {
            font-size: 11px;
            color: #666;
            padding: 4px 8px;
            background: #fff3cd;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>Open Sales Orders</h1>
        </div>
        <div class="controls">
            <span id="filterInfo" class="filter-info" style="display: none;"></span>
            <label style="font-size: 12px;">
                <input type="checkbox" id="hideEstimates" onchange="toggleEstimates()">
                Hide Estimates
            </label>
            <button class="btn" onclick="resetColumns()">Reset Columns</button>
            <button class="btn" onclick="clearFilters()">Clear Filters</button>
            <button class="btn btn-primary" onclick="loadData()">Refresh</button>
        </div>
    </div>

    <div id="salesOrderTable"></div>

    <!-- Debug Console (controlled by DEBUG_MODE variable) -->
    <div id="debugConsole" style="display: none; margin-top: 12px; background: #1e293b; border: 1px solid #334155; border-radius: 4px; padding: 12px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <h3 style="font-size: 12px; font-weight: 600; color: #94a3b8; margin: 0;">Debug Console</h3>
            <button onclick="clearDebugLog()" class="btn" style="padding: 4px 8px; font-size: 11px;">Clear</button>
        </div>
        <div id="debugLog" style="background: #0f172a; border-radius: 4px; padding: 8px; height: 200px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 11px; color: #e2e8f0;">
            <div style="color: #64748b; font-style: italic;">Initializing...</div>
        </div>
    </div>

    <div id="loading" class="loading" style="display: none;">
        <div class="loading-content">
            <div class="spinner"></div>
            <p style="font-weight: 600; color: #333;">Loading sales orders...</p>
        </div>
    </div>

    <script>
        // Debug mode - set to false for production
        const DEBUG_MODE = true;

        // Get date format from Fishbowl settings
        const FB_DATE_FORMAT = getProperty('DateFormatShort', 'MM/dd/yyyy');

        // Convert Java SimpleDateFormat to moment.js format
        // dd -> DD, MM -> MM, yyyy -> YYYY, yy -> YY
        const MOMENT_DATE_FORMAT = FB_DATE_FORMAT
            .replace(/yyyy/g, 'YYYY')
            .replace(/yy/g, 'YY')
            .replace(/dd/g, 'DD')
            .replace(/MM/g, 'MM');

        let table;
        let tableData = [];

        // Debug logging function
        function debugLog(message, type = 'info') {
            if (!DEBUG_MODE) return;

            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('debugLog');

            // Clear placeholder
            const placeholder = logDiv.querySelector('[style*="italic"]');
            if (placeholder) {
                logDiv.innerHTML = '';
            }

            const colors = {
                'info': '#60a5fa',
                'success': '#34d399',
                'warning': '#fbbf24',
                'error': '#f87171',
                'query': '#a78bfa'
            };

            const entry = document.createElement('div');
            entry.style.marginBottom = '4px';
            entry.innerHTML = `<span style="color: #64748b;">[${timestamp}]</span> <span style="color: ${colors[type]};">${message}</span>`;

            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;

            // Also log to browser console
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearDebugLog() {
            const logDiv = document.getElementById('debugLog');
            logDiv.innerHTML = '<div style="color: #64748b; font-style: italic;">Log cleared...</div>';
        }

        // Initialize Tabulator
        function initTable() {
            debugLog('Creating Tabulator instance...', 'info');

            // Adjust height based on whether debug console is shown
            const tableHeight = DEBUG_MODE ? "calc(100vh - 310px)" : "calc(100vh - 70px)";

            try {
                table = new Tabulator("#salesOrderTable", {
                height: tableHeight,
                data: [],
                layout: "fitData",
                placeholder: "No sales orders found",

                // Enable column features
                movableColumns: true,          // Drag to reorder columns
                headerSort: true,              // Click header to sort
                headerFilterPlaceholder: "",   // Filter placeholder

                // Persistence - saves column order, visibility, filters, sorting
                persistence: {
                    sort: true,
                    filter: true,
                    columns: true,
                },
                persistenceID: "openSalesOrdersTable",

                // Column header menu for show/hide
                headerMenu: [
                    {
                        label: "Hide Column",
                        action: function(e, column) {
                            column.hide();
                        }
                    }
                ],

                // Initial columns matching the screenshot
                columns: [
                    {
                        title: "Status",
                        field: "statusname",
                        width: 120,
                        headerFilter: "input",
                        formatter: function(cell) {
                            const value = cell.getValue();
                            let className = 'status-badge';
                            if (value === 'Estimate') className += ' status-estimate';
                            else if (value === 'In Progress') className += ' status-inprogress';
                            else if (value === 'Issued') className += ' status-issued';
                            return `<span class="${className}">${value}</span>`;
                        },
                        headerMenu: headerMenuWithFilter
                    },
                    {
                        title: "Number",
                        field: "num",
                        width: 100,
                        headerFilter: "input",
                        formatter: function(cell) {
                            const num = cell.getValue();
                            return `<a href="#" class="order-link" onclick="openSO('${num}'); return false;">${num}</a>`;
                        },
                        headerMenu: headerMenuWithFilter
                    },
                    {
                        title: "Customer Name",
                        field: "customername",
                        width: 250,
                        headerFilter: "input",
                        headerMenu: headerMenuWithFilter
                    },
                    {
                        title: "Customer PO",
                        field: "customerpo",
                        width: 150,
                        headerFilter: "input",
                        headerMenu: headerMenuWithFilter
                    },
                    {
                        title: "Date Issued",
                        field: "dateissued",
                        width: 130,
                        sorter: "date",
                        sorterParams: { format: "YYYY-MM-DD" },
                        formatter: function(cell) {
                            const value = cell.getValue();
                            if (!value) return '';
                            return moment(value).format(MOMENT_DATE_FORMAT);
                        },
                        headerMenu: headerMenuWithFilter
                    },
                    {
                        title: "Date Scheduled",
                        field: "datecalstart",
                        width: 130,
                        sorter: "date",
                        sorterParams: { format: "YYYY-MM-DD" },
                        formatter: function(cell) {
                            const value = cell.getValue();
                            if (!value) return '';
                            return moment(value).format(MOMENT_DATE_FORMAT);
                        },
                        headerMenu: headerMenuWithFilter
                    },
                    // Additional useful columns (hidden by default - can be shown via right-click menu)
                    {
                        title: "Salesman",
                        field: "salesman",
                        width: 150,
                        visible: false,
                        headerFilter: "input",
                        headerMenu: headerMenuWithFilter
                    },
                    {
                        title: "Total Price",
                        field: "totalprice",
                        width: 120,
                        visible: false,
                        formatter: "money",
                        formatterParams: {
                            decimal: ".",
                            thousand: ",",
                            symbol: "$",
                            precision: 2
                        },
                        headerMenu: headerMenuWithFilter
                    },
                    {
                        title: "Date Created",
                        field: "datecreated",
                        width: 130,
                        visible: false,
                        sorter: "date",
                        sorterParams: { format: "YYYY-MM-DD" },
                        formatter: function(cell) {
                            const value = cell.getValue();
                            if (!value) return '';
                            return moment(value).format(MOMENT_DATE_FORMAT);
                        },
                        headerMenu: headerMenuWithFilter
                    },
                    {
                        title: "Date Completed",
                        field: "datecompleted",
                        width: 130,
                        visible: false,
                        sorter: "date",
                        sorterParams: { format: "YYYY-MM-DD" },
                        formatter: function(cell) {
                            const value = cell.getValue();
                            if (!value) return '';
                            return moment(value).format(MOMENT_DATE_FORMAT);
                        },
                        headerMenu: headerMenuWithFilter
                    },
                    {
                        title: "Ship To Name",
                        field: "shiptoname",
                        width: 200,
                        visible: false,
                        headerFilter: "input",
                        headerMenu: headerMenuWithFilter
                    },
                    {
                        title: "Ship To City",
                        field: "shiptocity",
                        width: 150,
                        visible: false,
                        headerFilter: "input",
                        headerMenu: headerMenuWithFilter
                    },
                    {
                        title: "Priority",
                        field: "priorityname",
                        width: 100,
                        visible: false,
                        headerFilter: "input",
                        headerMenu: headerMenuWithFilter
                    }
                ],

                initialSort: [
                    { column: "dateissued", dir: "desc" }
                ]
            });

            debugLog('Tabulator instance created successfully', 'success');
            } catch (error) {
                debugLog(`ERROR creating Tabulator: ${error.message}`, 'error');
                debugLog(`Stack: ${error.stack}`, 'error');
                throw error;
            }
        }

        // Enhanced header menu with show/hide and filter options
        const headerMenuWithFilter = [
            {
                label: "Hide Column",
                action: function(e, column) {
                    column.hide();
                }
            },
            {
                separator: true
            },
            {
                label: "Show All Columns",
                action: function(e, column) {
                    table.getColumns().forEach(col => col.show());
                }
            }
        ];

        // Load sales order data
        function loadData() {
            debugLog('Starting data load...', 'info');
            const loading = document.getElementById('loading');
            loading.style.display = 'flex';

            try {
                // Query to get open sales orders with related data
                // Using table names with capital letters as per Fishbowl convention
                const query = `
                    SELECT
                        So.Id AS id,
                        So.Num AS num,
                        So.CustomerPO AS customerPO,
                        So.DateIssued AS dateIssued,
                        So.DateCreated AS dateCreated,
                        So.DateCompleted AS dateCompleted,
                        So.DateCalStart AS dateCalStart,
                        So.Salesman AS salesman,
                        So.TotalPrice AS totalPrice,
                        So.ShipToName AS shipToName,
                        So.ShipToCity AS shipToCity,
                        Customer.Name AS customerName,
                        SoStatus.Name AS statusName,
                        Priority.Name AS priorityName
                    FROM So
                    LEFT JOIN Customer ON So.CustomerId = Customer.Id
                    LEFT JOIN SoStatus ON So.StatusId = SoStatus.Id
                    LEFT JOIN Priority ON So.PriorityId = Priority.Id
                    WHERE SoStatus.Name IN ('Estimate', 'In Progress', 'Issued')
                    ORDER BY So.DateIssued DESC
                `;

                debugLog('Executing SQL query...', 'query');
                debugLog('Query: ' + query.substring(0, 100) + '...', 'query');

                const queryResult = runQuery(query);
                debugLog('Query executed, parsing result...', 'info');

                const result = JSON.parse(queryResult);
                debugLog(`Parsed ${result.length} records from query`, 'success');

                tableData = result;

                // Apply estimate filter if enabled
                const hideEstimates = document.getElementById('hideEstimates').checked;
                const filteredData = hideEstimates
                    ? result.filter(row => row.statusname !== 'Estimate')
                    : result;

                debugLog(`Applying filters... Hide estimates: ${hideEstimates}`, 'info');
                debugLog(`Filtered data: ${filteredData.length} of ${result.length} records`, 'info');

                table.setData(filteredData);
                debugLog('Table data set successfully', 'success');

                // Update filter info
                updateFilterInfo(result.length, filteredData.length);

                debugLog(`âœ“ Load complete: ${filteredData.length} sales orders displayed`, 'success');

                // Log first record as sample
                if (result.length > 0) {
                    debugLog('Sample record: ' + JSON.stringify(result[0]).substring(0, 150) + '...', 'info');
                }

            } catch (error) {
                debugLog(`ERROR: ${error.message}`, 'error');
                debugLog(`Stack: ${error.stack}`, 'error');
                console.error('Error loading data:', error);
                alert('Error loading sales orders: ' + error.message);
            } finally {
                loading.style.display = 'none';
            }
        }

        // Toggle estimate visibility
        function toggleEstimates() {
            const hideEstimates = document.getElementById('hideEstimates').checked;
            debugLog(`Toggle estimates filter: ${hideEstimates}`, 'info');

            const filteredData = hideEstimates
                ? tableData.filter(row => row.statusname !== 'Estimate')
                : tableData;

            debugLog(`Showing ${filteredData.length} of ${tableData.length} orders`, 'info');
            table.setData(filteredData);
            updateFilterInfo(tableData.length, filteredData.length);
        }

        // Update filter info display
        function updateFilterInfo(total, filtered) {
            const filterInfo = document.getElementById('filterInfo');
            if (total !== filtered) {
                filterInfo.textContent = `Showing ${filtered} of ${total} orders`;
                filterInfo.style.display = 'inline-block';
            } else {
                filterInfo.style.display = 'none';
            }
        }

        // Reset columns to default state
        function resetColumns() {
            if (confirm('Reset columns to default layout? This will clear saved preferences.')) {
                // Clear persistence
                localStorage.removeItem('tabulator-openSalesOrdersTable-columns');
                localStorage.removeItem('tabulator-openSalesOrdersTable-sort');
                localStorage.removeItem('tabulator-openSalesOrdersTable-filter');

                // Reload page to reset
                location.reload();
            }
        }

        // Clear all filters
        function clearFilters() {
            table.clearFilter();
            table.clearHeaderFilter();
            document.getElementById('hideEstimates').checked = false;
            loadData();
        }

        // Open sales order (placeholder - implement based on your system)
        function openSO(soNum) {
            alert('Open SO: ' + soNum + '\n\nImplement this to open the SO in Fishbowl or your system.');
            // Example: window.open('fishbowl://so/' + soNum);
        }

        // Catch any JavaScript errors
        window.onerror = function(message, source, lineno, colno, error) {
            debugLog(`JavaScript Error: ${message}`, 'error');
            debugLog(`  at ${source}:${lineno}:${colno}`, 'error');
            if (error && error.stack) {
                debugLog(`  Stack: ${error.stack}`, 'error');
            }
            return false; // Let default error handler run
        };

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', function() {
            try {
                // Show/hide debug console based on DEBUG_MODE
                if (DEBUG_MODE) {
                    document.getElementById('debugConsole').style.display = 'block';
                    debugLog('Debug mode enabled', 'info');
                    debugLog(`Date format: ${FB_DATE_FORMAT} (Fishbowl) -> ${MOMENT_DATE_FORMAT} (moment.js)`, 'info');

                    // Check if libraries are loaded
                    debugLog(`Checking libraries...`, 'info');
                    debugLog(`  - Tabulator: ${typeof Tabulator !== 'undefined' ? 'loaded' : 'NOT LOADED'}`, typeof Tabulator !== 'undefined' ? 'success' : 'error');
                    debugLog(`  - moment: ${typeof moment !== 'undefined' ? 'loaded' : 'NOT LOADED'}`, typeof moment !== 'undefined' ? 'success' : 'error');
                    debugLog(`  - getProperty: ${typeof getProperty !== 'undefined' ? 'loaded' : 'NOT LOADED'}`, typeof getProperty !== 'undefined' ? 'success' : 'error');
                    debugLog(`  - runQuery: ${typeof runQuery !== 'undefined' ? 'loaded' : 'NOT LOADED'}`, typeof runQuery !== 'undefined' ? 'success' : 'error');

                    debugLog('Initializing table...', 'info');
                }

                initTable();
                debugLog('Table initialized', 'success');

                loadData();
            } catch (error) {
                debugLog(`FATAL ERROR during initialization: ${error.message}`, 'error');
                debugLog(`Stack: ${error.stack}`, 'error');
                alert('Fatal error during initialization. See debug console.');
            }
        });

        // Right-click on table header to show column visibility menu
        document.addEventListener('contextmenu', function(e) {
            // Tabulator already handles this via headerMenu
        });
    </script>
</body>
</html>
