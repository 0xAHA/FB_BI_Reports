<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Adjustment Helper</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 6px;
        }
        .section.out {
            border-color: #ff6b6b;
            background-color: #fff5f5;
        }
        .section.in {
            border-color: #51cf66;
            background-color: #f4fdf7;
        }
        .section h2 {
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 2px solid currentColor;
        }
        .section.out h2 {
            color: #c92a2a;
        }
        .section.in h2 {
            color: #2b8a3e;
        }
        .item-row {
            display: grid;
            grid-template-columns: 1fr 200px 150px 100px 80px 50px;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        .locationgroup-selector {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #e7f5ff;
            border: 2px solid #4dabf7;
            border-radius: 6px;
        }
        .locationgroup-selector h3 {
            margin-top: 0;
            color: #1971c2;
            font-size: 16px;
        }
        .locationgroup-selector select {
            width: 100%;
            max-width: 400px;
            padding: 10px;
            border: 1px solid #4dabf7;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            background-color: white;
        }
        .item-row label {
            font-weight: bold;
            font-size: 12px;
            color: #666;
            margin-bottom: 3px;
            display: block;
        }
        .item-row select,
        .item-row input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        .item-row select:focus,
        .item-row input:focus {
            outline: none;
            border-color: #4dabf7;
            box-shadow: 0 0 0 3px rgba(77, 171, 247, 0.1);
        }
        .add-btn,
        .remove-btn,
        .export-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s;
        }
        .add-btn {
            background-color: #4dabf7;
            color: white;
            margin-top: 10px;
        }
        .add-btn:hover {
            background-color: #339af0;
        }
        .remove-btn {
            background-color: #fa5252;
            color: white;
            width: 40px;
            height: 40px;
        }
        .remove-btn:hover {
            background-color: #e03131;
        }
        .export-btn {
            background-color: #51cf66;
            color: white;
            padding: 12px 30px;
            font-size: 16px;
            margin: 10px auto;
            display: block;
        }
        .export-btn:hover {
            background-color: #40c057;
        }
        .export-btn:disabled {
            background-color: #adb5bd;
            cursor: not-allowed;
        }
        .metadata-fields {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        .metadata-fields h3 {
            margin-top: 0;
            font-size: 14px;
            color: #495057;
        }
        .metadata-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-top: 10px;
        }
        .metadata-row label {
            font-weight: bold;
            font-size: 12px;
            color: #666;
            margin-bottom: 3px;
            display: block;
        }
        .metadata-row input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        .preview-section {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 6px;
        }
        .preview-section h2 {
            margin-top: 0;
            color: #495057;
            font-size: 18px;
        }
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            margin-top: 15px;
            font-size: 13px;
        }
        .preview-table th {
            background-color: #495057;
            color: white;
            padding: 10px;
            text-align: left;
            font-weight: bold;
            border: 1px solid #dee2e6;
        }
        .preview-table td {
            padding: 8px 10px;
            border: 1px solid #dee2e6;
        }
        .preview-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        .preview-table tr:hover {
            background-color: #e9ecef;
        }
        .preview-table .negative {
            color: #c92a2a;
            font-weight: bold;
        }
        .preview-table .positive {
            color: #2b8a3e;
            font-weight: bold;
        }
        .empty-preview {
            text-align: center;
            padding: 40px;
            color: #868e96;
            font-style: italic;
        }
        .cost-summary {
            margin-top: 20px;
            padding: 20px;
            background-color: #fff;
            border: 2px solid #dee2e6;
            border-radius: 6px;
        }
        .cost-summary h3 {
            margin-top: 0;
            color: #495057;
        }
        .cost-row {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            font-size: 16px;
        }
        .cost-row.out {
            background-color: #fff5f5;
            border-left: 4px solid #ff6b6b;
        }
        .cost-row.in {
            background-color: #f4fdf7;
            border-left: 4px solid #51cf66;
        }
        .cost-row.discrepancy {
            background-color: #fff9db;
            border-left: 4px solid #fab005;
            font-weight: bold;
            font-size: 18px;
        }
        .cost-row.discrepancy.negative {
            background-color: #ffe3e3;
            border-left-color: #ff6b6b;
        }
        .cost-row.discrepancy.positive {
            background-color: #d3f9d8;
            border-left-color: #51cf66;
        }
        .cost-label {
            font-weight: bold;
        }
        .cost-value {
            font-family: monospace;
        }
        /* Searchable autocomplete styles */
        .autocomplete-container {
            position: relative;
            width: 100%;
        }
        .autocomplete-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .autocomplete-input:focus {
            outline: none;
            border-color: #4dabf7;
            box-shadow: 0 0 0 3px rgba(77, 171, 247, 0.1);
        }
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 250px;
            overflow-y: auto;
            background: white;
            border: 1px solid #4dabf7;
            border-top: none;
            border-radius: 0 0 4px 4px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none;
        }
        .autocomplete-dropdown.show {
            display: block;
        }
        .autocomplete-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 13px;
            border-bottom: 1px solid #f1f3f5;
        }
        .autocomplete-item:last-child {
            border-bottom: none;
        }
        .autocomplete-item:hover,
        .autocomplete-item.highlighted {
            background-color: #e7f5ff;
        }
        .autocomplete-item .part-num {
            font-weight: bold;
            color: #1971c2;
        }
        .autocomplete-item .part-desc {
            color: #666;
            font-size: 12px;
            margin-left: 8px;
        }
        .autocomplete-no-results {
            padding: 12px;
            color: #868e96;
            font-style: italic;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Inventory Adjustment Helper</h1>
        <p style="text-align: center; color: #666; margin-top: -10px;">
            Remove inventory via Cycle Count ‚Ä¢ Add inventory via Add Inventory
        </p>

        <div class="locationgroup-selector">
            <h3>üìç Location Group Filter</h3>
            <select id="locationGroupSelector" onchange="onLocationGroupChange()">
                <option value="">-- Select Location Group --</option>
            </select>
        </div>

        <div class="section out">
            <h2>üîª Items to Remove (Cycle Count)</h2>
            <div id="outItems">
                <!-- Items will be added here dynamically -->
            </div>
            <button class="add-btn" onclick="addOutItem()">+ Add Item to Remove</button>
        </div>

        <div class="section in">
            <h2>üî∫ Items to Add (Add Inventory)</h2>
            <div id="inItems">
                <!-- Items will be added here dynamically -->
            </div>
            <button class="add-btn" onclick="addInItem()">+ Add Item to Add</button>
        </div>

        <div class="metadata-fields">
            <h3>Additional Information (Optional)</h3>
            <div class="metadata-row">
                <div>
                    <label>Date</label>
                    <input type="date" id="adjustmentDate" onchange="updatePreview()" />
                </div>
                <div>
                    <label>QB Class</label>
                    <input type="text" id="qbclass" placeholder="QuickBooks class (optional)" oninput="updatePreview()" />
                </div>
                <div>
                    <label>Note</label>
                    <input type="text" id="note" placeholder="Add a note (optional)" oninput="updatePreview()" />
                </div>
            </div>
        </div>

        <div class="preview-section">
            <h2>üìã Preview</h2>
            <div id="previewContainer">
                <div class="empty-preview">Add items above to see preview</div>
            </div>

            <div class="cost-summary" id="costSummary" style="display: none;">
                <h3>üí∞ Cost Summary</h3>
                <div class="cost-row out">
                    <span class="cost-label">Total Cost OUT (Cycle Count):</span>
                    <span class="cost-value" id="totalCostOut">$0.00</span>
                </div>
                <div class="cost-row in">
                    <span class="cost-label">Total Cost IN (Add Inventory):</span>
                    <span class="cost-value" id="totalCostIn">$0.00</span>
                </div>
                <div class="cost-row discrepancy" id="discrepancyRow">
                    <span class="cost-label">Cost Discrepancy:</span>
                    <span class="cost-value" id="costDiscrepancy">$0.00</span>
                </div>

                <div style="text-align: center; margin-top: 15px;">
                    <button class="add-btn" onclick="autoApportionDiscrepancy()" style="background-color: #fab005; font-size: 14px; padding: 10px 20px;">‚ö° Auto-Apportion Discrepancy to IN Items</button>
                </div>
            </div>
        </div>

        <div style="display: flex; gap: 10px; justify-content: center; margin-top: 30px;">
            <button class="export-btn" onclick="importToFishbowl()" id="importBtn" style="margin: 0; background-color: #228be6; font-size: 18px; padding: 15px 40px;">Import to Fishbowl</button>
        </div>

        <div id="importStatus" style="margin-top: 15px; text-align: center; display: none;">
            <div id="importMessage" style="padding: 15px; border-radius: 6px; font-weight: bold;"></div>
        </div>
    </div>

    <script>
    let outItemCounter = 0;
    let inItemCounter = 0;
    let partsWithStock = [];  // For OUT items - only parts with inventory
    let allParts = [];        // For IN items - all active parts
    let locationGroups = [];
    let selectedLocationGroupId = null;
    let user = JSON.parse(getUser());
    let currentUser = user.id;

    // Load location groups
    function loadLocationGroups() {
        try {
            let query = `SELECT id, name FROM locationgroup WHERE activeflag = 1 ORDER BY name`;
            locationGroups = JSON.parse(runQuery(query));

            let selector = document.getElementById('locationGroupSelector');
            selector.innerHTML = '<option value="">-- Select Location Group --</option>';
            locationGroups.forEach(function(lg) {
                selector.innerHTML += '<option value="' + lg.id + '">' + lg.name + '</option>';
            });

            // Default select location group id 1
            selector.value = '1';
            selectedLocationGroupId = 1;
            loadParts();

            // Add initial rows
            addOutItem();
            addInItem();
        } catch(e) {
            console.error('Error loading location groups:', e);
            alert('Error loading location groups: ' + e.message);
        }
    }

    // Handle location group change
    function onLocationGroupChange() {
        let selector = document.getElementById('locationGroupSelector');
        selectedLocationGroupId = selector.value ? parseInt(selector.value) : null;

        // Clear existing items
        document.getElementById('outItems').innerHTML = '';
        document.getElementById('inItems').innerHTML = '';
        outItemCounter = 0;
        inItemCounter = 0;

        // Reload parts for selected location group
        if (selectedLocationGroupId) {
            loadParts();
            addOutItem();
            addInItem();
        } else {
            parts = [];
        }
        updatePreview();
    }

    // Load parts list filtered by location group (with average cost)
    function loadParts() {
        try {
            if (!selectedLocationGroupId) {
                partsWithStock = [];
                allParts = [];
                return;
            }

            console.log('Loading parts for location group:', selectedLocationGroupId);

            // Get parts WITH inventory (for OUT items)
            let queryWithStock = `SELECT DISTINCT
                part.num as partnum,
                part.description as partdescription,
                part.id as partid,
                uom.code as uom,
                COALESCE(pc.avgcost, 0) as avgcost
            FROM part
            INNER JOIN uom ON part.uomid = uom.id
            INNER JOIN qtyonhand qoh ON part.id = qoh.partid
            LEFT JOIN partcost pc ON part.id = pc.partid
            WHERE part.activeflag = 1
            AND qoh.locationgroupid = ${selectedLocationGroupId}
            AND qoh.qty > 0
            ORDER BY part.num`;

            let resultWithStock = runQuery(queryWithStock);
            partsWithStock = resultWithStock ? JSON.parse(resultWithStock) : [];

            // Ensure partsWithStock is always an array
            if (!partsWithStock) {
                partsWithStock = [];
            } else if (!Array.isArray(partsWithStock)) {
                partsWithStock = [partsWithStock];
            }

            console.log('Loaded ' + partsWithStock.length + ' parts with inventory in location group');

            // Get ALL active parts (for IN items - no stock requirement)
            let queryAllParts = `SELECT DISTINCT
                part.num as partnum,
                part.description as partdescription,
                part.id as partid,
                uom.code as uom,
                COALESCE(pc.avgcost, 0) as avgcost
            FROM part
            INNER JOIN uom ON part.uomid = uom.id
            LEFT JOIN partcost pc ON part.id = pc.partid
            WHERE part.activeflag = 1
            ORDER BY part.num`;

            let resultAllParts = runQuery(queryAllParts);
            allParts = resultAllParts ? JSON.parse(resultAllParts) : [];

            // Ensure allParts is always an array
            if (!allParts) {
                allParts = [];
            } else if (!Array.isArray(allParts)) {
                allParts = [allParts];
            }

            console.log('Loaded ' + allParts.length + ' total active parts');
        } catch(e) {
            console.error('Error loading parts:', e);
            alert('Error loading parts: ' + e.message);
            partsWithStock = [];
            allParts = [];
        }
    }

    // Create autocomplete HTML for part selection
    function createPartAutocomplete(inputId, type) {
        return `
            <div class="autocomplete-container">
                <input type="text"
                    id="${inputId}"
                    class="autocomplete-input"
                    placeholder="Type to search parts..."
                    autocomplete="off"
                    data-partnum=""
                    data-uom=""
                    data-avgcost="0"
                    data-description=""
                />
                <div id="${inputId}-dropdown" class="autocomplete-dropdown"></div>
            </div>
        `;
    }

    // Initialize autocomplete for a part input
    function initPartAutocomplete(inputId, type, counter) {
        let input = document.getElementById(inputId);
        let dropdown = document.getElementById(inputId + '-dropdown');
        let partsList = type === 'out' ? partsWithStock : allParts;
        let highlightedIndex = -1;

        // Filter and show dropdown
        function showDropdown(filter) {
            let filtered = partsList.filter(function(part) {
                let searchText = (part.partnum + ' ' + part.partdescription).toLowerCase();
                return searchText.includes(filter.toLowerCase());
            });

            if (filtered.length === 0) {
                dropdown.innerHTML = '<div class="autocomplete-no-results">No parts found</div>';
            } else {
                // Limit to first 50 results for performance
                let limited = filtered.slice(0, 50);
                dropdown.innerHTML = limited.map(function(part, index) {
                    return '<div class="autocomplete-item" data-index="' + index + '" data-partnum="' + part.partnum + '" data-uom="' + part.uom + '" data-avgcost="' + part.avgcost + '" data-description="' + part.partdescription + '">' +
                        '<span class="part-num">' + part.partnum + '</span>' +
                        '<span class="part-desc">' + part.partdescription + '</span>' +
                    '</div>';
                }).join('');

                if (filtered.length > 50) {
                    dropdown.innerHTML += '<div class="autocomplete-no-results">Showing first 50 of ' + filtered.length + ' results. Type more to filter.</div>';
                }
            }

            dropdown.classList.add('show');
            highlightedIndex = -1;
        }

        // Hide dropdown
        function hideDropdown() {
            dropdown.classList.remove('show');
            highlightedIndex = -1;
        }

        // Select a part
        function selectPart(partnum, uom, avgcost, description) {
            input.value = partnum + ' - ' + description;
            input.setAttribute('data-partnum', partnum);
            input.setAttribute('data-uom', uom);
            input.setAttribute('data-avgcost', avgcost);
            input.setAttribute('data-description', description);
            hideDropdown();
            onPartSelectedFromAutocomplete(type, counter, partnum, uom, avgcost, description);
        }

        // Update highlight
        function updateHighlight() {
            let items = dropdown.querySelectorAll('.autocomplete-item');
            items.forEach(function(item, index) {
                if (index === highlightedIndex) {
                    item.classList.add('highlighted');
                    item.scrollIntoView({ block: 'nearest' });
                } else {
                    item.classList.remove('highlighted');
                }
            });
        }

        // Input event handlers
        input.addEventListener('input', function() {
            let value = this.value.trim();
            if (value.length >= 1) {
                showDropdown(value);
            } else {
                showDropdown('');
            }
        });

        input.addEventListener('focus', function() {
            showDropdown(this.value.trim());
        });

        input.addEventListener('blur', function() {
            // Delay to allow click on dropdown item
            setTimeout(hideDropdown, 200);
        });

        input.addEventListener('keydown', function(e) {
            let items = dropdown.querySelectorAll('.autocomplete-item');

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (highlightedIndex < items.length - 1) {
                    highlightedIndex++;
                    updateHighlight();
                }
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (highlightedIndex > 0) {
                    highlightedIndex--;
                    updateHighlight();
                }
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (highlightedIndex >= 0 && items[highlightedIndex]) {
                    let item = items[highlightedIndex];
                    selectPart(
                        item.getAttribute('data-partnum'),
                        item.getAttribute('data-uom'),
                        item.getAttribute('data-avgcost'),
                        item.getAttribute('data-description')
                    );
                }
            } else if (e.key === 'Escape') {
                hideDropdown();
            }
        });

        // Click handler for dropdown items
        dropdown.addEventListener('click', function(e) {
            let item = e.target.closest('.autocomplete-item');
            if (item) {
                selectPart(
                    item.getAttribute('data-partnum'),
                    item.getAttribute('data-uom'),
                    item.getAttribute('data-avgcost'),
                    item.getAttribute('data-description')
                );
            }
        });
    }

    // Handle part selection from autocomplete
    function onPartSelectedFromAutocomplete(type, counter, partNum, uom, avgCost, description) {
        // Update UOM
        let uomInput = document.getElementById(type + '-uom-' + counter);
        if (uomInput) {
            uomInput.value = uom;
        }

        // Update Cost
        let costInput = document.getElementById(type + '-cost-' + counter);
        if (costInput) {
            if (type === 'out') {
                // For OUT items, cost is readonly display
                costInput.value = '$' + parseFloat(avgCost).toFixed(2);
            } else {
                // For IN items, cost is editable number input
                costInput.value = parseFloat(avgCost).toFixed(2);
                // Store original average cost for comparison
                costInput.setAttribute('data-original-cost', parseFloat(avgCost).toFixed(2));
            }
        }

        // Set quantity to 1
        let qtyInput = document.getElementById(type + '-qty-' + counter);
        if (qtyInput && partNum) {
            qtyInput.value = '1';
        }

        // Load locations for this part
        if (partNum) {
            loadLocationsForPart(partNum, type + '-loc-' + counter, type);
        }

        updatePreview();
    }

    // Load locations with stock for a specific part
    function loadLocationsForPart(partNum, locationSelectId, type) {
        try {
            if (!partNum || !selectedLocationGroupId) return;

            if (type === 'in') {
                // For Adjust IN: Get all locations and determine the default
                let locationSelect = document.getElementById(locationSelectId);
                let defaultLocationValue = null;

                // First, check if part has a default location in this location group
                let defaultQuery = `SELECT
                    CASE
                        WHEN COALESCE(lg.name, '') != '' AND COALESCE(loc.name, '') != '' THEN CONCAT(lg.name, '-', loc.name)
                        WHEN COALESCE(lg.name, '') != '' THEN lg.name
                        WHEN COALESCE(loc.name, '') != '' THEN loc.name
                        ELSE ''
                    END as location
                FROM part
                INNER JOIN defaultlocation dl ON part.id = dl.partid
                INNER JOIN location loc ON dl.locationid = loc.id
                INNER JOIN locationgroup lg ON dl.locationgroupid = lg.id
                WHERE part.num = '${partNum}'
                AND dl.locationgroupid = ${selectedLocationGroupId}`;

                let defaultResult = runQuery(defaultQuery);
                let defaultLocations = JSON.parse(defaultResult);

                if (defaultLocations && !Array.isArray(defaultLocations)) {
                    defaultLocations = [defaultLocations];
                }

                if (defaultLocations && defaultLocations.length > 0 && defaultLocations[0].location) {
                    defaultLocationValue = defaultLocations[0].location;
                } else {
                    // No part default - try to find the stock type location for this location group
                    let stockLocQuery = `SELECT
                        CASE
                            WHEN COALESCE(lg.name, '') != '' AND COALESCE(loc.name, '') != '' THEN CONCAT(lg.name, '-', loc.name)
                            WHEN COALESCE(lg.name, '') != '' THEN lg.name
                            WHEN COALESCE(loc.name, '') != '' THEN loc.name
                            ELSE 'Unknown Location'
                        END as location
                    FROM location loc
                    INNER JOIN locationgroup lg ON loc.locationgroupid = lg.id
                    WHERE lg.id = ${selectedLocationGroupId}
                    AND loc.typeid = 10
                    AND loc.activeflag = 1
                    LIMIT 1`;

                    let stockLocResult = runQuery(stockLocQuery);
                    let stockLocations = JSON.parse(stockLocResult);

                    if (stockLocations && !Array.isArray(stockLocations)) {
                        stockLocations = [stockLocations];
                    }

                    if (stockLocations && stockLocations.length > 0 && stockLocations[0].location) {
                        defaultLocationValue = stockLocations[0].location;
                    }
                }

                // Get ALL locations in this location group
                let allLocQuery = `SELECT DISTINCT
                    lg.name as locationgroupname,
                    loc.name as locationname,
                    CASE
                        WHEN COALESCE(lg.name, '') != '' AND COALESCE(loc.name, '') != '' THEN CONCAT(lg.name, '-', loc.name)
                        WHEN COALESCE(lg.name, '') != '' THEN lg.name
                        WHEN COALESCE(loc.name, '') != '' THEN loc.name
                        ELSE 'Unknown Location'
                    END as location
                FROM location loc
                INNER JOIN locationgroup lg ON loc.locationgroupid = lg.id
                WHERE lg.id = ${selectedLocationGroupId}
                AND loc.activeflag = 1
                ORDER BY loc.name`;

                let allLocsResult = runQuery(allLocQuery);
                let allLocations = JSON.parse(allLocsResult);

                if (allLocations && !Array.isArray(allLocations)) {
                    allLocations = [allLocations];
                }

                // Build dropdown with all locations, marking the default
                locationSelect.innerHTML = '';
                if (allLocations && allLocations.length > 0) {
                    allLocations.forEach(function(loc) {
                        let isDefault = (loc.location === defaultLocationValue);
                        let label = isDefault ? loc.location + ' (Default)' : loc.location;
                        locationSelect.innerHTML += '<option value="' + loc.location + '">' + label + '</option>';
                    });
                    // Select the default location, or first if no default
                    locationSelect.value = defaultLocationValue || allLocations[0].location;
                } else {
                    locationSelect.innerHTML = '<option value="">-- No Locations Available --</option>';
                }
            } else {
                // For Adjust OUT: Show only locations with stock
                let query = `SELECT
                    lg.name as locationgroupname,
                    loc.name as locationname,
                    CASE
                        WHEN COALESCE(lg.name, '') != '' AND COALESCE(loc.name, '') != '' THEN CONCAT(lg.name, '-', loc.name)
                        WHEN COALESCE(lg.name, '') != '' THEN lg.name
                        WHEN COALESCE(loc.name, '') != '' THEN loc.name
                        ELSE 'Unknown Location'
                    END as location,
                    SUM(qoh.qty) as qty
                FROM part
                INNER JOIN QOHVIEW qoh ON part.id = qoh.partid
                INNER JOIN location loc ON qoh.locationid = loc.id
                INNER JOIN locationgroup lg ON qoh.locationgroupid = lg.id
                WHERE part.num = '${partNum}'
                AND qoh.locationgroupid = ${selectedLocationGroupId}
                AND qoh.qty > 0
                GROUP BY lg.name, loc.name
                ORDER BY SUM(qoh.qty) DESC`;

                let queryResult = runQuery(query);
                let locations = JSON.parse(queryResult);

                if (locations && !Array.isArray(locations)) {
                    locations = [locations];
                }

                let locationSelect = document.getElementById(locationSelectId);
                locationSelect.innerHTML = '<option value="">-- Select Location --</option>';

                if (locations && locations.length > 0) {
                    locations.forEach(function(loc) {
                        locationSelect.innerHTML += '<option value="' + loc.location + '">' + loc.location + ' (Qty: ' + loc.qty + ')</option>';
                    });
                    locationSelect.value = locations[0].location;
                }
            }

            updatePreview();
        } catch(e) {
            console.error('Error loading locations for part:', e);
            alert('Error loading locations: ' + e.message);
        }
    }

    // Add OUT item row
    function addOutItem() {
        outItemCounter++;
        let container = document.getElementById('outItems');
        let row = document.createElement('div');
        row.className = 'item-row';
        row.id = 'out-' + outItemCounter;
        row.innerHTML = `
            <div>
                <label>Part Number</label>
                ${createPartAutocomplete('out-part-' + outItemCounter, 'out')}
            </div>
            <div>
                <label>Location</label>
                <select id="out-loc-${outItemCounter}" onchange="updatePreview()">
                    <option value="">-- Select Part First --</option>
                </select>
            </div>
            <div>
                <label>Quantity</label>
                <input type="number" id="out-qty-${outItemCounter}" min="0" step="1" value="" placeholder="Qty" oninput="updatePreview()" />
            </div>
            <div>
                <label>Avg Cost</label>
                <input type="text" id="out-cost-${outItemCounter}" readonly style="background-color: #f1f3f5;" />
            </div>
            <div>
                <label>UOM</label>
                <input type="text" id="out-uom-${outItemCounter}" readonly style="background-color: #f1f3f5;" />
            </div>
            <div>
                <label>&nbsp;</label>
                <button class="remove-btn" onclick="removeItem('out-${outItemCounter}')">√ó</button>
            </div>
        `;
        container.appendChild(row);
        // Initialize autocomplete for this row
        initPartAutocomplete('out-part-' + outItemCounter, 'out', outItemCounter);
    }

    // Add IN item row
    function addInItem() {
        inItemCounter++;
        let container = document.getElementById('inItems');
        let row = document.createElement('div');
        row.className = 'item-row';
        row.id = 'in-' + inItemCounter;
        row.innerHTML = `
            <div>
                <label>Part Number</label>
                ${createPartAutocomplete('in-part-' + inItemCounter, 'in')}
            </div>
            <div>
                <label>Location</label>
                <select id="in-loc-${inItemCounter}" onchange="updatePreview()">
                    <option value="">-- Select Part First --</option>
                </select>
            </div>
            <div>
                <label>Quantity</label>
                <input type="number" id="in-qty-${inItemCounter}" min="0" step="1" value="" placeholder="Qty" oninput="updatePreview()" />
            </div>
            <div>
                <label>Cost</label>
                <input type="number" id="in-cost-${inItemCounter}" data-original-cost="0" min="0" step="0.01" value="" placeholder="Cost" oninput="updatePreview()" />
            </div>
            <div>
                <label>UOM</label>
                <input type="text" id="in-uom-${inItemCounter}" readonly style="background-color: #f1f3f5;" />
            </div>
            <div>
                <label>&nbsp;</label>
                <button class="remove-btn" onclick="removeItem('in-${inItemCounter}')">√ó</button>
            </div>
        `;
        container.appendChild(row);
        // Initialize autocomplete for this row
        initPartAutocomplete('in-part-' + inItemCounter, 'in', inItemCounter);
    }


    // Remove item row
    function removeItem(rowId) {
        let row = document.getElementById(rowId);
        if (row) {
            row.remove();
            updatePreview();
        }
    }

    // Auto-apportion discrepancy to IN items proportionally
    function autoApportionDiscrepancy() {
        try {
            // Collect OUT items to calculate total OUT cost
            let outItems = [];
            document.getElementById('outItems').querySelectorAll('.item-row').forEach(function(row) {
                let partInput = row.querySelector('.autocomplete-input');
                let qtyInput = row.querySelector('input[type="number"]');
                let partNum = partInput.getAttribute('data-partnum') || '';
                let qty = parseFloat(qtyInput.value) || 0;
                let avgCost = parseFloat(partInput.getAttribute('data-avgcost')) || 0;

                if (partNum && qty > 0) {
                    outItems.push({
                        qty: qty,
                        avgcost: avgCost
                    });
                }
            });

            // Collect IN items with their row IDs to update later
            let inItemsData = [];
            document.getElementById('inItems').querySelectorAll('.item-row').forEach(function(row) {
                let partInput = row.querySelector('.autocomplete-input');
                let locationSelect = row.querySelector('select');
                let inputs = row.querySelectorAll('input[type="number"]');
                let qtyInput = inputs[0];
                let costInput = inputs[1];
                let partNum = partInput.getAttribute('data-partnum') || '';
                let location = locationSelect.value;
                let qty = parseFloat(qtyInput.value) || 0;
                let cost = parseFloat(costInput.value) || 0;

                if (partNum && qty > 0 && location) {
                    inItemsData.push({
                        costInput: costInput,
                        qty: qty,
                        cost: cost,
                        totalCost: qty * cost
                    });
                }
            });

            if (inItemsData.length === 0) {
                alert('No IN items to apportion. Please add items to add to inventory.');
                return;
            }

            // Calculate total costs
            let totalCostOut = 0;
            outItems.forEach(function(item) {
                totalCostOut += item.qty * item.avgcost;
            });

            let totalCostIn = 0;
            inItemsData.forEach(function(item) {
                totalCostIn += item.totalCost;
            });

            let discrepancy = totalCostIn - totalCostOut;

            if (totalCostIn === 0) {
                alert('Total IN cost is zero. Cannot apportion discrepancy.');
                return;
            }

            // Distribute discrepancy proportionally based on each item's share of total IN cost
            inItemsData.forEach(function(item) {
                let proportion = item.totalCost / totalCostIn;
                let adjustment = discrepancy * proportion;
                let newTotalCost = item.totalCost - adjustment;
                let newUnitCost = newTotalCost / item.qty;

                // Update the cost input field
                item.costInput.value = newUnitCost.toFixed(2);
            });

            // Refresh the preview
            updatePreview();

            console.log('Auto-apportioned discrepancy of $' + discrepancy.toFixed(2) + ' across ' + inItemsData.length + ' IN items');

        } catch(e) {
            console.error('Error in autoApportionDiscrepancy:', e);
            alert('Error apportioning discrepancy: ' + e.message);
        }
    }

    // Update preview table
    function updatePreview() {
        try {
            let previewContainer = document.getElementById('previewContainer');
            if (!previewContainer) return;

            let metadata = {
                date: document.getElementById('adjustmentDate').value || '',
                qbclass: document.getElementById('qbclass').value || '',
                note: document.getElementById('note').value || ''
            };

            // Collect OUT items
            let outItems = [];
            document.getElementById('outItems').querySelectorAll('.item-row').forEach(function(row) {
                let partInput = row.querySelector('.autocomplete-input');
                let locationSelect = row.querySelector('select');
                let qtyInput = row.querySelector('input[type="number"]');
                let partNum = partInput.getAttribute('data-partnum') || '';
                let location = locationSelect.value;
                let qty = parseFloat(qtyInput.value) || 0;

                let avgCost = parseFloat(partInput.getAttribute('data-avgcost')) || 0;

                if (partNum && qty > 0 && location) {
                    outItems.push({
                        partnum: partNum,
                        description: partInput.getAttribute('data-description') || '',
                        location: location,
                        qty: qty,
                        avgcost: avgCost,
                        uom: partInput.getAttribute('data-uom') || ''
                    });
                }
            });

            // Collect IN items
            let inItems = [];
            document.getElementById('inItems').querySelectorAll('.item-row').forEach(function(row) {
                let partInput = row.querySelector('.autocomplete-input');
                let locationSelect = row.querySelector('select');
                let inputs = row.querySelectorAll('input[type="number"]');
                let qtyInput = inputs[0];  // First number input is quantity
                let costInput = inputs[1]; // Second number input is cost
                let partNum = partInput.getAttribute('data-partnum') || '';
                let location = locationSelect.value;
                let qty = parseFloat(qtyInput.value) || 0;
                let cost = parseFloat(costInput.value) || 0;
                let originalCost = parseFloat(costInput.getAttribute('data-original-cost')) || 0;

                if (partNum && qty > 0 && location) {
                    inItems.push({
                        partnum: partNum,
                        description: partInput.getAttribute('data-description') || '',
                        location: location,
                        qty: qty,
                        avgcost: cost,  // Use the editable cost value
                        originalCost: originalCost,  // Store original average cost
                        uom: partInput.getAttribute('data-uom') || ''
                    });
                }
            });

            if (outItems.length === 0 && inItems.length === 0) {
                previewContainer.innerHTML = '<div class="empty-preview">Add items above to see preview</div>';
                document.getElementById('costSummary').style.display = 'none';
                return;
            }

            // Calculate costs
            let totalCostOut = 0;
            let totalCostIn = 0;

            outItems.forEach(function(item) {
                totalCostOut += item.qty * item.avgcost;
            });

            inItems.forEach(function(item) {
                totalCostIn += item.qty * item.avgcost;
            });

            let discrepancy = totalCostIn - totalCostOut;

            // Build preview tables
            let html = '';

            if (outItems.length > 0) {
                html += '<h3 style="color: #c92a2a;">Items to Remove (Cycle Count)</h3>';
                html += '<table class="preview-table">';
                html += '<thead><tr><th>Part Number</th><th>Location</th><th>Qty</th><th>Avg Cost</th><th>Total Cost</th><th>UOM</th></tr></thead>';
                html += '<tbody>';
                outItems.forEach(function(item) {
                    html += '<tr>';
                    html += '<td>' + item.partnum + '</td>';
                    html += '<td>' + item.location + '</td>';
                    html += '<td class="negative">' + item.qty + '</td>';
                    html += '<td>$' + item.avgcost.toFixed(2) + '</td>';
                    html += '<td>$' + (item.qty * item.avgcost).toFixed(2) + '</td>';
                    html += '<td>' + item.uom + '</td>';
                    html += '</tr>';
                });
                html += '</tbody></table>';
            }

            if (inItems.length > 0) {
                html += '<h3 style="color: #2b8a3e; margin-top: 20px;">Items to Add (Add Inventory)</h3>';
                html += '<table class="preview-table">';
                html += '<thead><tr><th>Part Number</th><th>Location</th><th>Qty</th><th>Cost</th><th>Cost Variation</th><th>Total Cost</th><th>UOM</th></tr></thead>';
                html += '<tbody>';
                inItems.forEach(function(item) {
                    let costVariation = item.avgcost - item.originalCost;
                    let costVariationPct = item.originalCost > 0 ? (costVariation / item.originalCost * 100) : 0;
                    let variationColor = costVariation < 0 ? '#c92a2a' : (costVariation > 0 ? '#2b8a3e' : '#495057');
                    let variationText = '$' + costVariation.toFixed(2);
                    if (costVariationPct !== 0) {
                        variationText += ' (' + (costVariation > 0 ? '+' : '') + costVariationPct.toFixed(1) + '%)';
                    }

                    html += '<tr>';
                    html += '<td>' + item.partnum + '</td>';
                    html += '<td>' + item.location + '</td>';
                    html += '<td class="positive">' + item.qty + '</td>';
                    html += '<td>$' + item.avgcost.toFixed(2) + '</td>';
                    html += '<td style="color: ' + variationColor + '; font-weight: bold;">' + variationText + '</td>';
                    html += '<td>$' + (item.qty * item.avgcost).toFixed(2) + '</td>';
                    html += '<td>' + item.uom + '</td>';
                    html += '</tr>';
                });
                html += '</tbody></table>';
            }

            previewContainer.innerHTML = html;

            // Update cost summary
            document.getElementById('totalCostOut').textContent = '$' + totalCostOut.toFixed(2);
            document.getElementById('totalCostIn').textContent = '$' + totalCostIn.toFixed(2);
            document.getElementById('costDiscrepancy').textContent = '$' + discrepancy.toFixed(2);

            let discrepancyRow = document.getElementById('discrepancyRow');
            discrepancyRow.className = 'cost-row discrepancy';
            // Set background color: grey for $0.00, light orange for any other amount
            if (discrepancy === 0) {
                discrepancyRow.style.backgroundColor = '#e9ecef';
                discrepancyRow.style.borderLeftColor = '#868e96';
            } else {
                discrepancyRow.style.backgroundColor = '#fff4e6';
                discrepancyRow.style.borderLeftColor = '#fd7e14';
            }

            document.getElementById('costSummary').style.display = 'block';

        } catch(e) {
            console.error('Error in updatePreview:', e);
            alert('Error updating preview: ' + e.message);
        }
    }

    // Show import status message
    function showImportStatus(message, isSuccess) {
        let statusDiv = document.getElementById('importStatus');
        let messageDiv = document.getElementById('importMessage');

        messageDiv.textContent = message;
        messageDiv.style.backgroundColor = isSuccess ? '#d3f9d8' : '#ffe3e3';
        messageDiv.style.color = isSuccess ? '#2b8a3e' : '#c92a2a';
        messageDiv.style.border = '2px solid ' + (isSuccess ? '#51cf66' : '#ff6b6b');

        statusDiv.style.display = 'block';

        // Auto-hide after 10 seconds
        setTimeout(function() {
            statusDiv.style.display = 'none';
        }, 10000);
    }

    // Import to Fishbowl via API
    function importToFishbowl() {
        try {
            let metadata = {
                date: document.getElementById('adjustmentDate').value || '',
                qbclass: document.getElementById('qbclass').value || '',
                note: document.getElementById('note').value || ''
            };

            // Collect OUT items for Cycle Count
            let outItems = [];
            document.getElementById('outItems').querySelectorAll('.item-row').forEach(function(row) {
                let partInput = row.querySelector('.autocomplete-input');
                let locationSelect = row.querySelector('select');
                let qtyInput = row.querySelector('input[type="number"]');
                let partNum = partInput.getAttribute('data-partnum') || '';
                let location = locationSelect.value;
                let qty = parseFloat(qtyInput.value) || 0;

                if (partNum && qty > 0 && location) {
                    outItems.push({
                        partnum: partNum,
                        location: location,
                        qty: qty,
                        uom: partInput.getAttribute('data-uom') || ''
                    });
                }
            });

            // Collect IN items for Add Inventory
            let inItems = [];
            document.getElementById('inItems').querySelectorAll('.item-row').forEach(function(row) {
                let partInput = row.querySelector('.autocomplete-input');
                let locationSelect = row.querySelector('select');
                let inputs = row.querySelectorAll('input[type="number"]');
                let qtyInput = inputs[0];
                let costInput = inputs[1];
                let partNum = partInput.getAttribute('data-partnum') || '';
                let location = locationSelect.value;
                let qty = parseFloat(qtyInput.value) || 0;
                let cost = parseFloat(costInput.value) || 0;

                if (partNum && qty > 0 && location) {
                    inItems.push({
                        partnum: partNum,
                        description: partInput.getAttribute('data-description') || '',
                        location: location,
                        qty: qty,
                        cost: cost,
                        uom: partInput.getAttribute('data-uom') || ''
                    });
                }
            });

            if (outItems.length === 0 && inItems.length === 0) {
                alert('No items to import. Please add items to remove or add.');
                return;
            }

            // Disable button during import
            let importBtn = document.getElementById('importBtn');
            importBtn.disabled = true;
            importBtn.textContent = 'Importing...';

            let results = [];
            let errors = [];

            // Import Cycle Count (OUT items) first
            if (outItems.length > 0) {
                try {
                    // Build cycle count rows - need to query current qty and calculate new count
                    let cycleCountRows = [
                        '"PartNumber","Location","Qty","UOM","Date","Note","Customer"'
                    ];

                    outItems.forEach(function(item) {
                        let locationParts = item.location.split('-');
                        let locationGroupName = locationParts[0];
                        let locationName = locationParts.length > 1 ? locationParts[1] : '';

                        // Query current quantity
                        let qtyQuery = `SELECT SUM(qoh.qty) as currentqty
                        FROM part
                        INNER JOIN QOHVIEW qoh ON part.id = qoh.partid
                        INNER JOIN locationgroup lg ON qoh.locationgroupid = lg.id
                        LEFT JOIN location loc ON qoh.locationid = loc.id
                        WHERE part.num = '${item.partnum}'
                        AND lg.name = '${locationGroupName}'`;

                        if (locationName) {
                            qtyQuery += ` AND loc.name = '${locationName}'`;
                        }

                        let qtyResult = runQuery(qtyQuery);
                        let qtyData = JSON.parse(qtyResult);

                        if (Array.isArray(qtyData) && qtyData.length > 0) {
                            qtyData = qtyData[0];
                        }

                        let currentQty = (qtyData && qtyData.currentqty !== null && qtyData.currentqty !== undefined) ? parseFloat(qtyData.currentqty) : 0;
                        let actualCount = currentQty - item.qty;

                        cycleCountRows.push(
                            '"' + item.partnum + '",' +
                            '"' + item.location + '",' +
                            actualCount + ',' +
                            '"' + item.uom + '",' +
                            '"' + metadata.date + '",' +
                            '"' + metadata.note + '",' +
                            '""'
                        );
                    });

                    // Build API request for Cycle Count import
                    let cycleCountRequest = {
                        "FbiJson": {
                            "Ticket": {
                                "Key": ""
                            },
                            "FbiMsgsRq": {
                                "ImportRq": {
                                    "Type": "ImportCycleCount",
                                    "Rows": {
                                        "Row": cycleCountRows
                                    }
                                }
                            }
                        }
                    };

                    console.log('Cycle Count Request:', JSON.stringify(cycleCountRequest, null, 2));
                    let cycleCountResponse = runApiRequest(JSON.stringify(cycleCountRequest));
                    console.log('Cycle Count Response:', cycleCountResponse);

                    if (!cycleCountResponse) {
                        errors.push('Cycle Count import failed: No response from API');
                    } else {
                        let cycleCountResult = JSON.parse(cycleCountResponse);
                        console.log('Cycle Count Result:', cycleCountResult);

                        if (cycleCountResult && cycleCountResult.FbiJson && cycleCountResult.FbiJson.FbiMsgsRs &&
                            cycleCountResult.FbiJson.FbiMsgsRs.ImportRs &&
                            cycleCountResult.FbiJson.FbiMsgsRs.ImportRs.statusCode === 1000) {
                            results.push('Cycle Count: ' + outItems.length + ' items imported successfully');
                        } else {
                            let errorMsg = 'Cycle Count import failed';
                            if (cycleCountResult && cycleCountResult.FbiJson && cycleCountResult.FbiJson.FbiMsgsRs &&
                                cycleCountResult.FbiJson.FbiMsgsRs.ImportRs && cycleCountResult.FbiJson.FbiMsgsRs.ImportRs.statusMessage) {
                                errorMsg += ': ' + cycleCountResult.FbiJson.FbiMsgsRs.ImportRs.statusMessage;
                            } else {
                                errorMsg += ': ' + JSON.stringify(cycleCountResult);
                            }
                            errors.push(errorMsg);
                        }
                    }
                } catch (e) {
                    errors.push('Cycle Count import error: ' + e.message);
                }
            }

            // Import Add Inventory (IN items)
            if (inItems.length > 0) {
                try {
                    // Build add inventory rows
                    let addInventoryRows = [
                        '"PartNumber","PartDescription","Location","Qty","UOM","Cost","QBClass","Date","Note"'
                    ];

                    inItems.forEach(function(item) {
                        addInventoryRows.push(
                            '"' + item.partnum + '",' +
                            '"' + item.description + '",' +
                            '"' + item.location + '",' +
                            item.qty + ',' +
                            '"' + item.uom + '",' +
                            item.cost.toFixed(2) + ',' +
                            '"' + metadata.qbclass + '",' +
                            '"' + metadata.date + '",' +
                            '"' + metadata.note + '"'
                        );
                    });

                    // Build API request for Add Inventory import
                    let addInventoryRequest = {
                        "FbiJson": {
                            "Ticket": {
                                "Key": ""
                            },
                            "FbiMsgsRq": {
                                "ImportRq": {
                                    "Type": "ImportAddInventory",
                                    "Rows": {
                                        "Row": addInventoryRows
                                    }
                                }
                            }
                        }
                    };

                    console.log('Add Inventory Request:', JSON.stringify(addInventoryRequest, null, 2));
                    let addInventoryResponse = runApiRequest(JSON.stringify(addInventoryRequest));
                    console.log('Add Inventory Response:', addInventoryResponse);

                    if (!addInventoryResponse) {
                        errors.push('Add Inventory import failed: No response from API');
                    } else {
                        let addInventoryResult = JSON.parse(addInventoryResponse);
                        console.log('Add Inventory Result:', addInventoryResult);

                        if (addInventoryResult && addInventoryResult.FbiJson && addInventoryResult.FbiJson.FbiMsgsRs &&
                            addInventoryResult.FbiJson.FbiMsgsRs.ImportRs &&
                            addInventoryResult.FbiJson.FbiMsgsRs.ImportRs.statusCode === 1000) {
                            results.push('Add Inventory: ' + inItems.length + ' items imported successfully');
                        } else {
                            let errorMsg = 'Add Inventory import failed';
                            if (addInventoryResult && addInventoryResult.FbiJson && addInventoryResult.FbiJson.FbiMsgsRs &&
                                addInventoryResult.FbiJson.FbiMsgsRs.ImportRs && addInventoryResult.FbiJson.FbiMsgsRs.ImportRs.statusMessage) {
                                errorMsg += ': ' + addInventoryResult.FbiJson.FbiMsgsRs.ImportRs.statusMessage;
                            } else {
                                errorMsg += ': ' + JSON.stringify(addInventoryResult);
                            }
                            errors.push(errorMsg);
                        }
                    }
                } catch (e) {
                    errors.push('Add Inventory import error: ' + e.message);
                }
            }

            // Re-enable button
            importBtn.disabled = false;
            importBtn.textContent = 'Import to Fishbowl';

            // Show results
            if (errors.length === 0) {
                showImportStatus(results.join(' | '), true);

                // Clear items after successful import
                document.getElementById('outItems').innerHTML = '';
                document.getElementById('inItems').innerHTML = '';
                outItemCounter = 0;
                inItemCounter = 0;
                addOutItem();
                addInItem();
                updatePreview();
            } else {
                showImportStatus(errors.join(' | '), false);
            }

        } catch(e) {
            console.error('Error in importToFishbowl:', e);
            alert('Import failed: ' + e.message);

            // Re-enable button on error
            let importBtn = document.getElementById('importBtn');
            importBtn.disabled = false;
            importBtn.textContent = 'Import to Fishbowl';
        }
    }

    // Export Cycle Count CSV
    function exportCycleCount() {
        try {
            let metadata = {
                date: document.getElementById('adjustmentDate').value || '',
                note: document.getElementById('note').value || ''
            };

            // Collect OUT items
            let outItems = [];
            document.getElementById('outItems').querySelectorAll('.item-row').forEach(function(row) {
                let partInput = row.querySelector('.autocomplete-input');
                let locationSelect = row.querySelector('select');
                let qtyInput = row.querySelector('input[type="number"]');
                let partNum = partInput.getAttribute('data-partnum') || '';
                let location = locationSelect.value;
                let qty = parseFloat(qtyInput.value) || 0;

                if (partNum && qty > 0 && location) {
                    outItems.push({
                        partnum: partNum,
                        location: location,
                        qty: qty,
                        uom: partInput.getAttribute('data-uom') || ''
                    });
                }
            });

            if (outItems.length === 0) {
                alert('No OUT items to export. Please add items to remove.');
                return;
            }

            let timestamp = new Date().toISOString().split('T')[0];

            // Generate Cycle Count CSV for OUT items
                // Query current quantities
                let cycleCountData = [];
                outItems.forEach(function(item) {
                    let locationParts = item.location.split('-');
                    let locationGroupName = locationParts[0];
                    let locationName = locationParts.length > 1 ? locationParts[1] : '';

                    let qtyQuery = `SELECT SUM(qoh.qty) as currentqty
                    FROM part
                    INNER JOIN QOHVIEW qoh ON part.id = qoh.partid
                    INNER JOIN locationgroup lg ON qoh.locationgroupid = lg.id
                    LEFT JOIN location loc ON qoh.locationid = loc.id
                    WHERE part.num = '${item.partnum}'
                    AND lg.name = '${locationGroupName}'`;

                    if (locationName) {
                        qtyQuery += ` AND loc.name = '${locationName}'`;
                    }

                    let qtyResult = runQuery(qtyQuery);
                    let qtyData = JSON.parse(qtyResult);

                    if (Array.isArray(qtyData) && qtyData.length > 0) {
                        qtyData = qtyData[0];
                    }

                    let currentQty = (qtyData && qtyData.currentqty !== null && qtyData.currentqty !== undefined) ? parseFloat(qtyData.currentqty) : 0;
                    let actualCount = currentQty - item.qty;

                    cycleCountData.push({
                        PartNumber: item.partnum,
                        Location: item.location,
                        Qty: actualCount,
                        UOM: item.uom,
                        Date: metadata.date,
                        Note: metadata.note,
                        Customer: ''
                    });
                });

                let cycleCountCsv = 'PartNumber,Location,Qty,UOM,Date,Note,Customer\n';
                cycleCountData.forEach(function(row) {
                    cycleCountCsv += '"' + row.PartNumber + '",';
                    cycleCountCsv += '"' + row.Location + '",';
                    cycleCountCsv += row.Qty + ',';
                    cycleCountCsv += '"' + row.UOM + '",';
                    cycleCountCsv += '"' + row.Date + '",';
                    cycleCountCsv += '"' + row.Note + '",';
                    cycleCountCsv += '"' + row.Customer + '"\n';
                });

            // Download Cycle Count CSV
            let ccBlob = new Blob([cycleCountCsv], { type: 'text/csv' });
            let ccUrl = window.URL.createObjectURL(ccBlob);
            let ccLink = document.createElement('a');
            ccLink.href = ccUrl;
            ccLink.download = 'CycleCount_' + timestamp + '.csv';
            document.body.appendChild(ccLink);
            ccLink.click();
            document.body.removeChild(ccLink);
            window.URL.revokeObjectURL(ccUrl);

            console.log('Exported CycleCount_' + timestamp + '.csv with ' + outItems.length + ' items');

        } catch(e) {
            console.error('Error in exportCycleCount:', e);
            alert('Export failed: ' + e.message);
        }
    }

    // Export Add Inventory CSV
    function exportAddInventory() {
        try {
            let metadata = {
                date: document.getElementById('adjustmentDate').value || '',
                qbclass: document.getElementById('qbclass').value || '',
                note: document.getElementById('note').value || ''
            };

            // Collect IN items
            let inItems = [];
            document.getElementById('inItems').querySelectorAll('.item-row').forEach(function(row) {
                let partInput = row.querySelector('.autocomplete-input');
                let locationSelect = row.querySelector('select');
                let inputs = row.querySelectorAll('input[type="number"]');
                let qtyInput = inputs[0];  // First number input is quantity
                let costInput = inputs[1]; // Second number input is cost
                let partNum = partInput.getAttribute('data-partnum') || '';
                let location = locationSelect.value;
                let qty = parseFloat(qtyInput.value) || 0;
                let cost = parseFloat(costInput.value) || 0;
                let originalCost = parseFloat(costInput.getAttribute('data-original-cost')) || 0;

                if (partNum && qty > 0 && location) {
                    inItems.push({
                        partnum: partNum,
                        description: partInput.getAttribute('data-description') || '',
                        location: location,
                        qty: qty,
                        avgcost: cost,  // Use the editable cost value
                        originalCost: originalCost,  // Store original average cost
                        uom: partInput.getAttribute('data-uom') || ''
                    });
                }
            });

            if (inItems.length === 0) {
                alert('No IN items to export. Please add items to add to inventory.');
                return;
            }

            let timestamp = new Date().toISOString().split('T')[0];

            // Generate Add Inventory CSV
            let addInventoryCsv = 'PartNumber,PartDescription,Location,Qty,UOM,Cost,QbClass,Date,Note\n';
            inItems.forEach(function(item) {
                addInventoryCsv += '"' + item.partnum + '",';
                addInventoryCsv += '"' + item.description + '",';
                addInventoryCsv += '"' + item.location + '",';
                addInventoryCsv += item.qty + ',';
                addInventoryCsv += '"' + item.uom + '",';
                addInventoryCsv += item.avgcost.toFixed(2) + ',';
                addInventoryCsv += '"' + metadata.qbclass + '",';
                addInventoryCsv += '"' + metadata.date + '",';
                addInventoryCsv += '"' + metadata.note + '"\n';
            });

            // Download Add Inventory CSV
            let aiBlob = new Blob([addInventoryCsv], { type: 'text/csv' });
            let aiUrl = window.URL.createObjectURL(aiBlob);
            let aiLink = document.createElement('a');
            aiLink.href = aiUrl;
            aiLink.download = 'AddInventory_' + timestamp + '.csv';
            document.body.appendChild(aiLink);
            aiLink.click();
            document.body.removeChild(aiLink);
            window.URL.revokeObjectURL(aiUrl);

            console.log('Exported AddInventory_' + timestamp + '.csv with ' + inItems.length + ' items');

        } catch(e) {
            console.error('Error in exportAddInventory:', e);
            alert('Export failed: ' + e.message);
        }
    }

    // Initialize
    window.onload = function() {
        // Set default date to today
        document.getElementById('adjustmentDate').valueAsDate = new Date();
        // Load location groups
        loadLocationGroups();
    };
    </script>
</body>
</html>
