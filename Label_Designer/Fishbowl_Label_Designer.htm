<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fishbowl Label Designer</title>
<script src="https://cdn.jsdelivr.net/npm/bwip-js@4"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2/dist/jspdf.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',system-ui,sans-serif;height:100vh;display:grid;grid-template-rows:auto 1fr;grid-template-columns:250px 1fr 280px;grid-template-areas:"toolbar toolbar toolbar" "palette canvas properties";overflow:hidden;background:#e2e8f0;color:#1e293b}
#toolbar{grid-area:toolbar;background:#1e293b;color:#fff;display:flex;align-items:center;gap:4px;padding:6px 12px;flex-wrap:wrap;z-index:100}
#toolbar select,#toolbar button,#toolbar input[type=number]{background:#334155;color:#fff;border:1px solid #475569;border-radius:4px;padding:4px 8px;font-size:12px;font-family:inherit;cursor:pointer;height:28px}
#toolbar button:hover{background:#475569}
#toolbar .sep{width:1px;height:20px;background:#475569;margin:0 4px}
#toolbar label{font-size:11px;display:flex;align-items:center;gap:4px;cursor:pointer}
#toolbar input[type=checkbox]{cursor:pointer}
#palette-panel{grid-area:palette;background:#f8fafc;border-right:1px solid #cbd5e1;display:flex;flex-direction:column;overflow:hidden}
.panel-header{padding:10px 12px;font-weight:600;font-size:13px;background:#f1f5f9;border-bottom:1px solid #cbd5e1}
#field-search{margin:8px;padding:6px 10px;border:1px solid #cbd5e1;border-radius:4px;font-size:12px;font-family:inherit}
#field-list{flex:1;overflow-y:auto;padding:0 8px 8px}
.field-category{margin-top:8px}
.field-category-title{font-size:11px;font-weight:600;color:#64748b;text-transform:uppercase;padding:4px 8px;cursor:pointer;display:flex;align-items:center;gap:4px}
.field-category-title::before{content:'\25BC';font-size:8px;transition:transform .2s}
.field-category.collapsed .field-category-title::before{transform:rotate(-90deg)}
.field-category.collapsed .field-items{display:none}
.field-item{padding:5px 8px;margin:2px 0;background:#fff;border:1px solid #e2e8f0;border-radius:4px;font-size:12px;cursor:grab;display:flex;align-items:center;gap:6px;transition:all .15s}
.field-item:hover{background:#eff6ff;border-color:#93c5fd}
.field-item .fi-icon{width:18px;height:18px;background:#dbeafe;border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:10px;color:#3b82f6;flex-shrink:0}
.field-item .fi-name{font-family:'Courier New',monospace;font-size:11px;color:#64748b}
#add-custom-field{padding:8px;border-top:1px solid #cbd5e1;display:flex;gap:4px}
#add-custom-field input{flex:1;padding:4px 8px;border:1px solid #cbd5e1;border-radius:4px;font-size:12px;font-family:inherit}
#add-custom-field button{padding:4px 10px;background:#3b82f6;color:#fff;border:none;border-radius:4px;font-size:12px;cursor:pointer}
#canvas-area{grid-area:canvas;display:grid;grid-template-rows:24px 1fr;grid-template-columns:24px 1fr;overflow:hidden}
#ruler-corner{background:#f1f5f9;border-right:1px solid #cbd5e1;border-bottom:1px solid #cbd5e1}
#ruler-top{background:#f8fafc;border-bottom:1px solid #cbd5e1;overflow:hidden}
#ruler-left{background:#f8fafc;border-right:1px solid #cbd5e1;overflow:hidden}
#canvas-scroll{overflow:auto;background:#e2e8f0;display:flex;align-items:flex-start;justify-content:flex-start;padding:20px}
#canvas-container{flex-shrink:0;transform-origin:0 0;position:relative}
#canvas{background:#fff;position:relative;box-shadow:0 2px 8px rgba(0,0,0,.15);overflow:hidden}
.grid-overlay{position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none}
.canvas-element{position:absolute;cursor:move;user-select:none}
.canvas-element.selected{outline:2px solid #3b82f6;outline-offset:-1px}
.canvas-element .handle{position:absolute;width:8px;height:8px;background:#fff;border:2px solid #3b82f6;border-radius:1px;z-index:10;display:none}
.canvas-element.selected .handle{display:block}
.handle-nw{top:-4px;left:-4px;cursor:nw-resize}
.handle-n{top:-4px;left:50%;margin-left:-4px;cursor:n-resize}
.handle-ne{top:-4px;right:-4px;cursor:ne-resize}
.handle-e{top:50%;right:-4px;margin-top:-4px;cursor:e-resize}
.handle-se{bottom:-4px;right:-4px;cursor:se-resize}
.handle-s{bottom:-4px;left:50%;margin-left:-4px;cursor:s-resize}
.handle-sw{bottom:-4px;left:-4px;cursor:sw-resize}
.handle-w{top:50%;left:-4px;margin-top:-4px;cursor:w-resize}
.marquee{position:absolute;border:1px dashed #3b82f6;background:rgba(59,130,246,.1);pointer-events:none;z-index:1000}
#properties-panel{grid-area:properties;background:#f8fafc;border-left:1px solid #cbd5e1;display:flex;flex-direction:column;overflow:hidden}
#properties-content{flex:1;overflow-y:auto;padding:8px}
.prop-group{margin-bottom:12px}
.prop-group-title{font-size:11px;font-weight:600;color:#64748b;text-transform:uppercase;padding:4px 0;border-bottom:1px solid #e2e8f0;margin-bottom:6px}
.prop-row{display:flex;align-items:center;gap:6px;margin-bottom:4px}
.prop-row label{font-size:11px;color:#475569;min-width:50px;flex-shrink:0}
.prop-row input,.prop-row select{flex:1;padding:3px 6px;border:1px solid #cbd5e1;border-radius:3px;font-size:12px;font-family:inherit;min-width:0}
.prop-row input[type=color]{padding:1px;height:26px;width:40px;flex:0 0 40px;cursor:pointer}
.prop-row input[type=number]{width:60px;flex:0 0 60px}
.prop-row input[type=checkbox]{flex:0 0 auto}
.prop-btn{padding:3px 8px;background:#f1f5f9;border:1px solid #cbd5e1;border-radius:3px;font-size:11px;cursor:pointer;font-family:inherit}
.prop-btn:hover{background:#e2e8f0}
.align-buttons{display:flex;gap:3px;flex-wrap:wrap}
.align-buttons button{width:28px;height:24px;padding:0;font-size:13px;display:flex;align-items:center;justify-content:center}
.elem-text{overflow:hidden;white-space:nowrap;text-overflow:ellipsis;width:100%;height:100%;display:flex;align-items:flex-start;padding:2px}
.elem-field{overflow:hidden;white-space:nowrap;text-overflow:ellipsis;width:100%;height:100%;display:flex;align-items:flex-start;padding:2px;background:rgba(59,130,246,.05);border:1px dashed rgba(59,130,246,.3)}
.elem-barcode{width:100%;height:100%;display:flex;align-items:center;justify-content:center;overflow:hidden}
.elem-barcode canvas{max-width:100%;max-height:100%}
.elem-line-h{border-top:1px solid #000}
.elem-line-v{border-left:1px solid #000}
.elem-rect{border:1px solid #000}
.elem-image{width:100%;height:100%;overflow:hidden}
.elem-image img{width:100%;height:100%}
.preview-mode .elem-field{background:transparent;border:none}
.preview-mode .canvas-element.selected{outline:none}
.preview-mode .handle{display:none!important}
@media print{body{display:block!important}#toolbar,#palette-panel,#properties-panel,#ruler-corner,#ruler-top,#ruler-left{display:none!important}#canvas-area{display:block!important}#canvas-scroll{padding:0!important;overflow:visible!important}#canvas-container{transform:none!important}#canvas{box-shadow:none!important}.canvas-element.selected{outline:none!important}.handle{display:none!important}.grid-overlay{display:none!important}}
</style>
</head>
<body>

<div id="toolbar">
  <select id="label-size" title="Label Size">
    <option value="4x6">4" x 6"</option>
    <option value="4x3">4" x 3"</option>
    <option value="2x1">2" x 1"</option>
    <option value="100x50mm">100 x 50 mm</option>
    <option value="100x30mm">100 x 30 mm</option>
    <option value="custom">Custom...</option>
  </select>
  <span id="label-dims" style="font-size:11px;color:#94a3b8;margin-right:4px">288 x 432 pt</span>
  <div class="sep"></div>
  <button onclick="addElement('staticText')" title="Add Static Text">T Text</button>
  <button onclick="addElement('barcode')" title="Add Barcode">&#9783; Barcode</button>
  <button onclick="addElement('line')" title="Add Line">&#9135; Line</button>
  <button onclick="addElement('rectangle')" title="Add Rectangle">&#9633; Rect</button>
  <button onclick="document.getElementById('image-upload').click()" title="Add Image">&#128247; Image</button>
  <div class="sep"></div>
  <label title="Show Grid"><input type="checkbox" id="show-grid" checked> Grid</label>
  <label title="Snap to Grid"><input type="checkbox" id="snap-grid" checked> Snap</label>
  <label style="gap:2px">Size:<input type="number" id="grid-size" value="9" min="1" max="72" style="width:45px" title="Grid spacing (points)"></label>
  <div class="sep"></div>
  <button onclick="doUndo()" title="Undo (Ctrl+Z)">&#8630; Undo</button>
  <button onclick="doRedo()" title="Redo (Ctrl+Y)">&#8631; Redo</button>
  <div class="sep"></div>
  <label>Zoom:<select id="zoom-select">
    <option value="1">100%</option>
    <option value="1.5">150%</option>
    <option value="2" selected>200%</option>
    <option value="3">300%</option>
  </select></label>
  <div class="sep"></div>
  <button id="preview-btn" onclick="togglePreview()">Preview</button>
  <div class="sep"></div>
  <button onclick="doPrint()">Print</button>
  <button onclick="exportPDF()">PDF</button>
  <button onclick="exportJRXML()">JRXML</button>
  <div class="sep"></div>
  <button onclick="saveDesign()">Save</button>
  <button onclick="document.getElementById('load-file').click()">Load</button>
</div>

<div id="palette-panel">
  <div class="panel-header">Field Palette</div>
  <input type="text" id="field-search" placeholder="Search fields...">
  <div id="field-list"></div>
  <div id="add-custom-field">
    <input type="text" id="custom-field-input" placeholder="custom_field_name">
    <button onclick="addCustomField()">+ Add</button>
  </div>
</div>

<div id="canvas-area">
  <div id="ruler-corner"></div>
  <div id="ruler-top"><canvas id="ruler-h"></canvas></div>
  <div id="ruler-left"><canvas id="ruler-v"></canvas></div>
  <div id="canvas-scroll">
    <div id="canvas-container">
      <div id="canvas">
        <div class="grid-overlay" id="grid-overlay"></div>
      </div>
    </div>
  </div>
</div>

<div id="properties-panel">
  <div class="panel-header">Properties</div>
  <div id="properties-content"></div>
</div>

<input type="file" id="image-upload" accept="image/*" style="display:none">
<input type="file" id="load-file" accept=".json" style="display:none">

<script>
// =============================================
// CONFIGURATION & STATE
// =============================================
const LABEL_PRESETS = {
  '4x6':     { w: 288, h: 432, label: '4" x 6"' },
  '4x3':     { w: 288, h: 216, label: '4" x 3"' },
  '2x1':     { w: 144, h: 72,  label: '2" x 1"' },
  '100x50mm':{ w: 283, h: 142, label: '100x50mm' },
  '100x30mm':{ w: 283, h: 85,  label: '100x30mm' }
};

const FIELD_CATEGORIES = {
  'Product': [
    { name:'product_num', label:'Product Number' },
    { name:'product_description', label:'Description' },
    { name:'product_price', label:'Price' },
    { name:'product_uom', label:'UOM' }
  ],
  'Part': [
    { name:'part_num', label:'Part Number' },
    { name:'part_description', label:'Description' },
    { name:'part_upc', label:'UPC' },
    { name:'part_weight', label:'Weight' },
    { name:'part_weightUom', label:'Weight UOM' }
  ],
  'Location': [
    { name:'location_name', label:'Location Name' },
    { name:'locationGroup_name', label:'Location Group' }
  ],
  'Tracking': [
    { name:'tracking_primaryValue', label:'Serial/Lot Number' },
    { name:'tracking_expirationDate', label:'Expiration Date' }
  ],
  'Custom Fields': [
    { name:'customField1', label:'Custom Field 1' },
    { name:'customField2', label:'Custom Field 2' },
    { name:'customField3', label:'Custom Field 3' },
    { name:'customField4', label:'Custom Field 4' },
    { name:'customField5', label:'Custom Field 5' }
  ]
};

const SAMPLE_DATA = {
  product_num:'BTY-001', product_description:'Widget Assembly Kit',
  product_price:'$24.99', product_uom:'ea',
  part_num:'PRT-10042', part_description:'Hex Bolt M8x25',
  part_upc:'012345678905', part_weight:'0.25', part_weightUom:'lbs',
  location_name:'Shelf A-3', locationGroup_name:'Main Warehouse',
  tracking_primaryValue:'SN-2024-00158', tracking_expirationDate:'2025-12-31',
  customField1:'Custom Value 1', customField2:'Custom Value 2',
  customField3:'Custom Value 3', customField4:'Custom Value 4',
  customField5:'Custom Value 5'
};

const BARCODE_MAP = { Code128:'code128', Code39:'code39', QRCode:'qrcode', 'EAN13':'ean13' };

let state = {
  label: { width: 288, height: 432, name: 'My Label' },
  elements: [],
  selectedIds: [],
  clipboard: [],
  zoom: 2,
  gridSize: 9,
  showGrid: true,
  snapToGrid: true,
  previewMode: false,
  nextId: 1,
  nextZIndex: 1,
  undoStack: [],
  redoStack: [],
  customFields: [],
  dragState: null,
  marquee: null
};

// =============================================
// UTILITIES
// =============================================
function uid() {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
    const r = Math.random()*16|0;
    return (c==='x' ? r : (r&0x3|0x8)).toString(16);
  });
}
function genId() { return 'elem_' + (state.nextId++); }
function mmToPt(mm) { return Math.round(mm * 72 / 25.4); }
function inToPt(i) { return Math.round(i * 72); }
function ptToMm(pt) { return (pt * 25.4 / 72).toFixed(1); }
function ptToIn(pt) { return (pt / 72).toFixed(3); }
function snap(v) { return state.snapToGrid ? Math.round(v / state.gridSize) * state.gridSize : Math.round(v); }
function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }
function deepClone(o) { return JSON.parse(JSON.stringify(o)); }

// =============================================
// HISTORY (UNDO/REDO)
// =============================================
function pushHistory() {
  state.undoStack.push(deepClone({ elements: state.elements, label: state.label }));
  if (state.undoStack.length > 20) state.undoStack.shift();
  state.redoStack = [];
}
function doUndo() {
  if (!state.undoStack.length) return;
  state.redoStack.push(deepClone({ elements: state.elements, label: state.label }));
  const prev = state.undoStack.pop();
  state.elements = prev.elements;
  state.label = prev.label;
  state.selectedIds = [];
  renderAll();
}
function doRedo() {
  if (!state.redoStack.length) return;
  state.undoStack.push(deepClone({ elements: state.elements, label: state.label }));
  const next = state.redoStack.pop();
  state.elements = next.elements;
  state.label = next.label;
  state.selectedIds = [];
  renderAll();
}

// =============================================
// ELEMENT FACTORY
// =============================================
function createElement(type, extra) {
  const base = {
    id: genId(), type, x: 10, y: 10, width: 120, height: 30,
    rotation: 0, zIndex: state.nextZIndex++, uuid: uid()
  };
  const defaults = {
    staticText: { text:'Text', fontFamily:'SansSerif', fontSize:12, fontBold:false, fontItalic:false, textAlign:'left', textColor:'#000000' },
    fieldToken: { fieldName:'product_num', fontFamily:'SansSerif', fontSize:12, fontBold:false, fontItalic:false, textAlign:'left', textColor:'#000000' },
    barcode: { barcodeType:'Code128', dataSource:'field', fieldName:'part_upc', staticValue:'12345', showHumanReadable:true, width:180, height:60 },
    line: { lineThickness:1, lineColor:'#000000', orientation:'horizontal', width:100, height:1 },
    rectangle: { borderThickness:1, borderColor:'#000000', fillColor:'transparent', cornerRadius:0, width:100, height:60 },
    image: { imageData:'', scaleMode:'retain', width:80, height:80 }
  };
  return Object.assign(base, defaults[type] || {}, extra || {});
}

// =============================================
// CANVAS RENDERING
// =============================================
function renderAll() {
  const canvas = document.getElementById('canvas');
  const container = document.getElementById('canvas-container');
  canvas.style.width = state.label.width + 'px';
  canvas.style.height = state.label.height + 'px';
  container.style.transform = `scale(${state.zoom})`;
  container.style.width = state.label.width + 'px';
  container.style.height = state.label.height + 'px';
  // Update grid
  const grid = document.getElementById('grid-overlay');
  if (state.showGrid) {
    const g = state.gridSize;
    grid.style.backgroundImage = `linear-gradient(to right,rgba(0,0,0,.08) 1px,transparent 1px),linear-gradient(to bottom,rgba(0,0,0,.08) 1px,transparent 1px)`;
    grid.style.backgroundSize = `${g}px ${g}px`;
    grid.style.display = 'block';
  } else {
    grid.style.display = 'none';
  }
  // Remove old elements
  canvas.querySelectorAll('.canvas-element').forEach(el => el.remove());
  canvas.querySelector('.marquee')?.remove();
  // Render elements sorted by zIndex
  const sorted = [...state.elements].sort((a,b) => a.zIndex - b.zIndex);
  sorted.forEach(elem => {
    const div = document.createElement('div');
    div.className = 'canvas-element' + (state.selectedIds.includes(elem.id) ? ' selected' : '');
    div.dataset.id = elem.id;
    div.style.left = elem.x + 'px';
    div.style.top = elem.y + 'px';
    div.style.width = elem.width + 'px';
    div.style.height = elem.height + 'px';
    div.style.zIndex = elem.zIndex;
    if (elem.rotation) div.style.transform = `rotate(${elem.rotation}deg)`;
    renderElementContent(div, elem);
    // Resize handles
    ['nw','n','ne','e','se','s','sw','w'].forEach(pos => {
      const h = document.createElement('div');
      h.className = `handle handle-${pos}`;
      h.dataset.handle = pos;
      div.appendChild(h);
    });
    // Events
    div.addEventListener('mousedown', e => onElementMouseDown(e, elem.id));
    div.addEventListener('dblclick', e => onElementDblClick(e, elem.id));
    canvas.appendChild(div);
  });
  updateDimsLabel();
  updatePropertiesPanel();
  drawRulers();
}

function renderElementContent(div, elem) {
  switch (elem.type) {
    case 'staticText': {
      const s = document.createElement('div');
      s.className = 'elem-text';
      s.style.fontFamily = elem.fontFamily;
      s.style.fontSize = elem.fontSize + 'px';
      s.style.fontWeight = elem.fontBold ? 'bold' : 'normal';
      s.style.fontStyle = elem.fontItalic ? 'italic' : 'normal';
      s.style.textAlign = elem.textAlign;
      s.style.color = elem.textColor;
      s.textContent = elem.text;
      div.appendChild(s);
      break;
    }
    case 'fieldToken': {
      const s = document.createElement('div');
      s.className = 'elem-field';
      s.style.fontFamily = elem.fontFamily;
      s.style.fontSize = elem.fontSize + 'px';
      s.style.fontWeight = elem.fontBold ? 'bold' : 'normal';
      s.style.fontStyle = elem.fontItalic ? 'italic' : 'normal';
      s.style.textAlign = elem.textAlign;
      s.style.color = elem.textColor;
      const sample = SAMPLE_DATA[elem.fieldName] || `\$F{${elem.fieldName}}`;
      s.textContent = state.previewMode ? sample : `\$F{${elem.fieldName}} [${sample}]`;
      div.appendChild(s);
      break;
    }
    case 'barcode': {
      const wrap = document.createElement('div');
      wrap.className = 'elem-barcode';
      const cvs = document.createElement('canvas');
      wrap.appendChild(cvs);
      div.appendChild(wrap);
      const data = elem.dataSource === 'field' ? (SAMPLE_DATA[elem.fieldName] || '12345') : (elem.staticValue || '12345');
      try {
        const bcid = BARCODE_MAP[elem.barcodeType] || 'code128';
        bwipjs.toCanvas(cvs, {
          bcid, text: data, scale: 2,
          height: Math.max(5, Math.round(elem.height / 4)),
          includetext: elem.showHumanReadable,
          textxalign: 'center'
        });
      } catch(e) {
        wrap.textContent = '[Barcode: ' + e.message + ']';
        wrap.style.fontSize = '10px';
        wrap.style.color = '#ef4444';
      }
      break;
    }
    case 'line': {
      if (elem.orientation === 'horizontal') {
        div.style.borderTop = `${elem.lineThickness}px solid ${elem.lineColor}`;
        div.style.height = Math.max(elem.lineThickness, elem.height) + 'px';
      } else {
        div.style.borderLeft = `${elem.lineThickness}px solid ${elem.lineColor}`;
        div.style.width = Math.max(elem.lineThickness, elem.width) + 'px';
      }
      break;
    }
    case 'rectangle': {
      div.style.border = `${elem.borderThickness}px solid ${elem.borderColor}`;
      if (elem.fillColor && elem.fillColor !== 'transparent') div.style.backgroundColor = elem.fillColor;
      if (elem.cornerRadius) div.style.borderRadius = elem.cornerRadius + 'px';
      break;
    }
    case 'image': {
      if (elem.imageData) {
        const img = document.createElement('img');
        img.src = elem.imageData;
        img.style.objectFit = elem.scaleMode === 'retain' ? 'contain' : 'fill';
        img.style.width = '100%';
        img.style.height = '100%';
        img.draggable = false;
        div.appendChild(img);
      } else {
        div.style.border = '1px dashed #94a3b8';
        div.style.display = 'flex';
        div.style.alignItems = 'center';
        div.style.justifyContent = 'center';
        div.style.fontSize = '11px';
        div.style.color = '#94a3b8';
        div.textContent = 'No Image';
      }
      break;
    }
  }
}

// =============================================
// RULERS
// =============================================
function drawRulers() {
  drawRulerH();
  drawRulerV();
}
function drawRulerH() {
  const c = document.getElementById('ruler-h');
  const scrollEl = document.getElementById('canvas-scroll');
  const w = state.label.width * state.zoom + 40;
  c.width = Math.max(w, scrollEl.clientWidth);
  c.height = 24;
  const ctx = c.getContext('2d');
  ctx.fillStyle = '#f8fafc';
  ctx.fillRect(0, 0, c.width, c.height);
  ctx.fillStyle = '#64748b';
  ctx.font = '9px Inter, sans-serif';
  ctx.strokeStyle = '#94a3b8';
  const step = state.gridSize * state.zoom;
  const majorEvery = Math.max(1, Math.round(36 / state.gridSize));
  const offset = 20 * 1; // padding in scroll area
  for (let i = 0; i <= state.label.width / state.gridSize; i++) {
    const x = offset + i * step;
    const isMajor = i % majorEvery === 0;
    ctx.beginPath();
    ctx.moveTo(x, isMajor ? 8 : 16);
    ctx.lineTo(x, 24);
    ctx.lineWidth = isMajor ? 1 : 0.5;
    ctx.stroke();
    if (isMajor) ctx.fillText(String(i * state.gridSize), x + 2, 7);
  }
  // Sync scroll
  c.parentElement.scrollLeft = scrollEl.scrollLeft;
}
function drawRulerV() {
  const c = document.getElementById('ruler-v');
  const scrollEl = document.getElementById('canvas-scroll');
  const h = state.label.height * state.zoom + 40;
  c.width = 24;
  c.height = Math.max(h, scrollEl.clientHeight);
  const ctx = c.getContext('2d');
  ctx.fillStyle = '#f8fafc';
  ctx.fillRect(0, 0, c.width, c.height);
  ctx.fillStyle = '#64748b';
  ctx.font = '9px Inter, sans-serif';
  ctx.strokeStyle = '#94a3b8';
  const step = state.gridSize * state.zoom;
  const majorEvery = Math.max(1, Math.round(36 / state.gridSize));
  const offset = 20;
  for (let i = 0; i <= state.label.height / state.gridSize; i++) {
    const y = offset + i * step;
    const isMajor = i % majorEvery === 0;
    ctx.beginPath();
    ctx.moveTo(isMajor ? 8 : 16, y);
    ctx.lineTo(24, y);
    ctx.lineWidth = isMajor ? 1 : 0.5;
    ctx.stroke();
    if (isMajor) {
      ctx.save();
      ctx.translate(7, y + 2);
      ctx.rotate(-Math.PI/2);
      ctx.fillText(String(i * state.gridSize), 0, 0);
      ctx.restore();
    }
  }
  c.parentElement.scrollTop = scrollEl.scrollTop;
}

function updateDimsLabel() {
  document.getElementById('label-dims').textContent = `${state.label.width} x ${state.label.height} pt`;
}

// =============================================
// INTERACTIONS: DRAG, RESIZE, SELECT, MARQUEE
// =============================================
function screenToCanvas(e) {
  const canvas = document.getElementById('canvas');
  const rect = canvas.getBoundingClientRect();
  return { x: (e.clientX - rect.left) / state.zoom, y: (e.clientY - rect.top) / state.zoom };
}

function onElementMouseDown(e, id) {
  e.stopPropagation();
  const handle = e.target.dataset.handle;
  if (handle) {
    // Start resize
    const elem = state.elements.find(el => el.id === id);
    if (!elem) return;
    state.dragState = {
      type: 'resize', handle, id,
      startX: e.clientX, startY: e.clientY,
      origX: elem.x, origY: elem.y, origW: elem.width, origH: elem.height
    };
    pushHistory();
  } else {
    // Select
    if (e.shiftKey) {
      if (state.selectedIds.includes(id)) {
        state.selectedIds = state.selectedIds.filter(i => i !== id);
      } else {
        state.selectedIds.push(id);
      }
    } else if (!state.selectedIds.includes(id)) {
      state.selectedIds = [id];
    }
    // Start drag
    const pos = screenToCanvas(e);
    state.dragState = {
      type: 'move', ids: [...state.selectedIds],
      startX: pos.x, startY: pos.y,
      origPositions: state.selectedIds.map(sid => {
        const el = state.elements.find(el => el.id === sid);
        return { id: sid, x: el.x, y: el.y };
      })
    };
    pushHistory();
    renderAll();
  }
}

function onCanvasMouseDown(e) {
  if (e.target.closest('.canvas-element')) return;
  if (!e.shiftKey) state.selectedIds = [];
  // Start marquee
  const pos = screenToCanvas(e);
  state.marquee = { startX: pos.x, startY: pos.y, x: pos.x, y: pos.y, w: 0, h: 0 };
  renderAll();
}

function onMouseMove(e) {
  if (state.dragState) {
    const ds = state.dragState;
    if (ds.type === 'move') {
      const pos = screenToCanvas(e);
      const dx = pos.x - ds.startX;
      const dy = pos.y - ds.startY;
      ds.origPositions.forEach(op => {
        const elem = state.elements.find(el => el.id === op.id);
        if (elem) {
          elem.x = snap(clamp(op.x + dx, 0, state.label.width - elem.width));
          elem.y = snap(clamp(op.y + dy, 0, state.label.height - elem.height));
          const div = document.querySelector(`[data-id="${elem.id}"]`);
          if (div) { div.style.left = elem.x+'px'; div.style.top = elem.y+'px'; }
        }
      });
      updatePropertiesPanel();
    } else if (ds.type === 'resize') {
      const dx = (e.clientX - ds.startX) / state.zoom;
      const dy = (e.clientY - ds.startY) / state.zoom;
      const elem = state.elements.find(el => el.id === ds.id);
      if (!elem) return;
      let {origX:ox, origY:oy, origW:ow, origH:oh} = ds;
      const h = ds.handle;
      let nx=ox, ny=oy, nw=ow, nh=oh;
      if (h.includes('e')) nw = Math.max(5, snap(ow + dx));
      if (h.includes('s')) nh = Math.max(5, snap(oh + dy));
      if (h.includes('w')) { nw = Math.max(5, snap(ow - dx)); nx = snap(ox + ow - nw); }
      if (h.includes('n')) { nh = Math.max(5, snap(oh - dy)); ny = snap(oy + oh - nh); }
      elem.x = nx; elem.y = ny; elem.width = nw; elem.height = nh;
      const div = document.querySelector(`[data-id="${elem.id}"]`);
      if (div) {
        div.style.left=nx+'px'; div.style.top=ny+'px';
        div.style.width=nw+'px'; div.style.height=nh+'px';
      }
      updatePropertiesPanel();
    }
  } else if (state.marquee) {
    const pos = screenToCanvas(e);
    const m = state.marquee;
    m.x = Math.min(m.startX, pos.x);
    m.y = Math.min(m.startY, pos.y);
    m.w = Math.abs(pos.x - m.startX);
    m.h = Math.abs(pos.y - m.startY);
    let mDiv = document.querySelector('.marquee');
    if (!mDiv) {
      mDiv = document.createElement('div');
      mDiv.className = 'marquee';
      document.getElementById('canvas').appendChild(mDiv);
    }
    mDiv.style.left = m.x+'px'; mDiv.style.top = m.y+'px';
    mDiv.style.width = m.w+'px'; mDiv.style.height = m.h+'px';
  }
}

function onMouseUp(e) {
  if (state.dragState) {
    if (state.dragState.type === 'move' || state.dragState.type === 'resize') {
      renderAll();
    }
    state.dragState = null;
  }
  if (state.marquee) {
    const m = state.marquee;
    if (m.w > 2 && m.h > 2) {
      state.selectedIds = state.elements.filter(el =>
        el.x >= m.x && el.y >= m.y &&
        el.x + el.width <= m.x + m.w &&
        el.y + el.height <= m.y + m.h
      ).map(el => el.id);
    }
    state.marquee = null;
    renderAll();
  }
}

function onElementDblClick(e, id) {
  const elem = state.elements.find(el => el.id === id);
  if (!elem || (elem.type !== 'staticText' && elem.type !== 'fieldToken')) return;
  if (elem.type === 'fieldToken') return; // can't edit field name inline
  const div = document.querySelector(`[data-id="${id}"] .elem-text`);
  if (!div) return;
  pushHistory();
  div.contentEditable = true;
  div.focus();
  document.execCommand('selectAll');
  const finish = () => {
    div.contentEditable = false;
    elem.text = div.textContent;
    renderAll();
  };
  div.addEventListener('blur', finish, { once: true });
  div.addEventListener('keydown', ev => {
    if (ev.key === 'Enter') { ev.preventDefault(); div.blur(); }
    if (ev.key === 'Escape') { div.textContent = elem.text; div.blur(); }
  });
}

// =============================================
// ADD / DELETE / COPY-PASTE ELEMENTS
// =============================================
function addElement(type, extra) {
  pushHistory();
  const elem = createElement(type, extra);
  // Place near center of visible canvas
  const scroll = document.getElementById('canvas-scroll');
  const cx = (scroll.scrollLeft + scroll.clientWidth/2) / state.zoom;
  const cy = (scroll.scrollTop + scroll.clientHeight/2) / state.zoom;
  elem.x = snap(clamp(cx - elem.width/2, 0, state.label.width - elem.width));
  elem.y = snap(clamp(cy - elem.height/2, 0, state.label.height - elem.height));
  state.elements.push(elem);
  state.selectedIds = [elem.id];
  renderAll();
  return elem;
}

function deleteSelected() {
  if (!state.selectedIds.length) return;
  pushHistory();
  state.elements = state.elements.filter(el => !state.selectedIds.includes(el.id));
  state.selectedIds = [];
  renderAll();
}

function copySelected() {
  state.clipboard = state.selectedIds.map(id => {
    const el = state.elements.find(e => e.id === id);
    return el ? deepClone(el) : null;
  }).filter(Boolean);
}

function pasteClipboard() {
  if (!state.clipboard.length) return;
  pushHistory();
  const newIds = [];
  state.clipboard.forEach(el => {
    const ne = deepClone(el);
    ne.id = genId();
    ne.uuid = uid();
    ne.x = snap(el.x + 10);
    ne.y = snap(el.y + 10);
    ne.zIndex = state.nextZIndex++;
    state.elements.push(ne);
    newIds.push(ne.id);
  });
  state.selectedIds = newIds;
  renderAll();
}
// =============================================
// PROPERTIES PANEL
// =============================================
function updatePropertiesPanel() {
  const panel = document.getElementById('properties-content');
  const sel = state.selectedIds.map(id => state.elements.find(e => e.id === id)).filter(Boolean);

  if (sel.length === 0) {
    panel.innerHTML = labelPropertiesHTML();
    bindLabelProps();
    return;
  }
  if (sel.length > 1) {
    panel.innerHTML = multiSelectHTML();
    bindAlignButtons();
    return;
  }
  const elem = sel[0];
  panel.innerHTML = elementPropertiesHTML(elem);
  bindElementProps(elem);
}

function labelPropertiesHTML() {
  return `<div class="prop-group"><div class="prop-group-title">Label</div>
    <div class="prop-row"><label>Name</label><input id="pp-name" value="${esc(state.label.name)}"></div>
    <div class="prop-row"><label>Width</label><input type="number" id="pp-lw" value="${state.label.width}" min="10"></div>
    <div class="prop-row"><label>Height</label><input type="number" id="pp-lh" value="${state.label.height}" min="10"></div>
    <div class="prop-row" style="font-size:11px;color:#64748b">${ptToIn(state.label.width)}" x ${ptToIn(state.label.height)}" &nbsp;|&nbsp; ${ptToMm(state.label.width)} x ${ptToMm(state.label.height)} mm</div>
  </div>`;
}

function bindLabelProps() {
  const setLP = (id, fn) => { const el = document.getElementById(id); if(el) el.addEventListener('change', fn); };
  setLP('pp-name', e => { state.label.name = e.target.value; });
  setLP('pp-lw', e => { pushHistory(); state.label.width = parseInt(e.target.value)||288; renderAll(); });
  setLP('pp-lh', e => { pushHistory(); state.label.height = parseInt(e.target.value)||432; renderAll(); });
}

function multiSelectHTML() {
  return `<div class="prop-group"><div class="prop-group-title">${state.selectedIds.length} Elements Selected</div>
    <div class="prop-group-title" style="margin-top:8px">Align</div>
    <div class="align-buttons">
      <button class="prop-btn" data-align="left" title="Align Left">&#9664;</button>
      <button class="prop-btn" data-align="centerH" title="Center Horizontal">&#9679;</button>
      <button class="prop-btn" data-align="right" title="Align Right">&#9654;</button>
      <button class="prop-btn" data-align="top" title="Align Top">&#9650;</button>
      <button class="prop-btn" data-align="centerV" title="Center Vertical">&#9679;</button>
      <button class="prop-btn" data-align="bottom" title="Align Bottom">&#9660;</button>
    </div>
    <div class="prop-group-title" style="margin-top:8px">Distribute</div>
    <div class="align-buttons">
      <button class="prop-btn" data-align="distH" title="Distribute Horizontally">&#8596;</button>
      <button class="prop-btn" data-align="distV" title="Distribute Vertically">&#8597;</button>
    </div>
  </div>`;
}

function bindAlignButtons() {
  document.querySelectorAll('[data-align]').forEach(btn => {
    btn.addEventListener('click', () => alignElements(btn.dataset.align));
  });
}

function alignElements(action) {
  const elems = state.selectedIds.map(id => state.elements.find(e=>e.id===id)).filter(Boolean);
  if (elems.length < 2) return;
  pushHistory();
  switch(action) {
    case 'left': { const m = Math.min(...elems.map(e=>e.x)); elems.forEach(e=>e.x=m); break; }
    case 'right': { const m = Math.max(...elems.map(e=>e.x+e.width)); elems.forEach(e=>e.x=m-e.width); break; }
    case 'top': { const m = Math.min(...elems.map(e=>e.y)); elems.forEach(e=>e.y=m); break; }
    case 'bottom': { const m = Math.max(...elems.map(e=>e.y+e.height)); elems.forEach(e=>e.y=m-e.height); break; }
    case 'centerH': { const avg = elems.reduce((s,e)=>s+e.x+e.width/2,0)/elems.length; elems.forEach(e=>e.x=Math.round(avg-e.width/2)); break; }
    case 'centerV': { const avg = elems.reduce((s,e)=>s+e.y+e.height/2,0)/elems.length; elems.forEach(e=>e.y=Math.round(avg-e.height/2)); break; }
    case 'distH': {
      elems.sort((a,b)=>a.x-b.x);
      const minX=elems[0].x, maxR=elems[elems.length-1].x+elems[elems.length-1].width;
      const totalW=elems.reduce((s,e)=>s+e.width,0);
      const gap=(maxR-minX-totalW)/(elems.length-1);
      let cx=minX;
      elems.forEach(e=>{e.x=Math.round(cx);cx+=e.width+gap;});
      break;
    }
    case 'distV': {
      elems.sort((a,b)=>a.y-b.y);
      const minY=elems[0].y, maxB=elems[elems.length-1].y+elems[elems.length-1].height;
      const totalH=elems.reduce((s,e)=>s+e.height,0);
      const gap=(maxB-minY-totalH)/(elems.length-1);
      let cy=minY;
      elems.forEach(e=>{e.y=Math.round(cy);cy+=e.height+gap;});
      break;
    }
  }
  renderAll();
}

function elementPropertiesHTML(el) {
  let html = `<div class="prop-group"><div class="prop-group-title">Position & Size</div>
    <div class="prop-row"><label>X</label><input type="number" id="pp-x" value="${el.x}"></div>
    <div class="prop-row"><label>Y</label><input type="number" id="pp-y" value="${el.y}"></div>
    <div class="prop-row"><label>Width</label><input type="number" id="pp-w" value="${el.width}" min="1"></div>
    <div class="prop-row"><label>Height</label><input type="number" id="pp-h" value="${el.height}" min="1"></div>
    <div class="prop-row"><label>Rotation</label><select id="pp-rot">
      ${[0,90,180,270].map(r=>`<option value="${r}"${el.rotation===r?' selected':''}>${r}Â°</option>`).join('')}
    </select></div>
  </div>
  <div class="prop-group"><div class="prop-group-title">Z-Order</div>
    <div class="align-buttons">
      <button class="prop-btn" id="pp-zup" title="Bring Forward">&#8593; Up</button>
      <button class="prop-btn" id="pp-zdown" title="Send Back">&#8595; Down</button>
      <button class="prop-btn" id="pp-ztop" title="Bring to Front">&#8607; Top</button>
      <button class="prop-btn" id="pp-zbot" title="Send to Back">&#8609; Bot</button>
    </div>
  </div>`;

  if (el.type === 'staticText' || el.type === 'fieldToken') {
    html += `<div class="prop-group"><div class="prop-group-title">Text</div>`;
    if (el.type === 'staticText') {
      html += `<div class="prop-row"><label>Text</label><input id="pp-text" value="${esc(el.text)}"></div>`;
    } else {
      html += `<div class="prop-row"><label>Field</label><input id="pp-field" value="${esc(el.fieldName)}"></div>`;
    }
    html += `<div class="prop-row"><label>Font</label><select id="pp-font">
      ${['SansSerif','Serif','Monospaced','Arial','Helvetica','Times New Roman','Courier New'].map(f=>`<option${el.fontFamily===f?' selected':''}>${f}</option>`).join('')}
    </select></div>
    <div class="prop-row"><label>Size</label><input type="number" id="pp-fsize" value="${el.fontSize}" min="4" max="200"></div>
    <div class="prop-row">
      <label>Style</label>
      <label><input type="checkbox" id="pp-bold"${el.fontBold?' checked':''}> B</label>
      <label><input type="checkbox" id="pp-italic"${el.fontItalic?' checked':''}> I</label>
    </div>
    <div class="prop-row"><label>Align</label><select id="pp-align">
      ${['left','center','right'].map(a=>`<option${el.textAlign===a?' selected':''}>${a}</option>`).join('')}
    </select></div>
    <div class="prop-row"><label>Color</label><input type="color" id="pp-tcolor" value="${el.textColor}"></div>
    </div>`;
  }

  if (el.type === 'barcode') {
    html += `<div class="prop-group"><div class="prop-group-title">Barcode</div>
    <div class="prop-row"><label>Type</label><select id="pp-bctype">
      ${['Code128','Code39','QRCode','EAN13'].map(t=>`<option${el.barcodeType===t?' selected':''}>${t}</option>`).join('')}
    </select></div>
    <div class="prop-row"><label>Source</label><select id="pp-bcsrc">
      <option value="field"${el.dataSource==='field'?' selected':''}>Field</option>
      <option value="static"${el.dataSource==='static'?' selected':''}>Static</option>
    </select></div>
    <div class="prop-row" id="pp-bcfield-row"><label>Field</label><input id="pp-bcfield" value="${esc(el.fieldName)}"></div>
    <div class="prop-row" id="pp-bcstatic-row"><label>Value</label><input id="pp-bcstatic" value="${esc(el.staticValue)}"></div>
    <div class="prop-row"><label>Text</label><label><input type="checkbox" id="pp-bctext"${el.showHumanReadable?' checked':''}> Show</label></div>
    </div>`;
  }

  if (el.type === 'line') {
    html += `<div class="prop-group"><div class="prop-group-title">Line</div>
    <div class="prop-row"><label>Dir</label><select id="pp-lineori">
      <option value="horizontal"${el.orientation==='horizontal'?' selected':''}>Horizontal</option>
      <option value="vertical"${el.orientation==='vertical'?' selected':''}>Vertical</option>
    </select></div>
    <div class="prop-row"><label>Width</label><input type="number" id="pp-linethk" value="${el.lineThickness}" min="1" max="20"></div>
    <div class="prop-row"><label>Color</label><input type="color" id="pp-linecolor" value="${el.lineColor}"></div>
    </div>`;
  }

  if (el.type === 'rectangle') {
    html += `<div class="prop-group"><div class="prop-group-title">Rectangle</div>
    <div class="prop-row"><label>Border</label><input type="number" id="pp-rectbdr" value="${el.borderThickness}" min="0" max="20"></div>
    <div class="prop-row"><label>Bdr Color</label><input type="color" id="pp-rectbdrclr" value="${el.borderColor}"></div>
    <div class="prop-row"><label>Fill</label><input type="color" id="pp-rectfill" value="${el.fillColor==='transparent'?'#ffffff':el.fillColor}"></div>
    <div class="prop-row"><label>No Fill</label><label><input type="checkbox" id="pp-rectnofill"${el.fillColor==='transparent'?' checked':''}> Transparent</label></div>
    <div class="prop-row"><label>Radius</label><input type="number" id="pp-rectrad" value="${el.cornerRadius}" min="0" max="100"></div>
    </div>`;
  }

  if (el.type === 'image') {
    html += `<div class="prop-group"><div class="prop-group-title">Image</div>
    <div class="prop-row"><label>Scale</label><select id="pp-imgscale">
      <option value="retain"${el.scaleMode==='retain'?' selected':''}>Retain Aspect</option>
      <option value="stretch"${el.scaleMode==='stretch'?' selected':''}>Stretch</option>
    </select></div>
    <div class="prop-row"><button class="prop-btn" id="pp-imgchange">Change Image</button></div>
    </div>`;
  }

  html += `<div class="prop-group" style="margin-top:12px">
    <button class="prop-btn" style="background:#fef2f2;border-color:#fca5a5;color:#dc2626;width:100%" onclick="deleteSelected()">Delete Element</button>
  </div>`;
  return html;
}

function esc(s) { return String(s).replace(/"/g,'&quot;').replace(/</g,'&lt;'); }

function bindElementProps(el) {
  const bind = (id, prop, parse) => {
    const input = document.getElementById(id);
    if (!input) return;
    input.addEventListener('change', () => {
      pushHistory();
      el[prop] = parse ? parse(input) : input.value;
      renderAll();
    });
  };
  bind('pp-x','x', i=>parseInt(i.value)||0);
  bind('pp-y','y', i=>parseInt(i.value)||0);
  bind('pp-w','width', i=>Math.max(1,parseInt(i.value)||1));
  bind('pp-h','height', i=>Math.max(1,parseInt(i.value)||1));
  bind('pp-rot','rotation', i=>parseInt(i.value)||0);
  bind('pp-text','text');
  bind('pp-field','fieldName');
  bind('pp-font','fontFamily');
  bind('pp-fsize','fontSize', i=>parseInt(i.value)||12);
  bind('pp-bold','fontBold', i=>i.checked);
  bind('pp-italic','fontItalic', i=>i.checked);
  bind('pp-align','textAlign');
  bind('pp-tcolor','textColor');
  bind('pp-bctype','barcodeType');
  bind('pp-bcsrc','dataSource');
  bind('pp-bcfield','fieldName');
  bind('pp-bcstatic','staticValue');
  bind('pp-bctext','showHumanReadable', i=>i.checked);
  bind('pp-lineori','orientation');
  bind('pp-linethk','lineThickness', i=>parseInt(i.value)||1);
  bind('pp-linecolor','lineColor');
  bind('pp-rectbdr','borderThickness', i=>parseInt(i.value)||0);
  bind('pp-rectbdrclr','borderColor');
  bind('pp-rectfill','fillColor');
  bind('pp-rectrad','cornerRadius', i=>parseInt(i.value)||0);
  bind('pp-imgscale','scaleMode');

  // No-fill checkbox
  const nf = document.getElementById('pp-rectnofill');
  if (nf) nf.addEventListener('change', () => {
    pushHistory();
    el.fillColor = nf.checked ? 'transparent' : '#ffffff';
    renderAll();
  });

  // Barcode source visibility
  const srcSel = document.getElementById('pp-bcsrc');
  if (srcSel) {
    const updateBcRows = () => {
      const fr = document.getElementById('pp-bcfield-row');
      const sr = document.getElementById('pp-bcstatic-row');
      if (fr) fr.style.display = srcSel.value==='field' ? 'flex' : 'none';
      if (sr) sr.style.display = srcSel.value==='static' ? 'flex' : 'none';
    };
    updateBcRows();
    srcSel.addEventListener('change', updateBcRows);
  }

  // Image change
  const ic = document.getElementById('pp-imgchange');
  if (ic) ic.addEventListener('click', () => {
    const inp = document.getElementById('image-upload');
    inp.onchange = e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => { pushHistory(); el.imageData = ev.target.result; renderAll(); };
      reader.readAsDataURL(file);
      inp.value = '';
    };
    inp.click();
  });

  // Z-order buttons
  const zBind = (id, fn) => { const b = document.getElementById(id); if(b) b.addEventListener('click', () => { pushHistory(); fn(); renderAll(); }); };
  zBind('pp-zup', () => { el.zIndex = Math.min(el.zIndex+1, 9999); });
  zBind('pp-zdown', () => { el.zIndex = Math.max(el.zIndex-1, 0); });
  zBind('pp-ztop', () => { el.zIndex = state.nextZIndex++; });
  zBind('pp-zbot', () => { el.zIndex = 0; state.elements.forEach(e => { if(e.id!==el.id && e.zIndex>=0) e.zIndex++; }); });
}
// =============================================
// FIELD PALETTE
// =============================================
function buildFieldPalette() {
  const list = document.getElementById('field-list');
  list.innerHTML = '';
  const search = (document.getElementById('field-search').value || '').toLowerCase();
  const icons = { Product:'P', Part:'#', Location:'L', Tracking:'T', 'Custom Fields':'C' };
  const allCats = { ...FIELD_CATEGORIES };
  if (state.customFields.length) {
    allCats['User Fields'] = state.customFields.map(f => ({ name: f.name, label: f.label || f.name }));
  }
  for (const [cat, fields] of Object.entries(allCats)) {
    const filtered = fields.filter(f => !search || f.name.toLowerCase().includes(search) || f.label.toLowerCase().includes(search));
    if (!filtered.length) continue;
    const catDiv = document.createElement('div');
    catDiv.className = 'field-category';
    catDiv.innerHTML = `<div class="field-category-title">${cat}</div><div class="field-items"></div>`;
    catDiv.querySelector('.field-category-title').addEventListener('click', () => catDiv.classList.toggle('collapsed'));
    const itemsDiv = catDiv.querySelector('.field-items');
    filtered.forEach(f => {
      const item = document.createElement('div');
      item.className = 'field-item';
      item.draggable = true;
      item.innerHTML = `<span class="fi-icon">${icons[cat]||'F'}</span><div><div style="font-size:12px">${f.label}</div><div class="fi-name">$F{${f.name}}</div></div>`;
      item.addEventListener('dragstart', e => {
        e.dataTransfer.setData('text/plain', f.name);
        e.dataTransfer.effectAllowed = 'copy';
      });
      item.addEventListener('dblclick', () => {
        addElement('fieldToken', { fieldName: f.name });
      });
      itemsDiv.appendChild(item);
    });
    list.appendChild(catDiv);
  }
}

function addCustomField() {
  const inp = document.getElementById('custom-field-input');
  const name = inp.value.trim().replace(/[^a-zA-Z0-9_]/g, '_');
  if (!name) return;
  if (state.customFields.some(f => f.name === name)) return;
  state.customFields.push({ name, label: name });
  SAMPLE_DATA[name] = name;
  inp.value = '';
  buildFieldPalette();
}

function handleCanvasDrop(e) {
  e.preventDefault();
  const fieldName = e.dataTransfer.getData('text/plain');
  if (!fieldName) return;
  const pos = screenToCanvas(e);
  addElement('fieldToken', {
    fieldName,
    x: snap(clamp(pos.x, 0, state.label.width - 120)),
    y: snap(clamp(pos.y, 0, state.label.height - 30))
  });
}
// =============================================
// JRXML EXPORT
// =============================================
function exportJRXML() {
  const W = state.label.width, H = state.label.height;
  const reportUuid = uid();
  // Collect field names from fieldToken and barcode elements
  const fieldNames = new Set();
  state.elements.forEach(el => {
    if (el.type === 'fieldToken') fieldNames.add(el.fieldName);
    if (el.type === 'barcode' && el.dataSource === 'field') fieldNames.add(el.fieldName);
  });

  let xml = `<?xml version="1.0" encoding="UTF-8"?>\n`;
  xml += `<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports"\n`;
  xml += `              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"\n`;
  xml += `              xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd"\n`;
  xml += `              name="${xmlEsc(state.label.name)}" pageWidth="${W}" pageHeight="${H}" columnWidth="${W}"\n`;
  xml += `              leftMargin="0" rightMargin="0" topMargin="0" bottomMargin="0"\n`;
  xml += `              uuid="${reportUuid}">\n`;

  // Field declarations
  fieldNames.forEach(fn => {
    xml += `\t<field name="${xmlEsc(fn)}" class="java.lang.String"/>\n`;
  });

  // Detail band
  xml += `\t<detail>\n\t\t<band height="${H}">\n`;

  // Sort by z-index
  const sorted = [...state.elements].sort((a,b) => a.zIndex - b.zIndex);
  sorted.forEach(el => {
    xml += jrxmlElement(el);
  });

  xml += `\t\t</band>\n\t</detail>\n</jasperReport>`;

  downloadFile(state.label.name + '.jrxml', xml, 'application/xml');
}

function jrxmlElement(el) {
  const re = `\t\t\t<reportElement x="${Math.round(el.x)}" y="${Math.round(el.y)}" width="${Math.round(el.width)}" height="${Math.round(el.height)}" uuid="${el.uuid}"/>\n`;
  const rotMap = { 0:'None', 90:'Right', 180:'UpsideDown', 270:'Left' };

  switch (el.type) {
    case 'staticText': {
      let s = `\t\t\t<staticText>\n${re}`;
      s += jrxmlTextElement(el, rotMap[el.rotation]||'None');
      s += `\t\t\t\t<text><![CDATA[${el.text}]]></text>\n`;
      s += `\t\t\t</staticText>\n`;
      return s;
    }
    case 'fieldToken': {
      let s = `\t\t\t<textField>\n${re}`;
      s += jrxmlTextElement(el, rotMap[el.rotation]||'None');
      s += `\t\t\t\t<textFieldExpression><![CDATA[$F{${el.fieldName}}]]></textFieldExpression>\n`;
      s += `\t\t\t</textField>\n`;
      return s;
    }
    case 'barcode': {
      const codeExpr = el.dataSource === 'field'
        ? `$F{${el.fieldName}}`
        : `"${xmlEsc(el.staticValue)}"`;
      const ns = 'http://jasperreports.sourceforge.net/jasperreports/components';
      const nsSL = 'http://jasperreports.sourceforge.net/jasperreports/components http://jasperreports.sourceforge.net/xsd/components.xsd';
      let s = `\t\t\t<componentElement>\n${re}`;
      if (el.barcodeType === 'QRCode') {
        s += `\t\t\t\t<jr:QRCode xmlns:jr="${ns}" xsi:schemaLocation="${nsSL}" errorCorrectionLevel="L">\n`;
        s += `\t\t\t\t\t<jr:codeExpression><![CDATA[${codeExpr}]]></jr:codeExpression>\n`;
        s += `\t\t\t\t</jr:QRCode>\n`;
      } else {
        const tag = el.barcodeType === 'EAN13' ? 'EAN13' : el.barcodeType;
        s += `\t\t\t\t<jr:${tag} xmlns:jr="${ns}" xsi:schemaLocation="${nsSL}" moduleWidth="1.0"`;
        s += el.showHumanReadable ? `>\n` : ` textPosition="none">\n`;
        s += `\t\t\t\t\t<jr:codeExpression><![CDATA[${codeExpr}]]></jr:codeExpression>\n`;
        s += `\t\t\t\t</jr:${tag}>\n`;
      }
      s += `\t\t\t</componentElement>\n`;
      return s;
    }
    case 'line': {
      let s = `\t\t\t<line>\n`;
      s += `\t\t\t\t<reportElement x="${Math.round(el.x)}" y="${Math.round(el.y)}" width="${Math.round(el.width)}" height="${Math.round(el.height)}" uuid="${el.uuid}"/>\n`;
      if (el.lineThickness !== 1 || el.lineColor !== '#000000') {
        s += `\t\t\t\t<graphicElement><pen lineWidth="${el.lineThickness}"`;
        if (el.lineColor !== '#000000') s += ` lineColor="${el.lineColor}"`;
        s += `/></graphicElement>\n`;
      }
      s += `\t\t\t</line>\n`;
      return s;
    }
    case 'rectangle': {
      let s = `\t\t\t<rectangle`;
      if (el.cornerRadius) s += ` radius="${el.cornerRadius}"`;
      s += `>\n${re}`;
      if (el.borderThickness !== 1 || el.borderColor !== '#000000') {
        s += `\t\t\t\t<graphicElement><pen lineWidth="${el.borderThickness}"`;
        if (el.borderColor !== '#000000') s += ` lineColor="${el.borderColor}"`;
        s += `/></graphicElement>\n`;
      }
      s += `\t\t\t</rectangle>\n`;
      return s;
    }
    case 'image': {
      let s = `\t\t\t<image scaleImage="${el.scaleMode==='retain'?'RetainShape':'FillFrame'}">\n${re}`;
      if (el.imageData) {
        // Extract base64 data (remove data:image/...;base64, prefix)
        const b64 = el.imageData.replace(/^data:image\/[^;]+;base64,/, '');
        s += `\t\t\t\t<imageExpression><![CDATA[new java.io.ByteArrayInputStream(javax.xml.bind.DatatypeConverter.parseBase64Binary("${b64}"))]]></imageExpression>\n`;
      } else {
        s += `\t\t\t\t<imageExpression><![CDATA["placeholder.png"]]></imageExpression>\n`;
      }
      s += `\t\t\t</image>\n`;
      return s;
    }
    default: return '';
  }
}

function jrxmlTextElement(el, rotation) {
  const alignMap = { left:'Left', center:'Center', right:'Right' };
  let s = `\t\t\t\t<textElement rotation="${rotation}"`;
  if (el.textAlign !== 'left') s += ` textAlignment="${alignMap[el.textAlign]||'Left'}"`;
  s += `>\n`;
  s += `\t\t\t\t\t<font fontName="${xmlEsc(el.fontFamily)}" size="${el.fontSize}"`;
  if (el.fontBold) s += ` isBold="true"`;
  if (el.fontItalic) s += ` isItalic="true"`;
  s += `/>\n`;
  s += `\t\t\t\t</textElement>\n`;
  return s;
}

function xmlEsc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
// =============================================
// PDF EXPORT
// =============================================
function exportPDF() {
  const W = state.label.width, H = state.label.height;
  const ptToMmV = v => v * 25.4 / 72;
  const orientation = W > H ? 'landscape' : 'portrait';
  const doc = new jspdf.jsPDF({ orientation, unit: 'mm', format: [ptToMmV(W), ptToMmV(H)] });

  const sorted = [...state.elements].sort((a,b) => a.zIndex - b.zIndex);
  sorted.forEach(el => {
    const x = ptToMmV(el.x), y = ptToMmV(el.y), w = ptToMmV(el.width), h = ptToMmV(el.height);
    switch (el.type) {
      case 'staticText':
      case 'fieldToken': {
        const text = el.type === 'staticText' ? el.text : (SAMPLE_DATA[el.fieldName] || el.fieldName);
        const style = (el.fontBold ? 'bold' : '') + (el.fontItalic ? 'italic' : '');
        doc.setFont(el.fontFamily === 'SansSerif' ? 'helvetica' : el.fontFamily === 'Serif' ? 'times' : 'courier', style || 'normal');
        doc.setFontSize(el.fontSize);
        const hexToRgb = hex => { const r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16); return [r,g,b]; };
        doc.setTextColor(...hexToRgb(el.textColor));
        const align = el.textAlign === 'center' ? 'center' : el.textAlign === 'right' ? 'right' : 'left';
        const tx = align === 'center' ? x + w/2 : align === 'right' ? x + w : x;
        doc.text(text, tx, y + ptToMmV(el.fontSize * 0.8), { align, maxWidth: w });
        break;
      }
      case 'barcode': {
        // Render barcode to temp canvas, add as image
        const tc = document.createElement('canvas');
        const data = el.dataSource === 'field' ? (SAMPLE_DATA[el.fieldName] || '12345') : (el.staticValue || '12345');
        try {
          bwipjs.toCanvas(tc, {
            bcid: BARCODE_MAP[el.barcodeType] || 'code128',
            text: data, scale: 3,
            height: Math.max(8, Math.round(el.height / 3)),
            includetext: el.showHumanReadable, textxalign: 'center'
          });
          doc.addImage(tc.toDataURL('image/png'), 'PNG', x, y, w, h);
        } catch(e) {}
        break;
      }
      case 'line': {
        doc.setDrawColor(...(el.lineColor === '#000000' ? [0,0,0] : hexToRgbArr(el.lineColor)));
        doc.setLineWidth(ptToMmV(el.lineThickness));
        if (el.orientation === 'horizontal') {
          doc.line(x, y, x + w, y);
        } else {
          doc.line(x, y, x, y + h);
        }
        break;
      }
      case 'rectangle': {
        doc.setDrawColor(...hexToRgbArr(el.borderColor));
        doc.setLineWidth(ptToMmV(el.borderThickness));
        if (el.fillColor && el.fillColor !== 'transparent') {
          doc.setFillColor(...hexToRgbArr(el.fillColor));
          doc.roundedRect(x, y, w, h, ptToMmV(el.cornerRadius||0), ptToMmV(el.cornerRadius||0), 'FD');
        } else {
          doc.roundedRect(x, y, w, h, ptToMmV(el.cornerRadius||0), ptToMmV(el.cornerRadius||0), 'S');
        }
        break;
      }
      case 'image': {
        if (el.imageData) {
          try { doc.addImage(el.imageData, 'PNG', x, y, w, h); } catch(e) {}
        }
        break;
      }
    }
  });
  doc.save(state.label.name + '.pdf');
}

function hexToRgbArr(hex) {
  if (!hex || hex === 'transparent') return [0,0,0];
  return [parseInt(hex.slice(1,3),16), parseInt(hex.slice(3,5),16), parseInt(hex.slice(5,7),16)];
}

// =============================================
// PRINT
// =============================================
function doPrint() { window.print(); }

// =============================================
// SAVE / LOAD DESIGN
// =============================================
function saveDesign() {
  const data = {
    version: 1,
    label: deepClone(state.label),
    elements: deepClone(state.elements),
    customFields: deepClone(state.customFields),
    nextId: state.nextId,
    nextZIndex: state.nextZIndex
  };
  downloadFile(state.label.name + '.json', JSON.stringify(data, null, 2), 'application/json');
}

function loadDesign(file) {
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      pushHistory();
      state.label = data.label || state.label;
      state.elements = data.elements || [];
      state.customFields = data.customFields || [];
      state.nextId = data.nextId || state.elements.length + 1;
      state.nextZIndex = data.nextZIndex || state.elements.length + 1;
      state.selectedIds = [];
      // Update label size selector
      const sel = document.getElementById('label-size');
      sel.value = 'custom';
      buildFieldPalette();
      renderAll();
    } catch(err) {
      alert('Failed to load design: ' + err.message);
    }
  };
  reader.readAsText(file);
}

function downloadFile(name, content, mime) {
  const blob = new Blob([content], { type: mime });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = name;
  a.click();
  URL.revokeObjectURL(a.href);
}

// =============================================
// PREVIEW MODE
// =============================================
function togglePreview() {
  state.previewMode = !state.previewMode;
  document.getElementById('canvas').classList.toggle('preview-mode', state.previewMode);
  document.getElementById('preview-btn').style.background = state.previewMode ? '#3b82f6' : '';
  if (state.previewMode) state.selectedIds = [];
  renderAll();
}

// =============================================
// KEYBOARD SHORTCUTS
// =============================================
function handleKeyDown(e) {
  // Don't intercept if typing in an input
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) return;

  if (e.ctrlKey || e.metaKey) {
    switch(e.key.toLowerCase()) {
      case 'z': e.preventDefault(); if (e.shiftKey) doRedo(); else doUndo(); break;
      case 'y': e.preventDefault(); doRedo(); break;
      case 'c': e.preventDefault(); copySelected(); break;
      case 'v': e.preventDefault(); pasteClipboard(); break;
      case 'a': e.preventDefault(); state.selectedIds = state.elements.map(el=>el.id); renderAll(); break;
      case 's': e.preventDefault(); saveDesign(); break;
    }
    return;
  }
  switch(e.key) {
    case 'Delete':
    case 'Backspace':
      e.preventDefault();
      deleteSelected();
      break;
    case 'ArrowLeft':
      e.preventDefault();
      nudgeSelected(e.shiftKey ? -state.gridSize : -1, 0);
      break;
    case 'ArrowRight':
      e.preventDefault();
      nudgeSelected(e.shiftKey ? state.gridSize : 1, 0);
      break;
    case 'ArrowUp':
      e.preventDefault();
      nudgeSelected(0, e.shiftKey ? -state.gridSize : -1);
      break;
    case 'ArrowDown':
      e.preventDefault();
      nudgeSelected(0, e.shiftKey ? state.gridSize : 1);
      break;
    case 'Escape':
      state.selectedIds = [];
      renderAll();
      break;
  }
}

function nudgeSelected(dx, dy) {
  if (!state.selectedIds.length) return;
  pushHistory();
  state.selectedIds.forEach(id => {
    const el = state.elements.find(e => e.id === id);
    if (el) {
      el.x = clamp(el.x + dx, 0, state.label.width - el.width);
      el.y = clamp(el.y + dy, 0, state.label.height - el.height);
    }
  });
  renderAll();
}

// =============================================
// TOOLBAR HANDLERS
// =============================================
function setupToolbar() {
  // Label size
  document.getElementById('label-size').addEventListener('change', function() {
    const v = this.value;
    if (v === 'custom') {
      const wStr = prompt('Width (e.g. "4in" or "100mm" or "288pt"):', '4in');
      const hStr = prompt('Height (e.g. "6in" or "50mm" or "432pt"):', '6in');
      if (!wStr || !hStr) { this.value = '4x6'; return; }
      pushHistory();
      state.label.width = parseDimension(wStr);
      state.label.height = parseDimension(hStr);
    } else {
      const preset = LABEL_PRESETS[v];
      if (preset) {
        pushHistory();
        state.label.width = preset.w;
        state.label.height = preset.h;
      }
    }
    renderAll();
  });

  // Grid controls
  document.getElementById('show-grid').addEventListener('change', function() {
    state.showGrid = this.checked;
    renderAll();
  });
  document.getElementById('snap-grid').addEventListener('change', function() {
    state.snapToGrid = this.checked;
  });
  document.getElementById('grid-size').addEventListener('change', function() {
    state.gridSize = Math.max(1, parseInt(this.value) || 9);
    renderAll();
  });

  // Zoom
  document.getElementById('zoom-select').addEventListener('change', function() {
    state.zoom = parseFloat(this.value) || 2;
    renderAll();
  });

  // Image upload (for toolbar button)
  document.getElementById('image-upload').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      addElement('image', { imageData: ev.target.result });
    };
    reader.readAsDataURL(file);
    this.value = '';
  });

  // Load file
  document.getElementById('load-file').addEventListener('change', function(e) {
    if (e.target.files[0]) loadDesign(e.target.files[0]);
    this.value = '';
  });

  // Field search
  document.getElementById('field-search').addEventListener('input', buildFieldPalette);
}

function parseDimension(s) {
  s = s.trim().toLowerCase();
  const num = parseFloat(s);
  if (s.includes('mm')) return mmToPt(num);
  if (s.includes('in')) return inToPt(num);
  return Math.round(num); // assume points
}

// =============================================
// INITIALIZATION
// =============================================
function init() {
  setupToolbar();
  buildFieldPalette();

  const canvas = document.getElementById('canvas');
  canvas.addEventListener('mousedown', onCanvasMouseDown);
  canvas.addEventListener('dragover', e => e.preventDefault());
  canvas.addEventListener('drop', handleCanvasDrop);

  document.addEventListener('mousemove', onMouseMove);
  document.addEventListener('mouseup', onMouseUp);
  document.addEventListener('keydown', handleKeyDown);

  // Sync rulers on scroll
  document.getElementById('canvas-scroll').addEventListener('scroll', drawRulers);

  renderAll();
}

document.addEventListener('DOMContentLoaded', init);
// end of script
</script>
</body>
</html>
