<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Label Designer - Fishbowl BI</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/bwip-js@4"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2/dist/jspdf.umd.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
*{font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}
:root{--color-primary:#2d9cdb;--color-primary-dark:#1e7bb4;--color-sidebar:#06162d;--color-sidebar-hover:#0a1f3d}
.bg-indigo-600{background-color:var(--color-primary)!important}
.hover\:bg-indigo-700:hover{background-color:var(--color-primary-dark)!important}
.text-indigo-600{color:var(--color-primary)!important}
.border-indigo-300{border-color:rgba(45,156,219,.4)!important}
.custom-scrollbar::-webkit-scrollbar{width:8px;height:8px}
.custom-scrollbar::-webkit-scrollbar-track{background:#f1f5f9;border-radius:4px}
.custom-scrollbar::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:4px}
.custom-scrollbar::-webkit-scrollbar-thumb:hover{background:#94a3b8}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.spinner{border:3px solid #f1f5f9;border-top:3px solid var(--color-primary);border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite}
/* Template cards */
.template-card{transition:all .2s;cursor:pointer}
.template-card:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,.12)}
.template-card.selected{ring:2px;border-color:var(--color-primary)!important;box-shadow:0 0 0 3px rgba(45,156,219,.25)}
/* Editor styles */
.editor-panel{background:#f8fafc;display:flex;flex-direction:column;overflow:hidden}
.panel-header{padding:10px 12px;font-weight:600;font-size:13px;background:#f1f5f9;border-bottom:1px solid #cbd5e1}
#field-search{margin:8px;padding:6px 10px;border:1px solid #cbd5e1;border-radius:4px;font-size:12px;font-family:inherit}
.field-category{margin-top:8px}
.field-category-title{font-size:11px;font-weight:600;color:#64748b;text-transform:uppercase;padding:4px 8px;cursor:pointer;display:flex;align-items:center;gap:4px}
.field-category-title::before{content:'\25BC';font-size:8px;transition:transform .2s}
.field-category.collapsed .field-category-title::before{transform:rotate(-90deg)}
.field-category.collapsed .field-items{display:none}
.field-item{padding:5px 8px;margin:2px 0;background:#fff;border:1px solid #e2e8f0;border-radius:4px;font-size:12px;cursor:grab;display:flex;align-items:center;gap:6px;transition:all .15s}
.field-item:hover{background:#eff6ff;border-color:#93c5fd}
.field-item .fi-icon{width:18px;height:18px;background:#dbeafe;border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:10px;color:#3b82f6;flex-shrink:0}
.field-item .fi-name{font-family:'Courier New',monospace;font-size:11px;color:#64748b}
#canvas-container{flex-shrink:0;transform-origin:0 0;position:relative}
#canvas{background:#fff;position:relative;box-shadow:0 2px 8px rgba(0,0,0,.15);overflow:hidden}
.grid-overlay{position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none}
.canvas-element{position:absolute;cursor:move;user-select:none}
.canvas-element.selected{outline:2px solid #3b82f6;outline-offset:-1px}
.canvas-element .handle{position:absolute;width:8px;height:8px;background:#fff;border:2px solid #3b82f6;border-radius:1px;z-index:10;display:none}
.canvas-element.selected .handle{display:block}
.handle-nw{top:-4px;left:-4px;cursor:nw-resize}.handle-n{top:-4px;left:50%;margin-left:-4px;cursor:n-resize}
.handle-ne{top:-4px;right:-4px;cursor:ne-resize}.handle-e{top:50%;right:-4px;margin-top:-4px;cursor:e-resize}
.handle-se{bottom:-4px;right:-4px;cursor:se-resize}.handle-s{bottom:-4px;left:50%;margin-left:-4px;cursor:s-resize}
.handle-sw{bottom:-4px;left:-4px;cursor:sw-resize}.handle-w{top:50%;left:-4px;margin-top:-4px;cursor:w-resize}
.marquee{position:absolute;border:1px dashed #3b82f6;background:rgba(59,130,246,.1);pointer-events:none;z-index:1000}
.prop-group{margin-bottom:12px}
.prop-group-title{font-size:11px;font-weight:600;color:#64748b;text-transform:uppercase;padding:4px 0;border-bottom:1px solid #e2e8f0;margin-bottom:6px}
.prop-row{display:flex;align-items:center;gap:6px;margin-bottom:4px}
.prop-row label{font-size:11px;color:#475569;min-width:50px;flex-shrink:0}
.prop-row input,.prop-row select{flex:1;padding:3px 6px;border:1px solid #cbd5e1;border-radius:3px;font-size:12px;font-family:inherit;min-width:0}
.prop-row input[type=color]{padding:1px;height:26px;width:40px;flex:0 0 40px;cursor:pointer}
.prop-row input[type=number]{width:60px;flex:0 0 60px}
.prop-btn{padding:3px 8px;background:#f1f5f9;border:1px solid #cbd5e1;border-radius:3px;font-size:11px;cursor:pointer;font-family:inherit}
.prop-btn:hover{background:#e2e8f0}
.align-buttons{display:flex;gap:3px;flex-wrap:wrap}
.align-buttons button{width:28px;height:24px;padding:0;font-size:13px;display:flex;align-items:center;justify-content:center}
.elem-text{overflow:hidden;white-space:nowrap;text-overflow:ellipsis;width:100%;height:100%;display:flex;align-items:flex-start;padding:2px}
.elem-field{overflow:hidden;white-space:nowrap;text-overflow:ellipsis;width:100%;height:100%;display:flex;align-items:flex-start;padding:2px;background:rgba(59,130,246,.05);border:1px dashed rgba(59,130,246,.3)}
.elem-barcode{width:100%;height:100%;display:flex;align-items:center;justify-content:center;overflow:hidden}
.elem-barcode canvas{max-width:100%;max-height:100%}
.elem-image{width:100%;height:100%;overflow:hidden}
.elem-image img{width:100%;height:100%}
.preview-mode .elem-field{background:transparent;border:none}
.preview-mode .canvas-element.selected{outline:none}
.preview-mode .handle{display:none!important}
/* Rulers */
.ruler-canvas{display:block}
/* Editor toolbar */
.editor-toolbar{background:#1e293b;color:#fff;display:flex;align-items:center;gap:4px;padding:6px 12px;flex-wrap:wrap}
.editor-toolbar select,.editor-toolbar button,.editor-toolbar input[type=number]{background:#334155;color:#fff;border:1px solid #475569;border-radius:4px;padding:4px 8px;font-size:12px;font-family:inherit;cursor:pointer;height:28px}
.editor-toolbar button:hover{background:#475569}
.editor-toolbar .sep{width:1px;height:20px;background:#475569;margin:0 4px}
.editor-toolbar label{font-size:11px;display:flex;align-items:center;gap:4px;cursor:pointer}
/* Print */
@media print{
  @page{margin:0;padding:0}
  body{margin:0;padding:0;background:#fff!important}
  .no-print,#view-selector,#view-preview,#drop-overlay,#loadingOverlay{display:none!important}
  #view-editor{display:block!important;height:auto!important;grid-template-rows:none!important;grid-template-columns:none!important}
  .editor-toolbar,.editor-panel{display:none!important}
  #canvas-scroll{padding:0!important;overflow:visible!important;display:block!important;background:#fff!important}
  #canvas-container{transform:none!important}
  #canvas{box-shadow:none!important}
  .canvas-element.selected{outline:none!important}
  .handle{display:none!important}
  .grid-overlay{display:none!important}
  .elem-field{background:transparent!important;border:none!important}
}
</style>
</head>
<body class="bg-slate-50">

<!-- ======================================================
     VIEW 1: TEMPLATE SELECTOR (Landing Page)
     ====================================================== -->
<div id="view-selector" class="flex flex-col h-screen">
  <header class="h-16 bg-white border-b border-slate-200 px-8 flex items-center justify-between flex-shrink-0 z-20 shadow-sm no-print">
    <div class="flex items-center gap-3">
      <svg class="w-7 h-7 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/></svg>
      <div>
        <h1 class="text-lg font-bold text-slate-900">Label Designer</h1>
        <p class="text-[10px] text-slate-500">Fishbowl BI Reports</p>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <button onclick="document.getElementById('import-jrxml-file').click()" class="px-4 py-2 bg-slate-100 hover:bg-slate-200 border border-slate-300 text-slate-700 rounded-lg text-sm font-semibold transition-colors flex items-center gap-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
        Import JRXML
      </button>
      <button onclick="openEditor(null)" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-semibold transition-colors flex items-center gap-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
        New Blank Label
      </button>
    </div>
  </header>
  <div class="flex-1 overflow-y-auto custom-scrollbar">
    <div class="p-6 lg:p-8 max-w-7xl mx-auto">
      <!-- Built-in Templates -->
      <h2 class="text-sm font-bold text-slate-500 uppercase tracking-wide mb-4">Built-in Templates</h2>
      <div id="builtin-templates" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-8"></div>
      <!-- Saved Templates -->
      <h2 class="text-sm font-bold text-slate-500 uppercase tracking-wide mb-4 flex items-center gap-2">
        Saved Templates
        <span id="saved-status" class="text-xs font-normal text-slate-400"></span>
      </h2>
      <div id="saved-templates" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-8"></div>
    </div>
  </div>
</div>

<!-- ======================================================
     VIEW 2: PARAMETER & PREVIEW
     ====================================================== -->
<div id="view-preview" class="flex flex-col h-screen" style="display:none">
  <header class="h-16 bg-white border-b border-slate-200 px-8 flex items-center justify-between flex-shrink-0 z-20 shadow-sm no-print">
    <div class="flex items-center gap-3">
      <button onclick="showView('selector')" class="p-2 hover:bg-slate-100 rounded-lg transition-colors" title="Back to templates">
        <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
      </button>
      <div>
        <h1 id="preview-title" class="text-lg font-bold text-slate-900">Template Name</h1>
        <p id="preview-subtitle" class="text-[10px] text-slate-500">Description</p>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <button onclick="openEditorFromPreview()" class="px-4 py-2 bg-slate-100 hover:bg-slate-200 border border-slate-300 text-slate-700 rounded-lg text-sm font-semibold transition-colors flex items-center gap-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
        Edit Design
      </button>
      <button onclick="printFromPreview()" class="px-4 py-2 bg-slate-100 hover:bg-slate-200 border border-slate-300 text-slate-700 rounded-lg text-sm font-semibold transition-colors">Print</button>
      <button onclick="exportPDFFromPreview()" class="px-4 py-2 bg-slate-100 hover:bg-slate-200 border border-slate-300 text-slate-700 rounded-lg text-sm font-semibold transition-colors">PDF</button>
      <button onclick="exportJRXMLFromPreview()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-semibold transition-colors">Export JRXML</button>
    </div>
  </header>
  <div class="flex-1 overflow-y-auto custom-scrollbar">
    <div class="p-6 lg:p-8 max-w-6xl mx-auto">
      <!-- Parameters Card -->
      <div id="params-card" class="bg-white rounded-2xl shadow-md border border-slate-300 p-4 mb-6">
        <h3 class="text-base font-bold text-slate-800 flex items-center gap-2 mb-3">
          <svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/></svg>
          Parameters
        </h3>
        <div id="params-content" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
      </div>
      <!-- Preview + Info -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 bg-white rounded-2xl shadow-md border border-slate-300 p-6">
          <h3 class="text-base font-bold text-slate-800 mb-4">Preview</h3>
          <div id="preview-canvas-wrapper" class="flex items-center justify-center bg-slate-100 rounded-xl p-8 min-h-[300px]">
            <div id="preview-canvas-container" style="transform-origin:0 0">
              <div id="preview-canvas" class="relative bg-white" style="box-shadow:0 2px 8px rgba(0,0,0,.15)"></div>
            </div>
          </div>
        </div>
        <div class="space-y-4">
          <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-4">
            <h3 class="text-sm font-bold text-slate-800 mb-2">Label Info</h3>
            <div id="label-info" class="text-sm text-slate-600 space-y-1"></div>
          </div>
          <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-4">
            <h3 class="text-sm font-bold text-slate-800 mb-2">Field Visibility</h3>
            <div id="field-toggles" class="space-y-1"></div>
          </div>
          <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-4">
            <h3 class="text-sm font-bold text-slate-800 mb-2">Actions</h3>
            <div class="space-y-2">
              <button onclick="saveTemplateToFishbowl()" class="w-full px-3 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-semibold transition-colors">Save to Fishbowl</button>
              <button onclick="saveDesign()" class="w-full px-3 py-2 bg-slate-100 hover:bg-slate-200 border border-slate-300 text-slate-700 rounded-lg text-sm font-semibold transition-colors">Save as JSON</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ======================================================
     VIEW 3: WYSIWYG EDITOR
     ====================================================== -->
<div id="view-editor" style="display:none;height:100vh;display:none;grid-template-rows:auto 1fr;grid-template-columns:250px 1fr 280px;grid-template-areas:'etoolbar etoolbar etoolbar' 'epalette ecanvas eprops'">
  <div class="editor-toolbar no-print" style="grid-area:etoolbar">
    <button onclick="showView('selector')" title="Back to templates" style="background:#475569">&#8592; Back</button>
    <div class="sep"></div>
    <select id="label-size" title="Label Size">
      <option value="4x6">4" x 6"</option><option value="4x3">4" x 3"</option><option value="2x1">2" x 1"</option>
      <option value="100x50mm">100 x 50 mm</option><option value="100x30mm">100 x 30 mm</option><option value="custom">Custom...</option>
    </select>
    <span id="label-dims" style="font-size:11px;color:#94a3b8;margin-right:4px">288 x 432 pt</span>
    <select id="unit-select" title="Display Units"><option value="pt">pt</option><option value="in" selected>in</option><option value="mm">mm</option></select>
    <div class="sep"></div>
    <button onclick="addElement('staticText')" title="Add Static Text">T Text</button>
    <button onclick="addElement('barcode')" title="Add Barcode">&#9783; Barcode</button>
    <button onclick="addElement('line')" title="Add Line">&#9135; Line</button>
    <button onclick="addElement('rectangle')" title="Add Rectangle">&#9633; Rect</button>
    <button onclick="document.getElementById('image-upload').click()" title="Add Image">&#128247; Image</button>
    <div class="sep"></div>
    <label title="Show Grid"><input type="checkbox" id="show-grid" checked> Grid</label>
    <label title="Snap to Grid"><input type="checkbox" id="snap-grid" checked> Snap</label>
    <label style="gap:2px">Size:<input type="number" id="grid-size" value="9" min="1" max="72" style="width:45px"></label>
    <div class="sep"></div>
    <button onclick="doUndo()" title="Undo (Ctrl+Z)">&#8630; Undo</button>
    <button onclick="doRedo()" title="Redo (Ctrl+Y)">&#8631; Redo</button>
    <div class="sep"></div>
    <label>Zoom:<select id="zoom-select"><option value="1">100%</option><option value="1.5">150%</option><option value="2" selected>200%</option><option value="3">300%</option></select></label>
    <div class="sep"></div>
    <button id="preview-btn" onclick="togglePreview()">Preview</button>
    <div class="sep"></div>
    <button onclick="doPrint()">Print</button>
    <button onclick="exportPDF()">PDF</button>
    <button onclick="exportJRXML()">JRXML</button>
    <div class="sep"></div>
    <button onclick="saveDesign()">Save JSON</button>
    <button onclick="document.getElementById('load-file').click()">Load</button>
    <button onclick="document.getElementById('import-jrxml-file').click()">Import JRXML</button>
    <button onclick="saveTemplateToFishbowl()" style="background:#0e7490">Save to Fishbowl</button>
  </div>
  <div class="editor-panel no-print" style="grid-area:epalette;border-right:1px solid #cbd5e1">
    <div class="panel-header">Field Palette</div>
    <input type="text" id="field-search" placeholder="Search fields...">
    <div id="field-list" style="flex:1;overflow-y:auto;padding:0 8px 8px"></div>
    <div style="padding:8px;border-top:1px solid #cbd5e1;display:flex;gap:4px">
      <input type="text" id="custom-field-input" placeholder="custom_field_name" style="flex:1;padding:4px 8px;border:1px solid #cbd5e1;border-radius:4px;font-size:12px">
      <button onclick="addCustomField()" style="padding:4px 10px;background:#3b82f6;color:#fff;border:none;border-radius:4px;font-size:12px;cursor:pointer">+ Add</button>
    </div>
  </div>
  <div style="grid-area:ecanvas;display:grid;grid-template-rows:24px 1fr;grid-template-columns:24px 1fr;overflow:hidden">
    <div style="background:#f1f5f9;border-right:1px solid #cbd5e1;border-bottom:1px solid #cbd5e1"></div>
    <div style="background:#f8fafc;border-bottom:1px solid #cbd5e1;overflow:hidden"><canvas id="ruler-h" class="ruler-canvas"></canvas></div>
    <div style="background:#f8fafc;border-right:1px solid #cbd5e1;overflow:hidden"><canvas id="ruler-v" class="ruler-canvas"></canvas></div>
    <div id="canvas-scroll" style="overflow:auto;background:#e2e8f0;display:flex;align-items:flex-start;justify-content:flex-start;padding:20px">
      <div id="canvas-container"><div id="canvas"><div class="grid-overlay" id="grid-overlay"></div></div></div>
    </div>
  </div>
  <div class="editor-panel no-print" style="grid-area:eprops;border-left:1px solid #cbd5e1">
    <div class="panel-header">Properties</div>
    <div id="properties-content" style="flex:1;overflow-y:auto;padding:8px"></div>
  </div>
</div>

<!-- Hidden inputs -->
<input type="file" id="image-upload" accept="image/*" style="display:none">
<input type="file" id="load-file" accept=".json" style="display:none">
<input type="file" id="import-jrxml-file" accept=".jrxml,.xml" style="display:none">

<!-- Drag-and-drop overlay -->
<div id="drop-overlay" style="display:none;position:fixed;inset:0;z-index:100;background:rgba(45,156,219,.12);border:3px dashed var(--color-primary);pointer-events:none">
  <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px">
    <svg style="width:56px;height:56px;color:var(--color-primary)" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
    <p style="font-size:18px;font-weight:600;color:var(--color-primary)">Drop JRXML file to import</p>
    <p style="font-size:13px;color:#64748b">or .json label design file</p>
  </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display:none">
  <div class="bg-white rounded-xl p-8 flex flex-col items-center gap-4 shadow-2xl">
    <div class="spinner"></div>
    <p class="text-slate-700 font-semibold">Loading...</p>
  </div>
</div>

<script>
// =============================================
// FISHBOWL API DETECTION
// =============================================
const IN_FISHBOWL = typeof runQuery === 'function';
function safeRunQuery(sql) {
  if (!IN_FISHBOWL) return null;
  try { return JSON.parse(runQuery(sql)); } catch(e) { console.error('Query error:', e); return null; }
}

// =============================================
// CONFIGURATION & CONSTANTS
// =============================================
const LABEL_PRESETS = {
  '4x6':{w:288,h:432,label:'4" x 6"'},'4x3':{w:288,h:216,label:'4" x 3"'},'2x1':{w:144,h:72,label:'2" x 1"'},
  '100x50mm':{w:283,h:142,label:'100x50mm'},'100x30mm':{w:283,h:85,label:'100x30mm'}
};
const FIELD_CATEGORIES = {
  'Product':[{name:'product_num',label:'Product Number'},{name:'product_description',label:'Description'},{name:'product_price',label:'Price'},{name:'product_uom',label:'UOM'}],
  'Part':[{name:'part_num',label:'Part Number'},{name:'part_description',label:'Description'},{name:'part_upc',label:'UPC'},{name:'part_weight',label:'Weight'},{name:'part_weightUom',label:'Weight UOM'}],
  'Location':[{name:'location_name',label:'Location Name'},{name:'locationGroup_name',label:'Location Group'}],
  'Tracking':[{name:'tracking_primaryValue',label:'Serial/Lot Number'},{name:'tracking_expirationDate',label:'Expiration Date'}],
  'Custom Fields':[{name:'customField1',label:'Custom Field 1'},{name:'customField2',label:'Custom Field 2'},{name:'customField3',label:'Custom Field 3'},{name:'customField4',label:'Custom Field 4'},{name:'customField5',label:'Custom Field 5'}]
};
const SAMPLE_DATA = {
  product_num:'BTY-001',product_description:'Widget Assembly Kit',product_price:'$24.99',product_uom:'ea',
  part_num:'PRT-10042',part_description:'Hex Bolt M8x25',part_upc:'012345678905',part_weight:'0.25',part_weightUom:'lbs',
  location_name:'Shelf A-3',locationGroup_name:'Main Warehouse',tracking_primaryValue:'SN-2024-00158',tracking_expirationDate:'2025-12-31',
  customField1:'Custom Value 1',customField2:'Custom Value 2',customField3:'Custom Value 3',customField4:'Custom Value 4',customField5:'Custom Value 5',
  po_number:'PO-12345',part_number:'PRT-10042',description:'Hex Bolt M8x25',received_qty:'50',uom:'ea',
  vendor_name:'Acme Supply Co',date_received:'2025-12-15',unit_cost:'$4.50',location_group:'Main Warehouse',
  ship_number:'S-00234',sales_order:'SO-10567',customer_name:'Widget Corp',ship_to_address:'123 Industrial Blvd',
  qty_shipped:'25',carrier:'FedEx',service:'Ground',customer_po:'CPO-8899',
  pick_number:'PKT-00456',scheduled_date:'2025-12-20',priority:'Normal',qty_to_pick:'30',available_qty:'85',order_type:'SO',order_number:'SO-10567',entity_name:'Widget Corp',
  work_order_number:'WO-00789',finished_part_number:'ASM-5001',finished_part_description:'Motor Assembly',qty_to_produce:'10',bom_number:'BOM-200',manufacturing_order:'MO-100',work_order_status:'Started',
  qty_at_location:'142',total_value:'$639.00',reorder_point:'50',stock_status:'OK'
};
const BARCODE_MAP = {Code128:'code128',Code39:'code39',QRCode:'qrcode',EAN13:'ean13'};

// =============================================
// BUILT-IN TEMPLATES
// =============================================
const BUILTIN_TEMPLATES = [
  {
    meta:{name:'Part / Product Label',description:'Basic product label with UPC barcode',icon:'tag',labelSize:'4x6'},
    label:{name:'Part Label',width:288,height:432},
    elements:[
      {id:'e1',type:'fieldToken',fieldName:'part_number',x:10,y:10,width:268,height:28,fontSize:20,fontBold:true,fontFamily:'SansSerif',textAlign:'left',textColor:'#000000',rotation:0,zIndex:1,uuid:''},
      {id:'e2',type:'barcode',barcodeType:'Code128',dataSource:'field',fieldName:'part_upc',staticValue:'',x:10,y:50,width:220,height:80,showHumanReadable:true,rotation:0,zIndex:2,uuid:''},
      {id:'e3',type:'fieldToken',fieldName:'part_description',x:10,y:140,width:268,height:22,fontSize:13,fontBold:false,fontFamily:'SansSerif',textAlign:'left',textColor:'#333333',rotation:0,zIndex:3,uuid:''},
      {id:'e4',type:'fieldToken',fieldName:'product_price',x:10,y:170,width:120,height:22,fontSize:14,fontBold:true,fontFamily:'SansSerif',textAlign:'left',textColor:'#000000',rotation:0,zIndex:4,uuid:''},
      {id:'e5',type:'fieldToken',fieldName:'location_name',x:10,y:200,width:180,height:18,fontSize:11,fontBold:false,fontFamily:'SansSerif',textAlign:'left',textColor:'#666666',rotation:0,zIndex:5,uuid:''}
    ],
    fields:[
      {name:'part_number',sqlExpr:'p.num',label:'Part Number',sampleData:'PRT-10042'},
      {name:'part_description',sqlExpr:'p.description',label:'Description',sampleData:'Hex Bolt M8x25'},
      {name:'part_upc',sqlExpr:'p.upc',label:'UPC',sampleData:'012345678905'},
      {name:'product_price',sqlExpr:'pr.price',label:'Price',sampleData:'$24.99'},
      {name:'location_name',sqlExpr:'l.name',label:'Location',sampleData:'Shelf A-3'},
      {name:'uom',sqlExpr:"COALESCE(uom.code,'EA')",label:'UOM',sampleData:'ea'}
    ],
    query:{sql:"SELECT p.num AS part_number, p.description AS part_description, p.upc AS part_upc, COALESCE(uom.code,'EA') AS uom, l.name AS location_name, lg.name AS location_group FROM part p LEFT JOIN uom ON p.uomid=uom.id LEFT JOIN tag t ON p.id=t.partid LEFT JOIN location l ON t.locationid=l.id LEFT JOIN locationgroup lg ON l.locationgroupid=lg.id WHERE p.typeid=10 AND p.activeflag=1 GROUP BY p.id ORDER BY p.num"},
    parameters:[{name:'location_group',prompt:'Location Group',inputType:'dropdown',lookupQuery:"SELECT id,name FROM locationgroup WHERE activeflag=1 ORDER BY name"}],
    options:{toggleableFields:['product_price','location_name','uom']}
  },
  {
    meta:{name:'Receiving Label',description:'Labels for PO receipt items',icon:'receive',labelSize:'4x3'},
    label:{name:'Receiving Label',width:288,height:216},
    elements:[
      {id:'e1',type:'staticText',text:'RECEIVED',x:10,y:8,width:80,height:18,fontSize:10,fontBold:true,fontFamily:'SansSerif',textAlign:'left',textColor:'#666666',rotation:0,zIndex:1,uuid:''},
      {id:'e2',type:'fieldToken',fieldName:'po_number',x:100,y:5,width:178,height:22,fontSize:16,fontBold:true,fontFamily:'SansSerif',textAlign:'right',textColor:'#000000',rotation:0,zIndex:2,uuid:''},
      {id:'e3',type:'line',orientation:'horizontal',x:10,y:30,width:268,height:1,lineThickness:1,lineColor:'#000000',rotation:0,zIndex:3,uuid:''},
      {id:'e4',type:'barcode',barcodeType:'Code128',dataSource:'field',fieldName:'part_number',staticValue:'',x:10,y:38,width:200,height:55,showHumanReadable:true,rotation:0,zIndex:4,uuid:''},
      {id:'e5',type:'fieldToken',fieldName:'description',x:10,y:100,width:268,height:20,fontSize:12,fontBold:false,fontFamily:'SansSerif',textAlign:'left',textColor:'#333333',rotation:0,zIndex:5,uuid:''},
      {id:'e6',type:'staticText',text:'Qty:',x:10,y:128,width:30,height:20,fontSize:12,fontBold:true,fontFamily:'SansSerif',textAlign:'left',textColor:'#000000',rotation:0,zIndex:6,uuid:''},
      {id:'e7',type:'fieldToken',fieldName:'received_qty',x:42,y:128,width:60,height:20,fontSize:14,fontBold:true,fontFamily:'SansSerif',textAlign:'left',textColor:'#000000',rotation:0,zIndex:7,uuid:''},
      {id:'e8',type:'fieldToken',fieldName:'vendor_name',x:10,y:155,width:200,height:16,fontSize:10,fontBold:false,fontFamily:'SansSerif',textAlign:'left',textColor:'#666666',rotation:0,zIndex:8,uuid:''},
      {id:'e9',type:'fieldToken',fieldName:'date_received',x:10,y:175,width:120,height:16,fontSize:10,fontBold:false,fontFamily:'SansSerif',textAlign:'left',textColor:'#666666',rotation:0,zIndex:9,uuid:''}
    ],
    fields:[
      {name:'po_number',sqlExpr:'po.num',label:'PO Number',sampleData:'PO-12345'},
      {name:'part_number',sqlExpr:'p.num',label:'Part Number',sampleData:'PRT-10042'},
      {name:'description',sqlExpr:'p.description',label:'Description',sampleData:'Hex Bolt M8x25'},
      {name:'received_qty',sqlExpr:'ri.qty',label:'Received Qty',sampleData:'50'},
      {name:'uom',sqlExpr:"COALESCE(uom.code,'EA')",label:'UOM',sampleData:'ea'},
      {name:'vendor_name',sqlExpr:'v.name',label:'Vendor',sampleData:'Acme Supply Co'},
      {name:'date_received',sqlExpr:'COALESCE(GREATEST(ri.dateReceived,ri.dateReconciled),ri.dateReceived)',label:'Date Received',sampleData:'2025-12-15'},
      {name:'unit_cost',sqlExpr:'ri.landedtotalcost/NULLIF(ri.qty,0)',label:'Unit Cost',sampleData:'$4.50'},
      {name:'location_group',sqlExpr:'lg.name',label:'Location Group',sampleData:'Main Warehouse'}
    ],
    query:{sql:"SELECT po.num AS po_number,p.num AS part_number,p.description,ri.qty AS received_qty,COALESCE(uom.code,'EA') AS uom,v.name AS vendor_name,COALESCE(GREATEST(ri.dateReceived,ri.dateReconciled),ri.dateReceived) AS date_received,ri.landedtotalcost/NULLIF(ri.qty,0) AS unit_cost,lg.name AS location_group FROM receiptitem ri JOIN receipt r ON ri.receiptid=r.id JOIN poitem ON ri.poitemid=poitem.id JOIN part p ON poitem.partid=p.id JOIN po ON poitem.poid=po.id LEFT JOIN vendor v ON po.vendorid=v.id LEFT JOIN uom ON p.uomid=uom.id LEFT JOIN locationgroup lg ON r.locationgroupid=lg.id WHERE ri.statusid>=20 AND p.typeid=10 AND po.num LIKE $P{po_number} ORDER BY p.num"},
    parameters:[{name:'po_number',prompt:'PO Number',inputType:'text',default:'%'}],
    options:{toggleableFields:['unit_cost','vendor_name','date_received']}
  },
  {
    meta:{name:'Shipping Label',description:'Labels for SO shipments',icon:'ship',labelSize:'4x6'},
    label:{name:'Shipping Label',width:288,height:432},
    elements:[
      {id:'e1',type:'fieldToken',fieldName:'ship_to_address',x:10,y:10,width:268,height:22,fontSize:14,fontBold:true,fontFamily:'SansSerif',textAlign:'left',textColor:'#000000',rotation:0,zIndex:1,uuid:''},
      {id:'e2',type:'fieldToken',fieldName:'customer_name',x:10,y:35,width:268,height:20,fontSize:13,fontBold:false,fontFamily:'SansSerif',textAlign:'left',textColor:'#333333',rotation:0,zIndex:2,uuid:''},
      {id:'e3',type:'line',orientation:'horizontal',x:10,y:62,width:268,height:1,lineThickness:1,lineColor:'#000000',rotation:0,zIndex:3,uuid:''},
      {id:'e4',type:'staticText',text:'SO:',x:10,y:70,width:25,height:18,fontSize:11,fontBold:true,fontFamily:'SansSerif',textAlign:'left',textColor:'#666',rotation:0,zIndex:4,uuid:''},
      {id:'e5',type:'fieldToken',fieldName:'sales_order',x:38,y:70,width:100,height:18,fontSize:12,fontBold:true,fontFamily:'SansSerif',textAlign:'left',textColor:'#000',rotation:0,zIndex:5,uuid:''},
      {id:'e6',type:'staticText',text:'Ship#:',x:150,y:70,width:40,height:18,fontSize:11,fontBold:true,fontFamily:'SansSerif',textAlign:'left',textColor:'#666',rotation:0,zIndex:6,uuid:''},
      {id:'e7',type:'fieldToken',fieldName:'ship_number',x:192,y:70,width:86,height:18,fontSize:12,fontBold:true,fontFamily:'SansSerif',textAlign:'left',textColor:'#000',rotation:0,zIndex:7,uuid:''},
      {id:'e8',type:'barcode',barcodeType:'Code128',dataSource:'field',fieldName:'part_number',staticValue:'',x:10,y:96,width:220,height:60,showHumanReadable:true,rotation:0,zIndex:8,uuid:''},
      {id:'e9',type:'fieldToken',fieldName:'description',x:10,y:165,width:268,height:20,fontSize:12,fontBold:false,fontFamily:'SansSerif',textAlign:'left',textColor:'#333',rotation:0,zIndex:9,uuid:''},
      {id:'e10',type:'fieldToken',fieldName:'qty_shipped',x:10,y:192,width:80,height:22,fontSize:16,fontBold:true,fontFamily:'SansSerif',textAlign:'left',textColor:'#000',rotation:0,zIndex:10,uuid:''},
      {id:'e11',type:'fieldToken',fieldName:'carrier',x:10,y:220,width:180,height:16,fontSize:10,fontBold:false,fontFamily:'SansSerif',textAlign:'left',textColor:'#666',rotation:0,zIndex:11,uuid:''}
    ],
    fields:[
      {name:'ship_number',sqlExpr:'ship.num',label:'Ship Number',sampleData:'S-00234'},
      {name:'sales_order',sqlExpr:'so.num',label:'Sales Order',sampleData:'SO-10567'},
      {name:'customer_name',sqlExpr:'c.name',label:'Customer',sampleData:'Widget Corp'},
      {name:'ship_to_address',sqlExpr:'ship.shiptoname',label:'Ship To',sampleData:'123 Industrial Blvd'},
      {name:'part_number',sqlExpr:'p.num',label:'Part Number',sampleData:'PRT-10042'},
      {name:'description',sqlExpr:'p.description',label:'Description',sampleData:'Hex Bolt M8x25'},
      {name:'qty_shipped',sqlExpr:'si.qtyshipped',label:'Qty Shipped',sampleData:'25'},
      {name:'carrier',sqlExpr:'cr.name',label:'Carrier',sampleData:'FedEx'},
      {name:'service',sqlExpr:'cs.name',label:'Service',sampleData:'Ground'},
      {name:'customer_po',sqlExpr:'so.customerpo',label:'Customer PO',sampleData:'CPO-8899'}
    ],
    query:{sql:"SELECT ship.num AS ship_number,so.num AS sales_order,c.name AS customer_name,ship.shiptoname AS ship_to_address,p.num AS part_number,p.description,si.qtyshipped AS qty_shipped,COALESCE(uom.code,'EA') AS uom,cr.name AS carrier,cs.name AS service,so.customerpo AS customer_po FROM shipitem si JOIN ship ON si.shipid=ship.id JOIN soitem soi ON si.soitemid=soi.id JOIN so ON soi.soid=so.id JOIN part p ON soi.productid=p.id LEFT JOIN customer c ON so.customerid=c.id LEFT JOIN uom ON p.uomid=uom.id LEFT JOIN carrier cr ON ship.carrierid=cr.id LEFT JOIN carrierservice cs ON ship.carrierserviceid=cs.id LEFT JOIN shipstatus ss ON ship.statusid=ss.id WHERE ss.name IN ('Entered','Packed') AND p.typeid=10 ORDER BY ship.num,p.num"},
    parameters:[{name:'so_number',prompt:'SO Number',inputType:'text',default:'%'}],
    options:{toggleableFields:['carrier','service','customer_po']}
  },
  {
    meta:{name:'Pick Ticket Label',description:'Labels for warehouse picks',icon:'pick',labelSize:'4x3'},
    label:{name:'Pick Label',width:288,height:216},
    elements:[
      {id:'e1',type:'staticText',text:'PICK',x:10,y:5,width:40,height:18,fontSize:10,fontBold:true,fontFamily:'SansSerif',textAlign:'left',textColor:'#666',rotation:0,zIndex:1,uuid:''},
      {id:'e2',type:'fieldToken',fieldName:'pick_number',x:55,y:3,width:223,height:22,fontSize:16,fontBold:true,fontFamily:'SansSerif',textAlign:'right',textColor:'#000',rotation:0,zIndex:2,uuid:''},
      {id:'e3',type:'line',orientation:'horizontal',x:10,y:28,width:268,height:1,lineThickness:1,lineColor:'#000',rotation:0,zIndex:3,uuid:''},
      {id:'e4',type:'barcode',barcodeType:'Code128',dataSource:'field',fieldName:'part_number',staticValue:'',x:10,y:35,width:200,height:50,showHumanReadable:true,rotation:0,zIndex:4,uuid:''},
      {id:'e5',type:'fieldToken',fieldName:'description',x:10,y:92,width:268,height:18,fontSize:11,fontBold:false,fontFamily:'SansSerif',textAlign:'left',textColor:'#333',rotation:0,zIndex:5,uuid:''},
      {id:'e6',type:'staticText',text:'Pick Qty:',x:10,y:118,width:55,height:20,fontSize:12,fontBold:true,fontFamily:'SansSerif',textAlign:'left',textColor:'#000',rotation:0,zIndex:6,uuid:''},
      {id:'e7',type:'fieldToken',fieldName:'qty_to_pick',x:68,y:118,width:50,height:20,fontSize:14,fontBold:true,fontFamily:'SansSerif',textAlign:'left',textColor:'#000',rotation:0,zIndex:7,uuid:''},
      {id:'e8',type:'staticText',text:'Avail:',x:140,y:118,width:40,height:20,fontSize:12,fontBold:false,fontFamily:'SansSerif',textAlign:'left',textColor:'#666',rotation:0,zIndex:8,uuid:''},
      {id:'e9',type:'fieldToken',fieldName:'available_qty',x:182,y:118,width:50,height:20,fontSize:14,fontBold:false,fontFamily:'SansSerif',textAlign:'left',textColor:'#666',rotation:0,zIndex:9,uuid:''},
      {id:'e10',type:'fieldToken',fieldName:'order_number',x:10,y:148,width:180,height:16,fontSize:10,fontBold:false,fontFamily:'SansSerif',textAlign:'left',textColor:'#666',rotation:0,zIndex:10,uuid:''}
    ],
    fields:[
      {name:'pick_number',sqlExpr:'pick.num',label:'Pick Number',sampleData:'PKT-00456'},
      {name:'part_number',sqlExpr:'p.num',label:'Part Number',sampleData:'PRT-10042'},
      {name:'description',sqlExpr:'p.description',label:'Description',sampleData:'Hex Bolt M8x25'},
      {name:'qty_to_pick',sqlExpr:'pi.qty',label:'Qty to Pick',sampleData:'30'},
      {name:'available_qty',sqlExpr:'COALESCE((SELECT qty FROM qtyonhand WHERE partid=pi.partid AND locationgroupid=pick.locationgroupid),0)-COALESCE((SELECT qty FROM qtycommitted WHERE partid=pi.partid AND locationgroupid=pick.locationgroupid),0)-COALESCE((SELECT qty FROM qtynotavailabletopick WHERE partid=pi.partid AND locationgroupid=pick.locationgroupid),0)',label:'Available Qty',sampleData:'85'},
      {name:'order_type',sqlExpr:"CASE pi.ordertypeid WHEN 10 THEN 'PO' WHEN 20 THEN 'SO' WHEN 30 THEN 'WO' WHEN 40 THEN 'TO' ELSE '' END",label:'Order Type',sampleData:'SO'},
      {name:'order_number',sqlExpr:'COALESCE(so.num,po.num,wo.num)',label:'Order Number',sampleData:'SO-10567'},
      {name:'entity_name',sqlExpr:'COALESCE(c.name,v.name)',label:'Customer/Vendor',sampleData:'Widget Corp'},
      {name:'scheduled_date',sqlExpr:'pick.datescheduled',label:'Scheduled Date',sampleData:'2025-12-20'}
    ],
    query:{sql:"SELECT pick.num AS pick_number,p.num AS part_number,p.description,pi.qty AS qty_to_pick,COALESCE((SELECT qty FROM qtyonhand WHERE partid=pi.partid AND locationgroupid=pick.locationgroupid),0)-COALESCE((SELECT qty FROM qtycommitted WHERE partid=pi.partid AND locationgroupid=pick.locationgroupid),0)-COALESCE((SELECT qty FROM qtynotavailabletopick WHERE partid=pi.partid AND locationgroupid=pick.locationgroupid),0) AS available_qty,CASE pi.ordertypeid WHEN 10 THEN 'PO' WHEN 20 THEN 'SO' WHEN 30 THEN 'WO' WHEN 40 THEN 'TO' ELSE '' END AS order_type,COALESCE(so.num,po.num,wo.num) AS order_number,COALESCE(c.name,v.name) AS entity_name,pick.datescheduled AS scheduled_date FROM pick JOIN pickitem pi ON pi.pickid=pick.id JOIN part p ON pi.partid=p.id LEFT JOIN soitem si ON pi.soitemid=si.id LEFT JOIN so ON si.soid=so.id LEFT JOIN customer c ON so.customerid=c.id LEFT JOIN poitem pmi ON pi.poitemid=pmi.id LEFT JOIN po ON pmi.poid=po.id LEFT JOIN vendor v ON po.vendorid=v.id LEFT JOIN woitem wi ON pi.woitemid=wi.id LEFT JOIN wo ON wi.woid=wo.id WHERE pick.statusid<40 AND pi.statusid<40 AND p.typeid=10 ORDER BY pick.datescheduled,pick.num"},
    parameters:[{name:'pick_number',prompt:'Pick Number',inputType:'text',default:'%'}],
    options:{toggleableFields:['available_qty','order_number','entity_name','scheduled_date']}
  },
  {
    meta:{name:'Work Order Label',description:'Labels for WO finished goods',icon:'build',labelSize:'4x3'},
    label:{name:'Work Order Label',width:288,height:216},
    elements:[
      {id:'e1',type:'staticText',text:'WORK ORDER',x:10,y:5,width:80,height:18,fontSize:10,fontBold:true,fontFamily:'SansSerif',textAlign:'left',textColor:'#666',rotation:0,zIndex:1,uuid:''},
      {id:'e2',type:'fieldToken',fieldName:'work_order_number',x:100,y:3,width:178,height:22,fontSize:16,fontBold:true,fontFamily:'SansSerif',textAlign:'right',textColor:'#000',rotation:0,zIndex:2,uuid:''},
      {id:'e3',type:'line',orientation:'horizontal',x:10,y:28,width:268,height:1,lineThickness:1,lineColor:'#000',rotation:0,zIndex:3,uuid:''},
      {id:'e4',type:'barcode',barcodeType:'Code128',dataSource:'field',fieldName:'finished_part_number',staticValue:'',x:10,y:35,width:200,height:50,showHumanReadable:true,rotation:0,zIndex:4,uuid:''},
      {id:'e5',type:'fieldToken',fieldName:'finished_part_description',x:10,y:92,width:268,height:18,fontSize:11,fontBold:false,fontFamily:'SansSerif',textAlign:'left',textColor:'#333',rotation:0,zIndex:5,uuid:''},
      {id:'e6',type:'staticText',text:'Qty:',x:10,y:118,width:30,height:20,fontSize:12,fontBold:true,fontFamily:'SansSerif',textAlign:'left',textColor:'#000',rotation:0,zIndex:6,uuid:''},
      {id:'e7',type:'fieldToken',fieldName:'qty_to_produce',x:42,y:118,width:60,height:20,fontSize:14,fontBold:true,fontFamily:'SansSerif',textAlign:'left',textColor:'#000',rotation:0,zIndex:7,uuid:''},
      {id:'e8',type:'fieldToken',fieldName:'bom_number',x:10,y:148,width:180,height:16,fontSize:10,fontBold:false,fontFamily:'SansSerif',textAlign:'left',textColor:'#666',rotation:0,zIndex:8,uuid:''}
    ],
    fields:[
      {name:'work_order_number',sqlExpr:'wo.num',label:'WO Number',sampleData:'WO-00789'},
      {name:'finished_part_number',sqlExpr:'p.num',label:'Part Number',sampleData:'ASM-5001'},
      {name:'finished_part_description',sqlExpr:'p.description',label:'Description',sampleData:'Motor Assembly'},
      {name:'qty_to_produce',sqlExpr:'wi.qty',label:'Qty to Produce',sampleData:'10'},
      {name:'bom_number',sqlExpr:'bom.num',label:'BOM Number',sampleData:'BOM-200'},
      {name:'manufacturing_order',sqlExpr:'mo.num',label:'MO Number',sampleData:'MO-100'},
      {name:'work_order_status',sqlExpr:'ws.name',label:'Status',sampleData:'Started'}
    ],
    query:{sql:"SELECT wo.num AS work_order_number,p.num AS finished_part_number,p.description AS finished_part_description,wi.qty AS qty_to_produce,COALESCE(uom.code,'EA') AS uom,bom.num AS bom_number,mo.num AS manufacturing_order,ws.name AS work_order_status,lg.name AS location_group FROM wo LEFT JOIN woitem wi ON wo.id=wi.woid LEFT JOIN part p ON wi.partid=p.id LEFT JOIN uom ON p.uomid=uom.id LEFT JOIN moitem mi ON wo.moitemid=mi.id LEFT JOIN mo ON mi.moid=mo.id LEFT JOIN bom ON mi.bomid=bom.id LEFT JOIN wostatus ws ON wo.statusid=ws.id LEFT JOIN locationgroup lg ON wo.locationgroupid=lg.id WHERE wo.statusid IN (10,30) AND p.typeid=10 ORDER BY wo.datescheduled,wo.num"},
    parameters:[{name:'wo_number',prompt:'WO Number',inputType:'text',default:'%'}],
    options:{toggleableFields:['bom_number','manufacturing_order','work_order_status']}
  },
  {
    meta:{name:'Inventory Location Label',description:'Labels for bin/shelf locations',icon:'location',labelSize:'4x3'},
    label:{name:'Location Label',width:288,height:216},
    elements:[
      {id:'e1',type:'fieldToken',fieldName:'location_name',x:10,y:8,width:268,height:28,fontSize:20,fontBold:true,fontFamily:'SansSerif',textAlign:'center',textColor:'#000',rotation:0,zIndex:1,uuid:''},
      {id:'e2',type:'line',orientation:'horizontal',x:10,y:40,width:268,height:1,lineThickness:2,lineColor:'#000',rotation:0,zIndex:2,uuid:''},
      {id:'e3',type:'barcode',barcodeType:'Code128',dataSource:'field',fieldName:'part_number',staticValue:'',x:10,y:48,width:200,height:50,showHumanReadable:true,rotation:0,zIndex:3,uuid:''},
      {id:'e4',type:'fieldToken',fieldName:'description',x:10,y:105,width:268,height:18,fontSize:11,fontBold:false,fontFamily:'SansSerif',textAlign:'left',textColor:'#333',rotation:0,zIndex:4,uuid:''},
      {id:'e5',type:'staticText',text:'Qty:',x:10,y:130,width:30,height:20,fontSize:12,fontBold:true,fontFamily:'SansSerif',textAlign:'left',textColor:'#000',rotation:0,zIndex:5,uuid:''},
      {id:'e6',type:'fieldToken',fieldName:'qty_at_location',x:42,y:130,width:60,height:20,fontSize:14,fontBold:true,fontFamily:'SansSerif',textAlign:'left',textColor:'#000',rotation:0,zIndex:6,uuid:''},
      {id:'e7',type:'fieldToken',fieldName:'location_group',x:10,y:160,width:180,height:16,fontSize:10,fontBold:false,fontFamily:'SansSerif',textAlign:'left',textColor:'#666',rotation:0,zIndex:7,uuid:''}
    ],
    fields:[
      {name:'location_name',sqlExpr:'l.name',label:'Location',sampleData:'Shelf A-3'},
      {name:'location_group',sqlExpr:'lg.name',label:'Location Group',sampleData:'Main Warehouse'},
      {name:'part_number',sqlExpr:'p.num',label:'Part Number',sampleData:'PRT-10042'},
      {name:'description',sqlExpr:'p.description',label:'Description',sampleData:'Hex Bolt M8x25'},
      {name:'qty_at_location',sqlExpr:'t.qty',label:'Qty at Location',sampleData:'142'},
      {name:'uom',sqlExpr:"COALESCE(uom.code,'EA')",label:'UOM',sampleData:'ea'},
      {name:'unit_cost',sqlExpr:'COALESCE(pc.avgcost,0)',label:'Unit Cost',sampleData:'$4.50'},
      {name:'total_value',sqlExpr:'t.qty*COALESCE(pc.avgcost,0)',label:'Total Value',sampleData:'$639.00'},
      {name:'reorder_point',sqlExpr:'pr.reorderpoint',label:'Reorder Point',sampleData:'50'},
      {name:'stock_status',sqlExpr:"CASE WHEN t.qty<pr.reorderpoint THEN 'LOW STOCK' ELSE 'OK' END",label:'Stock Status',sampleData:'OK'}
    ],
    query:{sql:"SELECT l.name AS location_name,lg.name AS location_group,p.num AS part_number,p.description,t.qty AS qty_at_location,COALESCE(uom.code,'EA') AS uom,COALESCE(pc.avgcost,0) AS unit_cost,t.qty*COALESCE(pc.avgcost,0) AS total_value,pr.reorderpoint AS reorder_point,CASE WHEN t.qty<pr.reorderpoint THEN 'LOW STOCK' ELSE 'OK' END AS stock_status FROM tag t JOIN location l ON t.locationid=l.id JOIN locationgroup lg ON l.locationgroupid=lg.id JOIN part p ON t.partid=p.id LEFT JOIN uom ON p.uomid=uom.id LEFT JOIN partcost pc ON p.id=pc.partid LEFT JOIN partreorder pr ON p.id=pr.partid AND pr.locationgroupid=lg.id WHERE t.qty>0 AND p.typeid=10 AND p.activeflag=1 ORDER BY l.name,p.num"},
    parameters:[{name:'location_group_id',prompt:'Location Group',inputType:'dropdown',lookupQuery:"SELECT id,name FROM locationgroup WHERE activeflag=1 ORDER BY name"}],
    options:{toggleableFields:['unit_cost','total_value','reorder_point','stock_status']}
  },
  {
    meta:{name:'Serial / Lot Tracking Label',description:'Labels for serial or lot tracked items',icon:'tag',labelSize:'4x6'},
    label:{name:'Tracking Label',width:288,height:432},
    elements:[
      {id:'e1',type:'fieldToken',fieldName:'part_number',x:10,y:10,width:268,height:28,fontSize:20,fontBold:true,fontFamily:'SansSerif',textAlign:'left',textColor:'#000000',rotation:0,zIndex:1,uuid:''},
      {id:'e2',type:'fieldToken',fieldName:'part_description',x:10,y:42,width:268,height:20,fontSize:12,fontBold:false,fontFamily:'SansSerif',textAlign:'left',textColor:'#333333',rotation:0,zIndex:2,uuid:''},
      {id:'e3',type:'line',orientation:'horizontal',x:10,y:68,width:268,height:1,lineThickness:1,lineColor:'#000000',rotation:0,zIndex:3,uuid:''},
      {id:'e4',type:'staticText',text:'TRACKING:',x:10,y:75,width:70,height:16,fontSize:9,fontBold:true,fontFamily:'SansSerif',textAlign:'left',textColor:'#666666',rotation:0,zIndex:4,uuid:''},
      {id:'e5',type:'fieldToken',fieldName:'tracking_type',x:82,y:74,width:196,height:18,fontSize:11,fontBold:true,fontFamily:'SansSerif',textAlign:'left',textColor:'#000000',rotation:0,zIndex:5,uuid:''},
      {id:'e6',type:'barcode',barcodeType:'Code128',dataSource:'field',fieldName:'serial_number',staticValue:'',x:10,y:98,width:240,height:80,showHumanReadable:true,rotation:0,zIndex:6,uuid:''},
      {id:'e7',type:'staticText',text:'Qty:',x:10,y:190,width:30,height:20,fontSize:12,fontBold:true,fontFamily:'SansSerif',textAlign:'left',textColor:'#000000',rotation:0,zIndex:7,uuid:''},
      {id:'e8',type:'fieldToken',fieldName:'batch_qty',x:42,y:190,width:60,height:20,fontSize:14,fontBold:true,fontFamily:'SansSerif',textAlign:'left',textColor:'#000000',rotation:0,zIndex:8,uuid:''},
      {id:'e9',type:'fieldToken',fieldName:'location_name',x:10,y:218,width:200,height:16,fontSize:10,fontBold:false,fontFamily:'SansSerif',textAlign:'left',textColor:'#666666',rotation:0,zIndex:9,uuid:''},
      {id:'e10',type:'fieldToken',fieldName:'tag_date',x:10,y:238,width:120,height:16,fontSize:10,fontBold:false,fontFamily:'SansSerif',textAlign:'left',textColor:'#666666',rotation:0,zIndex:10,uuid:''}
    ],
    fields:[
      {name:'part_number',sqlExpr:'p.num',label:'Part Number',sampleData:'PRT-10042'},
      {name:'part_description',sqlExpr:'p.description',label:'Description',sampleData:'Hex Bolt M8x25'},
      {name:'tracking_type',sqlExpr:"CASE pt.trackingtypeid WHEN 1 THEN 'Lot' WHEN 2 THEN 'Serial' WHEN 3 THEN 'Lot & Serial' ELSE 'None' END",label:'Tracking Type',sampleData:'Serial'},
      {name:'serial_number',sqlExpr:'sn.serialnumber',label:'Serial/Lot Number',sampleData:'SN-2024-00158'},
      {name:'batch_qty',sqlExpr:'t.qty',label:'Qty',sampleData:'1'},
      {name:'location_name',sqlExpr:'l.name',label:'Location',sampleData:'Shelf A-3'},
      {name:'location_group',sqlExpr:'lg.name',label:'Location Group',sampleData:'Main Warehouse'},
      {name:'tag_date',sqlExpr:'t.datetimecreated',label:'Tag Date',sampleData:'2025-12-15'}
    ],
    query:{sql:"SELECT p.num AS part_number,p.description AS part_description,CASE pt.trackingtypeid WHEN 1 THEN 'Lot' WHEN 2 THEN 'Serial' WHEN 3 THEN 'Lot & Serial' ELSE 'None' END AS tracking_type,sn.serialnumber AS serial_number,t.qty AS batch_qty,l.name AS location_name,lg.name AS location_group,t.datetimecreated AS tag_date FROM tag t JOIN part p ON t.partid=p.id LEFT JOIN parttracking pt ON p.id=pt.partid LEFT JOIN serialnum sn ON t.partid=sn.partid LEFT JOIN location l ON t.locationid=l.id LEFT JOIN locationgroup lg ON l.locationgroupid=lg.id WHERE t.qty>0 AND p.typeid=10 AND pt.trackingtypeid IS NOT NULL ORDER BY p.num,sn.serialnumber"},
    parameters:[{name:'location_group_id',prompt:'Location Group',inputType:'dropdown',lookupQuery:"SELECT id,name FROM locationgroup WHERE activeflag=1 ORDER BY name"}],
    options:{toggleableFields:['location_name','tag_date','batch_qty']}
  },
  {
    meta:{name:'Multi-Tracking Label',description:'Labels with multiple tracking values and expiration',icon:'tag',labelSize:'4x6'},
    label:{name:'Multi-Tracking Label',width:288,height:432},
    elements:[
      {id:'e1',type:'fieldToken',fieldName:'part_number',x:10,y:10,width:268,height:28,fontSize:20,fontBold:true,fontFamily:'SansSerif',textAlign:'left',textColor:'#000000',rotation:0,zIndex:1,uuid:''},
      {id:'e2',type:'fieldToken',fieldName:'part_description',x:10,y:42,width:268,height:20,fontSize:12,fontBold:false,fontFamily:'SansSerif',textAlign:'left',textColor:'#333333',rotation:0,zIndex:2,uuid:''},
      {id:'e3',type:'line',orientation:'horizontal',x:10,y:68,width:268,height:1,lineThickness:1,lineColor:'#000000',rotation:0,zIndex:3,uuid:''},
      {id:'e4',type:'barcode',barcodeType:'Code128',dataSource:'field',fieldName:'primary_tracking',staticValue:'',x:10,y:75,width:240,height:70,showHumanReadable:true,rotation:0,zIndex:4,uuid:''},
      {id:'e5',type:'staticText',text:'LOT:',x:10,y:152,width:32,height:16,fontSize:9,fontBold:true,fontFamily:'SansSerif',textAlign:'left',textColor:'#666666',rotation:0,zIndex:5,uuid:''},
      {id:'e6',type:'fieldToken',fieldName:'lot_number',x:44,y:151,width:234,height:18,fontSize:12,fontBold:true,fontFamily:'SansSerif',textAlign:'left',textColor:'#000000',rotation:0,zIndex:6,uuid:''},
      {id:'e7',type:'staticText',text:'SERIAL:',x:10,y:174,width:45,height:16,fontSize:9,fontBold:true,fontFamily:'SansSerif',textAlign:'left',textColor:'#666666',rotation:0,zIndex:7,uuid:''},
      {id:'e8',type:'fieldToken',fieldName:'serial_number',x:58,y:173,width:220,height:18,fontSize:12,fontBold:true,fontFamily:'SansSerif',textAlign:'left',textColor:'#000000',rotation:0,zIndex:8,uuid:''},
      {id:'e9',type:'staticText',text:'EXP:',x:10,y:196,width:32,height:16,fontSize:9,fontBold:true,fontFamily:'SansSerif',textAlign:'left',textColor:'#666666',rotation:0,zIndex:9,uuid:''},
      {id:'e10',type:'fieldToken',fieldName:'expiration_date',x:44,y:195,width:150,height:18,fontSize:12,fontBold:true,fontFamily:'SansSerif',textAlign:'left',textColor:'#cc0000',rotation:0,zIndex:10,uuid:''},
      {id:'e11',type:'staticText',text:'Qty:',x:10,y:222,width:30,height:20,fontSize:12,fontBold:true,fontFamily:'SansSerif',textAlign:'left',textColor:'#000000',rotation:0,zIndex:11,uuid:''},
      {id:'e12',type:'fieldToken',fieldName:'batch_qty',x:42,y:222,width:60,height:20,fontSize:14,fontBold:true,fontFamily:'SansSerif',textAlign:'left',textColor:'#000000',rotation:0,zIndex:12,uuid:''},
      {id:'e13',type:'fieldToken',fieldName:'location_name',x:10,y:250,width:200,height:16,fontSize:10,fontBold:false,fontFamily:'SansSerif',textAlign:'left',textColor:'#666666',rotation:0,zIndex:13,uuid:''}
    ],
    fields:[
      {name:'part_number',sqlExpr:'p.num',label:'Part Number',sampleData:'PRT-10042'},
      {name:'part_description',sqlExpr:'p.description',label:'Description',sampleData:'Hex Bolt M8x25'},
      {name:'primary_tracking',sqlExpr:'COALESCE(sn.serialnumber,p.num)',label:'Primary Tracking',sampleData:'SN-2024-00158'},
      {name:'lot_number',sqlExpr:"(SELECT sn2.serialnumber FROM serialnum sn2 JOIN parttracking pt2 ON sn2.parttrackingid=pt2.id WHERE pt2.trackingtypeid=1 AND sn2.partid=p.id LIMIT 1)",label:'Lot Number',sampleData:'LOT-2024-A'},
      {name:'serial_number',sqlExpr:"(SELECT sn3.serialnumber FROM serialnum sn3 JOIN parttracking pt3 ON sn3.parttrackingid=pt3.id WHERE pt3.trackingtypeid=2 AND sn3.partid=p.id LIMIT 1)",label:'Serial Number',sampleData:'SN-2024-00158'},
      {name:'expiration_date',sqlExpr:"(SELECT sn4.serialnumber FROM serialnum sn4 JOIN parttracking pt4 ON sn4.parttrackingid=pt4.id WHERE pt4.trackingtypeid=4 AND sn4.partid=p.id LIMIT 1)",label:'Expiration Date',sampleData:'2026-06-30'},
      {name:'batch_qty',sqlExpr:'t.qty',label:'Qty',sampleData:'50'},
      {name:'location_name',sqlExpr:'l.name',label:'Location',sampleData:'Shelf A-3'},
      {name:'location_group',sqlExpr:'lg.name',label:'Location Group',sampleData:'Main Warehouse'}
    ],
    query:{sql:"SELECT p.num AS part_number,p.description AS part_description,COALESCE(sn.serialnumber,p.num) AS primary_tracking,t.qty AS batch_qty,l.name AS location_name,lg.name AS location_group FROM tag t JOIN part p ON t.partid=p.id LEFT JOIN serialnum sn ON t.partid=sn.partid LEFT JOIN location l ON t.locationid=l.id LEFT JOIN locationgroup lg ON l.locationgroupid=lg.id WHERE t.qty>0 AND p.typeid=10 ORDER BY p.num"},
    parameters:[{name:'location_group_id',prompt:'Location Group',inputType:'dropdown',lookupQuery:"SELECT id,name FROM locationgroup WHERE activeflag=1 ORDER BY name"}],
    options:{toggleableFields:['lot_number','serial_number','expiration_date','location_name']}
  }
];

// =============================================
// APPLICATION STATE
// =============================================
let state = {
  currentView: 'selector',
  currentTemplate: null,
  label: {width:288,height:432,name:'My Label'},
  elements: [],
  selectedIds: [],
  clipboard: [],
  zoom: 2,
  gridSize: 9,
  showGrid: true,
  snapToGrid: true,
  displayUnit: 'in',
  previewMode: false,
  nextId: 1,
  nextZIndex: 1,
  undoStack: [],
  redoStack: [],
  customFields: [],
  dragState: null,
  marquee: null,
  savedTemplates: [],
  hiddenFields: new Set(),
  templateQuery: null,
  templateParams: [],
  templateFields: []
};

// =============================================
// UTILITIES
// =============================================
function uid(){return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{const r=Math.random()*16|0;return(c==='x'?r:(r&0x3|0x8)).toString(16)})}
function genId(){return 'elem_'+(state.nextId++)}
function mmToPt(mm){return Math.round(mm*72/25.4)}
function inToPt(i){return Math.round(i*72)}
function ptToMm(pt){return(pt*25.4/72).toFixed(1)}
function ptToIn(pt){return(pt/72).toFixed(3)}
function snap(v){return state.snapToGrid?Math.round(v/state.gridSize)*state.gridSize:Math.round(v)}
function clamp(v,min,max){return Math.max(min,Math.min(max,v))}
function deepClone(o){return JSON.parse(JSON.stringify(o))}
function esc(s){return String(s).replace(/"/g,'&quot;').replace(/</g,'&lt;')}
function xmlEsc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}
function hexToRgbArr(hex){if(!hex||hex==='transparent')return[0,0,0];return[parseInt(hex.slice(1,3),16),parseInt(hex.slice(3,5),16),parseInt(hex.slice(5,7),16)]}

// Unit display conversion (internal storage is always pt)
function ptToDisplay(pt) {
  const u = state.displayUnit;
  if (u === 'mm') return (pt * 25.4 / 72).toFixed(2);
  if (u === 'in') return (pt / 72).toFixed(3);
  return String(Math.round(pt));
}
function displayToPt(val) {
  const v = parseFloat(val);
  if (isNaN(v)) return 0;
  const u = state.displayUnit;
  if (u === 'mm') return Math.round(v * 72 / 25.4);
  if (u === 'in') return Math.round(v * 72);
  return Math.round(v);
}
function unitSuffix() { return state.displayUnit; }

// =============================================
// VIEW MANAGEMENT
// =============================================
function showView(view) {
  state.currentView = view;
  document.getElementById('view-selector').style.display = view === 'selector' ? 'flex' : 'none';
  document.getElementById('view-preview').style.display = view === 'preview' ? 'flex' : 'none';
  const editor = document.getElementById('view-editor');
  editor.style.display = view === 'editor' ? 'grid' : 'none';
  if (view === 'selector') renderTemplateCards();
  if (view === 'preview') renderPreview();
  if (view === 'editor') renderAll();
}

// =============================================
// VIEW 1: TEMPLATE SELECTOR
// =============================================
const TEMPLATE_ICONS = {
  tag:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A2 2 0 013 12V7a4 4 0 014-4z"/>',
  receive:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>',
  ship:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>',
  pick:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>',
  build:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>',
  location:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>'
};

function renderTemplateCards() {
  const builtinDiv = document.getElementById('builtin-templates');
  builtinDiv.innerHTML = BUILTIN_TEMPLATES.map((t, i) => templateCardHTML(t, 'builtin', i)).join('');
  // Saved templates
  const savedDiv = document.getElementById('saved-templates');
  if (state.savedTemplates.length) {
    savedDiv.innerHTML = state.savedTemplates.map((t, i) => templateCardHTML(t, 'saved', i)).join('');
  } else {
    savedDiv.innerHTML = `<div class="col-span-full text-center py-8 text-slate-400 text-sm">
      ${IN_FISHBOWL ? 'No saved templates found. Create one from a built-in template.' : 'Connect to Fishbowl to access saved templates.'}
    </div>`;
  }
  document.getElementById('saved-status').textContent = IN_FISHBOWL ? '' : '(Fishbowl not connected)';
}

function templateCardHTML(t, source, idx) {
  const icon = TEMPLATE_ICONS[t.meta.icon] || TEMPLATE_ICONS.tag;
  const preset = LABEL_PRESETS[t.meta.labelSize];
  const sizeLabel = preset ? preset.label : `${t.label.width}x${t.label.height}pt`;
  return `<div class="template-card bg-white rounded-2xl shadow-md border border-slate-200 p-5 hover:border-blue-300" onclick="selectTemplate('${source}',${idx})">
    <div class="flex items-center gap-3 mb-3">
      <div class="w-10 h-10 rounded-xl bg-blue-50 flex items-center justify-center">
        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">${icon}</svg>
      </div>
      <div class="flex-1 min-w-0">
        <h3 class="text-sm font-bold text-slate-900 truncate">${esc(t.meta.name)}</h3>
        <p class="text-[10px] text-slate-500">${sizeLabel}</p>
      </div>
    </div>
    <p class="text-xs text-slate-500 line-clamp-2">${esc(t.meta.description)}</p>
  </div>`;
}

function selectTemplate(source, idx) {
  const t = source === 'builtin' ? BUILTIN_TEMPLATES[idx] : state.savedTemplates[idx];
  if (!t) return;
  state.currentTemplate = deepClone(t);
  // Assign UUIDs to elements
  state.currentTemplate.elements.forEach(el => { if (!el.uuid) el.uuid = uid(); });
  // Load into state
  state.label = deepClone(t.label);
  state.elements = deepClone(state.currentTemplate.elements);
  state.templateQuery = t.query || null;
  state.templateParams = t.parameters || [];
  state.templateFields = t.fields || [];
  state.hiddenFields = new Set();
  state.selectedIds = [];
  state.nextId = state.elements.length + 1;
  state.nextZIndex = state.elements.length + 1;
  // Register sample data
  (t.fields || []).forEach(f => { if (f.sampleData) SAMPLE_DATA[f.name] = f.sampleData; });
  showView('preview');
}

// =============================================
// VIEW 2: PARAMETER & PREVIEW
// =============================================
function renderPreview() {
  const t = state.currentTemplate;
  if (!t) return;
  document.getElementById('preview-title').textContent = t.meta.name;
  document.getElementById('preview-subtitle').textContent = t.meta.description;
  // Label info
  const preset = LABEL_PRESETS[t.meta.labelSize];
  const sizeStr = preset ? preset.label : `${t.label.width} x ${t.label.height} pt`;
  document.getElementById('label-info').innerHTML = `
    <div><span class="font-semibold">Size:</span> ${sizeStr}</div>
    <div><span class="font-semibold">Dimensions:</span> ${t.label.width} x ${t.label.height} pt</div>
    <div><span class="font-semibold">Fields:</span> ${(t.fields||[]).length}</div>
    <div><span class="font-semibold">Elements:</span> ${state.elements.length}</div>
  `;
  // Parameters
  renderParams();
  // Field toggles
  renderFieldToggles();
  // Canvas preview
  renderPreviewCanvas();
}

function renderParams() {
  const div = document.getElementById('params-content');
  if (!state.templateParams.length) {
    div.innerHTML = '<p class="text-sm text-slate-400 col-span-full">No parameters for this template.</p>';
    return;
  }
  div.innerHTML = state.templateParams.map(p => `
    <div>
      <label class="block text-[11px] font-semibold text-slate-600 mb-1.5 uppercase tracking-wide">${esc(p.prompt)}</label>
      <input type="text" id="param-${p.name}" value="${esc(p.default||'')}" placeholder="Enter ${p.prompt}..."
        class="w-full px-2.5 py-1.5 bg-slate-50 border border-slate-300 rounded-lg text-sm font-medium text-slate-700 focus:outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-300">
    </div>
  `).join('');
}

function renderFieldToggles() {
  const div = document.getElementById('field-toggles');
  const toggleable = state.currentTemplate?.options?.toggleableFields || [];
  if (!toggleable.length) { div.innerHTML = '<p class="text-xs text-slate-400">No toggleable fields.</p>'; return; }
  div.innerHTML = toggleable.map(fn => {
    const field = (state.templateFields || []).find(f => f.name === fn);
    const label = field ? field.label : fn;
    const checked = !state.hiddenFields.has(fn);
    return `<label class="flex items-center gap-2 text-xs text-slate-700 cursor-pointer">
      <input type="checkbox" ${checked?'checked':''} onchange="toggleField('${fn}',this.checked)"> ${esc(label)}
    </label>`;
  }).join('');
}

function toggleField(fieldName, visible) {
  if (visible) state.hiddenFields.delete(fieldName);
  else state.hiddenFields.add(fieldName);
  // Hide/show elements using this field
  state.elements.forEach(el => {
    if (el.type === 'fieldToken' && el.fieldName === fieldName) {
      el._hidden = !visible;
    }
  });
  renderPreviewCanvas();
}

function renderPreviewCanvas() {
  const canvas = document.getElementById('preview-canvas');
  const container = document.getElementById('preview-canvas-container');
  canvas.style.width = state.label.width + 'px';
  canvas.style.height = state.label.height + 'px';
  // Fit zoom to container
  const wrapper = document.getElementById('preview-canvas-wrapper');
  const maxW = wrapper.clientWidth - 64;
  const maxH = wrapper.clientHeight - 64;
  const zoom = Math.min(maxW / state.label.width, maxH / state.label.height, 3);
  container.style.transform = `scale(${zoom})`;
  container.style.width = state.label.width + 'px';
  container.style.height = state.label.height + 'px';
  // Clear and render
  canvas.querySelectorAll('.canvas-element').forEach(el => el.remove());
  const sorted = [...state.elements].filter(el => !el._hidden).sort((a,b) => a.zIndex - b.zIndex);
  sorted.forEach(elem => {
    const div = document.createElement('div');
    div.className = 'canvas-element';
    div.style.left = elem.x + 'px';
    div.style.top = elem.y + 'px';
    div.style.width = elem.width + 'px';
    div.style.height = elem.height + 'px';
    div.style.zIndex = elem.zIndex;
    if (elem.rotation) div.style.transform = `rotate(${elem.rotation}deg)`;
    renderElementContent(div, elem, true);
    canvas.appendChild(div);
  });
}

function openEditor(template) {
  if (template) selectTemplate('builtin', BUILTIN_TEMPLATES.indexOf(template));
  else {
    state.currentTemplate = null;
    state.label = {width:288,height:432,name:'My Label'};
    state.elements = [];
    state.selectedIds = [];
    state.nextId = 1;
    state.nextZIndex = 1;
    state.templateQuery = null;
    state.templateParams = [];
    state.templateFields = [];
  }
  showView('editor');
}

function openEditorFromPreview() { showView('editor'); }
function printFromPreview() { window.print(); }
function exportPDFFromPreview() { exportPDF(); }
function exportJRXMLFromPreview() { exportJRXML(); }
// =============================================
// HISTORY (UNDO/REDO)
// =============================================
function pushHistory(){state.undoStack.push(deepClone({elements:state.elements,label:state.label}));if(state.undoStack.length>20)state.undoStack.shift();state.redoStack=[]}
function doUndo(){if(!state.undoStack.length)return;state.redoStack.push(deepClone({elements:state.elements,label:state.label}));const p=state.undoStack.pop();state.elements=p.elements;state.label=p.label;state.selectedIds=[];renderAll()}
function doRedo(){if(!state.redoStack.length)return;state.undoStack.push(deepClone({elements:state.elements,label:state.label}));const n=state.redoStack.pop();state.elements=n.elements;state.label=n.label;state.selectedIds=[];renderAll()}

// =============================================
// ELEMENT FACTORY
// =============================================
function createElement(type, extra) {
  const base = {id:genId(),type,x:10,y:10,width:120,height:30,rotation:0,zIndex:state.nextZIndex++,uuid:uid()};
  const defaults = {
    staticText:{text:'Text',fontFamily:'SansSerif',fontSize:12,fontBold:false,fontItalic:false,textAlign:'left',textColor:'#000000'},
    fieldToken:{fieldName:'product_num',fontFamily:'SansSerif',fontSize:12,fontBold:false,fontItalic:false,textAlign:'left',textColor:'#000000'},
    barcode:{barcodeType:'Code128',dataSource:'field',fieldName:'part_upc',staticValue:'12345',showHumanReadable:true,width:180,height:60},
    line:{lineThickness:1,lineColor:'#000000',orientation:'horizontal',width:100,height:1},
    rectangle:{borderThickness:1,borderColor:'#000000',fillColor:'transparent',cornerRadius:0,width:100,height:60},
    image:{imageData:'',scaleMode:'retain',width:80,height:80}
  };
  return Object.assign(base, defaults[type]||{}, extra||{});
}

// =============================================
// CANVAS RENDERING (EDITOR)
// =============================================
function renderAll() {
  if (state.currentView !== 'editor') return;
  const canvas = document.getElementById('canvas');
  const container = document.getElementById('canvas-container');
  canvas.style.width = state.label.width+'px';
  canvas.style.height = state.label.height+'px';
  container.style.transform = `scale(${state.zoom})`;
  container.style.width = state.label.width+'px';
  container.style.height = state.label.height+'px';
  const grid = document.getElementById('grid-overlay');
  if (state.showGrid) {
    grid.style.backgroundImage = `linear-gradient(to right,rgba(0,0,0,.08) 1px,transparent 1px),linear-gradient(to bottom,rgba(0,0,0,.08) 1px,transparent 1px)`;
    grid.style.backgroundSize = `${state.gridSize}px ${state.gridSize}px`;
    grid.style.display = 'block';
  } else grid.style.display = 'none';
  canvas.querySelectorAll('.canvas-element').forEach(el=>el.remove());
  canvas.querySelector('.marquee')?.remove();
  const sorted = [...state.elements].sort((a,b)=>a.zIndex-b.zIndex);
  sorted.forEach(elem => {
    const div = document.createElement('div');
    div.className = 'canvas-element'+(state.selectedIds.includes(elem.id)?' selected':'');
    div.dataset.id = elem.id;
    div.style.left=elem.x+'px';div.style.top=elem.y+'px';div.style.width=elem.width+'px';div.style.height=elem.height+'px';div.style.zIndex=elem.zIndex;
    if(elem.rotation) div.style.transform=`rotate(${elem.rotation}deg)`;
    renderElementContent(div, elem, false);
    ['nw','n','ne','e','se','s','sw','w'].forEach(pos=>{const h=document.createElement('div');h.className=`handle handle-${pos}`;h.dataset.handle=pos;div.appendChild(h)});
    div.addEventListener('mousedown',e=>onElementMouseDown(e,elem.id));
    div.addEventListener('dblclick',e=>onElementDblClick(e,elem.id));
    canvas.appendChild(div);
  });
  updateDimsLabel();
  updatePropertiesPanel();
  drawRulers();
}

function renderElementContent(div, elem, previewMode) {
  const isPreview = previewMode || state.previewMode;
  switch(elem.type) {
    case 'staticText': {
      const s=document.createElement('div');s.className='elem-text';
      s.style.fontFamily=elem.fontFamily;s.style.fontSize=elem.fontSize+'px';s.style.fontWeight=elem.fontBold?'bold':'normal';
      s.style.fontStyle=elem.fontItalic?'italic':'normal';s.style.textAlign=elem.textAlign;s.style.color=elem.textColor;
      s.textContent=elem.text;div.appendChild(s);break;
    }
    case 'fieldToken': {
      const s=document.createElement('div');s.className='elem-field';
      if(isPreview){s.style.background='transparent';s.style.border='none'}
      s.style.fontFamily=elem.fontFamily;s.style.fontSize=elem.fontSize+'px';s.style.fontWeight=elem.fontBold?'bold':'normal';
      s.style.fontStyle=elem.fontItalic?'italic':'normal';s.style.textAlign=elem.textAlign;s.style.color=elem.textColor;
      const sample=SAMPLE_DATA[elem.fieldName]||`\$F{${elem.fieldName}}`;
      s.textContent=isPreview?sample:`\$F{${elem.fieldName}} [${sample}]`;
      div.appendChild(s);break;
    }
    case 'barcode': {
      const wrap=document.createElement('div');wrap.className='elem-barcode';
      const cvs=document.createElement('canvas');wrap.appendChild(cvs);div.appendChild(wrap);
      const data=elem.dataSource==='field'?(SAMPLE_DATA[elem.fieldName]||'12345'):(elem.staticValue||'12345');
      try{bwipjs.toCanvas(cvs,{bcid:BARCODE_MAP[elem.barcodeType]||'code128',text:data,scale:2,height:Math.max(5,Math.round(elem.height/4)),includetext:elem.showHumanReadable,textxalign:'center'})}
      catch(e){wrap.textContent='[Barcode: '+e.message+']';wrap.style.fontSize='10px';wrap.style.color='#ef4444'}
      break;
    }
    case 'line': {
      if(elem.orientation==='horizontal'){div.style.borderTop=`${elem.lineThickness}px solid ${elem.lineColor}`;div.style.height=Math.max(elem.lineThickness,elem.height)+'px'}
      else{div.style.borderLeft=`${elem.lineThickness}px solid ${elem.lineColor}`;div.style.width=Math.max(elem.lineThickness,elem.width)+'px'}
      break;
    }
    case 'rectangle': {
      div.style.border=`${elem.borderThickness}px solid ${elem.borderColor}`;
      if(elem.fillColor&&elem.fillColor!=='transparent')div.style.backgroundColor=elem.fillColor;
      if(elem.cornerRadius)div.style.borderRadius=elem.cornerRadius+'px';break;
    }
    case 'image': {
      if(elem.imageData){const img=document.createElement('img');img.src=elem.imageData;img.style.objectFit=elem.scaleMode==='retain'?'contain':'fill';img.style.width='100%';img.style.height='100%';img.draggable=false;div.appendChild(img)}
      else{div.style.border='1px dashed #94a3b8';div.style.display='flex';div.style.alignItems='center';div.style.justifyContent='center';div.style.fontSize='11px';div.style.color='#94a3b8';div.textContent='No Image'}
      break;
    }
  }
}

// =============================================
// RULERS
// =============================================
function drawRulers(){drawRulerH();drawRulerV()}
// Returns {minor, major, unitToPt, fmtMajor} where minor/major are in display units
function rulerConfig() {
  const u = state.displayUnit;
  if (u === 'in') return { minor: 1/8, major: 1, unitToPt: 72, fmtMajor: v => String(v) };
  if (u === 'mm') return { minor: 1, major: 10, unitToPt: 72/25.4, fmtMajor: v => String(v) };
  return { minor: 9, major: 36, unitToPt: 1, fmtMajor: v => String(v) };
}
function drawRulerH(){const c=document.getElementById('ruler-h');if(!c)return;const scrollEl=document.getElementById('canvas-scroll');const totalW=state.label.width*state.zoom+40;c.width=Math.max(totalW,scrollEl.clientWidth);c.height=24;const ctx=c.getContext('2d');ctx.fillStyle='#f8fafc';ctx.fillRect(0,0,c.width,c.height);ctx.fillStyle='#64748b';ctx.font='9px Inter,sans-serif';ctx.strokeStyle='#94a3b8';const rc=rulerConfig();const offset=20;const maxUnit=state.label.width/rc.unitToPt;for(let i=0;i*rc.minor<=maxUnit+0.001;i++){const uVal=i*rc.minor;const px=offset+uVal*rc.unitToPt*state.zoom;const isMajor=Math.abs(uVal%rc.major)<rc.minor*0.01||Math.abs(uVal%rc.major-rc.major)<rc.minor*0.01;ctx.beginPath();ctx.moveTo(px,isMajor?8:16);ctx.lineTo(px,24);ctx.lineWidth=isMajor?1:0.5;ctx.stroke();if(isMajor)ctx.fillText(rc.fmtMajor(Math.round(uVal*1000)/1000),px+2,7)}}
function drawRulerV(){const c=document.getElementById('ruler-v');if(!c)return;const scrollEl=document.getElementById('canvas-scroll');const totalH=state.label.height*state.zoom+40;c.width=24;c.height=Math.max(totalH,scrollEl.clientHeight);const ctx=c.getContext('2d');ctx.fillStyle='#f8fafc';ctx.fillRect(0,0,c.width,c.height);ctx.fillStyle='#64748b';ctx.font='9px Inter,sans-serif';ctx.strokeStyle='#94a3b8';const rc=rulerConfig();const offset=20;const maxUnit=state.label.height/rc.unitToPt;for(let i=0;i*rc.minor<=maxUnit+0.001;i++){const uVal=i*rc.minor;const py=offset+uVal*rc.unitToPt*state.zoom;const isMajor=Math.abs(uVal%rc.major)<rc.minor*0.01||Math.abs(uVal%rc.major-rc.major)<rc.minor*0.01;ctx.beginPath();ctx.moveTo(isMajor?8:16,py);ctx.lineTo(24,py);ctx.lineWidth=isMajor?1:0.5;ctx.stroke();if(isMajor){ctx.save();ctx.translate(7,py+2);ctx.rotate(-Math.PI/2);ctx.fillText(rc.fmtMajor(Math.round(uVal*1000)/1000),0,0);ctx.restore()}}}
function updateDimsLabel(){const el=document.getElementById('label-dims');if(el)el.textContent=`${ptToDisplay(state.label.width)} x ${ptToDisplay(state.label.height)} ${unitSuffix()}`}

// =============================================
// INTERACTIONS
// =============================================
function screenToCanvas(e){const canvas=document.getElementById('canvas');const rect=canvas.getBoundingClientRect();return{x:(e.clientX-rect.left)/state.zoom,y:(e.clientY-rect.top)/state.zoom}}
function onElementMouseDown(e,id){
  e.stopPropagation();
  const handle=e.target.dataset.handle;
  if(handle){const elem=state.elements.find(el=>el.id===id);if(!elem)return;state.dragState={type:'resize',handle,id,startX:e.clientX,startY:e.clientY,origX:elem.x,origY:elem.y,origW:elem.width,origH:elem.height};pushHistory()}
  else{if(e.shiftKey){if(state.selectedIds.includes(id))state.selectedIds=state.selectedIds.filter(i=>i!==id);else state.selectedIds.push(id)}else if(!state.selectedIds.includes(id))state.selectedIds=[id];
    const pos=screenToCanvas(e);state.dragState={type:'move',ids:[...state.selectedIds],startX:pos.x,startY:pos.y,origPositions:state.selectedIds.map(sid=>{const el=state.elements.find(el=>el.id===sid);return{id:sid,x:el.x,y:el.y}})};pushHistory();renderAll()}
}
function onCanvasMouseDown(e){if(e.target.closest('.canvas-element'))return;if(!e.shiftKey)state.selectedIds=[];const pos=screenToCanvas(e);state.marquee={startX:pos.x,startY:pos.y,x:pos.x,y:pos.y,w:0,h:0};renderAll()}
function onMouseMove(e){
  if(state.dragState){const ds=state.dragState;
    if(ds.type==='move'){const pos=screenToCanvas(e);const dx=pos.x-ds.startX;const dy=pos.y-ds.startY;ds.origPositions.forEach(op=>{const elem=state.elements.find(el=>el.id===op.id);if(elem){elem.x=snap(clamp(op.x+dx,0,state.label.width-elem.width));elem.y=snap(clamp(op.y+dy,0,state.label.height-elem.height));const div=document.querySelector(`[data-id="${elem.id}"]`);if(div){div.style.left=elem.x+'px';div.style.top=elem.y+'px'}}});updatePropertiesPanel()}
    else if(ds.type==='resize'){const dx=(e.clientX-ds.startX)/state.zoom;const dy=(e.clientY-ds.startY)/state.zoom;const elem=state.elements.find(el=>el.id===ds.id);if(!elem)return;let{origX:ox,origY:oy,origW:ow,origH:oh}=ds;const h=ds.handle;let nx=ox,ny=oy,nw=ow,nh=oh;if(h.includes('e'))nw=Math.max(5,snap(ow+dx));if(h.includes('s'))nh=Math.max(5,snap(oh+dy));if(h.includes('w')){nw=Math.max(5,snap(ow-dx));nx=snap(ox+ow-nw)}if(h.includes('n')){nh=Math.max(5,snap(oh-dy));ny=snap(oy+oh-nh)}elem.x=nx;elem.y=ny;elem.width=nw;elem.height=nh;const div=document.querySelector(`[data-id="${elem.id}"]`);if(div){div.style.left=nx+'px';div.style.top=ny+'px';div.style.width=nw+'px';div.style.height=nh+'px'}updatePropertiesPanel()}
  } else if(state.marquee){const pos=screenToCanvas(e);const m=state.marquee;m.x=Math.min(m.startX,pos.x);m.y=Math.min(m.startY,pos.y);m.w=Math.abs(pos.x-m.startX);m.h=Math.abs(pos.y-m.startY);let mDiv=document.querySelector('.marquee');if(!mDiv){mDiv=document.createElement('div');mDiv.className='marquee';document.getElementById('canvas').appendChild(mDiv)}mDiv.style.left=m.x+'px';mDiv.style.top=m.y+'px';mDiv.style.width=m.w+'px';mDiv.style.height=m.h+'px'}
}
function onMouseUp(e){if(state.dragState){if(state.dragState.type==='move'||state.dragState.type==='resize')renderAll();state.dragState=null}if(state.marquee){const m=state.marquee;if(m.w>2&&m.h>2){state.selectedIds=state.elements.filter(el=>el.x>=m.x&&el.y>=m.y&&el.x+el.width<=m.x+m.w&&el.y+el.height<=m.y+m.h).map(el=>el.id)}state.marquee=null;renderAll()}}
function onElementDblClick(e,id){const elem=state.elements.find(el=>el.id===id);if(!elem||elem.type!=='staticText')return;const div=document.querySelector(`[data-id="${id}"] .elem-text`);if(!div)return;pushHistory();div.contentEditable=true;div.focus();document.execCommand('selectAll');const finish=()=>{div.contentEditable=false;elem.text=div.textContent;renderAll()};div.addEventListener('blur',finish,{once:true});div.addEventListener('keydown',ev=>{if(ev.key==='Enter'){ev.preventDefault();div.blur()}if(ev.key==='Escape'){div.textContent=elem.text;div.blur()}})}

// =============================================
// ADD/DELETE/COPY-PASTE
// =============================================
function addElement(type,extra){pushHistory();const elem=createElement(type,extra);const scroll=document.getElementById('canvas-scroll');const cx=(scroll.scrollLeft+scroll.clientWidth/2)/state.zoom;const cy=(scroll.scrollTop+scroll.clientHeight/2)/state.zoom;elem.x=snap(clamp(cx-elem.width/2,0,state.label.width-elem.width));elem.y=snap(clamp(cy-elem.height/2,0,state.label.height-elem.height));state.elements.push(elem);state.selectedIds=[elem.id];renderAll();return elem}
function deleteSelected(){if(!state.selectedIds.length)return;pushHistory();state.elements=state.elements.filter(el=>!state.selectedIds.includes(el.id));state.selectedIds=[];renderAll()}
function copySelected(){state.clipboard=state.selectedIds.map(id=>{const el=state.elements.find(e=>e.id===id);return el?deepClone(el):null}).filter(Boolean)}
function pasteClipboard(){if(!state.clipboard.length)return;pushHistory();const newIds=[];state.clipboard.forEach(el=>{const ne=deepClone(el);ne.id=genId();ne.uuid=uid();ne.x=snap(el.x+10);ne.y=snap(el.y+10);ne.zIndex=state.nextZIndex++;state.elements.push(ne);newIds.push(ne.id)});state.selectedIds=newIds;renderAll()}
function nudgeSelected(dx,dy){if(!state.selectedIds.length)return;pushHistory();state.selectedIds.forEach(id=>{const el=state.elements.find(e=>e.id===id);if(el){el.x=clamp(el.x+dx,0,state.label.width-el.width);el.y=clamp(el.y+dy,0,state.label.height-el.height)}});renderAll()}

// =============================================
// PROPERTIES PANEL
// =============================================
function updatePropertiesPanel(){
  const panel=document.getElementById('properties-content');if(!panel)return;
  const sel=state.selectedIds.map(id=>state.elements.find(e=>e.id===id)).filter(Boolean);
  if(!sel.length){panel.innerHTML=labelPropsHTML();bindLabelProps();return}
  if(sel.length>1){panel.innerHTML=multiSelectHTML();bindAlignButtons();return}
  const elem=sel[0];panel.innerHTML=elementPropsHTML(elem);bindElementProps(elem);
}
function labelPropsHTML(){const u=unitSuffix();const step=state.displayUnit==='pt'?'1':'0.001';return `<div class="prop-group"><div class="prop-group-title">Label</div><div class="prop-row"><label>Name</label><input id="pp-name" value="${esc(state.label.name)}"></div><div class="prop-row"><label>Width (${u})</label><input type="number" id="pp-lw" value="${ptToDisplay(state.label.width)}" min="0" step="${step}"></div><div class="prop-row"><label>Height (${u})</label><input type="number" id="pp-lh" value="${ptToDisplay(state.label.height)}" min="0" step="${step}"></div><div class="prop-row" style="font-size:11px;color:#64748b">${ptToIn(state.label.width)}" x ${ptToIn(state.label.height)}" | ${ptToMm(state.label.width)} x ${ptToMm(state.label.height)} mm | ${state.label.width} x ${state.label.height} pt</div></div>`}
function bindLabelProps(){const s=(id,fn)=>{const el=document.getElementById(id);if(el)el.addEventListener('change',fn)};s('pp-name',e=>{state.label.name=e.target.value});s('pp-lw',e=>{pushHistory();state.label.width=displayToPt(e.target.value)||288;renderAll()});s('pp-lh',e=>{pushHistory();state.label.height=displayToPt(e.target.value)||432;renderAll()})}
function multiSelectHTML(){return `<div class="prop-group"><div class="prop-group-title">${state.selectedIds.length} Elements Selected</div><div class="prop-group-title" style="margin-top:8px">Align</div><div class="align-buttons"><button class="prop-btn" data-align="left" title="Align Left">&#9664;</button><button class="prop-btn" data-align="centerH" title="Center H">&#9679;</button><button class="prop-btn" data-align="right" title="Align Right">&#9654;</button><button class="prop-btn" data-align="top" title="Align Top">&#9650;</button><button class="prop-btn" data-align="centerV" title="Center V">&#9679;</button><button class="prop-btn" data-align="bottom" title="Align Bottom">&#9660;</button></div><div class="prop-group-title" style="margin-top:8px">Distribute</div><div class="align-buttons"><button class="prop-btn" data-align="distH">&#8596;</button><button class="prop-btn" data-align="distV">&#8597;</button></div></div>`}
function bindAlignButtons(){document.querySelectorAll('[data-align]').forEach(btn=>{btn.addEventListener('click',()=>alignElements(btn.dataset.align))})}
function alignElements(action){const elems=state.selectedIds.map(id=>state.elements.find(e=>e.id===id)).filter(Boolean);if(elems.length<2)return;pushHistory();switch(action){case 'left':{const m=Math.min(...elems.map(e=>e.x));elems.forEach(e=>e.x=m);break}case 'right':{const m=Math.max(...elems.map(e=>e.x+e.width));elems.forEach(e=>e.x=m-e.width);break}case 'top':{const m=Math.min(...elems.map(e=>e.y));elems.forEach(e=>e.y=m);break}case 'bottom':{const m=Math.max(...elems.map(e=>e.y+e.height));elems.forEach(e=>e.y=m-e.height);break}case 'centerH':{const avg=elems.reduce((s,e)=>s+e.x+e.width/2,0)/elems.length;elems.forEach(e=>e.x=Math.round(avg-e.width/2));break}case 'centerV':{const avg=elems.reduce((s,e)=>s+e.y+e.height/2,0)/elems.length;elems.forEach(e=>e.y=Math.round(avg-e.height/2));break}case 'distH':{elems.sort((a,b)=>a.x-b.x);const minX=elems[0].x,maxR=elems[elems.length-1].x+elems[elems.length-1].width,totalW=elems.reduce((s,e)=>s+e.width,0),gap=(maxR-minX-totalW)/(elems.length-1);let cx=minX;elems.forEach(e=>{e.x=Math.round(cx);cx+=e.width+gap});break}case 'distV':{elems.sort((a,b)=>a.y-b.y);const minY=elems[0].y,maxB=elems[elems.length-1].y+elems[elems.length-1].height,totalH=elems.reduce((s,e)=>s+e.height,0),gap=(maxB-minY-totalH)/(elems.length-1);let cy=minY;elems.forEach(e=>{e.y=Math.round(cy);cy+=e.height+gap});break}}renderAll()}

function elementPropsHTML(el){
  const u=unitSuffix(),stp=state.displayUnit==='pt'?'1':'0.001';
  let html=`<div class="prop-group"><div class="prop-group-title">Position & Size (${u})</div><div class="prop-row"><label>X</label><input type="number" id="pp-x" value="${ptToDisplay(el.x)}" step="${stp}"></div><div class="prop-row"><label>Y</label><input type="number" id="pp-y" value="${ptToDisplay(el.y)}" step="${stp}"></div><div class="prop-row"><label>Width</label><input type="number" id="pp-w" value="${ptToDisplay(el.width)}" min="0" step="${stp}"></div><div class="prop-row"><label>Height</label><input type="number" id="pp-h" value="${ptToDisplay(el.height)}" min="0" step="${stp}"></div><div class="prop-row"><label>Rotation</label><select id="pp-rot">${[0,90,180,270].map(r=>`<option value="${r}"${el.rotation===r?' selected':''}>${r}</option>`).join('')}</select></div></div>`;
  html+=`<div class="prop-group"><div class="prop-group-title">Z-Order</div><div class="align-buttons"><button class="prop-btn" id="pp-zup">&#8593; Up</button><button class="prop-btn" id="pp-zdown">&#8595; Down</button><button class="prop-btn" id="pp-ztop">&#8607; Top</button><button class="prop-btn" id="pp-zbot">&#8609; Bot</button></div></div>`;
  if(el.type==='staticText'||el.type==='fieldToken'){
    html+=`<div class="prop-group"><div class="prop-group-title">Text</div>`;
    if(el.type==='staticText')html+=`<div class="prop-row"><label>Text</label><input id="pp-text" value="${esc(el.text)}"></div>`;
    else html+=`<div class="prop-row"><label>Field</label><input id="pp-field" value="${esc(el.fieldName)}"></div>`;
    html+=`<div class="prop-row"><label>Font</label><select id="pp-font">${['SansSerif','Serif','Monospaced','Arial','Helvetica','Times New Roman','Courier New'].map(f=>`<option${el.fontFamily===f?' selected':''}>${f}</option>`).join('')}</select></div><div class="prop-row"><label>Size</label><input type="number" id="pp-fsize" value="${el.fontSize}" min="4" max="200"></div><div class="prop-row"><label>Style</label><label><input type="checkbox" id="pp-bold"${el.fontBold?' checked':''}> B</label><label><input type="checkbox" id="pp-italic"${el.fontItalic?' checked':''}> I</label></div><div class="prop-row"><label>Align</label><select id="pp-align">${['left','center','right'].map(a=>`<option${el.textAlign===a?' selected':''}>${a}</option>`).join('')}</select></div><div class="prop-row"><label>Color</label><input type="color" id="pp-tcolor" value="${el.textColor}"></div></div>`;
  }
  if(el.type==='barcode')html+=`<div class="prop-group"><div class="prop-group-title">Barcode</div><div class="prop-row"><label>Type</label><select id="pp-bctype">${['Code128','Code39','QRCode','EAN13'].map(t=>`<option${el.barcodeType===t?' selected':''}>${t}</option>`).join('')}</select></div><div class="prop-row"><label>Source</label><select id="pp-bcsrc"><option value="field"${el.dataSource==='field'?' selected':''}>Field</option><option value="static"${el.dataSource==='static'?' selected':''}>Static</option></select></div><div class="prop-row" id="pp-bcfield-row"><label>Field</label><input id="pp-bcfield" value="${esc(el.fieldName)}"></div><div class="prop-row" id="pp-bcstatic-row"><label>Value</label><input id="pp-bcstatic" value="${esc(el.staticValue)}"></div><div class="prop-row"><label>Text</label><label><input type="checkbox" id="pp-bctext"${el.showHumanReadable?' checked':''}> Show</label></div></div>`;
  if(el.type==='line')html+=`<div class="prop-group"><div class="prop-group-title">Line</div><div class="prop-row"><label>Dir</label><select id="pp-lineori"><option value="horizontal"${el.orientation==='horizontal'?' selected':''}>Horizontal</option><option value="vertical"${el.orientation==='vertical'?' selected':''}>Vertical</option></select></div><div class="prop-row"><label>Width</label><input type="number" id="pp-linethk" value="${el.lineThickness}" min="1" max="20"></div><div class="prop-row"><label>Color</label><input type="color" id="pp-linecolor" value="${el.lineColor}"></div></div>`;
  if(el.type==='rectangle')html+=`<div class="prop-group"><div class="prop-group-title">Rectangle</div><div class="prop-row"><label>Border</label><input type="number" id="pp-rectbdr" value="${el.borderThickness}" min="0" max="20"></div><div class="prop-row"><label>Bdr Color</label><input type="color" id="pp-rectbdrclr" value="${el.borderColor}"></div><div class="prop-row"><label>Fill</label><input type="color" id="pp-rectfill" value="${el.fillColor==='transparent'?'#ffffff':el.fillColor}"></div><div class="prop-row"><label>No Fill</label><label><input type="checkbox" id="pp-rectnofill"${el.fillColor==='transparent'?' checked':''}> Transparent</label></div><div class="prop-row"><label>Radius</label><input type="number" id="pp-rectrad" value="${el.cornerRadius}" min="0"></div></div>`;
  if(el.type==='image')html+=`<div class="prop-group"><div class="prop-group-title">Image</div><div class="prop-row"><label>Scale</label><select id="pp-imgscale"><option value="retain"${el.scaleMode==='retain'?' selected':''}>Retain Aspect</option><option value="stretch"${el.scaleMode==='stretch'?' selected':''}>Stretch</option></select></div><div class="prop-row"><button class="prop-btn" id="pp-imgchange">Change Image</button></div></div>`;
  html+=`<div class="prop-group" style="margin-top:12px"><button class="prop-btn" style="background:#fef2f2;border-color:#fca5a5;color:#dc2626;width:100%" onclick="deleteSelected()">Delete Element</button></div>`;
  return html;
}

function bindElementProps(el){
  const bind=(id,prop,parse)=>{const input=document.getElementById(id);if(!input)return;input.addEventListener('change',()=>{pushHistory();el[prop]=parse?parse(input):input.value;renderAll()})};
  bind('pp-x','x',i=>displayToPt(i.value));bind('pp-y','y',i=>displayToPt(i.value));bind('pp-w','width',i=>Math.max(1,displayToPt(i.value)||1));bind('pp-h','height',i=>Math.max(1,displayToPt(i.value)||1));
  bind('pp-rot','rotation',i=>parseInt(i.value)||0);bind('pp-text','text');bind('pp-field','fieldName');bind('pp-font','fontFamily');bind('pp-fsize','fontSize',i=>parseInt(i.value)||12);
  bind('pp-bold','fontBold',i=>i.checked);bind('pp-italic','fontItalic',i=>i.checked);bind('pp-align','textAlign');bind('pp-tcolor','textColor');
  bind('pp-bctype','barcodeType');bind('pp-bcsrc','dataSource');bind('pp-bcfield','fieldName');bind('pp-bcstatic','staticValue');bind('pp-bctext','showHumanReadable',i=>i.checked);
  bind('pp-lineori','orientation');bind('pp-linethk','lineThickness',i=>parseInt(i.value)||1);bind('pp-linecolor','lineColor');
  bind('pp-rectbdr','borderThickness',i=>parseInt(i.value)||0);bind('pp-rectbdrclr','borderColor');bind('pp-rectfill','fillColor');bind('pp-rectrad','cornerRadius',i=>parseInt(i.value)||0);bind('pp-imgscale','scaleMode');
  const nf=document.getElementById('pp-rectnofill');if(nf)nf.addEventListener('change',()=>{pushHistory();el.fillColor=nf.checked?'transparent':'#ffffff';renderAll()});
  const srcSel=document.getElementById('pp-bcsrc');if(srcSel){const u=()=>{const fr=document.getElementById('pp-bcfield-row');const sr=document.getElementById('pp-bcstatic-row');if(fr)fr.style.display=srcSel.value==='field'?'flex':'none';if(sr)sr.style.display=srcSel.value==='static'?'flex':'none'};u();srcSel.addEventListener('change',u)}
  const ic=document.getElementById('pp-imgchange');if(ic)ic.addEventListener('click',()=>{const inp=document.getElementById('image-upload');inp.onchange=e=>{const file=e.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=ev=>{pushHistory();el.imageData=ev.target.result;renderAll()};reader.readAsDataURL(file);inp.value=''};inp.click()});
  const zBind=(id,fn)=>{const b=document.getElementById(id);if(b)b.addEventListener('click',()=>{pushHistory();fn();renderAll()})};
  zBind('pp-zup',()=>{el.zIndex=Math.min(el.zIndex+1,9999)});zBind('pp-zdown',()=>{el.zIndex=Math.max(el.zIndex-1,0)});zBind('pp-ztop',()=>{el.zIndex=state.nextZIndex++});zBind('pp-zbot',()=>{el.zIndex=0;state.elements.forEach(e=>{if(e.id!==el.id&&e.zIndex>=0)e.zIndex++})});
}

// =============================================
// FIELD PALETTE
// =============================================
function buildFieldPalette(){
  const list=document.getElementById('field-list');if(!list)return;list.innerHTML='';
  const search=(document.getElementById('field-search')?.value||'').toLowerCase();
  const icons={Product:'P',Part:'#',Location:'L',Tracking:'T','Custom Fields':'C'};
  const allCats={...FIELD_CATEGORIES};
  // Add template fields as a category
  if(state.templateFields.length){allCats['Template Fields']=state.templateFields.map(f=>({name:f.name,label:f.label||f.name}))}
  if(state.customFields.length){allCats['User Fields']=state.customFields.map(f=>({name:f.name,label:f.label||f.name}))}
  for(const[cat,fields]of Object.entries(allCats)){
    const filtered=fields.filter(f=>!search||f.name.toLowerCase().includes(search)||f.label.toLowerCase().includes(search));
    if(!filtered.length)continue;
    const catDiv=document.createElement('div');catDiv.className='field-category';
    catDiv.innerHTML=`<div class="field-category-title">${cat}</div><div class="field-items"></div>`;
    catDiv.querySelector('.field-category-title').addEventListener('click',()=>catDiv.classList.toggle('collapsed'));
    const itemsDiv=catDiv.querySelector('.field-items');
    filtered.forEach(f=>{
      const item=document.createElement('div');item.className='field-item';item.draggable=true;
      item.innerHTML=`<span class="fi-icon">${icons[cat]||'F'}</span><div><div style="font-size:12px">${f.label}</div><div class="fi-name">$F{${f.name}}</div></div>`;
      item.addEventListener('dragstart',e=>{e.dataTransfer.setData('text/plain',f.name);e.dataTransfer.effectAllowed='copy'});
      item.addEventListener('dblclick',()=>addElement('fieldToken',{fieldName:f.name}));
      itemsDiv.appendChild(item);
    });
    list.appendChild(catDiv);
  }
}
function addCustomField(){const inp=document.getElementById('custom-field-input');const name=inp.value.trim().replace(/[^a-zA-Z0-9_]/g,'_');if(!name)return;if(state.customFields.some(f=>f.name===name))return;state.customFields.push({name,label:name});SAMPLE_DATA[name]=name;inp.value='';buildFieldPalette()}
function handleCanvasDrop(e){e.preventDefault();const fieldName=e.dataTransfer.getData('text/plain');if(!fieldName)return;const pos=screenToCanvas(e);addElement('fieldToken',{fieldName,x:snap(clamp(pos.x,0,state.label.width-120)),y:snap(clamp(pos.y,0,state.label.height-30))})}
function togglePreview(){state.previewMode=!state.previewMode;document.getElementById('canvas').classList.toggle('preview-mode',state.previewMode);document.getElementById('preview-btn').style.background=state.previewMode?'#3b82f6':'';if(state.previewMode)state.selectedIds=[];renderAll()}
// =============================================
// JRXML EXPORT
// =============================================
function exportJRXML() {
  const w = state.label.width, h = state.label.height;
  const labelName = xmlEsc(state.label.name || 'Label');
  const pageUuid = uid(), bandUuid = uid();

  // Collect all field names used
  const usedFields = new Set();
  state.elements.forEach(el => {
    if (el.type === 'fieldToken') usedFields.add(el.fieldName);
    if (el.type === 'barcode' && el.dataSource === 'field') usedFields.add(el.fieldName);
  });

  // Build field declarations from template fields or defaults
  let fieldsXml = '';
  usedFields.forEach(fn => {
    const tf = (state.templateFields || []).find(f => f.name === fn);
    const javaClass = tf ? (tf.javaClass || 'java.lang.String') : 'java.lang.String';
    fieldsXml += `\t<field name="${xmlEsc(fn)}" class="${javaClass}"/>\n`;
  });

  // Build parameters from template
  let paramsXml = '';
  (state.templateParams || []).forEach(p => {
    const javaClass = p.javaClass || 'java.lang.String';
    paramsXml += `\t<parameter name="${xmlEsc(p.name)}" class="${javaClass}">\n`;
    if (p.prompt) paramsXml += `\t\t<property name="prompt" value="${xmlEsc(p.prompt)}"/>\n`;
    if (p.default) paramsXml += `\t\t<defaultValueExpression><![CDATA["${p.default}"]]></defaultValueExpression>\n`;
    paramsXml += `\t</parameter>\n`;
  });

  // Build queryString
  let queryXml = '';
  if (state.templateQuery && state.templateQuery.sql) {
    queryXml = `\t<queryString>\n\t\t<![CDATA[${state.templateQuery.sql}]]>\n\t</queryString>\n`;
  }

  // Build elements XML
  let elementsXml = '';
  const sorted = [...state.elements].sort((a, b) => a.zIndex - b.zIndex);
  sorted.forEach(el => {
    const elUuid = el.uuid || uid();
    switch (el.type) {
      case 'staticText':
        elementsXml += buildJrxmlStaticText(el, elUuid);
        break;
      case 'fieldToken':
        elementsXml += buildJrxmlTextField(el, elUuid);
        break;
      case 'barcode':
        elementsXml += buildJrxmlBarcode(el, elUuid);
        break;
      case 'line':
        elementsXml += buildJrxmlLine(el, elUuid);
        break;
      case 'rectangle':
        elementsXml += buildJrxmlRectangle(el, elUuid);
        break;
      case 'image':
        elementsXml += buildJrxmlImage(el, elUuid);
        break;
    }
  });

  const jrxml = `<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd"
  name="${labelName}" pageWidth="${w}" pageHeight="${h}"
  columnWidth="${w}" leftMargin="0" rightMargin="0" topMargin="0" bottomMargin="0"
  uuid="${pageUuid}">
${paramsXml}${queryXml}${fieldsXml}\t<detail>
\t\t<band height="${h}" splitType="Stretch" uuid="${bandUuid}">
${elementsXml}\t\t</band>
\t</detail>
</jasperReport>`;

  downloadFile(labelName + '.jrxml', jrxml, 'application/xml');
}

function buildJrxmlStaticText(el, uuid) {
  let xml = `\t\t\t<staticText uuid="${uuid}">\n`;
  xml += reportElementXml(el);
  xml += textElementXml(el);
  xml += `\t\t\t\t<text><![CDATA[${el.text || ''}]]></text>\n`;
  xml += `\t\t\t</staticText>\n`;
  return xml;
}

function buildJrxmlTextField(el, uuid) {
  let xml = `\t\t\t<textField uuid="${uuid}">\n`;
  xml += reportElementXml(el);
  xml += textElementXml(el);
  xml += `\t\t\t\t<textFieldExpression><![CDATA[$F{${el.fieldName}}]]></textFieldExpression>\n`;
  xml += `\t\t\t</textField>\n`;
  return xml;
}

function buildJrxmlBarcode(el, uuid) {
  const compUuid = uid();
  const bcTypes = {Code128:'Code128',Code39:'Code39',QRCode:'QRCode',EAN13:'EAN13'};
  const bcType = bcTypes[el.barcodeType] || 'Code128';
  const ns = 'http://jasperreports.sourceforge.net/jasperreports/components';
  let expr = el.dataSource === 'field' ? `$F{${el.fieldName}}` : `"${xmlEsc(el.staticValue || '12345')}"`;
  let xml = `\t\t\t<componentElement uuid="${uuid}">\n`;
  xml += `\t\t\t\t<reportElement x="${el.x}" y="${el.y}" width="${el.width}" height="${el.height}" uuid="${compUuid}"`;
  if (el.rotation) xml += ` rotation="${el.rotation}"`;
  xml += `/>\n`;
  if (bcType === 'QRCode') {
    xml += `\t\t\t\t<jr:QRCode xmlns:jr="${ns}" errorCorrectionLevel="L">\n`;
    xml += `\t\t\t\t\t<jr:codeExpression><![CDATA[${expr}]]></jr:codeExpression>\n`;
    xml += `\t\t\t\t</jr:QRCode>\n`;
  } else {
    const tag = bcType === 'EAN13' ? 'EAN13' : bcType;
    xml += `\t\t\t\t<jr:barbecue xmlns:jr="${ns}" type="${tag}" drawText="${el.showHumanReadable}" checksumRequired="false">\n`;
    xml += `\t\t\t\t\t<jr:codeExpression><![CDATA[${expr}]]></jr:codeExpression>\n`;
    xml += `\t\t\t\t</jr:barbecue>\n`;
  }
  xml += `\t\t\t</componentElement>\n`;
  return xml;
}

function buildJrxmlLine(el, uuid) {
  let xml = `\t\t\t<line uuid="${uuid}">\n`;
  const h = el.orientation === 'horizontal' ? Math.max(el.lineThickness, 1) : el.height;
  const w = el.orientation === 'vertical' ? Math.max(el.lineThickness, 1) : el.width;
  xml += `\t\t\t\t<reportElement x="${el.x}" y="${el.y}" width="${w}" height="${h}" uuid="${uid()}"/>\n`;
  xml += `\t\t\t\t<graphicElement><pen lineWidth="${el.lineThickness}" lineColor="${el.lineColor}"/></graphicElement>\n`;
  xml += `\t\t\t</line>\n`;
  return xml;
}

function buildJrxmlRectangle(el, uuid) {
  let xml = `\t\t\t<rectangle`;
  if (el.cornerRadius) xml += ` radius="${el.cornerRadius}"`;
  xml += ` uuid="${uuid}">\n`;
  xml += `\t\t\t\t<reportElement x="${el.x}" y="${el.y}" width="${el.width}" height="${el.height}" uuid="${uid()}"`;
  if (el.fillColor === 'transparent') xml += ` mode="Transparent"`;
  xml += `/>\n`;
  xml += `\t\t\t\t<graphicElement><pen lineWidth="${el.borderThickness}" lineColor="${el.borderColor}"/></graphicElement>\n`;
  xml += `\t\t\t</rectangle>\n`;
  return xml;
}

function buildJrxmlImage(el, uuid) {
  let xml = `\t\t\t<image scaleImage="${el.scaleMode === 'retain' ? 'RetainShape' : 'FillFrame'}" uuid="${uuid}">\n`;
  xml += `\t\t\t\t<reportElement x="${el.x}" y="${el.y}" width="${el.width}" height="${el.height}" uuid="${uid()}"/>\n`;
  if (el.imageData) {
    const b64 = el.imageData.includes(',') ? el.imageData.split(',')[1] : el.imageData;
    xml += `\t\t\t\t<imageExpression><![CDATA[javax.imageio.ImageIO.read(new java.io.ByteArrayInputStream(javax.xml.bind.DatatypeConverter.parseBase64Binary("${b64}")))]]></imageExpression>\n`;
  } else {
    xml += `\t\t\t\t<imageExpression><![CDATA["no_image.png"]]></imageExpression>\n`;
  }
  xml += `\t\t\t</image>\n`;
  return xml;
}

function reportElementXml(el) {
  let xml = `\t\t\t\t<reportElement x="${el.x}" y="${el.y}" width="${el.width}" height="${el.height}" uuid="${uid()}"`;
  if (el.rotation) xml += ` rotation="${el.rotation}"`;
  xml += `/>\n`;
  return xml;
}

function textElementXml(el) {
  const jrAlign = {left:'Left',center:'Center',right:'Right'};
  const jrFont = {SansSerif:'SansSerif',Serif:'Serif',Monospaced:'Monospaced','Arial':'Arial','Helvetica':'Helvetica','Times New Roman':'Times New Roman','Courier New':'Courier New'};
  let xml = `\t\t\t\t<textElement textAlignment="${jrAlign[el.textAlign]||'Left'}">\n`;
  xml += `\t\t\t\t\t<font fontName="${jrFont[el.fontFamily]||'SansSerif'}" size="${el.fontSize}"`;
  if (el.fontBold) xml += ' isBold="true"';
  if (el.fontItalic) xml += ' isItalic="true"';
  xml += `/>\n\t\t\t\t</textElement>\n`;
  return xml;
}

// =============================================
// PDF EXPORT
// =============================================
function exportPDF() {
  if (typeof jspdf === 'undefined' && typeof window.jspdf === 'undefined') {
    alert('jsPDF library not loaded. Please check your internet connection.');
    return;
  }
  const { jsPDF } = window.jspdf;
  const w = state.label.width, h = state.label.height;
  const pdf = new jsPDF({ orientation: w > h ? 'landscape' : 'portrait', unit: 'pt', format: [w, h] });

  const sorted = [...state.elements].filter(el => !el._hidden).sort((a, b) => a.zIndex - b.zIndex);
  sorted.forEach(el => {
    switch (el.type) {
      case 'staticText':
      case 'fieldToken': {
        const text = el.type === 'staticText' ? el.text : (SAMPLE_DATA[el.fieldName] || el.fieldName);
        const style = (el.fontBold ? 'bold' : '') + (el.fontItalic ? 'italic' : '');
        pdf.setFont(el.fontFamily === 'SansSerif' ? 'helvetica' : el.fontFamily === 'Serif' ? 'times' : 'courier', style || 'normal');
        pdf.setFontSize(el.fontSize);
        const rgb = hexToRgbArr(el.textColor);
        pdf.setTextColor(rgb[0], rgb[1], rgb[2]);
        let tx = el.x, align = 'left';
        if (el.textAlign === 'center') { tx = el.x + el.width / 2; align = 'center'; }
        else if (el.textAlign === 'right') { tx = el.x + el.width; align = 'right'; }
        pdf.text(text, tx, el.y + el.fontSize, { align, maxWidth: el.width });
        break;
      }
      case 'barcode': {
        const data = el.dataSource === 'field' ? (SAMPLE_DATA[el.fieldName] || '12345') : (el.staticValue || '12345');
        try {
          const cvs = document.createElement('canvas');
          bwipjs.toCanvas(cvs, { bcid: BARCODE_MAP[el.barcodeType] || 'code128', text: data, scale: 3, height: Math.max(5, Math.round(el.height / 3)), includetext: el.showHumanReadable, textxalign: 'center' });
          pdf.addImage(cvs.toDataURL('image/png'), 'PNG', el.x, el.y, el.width, el.height);
        } catch (e) { /* skip */ }
        break;
      }
      case 'line': {
        const rgb = hexToRgbArr(el.lineColor);
        pdf.setDrawColor(rgb[0], rgb[1], rgb[2]);
        pdf.setLineWidth(el.lineThickness);
        if (el.orientation === 'horizontal') pdf.line(el.x, el.y, el.x + el.width, el.y);
        else pdf.line(el.x, el.y, el.x, el.y + el.height);
        break;
      }
      case 'rectangle': {
        const bRgb = hexToRgbArr(el.borderColor);
        pdf.setDrawColor(bRgb[0], bRgb[1], bRgb[2]);
        pdf.setLineWidth(el.borderThickness);
        if (el.fillColor && el.fillColor !== 'transparent') {
          const fRgb = hexToRgbArr(el.fillColor);
          pdf.setFillColor(fRgb[0], fRgb[1], fRgb[2]);
          pdf.roundedRect(el.x, el.y, el.width, el.height, el.cornerRadius || 0, el.cornerRadius || 0, 'FD');
        } else {
          pdf.roundedRect(el.x, el.y, el.width, el.height, el.cornerRadius || 0, el.cornerRadius || 0, 'S');
        }
        break;
      }
      case 'image': {
        if (el.imageData) {
          try { pdf.addImage(el.imageData, 'PNG', el.x, el.y, el.width, el.height); } catch (e) { /* skip */ }
        }
        break;
      }
    }
  });

  pdf.save((state.label.name || 'label') + '.pdf');
}

// =============================================
// PRINT
// =============================================
function doPrint() {
  // Inject dynamic @page size matching the label
  const w = state.label.width, h = state.label.height;
  const wIn = (w / 72).toFixed(4), hIn = (h / 72).toFixed(4);
  let pageStyle = document.getElementById('print-page-style');
  if (!pageStyle) { pageStyle = document.createElement('style'); pageStyle.id = 'print-page-style'; document.head.appendChild(pageStyle); }
  pageStyle.textContent = `@media print { @page { size: ${wIn}in ${hIn}in; margin: 0; } }`;

  const wasPreview = state.previewMode;
  const wasView = state.currentView;
  const savedZoom = state.zoom;

  // Ensure editor view is active and in preview mode at 1x zoom
  if (wasView !== 'editor') showView('editor');
  state.previewMode = true;
  state.selectedIds = [];
  state.zoom = 1;
  renderAll();

  setTimeout(() => {
    window.print();
    // Restore state
    state.previewMode = wasPreview;
    state.zoom = savedZoom;
    if (wasView !== 'editor') showView(wasView);
    else renderAll();
    document.getElementById('preview-btn').style.background = state.previewMode ? '#3b82f6' : '';
  }, 200);
}

// =============================================
// SAVE / LOAD JSON
// =============================================
function saveDesign() {
  const data = {
    version: 1,
    meta: state.currentTemplate ? state.currentTemplate.meta : { name: state.label.name, description: '', icon: 'tag', labelSize: 'custom' },
    label: deepClone(state.label),
    elements: deepClone(state.elements),
    fields: deepClone(state.templateFields || []),
    query: state.templateQuery ? deepClone(state.templateQuery) : null,
    parameters: deepClone(state.templateParams || []),
    options: state.currentTemplate ? deepClone(state.currentTemplate.options || {}) : {}
  };
  // Remove imageData for file size (keep base64 reference)
  const json = JSON.stringify(data, null, 2);
  downloadFile((state.label.name || 'label') + '.json', json, 'application/json');
}

function loadDesign(file) {
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const data = JSON.parse(e.target.result);
      if (data.label) state.label = data.label;
      if (data.elements) {
        state.elements = data.elements;
        state.elements.forEach(el => { if (!el.uuid) el.uuid = uid(); });
      }
      if (data.fields) state.templateFields = data.fields;
      if (data.query) state.templateQuery = data.query;
      if (data.parameters) state.templateParams = data.parameters;
      if (data.meta) state.currentTemplate = data;
      state.selectedIds = [];
      state.nextId = state.elements.length + 1;
      state.nextZIndex = Math.max(...state.elements.map(e => e.zIndex), 0) + 1;
      // Register sample data
      (data.fields || []).forEach(f => { if (f.sampleData) SAMPLE_DATA[f.name] = f.sampleData; });
      if (state.currentView === 'editor') renderAll();
      else showView('preview');
      buildFieldPalette();
    } catch (err) {
      alert('Error loading file: ' + err.message);
    }
  };
  reader.readAsText(file);
}

// =============================================
// JRXML IMPORT
// =============================================
function importJRXML(file) {
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const xmlStr = e.target.result;
      const parser = new DOMParser();
      const doc = parser.parseFromString(xmlStr, 'application/xml');
      const parseError = doc.querySelector('parsererror');
      if (parseError) throw new Error('Invalid XML: ' + parseError.textContent.substring(0, 100));

      const jr = doc.documentElement;
      const nsResolver = (prefix) => {
        const ns = {
          jr: 'http://jasperreports.sourceforge.net/jasperreports',
          jrc: 'http://jasperreports.sourceforge.net/jasperreports/components',
          c: 'http://jasperreports.sourceforge.net/jasperreports/components'
        };
        return ns[prefix] || null;
      };

      // Parse label dimensions from jasperReport attributes
      const pageW = parseInt(jr.getAttribute('pageWidth')) || parseInt(jr.getAttribute('columnWidth')) || 288;
      const pageH = parseInt(jr.getAttribute('pageHeight')) || 432;
      const labelName = jr.getAttribute('name') || file.name.replace(/\.jrxml$/i, '');

      // Parse fields
      const fieldEls = jr.querySelectorAll('field');
      const templateFields = [];
      fieldEls.forEach(f => {
        templateFields.push({
          name: f.getAttribute('name'),
          javaClass: f.getAttribute('class') || 'java.lang.String',
          label: f.getAttribute('name'),
          sampleData: SAMPLE_DATA[f.getAttribute('name')] || f.getAttribute('name')
        });
      });

      // Parse parameters
      const paramEls = jr.querySelectorAll('parameter');
      const templateParams = [];
      paramEls.forEach(p => {
        const name = p.getAttribute('name');
        // Skip JasperReports built-in parameters
        if (name && name.startsWith('JASPER_')) return;
        if (name === 'REPORT_LOCALE' || name === 'REPORT_TIME_ZONE') return;
        const prompt = p.querySelector('property[name="prompt"]');
        const defExpr = p.querySelector('defaultValueExpression');
        templateParams.push({
          name: name,
          javaClass: p.getAttribute('class') || 'java.lang.String',
          prompt: prompt ? prompt.getAttribute('value') : name,
          default: defExpr ? defExpr.textContent.replace(/^"(.*)"$/, '$1') : ''
        });
      });

      // Parse query
      let templateQuery = null;
      const queryEl = jr.querySelector('queryString');
      if (queryEl) {
        templateQuery = { sql: queryEl.textContent.trim() };
      }

      // Collect all elements from all bands
      const elements = [];
      let zIdx = 1;

      // Helper: get text from CDATA or text content
      function textOf(el) { return el ? el.textContent.trim() : ''; }

      // Helper: parse a reportElement
      function parseReportElement(parent) {
        const re = parent.querySelector('reportElement');
        if (!re) return { x: 0, y: 0, width: 100, height: 30, rotation: 0 };
        const rot = re.getAttribute('rotation') || '';
        let rotDeg = 0;
        if (rot === 'Left') rotDeg = 270;
        else if (rot === 'Right') rotDeg = 90;
        else if (rot === 'UpsideDown') rotDeg = 180;
        else if (rot && !isNaN(parseInt(rot))) rotDeg = parseInt(rot);
        return {
          x: parseInt(re.getAttribute('x')) || 0,
          y: parseInt(re.getAttribute('y')) || 0,
          width: parseInt(re.getAttribute('width')) || 100,
          height: parseInt(re.getAttribute('height')) || 30,
          rotation: rotDeg,
          mode: re.getAttribute('mode') || '',
          forecolor: re.getAttribute('forecolor') || '',
          backcolor: re.getAttribute('backcolor') || ''
        };
      }

      // Helper: parse textElement for font info
      function parseTextElement(parent) {
        const te = parent.querySelector('textElement');
        const result = { fontFamily: 'SansSerif', fontSize: 12, fontBold: false, fontItalic: false, textAlign: 'left', textColor: '#000000' };
        if (!te) return result;
        const align = te.getAttribute('textAlignment') || '';
        if (align === 'Center') result.textAlign = 'center';
        else if (align === 'Right') result.textAlign = 'right';
        const font = te.querySelector('font');
        if (font) {
          result.fontFamily = font.getAttribute('fontName') || 'SansSerif';
          result.fontSize = parseInt(font.getAttribute('size')) || 12;
          result.fontBold = font.getAttribute('isBold') === 'true';
          result.fontItalic = font.getAttribute('isItalic') === 'true';
        }
        return result;
      }

      // Helper: parse pen for line/border styling
      function parsePen(parent) {
        const ge = parent.querySelector('graphicElement');
        const pen = ge ? ge.querySelector('pen') : parent.querySelector('pen');
        if (!pen) return { lineWidth: 1, lineColor: '#000000' };
        return {
          lineWidth: parseFloat(pen.getAttribute('lineWidth')) || 1,
          lineColor: pen.getAttribute('lineColor') || '#000000'
        };
      }

      // Process all bands (detail, title, pageHeader, columnHeader, summary, etc.)
      const bandSelectors = ['detail band', 'title band', 'pageHeader band', 'columnHeader band', 'columnFooter band', 'pageFooter band', 'summary band', 'background band'];
      const bands = [];
      bandSelectors.forEach(sel => {
        jr.querySelectorAll(sel).forEach(b => bands.push(b));
      });
      // Also look for any band directly
      if (bands.length === 0) {
        jr.querySelectorAll('band').forEach(b => bands.push(b));
      }

      bands.forEach(band => {
        // Static text elements
        band.querySelectorAll(':scope > staticText').forEach(st => {
          const re = parseReportElement(st);
          const te = parseTextElement(st);
          const textEl = st.querySelector('text');
          elements.push({
            id: genId(), type: 'staticText', uuid: uid(),
            x: re.x, y: re.y, width: re.width, height: re.height, rotation: re.rotation,
            zIndex: zIdx++,
            text: textOf(textEl),
            ...te,
            textColor: re.forecolor || te.textColor
          });
        });

        // Text fields (field tokens)
        band.querySelectorAll(':scope > textField').forEach(tf => {
          const re = parseReportElement(tf);
          const te = parseTextElement(tf);
          const expr = tf.querySelector('textFieldExpression');
          const exprText = textOf(expr);
          // Extract field name from $F{fieldName} or use as static text
          const fieldMatch = exprText.match(/\$F\{([^}]+)\}/);
          if (fieldMatch) {
            elements.push({
              id: genId(), type: 'fieldToken', uuid: uid(),
              x: re.x, y: re.y, width: re.width, height: re.height, rotation: re.rotation,
              zIndex: zIdx++,
              fieldName: fieldMatch[1],
              ...te,
              textColor: re.forecolor || te.textColor
            });
          } else {
            // Treat as static text if no field reference
            let staticVal = exprText.replace(/^"(.*)"$/, '$1');
            elements.push({
              id: genId(), type: 'staticText', uuid: uid(),
              x: re.x, y: re.y, width: re.width, height: re.height, rotation: re.rotation,
              zIndex: zIdx++,
              text: staticVal || exprText,
              ...te,
              textColor: re.forecolor || te.textColor
            });
          }
        });

        // Lines
        band.querySelectorAll(':scope > line').forEach(ln => {
          const re = parseReportElement(ln);
          const pen = parsePen(ln);
          const isVert = re.width <= re.height;
          elements.push({
            id: genId(), type: 'line', uuid: uid(),
            x: re.x, y: re.y, width: re.width, height: re.height, rotation: re.rotation,
            zIndex: zIdx++,
            lineThickness: pen.lineWidth,
            lineColor: pen.lineColor,
            orientation: isVert ? 'vertical' : 'horizontal'
          });
        });

        // Rectangles
        band.querySelectorAll(':scope > rectangle').forEach(rect => {
          const re = parseReportElement(rect);
          const pen = parsePen(rect);
          const radius = parseInt(rect.getAttribute('radius')) || 0;
          const fillColor = (re.mode === 'Transparent') ? 'transparent' : (re.backcolor || 'transparent');
          elements.push({
            id: genId(), type: 'rectangle', uuid: uid(),
            x: re.x, y: re.y, width: re.width, height: re.height, rotation: re.rotation,
            zIndex: zIdx++,
            borderThickness: pen.lineWidth,
            borderColor: pen.lineColor,
            fillColor: fillColor,
            cornerRadius: radius
          });
        });

        // Images
        band.querySelectorAll(':scope > image').forEach(img => {
          const re = parseReportElement(img);
          const scaleAttr = img.getAttribute('scaleImage') || '';
          const scaleMode = scaleAttr === 'FillFrame' ? 'stretch' : 'retain';
          const imgExpr = img.querySelector('imageExpression');
          let imageData = '';
          if (imgExpr) {
            const exprText = textOf(imgExpr);
            // Try to extract base64 data
            const b64Match = exprText.match(/parseBase64Binary\("([^"]+)"\)/);
            if (b64Match) {
              imageData = 'data:image/png;base64,' + b64Match[1];
            }
          }
          elements.push({
            id: genId(), type: 'image', uuid: uid(),
            x: re.x, y: re.y, width: re.width, height: re.height, rotation: re.rotation,
            zIndex: zIdx++,
            imageData: imageData,
            scaleMode: scaleMode
          });
        });

        // Component elements (barcodes)
        band.querySelectorAll(':scope > componentElement').forEach(ce => {
          const re = parseReportElement(ce);
          // Detect barcode type - look for barbecue, QRCode, or other barcode tags
          let barcodeType = 'Code128';
          let dataSource = 'static';
          let fieldName = '';
          let staticValue = '12345';
          let showHumanReadable = true;

          // barbecue barcodes
          const barbecue = ce.querySelector('barbecue');
          if (barbecue) {
            const bcType = barbecue.getAttribute('type') || 'Code128';
            if (bcType === 'Code39' || bcType.includes('39')) barcodeType = 'Code39';
            else if (bcType === 'EAN13' || bcType.includes('EAN')) barcodeType = 'EAN13';
            else barcodeType = 'Code128';
            showHumanReadable = barbecue.getAttribute('drawText') !== 'false';
            const codeExpr = barbecue.querySelector('codeExpression');
            if (codeExpr) {
              const cText = textOf(codeExpr);
              const fm = cText.match(/\$F\{([^}]+)\}/);
              if (fm) { dataSource = 'field'; fieldName = fm[1]; }
              else { staticValue = cText.replace(/^"(.*)"$/, '$1'); }
            }
          }

          // QRCode
          const qr = ce.querySelector('QRCode');
          if (qr) {
            barcodeType = 'QRCode';
            const codeExpr = qr.querySelector('codeExpression');
            if (codeExpr) {
              const cText = textOf(codeExpr);
              const fm = cText.match(/\$F\{([^}]+)\}/);
              if (fm) { dataSource = 'field'; fieldName = fm[1]; }
              else { staticValue = cText.replace(/^"(.*)"$/, '$1'); }
            }
          }

          // Also check for Code128, Code39, EAN128, etc. component tags
          ['Code128', 'Code39', 'EAN13', 'EAN128', 'UPCA', 'UPCE', 'Codabar', 'PDF417', 'DataMatrix'].forEach(tag => {
            const bcEl = ce.querySelector(tag);
            if (bcEl) {
              barcodeType = (tag === 'EAN128' || tag === 'Code128') ? 'Code128' :
                            (tag === 'EAN13') ? 'EAN13' :
                            (tag === 'Code39') ? 'Code39' : 'Code128';
              const codeExpr = bcEl.querySelector('codeExpression');
              if (codeExpr) {
                const cText = textOf(codeExpr);
                const fm = cText.match(/\$F\{([^}]+)\}/);
                if (fm) { dataSource = 'field'; fieldName = fm[1]; }
                else { staticValue = cText.replace(/^"(.*)"$/, '$1'); }
              }
            }
          });

          elements.push({
            id: genId(), type: 'barcode', uuid: uid(),
            x: re.x, y: re.y, width: re.width, height: re.height, rotation: re.rotation,
            zIndex: zIdx++,
            barcodeType, dataSource, fieldName, staticValue, showHumanReadable
          });
        });
      });

      // Apply to state
      state.label = { name: labelName, width: pageW, height: pageH };
      state.elements = elements;
      state.selectedIds = [];
      state.nextId = elements.length + 1;
      state.nextZIndex = zIdx;
      state.templateFields = templateFields;
      state.templateQuery = templateQuery;
      state.templateParams = templateParams;
      state.currentTemplate = {
        meta: { name: labelName, description: 'Imported from JRXML', icon: 'tag', labelSize: 'custom' },
        label: deepClone(state.label),
        elements: deepClone(elements),
        fields: deepClone(templateFields),
        query: templateQuery ? deepClone(templateQuery) : null,
        parameters: deepClone(templateParams),
        options: {}
      };

      // Register sample data for imported fields
      templateFields.forEach(f => {
        if (!SAMPLE_DATA[f.name]) SAMPLE_DATA[f.name] = f.sampleData || f.name;
      });

      buildFieldPalette();
      showView('editor');

      const elCount = elements.length;
      const fieldCount = templateFields.length;
      console.log(`JRXML import: ${elCount} elements, ${fieldCount} fields, label ${pageW}x${pageH}pt`);

    } catch (err) {
      alert('Error importing JRXML: ' + err.message);
      console.error('JRXML import error:', err);
    }
  };
  reader.readAsText(file);
}

function downloadFile(filename, content, mime) {
  const blob = new Blob([content], { type: mime });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(a.href);
}

// =============================================
// FISHBOWL STORAGE (part.details pattern)
// =============================================
function saveTemplateToFishbowl() {
  if (!IN_FISHBOWL) {
    alert('Save to Fishbowl requires running inside the Fishbowl application.\nUse "Save as JSON" for standalone use.');
    return;
  }
  const tplName = prompt('Template name:', state.currentTemplate?.meta?.name || state.label.name || 'My Label');
  if (!tplName) return;

  showLoading(true);
  try {
    const data = {
      version: 1,
      meta: { name: tplName, description: state.currentTemplate?.meta?.description || '', icon: state.currentTemplate?.meta?.icon || 'tag', labelSize: state.currentTemplate?.meta?.labelSize || 'custom', category: 'saved', createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() },
      label: deepClone(state.label),
      elements: deepClone(state.elements),
      fields: deepClone(state.templateFields || []),
      query: state.templateQuery ? deepClone(state.templateQuery) : null,
      parameters: deepClone(state.templateParams || []),
      options: state.currentTemplate ? deepClone(state.currentTemplate.options || {}) : {}
    };

    const json = JSON.stringify(data);
    const base64 = btoa(unescape(encodeURIComponent(json)));
    const partNum = '_labelTpl_' + tplName.replace(/[^a-zA-Z0-9]/g, '');

    // Get import headers
    const headers = queryImportHeaders();
    if (!headers) { showLoading(false); alert('Could not get import headers from Fishbowl.'); return; }

    // Build CSV row matching header order
    const fieldMap = {
      'PartNumber': '"' + partNum + '"',
      'PartDescription': '"Label Template: ' + tplName.replace(/"/g, '""') + '"',
      'PartDetails': '"' + base64 + '"',
      'UOM': '"ea"',
      'PartType': '"Internal Use"',
      'Active': '"false"',
      'ABCCode': '"N"',
      'PartClass': '""',
      'Weight': '"0"',
      'WeightUOM': '"lbs"',
      'Width': '"0"',
      'Height': '"0"',
      'Length': '"0"',
      'SizeUOM': '"in"',
      'AlertNote': '"Label Designer Template - Do Not Modify"',
      'POItemType': '"Purchase"',
      'ConsumptionRate': '"0"'
    };

    const headerArr = headers.split(',').map(h => h.replace(/"/g, '').trim());
    const csvRow = headerArr.map(h => fieldMap[h] || '""').join(',');

    const importPayload = JSON.stringify({
      ImportRq: { Type: 'ImportPart', Rows: { Row: [headers, csvRow] } }
    });

    const result = runApiRequest('ImportRq', importPayload);
    showLoading(false);

    if (result && !result.includes('Error')) {
      alert('Template "' + tplName + '" saved to Fishbowl successfully!');
      loadSavedTemplates();
    } else {
      alert('Error saving template: ' + (result || 'Unknown error'));
    }
  } catch (e) {
    showLoading(false);
    alert('Error saving to Fishbowl: ' + e.message);
  }
}

function queryImportHeaders() {
  if (!IN_FISHBOWL) return null;
  try {
    if (typeof runApiRequest === 'function') {
      const resp = runApiRequest('ImportHeadersRq', JSON.stringify({ ImportHeadersRq: { Type: 'ImportPart' } }));
      if (resp) {
        const parsed = typeof resp === 'string' ? JSON.parse(resp) : resp;
        if (parsed.ImportHeadersRs && parsed.ImportHeadersRs.Header) return parsed.ImportHeadersRs.Header.Row;
      }
    }
  } catch (e) { console.error('Error getting import headers:', e); }
  // Fallback headers
  return '"PartNumber","PartDescription","PartDetails","UOM","PartType","Active","ABCCode"';
}

function loadSavedTemplates() {
  if (!IN_FISHBOWL) return;
  try {
    const results = safeRunQuery("SELECT num, description, details FROM part WHERE num LIKE '\\_labelTpl\\_%' AND typeid = 30 ORDER BY num");
    if (!results || !results.length) { state.savedTemplates = []; return; }
    state.savedTemplates = results.map(row => {
      try {
        const json = decodeURIComponent(escape(atob(row.details)));
        const tpl = JSON.parse(json);
        tpl._partNum = row.num;
        return tpl;
      } catch (e) { console.error('Error parsing template:', row.num, e); return null; }
    }).filter(Boolean);
    if (state.currentView === 'selector') renderTemplateCards();
  } catch (e) { console.error('Error loading saved templates:', e); }
}

function deleteSavedTemplate(idx) {
  const tpl = state.savedTemplates[idx];
  if (!tpl || !tpl._partNum) return;
  if (!confirm('Delete template "' + (tpl.meta?.name || tpl._partNum) + '"?')) return;
  // Mark as inactive / remove by setting details to empty
  try {
    safeRunQuery("UPDATE part SET details = '' WHERE num = '" + tpl._partNum.replace(/'/g, "''") + "'");
    state.savedTemplates.splice(idx, 1);
    renderTemplateCards();
  } catch (e) { alert('Error deleting template: ' + e.message); }
}

function showLoading(show) {
  document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
}
// =============================================
// KEYBOARD SHORTCUTS
// =============================================
document.addEventListener('keydown', e => {
  if (state.currentView !== 'editor') return;
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA' || e.target.contentEditable === 'true') return;

  const ctrl = e.ctrlKey || e.metaKey;
  if (ctrl && e.key === 'z') { e.preventDefault(); doUndo(); }
  else if (ctrl && e.key === 'y') { e.preventDefault(); doRedo(); }
  else if (ctrl && e.key === 'c') { e.preventDefault(); copySelected(); }
  else if (ctrl && e.key === 'v') { e.preventDefault(); pasteClipboard(); }
  else if (ctrl && e.key === 'a') { e.preventDefault(); state.selectedIds = state.elements.map(el => el.id); renderAll(); }
  else if (ctrl && e.key === 'd') { e.preventDefault(); copySelected(); pasteClipboard(); }
  else if (e.key === 'Delete' || e.key === 'Backspace') { e.preventDefault(); deleteSelected(); }
  else if (e.key === 'Escape') { state.selectedIds = []; renderAll(); }
  else if (e.key === 'ArrowUp') { e.preventDefault(); nudgeSelected(0, ctrl ? -1 : -state.gridSize); }
  else if (e.key === 'ArrowDown') { e.preventDefault(); nudgeSelected(0, ctrl ? 1 : state.gridSize); }
  else if (e.key === 'ArrowLeft') { e.preventDefault(); nudgeSelected(ctrl ? -1 : -state.gridSize, 0); }
  else if (e.key === 'ArrowRight') { e.preventDefault(); nudgeSelected(ctrl ? 1 : state.gridSize, 0); }
});

// =============================================
// EVENT BINDINGS & INITIALIZATION
// =============================================
document.addEventListener('DOMContentLoaded', () => {
  // Canvas mouse events
  const canvas = document.getElementById('canvas');
  if (canvas) {
    canvas.addEventListener('mousedown', onCanvasMouseDown);
    canvas.addEventListener('dragover', e => e.preventDefault());
    canvas.addEventListener('drop', handleCanvasDrop);
  }
  document.addEventListener('mousemove', onMouseMove);
  document.addEventListener('mouseup', onMouseUp);

  // Label size dropdown
  const labelSizeSel = document.getElementById('label-size');
  if (labelSizeSel) {
    labelSizeSel.addEventListener('change', () => {
      const val = labelSizeSel.value;
      if (val === 'custom') {
        const u = unitSuffix();
        const w = prompt(`Width (${u}):`, ptToDisplay(state.label.width));
        const h = prompt(`Height (${u}):`, ptToDisplay(state.label.height));
        if (w && h) { pushHistory(); state.label.width = displayToPt(w) || 288; state.label.height = displayToPt(h) || 432; renderAll(); }
        return;
      }
      const preset = LABEL_PRESETS[val];
      if (preset) { pushHistory(); state.label.width = preset.w; state.label.height = preset.h; renderAll(); }
    });
  }

  // Zoom
  const zoomSel = document.getElementById('zoom-select');
  if (zoomSel) zoomSel.addEventListener('change', () => { state.zoom = parseFloat(zoomSel.value) || 2; renderAll(); });

  // Display unit selector
  const unitSel = document.getElementById('unit-select');
  if (unitSel) unitSel.addEventListener('change', () => { state.displayUnit = unitSel.value; renderAll(); });

  // Grid controls
  const showGridCb = document.getElementById('show-grid');
  if (showGridCb) showGridCb.addEventListener('change', () => { state.showGrid = showGridCb.checked; renderAll(); });
  const snapGridCb = document.getElementById('snap-grid');
  if (snapGridCb) snapGridCb.addEventListener('change', () => { state.snapToGrid = snapGridCb.checked; });
  const gridSizeInp = document.getElementById('grid-size');
  if (gridSizeInp) gridSizeInp.addEventListener('change', () => { state.gridSize = parseInt(gridSizeInp.value) || 9; renderAll(); });

  // Image upload
  const imgUpload = document.getElementById('image-upload');
  if (imgUpload) {
    imgUpload.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        const elem = addElement('image', { imageData: ev.target.result });
        renderAll();
      };
      reader.readAsDataURL(file);
      imgUpload.value = '';
    });
  }

  // Load JSON file
  const loadFile = document.getElementById('load-file');
  if (loadFile) {
    loadFile.addEventListener('change', e => {
      if (e.target.files[0]) loadDesign(e.target.files[0]);
      loadFile.value = '';
    });
  }

  // Import JRXML file
  const importFile = document.getElementById('import-jrxml-file');
  if (importFile) {
    importFile.addEventListener('change', e => {
      if (e.target.files[0]) importJRXML(e.target.files[0]);
      importFile.value = '';
    });
  }

  // Drag-and-drop for JRXML/JSON files
  let dropCounter = 0;
  const dropOverlay = document.getElementById('drop-overlay');
  document.addEventListener('dragenter', e => {
    e.preventDefault();
    dropCounter++;
    if (dropOverlay) dropOverlay.style.display = 'block';
  });
  document.addEventListener('dragleave', e => {
    e.preventDefault();
    dropCounter--;
    if (dropCounter <= 0) { dropCounter = 0; if (dropOverlay) dropOverlay.style.display = 'none'; }
  });
  document.addEventListener('dragover', e => { e.preventDefault(); });
  document.addEventListener('drop', e => {
    e.preventDefault();
    dropCounter = 0;
    if (dropOverlay) dropOverlay.style.display = 'none';
    const file = e.dataTransfer.files[0];
    if (!file) return;
    const name = file.name.toLowerCase();
    if (name.endsWith('.jrxml') || name.endsWith('.xml')) {
      importJRXML(file);
    } else if (name.endsWith('.json')) {
      loadDesign(file);
    } else {
      alert('Unsupported file type. Please drop a .jrxml or .json file.');
    }
  });

  // Field search
  const fieldSearch = document.getElementById('field-search');
  if (fieldSearch) fieldSearch.addEventListener('input', () => buildFieldPalette());

  // Build initial views
  renderTemplateCards();
  buildFieldPalette();
  loadSavedTemplates();
});
</script>
</body>
</html>
