<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto PO - Inventory Reorder Watchlist</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- D3.js v7 -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <!-- Moment.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

    <!-- DataTables CDN Links -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs4-4.1.1/jq-3.3.1/jszip-2.5.0/dt-1.10.20/b-1.6.1/b-colvis-1.6.1/b-html5-1.6.1/b-print-1.6.1/cr-1.5.2/fh-3.1.6/r-2.2.3/sc-2.0.1/datatables.min.css"/>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/v/bs4-4.1.1/jq-3.3.1/jszip-2.5.0/dt-1.10.20/b-1.6.1/b-colvis-1.6.1/b-html5-1.6.1/b-print-1.6.1/cr-1.5.2/fh-3.1.6/r-2.2.3/sc-2.0.1/datatables.min.js"></script>
    <style>
        /* ============================================
           Base Styles (matching Reorder Watchlist)
           ============================================ */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        :root {
            --color-primary: #2d9cdb;
            --color-primary-dark: #1e7bb4;
            --color-sidebar: #06162d;
            --color-sidebar-hover: #0a1f3d;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .bg-indigo-600 { background-color: var(--color-primary) !important; }
        .bg-indigo-50 { background-color: rgba(45, 156, 219, 0.1) !important; }
        .text-indigo-600 { color: var(--color-primary) !important; }
        .text-indigo-700 { color: var(--color-primary-dark) !important; }
        .border-indigo-200 { border-color: rgba(45, 156, 219, 0.3) !important; }
        .hover\:text-indigo-600:hover { color: var(--color-primary) !important; }
        .hover\:bg-indigo-50:hover { background-color: rgba(45, 156, 219, 0.1) !important; }

        /* ============================================
           DataTables Overrides
           ============================================ */
        table.dataTable {
            table-layout: fixed;
            font-size: 12px;
            border-collapse: separate;
            border-spacing: 0;
        }

        table.dataTable thead th {
            font-size: 12px;
            padding: 12px 8px;
            background-color: #f8f9fa !important;
            color: #475569 !important;
            font-weight: 600;
            border: none;
            border-bottom: 2px solid #e2e8f0;
            text-align: center;
            white-space: normal;
            line-height: 1.3;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        table.dataTable thead th:first-child { border-top-left-radius: 0px; }
        table.dataTable thead th:last-child { border-top-right-radius: 0px; }

        table.dataTable tbody td {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 12px;
            padding: 8px;
            border-bottom: 1px solid #e2e8f0;
        }

        table.dataTable tbody td.dt-center { text-align: center; }
        table.dataTable tbody td.dt-right { text-align: right; }

        table.dataTable tbody tr {
            background-color: white;
            transition: background-color 0.15s ease;
        }

        table.dataTable tbody tr:hover { background-color: #f8fafc; }

        /* Vendor Group Header Row */
        .vendor-group-header td {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%) !important;
            font-weight: 700;
            padding: 12px !important;
            font-size: 13px;
            border-top: 2px solid var(--color-primary);
            border-bottom: 1px solid #cbd5e1;
            color: #1e293b;
        }

        .item-link {
            color: #2d9cdb;
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }
        .item-link:hover {
            text-decoration: underline;
            color: #1e7bb4;
        }

        .dataTables_wrapper .dataTables_length,
        .dataTables_wrapper .dataTables_filter,
        .dataTables_wrapper .dataTables_info,
        .dataTables_wrapper .dataTables_paginate,
        .dt-buttons {
            display: none !important;
        }

        .group-part-info { background-color: #f1f5f9 !important; }
        .group-inventory-key { background-color: #fef3c7 !important; }
        .group-reorder-params { background-color: #dcfce7 !important; }
        .group-allocation { background-color: #fafafa !important; }
        .group-status { background-color: transparent !important; }

        /* ============================================
           Auto PO Specific Styles
           ============================================ */
        .row-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: var(--color-primary);
        }

        .qty-input {
            width: 70px;
            padding: 2px 6px;
            font-size: 12px;
            border: 1px solid #cbd5e1;
            border-radius: 3px;
            text-align: right;
            background: white;
        }
        .qty-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(45, 156, 219, 0.2);
        }
        .qty-input:disabled {
            background: #f1f5f9;
            color: #94a3b8;
        }

        .btn-create-po {
            padding: 4px 12px;
            font-size: 11px;
            font-weight: 600;
            color: white;
            background-color: #16a34a;
            border: 1px solid #15803d;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s ease;
            white-space: nowrap;
        }
        .btn-create-po:hover { background-color: #15803d; }
        .btn-create-po:disabled {
            background-color: #94a3b8;
            border-color: #94a3b8;
            cursor: not-allowed;
        }

        .vendor-select-all {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: var(--color-primary);
            vertical-align: middle;
            margin-right: 4px;
        }

        /* Toast notification - bottom right corner */
        #toastContainer {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 8px;
            pointer-events: none;
        }
        .toast {
            padding: 10px 18px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            pointer-events: auto;
            animation: toastIn 0.3s ease-out;
            max-width: 360px;
        }
        .toast.fade-out { animation: toastOut 0.3s ease-in forwards; }
        .toast.success { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .toast.error { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .toast.info { background: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; }
        .toast.warning { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
        @keyframes toastIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes toastOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(12px); } }

        tr.row-deselected td { opacity: 0.45; }

        tr.vendor-collapsed { display: none !important; }

        .vendor-expand-toggle {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            cursor: pointer;
            margin-right: 4px;
            vertical-align: middle;
            transition: transform 0.15s ease;
            color: #64748b;
        }
        .vendor-expand-toggle:hover { color: #2d9cdb; }
        .vendor-expand-toggle.expanded { transform: rotate(90deg); }

        .vendor-po-value {
            font-size: 12px;
            font-weight: 600;
            color: #16a34a;
            margin-right: 12px;
            white-space: nowrap;
        }

        /* Custom Tooltip */
        .custom-tooltip {
            position: absolute;
            background: rgba(15, 23, 42, 0.95);
            color: white;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            line-height: 1.5;
            pointer-events: none;
            z-index: 10000;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transition: opacity 0.2s ease;
            max-width: 400px;
            white-space: pre-line;
        }
        .custom-tooltip.show { opacity: 1; }

        /* ============================================
           PO Modal Styles
           ============================================ */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9998;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
        }
        .modal-header {
            padding: 16px 24px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .modal-body {
            padding: 16px 24px;
            overflow-y: auto;
            flex: 1;
        }
        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .modal-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .modal-table th {
            background: #f8f9fa;
            padding: 10px 8px;
            text-align: left;
            font-weight: 600;
            color: #475569;
            border-bottom: 2px solid #e2e8f0;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.5px;
        }
        .modal-table td {
            padding: 8px;
            border-bottom: 1px solid #e2e8f0;
            color: #334155;
        }
        .modal-table tr:hover { background: #f8fafc; }
        .modal-table .col-right { text-align: right; }
        .modal-input {
            width: 80px;
            padding: 3px 6px;
            font-size: 12px;
            border: 1px solid #cbd5e1;
            border-radius: 3px;
            text-align: right;
        }
        .modal-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(45, 156, 219, 0.2);
        }
        .modal-total-row td {
            font-weight: 700;
            border-top: 2px solid #334155;
            padding-top: 12px;
        }

        /* ============================================
           Print Styles
           ============================================ */
        @media print {
            html, body { overflow: visible; }
            @page { size: A4 landscape; margin: 0.5in; }
            .dataTables_wrapper .dataTables_length,
            .dataTables_wrapper .dataTables_filter,
            .dataTables_wrapper .dataTables_info,
            .dataTables_wrapper .dataTables_paginate,
            .dt-buttons, button, .btn, header,
            .row-checkbox, .qty-input, .btn-create-po,
            #parametersPanel, #toastContainer, .modal-overlay,
            #debugConsoleContainer { display: none !important; }
            table.dataTable { width: 100% !important; font-size: 7pt; }
            table.dataTable thead th { font-size: 6.5pt; padding: 3px 2px; border: 1px solid #ccc; }
            table.dataTable tbody td { font-size: 7pt; padding: 2px 1px; border: 1px solid #ccc; }
            .vendor-group-header td { font-weight: bold; font-size: 7.5pt; padding: 4px 2px !important; border: 1px solid #000 !important; }
        }
    </style>
</head>
<body class="bg-slate-50">
    <div id="customTooltip" class="custom-tooltip"></div>

    <!-- PO Modal Container (populated dynamically) -->
    <div id="poModal"></div>

    <div class="flex flex-col h-screen">
        <!-- Header -->
        <header id="headerContainer" class="h-20 bg-white border-b border-slate-200 px-8 flex items-center justify-between flex-shrink-0 z-20 shadow-sm">
            <div class="flex items-center gap-6">
                <div>
                    <h1 class="text-xl font-bold text-slate-900">Auto PO - Inventory Reorder Watchlist</h1>
                    <p class="text-xs text-slate-500 mt-0.5">Generate purchase orders from system-calculated reorder suggestions</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="toggleInstructions()" class="px-3 py-2 bg-slate-100 hover:bg-slate-200 border border-slate-300 rounded-lg text-sm font-medium transition-colors" title="View Usage Guide">
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Help
                </button>
            </div>
        </header>

        <!-- Content Area -->
        <div class="flex-1 overflow-y-auto custom-scrollbar p-4 lg:p-8">
            <!-- Instructions Panel -->
            <div id="instructionsPanel" class="bg-white rounded-2xl shadow-md border border-slate-300 p-6 mb-6" style="display: none;">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Usage Guide
                    </h2>
                    <button onclick="toggleInstructions()" class="text-slate-400 hover:text-slate-600 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-sm font-bold text-slate-700 mb-2">How It Works</h3>
                        <p class="text-sm text-slate-600 mb-3">This report uses Fishbowl's built-in Auto PO engine to calculate suggested purchase quantities for each part, factoring in on-hand stock, allocations, open orders, reorder points, and target levels.</p>
                        <h3 class="text-sm font-bold text-slate-700 mb-2">Steps</h3>
                        <ol class="text-sm text-slate-600 space-y-1 list-decimal list-inside">
                            <li>Configure parameters (vendor, location group, date range, etc.)</li>
                            <li>Click <strong>Load Data</strong> to fetch suggestions from the system</li>
                            <li>Review results &mdash; adjust quantities if needed</li>
                            <li>Select/deselect parts using checkboxes</li>
                            <li>Click <strong>Create PO</strong> on vendor header row to review and create a purchase order</li>
                        </ol>

                        <h3 class="text-sm font-bold text-slate-700 mt-4 mb-2">Vendor Sections</h3>
                        <p class="text-sm text-slate-600 mb-2">Parts are grouped by vendor. Each vendor section can be collapsed or expanded using the <strong>&gt;</strong> chevron toggle on the header row:</p>
                        <div class="text-sm text-slate-600 space-y-1">
                            <p><span class="inline-flex items-center justify-center w-5 h-5 mr-1 align-middle"><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="transform:rotate(90deg);color:#2d9cdb;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></span> <strong>Expanded</strong> &mdash; part rows are visible beneath the vendor header.</p>
                            <p><span class="inline-flex items-center justify-center w-5 h-5 mr-1 align-middle"><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color:#64748b;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></span> <strong>Collapsed</strong> &mdash; part rows are hidden to save space.</p>
                        </div>
                        <p class="text-xs text-slate-500 mt-2">Vendors with suggested order quantities auto-expand on load. Vendors with no suggestions auto-collapse. Toggling does not affect row selections, quantities, or PO values &mdash; collapsed items are still included when creating a PO.</p>

                        <h3 class="text-sm font-bold text-slate-700 mt-4 mb-2">Key Metrics</h3>
                        <div class="text-sm text-slate-600 space-y-1">
                            <p><strong>Available:</strong> On Hand &minus; Allocated &minus; Not Available + Drop Ship</p>
                            <p><strong>Needed:</strong> Calculated shortfall quantity from the Auto PO engine</p>
                            <p><strong>Order Qty:</strong> Suggested purchase quantity (editable per row)</p>
                            <p><strong>ROP:</strong> Reorder Point &mdash; minimum threshold triggering a reorder</p>
                            <p><strong>Target:</strong> Order Up To level &mdash; target maximum inventory</p>
                            <p><strong>PO Value:</strong> Sum of (Order Qty &times; Last Cost) for selected parts per vendor</p>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-sm font-bold text-slate-700 mb-2">Parameters</h3>
                        <div class="text-sm text-slate-600 space-y-1">
                            <p><strong>Vendor:</strong> Select a specific vendor or "All Vendors" (processes each vendor individually).</p>
                            <p><strong>Location Group:</strong> Use "All" (-1) for company wide, or select a specific group.</p>
                            <p><strong>QB Class:</strong> Use "All" (-1) for all classes, or select a specific QuickBooks class.</p>
                            <p><strong>Date Range:</strong> The date window for demand analysis.</p>
                            <p><strong>Default Vendor Only:</strong> Only show parts where this vendor is the default vendor.</p>
                        </div>

                        <h3 class="text-sm font-bold text-slate-700 mt-4 mb-3">Status Indicators</h3>
                        <p class="text-sm text-slate-600 mb-3">The Status column uses color-coded cells with gradient fills representing capacity percentage:</p>
                        <div class="space-y-3">
                            <div class="flex items-center gap-3">
                                <div class="w-20 h-8 rounded flex items-center justify-center text-white text-xs font-semibold" style="background: linear-gradient(to left, #C62828 75%, #EF9A9A 75%); text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">-75%</div>
                                <div class="flex-1 text-xs">
                                    <strong class="text-slate-700">Critical</strong>
                                    <p class="text-slate-500">Below reorder point &mdash; fills from right (negative values)</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="w-20 h-8 rounded flex items-center justify-center text-white text-xs font-semibold" style="background: linear-gradient(to right, #F57C00 20%, #FFCC80 20%); text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">20%</div>
                                <div class="flex-1 text-xs">
                                    <strong class="text-slate-700">Alert</strong>
                                    <p class="text-slate-500">Within 20% above reorder point &mdash; order soon</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="w-20 h-8 rounded flex items-center justify-center text-white text-xs font-semibold" style="background: linear-gradient(to right, #2E7D32 60%, #A5D6A7 60%); text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">60%</div>
                                <div class="flex-1 text-xs">
                                    <strong class="text-slate-700">Good</strong>
                                    <p class="text-slate-500">Adequate stock levels</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="w-24 h-8 rounded flex items-center justify-center text-white text-xs font-semibold" style="background: #1976D2; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">Overstocked</div>
                                <div class="flex-1 text-xs">
                                    <strong class="text-slate-700">Overstocked</strong>
                                    <p class="text-slate-500">Above order up to level</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="w-20 h-8 rounded flex items-center justify-center text-xs font-semibold" style="background: #e2e8f0; color: #64748b;">No ROP/OUL</div>
                                <div class="flex-1 text-xs">
                                    <strong class="text-slate-700">Not Configured</strong>
                                    <p class="text-slate-500">Part has no reorder point or target level set</p>
                                </div>
                            </div>
                        </div>

                        <!-- Status Scale Diagram -->
                        <h3 class="text-sm font-bold text-slate-700 mt-5 mb-3">How Status % is Calculated</h3>
                        <div class="bg-slate-50 rounded-lg p-3 border border-slate-200">
                            <div class="flex gap-4">
                                <!-- Left: Scale visualization -->
                                <div class="flex-1">
                                    <p class="text-xs text-slate-600 mb-2">Status % shows where Available falls on the scale:</p>
                                    <!-- Scale bar with ticks -->
                                    <div class="relative" style="height: 70px;">
                                        <!-- Color bar: Critical=40%, Alert=10%, Good=38%, Over=12% -->
                                        <div class="absolute top-0 left-0 right-0 flex h-7 rounded overflow-hidden border border-slate-300">
                                            <div class="w-[40%] bg-gradient-to-r from-red-200 to-red-600 flex items-center justify-center">
                                                <span class="text-[10px] font-semibold text-white" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">Critical</span>
                                            </div>
                                            <div class="w-[10%] bg-orange-500"></div>
                                            <div class="w-[38%] bg-gradient-to-r from-green-600 to-green-500 flex items-center justify-center">
                                                <span class="text-[10px] font-semibold text-white" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">Good</span>
                                            </div>
                                            <div class="w-[12%] bg-blue-600 flex items-center justify-center">
                                                <span class="text-[8px] font-semibold text-white" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">Over</span>
                                            </div>
                                        </div>
                                        <!-- Tick marks at boundaries -->
                                        <div class="absolute top-7 left-0 w-px h-2 bg-slate-500"></div>
                                        <div class="absolute top-7 left-[40%] w-px h-2 bg-slate-500"></div>
                                        <div class="absolute top-7 left-[88%] w-px h-2 bg-slate-500"></div>
                                        <!-- Labels -->
                                        <span class="absolute top-9 left-0 text-[10px] font-semibold text-slate-500">0</span>
                                        <span class="absolute top-9 left-[40%] text-[10px] font-semibold text-red-600" style="transform: translateX(-50%);">ROP</span>
                                        <span class="absolute top-9 left-[88%] text-[10px] font-semibold text-green-600" style="transform: translateX(-50%);">OUL</span>
                                        <!-- Percentage labels centered in each zone -->
                                        <span class="absolute top-14 left-[20%] text-[9px] text-slate-500" style="transform: translateX(-50%);">-100% &larr; &rarr; 0%</span>
                                        <span class="absolute top-14 left-[64%] text-[9px] text-slate-500" style="transform: translateX(-50%);">0% &rarr; 100%</span>
                                        <span class="absolute top-14 left-[94%] text-[9px] text-slate-500" style="transform: translateX(-50%);">&gt;100%</span>
                                    </div>
                                </div>
                                <!-- Right: Example calculations -->
                                <div class="flex-1 text-xs text-slate-600 border-l border-slate-200 pl-4">
                                    <p class="font-semibold text-slate-700 mb-1">Example: ROP = 50, OUL = 150</p>
                                    <p><span class="inline-block w-12 text-red-600 font-medium">-50%</span> Available = 25</p>
                                    <p><span class="inline-block w-12 text-orange-600 font-medium">0%</span> Available = 50 (at ROP)</p>
                                    <p><span class="inline-block w-12 text-green-600 font-medium">50%</span> Available = 100</p>
                                    <p><span class="inline-block w-12 text-green-600 font-medium">100%</span> Available = 150 (at OUL)</p>
                                    <p><span class="inline-block w-12 text-blue-600 font-medium">Over</span> Available &gt; 150</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Parameters Panel -->
            <div id="parametersPanel" class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 mb-4">
                <div class="flex flex-wrap gap-3 items-end">
                    <div class="flex-1 min-w-[160px]">
                        <label class="block text-xs font-medium text-slate-600 mb-1">Vendor</label>
                        <select id="paramVendor" class="w-full px-2 py-1.5 text-sm border border-slate-300 rounded bg-white">
                            <option value="all">All Vendors</option>
                        </select>
                    </div>
                    <div class="flex-1 min-w-[160px]">
                        <label class="block text-xs font-medium text-slate-600 mb-1">Location Group</label>
                        <select id="paramLocationGroup" class="w-full px-2 py-1.5 text-sm border border-slate-300 rounded bg-white">
                            <option value="-1">All (Company Wide)</option>
                        </select>
                    </div>
                    <div class="flex-1 min-w-[120px]">
                        <label class="block text-xs font-medium text-slate-600 mb-1">QB Class</label>
                        <select id="paramQBClass" class="w-full px-2 py-1.5 text-sm border border-slate-300 rounded bg-white">
                            <option value="-1">All</option>
                        </select>
                    </div>
                    <div class="min-w-[130px]">
                        <label class="block text-xs font-medium text-slate-600 mb-1">Start Date</label>
                        <input type="date" id="paramStartDate" class="w-full px-2 py-1 text-sm border border-slate-300 rounded">
                    </div>
                    <div class="min-w-[130px]">
                        <label class="block text-xs font-medium text-slate-600 mb-1">End Date</label>
                        <input type="date" id="paramEndDate" class="w-full px-2 py-1 text-sm border border-slate-300 rounded">
                    </div>
                    <div class="flex items-center gap-4 py-1">
                        <label class="flex items-center gap-1.5 text-xs text-slate-600 cursor-pointer whitespace-nowrap" title="Only show parts where this is the default vendor">
                            <input type="checkbox" id="paramDefaultVendorOnly" class="accent-[#2d9cdb]"> Default Vendor Only
                        </label>
                        <label class="flex items-center gap-1.5 text-xs text-slate-600 cursor-pointer whitespace-nowrap">
                            <input type="checkbox" id="paramShowVendorPN" checked class="accent-[#2d9cdb]"> Vendor Part #
                        </label>
                        <label class="flex items-center gap-1.5 text-xs text-slate-600 cursor-pointer whitespace-nowrap">
                            <input type="checkbox" id="paramIncludeNoROP" checked class="accent-[#2d9cdb]"> No ROP/OUL
                        </label>
                        <label class="flex items-center gap-1.5 text-xs text-slate-600 cursor-pointer whitespace-nowrap">
                            <input type="checkbox" id="paramIncludeMfg" checked class="accent-[#2d9cdb]"> Always Mfg
                        </label>
                    </div>
                    <div>
                        <button onclick="loadAutoPoData()" id="btnLoadData" class="px-4 py-1.5 text-sm font-semibold text-white rounded border border-[#1e7bb4] transition-colors" style="background-color: var(--color-primary);" onmouseover="this.style.backgroundColor='#1e7bb4'" onmouseout="this.style.backgroundColor='#2d9cdb'">
                            Load Data
                        </button>
                    </div>
                </div>
            </div>

            <!-- Column Filters -->
            <div id="columnFilters" class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 mb-4" style="display:none;">
                <div class="flex flex-wrap gap-3 items-end">
                    <div class="flex-1 min-w-[120px]">
                        <label class="block text-xs font-medium text-slate-600 mb-1">Part Number</label>
                        <input type="text" id="filterPartNum" class="w-full px-2 py-1 text-sm border border-slate-300 rounded" placeholder="Filter..." oninput="applyColumnFilters()">
                    </div>
                    <div class="flex-1 min-w-[150px]">
                        <label class="block text-xs font-medium text-slate-600 mb-1">Description</label>
                        <input type="text" id="filterDescription" class="w-full px-2 py-1 text-sm border border-slate-300 rounded" placeholder="Filter..." oninput="applyColumnFilters()">
                    </div>
                    <div class="flex-1 min-w-[120px]">
                        <label class="block text-xs font-medium text-slate-600 mb-1">Vendor</label>
                        <input type="text" id="filterVendor" class="w-full px-2 py-1 text-sm border border-slate-300 rounded" placeholder="Filter..." oninput="applyColumnFilters()">
                    </div>
                    <div class="flex items-center gap-1">
                        <button onclick="clearColumnFilters()" class="px-3 py-1 text-sm bg-slate-100 hover:bg-slate-200 text-slate-700 rounded border border-slate-300">Clear</button>
                        <button onclick="exportToCSV()" class="p-1.5 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded border border-slate-300" title="Export CSV">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        </button>
                        <button onclick="printTable()" class="p-1.5 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded border border-slate-300" title="Print">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Toast Container (fixed bottom-right) -->
            <div id="toastContainer"></div>

            <!-- Overall PO Summary -->
            <div id="poSummaryBar" class="bg-gradient-to-r from-slate-50 to-white rounded-xl shadow-sm border border-slate-200 px-5 py-3 mb-4 flex items-center justify-between" style="display:none;">
                <div class="flex items-center gap-3">
                    <svg class="w-5 h-5 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                    </svg>
                    <div>
                        <span class="text-xs font-medium text-slate-500 uppercase tracking-wide">Total Selected PO Value</span>
                        <div class="text-lg font-bold text-emerald-600" id="overallPoTotal">$0.00</div>
                    </div>
                </div>
                <div class="text-right">
                    <span class="text-xs font-medium text-slate-500 uppercase tracking-wide">Selected Parts</span>
                    <div class="text-sm font-semibold text-slate-700" id="overallSelectedCount">0 / 0</div>
                </div>
            </div>

            <!-- Main Table Container -->
            <div id="tableContainer" class="bg-white rounded-2xl shadow-md border border-slate-300 p-6 relative" style="display:none;">
                <table id="report-table" class="display" style="width:100%"></table>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="bg-white rounded-2xl shadow-md border border-slate-300 p-12 text-center">
                <svg class="w-16 h-16 mx-auto text-slate-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                </svg>
                <p class="text-slate-500 text-sm mb-2">Configure parameters above and click <strong>Load Data</strong> to fetch reorder suggestions.</p>
                <p class="text-slate-400 text-xs">The system will calculate suggested purchase quantities for each vendor.</p>
            </div>

            <!-- Debug Console (hidden by default, shown if BI_SHOW_DEBUG=true) -->
            <div id="debugConsoleContainer" class="mt-6" style="display: none;">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <button onclick="toggleDebugConsole()" class="w-full px-6 py-3 flex items-center justify-between hover:bg-slate-50 transition-colors">
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                            </svg>
                            <span class="text-sm font-semibold text-slate-700">Debug Console</span>
                            <span class="text-xs text-slate-400 font-normal">Auto-scrolls to latest entry</span>
                        </div>
                        <svg id="debugChevron" class="w-5 h-5 text-slate-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>

                    <div id="debugContent" class="hidden border-t border-slate-200">
                        <div class="bg-slate-900 px-4 py-2 flex items-center justify-between">
                            <span class="text-xs text-slate-400 font-mono">Auto PO Diagnostics</span>
                            <button onclick="clearDebugLog()" class="text-xs text-slate-400 hover:text-white transition-colors">
                                Clear
                            </button>
                        </div>
                        <div id="debugLog" class="bg-slate-950 text-slate-200 p-4 font-mono text-xs max-h-96 overflow-y-auto" style="scrollbar-width: thin;">
                            <div class="text-slate-500 italic">Waiting for application to initialize...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // ============================================
    // Configuration & Globals
    // ============================================
    const displayHeader = $CHECK{Display_header|true};
    document.getElementById('headerContainer').style.display = displayHeader ? 'flex' : 'none';

    let user = JSON.parse(getUser());
    let currentUser = user.id;

    // User's default location group (resolved from usertolg at init)
    let userDefaultLG = { id: 0, name: '' };

    let allResults = [];
    let selectionState = {};
    let qtyOverrides = {};
    let dataTable = null;
    // Map of default vendor per part: { partId: vendorId }
    let defaultVendorMap = {};
    // Map of vendorparts data: { "partId_vendorId": { lastcost, leadtime, vendorpartnumber } }
    let vendorPartsLookup = {};
    // Track collapsed/expanded state per vendor: { vendorId: true/false }
    let vendorCollapsed = {};

    // Debug mode from Fishbowl system property (default to false)
    const BI_SHOW_DEBUG_PROP = typeof getProperty === 'function' ? getProperty('BI_SHOW_DEBUG', 'false') : 'false';
    const DEBUG_MODE = BI_SHOW_DEBUG_PROP === 'true' || BI_SHOW_DEBUG_PROP === true;

    // ============================================
    // Tooltip
    // ============================================
    function showTooltip(event, content) {
        const tooltip = document.getElementById('customTooltip');
        tooltip.innerHTML = content;
        tooltip.classList.add('show');
        const x = event.pageX + 15;
        const y = event.pageY + 15;
        tooltip.style.left = ((x + 400 > window.innerWidth) ? event.pageX - 400 - 15 : x) + 'px';
        tooltip.style.top = ((y + 100 > window.innerHeight) ? event.pageY - 100 - 15 : y) + 'px';
    }

    function hideTooltip() {
        document.getElementById('customTooltip').classList.remove('show');
    }

    function toggleInstructions() {
        const panel = document.getElementById('instructionsPanel');
        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }

    // ============================================
    // Debug Console
    // ============================================
    function debugLog(message, type) {
        type = type || 'info';
        if (!DEBUG_MODE) return;

        var timestamp = new Date().toLocaleTimeString();
        var logDiv = document.getElementById('debugLog');
        if (!logDiv) return;

        // Clear initial placeholder message
        if (logDiv.querySelector('.italic')) {
            logDiv.innerHTML = '';
        }

        var colors = {
            'info': 'text-blue-400',
            'success': 'text-green-400',
            'warning': 'text-yellow-400',
            'error': 'text-red-400',
            'click': 'text-purple-400'
        };

        var entry = document.createElement('div');
        entry.className = 'py-0.5';
        entry.innerHTML = '<span class="text-slate-500">[' + timestamp + ']</span> <span class="' + (colors[type] || colors.info) + '">' + message + '</span>';

        logDiv.appendChild(entry);
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    function toggleDebugConsole() {
        var content = document.getElementById('debugContent');
        var chevron = document.getElementById('debugChevron');

        if (content.classList.contains('hidden')) {
            content.classList.remove('hidden');
            chevron.style.transform = 'rotate(180deg)';
        } else {
            content.classList.add('hidden');
            chevron.style.transform = 'rotate(0deg)';
        }
    }

    function clearDebugLog() {
        var logDiv = document.getElementById('debugLog');
        if (logDiv) logDiv.innerHTML = '<div class="text-slate-500 italic">Log cleared</div>';
    }

    // ============================================
    // Formatting Helpers
    // ============================================
    function formatNumber(val) {
        if (val === null || val === undefined || val === '') return '0';
        var num = parseFloat(val);
        if (isNaN(num)) return '0';
        if (Number.isInteger(num)) return num.toString();
        return num.toFixed(2).replace(/\.?0+$/, '');
    }

    function safeCost(val) {
        // Robustly extract a numeric cost from any value (handles objects, strings, null, undefined)
        if (val === null || val === undefined || val === '') return 0;
        if (typeof val === 'object') return 0;
        var num = parseFloat(val);
        return isNaN(num) ? 0 : num;
    }

    // ============================================
    // Compute inventory status (state + capacity %)
    // Matches Inv_Reorder_Watchlist logic
    // ============================================
    function computePartStatus(item) {
        var rop = parseFloat(item.reorder_level) || 0;
        var oul = parseFloat(item.target_level) || 0;
        // Compute available: on_hand - allocated - not_available + drop_ship
        // The SQL query computes the full formula (including qtynotavailable) as _available.
        // JS fallback only used for Auto PO engine rows where _available is not pre-computed.
        var onhand = parseFloat(item.qty_on_hand) || 0;
        var allocated = parseFloat(item.qty_allocated) || 0;
        var dropship = parseFloat(item.qty_on_drop_ship) || 0;
        var available = Math.max(0, onhand - allocated + dropship);
        // Use _available if already computed from standard query (includes Not Available)
        if (item._available !== undefined) available = item._available;

        item._available = available;

        if (!rop || !oul || rop === 0 || oul === 0) {
            item._state = 'norop';
            item._capacitypct = null;
            return;
        }

        if (available > oul) {
            item._state = 'fb10';
            item._capacitypct = 150;
        } else if (available < rop) {
            item._state = 'fb40';
            item._capacitypct = Math.round(-1 * ((rop - available) / rop) * 100 * 10) / 10;
        } else if (oul === rop) {
            item._state = available >= oul ? 'fb20' : 'fb40';
            item._capacitypct = available >= oul ? 100 : Math.round(-1 * ((rop - available) / rop) * 100 * 10) / 10;
        } else if (available <= rop + (0.2 * (oul - rop))) {
            item._state = 'fb30';
            item._capacitypct = Math.round(((available - rop) / (oul - rop)) * 100 * 10) / 10;
        } else {
            item._state = 'fb20';
            item._capacitypct = Math.round(((available - rop) / (oul - rop)) * 100 * 10) / 10;
        }
    }

    // Currency formatting â€” currencyLocale() returns { symbol, locale } with no arguments
    var CURRENCY_LOCALE_OBJ = (typeof currencyLocale === 'function') ? currencyLocale() : {};
    var CURRENCY_SYMBOL = (CURRENCY_LOCALE_OBJ && CURRENCY_LOCALE_OBJ.symbol) || '$';
    var LOCALE_CODE = (CURRENCY_LOCALE_OBJ && CURRENCY_LOCALE_OBJ.locale) || 'en-US';

    function formatCurrencyVal(val) {
        var num = safeCost(val);
        var isNegative = num < 0;
        var absValue = Math.abs(num);
        var formatted = absValue.toLocaleString(LOCALE_CODE, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
        return isNegative ? '-' + CURRENCY_SYMBOL + formatted : CURRENCY_SYMBOL + formatted;
    }

    // ============================================
    // Initialize Parameter Dropdowns
    // ============================================
    function initParameters() {
        try {
            var vendors = JSON.parse(runQuery("SELECT id, name FROM vendor WHERE activeflag = 1 ORDER BY name"));
            var sel = document.getElementById('paramVendor');
            vendors.forEach(function(v) {
                var opt = document.createElement('option');
                opt.value = v.id;
                opt.textContent = v.name;
                sel.appendChild(opt);
            });
        } catch (e) { console.error('Failed to load vendors:', e); }

        try {
            var lgs = JSON.parse(runQuery(
                "SELECT lg.id, lg.name, ulg.defaultflag " +
                "FROM locationgroup lg " +
                "INNER JOIN usertolg ulg ON lg.id = ulg.locationgroupid " +
                "WHERE lg.activeflag = 1 AND ulg.userid = " + parseInt(currentUser) +
                " ORDER BY lg.name"
            ));
            var sel = document.getElementById('paramLocationGroup');
            lgs.forEach(function(lg) {
                var opt = document.createElement('option');
                opt.value = lg.id;
                opt.textContent = lg.name;
                sel.appendChild(opt);
                // Capture user's default location group
                if (lg.defaultflag === '1' || lg.defaultflag === 1 || lg.defaultflag === true) {
                    userDefaultLG = { id: parseInt(lg.id), name: lg.name };
                }
            });
            debugLog('User LG access: ' + lgs.length + ' groups, default: ' + JSON.stringify(userDefaultLG), 'info');
        } catch (e) { console.error('Failed to load location groups:', e); }

        try {
            var qbs = JSON.parse(runQuery("SELECT id, name FROM qbclass WHERE activeflag = 1 ORDER BY name"));
            var sel = document.getElementById('paramQBClass');
            qbs.forEach(function(qb) {
                var opt = document.createElement('option');
                opt.value = qb.id;
                opt.textContent = qb.name;
                sel.appendChild(opt);
            });
        } catch (e) { /* QB Class table may not exist */ }

        // Default dates = current fiscal year
        try {
            var fyStartMonth = parseInt(getProperty('BI_FY_START_MONTH', '1')) || 1;
            var now = new Date();
            var fyStartYear = now.getFullYear();
            if ((now.getMonth() + 1) < fyStartMonth) fyStartYear--;
            var startDate = fyStartYear + '-' + String(fyStartMonth).padStart(2, '0') + '-01';
            var fyEndYear = fyStartYear + 1;
            var fyEndMonth = fyStartMonth - 1;
            if (fyEndMonth === 0) { fyEndMonth = 12; fyEndYear--; }
            var lastDay = new Date(fyEndYear, fyEndMonth, 0).getDate();
            var endDate = fyEndYear + '-' + String(fyEndMonth).padStart(2, '0') + '-' + String(lastDay).padStart(2, '0');
            document.getElementById('paramStartDate').value = startDate;
            document.getElementById('paramEndDate').value = endDate;
        } catch (e) {
            var year = new Date().getFullYear();
            document.getElementById('paramStartDate').value = year + '-01-01';
            document.getElementById('paramEndDate').value = year + '-12-31';
        }
    }

    // ============================================
    // Load Auto PO Data
    // ============================================
    function loadAutoPoData() {
        var vendorVal = document.getElementById('paramVendor').value;
        var locationGroupId = parseInt(document.getElementById('paramLocationGroup').value);
        var qbClassId = parseInt(document.getElementById('paramQBClass').value);
        var showVendorPN = document.getElementById('paramShowVendorPN').checked;
        var includeNoROP = document.getElementById('paramIncludeNoROP').checked;
        var includeMfg = document.getElementById('paramIncludeMfg').checked;
        var defaultVendorOnly = document.getElementById('paramDefaultVendorOnly').checked;
        var startDate = document.getElementById('paramStartDate').value;
        var endDate = document.getElementById('paramEndDate').value;

        if (!startDate || !endDate) {
            showStatus('Please select both start and end dates.', 'warning');
            return;
        }

        allResults = [];
        selectionState = {};
        qtyOverrides = {};
        defaultVendorMap = {};
        vendorCollapsed = {};

        showStatus('Loading Auto PO data...', 'info');
        document.getElementById('btnLoadData').disabled = true;

        try {
            debugLog('Loading Auto PO data â€” Vendor: ' + vendorVal + ', LG: ' + locationGroupId + ', QB: ' + qbClassId, 'info');

            // Build vendorparts lookup for lastcost, leadtime, vendorPartNumber, and real FB part number
            vendorPartsLookup = {};
            try {
                var vpRows = JSON.parse(runQuery(
                    "SELECT vp.partid, vp.vendorid, vp.lastcost, vp.leadtime, vp.vendorPartNumber, vp.qtyMin, p.num AS partnum " +
                    "FROM vendorparts vp INNER JOIN part p ON p.id = vp.partid"
                ));
                vpRows.forEach(function(r) {
                    var vpKey = r.partid + '_' + r.vendorid;
                    var rawCost = r.lastcost;
                    var parsedCost = 0;
                    if (rawCost !== null && rawCost !== undefined && typeof rawCost !== 'object') {
                        parsedCost = parseFloat(rawCost) || 0;
                    }
                    vendorPartsLookup[vpKey] = {
                        lastcost: parsedCost,
                        leadtime: parseInt(r.leadtime) || 0,
                        vendorpartnumber: r.vendorPartNumber || r.vendorpartnumber || '',
                        fbpartnum: r.partnum || r.PARTNUM || '',
                        qtymin: parseFloat(r.qtyMin || r.qtymin) || 0
                    };
                });
                debugLog('Loaded vendorparts lookup: ' + vpRows.length + ' records', 'success');
                // Debug: log a sample record to check field types
                var sampleKeys = Object.keys(vendorPartsLookup);
                if (sampleKeys.length > 0) {
                    var s = vendorPartsLookup[sampleKeys[0]];
                    debugLog('Sample vendorpart: key=' + sampleKeys[0] + ' fbpartnum=' + s.fbpartnum + ' vendorpn=' + s.vendorpartnumber + ' lastcost=' + s.lastcost + ' (' + typeof s.lastcost + ') leadtime=' + s.leadtime, 'info');
                }
            } catch(e) {
                console.error('Failed to load vendorparts lookup:', e);
                debugLog('Failed to load vendorparts lookup: ' + e.message, 'error');
            }

            // Always build default vendor map (needed for smart auto-selection)
            try {
                var dvRows = JSON.parse(runQuery("SELECT partid, vendorid FROM vendorparts WHERE defaultflag = 1"));
                dvRows.forEach(function(r) { defaultVendorMap[r.partid] = r.vendorid; });
                debugLog('Default vendor map: ' + dvRows.length + ' entries', 'info');
            } catch(e) {
                console.error('Failed to load default vendor map:', e);
                debugLog('Failed to load default vendor map: ' + e.message, 'error');
            }

            // Check system property: UseMinQtyAutoGenPOs
            // When true, PO line item quantities must be at least vendorparts.qtyMin
            var useMinQtyProp = getProperty('UseMinQtyAutoGenPOs', 'false');
            var useMinQty = (useMinQtyProp === 'true' || useMinQtyProp === '1');
            debugLog('UseMinQtyAutoGenPOs: ' + useMinQtyProp + ' â†’ enforcing=' + useMinQty, 'info');

            var vendorIds = [];
            if (vendorVal === 'all') {
                var vResult = JSON.parse(runQuery("SELECT DISTINCT v.id FROM vendor v INNER JOIN vendorparts vp ON v.id = vp.vendorid WHERE v.activeflag = 1 ORDER BY v.id"));
                vendorIds = vResult.map(function(v) { return v.id; });
                debugLog('Processing all vendors: ' + vendorIds.length + ' found', 'info');
            } else {
                vendorIds = [parseInt(vendorVal)];
                debugLog('Processing single vendor ID: ' + vendorVal, 'info');
            }

            var totalParts = 0;
            var vendorsWithData = 0;

            vendorIds.forEach(function(vid) {
                try {
                    var resultJson = getAutoPo(vid, locationGroupId, qbClassId, showVendorPN, includeNoROP, includeMfg, startDate, endDate);
                    var items = JSON.parse(resultJson);

                    if (items && items.length > 0) {
                        var addedForVendor = 0;
                        items.forEach(function(item) {
                            // Skip items without valid part_id or part_num
                            if (!item.part_id || !item.part_num) return;

                            // Default vendor filter: skip if this vendor is not the default for this part
                            if (defaultVendorOnly && defaultVendorMap[item.part_id] && defaultVendorMap[item.part_id] !== item.vendor_id) return;

                            // Merge vendorparts data (lastcost, leadtime, vendorPartNumber, FB part number)
                            var vpKey = item.part_id + '_' + item.vendor_id;
                            var vpData = vendorPartsLookup[vpKey];
                            if (vpData) {
                                item.last_cost = vpData.lastcost;
                                item.lead_time = vpData.leadtime;
                                item._vendorPartNum = vpData.vendorpartnumber;
                                item._fbPartNum = vpData.fbpartnum;
                            } else {
                                // Force numeric even if getAutoPo returned an object
                                item.last_cost = safeCost(item.last_cost);
                                item.lead_time = parseInt(item.lead_time) || 0;
                                item._vendorPartNum = '';
                                item._fbPartNum = '';
                            }

                            // If we couldn't get FB part number from vendorparts, try to extract from getAutoPo's part_num
                            if (!item._fbPartNum) {
                                item._fbPartNum = (item.part_num || '');
                            }

                            // Debug: log all keys on first item per vendor to see full engine output
                            if (addedForVendor === 0) {
                                debugLog('Sample item for vendor ' + vid + ': part_num=' + item.part_num + ' _fbPartNum=' + item._fbPartNum + ' _vendorPartNum=' + item._vendorPartNum + ' last_cost=' + item.last_cost + ' (' + typeof item.last_cost + ')', 'info');
                                try {
                                    debugLog('getAutoPo raw keys [' + vid + '/' + item.part_num + ']: ' + Object.keys(item).join(', '), 'info');
                                    debugLog('getAutoPo raw JSON [' + vid + '/' + item.part_num + ']: ' + JSON.stringify(item), 'info');
                                } catch(e) {}
                            }

                            // Log all inventory values returned by getAutoPo engine
                            debugLog('getAutoPo item [' + vid + '/' + item.part_num + ']: ' +
                                'onhand=' + item.qty_on_hand +
                                ' avail=' + item._available +
                                ' allocated=' + item.qty_allocated +
                                ' onorder=' + item.qty_on_order +
                                ' dropship=' + item.qty_on_drop_ship +
                                ' ROP=' + item.reorder_level +
                                ' OUL=' + item.target_level +
                                ' needed=' + item.qty_needed +
                                ' suggested=' + item.qty_suggested, 'info');

                            // Enforce minimum order qty if UseMinQtyAutoGenPOs is enabled
                            if (useMinQty && vpData && vpData.qtymin > 0) {
                                var curSug = parseFloat(item.qty_suggested) || 0;
                                if (curSug > 0 && curSug < vpData.qtymin) {
                                    item.qty_suggested = vpData.qtymin;
                                    debugLog('MinQty enforced: ' + item.part_num + ' qty ' + curSug + ' â†’ ' + vpData.qtymin, 'info');
                                }
                            }

                            // Mark as auto PO sourced
                            item._isAutoPo = true;

                            allResults.push(item);
                            var key = item.vendor_id + '_' + item.part_id;
                            var sugQty = parseFloat(item.qty_suggested) || 0;
                            // Only auto-select if qty suggested > 0 AND this is the default vendor
                            // (or no default vendor is set for this part)
                            var isDefaultVendor = !defaultVendorMap[item.part_id] || defaultVendorMap[item.part_id] == item.vendor_id;
                            selectionState[key] = sugQty > 0 && isDefaultVendor;
                            addedForVendor++;
                        });
                        if (addedForVendor > 0) {
                            totalParts += addedForVendor;
                            vendorsWithData++;
                            debugLog('Vendor ' + vid + ': ' + addedForVendor + ' parts loaded', 'success');
                        }
                    }
                } catch (innerErr) {
                    console.error('getAutoPo failed for vendor ' + vid + ':', innerErr);
                    debugLog('getAutoPo failed for vendor ' + vid + ': ' + innerErr.message, 'error');
                }
            });

            // ------------------------------------------------
            // Post-filter getAutoPo results by date range
            // The engine ignores date params, so we query
            // SO / WO demand within the window ourselves
            // and recalculate shortfall accordingly.
            // ------------------------------------------------
            try {
                var partsToFilter = [];
                allResults.forEach(function(item) {
                    if (item._isAutoPo && (parseFloat(item.qty_needed) || 0) > 0) {
                        if (partsToFilter.indexOf(item.part_id) === -1) {
                            partsToFilter.push(item.part_id);
                        }
                    }
                });

                if (partsToFilter.length > 0) {
                    var partIdList = partsToFilter.join(',');

                    // Helper: safely parse runQuery result (returns null for empty sets)
                    function safeParseQuery(sql) {
                        var raw = runQuery(sql);
                        if (!raw || raw === 'null') return [];
                        var parsed = JSON.parse(raw);
                        return Array.isArray(parsed) ? parsed : [];
                    }

                    // Diagnostic: show what dates exist for SO demand on these parts
                    try {
                        var diagRows = safeParseQuery(
                            "SELECT prod.partid AS part_id, p.num AS part_num, " +
                            "  so.num AS so_num, so.statusid AS so_status, " +
                            "  so.datefirstship AS ship_date, " +
                            "  GREATEST(si.qtytofulfill - si.qtyfulfilled, 0) AS unfulfilled " +
                            "FROM soitem si " +
                            "INNER JOIN product prod ON prod.id = si.productid " +
                            "INNER JOIN part p ON p.id = prod.partid " +
                            "INNER JOIN so ON so.id = si.soid " +
                            "WHERE prod.partid IN (" + partIdList + ") " +
                            "  AND so.statusid >= 20 AND so.statusid < 60 " +
                            "  AND si.typeid = 10 " +
                            "  AND GREATEST(si.qtytofulfill - si.qtyfulfilled, 0) > 0 " +
                            "ORDER BY prod.partid, so.datefirstship"
                        );
                        debugLog('=== SO DEMAND DATES (all open SOs for these parts) ===', 'info');
                        diagRows.forEach(function(r) {
                            debugLog('  ' + r.part_num + ': SO#' + r.so_num +
                                ' ship=' + (r.ship_date || 'NULL') +
                                ' unfulfilled=' + r.unfulfilled +
                                ' status=' + r.so_status, 'info');
                        });
                        if (diagRows.length === 0) {
                            debugLog('  (no open SO demand found for any of these parts)', 'info');
                        }
                    } catch (e) {
                        debugLog('SO diagnostic query failed: ' + e.message, 'warning');
                    }

                    // Diagnostic: show what dates exist for WO/MO demand on these parts
                    if (includeMfg) {
                        try {
                            var woDiagRows = safeParseQuery(
                                "SELECT wi.partid AS part_id, p.num AS part_num, " +
                                "  mo.num AS mo_num, mo.statusid AS mo_status, " +
                                "  wo.num AS wo_num, wo.statusid AS wo_status, " +
                                "  wo.datescheduled AS wo_date, mi.datescheduled AS mo_date, " +
                                "  GREATEST(wi.qtytofulfill - wi.qtyfulfilled, 0) AS unfulfilled " +
                                "FROM woitem wi " +
                                "INNER JOIN part p ON p.id = wi.partid " +
                                "INNER JOIN wo ON wo.id = wi.woid " +
                                "LEFT JOIN moitem mi ON wo.moitemid = mi.id " +
                                "LEFT JOIN mo ON mo.id = mi.moid " +
                                "WHERE wi.partid IN (" + partIdList + ") " +
                                "  AND wi.typeid = 20 " +
                                "  AND GREATEST(wi.qtytofulfill - wi.qtyfulfilled, 0) > 0 " +
                                "ORDER BY wi.partid, wo.datescheduled"
                            );
                            debugLog('=== WO/MO DEMAND DATES (all open WOs consuming these parts) ===', 'info');
                            woDiagRows.forEach(function(r) {
                                debugLog('  ' + r.part_num + ': MO#' + (r.mo_num || '?') +
                                    '/WO#' + (r.wo_num || '?') +
                                    ' wo_date=' + (r.wo_date || 'NULL') +
                                    ' mo_date=' + (r.mo_date || 'NULL') +
                                    ' unfulfilled=' + r.unfulfilled +
                                    ' mo_status=' + r.mo_status +
                                    ' wo_status=' + r.wo_status, 'info');
                            });
                            if (woDiagRows.length === 0) {
                                debugLog('  (no open WO demand found for any of these parts)', 'info');
                            }
                        } catch (e) {
                            debugLog('WO diagnostic query failed: ' + e.message, 'warning');
                        }
                    }

                    // SO demand: unfulfilled qty on open SOs within date range
                    // Note: SoItem.ProductId â†’ Product.Id, Product.PartId â†’ Part.Id
                    var soDemandMap = {};
                    try {
                        var soRows = safeParseQuery(
                            "SELECT prod.partid AS part_id, " +
                            "  COALESCE(SUM(GREATEST(si.qtytofulfill - si.qtyfulfilled, 0)), 0) AS dated_demand " +
                            "FROM soitem si " +
                            "INNER JOIN product prod ON prod.id = si.productid " +
                            "INNER JOIN so ON so.id = si.soid " +
                            "WHERE prod.partid IN (" + partIdList + ") " +
                            "  AND so.statusid >= 20 AND so.statusid < 60 " +
                            "  AND si.typeid = 10 " +
                            "  AND so.datefirstship >= '" + startDate + "' " +
                            "  AND so.datefirstship <= '" + endDate + " 23:59:59' " +
                            "GROUP BY prod.partid"
                        );
                        soRows.forEach(function(r) {
                            soDemandMap[r.part_id] = parseFloat(r.dated_demand) || 0;
                        });
                        debugLog('Date-filtered SO demand for ' + partsToFilter.length + ' parts: ' + JSON.stringify(soDemandMap), 'info');
                    } catch (e) {
                        debugLog('SO date-filter query failed: ' + e.message, 'warning');
                    }

                    // TO demand: allocated qty on open Transfer Orders within date range
                    // TO allocations go through the Pick system: PickItem â†’ XoItem â†’ Xo
                    var toDemandMap = {};
                    try {
                        // Diagnostic: show TO allocations via picks
                        var toDiagRows = safeParseQuery(
                            "SELECT pi.partid AS part_id, p.num AS part_num, " +
                            "  xo.num AS xo_num, xo.statusid AS xo_status, " +
                            "  COALESCE(xo.datefirstship, xo.datescheduled) AS ship_date, " +
                            "  pi.qty AS pick_qty, pi.statusid AS pick_status " +
                            "FROM pickitem pi " +
                            "INNER JOIN part p ON p.id = pi.partid " +
                            "INNER JOIN xoitem xi ON xi.id = pi.xoitemid " +
                            "INNER JOIN xo ON xo.id = xi.xoid " +
                            "WHERE pi.partid IN (" + partIdList + ") " +
                            "  AND pi.ordertypeid = 40 " +
                            "  AND pi.statusid < 40 " +
                            "ORDER BY pi.partid, COALESCE(xo.datefirstship, xo.datescheduled)"
                        );
                        debugLog('=== TO DEMAND DATES (all open TO picks for these parts) ===', 'info');
                        toDiagRows.forEach(function(r) {
                            debugLog('  ' + r.part_num + ': TO#' + r.xo_num +
                                ' ship=' + (r.ship_date || 'NULL') +
                                ' pickQty=' + r.pick_qty +
                                ' pickStatus=' + r.pick_status +
                                ' xoStatus=' + r.xo_status, 'info');
                        });
                        if (toDiagRows.length === 0) {
                            debugLog('  (no open TO picks found for any of these parts)', 'info');
                        }

                        // Date-filtered TO demand via picks
                        var toRows = safeParseQuery(
                            "SELECT pi.partid AS part_id, " +
                            "  COALESCE(SUM(pi.qty), 0) AS dated_demand " +
                            "FROM pickitem pi " +
                            "INNER JOIN xoitem xi ON xi.id = pi.xoitemid " +
                            "INNER JOIN xo ON xo.id = xi.xoid " +
                            "WHERE pi.partid IN (" + partIdList + ") " +
                            "  AND pi.ordertypeid = 40 " +
                            "  AND pi.statusid < 40 " +
                            "  AND COALESCE(xo.datefirstship, xo.datescheduled) >= '" + startDate + "' " +
                            "  AND COALESCE(xo.datefirstship, xo.datescheduled) <= '" + endDate + " 23:59:59' " +
                            "GROUP BY pi.partid"
                        );
                        toRows.forEach(function(r) {
                            toDemandMap[r.part_id] = parseFloat(r.dated_demand) || 0;
                        });
                        debugLog('Date-filtered TO demand for ' + partsToFilter.length + ' parts: ' + JSON.stringify(toDemandMap), 'info');
                    } catch (e) {
                        debugLog('TO date-filter query failed: ' + e.message, 'warning');
                    }

                    // WO/MO demand: raw material consumption on open WOs within date range
                    var woDemandMap = {};
                    if (includeMfg) {
                        try {
                            var woRows = safeParseQuery(
                                "SELECT wi.partid AS part_id, " +
                                "  COALESCE(SUM(GREATEST(wi.qtytofulfill - wi.qtyfulfilled, 0)), 0) AS dated_demand " +
                                "FROM woitem wi " +
                                "INNER JOIN wo ON wo.id = wi.woid " +
                                "LEFT JOIN moitem mi ON wo.moitemid = mi.id " +
                                "LEFT JOIN mo ON mo.id = mi.moid " +
                                "WHERE wi.partid IN (" + partIdList + ") " +
                                "  AND wi.typeid = 20 " +
                                "  AND COALESCE(wo.datescheduled, mi.datescheduled) >= '" + startDate + "' " +
                                "  AND COALESCE(wo.datescheduled, mi.datescheduled) <= '" + endDate + " 23:59:59' " +
                                "GROUP BY wi.partid"
                            );
                            woRows.forEach(function(r) {
                                woDemandMap[r.part_id] = parseFloat(r.dated_demand) || 0;
                            });
                            debugLog('Date-filtered WO demand for ' + partsToFilter.length + ' parts: ' + JSON.stringify(woDemandMap), 'info');
                        } catch (e) {
                            debugLog('WO date-filter query failed: ' + e.message, 'warning');
                        }
                    }

                    // Recalculate shortfall using date-filtered demand
                    allResults.forEach(function(item) {
                        if (!item._isAutoPo || (parseFloat(item.qty_needed) || 0) <= 0) return;

                        var soDemand = soDemandMap[item.part_id] || 0;
                        var toDemand = toDemandMap[item.part_id] || 0;
                        var woDemand = woDemandMap[item.part_id] || 0;
                        var datedAlloc = soDemand + toDemand + woDemand;
                        var onhand = parseFloat(item.qty_on_hand) || 0;
                        var onorder = parseFloat(item.qty_on_order) || 0;
                        var origNeeded = parseFloat(item.qty_needed) || 0;
                        var newNeeded = Math.max(0, datedAlloc - onhand - onorder);

                        debugLog('Date filter [' + item.part_num + ' v' + item.vendor_id + ']: ' +
                            'SO=' + soDemand + ' TO=' + toDemand + ' WO=' + woDemand +
                            ' datedAlloc=' + datedAlloc +
                            ' onhand=' + onhand + ' onorder=' + onorder +
                            ' â†’ needed: ' + origNeeded + ' â†’ ' + newNeeded, 'info');

                        item.qty_needed = newNeeded;
                        item.qty_suggested = newNeeded;

                        if (newNeeded === 0) {
                            var key = item.vendor_id + '_' + item.part_id;
                            selectionState[key] = false;
                        }
                    });
                }
            } catch (e) {
                debugLog('Date post-filter failed: ' + e.message, 'error');
            }

            // ------------------------------------------------
            // Load standard inventory data for parts NOT already
            // returned by Auto PO â€” allows users to add items
            // to POs that weren't auto-suggested
            // ------------------------------------------------
            try {
                var autoPoPartIds = {};
                allResults.forEach(function(item) { autoPoPartIds[item.part_id] = true; });

                var stdQuery =
                    "SELECT " +
                    "  p.id as part_id, p.num as part_num, p.description as part_description, " +
                    "  COALESCE(uom.code, '') as part_uom_code, p.uomid as part_uom_id, " +
                    "  vp.vendorid as vendor_id, COALESCE(v.name, '') as vendor_name, " +
                    "  COALESCE(pr.reorderpoint, 0) as reorder_level, " +
                    "  COALESCE(pr.orderuptolevel, 0) as target_level, " +
                    "  COALESCE(t.qtyonhand, 0) as qty_on_hand, " +
                    "  COALESCE(t.qtyonorder, 0) as qty_on_order, " +
                    "  COALESCE(t.qtyallocated, 0) as qty_allocated, " +
                    "  COALESCE(t.qtydropship, 0) as qty_on_drop_ship, " +
                    "  COALESCE(t.qtyavailable, 0) as _available " +
                    "FROM part p " +
                    "  INNER JOIN uom ON p.uomid = uom.id " +
                    "  LEFT JOIN partreorder pr ON p.id = pr.partid AND pr.locationgroupid IS NULL " +
                    "  INNER JOIN vendorparts vp ON p.id = vp.partid AND vp.defaultflag = 1 " +
                    "  INNER JOIN vendor v ON vp.vendorid = v.id AND v.activeflag = 1 " +
                    "  LEFT JOIN (" +
                    "    SELECT partid, " +
                    "      COALESCE(SUM(qtyonhand), 0) as qtyonhand, " +
                    "      COALESCE(SUM(qtyallocated), 0) as qtyallocated, " +
                    "      COALESCE(SUM(qtyonorder), 0) as qtyonorder, " +
                    "      COALESCE(SUM(qtydropship), 0) as qtydropship, " +
                    "      IF(COALESCE(SUM(qtyonhand) - SUM(qtyallocated) - SUM(qtynotavailable) + SUM(qtydropship), 0) < 0, 0, " +
                    "         COALESCE(SUM(qtyonhand) - SUM(qtyallocated) - SUM(qtynotavailable) + SUM(qtydropship), 0)) as qtyavailable " +
                    "    FROM qtyinventorytotals GROUP BY partid" +
                    "  ) as t ON p.id = t.partid " +
                    "WHERE p.typeid = 10 AND vp.vendorid IS NOT NULL";

                // Respect vendor filter
                if (vendorVal !== 'all') {
                    stdQuery += " AND vp.vendorid = " + parseInt(vendorVal);
                }

                // Respect include No ROP/OUL setting
                if (!includeNoROP) {
                    stdQuery += " AND pr.reorderpoint IS NOT NULL AND pr.reorderpoint > 0 AND pr.orderuptolevel IS NOT NULL AND pr.orderuptolevel > 0";
                }

                var stdRows = JSON.parse(runQuery(stdQuery));
                var stdAdded = 0;

                stdRows.forEach(function(row) {
                    // Skip parts already covered by Auto PO data
                    if (autoPoPartIds[row.part_id]) return;

                    // Merge vendorparts data (cost, leadtime, vendor PN, FB part number)
                    var vpKey = row.part_id + '_' + row.vendor_id;
                    var vpData = vendorPartsLookup[vpKey];
                    if (vpData) {
                        row.last_cost = vpData.lastcost;
                        row.lead_time = vpData.leadtime;
                        row._vendorPartNum = vpData.vendorpartnumber;
                        row._fbPartNum = vpData.fbpartnum;
                    } else {
                        row.last_cost = 0;
                        row.lead_time = 0;
                        row._vendorPartNum = '';
                        row._fbPartNum = row.part_num || '';
                    }
                    if (!row._fbPartNum) row._fbPartNum = row.part_num || '';

                    // Standard rows have no auto PO suggestion
                    row.qty_needed = 0;
                    row.qty_suggested = 0;
                    row.vendor_uom_code = row.part_uom_code;
                    row.vendor_uom_id = row.part_uom_id;
                    row._isStandardRow = true;
                    row._available = parseFloat(row._available) || 0;

                    allResults.push(row);
                    var key = row.vendor_id + '_' + row.part_id;
                    selectionState[key] = false; // Standard rows start unchecked
                    stdAdded++;
                });

                debugLog('Standard inventory: ' + stdAdded + ' additional parts added (from ' + stdRows.length + ' queried)', 'success');
                totalParts += stdAdded;
            } catch(stdErr) {
                console.error('Standard inventory query failed:', stdErr);
                debugLog('Standard inventory query failed: ' + stdErr.message, 'error');
            }

            // ------------------------------------------------
            // Compute status (state + capacity %) for all rows
            // ------------------------------------------------
            allResults.forEach(function(item) {
                computePartStatus(item);
            });

            document.getElementById('btnLoadData').disabled = false;

            if (allResults.length === 0) {
                showStatus('No inventory data found for the selected parameters.', 'warning');
                debugLog('No inventory data found', 'warning');
                document.getElementById('tableContainer').style.display = 'none';
                document.getElementById('columnFilters').style.display = 'none';
                document.getElementById('poSummaryBar').style.display = 'none';
                document.getElementById('emptyState').style.display = 'block';
                return;
            }

            showStatus('Loaded ' + totalParts + ' parts from ' + vendorsWithData + ' vendor(s).', 'success');
            debugLog('Total loaded: ' + totalParts + ' parts from ' + vendorsWithData + ' vendor(s)', 'success');
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('columnFilters').style.display = 'block';
            document.getElementById('poSummaryBar').style.display = 'flex';
            document.getElementById('tableContainer').style.display = 'block';

            buildTable();
            updateVendorHeaderCounts();

        } catch (e) {
            console.error('loadAutoPoData error:', e);
            showStatus('Error loading data: ' + e.message, 'error');
            document.getElementById('btnLoadData').disabled = false;
        }
    }

    // ============================================
    // Status
    // ============================================
    function showStatus(message, type) {
        var container = document.getElementById('toastContainer');
        var toast = document.createElement('div');
        toast.className = 'toast ' + (type || 'info');
        toast.textContent = message;
        container.appendChild(toast);

        // Auto-dismiss after 3 seconds
        setTimeout(function() {
            toast.classList.add('fade-out');
            setTimeout(function() {
                if (toast.parentNode) toast.parentNode.removeChild(toast);
            }, 300);
        }, 3000);
    }

    // ============================================
    // Column Filters
    // ============================================
    function applyColumnFilters() {
        if (dataTable) redrawTable();
    }

    function clearColumnFilters() {
        document.getElementById('filterPartNum').value = '';
        document.getElementById('filterDescription').value = '';
        document.getElementById('filterVendor').value = '';
        if (dataTable) redrawTable();
    }

    function getFilteredData() {
        var fp = (document.getElementById('filterPartNum').value || '').toLowerCase();
        var fd = (document.getElementById('filterDescription').value || '').toLowerCase();
        var fv = (document.getElementById('filterVendor').value || '').toLowerCase();

        return allResults.filter(function(row) {
            if (fp && (row.part_num || '').toLowerCase().indexOf(fp) === -1) return false;
            if (fd && (row.part_description || '').toLowerCase().indexOf(fd) === -1) return false;
            if (fv && (row.vendor_name || '').toLowerCase().indexOf(fv) === -1) return false;
            return true;
        });
    }

    // ============================================
    // Calculate vendor PO value for selected items
    // ============================================
    function calcVendorPoValue(vendorId) {
        var total = 0;
        allResults.forEach(function(item) {
            if (item.vendor_id !== vendorId) return;
            var key = item.vendor_id + '_' + item.part_id;
            if (!selectionState[key]) return;
            var qty = qtyOverrides[key] !== undefined ? qtyOverrides[key] : (parseFloat(item.qty_suggested) || 0);
            var cost = safeCost(item.last_cost);
            total += qty * cost;
        });
        return total;
    }

    // ============================================
    // Build/Redraw DataTable
    // ============================================
    function buildTable() {
        if (dataTable) {
            dataTable.destroy(true);
            dataTable = null;
            // Recreate the table element after full destroy (scrollY wraps it in extra divs)
            var container = document.getElementById('tableContainer');
            var wrapper = container.querySelector('.dataTables_wrapper');
            if (wrapper) wrapper.parentNode.removeChild(wrapper);
            if (!document.getElementById('report-table')) {
                var tbl = document.createElement('table');
                tbl.id = 'report-table';
                tbl.className = 'display';
                tbl.style.width = '100%';
                container.appendChild(tbl);
            }
        }

        var filteredData = getFilteredData();
        var groupedData = buildGroupedData(filteredData);

        dataTable = $('#report-table').DataTable({
            dom: 'Brt',
            data: groupedData,
            ordering: false,
            autoWidth: false,
            paging: false,
            scrollY: 'calc(100vh - 340px)',
            scrollCollapse: true,
            deferRender: true,
            buttons: [
                { extend: 'csv', className: 'dt-button-hidden', exportOptions: {
                    columns: function(idx) { return idx > 0; },
                    format: { body: function(data) { return $('<div>').html(data).text(); } }
                }},
                { extend: 'print', className: 'dt-button-hidden' }
            ],
            columns: [
                // Col 0: Checkbox / Vendor header
                {
                    title: '<input type="checkbox" id="selectAllGlobal" class="row-checkbox" onclick="toggleSelectAll(this.checked)" title="Select/Deselect All">',
                    data: null,
                    defaultContent: '',
                    width: '3%',
                    className: 'dt-center',
                    orderable: false,
                    render: function(data, type, row) {
                        if (row._isHeader) return '';
                        if (type !== 'display') return '';
                        var key = row.vendor_id + '_' + row.part_id;
                        var checked = selectionState[key] ? 'checked' : '';
                        return '<input type="checkbox" class="row-checkbox" data-key="' + key + '" ' + checked + ' onclick="toggleRowSelection(\'' + key + '\', this.checked)">';
                    },
                    createdCell: function(td, cellData, rowData) {
                        if (!rowData._isHeader) return;
                        var $td = $(td);
                        $td.attr('colspan', 16);
                        $td.parent().addClass('vendor-group-header');
                        $td.nextAll().remove();

                        var vid = rowData._vendorId;
                        var vname = rowData._vendorName || '';
                        var partCount = rowData._partCount || 0;
                        var selectedCount = rowData._selectedCount || 0;
                        var poValue = calcVendorPoValue(vid);

                        var isCollapsed = vendorCollapsed[vid];
                        var expandClass = isCollapsed ? '' : ' expanded';
                        var expandBtn = '<span class="vendor-expand-toggle' + expandClass + '" data-vendor-id="' + vid + '" onclick="toggleVendorCollapse(' + vid + ', this)" title="Expand/Collapse"><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></span>';
                        var vendorIcon = '<svg class="w-4 h-4 inline-block mr-1 align-text-bottom" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: #2d9cdb;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>';
                        var vendorLink = vname ? '<a href="#" class="item-link" onclick="openModule(\'Vendor\', \'' + vname.replace(/'/g, "\\'") + '\'); return false;">' + vname + '</a>' : '';
                        var countBadge = '<span class="vendor-count-badge" data-vendor-id="' + vid + '" style="font-size:11px; font-weight:400; color:#64748b; margin-left:8px;">(' + selectedCount + '/' + partCount + ' selected)</span>';
                        var selectAllChecked = (selectedCount === partCount && partCount > 0) ? 'checked' : '';
                        var selectAllCb = '<input type="checkbox" class="vendor-select-all" data-vendor-id="' + vid + '" ' + selectAllChecked + ' onclick="toggleVendorSelectAll(' + vid + ', this.checked)" title="Select/Deselect all for this vendor">';
                        var poValueHtml = '<span class="vendor-po-value" data-vendor-id="' + vid + '">PO Value: ' + formatCurrencyVal(poValue) + '</span>';

                        // If a PO was already raised this session, show link instead of Create button
                        var existingPo = (window._vendorPOs && window._vendorPOs[vid]) ? window._vendorPOs[vid] : null;
                        var actionHtml;
                        if (existingPo) {
                            actionHtml = '<a href="#" class="po-raised-link" onclick="openModule(\'Purchase Order\', \'' + existingPo + '\'); return false;" ' +
                                'style="display:inline-flex; align-items:center; gap:4px; font-size:12px; padding:4px 10px; border-radius:6px; ' +
                                'background:#dcfce7; color:#166534; font-weight:600; text-decoration:none; border:1px solid #bbf7d0;">' +
                                '<svg style="width:14px;height:14px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>' +
                                'PO# ' + existingPo + '</a>';
                        } else {
                            actionHtml = '<button class="btn-create-po" onclick="openPoModal(' + vid + ')" title="Create PO for ' + vname.replace(/"/g, '&quot;') + '"><svg class="w-3.5 h-3.5 inline-block mr-1 align-text-bottom" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>Create PO</button>';
                        }

                        $td.html(
                            '<div style="display:flex; align-items:center; justify-content:space-between;">' +
                                '<div>' + expandBtn + selectAllCb + vendorIcon + vendorLink + countBadge + '</div>' +
                                '<div style="display:flex; align-items:center;">' + poValueHtml + actionHtml + '</div>' +
                            '</div>'
                        );
                    }
                },
                // Col 1: Status - Inventory status with capacity bar
                {
                    title: '<span title="Inventory status with capacity percentage">Status</span>',
                    data: '_capacitypct',
                    defaultContent: '',
                    width: '7%',
                    className: 'dt-center group-status',
                    orderable: false,
                    render: function(data, type, row) {
                        if (row._isHeader) return '';
                        if (type !== 'display') {
                            if (row._state === 'norop') return 999999;
                            return data;
                        }
                        var text;
                        if (row._state === 'norop') {
                            text = 'No ROP/OUL';
                        } else if (row._state === 'fb10' || data > 100) {
                            text = 'Overstocked';
                        } else {
                            text = data + '%';
                        }
                        return '<strong style="font-size:11px;">' + text + '</strong>';
                    },
                    createdCell: function(td, cellData, rowData) {
                        if (rowData._isHeader) return;

                        var state = rowData._state;
                        var pct = rowData._capacitypct;
                        var bgColor, lightColor;

                        if (state === 'norop') {
                            td.style.setProperty('background', '#e2e8f0', 'important');
                            td.style.setProperty('color', '#64748b', 'important');
                            td.style.setProperty('font-weight', 'normal', 'important');
                            return;
                        } else if (state === 'fb10') {
                            bgColor = '#1976D2'; lightColor = '#90CAF9';
                        } else if (state === 'fb20') {
                            bgColor = '#2E7D32'; lightColor = '#A5D6A7';
                        } else if (state === 'fb30') {
                            bgColor = '#F57C00'; lightColor = '#FFCC80';
                        } else if (state === 'fb40') {
                            bgColor = '#C62828'; lightColor = '#EF9A9A';
                        } else {
                            td.style.setProperty('background', '#e2e8f0', 'important');
                            td.style.setProperty('color', '#64748b', 'important');
                            return;
                        }

                        var gradient;
                        if (state === 'fb10' || pct > 100) {
                            gradient = bgColor;
                        } else if (pct < 0) {
                            var fillFromRight = Math.min(100, Math.abs(pct));
                            gradient = 'linear-gradient(to left, ' + bgColor + ' ' + fillFromRight + '%, ' + lightColor + ' ' + fillFromRight + '%)';
                        } else {
                            var fillPercent = Math.max(0, Math.min(100, pct));
                            gradient = 'linear-gradient(to right, ' + bgColor + ' ' + fillPercent + '%, ' + lightColor + ' ' + fillPercent + '%)';
                        }

                        td.style.setProperty('background', gradient, 'important');
                        td.style.setProperty('color', '#FFFFFF', 'important');
                        td.style.setProperty('text-shadow', '1px 1px 2px rgba(0,0,0,0.8)', 'important');
                    }
                },
                // Col 2: Part Number - FB part number with vendor part number in brackets
                {
                    title: '<span title="Part number">Part #</span>',
                    data: 'part_num',
                    defaultContent: '',
                    width: '9%',
                    className: 'dt-left group-part-info',
                    render: function(data, type, row) {
                        if (row._isHeader) return '';
                        if (type === 'display') {
                            // _fbPartNum = real Fishbowl part number from part.num
                            // _vendorPartNum = vendor's part number from vendorparts.vendorPartNumber
                            var fbPN = row._fbPartNum || '';
                            var vendorPN = row._vendorPartNum || '';
                            var showVPN = document.getElementById('paramShowVendorPN').checked;
                            var displayText = fbPN;
                            if (showVPN && vendorPN && vendorPN !== fbPN) {
                                displayText = fbPN + ' <span style="color:#64748b; font-weight:400;">(' + vendorPN + ')</span>';
                            }
                            var escaped = fbPN.replace(/'/g, "\\'");
                            var tooltipText = fbPN + (vendorPN ? ' | Vendor PN: ' + vendorPN : '');
                            return '<a href="#" class="item-link" onmouseenter="showTooltip(event, \'' + tooltipText.replace(/'/g, "\\'") + '\')" onmouseleave="hideTooltip()" onclick="openModule(\'Part\', \'' + escaped + '\'); return false;"><strong>' + displayText + '</strong></a>';
                        }
                        return row._fbPartNum || data;
                    }
                },
                // Col 3: Description
                {
                    title: '<span title="Part description">Description</span>',
                    data: 'part_description',
                    defaultContent: '',
                    width: '15%',
                    className: 'group-part-info',
                    render: function(data, type, row) {
                        if (row._isHeader) return '';
                        if (type === 'display') {
                            var escaped = (data || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                            return '<span onmouseenter="showTooltip(event, \'' + escaped + '\')" onmouseleave="hideTooltip()">' + (data || '') + '</span>';
                        }
                        return data;
                    }
                },
                // Col 3: UOM
                {
                    title: '<span title="Part unit of measure">UOM</span>',
                    data: 'part_uom_code',
                    defaultContent: '',
                    width: '4%',
                    className: 'dt-center group-part-info',
                    render: function(data, type, row) { return row._isHeader ? '' : (data || ''); }
                },
                // Col 4: On Hand
                {
                    title: '<span title="Total quantity on hand">On Hand</span>',
                    data: 'qty_on_hand',
                    defaultContent: '0',
                    width: '5%',
                    className: 'dt-center group-inventory-key',
                    render: function(data, type, row) { return row._isHeader ? '' : formatNumber(data); }
                },
                // Col 5: Available
                {
                    title: '<span title="Available quantity: On Hand - Allocated - Not Available + Drop Ship">Avail</span>',
                    data: '_available',
                    defaultContent: '0',
                    width: '5%',
                    className: 'dt-center group-inventory-key',
                    render: function(data, type, row) { return row._isHeader ? '' : formatNumber(data); }
                },
                // Col 6: On Order
                {
                    title: '<span title="Quantity on open purchase orders">On Order</span>',
                    data: 'qty_on_order',
                    defaultContent: '0',
                    width: '6%',
                    className: 'dt-center group-inventory-key',
                    render: function(data, type, row) { return row._isHeader ? '' : formatNumber(data); }
                },
                // Col 6: Allocated
                {
                    title: '<span title="Quantity allocated to orders">Allocated</span>',
                    data: 'qty_allocated',
                    defaultContent: '0',
                    width: '6%',
                    className: 'dt-center group-inventory-key',
                    render: function(data, type, row) { return row._isHeader ? '' : formatNumber(data); }
                },
                // Col 7: Drop Ship
                {
                    title: '<span title="Quantity on drop ship">Drop Ship</span>',
                    data: 'qty_on_drop_ship',
                    defaultContent: '0',
                    width: '5%',
                    className: 'dt-center group-allocation',
                    render: function(data, type, row) { return row._isHeader ? '' : formatNumber(data); }
                },
                // Col 8: ROP
                {
                    title: '<span title="Reorder point">ROP</span>',
                    data: 'reorder_level',
                    defaultContent: '',
                    width: '5%',
                    className: 'dt-center group-reorder-params',
                    render: function(data, type, row) {
                        if (row._isHeader) return '';
                        var num = parseFloat(data);
                        return (!num || num === 0) ? '-' : formatNumber(data);
                    }
                },
                // Col 9: Target
                {
                    title: '<span title="Order up to / target level">Target</span>',
                    data: 'target_level',
                    defaultContent: '',
                    width: '5%',
                    className: 'dt-center group-reorder-params',
                    render: function(data, type, row) {
                        if (row._isHeader) return '';
                        var num = parseFloat(data);
                        return (!num || num === 0) ? '-' : formatNumber(data);
                    }
                },
                // Col 10: Qty Needed
                {
                    title: '<span title="Calculated quantity needed">Needed</span>',
                    data: 'qty_needed',
                    defaultContent: '0',
                    width: '6%',
                    className: 'dt-center group-inventory-key',
                    render: function(data, type, row) { return row._isHeader ? '' : formatNumber(data); }
                },
                // Col 11: Suggested Qty (editable)
                {
                    title: '<span title="System-suggested order quantity (editable)">Order Qty</span>',
                    data: 'qty_suggested',
                    defaultContent: '0',
                    width: '8%',
                    className: 'dt-center',
                    render: function(data, type, row) {
                        if (row._isHeader) return '';
                        if (type !== 'display') return data;
                        var key = row.vendor_id + '_' + row.part_id;
                        var currentQty = qtyOverrides[key] !== undefined ? qtyOverrides[key] : (parseFloat(data) || 0);
                        var disabled = selectionState[key] ? '' : 'disabled';
                        return '<input type="number" class="qty-input" data-key="' + key + '" value="' + currentQty + '" min="0" step="1" ' + disabled + ' onchange="updateQtyOverride(\'' + key + '\', this.value)" onclick="event.stopPropagation()">';
                    }
                },
                // Col 12: Last Cost
                {
                    title: '<span title="Last purchase cost">Last Cost</span>',
                    data: 'last_cost',
                    defaultContent: '',
                    width: '6%',
                    className: 'dt-right group-allocation',
                    render: function(data, type, row) {
                        if (row._isHeader) return '';
                        return formatCurrencyVal(safeCost(data));
                    }
                },
                // Col 13: Lead Time
                {
                    title: '<span title="Vendor lead time in days">Lead Time</span>',
                    data: 'lead_time',
                    defaultContent: '',
                    width: '5%',
                    className: 'dt-center group-allocation',
                    render: function(data, type, row) {
                        if (row._isHeader) return '';
                        var num = parseInt(data);
                        return (!num || num === 0) ? '-' : num + 'd';
                    }
                }
            ],
            fixedHeader: true,
            colReorder: false,
            responsive: false,
            stateSave: false,
            drawCallback: function() {
                this.api().columns.adjust();
                applyRowDimming();
            }
        });
    }

    function redrawTable() {
        if (!dataTable) return;
        var filteredData = getFilteredData();
        var groupedData = buildGroupedData(filteredData);
        dataTable.clear();
        dataTable.rows.add(groupedData);
        dataTable.draw(false);
        dataTable.columns.adjust();
    }

    function buildGroupedData(data) {
        var vendorGroups = {};
        var vendorOrder = [];

        data.forEach(function(row) {
            var vid = row.vendor_id;
            if (vid === undefined || vid === null) return; // skip items with no vendor
            if (!vendorGroups[vid]) {
                vendorGroups[vid] = { vendor_name: row.vendor_name || 'Unknown Vendor', vendor_id: vid, parts: [] };
                vendorOrder.push(vid);
            }
            vendorGroups[vid].parts.push(row);
        });

        vendorOrder.sort(function(a, b) {
            var nameA = (vendorGroups[a].vendor_name || '').toLowerCase();
            var nameB = (vendorGroups[b].vendor_name || '').toLowerCase();
            return nameA < nameB ? -1 : nameA > nameB ? 1 : 0;
        });

        var result = [];
        vendorOrder.forEach(function(vid) {
            var group = vendorGroups[vid];
            var selectedCount = 0;
            var hasAutoPoSuggestions = false;
            group.parts.forEach(function(p) {
                if (selectionState[p.vendor_id + '_' + p.part_id]) selectedCount++;
                if ((parseFloat(p.qty_suggested) || 0) > 0) hasAutoPoSuggestions = true;
            });

            // Auto-collapse vendors with no auto PO suggestions (only on first load)
            if (vendorCollapsed[vid] === undefined) {
                vendorCollapsed[vid] = !hasAutoPoSuggestions;
            }

            // Vendor header row - use _isHeader flag and explicit field names to avoid DataTables column mapping issues
            result.push({
                _isHeader: true,
                _vendorId: vid,
                _vendorName: group.vendor_name,
                _partCount: group.parts.length,
                _selectedCount: selectedCount,
                _hasAutoPoSuggestions: hasAutoPoSuggestions,
                // Provide all data fields as null so DataTables doesn't render "undefined"
                _capacitypct: null, _state: null, _available: null,
                part_num: null, part_description: null, part_uom_code: null,
                qty_on_hand: null, qty_on_order: null, qty_allocated: null,
                qty_on_drop_ship: null, reorder_level: null, target_level: null,
                qty_needed: null, qty_suggested: null, last_cost: null, lead_time: null
            });

            group.parts.forEach(function(p) { result.push(p); });
        });

        return result;
    }

    function applyRowDimming() {
        var currentVendorId = null;
        var isCollapsed = false;
        $('#report-table tbody tr').each(function() {
            var $row = $(this);
            if ($row.hasClass('vendor-group-header')) {
                // Extract vendor ID from the expand toggle or select-all checkbox
                var toggle = $row.find('.vendor-expand-toggle');
                if (toggle.length) {
                    currentVendorId = parseInt(toggle.attr('data-vendor-id'));
                    isCollapsed = !!vendorCollapsed[currentVendorId];
                }
                return;
            }
            // Apply collapsed state
            if (isCollapsed) {
                $row.addClass('vendor-collapsed');
            } else {
                $row.removeClass('vendor-collapsed');
            }
            // Apply deselected dimming
            var cb = $row.find('.row-checkbox');
            if (cb.length > 0 && !cb.prop('checked')) {
                $row.addClass('row-deselected');
            } else {
                $row.removeClass('row-deselected');
            }
        });
    }

    function toggleVendorCollapse(vendorId, toggleEl) {
        vendorCollapsed[vendorId] = !vendorCollapsed[vendorId];
        var isCollapsed = vendorCollapsed[vendorId];

        // Toggle chevron rotation
        if (isCollapsed) {
            toggleEl.classList.remove('expanded');
        } else {
            toggleEl.classList.add('expanded');
        }

        // Show/hide part rows for this vendor (walk sibling rows until next vendor header)
        var headerRow = toggleEl.closest('tr');
        var nextRow = headerRow.nextElementSibling;
        while (nextRow && !nextRow.classList.contains('vendor-group-header')) {
            if (isCollapsed) {
                nextRow.classList.add('vendor-collapsed');
            } else {
                nextRow.classList.remove('vendor-collapsed');
            }
            nextRow = nextRow.nextElementSibling;
        }
    }

    // ============================================
    // Selection Logic
    // ============================================
    function toggleRowSelection(key, checked) {
        selectionState[key] = checked;
        var qtyInput = document.querySelector('.qty-input[data-key="' + key + '"]');
        if (qtyInput) qtyInput.disabled = !checked;
        var cb = document.querySelector('.row-checkbox[data-key="' + key + '"]');
        if (cb) {
            var row = cb.closest('tr');
            checked ? row.classList.remove('row-deselected') : row.classList.add('row-deselected');
        }
        updateVendorHeaderCounts();
    }

    function toggleVendorSelectAll(vendorId, checked) {
        allResults.forEach(function(item) {
            if (item.vendor_id === vendorId) {
                selectionState[item.vendor_id + '_' + item.part_id] = checked;
            }
        });
        document.querySelectorAll('.row-checkbox[data-key]').forEach(function(cb) {
            var key = cb.getAttribute('data-key');
            if (key && key.startsWith(vendorId + '_')) {
                cb.checked = checked;
                var row = cb.closest('tr');
                checked ? row.classList.remove('row-deselected') : row.classList.add('row-deselected');
            }
        });
        document.querySelectorAll('.qty-input[data-key]').forEach(function(inp) {
            var key = inp.getAttribute('data-key');
            if (key && key.startsWith(vendorId + '_')) inp.disabled = !checked;
        });
        updateVendorHeaderCounts();
    }

    function toggleSelectAll(checked) {
        Object.keys(selectionState).forEach(function(key) { selectionState[key] = checked; });
        document.querySelectorAll('.row-checkbox[data-key]').forEach(function(cb) {
            cb.checked = checked;
            var row = cb.closest('tr');
            checked ? row.classList.remove('row-deselected') : row.classList.add('row-deselected');
        });
        document.querySelectorAll('.qty-input[data-key]').forEach(function(inp) { inp.disabled = !checked; });
        document.querySelectorAll('.vendor-select-all').forEach(function(cb) { cb.checked = checked; });
        updateVendorHeaderCounts();
    }

    function updateVendorHeaderCounts() {
        var overallTotal = 0;
        var overallSelected = 0;
        var overallParts = allResults.length;

        document.querySelectorAll('.vendor-select-all').forEach(function(cb) {
            var vendorId = parseInt(cb.getAttribute('data-vendor-id'));
            var partCount = 0;
            var selectedCount = 0;
            allResults.forEach(function(item) {
                if (item.vendor_id === vendorId) {
                    partCount++;
                    if (selectionState[item.vendor_id + '_' + item.part_id]) selectedCount++;
                }
            });
            cb.checked = (selectedCount === partCount && partCount > 0);

            var badge = document.querySelector('.vendor-count-badge[data-vendor-id="' + vendorId + '"]');
            if (badge) badge.textContent = '(' + selectedCount + '/' + partCount + ' selected)';

            // Update vendor PO value
            var vendorPoVal = calcVendorPoValue(vendorId);
            var poValueEl = document.querySelector('.vendor-po-value[data-vendor-id="' + vendorId + '"]');
            if (poValueEl) poValueEl.textContent = 'PO Value: ' + formatCurrencyVal(vendorPoVal);

            overallTotal += vendorPoVal;
        });

        // Update overall selected count
        allResults.forEach(function(item) {
            var key = item.vendor_id + '_' + item.part_id;
            if (selectionState[key]) overallSelected++;
        });

        // Update overall PO summary bar
        var totalEl = document.getElementById('overallPoTotal');
        if (totalEl) totalEl.textContent = formatCurrencyVal(overallTotal);
        var countEl = document.getElementById('overallSelectedCount');
        if (countEl) countEl.textContent = overallSelected + ' / ' + overallParts + ' parts';
    }

    // ============================================
    // Qty Override
    // ============================================
    function updateQtyOverride(key, value) {
        var num = parseFloat(value);
        if (isNaN(num) || num < 0) num = 0;
        qtyOverrides[key] = num;
        updateVendorHeaderCounts();
    }

    // ============================================
    // PO Modal
    // ============================================
    function openPoModal(vendorId) {
        var selectedItems = [];
        allResults.forEach(function(item) {
            if (item.vendor_id !== vendorId) return;
            var key = item.vendor_id + '_' + item.part_id;
            if (!selectionState[key]) return;

            var qty = qtyOverrides[key] !== undefined ? qtyOverrides[key] : (parseFloat(item.qty_suggested) || 0);
            if (qty <= 0) return;

            var cost = safeCost(item.last_cost);
            var fbPN = item._fbPartNum || '';
            var vendorPN = item._vendorPartNum || '';
            var showVPN = document.getElementById('paramShowVendorPN').checked;
            var partDisplay = fbPN;
            if (showVPN && vendorPN && vendorPN !== fbPN) {
                partDisplay = fbPN + ' (' + vendorPN + ')';
            }

            debugLog('Modal item: ' + fbPN + ' qty=' + qty + ' cost=' + cost + ' (' + typeof cost + ') lineTotal=' + (qty * cost), 'info');

            selectedItems.push({
                partId: item.part_id,
                partNum: fbPN,
                vendorPartNum: vendorPN,
                partNumDisplay: partDisplay,
                partDescription: item.part_description || '',
                qty: qty,
                uomId: item.vendor_uom_id || item.part_uom_id,
                uomCode: item.vendor_uom_code || item.part_uom_code || 'ea',
                unitCost: cost,
                lineTotal: qty * cost,
                locationGroupId: item.location_group_id || 0
            });
        });

        if (selectedItems.length === 0) {
            showStatus('No parts selected with qty > 0 for this vendor.', 'warning');
            return;
        }

        var vendorName = '';
        allResults.forEach(function(item) {
            if (item.vendor_id === vendorId && !vendorName) vendorName = item.vendor_name;
        });

        // Build modal HTML
        var grandTotal = 0;
        selectedItems.forEach(function(i) { grandTotal += i.lineTotal; });

        var tableRows = '';
        selectedItems.forEach(function(item, idx) {
            tableRows +=
                '<tr>' +
                    '<td><strong>' + item.partNumDisplay + '</strong></td>' +
                    '<td>' + item.partDescription + '</td>' +
                    '<td class="col-right">' + item.uomCode + '</td>' +
                    '<td class="col-right"><input type="number" class="modal-input" id="modal-qty-' + idx + '" value="' + item.qty + '" min="0" step="1" onchange="recalcModalLine(' + idx + ')"></td>' +
                    '<td class="col-right"><input type="number" class="modal-input" id="modal-cost-' + idx + '" value="' + item.unitCost.toFixed(2) + '" min="0" step="0.01" onchange="recalcModalLine(' + idx + ')"></td>' +
                    '<td class="col-right" id="modal-linetotal-' + idx + '">' + formatCurrencyVal(item.lineTotal) + '</td>' +
                '</tr>';
        });

        tableRows +=
            '<tr class="modal-total-row">' +
                '<td colspan="3"></td>' +
                '<td class="col-right"><strong>Total</strong></td>' +
                '<td></td>' +
                '<td class="col-right"><strong id="modal-grand-total">' + formatCurrencyVal(grandTotal) + '</strong></td>' +
            '</tr>';

        var html =
            '<div class="modal-overlay" onclick="closePoModal(event)">' +
                '<div class="modal-content" onclick="event.stopPropagation()">' +
                    '<div class="modal-header">' +
                        '<div>' +
                            '<h2 style="font-size:16px; font-weight:700; color:#1e293b; margin:0;">Create Purchase Order</h2>' +
                            '<p style="font-size:12px; color:#64748b; margin:2px 0 0 0;">Vendor: <strong>' + vendorName + '</strong> &mdash; ' + selectedItems.length + ' line items</p>' +
                        '</div>' +
                        '<button onclick="closePoModal()" style="background:none; border:none; cursor:pointer; padding:4px; color:#94a3b8;">' +
                            '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>' +
                        '</button>' +
                    '</div>' +
                    '<div class="modal-body">' +
                        '<table class="modal-table">' +
                            '<thead><tr>' +
                                '<th>Part #</th>' +
                                '<th>Description</th>' +
                                '<th class="col-right">UOM</th>' +
                                '<th class="col-right">Qty</th>' +
                                '<th class="col-right">Unit Cost</th>' +
                                '<th class="col-right">Line Total</th>' +
                            '</tr></thead>' +
                            '<tbody>' + tableRows + '</tbody>' +
                        '</table>' +
                    '</div>' +
                    '<div class="modal-footer">' +
                        '<div style="display:flex; align-items:center; gap:12px;">' +
                            '<span style="font-size:12px; color:#64748b; white-space:nowrap;">PO Status:</span>' +
                            '<label style="font-size:13px; cursor:pointer; display:flex; align-items:center; gap:4px;">' +
                                '<input type="radio" name="modal-po-status" value="10" checked> Bid Request' +
                            '</label>' +
                            '<label style="font-size:13px; cursor:pointer; display:flex; align-items:center; gap:4px;">' +
                                '<input type="radio" name="modal-po-status" value="20"> Issued' +
                            '</label>' +
                        '</div>' +
                        '<div style="display:flex; gap:8px;">' +
                            '<button onclick="closePoModal()" style="padding:6px 16px; font-size:13px; border:1px solid #cbd5e1; border-radius:6px; background:white; cursor:pointer; font-weight:500;">Cancel</button>' +
                            '<button onclick="submitPoFromModal(' + vendorId + ')" class="btn-create-po" style="padding:6px 16px; font-size:13px; border-radius:6px;">Create PO</button>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
            '</div>';

        document.getElementById('poModal').innerHTML = html;

        // Store modal items for later
        window._modalItems = selectedItems;
        window._modalVendorId = vendorId;
        window._modalVendorName = vendorName;
    }

    function closePoModal(event) {
        if (event && event.target !== event.currentTarget) return;
        document.getElementById('poModal').innerHTML = '';
    }

    function recalcModalLine(idx) {
        var qtyInput = document.getElementById('modal-qty-' + idx);
        var costInput = document.getElementById('modal-cost-' + idx);
        var lineTotalEl = document.getElementById('modal-linetotal-' + idx);
        if (!qtyInput || !costInput || !lineTotalEl) return;

        var qty = parseFloat(qtyInput.value) || 0;
        var cost = parseFloat(costInput.value) || 0;
        var lineTotal = qty * cost;

        lineTotalEl.textContent = formatCurrencyVal(lineTotal);

        // Update item data
        if (window._modalItems && window._modalItems[idx]) {
            window._modalItems[idx].qty = qty;
            window._modalItems[idx].unitCost = cost;
            window._modalItems[idx].lineTotal = lineTotal;
        }

        // Recalculate grand total
        var grandTotal = 0;
        if (window._modalItems) {
            window._modalItems.forEach(function(item) { grandTotal += item.lineTotal; });
        }
        var gtEl = document.getElementById('modal-grand-total');
        if (gtEl) gtEl.textContent = formatCurrencyVal(grandTotal);
    }

    /**
     * Get location group name for PO creation.
     * When a specific LG is selected, returns that name.
     * When "Company Wide" (-1) is selected, returns user's default LG name
     * so the PO is raised against the user's default location group.
     */
    function getLocationGroupName() {
        var sel = document.getElementById('paramLocationGroup');
        if (sel.selectedIndex >= 0) {
            // Company Wide: use user's default LG
            if (sel.value === '-1') return userDefaultLG.name || '';
            return sel.options[sel.selectedIndex].text;
        }
        return '';
    }

    /**
     * Get location group ID for address resolution.
     * Returns the selected LG ID, or the user's default LG ID when Company Wide.
     */
    function getLocationGroupId() {
        var val = parseInt(document.getElementById('paramLocationGroup').value);
        if (val === -1 || isNaN(val)) return userDefaultLG.id || 0;
        return val;
    }

    /**
     * Lookup vendor address from the address table.
     * @param {number} vendorId - Vendor ID to resolve accountid
     * @param {number} addrType - Address type: 30=Remit To, 10=Ship To
     * @param {number} locationGroupId - Current location group ID (0 or -1 = any)
     * @returns {object} Address fields {name, address, city, state, zip, country} or empty strings
     */
    function lookupVendorAddress(vendorId, addrType, locationGroupId) {
        var empty = { name: '', address: '', city: '', state: '', zip: '', country: '' };
        try {
            // Get vendor's accountid
            var vendorRows = JSON.parse(runQuery(
                "SELECT accountid FROM vendor WHERE id = " + parseInt(vendorId)
            ));
            if (!vendorRows || vendorRows.length === 0) return empty;
            var accountId = vendorRows[0].accountid;
            if (!accountId) return empty;

            var lgId = (locationGroupId && locationGroupId > 0) ? parseInt(locationGroupId) : null;

            // Query addresses joining stateconst and countryconst for names.
            // Order by: LG match first, then requested type before Main Office, then default flag.
            var sql =
                "SELECT a.addressName, a.address, a.city, " +
                "COALESCE(sc.name, '') AS stateName, a.zip, COALESCE(cc.name, '') AS countryName, " +
                "a.typeid, a.defaultflag, a.locationgroupid " +
                "FROM address a " +
                "LEFT JOIN stateconst sc ON sc.id = a.stateId " +
                "LEFT JOIN countryconst cc ON cc.id = a.countryId " +
                "WHERE a.accountid = " + parseInt(accountId) +
                " AND a.typeid IN (" + parseInt(addrType) + ", 50)" +
                " ORDER BY " +
                (lgId
                    ? "  CASE WHEN a.locationgroupid = " + lgId + " THEN 0 ELSE 1 END, "
                    : "") +
                "  CASE WHEN a.typeid = " + parseInt(addrType) + " THEN 0 ELSE 1 END, " +
                "  a.defaultflag DESC";

            var rows = JSON.parse(runQuery(sql));
            debugLog('Vendor address rows (type ' + addrType + ' for accountid ' + accountId + ', lgId=' + lgId + '): ' + rows.length + ' candidates', 'info');
            if (!rows || rows.length === 0) return empty;

            // Pick best match: prefer requested type with matching locationgroup, then defaultFlag
            var best = null;

            for (var i = 0; i < rows.length; i++) {
                var r = rows[i];
                var isRequestedType = (parseInt(r.typeid) === addrType);
                // Use == for type-coercing comparison (handles string/number mismatches from DB)
                var isLgMatch = lgId && r.locationgroupid != null && r.locationgroupid != 0 && r.locationgroupid == lgId;
                var isDefault = (r.defaultflag === '1' || r.defaultflag === 1 || r.defaultflag === true);

                // Best: requested type + matching LG â€” always wins
                if (isRequestedType && isLgMatch) { best = r; break; }
                // Next best: requested type + default flag
                if (!best && isRequestedType && isDefault) { best = r; }
                // Next: requested type (any)
                if (!best && isRequestedType) { best = r; }
                // Fallback: Main Office type 50
                if (!best) { best = r; }
            }

            if (!best) return empty;
            debugLog('Vendor address selected: name=' + best.addressName + ' city=' + best.city + ' lg=' + best.locationgroupid, 'info');
            return {
                name: best.addressName || '',
                address: best.address || '',
                city: best.city || '',
                state: best.stateName || '',
                zip: best.zip || '',
                country: best.countryName || ''
            };
        } catch (e) {
            debugLog('Address lookup error (type ' + addrType + '): ' + e.message, 'error');
            return empty;
        }
    }

    /**
     * Lookup the company Ship To address (accountid = 1).
     * ShipTo on a PO = where goods are delivered (our warehouse), not the vendor's address.
     * Same priority cascade as lookupVendorAddress:
     *   1. Ship To (type 10) matching the location group
     *   2. Ship To (type 10) with defaultFlag
     *   3. Ship To (type 10) any
     *   4. Main Office (type 50) fallback
     */
    function lookupCompanyShipTo(locationGroupId) {
        var empty = { name: '', address: '', city: '', state: '', zip: '', country: '' };
        try {
            var companyAccountId = 1;
            var lgId = (locationGroupId && locationGroupId > 0) ? parseInt(locationGroupId) : null;
            debugLog('Company ShipTo lookup: locationGroupId=' + locationGroupId + ' resolved lgId=' + lgId, 'info');

            // Query all Ship To (type 10) and Main Office (type 50) addresses for the company.
            // Order by: LG match first, then Ship To before Main Office, then default flag.
            var sql =
                "SELECT a.addressName, a.address, a.city, " +
                "COALESCE(sc.name, '') AS stateName, a.zip, COALESCE(cc.name, '') AS countryName, " +
                "a.typeid, a.defaultflag, a.locationgroupid " +
                "FROM address a " +
                "LEFT JOIN stateconst sc ON sc.id = a.stateId " +
                "LEFT JOIN countryconst cc ON cc.id = a.countryId " +
                "WHERE a.accountid = " + companyAccountId +
                " AND a.typeid IN (10, 50)" +
                " ORDER BY " +
                (lgId
                    ? "  CASE WHEN a.locationgroupid = " + lgId + " THEN 0 ELSE 1 END, "
                    : "") +
                "  CASE WHEN a.typeid = 10 THEN 0 ELSE 1 END, " +
                "  a.defaultflag DESC";

            var rows = JSON.parse(runQuery(sql));
            debugLog('Company ShipTo candidates (' + rows.length + ' rows, lgId=' + lgId + '):', 'info');
            for (var d = 0; d < rows.length; d++) {
                var dr = rows[d];
                debugLog('  [' + d + '] name=' + dr.addressName + ' city=' + dr.city + ' type=' + dr.typeid + ' lg=' + dr.locationgroupid + ' default=' + dr.defaultflag, 'info');
            }
            if (!rows || rows.length === 0) return empty;

            // Pick best match: LG-matching Ship To â†’ default Ship To â†’ any Ship To â†’ Main Office
            var best = null;

            for (var i = 0; i < rows.length; i++) {
                var r = rows[i];
                var isShipTo = (parseInt(r.typeid) === 10);
                // Use == for type-coercing comparison (handles string/number mismatches from DB)
                var isLgMatch = lgId && r.locationgroupid != null && r.locationgroupid != 0 && r.locationgroupid == lgId;
                var isDefault = (r.defaultflag === '1' || r.defaultflag === 1 || r.defaultflag === true);

                // Best: Ship To + matching LG â€” always wins
                if (isShipTo && isLgMatch) { best = r; break; }
                // Next best: Ship To + default flag
                if (!best && isShipTo && isDefault) { best = r; }
                // Next: Ship To (any)
                if (!best && isShipTo) { best = r; }
                // Fallback: Main Office type 50
                if (!best) { best = r; }
            }

            if (!best) return empty;
            debugLog('Company ShipTo selected: name=' + best.addressName + ' city=' + best.city + ' lg=' + best.locationgroupid, 'success');
            return {
                name: best.addressName || '',
                address: best.address || '',
                city: best.city || '',
                state: best.stateName || '',
                zip: best.zip || '',
                country: best.countryName || ''
            };
        } catch (e) {
            debugLog('Company ShipTo lookup error: ' + e.message, 'error');
            return empty;
        }
    }

    function submitPoFromModal(vendorId) {
        var items = window._modalItems;
        var vendorName = window._modalVendorName;
        if (!items || items.length === 0) return;

        // Re-read values from modal inputs in case user changed them
        items.forEach(function(item, idx) {
            var qtyInput = document.getElementById('modal-qty-' + idx);
            var costInput = document.getElementById('modal-cost-' + idx);
            if (qtyInput) item.qty = parseFloat(qtyInput.value) || 0;
            if (costInput) item.unitCost = parseFloat(costInput.value) || 0;
        });

        // Filter out zero qty
        items = items.filter(function(i) { return i.qty > 0; });
        if (items.length === 0) {
            showStatus('All line items have zero quantity.', 'warning');
            return;
        }

        try {
            var lgName = getLocationGroupName();
            var lgId = getLocationGroupId();
            debugLog('PO submit: lgName=' + lgName + ' lgId=' + lgId + ' vendorId=' + vendorId, 'info');
            // Format today's date using Fishbowl's DateFormatShort property
            var fbDateFormat = getProperty('DateFormatShort', 'MM/dd/yyyy');
            // Convert Java SimpleDateFormat to Moment.js format (ddâ†’DD, yyyyâ†’YYYY)
            var momentFormat = fbDateFormat.replace(/yyyy/g, 'YYYY').replace(/yy/g, 'YY').replace(/dd/g, 'DD');
            var today = moment().format(momentFormat);

            // Read PO status from radio buttons
            var statusEl = document.querySelector('input[name="modal-po-status"]:checked');
            var poStatus = statusEl ? parseInt(statusEl.value) : 10;

            // Lookup addresses
            var remitTo = lookupVendorAddress(vendorId, 30, lgId);  // Vendor: type 30 Remit To, fallback 50 Main Office
            var shipTo  = lookupCompanyShipTo(lgId);                // Company: type 10 Ship To, fallback 50 Main Office

            // Fallback: RemitToName must not be empty â€” use vendor name if no address found
            if (!remitTo.name) remitTo.name = vendorName;

            // Fallback: ShipToName must not be empty â€” use location group name if no address found
            if (!shipTo.name) shipTo.name = lgName;

            // Lookup default carrier for this vendor, fallback to system default
            var carrierName = '';
            try {
                var carrierRows = JSON.parse(runQuery(
                    "SELECT c.name FROM carrier c " +
                    "INNER JOIN vendor v ON v.defaultcarrierid = c.id " +
                    "WHERE v.id = " + parseInt(vendorId)
                ));
                if (carrierRows && carrierRows.length > 0 && carrierRows[0].name) {
                    carrierName = carrierRows[0].name;
                }
            } catch (e) {
                debugLog('Carrier lookup error: ' + e.message, 'warning');
            }
            if (!carrierName) {
                // Fallback: company default carrier
                try {
                    var companyCarrier = JSON.parse(runQuery(
                        "SELECT c.name FROM carrier c " +
                        "INNER JOIN company co ON co.defaultcarrierid = c.id"
                    ));
                    if (companyCarrier && companyCarrier.length > 0 && companyCarrier[0].name) {
                        carrierName = companyCarrier[0].name;
                    }
                } catch (e) {
                    debugLog('Company carrier lookup error: ' + e.message, 'warning');
                }
            }
            debugLog('Carrier: ' + (carrierName || '(none)'), 'info');

            debugLog('RemitTo address: ' + JSON.stringify(remitTo), 'info');
            debugLog('ShipTo address: ' + JSON.stringify(shipTo), 'info');

            // === Build CSV rows matching Fishbowl ImportPurchaseOrder export format ===
            // Structure: PO header row, Item header row, PO data row, Item data rows
            var csvRows = [];

            // Row 1: PO column headers
            csvRows.push(
                '"Flag","PONum","Status","VendorName","VendorContact",' +
                '"RemitToName","RemitToAddress","RemitToCity","RemitToState","RemitToZip","RemitToCountry",' +
                '"ShipToName","DeliverToName","ShipToAddress","ShipToCity","ShipToState","ShipToZip","ShipToCountry",' +
                '"CarrierName","CarrierService","TaxCode","VendorSONum","CustomerSONum",' +
                '"CreatedDate","CompletedDate","ConfirmedDate","FulfillmentDate","IssuedDate",' +
                '"Buyer","ShippingTerms","PaymentTerms","FOB","Note",' +
                '"QuickBooksClassName","LocationGroupName","URL","Phone","Email",' +
                '"CurrencyName","CurrencyRate","CF-Custom"'
            );

            // Row 2: Item column headers
            csvRows.push(
                '"Flag","POItemTypeID","PartNumber","VendorPartNumber","PartQuantity","FulfilledQuantity",' +
                '"PickedQuantity","UOM","PartPrice","TaxCode","FulfillmentDate","LastFulfillmentDate",' +
                '"RevisionLevel","Note","QuickBooksClassName","CustomerJob"'
            );

            // Helper to escape CSV values
            function esc(val) { return (val || '').replace(/"/g, '""'); }

            // Row 3: PO data
            var escapedVendor = esc(vendorName);
            csvRows.push(
                '"PO","",' + poStatus + ',"' + escapedVendor + '","",' +
                '"' + esc(remitTo.name) + '","' + esc(remitTo.address) + '","' + esc(remitTo.city) + '","' + esc(remitTo.state) + '","' + esc(remitTo.zip) + '","' + esc(remitTo.country) + '",' +
                '"' + esc(shipTo.name) + '","","' + esc(shipTo.address) + '","' + esc(shipTo.city) + '","' + esc(shipTo.state) + '","' + esc(shipTo.zip) + '","' + esc(shipTo.country) + '",' +
                '"' + esc(carrierName) + '","","","","","' + today + '","","","","","","","","","Auto PO from BI Report",' +
                '"","' + esc(lgName) + '","","","","","",""'
            );

            // Row 4+: Item data rows
            items.forEach(function(item) {
                var escapedPN = item.partNum.replace(/"/g, '""');
                var escapedVPN = (item.vendorPartNum || '').replace(/"/g, '""');
                csvRows.push(
                    '"Item",10,"' + escapedPN + '","' + escapedVPN + '",' +
                    item.qty + ',0,0,' +
                    '"' + item.uomCode + '",' + item.unitCost.toFixed(2) + ',' +
                    '"","","","","","",""'
                );
            });

            var csvData = csvRows.join('\n');

            debugLog('Submitting PO for vendor: ' + vendorName + ' (' + items.length + ' items, PO#: ' + (poNum || 'auto') + ')', 'click');
            debugLog('PO CSV data:\n' + csvData, 'info');

            // === Submit via Fishbowl ImportRq API ===
            var payload = {
                "ImportRq": {
                    "Type": "ImportPurchaseOrder",
                    "Rows": {
                        "Row": csvRows
                    }
                }
            };

            debugLog('Import payload: ' + JSON.stringify(payload), 'info');

            var response = runApiRequest('ImportRq', JSON.stringify(payload));

            if (!response) {
                showStatus('PO import failed for ' + vendorName + ': No response from API.', 'error');
                debugLog('PO import failed: No response from runApiRequest', 'error');
                return;
            }

            var result = typeof response === 'string' ? JSON.parse(response) : response;
            debugLog('PO import response: ' + JSON.stringify(result), 'info');

            if (result && result.ImportRs && result.ImportRs.statusCode === 1000) {
                debugLog('PO created successfully for ' + vendorName + ': ' + items.length + ' line items', 'success');

                // Look up the PO that was just created by finding the most recent PO for this vendor
                // and verifying the line-item count matches what we submitted
                var poNum = '';
                try {
                    var poRows = JSON.parse(runQuery(
                        "SELECT po.id, po.num FROM po " +
                        "WHERE po.vendorid = " + parseInt(vendorId) +
                        " ORDER BY po.id DESC LIMIT 1"
                    ));
                    if (poRows && poRows.length > 0) {
                        // Verify by checking item count on this PO matches what we sent
                        var poId = poRows[0].id;
                        var candidateNum = poRows[0].num;
                        var itemCountRows = JSON.parse(runQuery(
                            "SELECT COUNT(*) AS cnt FROM poitem WHERE poid = " + poId
                        ));
                        var dbCount = (itemCountRows && itemCountRows.length > 0) ? parseInt(itemCountRows[0].cnt) : 0;
                        if (dbCount === items.length) {
                            poNum = candidateNum;
                            debugLog('Verified PO#' + poNum + ' (id=' + poId + ') with ' + dbCount + ' items', 'success');
                        } else {
                            // Count mismatch â€” still use the number but log a warning
                            poNum = candidateNum;
                            debugLog('PO#' + poNum + ' item count mismatch: expected ' + items.length + ', got ' + dbCount, 'warning');
                        }
                    }
                } catch (e) {
                    debugLog('Could not look up created PO number: ' + e.message, 'warning');
                }

                showStatus('PO created successfully for ' + vendorName + '! ' + items.length + ' line items.' + (poNum ? ' PO#: ' + poNum : ''), 'success');

                // Store the PO against this vendor so the header row can show it
                if (poNum) {
                    if (!window._vendorPOs) window._vendorPOs = {};
                    window._vendorPOs[vendorId] = poNum;
                }

                // Update vendor header row with PO link badge
                var headerRow = document.querySelector('.vendor-group-header .vendor-expand-toggle[data-vendor-id="' + vendorId + '"]');
                if (headerRow && poNum) {
                    var headerDiv = headerRow.closest('.vendor-group-header td > div');
                    if (headerDiv) {
                        // Remove the Create PO button and replace with PO link
                        var createBtn = headerDiv.querySelector('.btn-create-po');
                        if (createBtn) createBtn.remove();
                        var rightDiv = headerDiv.querySelector('div:last-child');
                        if (rightDiv) {
                            rightDiv.insertAdjacentHTML('beforeend',
                                ' <a href="#" class="po-raised-link" onclick="openModule(\'Purchase Order\', \'' + poNum + '\'); return false;" ' +
                                'style="display:inline-flex; align-items:center; gap:4px; font-size:12px; padding:4px 10px; border-radius:6px; ' +
                                'background:#dcfce7; color:#166534; font-weight:600; text-decoration:none; border:1px solid #bbf7d0;">' +
                                '<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:14px;height:14px;">' +
                                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>' +
                                'PO# ' + poNum + '</a>'
                            );
                        }
                    }
                }

                // Mark submitted rows in the table (visual only, resets on page reload)
                var submittedKeys = {};
                items.forEach(function(item) {
                    submittedKeys[vendorId + '_' + item.partId] = poNum || 'created';
                });
                document.querySelectorAll('.row-checkbox[data-key]').forEach(function(cb) {
                    var key = cb.getAttribute('data-key');
                    if (submittedKeys[key]) {
                        var tr = cb.closest('tr');
                        if (tr) {
                            tr.style.backgroundColor = '#f0fdf4';
                            tr.style.opacity = '0.7';
                            if (poNum) {
                                var partCell = tr.querySelectorAll('td')[1];
                                if (partCell && !partCell.querySelector('.po-badge')) {
                                    partCell.insertAdjacentHTML('beforeend',
                                        ' <span class="po-badge" style="display:inline-block; font-size:10px; padding:1px 6px; border-radius:4px; background:#bbf7d0; color:#166534; font-weight:600; vertical-align:middle;">PO# ' + poNum + '</span>'
                                    );
                                }
                            }
                        }
                        cb.checked = false;
                        cb.disabled = true;
                        selectionState[key] = false;
                    }
                });

                closePoModal();
            } else {
                var errorMsg = 'PO import failed for ' + vendorName;
                if (result && result.ImportRs && result.ImportRs.statusMessage) {
                    errorMsg += ': ' + result.ImportRs.statusMessage;
                } else if (result && result.ErrorRs && result.ErrorRs.statusMessage) {
                    errorMsg += ': ' + result.ErrorRs.statusMessage;
                } else {
                    errorMsg += ': ' + JSON.stringify(result);
                }
                showStatus(errorMsg, 'error');
                debugLog(errorMsg, 'error');
            }
        } catch (e) {
            console.error('submitPoFromModal error:', e);
            showStatus('Error creating PO: ' + e.message, 'error');
            debugLog('submitPoFromModal error: ' + e.message, 'error');
        }
    }

    // ============================================
    // Export / Print
    // ============================================
    function exportToCSV() { if (dataTable) dataTable.button(0).trigger(); }
    function printTable() { if (dataTable) dataTable.button(1).trigger(); }

    // ============================================
    // Init
    // ============================================
    $(document).ready(function() {
        // Show debug console if BI_SHOW_DEBUG property is set
        if (DEBUG_MODE) {
            document.getElementById('debugConsoleContainer').style.display = 'block';
        }

        debugLog('Auto PO Inventory Watchlist initialized', 'success');
        debugLog('Debug mode: ' + DEBUG_MODE + ' (BI_SHOW_DEBUG=' + BI_SHOW_DEBUG_PROP + ')', 'info');
        debugLog('User: ' + (user.fullName || user.firstName + ' ' + user.lastName || 'ID ' + currentUser), 'info');

        initParameters();
        debugLog('Parameters initialized', 'success');
    });

    </script>
</body>
</html>
