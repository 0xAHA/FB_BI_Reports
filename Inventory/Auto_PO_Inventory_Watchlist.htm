<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto PO - Inventory Reorder Watchlist</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- D3.js v7 -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <!-- Moment.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

    <!-- DataTables CDN Links -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs4-4.1.1/jq-3.3.1/jszip-2.5.0/dt-1.10.20/b-1.6.1/b-colvis-1.6.1/b-html5-1.6.1/b-print-1.6.1/cr-1.5.2/fh-3.1.6/r-2.2.3/sc-2.0.1/datatables.min.css"/>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/v/bs4-4.1.1/jq-3.3.1/jszip-2.5.0/dt-1.10.20/b-1.6.1/b-colvis-1.6.1/b-html5-1.6.1/b-print-1.6.1/cr-1.5.2/fh-3.1.6/r-2.2.3/sc-2.0.1/datatables.min.js"></script>
    <style>
        /* ============================================
           Base Styles (matching Reorder Watchlist)
           ============================================ */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        :root {
            --color-primary: #2d9cdb;
            --color-primary-dark: #1e7bb4;
            --color-sidebar: #06162d;
            --color-sidebar-hover: #0a1f3d;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Override Tailwind indigo with custom blue */
        .bg-indigo-600 { background-color: var(--color-primary) !important; }
        .bg-indigo-50 { background-color: rgba(45, 156, 219, 0.1) !important; }
        .text-indigo-600 { color: var(--color-primary) !important; }
        .text-indigo-700 { color: var(--color-primary-dark) !important; }
        .border-indigo-200 { border-color: rgba(45, 156, 219, 0.3) !important; }
        .hover\:text-indigo-600:hover { color: var(--color-primary) !important; }
        .hover\:bg-indigo-50:hover { background-color: rgba(45, 156, 219, 0.1) !important; }

        /* ============================================
           DataTables Overrides
           ============================================ */
        table.dataTable {
            table-layout: fixed;
            font-size: 12px;
            border-collapse: separate;
            border-spacing: 0;
        }

        table.dataTable thead th {
            font-size: 12px;
            padding: 12px 8px;
            background-color: #f8f9fa !important;
            color: #475569 !important;
            font-weight: 600;
            border: none;
            border-bottom: 2px solid #e2e8f0;
            text-align: center;
            white-space: normal;
            line-height: 1.3;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        table.dataTable thead th:first-child { border-top-left-radius: 0px; }
        table.dataTable thead th:last-child { border-top-right-radius: 0px; }

        table.dataTable tbody td {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 12px;
            padding: 8px;
            border-bottom: 1px solid #e2e8f0;
        }

        table.dataTable tbody td.dt-center { text-align: center; }
        table.dataTable tbody td.dt-right { text-align: right; }

        table.dataTable tbody tr {
            background-color: white;
            transition: background-color 0.15s ease;
        }

        table.dataTable tbody tr:hover { background-color: #f8fafc; }

        /* Vendor Group Header Row */
        .vendor-group-header td {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%) !important;
            font-weight: 700;
            padding: 12px !important;
            font-size: 13px;
            border-top: 2px solid var(--color-primary);
            border-bottom: 1px solid #cbd5e1;
            color: #1e293b;
        }

        /* Clickable Links */
        .item-link {
            color: #2d9cdb;
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }
        .item-link:hover {
            text-decoration: underline;
            color: #1e7bb4;
        }

        /* DataTables Controls - hide built-in */
        .dataTables_wrapper .dataTables_length,
        .dataTables_wrapper .dataTables_filter,
        .dataTables_wrapper .dataTables_info,
        .dataTables_wrapper .dataTables_paginate,
        .dt-buttons {
            display: none !important;
        }

        /* Column Group Styling */
        .group-part-info { background-color: #f1f5f9 !important; }
        .group-inventory-key { background-color: #fef3c7 !important; }
        .group-reorder-params { background-color: #dcfce7 !important; }
        .group-allocation { background-color: #fafafa !important; }

        /* ============================================
           Auto PO Specific Styles
           ============================================ */
        .row-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: var(--color-primary);
        }

        .qty-input {
            width: 70px;
            padding: 2px 6px;
            font-size: 12px;
            border: 1px solid #cbd5e1;
            border-radius: 3px;
            text-align: right;
            background: white;
        }
        .qty-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(45, 156, 219, 0.2);
        }
        .qty-input:disabled {
            background: #f1f5f9;
            color: #94a3b8;
        }

        .btn-create-po {
            padding: 4px 12px;
            font-size: 11px;
            font-weight: 600;
            color: white;
            background-color: #16a34a;
            border: 1px solid #15803d;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s ease;
            white-space: nowrap;
        }
        .btn-create-po:hover { background-color: #15803d; }
        .btn-create-po:disabled {
            background-color: #94a3b8;
            border-color: #94a3b8;
            cursor: not-allowed;
        }

        .vendor-select-all {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: var(--color-primary);
            vertical-align: middle;
            margin-right: 4px;
        }

        .status-message {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            display: none;
        }
        .status-message.success { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; display: block; }
        .status-message.error { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; display: block; }
        .status-message.info { background: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; display: block; }
        .status-message.warning { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; display: block; }

        tr.row-deselected td { opacity: 0.45; }

        /* Custom Tooltip Styles */
        .custom-tooltip {
            position: absolute;
            background: rgba(15, 23, 42, 0.95);
            color: white;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            line-height: 1.5;
            pointer-events: none;
            z-index: 10000;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transition: opacity 0.2s ease;
            max-width: 400px;
            white-space: pre-line;
        }
        .custom-tooltip.show { opacity: 1; }

        /* ============================================
           Print Styles
           ============================================ */
        @media print {
            html, body { overflow: visible; }
            @page { size: A4 landscape; margin: 0.5in; }
            .dataTables_wrapper .dataTables_length,
            .dataTables_wrapper .dataTables_filter,
            .dataTables_wrapper .dataTables_info,
            .dataTables_wrapper .dataTables_paginate,
            .dt-buttons, button, .btn, header,
            .row-checkbox, .qty-input, .btn-create-po,
            #parametersPanel, #statusArea { display: none !important; }
            table.dataTable { width: 100% !important; font-size: 7pt; }
            table.dataTable thead th { font-size: 6.5pt; padding: 3px 2px; border: 1px solid #ccc; }
            table.dataTable tbody td { font-size: 7pt; padding: 2px 1px; border: 1px solid #ccc; }
            .vendor-group-header td { font-weight: bold; font-size: 7.5pt; padding: 4px 2px !important; border: 1px solid #000 !important; }
        }
    </style>
</head>
<body class="bg-slate-50">
    <!-- Custom Tooltip Container -->
    <div id="customTooltip" class="custom-tooltip"></div>

    <div class="flex flex-col h-screen">
        <!-- Header -->
        <header id="headerContainer" class="h-20 bg-white border-b border-slate-200 px-8 flex items-center justify-between flex-shrink-0 z-20 shadow-sm">
            <div class="flex items-center gap-6">
                <div>
                    <h1 class="text-xl font-bold text-slate-900">Auto PO - Inventory Reorder Watchlist</h1>
                    <p class="text-xs text-slate-500 mt-0.5">Generate purchase orders from system-calculated reorder suggestions</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="toggleInstructions()" class="px-3 py-2 bg-slate-100 hover:bg-slate-200 border border-slate-300 rounded-lg text-sm font-medium transition-colors" title="View Usage Guide">
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Help
                </button>
            </div>
        </header>

        <!-- Content Area -->
        <div class="flex-1 overflow-y-auto custom-scrollbar p-4 lg:p-8">
            <!-- Instructions Panel (hidden by default) -->
            <div id="instructionsPanel" class="bg-white rounded-2xl shadow-md border border-slate-300 p-6 mb-6" style="display: none;">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Usage Guide
                    </h2>
                    <button onclick="toggleInstructions()" class="text-slate-400 hover:text-slate-600 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-sm font-bold text-slate-700 mb-2">How It Works</h3>
                        <p class="text-sm text-slate-600 mb-3">This report uses Fishbowl's built-in Auto PO engine to calculate suggested purchase quantities for each part, factoring in on-hand stock, allocations, open orders, reorder points, and target levels.</p>
                        <h3 class="text-sm font-bold text-slate-700 mb-2">Steps</h3>
                        <ol class="text-sm text-slate-600 space-y-1 list-decimal list-inside">
                            <li>Configure parameters (vendor, location group, date range, etc.)</li>
                            <li>Click <strong>Load Data</strong> to fetch suggestions from the system</li>
                            <li>Review results &mdash; adjust quantities if needed</li>
                            <li>Select/deselect parts using checkboxes</li>
                            <li>Click <strong>Create PO</strong> on vendor header row to generate a purchase order</li>
                        </ol>
                    </div>
                    <div>
                        <h3 class="text-sm font-bold text-slate-700 mb-2">Parameters</h3>
                        <div class="text-sm text-slate-600 space-y-1">
                            <p><strong>Vendor:</strong> Required. Select a specific vendor or "All Vendors" (processes each vendor individually).</p>
                            <p><strong>Location Group:</strong> Use "All" (-1) for company wide, or select a specific group.</p>
                            <p><strong>QB Class:</strong> Use "All" (-1) for all classes, or select a specific QuickBooks class.</p>
                            <p><strong>Date Range:</strong> The date window for demand analysis (e.g. current fiscal year).</p>
                            <p><strong>Show Vendor Part #:</strong> Include vendor-specific part numbers in results.</p>
                            <p><strong>Include No ROP/OUL:</strong> Include parts without configured reorder points.</p>
                            <p><strong>Include Always Manufacture:</strong> Include parts flagged as always manufactured.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Parameters Panel -->
            <div id="parametersPanel" class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 mb-4">
                <div class="flex flex-wrap gap-3 items-end">
                    <div class="flex-1 min-w-[160px]">
                        <label class="block text-xs font-medium text-slate-600 mb-1">Vendor</label>
                        <select id="paramVendor" class="w-full px-2 py-1.5 text-sm border border-slate-300 rounded bg-white">
                            <option value="all">All Vendors</option>
                        </select>
                    </div>
                    <div class="flex-1 min-w-[160px]">
                        <label class="block text-xs font-medium text-slate-600 mb-1">Location Group</label>
                        <select id="paramLocationGroup" class="w-full px-2 py-1.5 text-sm border border-slate-300 rounded bg-white">
                            <option value="-1">All (Company Wide)</option>
                        </select>
                    </div>
                    <div class="flex-1 min-w-[120px]">
                        <label class="block text-xs font-medium text-slate-600 mb-1">QB Class</label>
                        <select id="paramQBClass" class="w-full px-2 py-1.5 text-sm border border-slate-300 rounded bg-white">
                            <option value="-1">All</option>
                        </select>
                    </div>
                    <div class="min-w-[130px]">
                        <label class="block text-xs font-medium text-slate-600 mb-1">Start Date</label>
                        <input type="date" id="paramStartDate" class="w-full px-2 py-1 text-sm border border-slate-300 rounded">
                    </div>
                    <div class="min-w-[130px]">
                        <label class="block text-xs font-medium text-slate-600 mb-1">End Date</label>
                        <input type="date" id="paramEndDate" class="w-full px-2 py-1 text-sm border border-slate-300 rounded">
                    </div>
                    <div class="flex items-center gap-4 py-1">
                        <label class="flex items-center gap-1.5 text-xs text-slate-600 cursor-pointer whitespace-nowrap">
                            <input type="checkbox" id="paramShowVendorPN" checked class="accent-[#2d9cdb]"> Vendor Part #
                        </label>
                        <label class="flex items-center gap-1.5 text-xs text-slate-600 cursor-pointer whitespace-nowrap">
                            <input type="checkbox" id="paramIncludeNoROP" checked class="accent-[#2d9cdb]"> No ROP/OUL
                        </label>
                        <label class="flex items-center gap-1.5 text-xs text-slate-600 cursor-pointer whitespace-nowrap">
                            <input type="checkbox" id="paramIncludeMfg" checked class="accent-[#2d9cdb]"> Always Mfg
                        </label>
                    </div>
                    <div>
                        <button onclick="loadAutoPoData()" id="btnLoadData" class="px-4 py-1.5 text-sm font-semibold text-white rounded border border-[#1e7bb4] transition-colors" style="background-color: var(--color-primary);" onmouseover="this.style.backgroundColor='#1e7bb4'" onmouseout="this.style.backgroundColor='#2d9cdb'">
                            Load Data
                        </button>
                    </div>
                </div>
            </div>

            <!-- Column Filters (shown after data loads) -->
            <div id="columnFilters" class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 mb-4" style="display:none;">
                <div class="flex flex-wrap gap-3 items-end">
                    <div class="flex-1 min-w-[120px]">
                        <label class="block text-xs font-medium text-slate-600 mb-1">Part Number</label>
                        <input type="text" id="filterPartNum" class="w-full px-2 py-1 text-sm border border-slate-300 rounded" placeholder="Filter..." oninput="applyColumnFilters()">
                    </div>
                    <div class="flex-1 min-w-[150px]">
                        <label class="block text-xs font-medium text-slate-600 mb-1">Description</label>
                        <input type="text" id="filterDescription" class="w-full px-2 py-1 text-sm border border-slate-300 rounded" placeholder="Filter..." oninput="applyColumnFilters()">
                    </div>
                    <div class="flex-1 min-w-[120px]">
                        <label class="block text-xs font-medium text-slate-600 mb-1">Vendor</label>
                        <input type="text" id="filterVendor" class="w-full px-2 py-1 text-sm border border-slate-300 rounded" placeholder="Filter..." oninput="applyColumnFilters()">
                    </div>
                    <div class="flex items-center gap-1">
                        <button onclick="clearColumnFilters()" class="px-3 py-1 text-sm bg-slate-100 hover:bg-slate-200 text-slate-700 rounded border border-slate-300">Clear</button>
                        <button onclick="exportToCSV()" class="p-1.5 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded border border-slate-300" title="Export CSV">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        </button>
                        <button onclick="printTable()" class="p-1.5 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded border border-slate-300" title="Print">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Status Area -->
            <div id="statusArea" class="mb-4">
                <div id="statusMessage" class="status-message"></div>
            </div>

            <!-- Main Table Container -->
            <div id="tableContainer" class="bg-white rounded-2xl shadow-md border border-slate-300 p-6 relative" style="display:none;">
                <table id="report-table" class="display" style="width:100%"></table>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="bg-white rounded-2xl shadow-md border border-slate-300 p-12 text-center">
                <svg class="w-16 h-16 mx-auto text-slate-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                </svg>
                <p class="text-slate-500 text-sm mb-2">Configure parameters above and click <strong>Load Data</strong> to fetch reorder suggestions.</p>
                <p class="text-slate-400 text-xs">The system will calculate suggested purchase quantities for each vendor.</p>
            </div>
        </div>
    </div>

    <script>
    // ============================================
    // Configuration & Globals
    // ============================================
    const displayHeader = $CHECK{Display_header|true};
    let headerContainer = document.getElementById('headerContainer');
    displayHeader ? headerContainer.style.display = 'flex' : headerContainer.style.display = 'none';

    let user = JSON.parse(getUser());
    let currentUser = user.id;

    // All data from getAutoPo calls
    let allResults = [];
    // Track selection state: { 'vendorId_partId': true/false }
    let selectionState = {};
    // Track qty overrides: { 'vendorId_partId': number }
    let qtyOverrides = {};
    // DataTable reference
    let dataTable = null;

    // ============================================
    // Tooltip Functions
    // ============================================
    function showTooltip(event, content) {
        const tooltip = document.getElementById('customTooltip');
        tooltip.innerHTML = content;
        tooltip.classList.add('show');
        const x = event.pageX + 15;
        const y = event.pageY + 15;
        const adjustedX = (x + 400 > window.innerWidth) ? event.pageX - 400 - 15 : x;
        const adjustedY = (y + 100 > window.innerHeight) ? event.pageY - 100 - 15 : y;
        tooltip.style.left = adjustedX + 'px';
        tooltip.style.top = adjustedY + 'px';
    }

    function hideTooltip() {
        document.getElementById('customTooltip').classList.remove('show');
    }

    function toggleInstructions() {
        const panel = document.getElementById('instructionsPanel');
        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }

    // ============================================
    // Initialize Parameter Dropdowns
    // ============================================
    function initParameters() {
        // Load vendors
        try {
            const vendorQuery = "SELECT id, name FROM vendor WHERE activeflag = 1 ORDER BY name";
            const vendors = JSON.parse(runQuery(vendorQuery));
            const vendorSelect = document.getElementById('paramVendor');
            vendors.forEach(function(v) {
                const opt = document.createElement('option');
                opt.value = v.id;
                opt.textContent = v.name;
                vendorSelect.appendChild(opt);
            });
        } catch (e) {
            console.error('Failed to load vendors:', e);
        }

        // Load location groups
        try {
            const lgQuery = "SELECT id, name FROM locationgroup WHERE activeflag = 1 ORDER BY name";
            const locationGroups = JSON.parse(runQuery(lgQuery));
            const lgSelect = document.getElementById('paramLocationGroup');
            locationGroups.forEach(function(lg) {
                const opt = document.createElement('option');
                opt.value = lg.id;
                opt.textContent = lg.name;
                lgSelect.appendChild(opt);
            });
        } catch (e) {
            console.error('Failed to load location groups:', e);
        }

        // Load QB Classes (table may not exist)
        try {
            const qbQuery = "SELECT id, name FROM qbclass WHERE activeflag = 1 ORDER BY name";
            const qbClasses = JSON.parse(runQuery(qbQuery));
            const qbSelect = document.getElementById('paramQBClass');
            qbClasses.forEach(function(qb) {
                const opt = document.createElement('option');
                opt.value = qb.id;
                opt.textContent = qb.name;
                qbSelect.appendChild(opt);
            });
        } catch (e) {
            console.log('QB Class query skipped:', e);
        }

        // Set default dates to current fiscal year
        try {
            const fyStartMonth = parseInt(getProperty('BI_FY_START_MONTH', '1')) || 1;
            const now = new Date();
            let fyStartYear = now.getFullYear();
            if ((now.getMonth() + 1) < fyStartMonth) {
                fyStartYear--;
            }
            const startDate = fyStartYear + '-' + String(fyStartMonth).padStart(2, '0') + '-01';
            let fyEndYear = fyStartYear + 1;
            let fyEndMonth = fyStartMonth - 1;
            if (fyEndMonth === 0) { fyEndMonth = 12; fyEndYear--; }
            const lastDay = new Date(fyEndYear, fyEndMonth, 0).getDate();
            const endDate = fyEndYear + '-' + String(fyEndMonth).padStart(2, '0') + '-' + String(lastDay).padStart(2, '0');

            document.getElementById('paramStartDate').value = startDate;
            document.getElementById('paramEndDate').value = endDate;
        } catch (e) {
            const year = new Date().getFullYear();
            document.getElementById('paramStartDate').value = year + '-01-01';
            document.getElementById('paramEndDate').value = year + '-12-31';
        }
    }

    // ============================================
    // Load Auto PO Data
    // ============================================
    function loadAutoPoData() {
        const vendorVal = document.getElementById('paramVendor').value;
        const locationGroupId = parseInt(document.getElementById('paramLocationGroup').value);
        const qbClassId = parseInt(document.getElementById('paramQBClass').value);
        const showVendorPN = document.getElementById('paramShowVendorPN').checked;
        const includeNoROP = document.getElementById('paramIncludeNoROP').checked;
        const includeMfg = document.getElementById('paramIncludeMfg').checked;
        const startDate = document.getElementById('paramStartDate').value;
        const endDate = document.getElementById('paramEndDate').value;

        if (!startDate || !endDate) {
            showStatus('Please select both start and end dates.', 'warning');
            return;
        }

        // Reset state
        allResults = [];
        selectionState = {};
        qtyOverrides = {};

        showStatus('Loading Auto PO data...', 'info');
        document.getElementById('btnLoadData').disabled = true;

        try {
            let vendorIds = [];

            if (vendorVal === 'all') {
                // Get all active vendors that have vendor parts
                const vQuery = "SELECT DISTINCT v.id FROM vendor v INNER JOIN vendorparts vp ON v.id = vp.vendorid WHERE v.activeflag = 1 ORDER BY v.id";
                const vResult = JSON.parse(runQuery(vQuery));
                vendorIds = vResult.map(function(v) { return v.id; });
            } else {
                vendorIds = [parseInt(vendorVal)];
            }

            let totalParts = 0;
            let vendorsWithData = 0;

            vendorIds.forEach(function(vid) {
                try {
                    const resultJson = getAutoPo(
                        vid,
                        locationGroupId,
                        qbClassId,
                        showVendorPN,
                        includeNoROP,
                        includeMfg,
                        startDate,
                        endDate
                    );
                    const items = JSON.parse(resultJson);

                    if (items && items.length > 0) {
                        items.forEach(function(item) {
                            allResults.push(item);
                            var key = item.vendor_id + '_' + item.part_id;
                            var sugQty = parseFloat(item.qty_suggested) || 0;
                            selectionState[key] = sugQty > 0;
                        });
                        totalParts += items.length;
                        vendorsWithData++;
                    }
                } catch (innerErr) {
                    console.error('getAutoPo failed for vendor ' + vid + ':', innerErr);
                }
            });

            document.getElementById('btnLoadData').disabled = false;

            if (allResults.length === 0) {
                showStatus('No reorder suggestions found for the selected parameters.', 'warning');
                document.getElementById('tableContainer').style.display = 'none';
                document.getElementById('columnFilters').style.display = 'none';
                document.getElementById('emptyState').style.display = 'block';
                return;
            }

            showStatus('Loaded ' + totalParts + ' parts from ' + vendorsWithData + ' vendor(s).', 'success');
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('columnFilters').style.display = 'block';
            document.getElementById('tableContainer').style.display = 'block';

            buildTable();

        } catch (e) {
            console.error('loadAutoPoData error:', e);
            showStatus('Error loading data: ' + e.message, 'error');
            document.getElementById('btnLoadData').disabled = false;
        }
    }

    // ============================================
    // Status Messages
    // ============================================
    function showStatus(message, type) {
        const el = document.getElementById('statusMessage');
        el.textContent = message;
        el.className = 'status-message ' + type;
    }

    // ============================================
    // Formatting Helpers
    // ============================================
    function formatNumber(val) {
        if (val === null || val === undefined || val === '') return '0';
        var num = parseFloat(val);
        if (isNaN(num)) return '0';
        if (Number.isInteger(num)) return num.toString();
        return num.toFixed(2).replace(/\.?0+$/, '');
    }

    function formatCurrencyVal(val) {
        if (val === null || val === undefined || val === '') return '';
        var num = parseFloat(val);
        if (isNaN(num)) return '';
        try {
            return currencyLocale(num);
        } catch(e) {
            return '$' + num.toFixed(2);
        }
    }

    // ============================================
    // Column Filters
    // ============================================
    function applyColumnFilters() {
        if (!dataTable) return;
        redrawTable();
    }

    function clearColumnFilters() {
        document.getElementById('filterPartNum').value = '';
        document.getElementById('filterDescription').value = '';
        document.getElementById('filterVendor').value = '';
        if (dataTable) redrawTable();
    }

    function getFilteredData() {
        const fp = (document.getElementById('filterPartNum').value || '').toLowerCase();
        const fd = (document.getElementById('filterDescription').value || '').toLowerCase();
        const fv = (document.getElementById('filterVendor').value || '').toLowerCase();

        return allResults.filter(function(row) {
            if (fp && (row.part_num || '').toLowerCase().indexOf(fp) === -1) return false;
            if (fd && (row.part_description || '').toLowerCase().indexOf(fd) === -1) return false;
            if (fv && (row.vendor_name || '').toLowerCase().indexOf(fv) === -1) return false;
            return true;
        });
    }

    // ============================================
    // Build/Redraw DataTable
    // ============================================
    function buildTable() {
        if (dataTable) {
            dataTable.destroy();
            $('#report-table').empty();
        }

        const filteredData = getFilteredData();
        const groupedData = buildGroupedData(filteredData);

        dataTable = $('#report-table').DataTable({
            dom: 'Brt',
            data: groupedData,
            ordering: false,
            autoWidth: false,
            paging: false,
            scrollY: 'calc(100vh - 340px)',
            scrollCollapse: true,
            deferRender: true,
            buttons: [
                { extend: 'csv', className: 'dt-button-hidden', exportOptions: {
                    columns: function(idx) { return idx > 0; },
                    format: { body: function(data) { return $('<div>').html(data).text(); } }
                }},
                { extend: 'print', className: 'dt-button-hidden' }
            ],
            columns: [
                // Col 0: Checkbox / Vendor header
                {
                    title: '<input type="checkbox" id="selectAllGlobal" class="row-checkbox" onclick="toggleSelectAll(this.checked)" title="Select/Deselect All">',
                    data: null,
                    defaultContent: '',
                    width: '3%',
                    className: 'dt-center',
                    orderable: false,
                    render: function(data, type, row) {
                        if (row.isVendorHeader) return '';
                        if (type !== 'display') return '';
                        var key = row.vendor_id + '_' + row.part_id;
                        var checked = selectionState[key] ? 'checked' : '';
                        return '<input type="checkbox" class="row-checkbox" data-key="' + key + '" ' + checked + ' onclick="toggleRowSelection(\'' + key + '\', this.checked)">';
                    },
                    createdCell: function(td, cellData, rowData) {
                        if (rowData.isVendorHeader) {
                            $(td).attr('colspan', 14);
                            $(td).parent().addClass('vendor-group-header');

                            var vendorIcon = '<svg class="w-4 h-4 inline-block mr-2 align-text-bottom" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: #2d9cdb;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>';

                            var vendorDisplay = rowData.vendor_name || '';
                            if (rowData.vendor_name) {
                                vendorDisplay = '<a href="#" class="item-link" onclick="openModule(\'Vendor\', \'' + rowData.vendor_name.replace(/'/g, "\\'") + '\'); return false;">' + rowData.vendor_name + '</a>';
                            }

                            var partCount = rowData._partCount || 0;
                            var selectedCount = rowData._selectedCount || 0;
                            var countBadge = '<span class="vendor-count-badge" data-vendor-id="' + rowData._vendorId + '" style="font-size:11px; font-weight:400; color:#64748b; margin-left:8px;">(' + selectedCount + '/' + partCount + ' selected)</span>';

                            var selectAllChecked = (selectedCount === partCount && partCount > 0) ? 'checked' : '';
                            var selectAllCb = '<input type="checkbox" class="vendor-select-all" data-vendor-id="' + rowData._vendorId + '" ' + selectAllChecked + ' onclick="toggleVendorSelectAll(' + rowData._vendorId + ', this.checked)" title="Select/Deselect all for this vendor">';

                            var createPoBtn = '<button class="btn-create-po" data-vendor-id="' + rowData._vendorId + '" onclick="createPoForVendor(' + rowData._vendorId + ')" title="Create PO for ' + (rowData.vendor_name || '').replace(/"/g, '&quot;') + '">' +
                                '<svg class="w-3.5 h-3.5 inline-block mr-1 align-text-bottom" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>' +
                                'Create PO</button>';

                            $(td).html(
                                '<div style="display:flex; align-items:center; justify-content:space-between;">' +
                                    '<div>' + selectAllCb + vendorIcon + vendorDisplay + countBadge + '</div>' +
                                    '<div>' + createPoBtn + '</div>' +
                                '</div>'
                            );
                            $(td).nextAll().remove();
                        }
                    }
                },
                // Col 1: Part Number
                {
                    title: '<span title="Part number">Part #</span>',
                    data: 'part_num',
                    defaultContent: '',
                    width: '8%',
                    className: 'dt-left group-part-info',
                    render: function(data, type, row) {
                        if (row.isVendorHeader) return '';
                        if (type === 'display') {
                            var escaped = (data || '').replace(/'/g, "\\'");
                            return '<a href="#" class="item-link" onmouseenter="showTooltip(event, \'' + escaped + '\')" onmouseleave="hideTooltip()" onclick="openModule(\'Part\', \'' + escaped + '\'); return false;"><strong>' + data + '</strong></a>';
                        }
                        return data;
                    }
                },
                // Col 2: Description
                {
                    title: '<span title="Part description">Description</span>',
                    data: 'part_description',
                    defaultContent: '',
                    width: '18%',
                    className: 'group-part-info',
                    render: function(data, type, row) {
                        if (row.isVendorHeader) return '';
                        if (type === 'display') {
                            var escaped = (data || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                            return '<span onmouseenter="showTooltip(event, \'' + escaped + '\')" onmouseleave="hideTooltip()">' + data + '</span>';
                        }
                        return data;
                    }
                },
                // Col 3: UOM
                {
                    title: '<span title="Part unit of measure">UOM</span>',
                    data: 'part_uom_code',
                    defaultContent: '',
                    width: '4%',
                    className: 'dt-center group-part-info',
                    render: function(data, type, row) { return row.isVendorHeader ? '' : (data || ''); }
                },
                // Col 4: On Hand
                {
                    title: '<span title="Total quantity on hand">On Hand</span>',
                    data: 'qty_on_hand',
                    defaultContent: '',
                    width: '6%',
                    className: 'dt-center group-inventory-key',
                    render: function(data, type, row) { return row.isVendorHeader ? '' : formatNumber(data); }
                },
                // Col 5: On Order
                {
                    title: '<span title="Quantity on open purchase orders">On Order</span>',
                    data: 'qty_on_order',
                    defaultContent: '',
                    width: '6%',
                    className: 'dt-center group-inventory-key',
                    render: function(data, type, row) { return row.isVendorHeader ? '' : formatNumber(data); }
                },
                // Col 6: Allocated
                {
                    title: '<span title="Quantity allocated to orders">Allocated</span>',
                    data: 'qty_allocated',
                    defaultContent: '',
                    width: '6%',
                    className: 'dt-center group-inventory-key',
                    render: function(data, type, row) { return row.isVendorHeader ? '' : formatNumber(data); }
                },
                // Col 7: Drop Ship
                {
                    title: '<span title="Quantity on drop ship">Drop Ship</span>',
                    data: 'qty_on_drop_ship',
                    defaultContent: '',
                    width: '5%',
                    className: 'dt-center group-allocation',
                    render: function(data, type, row) { return row.isVendorHeader ? '' : formatNumber(data); }
                },
                // Col 8: ROP
                {
                    title: '<span title="Reorder point">ROP</span>',
                    data: 'reorder_level',
                    defaultContent: '',
                    width: '5%',
                    className: 'dt-center group-reorder-params',
                    render: function(data, type, row) {
                        if (row.isVendorHeader) return '';
                        var num = parseFloat(data);
                        return (!num || num === 0) ? '-' : formatNumber(data);
                    }
                },
                // Col 9: Target
                {
                    title: '<span title="Order up to / target level">Target</span>',
                    data: 'target_level',
                    defaultContent: '',
                    width: '5%',
                    className: 'dt-center group-reorder-params',
                    render: function(data, type, row) {
                        if (row.isVendorHeader) return '';
                        var num = parseFloat(data);
                        return (!num || num === 0) ? '-' : formatNumber(data);
                    }
                },
                // Col 10: Qty Needed
                {
                    title: '<span title="Calculated quantity needed">Needed</span>',
                    data: 'qty_needed',
                    defaultContent: '',
                    width: '6%',
                    className: 'dt-center group-inventory-key',
                    render: function(data, type, row) { return row.isVendorHeader ? '' : formatNumber(data); }
                },
                // Col 11: Suggested Qty (editable)
                {
                    title: '<span title="System-suggested order quantity (editable)">Order Qty</span>',
                    data: 'qty_suggested',
                    defaultContent: '',
                    width: '8%',
                    className: 'dt-center',
                    render: function(data, type, row) {
                        if (row.isVendorHeader) return '';
                        if (type !== 'display') return data;
                        var key = row.vendor_id + '_' + row.part_id;
                        var currentQty = qtyOverrides[key] !== undefined ? qtyOverrides[key] : (parseFloat(data) || 0);
                        var disabled = selectionState[key] ? '' : 'disabled';
                        return '<input type="number" class="qty-input" data-key="' + key + '" value="' + currentQty + '" min="0" step="1" ' + disabled + ' onchange="updateQtyOverride(\'' + key + '\', this.value)" onclick="event.stopPropagation()">';
                    }
                },
                // Col 12: Last Cost
                {
                    title: '<span title="Last purchase cost">Last Cost</span>',
                    data: 'last_cost',
                    defaultContent: '',
                    width: '6%',
                    className: 'dt-right group-allocation',
                    render: function(data, type, row) { return row.isVendorHeader ? '' : formatCurrencyVal(data); }
                },
                // Col 13: Lead Time
                {
                    title: '<span title="Vendor lead time in days">Lead Time</span>',
                    data: 'lead_time',
                    defaultContent: '',
                    width: '5%',
                    className: 'dt-center group-allocation',
                    render: function(data, type, row) {
                        if (row.isVendorHeader) return '';
                        var num = parseInt(data);
                        return (!num || num === 0) ? '-' : num + 'd';
                    }
                }
            ],
            fixedHeader: true,
            colReorder: false,
            responsive: false,
            stateSave: false,
            drawCallback: function() {
                this.api().columns.adjust();
                updateVendorHeaderColspans();
                applyRowDimming();
            }
        });
    }

    function redrawTable() {
        if (!dataTable) return;
        const filteredData = getFilteredData();
        const groupedData = buildGroupedData(filteredData);
        dataTable.clear();
        dataTable.rows.add(groupedData);
        dataTable.draw(false);
        dataTable.columns.adjust();
    }

    function buildGroupedData(data) {
        var vendorGroups = {};
        var vendorOrder = [];

        data.forEach(function(row) {
            var vid = row.vendor_id;
            if (!vendorGroups[vid]) {
                vendorGroups[vid] = { vendor_name: row.vendor_name, vendor_id: vid, parts: [] };
                vendorOrder.push(vid);
            }
            vendorGroups[vid].parts.push(row);
        });

        vendorOrder.sort(function(a, b) {
            var nameA = (vendorGroups[a].vendor_name || '').toLowerCase();
            var nameB = (vendorGroups[b].vendor_name || '').toLowerCase();
            return nameA < nameB ? -1 : nameA > nameB ? 1 : 0;
        });

        var result = [];
        vendorOrder.forEach(function(vid) {
            var group = vendorGroups[vid];
            var selectedCount = 0;
            group.parts.forEach(function(p) {
                if (selectionState[p.vendor_id + '_' + p.part_id]) selectedCount++;
            });

            result.push({
                isVendorHeader: true,
                vendor_name: group.vendor_name,
                _vendorId: vid,
                _partCount: group.parts.length,
                _selectedCount: selectedCount
            });

            group.parts.forEach(function(p) { result.push(p); });
        });

        return result;
    }

    function updateVendorHeaderColspans() {
        if (!dataTable) return;
        var visibleColCount = dataTable.columns(':visible').count();
        $('.vendor-group-header td:first-child').each(function() {
            $(this).attr('colspan', visibleColCount);
            $(this).nextAll().remove();
        });
    }

    function applyRowDimming() {
        $('#report-table tbody tr').each(function() {
            var $row = $(this);
            if ($row.hasClass('vendor-group-header')) return;
            var cb = $row.find('.row-checkbox');
            if (cb.length > 0 && !cb.prop('checked')) {
                $row.addClass('row-deselected');
            } else {
                $row.removeClass('row-deselected');
            }
        });
    }

    // ============================================
    // Selection Logic
    // ============================================
    function toggleRowSelection(key, checked) {
        selectionState[key] = checked;
        var qtyInput = document.querySelector('.qty-input[data-key="' + key + '"]');
        if (qtyInput) qtyInput.disabled = !checked;
        var cb = document.querySelector('.row-checkbox[data-key="' + key + '"]');
        if (cb) {
            var row = cb.closest('tr');
            checked ? row.classList.remove('row-deselected') : row.classList.add('row-deselected');
        }
        updateVendorHeaderCounts();
    }

    function toggleVendorSelectAll(vendorId, checked) {
        allResults.forEach(function(item) {
            if (item.vendor_id === vendorId) {
                selectionState[item.vendor_id + '_' + item.part_id] = checked;
            }
        });
        document.querySelectorAll('.row-checkbox[data-key]').forEach(function(cb) {
            var key = cb.getAttribute('data-key');
            if (key && key.startsWith(vendorId + '_')) {
                cb.checked = checked;
                var row = cb.closest('tr');
                checked ? row.classList.remove('row-deselected') : row.classList.add('row-deselected');
            }
        });
        document.querySelectorAll('.qty-input[data-key]').forEach(function(inp) {
            var key = inp.getAttribute('data-key');
            if (key && key.startsWith(vendorId + '_')) inp.disabled = !checked;
        });
        updateVendorHeaderCounts();
    }

    function toggleSelectAll(checked) {
        Object.keys(selectionState).forEach(function(key) { selectionState[key] = checked; });
        document.querySelectorAll('.row-checkbox[data-key]').forEach(function(cb) {
            cb.checked = checked;
            var row = cb.closest('tr');
            checked ? row.classList.remove('row-deselected') : row.classList.add('row-deselected');
        });
        document.querySelectorAll('.qty-input[data-key]').forEach(function(inp) { inp.disabled = !checked; });
        document.querySelectorAll('.vendor-select-all').forEach(function(cb) { cb.checked = checked; });
        updateVendorHeaderCounts();
    }

    function updateVendorHeaderCounts() {
        document.querySelectorAll('.vendor-select-all').forEach(function(cb) {
            var vendorId = parseInt(cb.getAttribute('data-vendor-id'));
            var partCount = 0;
            var selectedCount = 0;
            allResults.forEach(function(item) {
                if (item.vendor_id === vendorId) {
                    partCount++;
                    if (selectionState[item.vendor_id + '_' + item.part_id]) selectedCount++;
                }
            });
            cb.checked = (selectedCount === partCount && partCount > 0);

            // Update count badge
            var badge = document.querySelector('.vendor-count-badge[data-vendor-id="' + vendorId + '"]');
            if (badge) badge.textContent = '(' + selectedCount + '/' + partCount + ' selected)';
        });
    }

    // ============================================
    // Qty Override
    // ============================================
    function updateQtyOverride(key, value) {
        var num = parseFloat(value);
        if (isNaN(num) || num < 0) num = 0;
        qtyOverrides[key] = num;
    }

    // ============================================
    // Create PO for Vendor
    // ============================================
    function createPoForVendor(vendorId) {
        var selectedItems = [];
        allResults.forEach(function(item) {
            if (item.vendor_id !== vendorId) return;
            var key = item.vendor_id + '_' + item.part_id;
            if (!selectionState[key]) return;

            var qty = qtyOverrides[key] !== undefined ? qtyOverrides[key] : (parseFloat(item.qty_suggested) || 0);
            if (qty <= 0) return;

            selectedItems.push({
                partId: item.part_id,
                partNum: item.part_num,
                partDescription: item.part_description,
                qty: qty,
                uomId: item.vendor_uom_id || item.part_uom_id,
                uomCode: item.vendor_uom_code || item.part_uom_code,
                lastCost: parseFloat(item.last_cost) || 0,
                locationGroupId: item.location_group_id || 0
            });
        });

        if (selectedItems.length === 0) {
            showStatus('No parts selected with qty > 0 for this vendor.', 'warning');
            return;
        }

        var vendorName = '';
        allResults.forEach(function(item) {
            if (item.vendor_id === vendorId && !vendorName) vendorName = item.vendor_name;
        });

        // Confirm with user
        var totalQty = 0;
        selectedItems.forEach(function(i) { totalQty += i.qty; });
        var confirmMsg = 'Create PO for ' + vendorName + '?\n\n' +
            selectedItems.length + ' line item(s), ' + totalQty + ' total qty.\n\n' +
            'Items:\n';
        selectedItems.forEach(function(i) {
            confirmMsg += '  ' + i.partNum + ' - Qty: ' + i.qty + '\n';
        });

        if (!confirm(confirmMsg)) return;

        try {
            var locationGroupId = parseInt(document.getElementById('paramLocationGroup').value);
            var lgId = locationGroupId === -1 ? 0 : locationGroupId;

            // Build PO import CSV
            var csvLines = [];
            csvLines.push('"Flag","POType","Status","VendorName","VendorContact","RemitToName","RemitToAddress","RemitToCity","RemitToState","RemitToZip","RemitToCountry","ShipToName","DeliverToName","BLType","FOBPointName","CarrierName","CarrierServiceName","PaymentTermsName","Note","CustomerSO","DateCreated","Vendor SO Num","DateScheduled","DateExpired","Phone","Fax","Email","URL","CurrencyName","CurrencyRate","LocationGroupName","BuyerId","Buyer","PriorityId","QuickBooksClassName","CF-Custom"');
            csvLines.push('"PO",20,"Bid Request","' + vendorName.replace(/"/g, '""') + '","","","","","","","","","","","","","","","Auto PO from BI Report","","","","","","","","","","","","",' + lgId + ',"","",0,"",""');

            selectedItems.forEach(function(item) {
                csvLines.push('"Item",10,"' + item.partNum.replace(/"/g, '""') + '","","","' + item.qty + '","' + item.uomCode + '","' + item.lastCost + '","",""');
            });

            var csvData = csvLines.join('\n');

            try {
                var importResult = importData('ImportPurchaseOrder', csvData);
                showStatus('PO created successfully for ' + vendorName + '! ' + selectedItems.length + ' line items.', 'success');
            } catch (importErr) {
                console.error('Import failed:', importErr);
                showStatus('PO data prepared for ' + vendorName + '. Auto-import may not be available. Check console for details.', 'warning');
                console.log('PO Import Data for ' + vendorName + ':\n' + csvData);
            }
        } catch (e) {
            console.error('createPoForVendor error:', e);
            showStatus('Error creating PO: ' + e.message, 'error');
        }
    }

    // ============================================
    // Export / Print
    // ============================================
    function exportToCSV() {
        if (dataTable) dataTable.button(0).trigger();
    }

    function printTable() {
        if (dataTable) dataTable.button(1).trigger();
    }

    // ============================================
    // Initialize on Ready
    // ============================================
    $(document).ready(function() {
        initParameters();
    });

    </script>
</body>
</html>
