<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dev Testing Tool - Fishbowl BI</title>

    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        :root {
            --color-primary: #2d9cdb;
            --color-primary-dark: #1e7bb4;
        }

        /* Tailwind overrides */
        .bg-indigo-600 { background-color: var(--color-primary) !important; }
        .hover\:bg-indigo-700:hover { background-color: var(--color-primary-dark) !important; }
        .text-indigo-600 { color: var(--color-primary) !important; }
        .border-indigo-300 { border-color: rgba(45, 156, 219, 0.4) !important; }
        .focus\:ring-indigo-500:focus { --tw-ring-color: var(--color-primary) !important; }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* SQL Editor */
        .sql-editor {
            font-family: 'Courier New', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.6;
            tab-size: 4;
            resize: vertical;
        }

        /* Results Table */
        .results-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .results-table th {
            background-color: #f8fafc;
            padding: 10px 12px;
            text-align: left;
            font-size: 11px;
            font-weight: 700;
            color: #475569;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
            cursor: pointer;
            user-select: none;
        }
        .results-table th:hover { background-color: #e9ecef; }
        .results-table td {
            padding: 8px 12px;
            border-bottom: 1px solid #e2e8f0;
            color: #334155;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .results-table tbody tr:hover { background-color: #f0f9ff; }
        .results-table tbody tr:nth-child(even) { background-color: #fafafa; }
        .results-table tbody tr:nth-child(even):hover { background-color: #f0f9ff; }

        /* JSON Output */
        .json-output {
            font-family: 'Courier New', 'Consolas', monospace;
            font-size: 12px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .json-key { color: #7c3aed; }
        .json-string { color: #059669; }
        .json-number { color: #2563eb; }
        .json-boolean { color: #dc2626; }
        .json-null { color: #6b7280; }

        /* Tab styles */
        .tab-btn { transition: all 0.2s ease; }
        .tab-btn.active {
            background-color: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        /* Spinner */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .spinner-sm {
            border: 2px solid #e2e8f0;
            border-top: 2px solid var(--color-primary);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 0.8s linear infinite;
            display: inline-block;
        }
    </style>
</head>

<body class="bg-slate-50">
    <div class="flex flex-col h-screen">

        <!-- Header -->
        <header class="bg-white border-b border-slate-200 px-6 py-3 flex items-center justify-between flex-shrink-0 shadow-sm">
            <div class="flex items-center gap-4">
                <div>
                    <h1 class="text-lg font-bold text-slate-900">Dev Testing Tool</h1>
                    <p class="text-xs text-slate-500">SQL Query Runner &amp; JS Function Tester</p>
                </div>
                <div id="connectionStatus" class="flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-slate-100 text-slate-500">
                    <span class="w-2 h-2 rounded-full bg-slate-400"></span>
                    Checking...
                </div>
            </div>

            <!-- Tab Navigation -->
            <div class="flex items-center gap-2">
                <button onclick="switchTab('sql')" id="tabSql" class="tab-btn active px-4 py-2 text-sm font-semibold rounded-lg border border-slate-300">
                    SQL Query
                </button>
                <button onclick="switchTab('functions')" id="tabFunctions" class="tab-btn px-4 py-2 text-sm font-semibold rounded-lg border border-slate-300 text-slate-600 hover:bg-slate-50">
                    JS Functions
                </button>
                <button onclick="switchTab('currency')" id="tabCurrency" class="tab-btn px-4 py-2 text-sm font-semibold rounded-lg border border-slate-300 text-slate-600 hover:bg-slate-50">
                    Currency Locale
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <div class="flex-1 overflow-hidden">

            <!-- ============================================
                 TAB 1: SQL QUERY RUNNER
                 ============================================ -->
            <div id="panelSql" class="h-full flex flex-col">
                <!-- SQL Input Area -->
                <div class="flex-shrink-0 p-4 pb-0">
                    <div class="bg-white rounded-xl shadow-md border border-slate-300 p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-sm font-bold text-slate-700 flex items-center gap-2">
                                <svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/>
                                </svg>
                                SQL Query
                            </h3>
                            <div class="flex items-center gap-2">
                                <select id="sqlPresets" onchange="loadSqlPreset()" class="px-2 py-1 text-xs border border-slate-300 rounded-lg text-slate-600 font-medium">
                                    <option value="">-- Preset Queries --</option>
                                    <option value="tables">Show All Tables</option>
                                    <option value="columns">Show Table Columns</option>
                                    <option value="properties">System Properties</option>
                                    <option value="currency">Home Currency</option>
                                    <option value="customers">Active Customers</option>
                                    <option value="vendors">Active Vendors</option>
                                    <option value="locations">Location Groups</option>
                                    <option value="so_recent">Recent Sales Orders</option>
                                    <option value="po_recent">Recent Purchase Orders</option>
                                    <option value="wo_recent">Recent Work Orders</option>
                                    <option value="inventory">Inventory Summary</option>
                                </select>
                                <button onclick="clearSqlEditor()" class="px-2 py-1 text-xs text-slate-500 hover:text-red-600 hover:bg-red-50 rounded transition-colors">
                                    Clear
                                </button>
                                <button onclick="runSqlQuery()" class="px-4 py-1.5 bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-semibold rounded-lg transition-colors flex items-center gap-1.5">
                                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                                    </svg>
                                    Run Query
                                </button>
                            </div>
                        </div>
                        <textarea id="sqlInput" class="sql-editor w-full bg-slate-50 border border-slate-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-slate-800" rows="6" placeholder="Enter your SQL query here...&#10;&#10;Example:&#10;SELECT So.Num, Customer.Name, So.TotalPrice&#10;FROM So&#10;LEFT JOIN Customer ON So.CustomerId = Customer.Id&#10;ORDER BY So.DateIssued DESC&#10;LIMIT 20" spellcheck="false"></textarea>
                        <div class="flex items-center justify-between mt-2">
                            <span class="text-xs text-slate-400">Ctrl+Enter to run | Fishbowl tables use PascalCase</span>
                            <span id="sqlStatus" class="text-xs text-slate-400"></span>
                        </div>
                    </div>
                </div>

                <!-- SQL Results Area -->
                <div class="flex-1 overflow-hidden p-4 pt-3">
                    <div class="bg-white rounded-xl shadow-md border border-slate-300 h-full flex flex-col">
                        <div class="flex items-center justify-between px-4 py-3 border-b border-slate-200 flex-shrink-0">
                            <div class="flex items-center gap-3">
                                <h3 class="text-sm font-bold text-slate-700">Results</h3>
                                <span id="sqlRowCount" class="text-xs text-slate-400"></span>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="toggleSqlView('table')" id="viewTable" class="px-2 py-1 text-xs font-medium rounded bg-slate-100 text-slate-700 border border-slate-200">Table</button>
                                <button onclick="toggleSqlView('json')" id="viewJson" class="px-2 py-1 text-xs font-medium rounded text-slate-500 border border-slate-200 hover:bg-slate-50">JSON</button>
                                <button onclick="exportSqlResults()" class="px-2 py-1 text-xs text-slate-500 hover:text-indigo-600 rounded border border-slate-200 hover:bg-slate-50">Export CSV</button>
                            </div>
                        </div>
                        <div class="flex-1 overflow-auto custom-scrollbar p-4">
                            <div id="sqlResultsTable"></div>
                            <div id="sqlResultsJson" class="hidden"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ============================================
                 TAB 2: JS FUNCTION TESTER
                 ============================================ -->
            <div id="panelFunctions" class="h-full flex flex-col hidden">
                <div class="flex-1 overflow-y-auto custom-scrollbar p-4">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">

                        <!-- Function Runner -->
                        <div class="bg-white rounded-xl shadow-md border border-slate-300 p-4">
                            <h3 class="text-sm font-bold text-slate-700 mb-3 flex items-center gap-2">
                                <svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/>
                                </svg>
                                Custom Function Runner
                            </h3>
                            <textarea id="jsInput" class="sql-editor w-full bg-slate-50 border border-slate-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-slate-800" rows="8" placeholder="Enter JavaScript to execute...&#10;&#10;Example:&#10;const result = JSON.parse(runQuery('SELECT code FROM currency WHERE homeCurrency = 1'));&#10;return result;" spellcheck="false"></textarea>
                            <div class="flex items-center justify-between mt-2">
                                <span class="text-xs text-slate-400">Use 'return' to output a value</span>
                                <button onclick="runCustomFunction()" class="px-4 py-1.5 bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-semibold rounded-lg transition-colors">
                                    Run
                                </button>
                            </div>
                            <div id="customFnOutput" class="mt-3 bg-slate-900 rounded-lg p-3 min-h-[100px] max-h-[300px] overflow-auto custom-scrollbar">
                                <div class="json-output text-slate-400 italic">Output will appear here...</div>
                            </div>
                        </div>

                        <!-- Built-in Function Tests -->
                        <div class="bg-white rounded-xl shadow-md border border-slate-300 p-4">
                            <h3 class="text-sm font-bold text-slate-700 mb-3 flex items-center gap-2">
                                <svg class="w-4 h-4 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                Built-in Function Tests
                            </h3>
                            <p class="text-xs text-slate-500 mb-3">Click to run each function and see the JSON output</p>

                            <div class="space-y-2" id="functionTestList">
                                <!-- Populated by initFunctionTests() -->
                            </div>

                            <!-- Aggregate output -->
                            <div class="mt-4">
                                <div class="flex items-center justify-between mb-2">
                                    <h4 class="text-xs font-bold text-slate-600 uppercase tracking-wide">Output</h4>
                                    <button onclick="runAllTests()" class="px-3 py-1 text-xs bg-emerald-50 text-emerald-700 hover:bg-emerald-100 rounded-lg font-semibold border border-emerald-200 transition-colors">
                                        Run All Tests
                                    </button>
                                </div>
                                <div id="testOutput" class="bg-slate-900 rounded-lg p-3 min-h-[200px] max-h-[400px] overflow-auto custom-scrollbar">
                                    <div class="json-output text-slate-400 italic">Click a test to see results...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ============================================
                 TAB 3: CURRENCY LOCALE TESTER
                 ============================================ -->
            <div id="panelCurrency" class="h-full flex flex-col hidden">
                <div class="flex-1 overflow-y-auto custom-scrollbar p-4">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">

                        <!-- Interactive Currency Tester -->
                        <div class="bg-white rounded-xl shadow-md border border-slate-300 p-4">
                            <h3 class="text-sm font-bold text-slate-700 mb-3 flex items-center gap-2">
                                <svg class="w-4 h-4 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                currencyLocale() Tester
                            </h3>
                            <p class="text-xs text-slate-500 mb-4">
                                Uses <code class="bg-slate-100 px-1 rounded">Intl.NumberFormat</code> to automatically resolve currency symbols
                                from ISO 4217 codes. No lookup table needed.
                            </p>

                            <!-- Single Currency Test -->
                            <div class="flex items-end gap-3 mb-4">
                                <div class="flex-1">
                                    <label class="block text-[11px] font-semibold text-slate-600 mb-1.5 uppercase tracking-wide">Currency Code</label>
                                    <input type="text" id="currencyCode" value="USD" maxlength="3"
                                        class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm font-mono uppercase focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                        placeholder="e.g. USD, EUR, AUD">
                                </div>
                                <div class="flex-1">
                                    <label class="block text-[11px] font-semibold text-slate-600 mb-1.5 uppercase tracking-wide">Locale (optional)</label>
                                    <input type="text" id="currencyLocaleInput" value=""
                                        class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm font-mono focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                        placeholder="e.g. en, en-AU, de-DE">
                                </div>
                                <button onclick="testSingleCurrency()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-semibold rounded-lg transition-colors whitespace-nowrap">
                                    Test
                                </button>
                            </div>

                            <div id="singleCurrencyResult" class="bg-slate-50 rounded-lg p-4 border border-slate-200 mb-4">
                                <div class="text-sm text-slate-400 italic">Enter a currency code and click Test</div>
                            </div>

                            <!-- Test Amount Formatting -->
                            <div class="border-t border-slate-200 pt-4">
                                <h4 class="text-xs font-bold text-slate-600 uppercase tracking-wide mb-3">Format Test Amount</h4>
                                <div class="flex items-end gap-3">
                                    <div class="flex-1">
                                        <label class="block text-[11px] font-semibold text-slate-600 mb-1.5">Amount</label>
                                        <input type="number" id="testAmount" value="1234567.89"
                                            class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm font-mono focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    </div>
                                    <button onclick="testFormatAmount()" class="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 text-xs font-semibold rounded-lg border border-slate-300 transition-colors whitespace-nowrap">
                                        Format
                                    </button>
                                </div>
                                <div id="formatResult" class="mt-3 bg-slate-50 rounded-lg p-3 border border-slate-200">
                                    <div class="text-sm text-slate-400 italic">Will format using the tested currency</div>
                                </div>
                            </div>

                            <!-- DB Currency Test -->
                            <div class="border-t border-slate-200 pt-4 mt-4">
                                <h4 class="text-xs font-bold text-slate-600 uppercase tracking-wide mb-3">Fishbowl Home Currency</h4>
                                <button onclick="testDbCurrency()" class="px-4 py-2 bg-amber-50 hover:bg-amber-100 text-amber-700 text-xs font-semibold rounded-lg border border-amber-200 transition-colors">
                                    Query Home Currency from DB
                                </button>
                                <div id="dbCurrencyResult" class="mt-3 bg-slate-50 rounded-lg p-3 border border-slate-200">
                                    <div class="text-sm text-slate-400 italic">Requires Fishbowl connection</div>
                                </div>
                            </div>
                        </div>

                        <!-- Currency Code Reference Table -->
                        <div class="bg-white rounded-xl shadow-md border border-slate-300 p-4">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="text-sm font-bold text-slate-700 flex items-center gap-2">
                                    <svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                    </svg>
                                    Currency Comparison: Intl API vs Lookup Table
                                </h3>
                                <button onclick="runCurrencyComparison()" class="px-3 py-1 text-xs bg-indigo-50 text-indigo-700 hover:bg-indigo-100 rounded-lg font-semibold border border-indigo-200 transition-colors">
                                    Run Comparison
                                </button>
                            </div>
                            <p class="text-xs text-slate-500 mb-3">
                                Compares <code class="bg-slate-100 px-1 rounded">currencyLocale()</code> (Intl API)
                                against the fixed lookup table to see if there are any differences.
                            </p>
                            <div class="overflow-auto custom-scrollbar" style="max-height: calc(100vh - 280px);">
                                <table class="results-table" id="currencyComparisonTable">
                                    <thead>
                                        <tr>
                                            <th>Code</th>
                                            <th>Currency</th>
                                            <th>Intl (narrowSymbol)</th>
                                            <th>Intl (symbol)</th>
                                            <th>Lookup Table</th>
                                            <th>Match?</th>
                                        </tr>
                                    </thead>
                                    <tbody id="currencyComparisonBody">
                                        <tr><td colspan="6" class="text-center text-slate-400 italic py-8">Click "Run Comparison" to generate</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        /* ============================================
           CONFIGURATION
           ============================================ */

        // Check Fishbowl connection
        const HAS_FISHBOWL = typeof runQuery === 'function';
        const HAS_GET_PROPERTY = typeof getProperty === 'function';

        // Date format from Fishbowl
        const FB_DATE_FORMAT = HAS_GET_PROPERTY ? getProperty('DateFormatShort', 'MM/dd/yyyy') : 'MM/dd/yyyy';
        const MOMENT_DATE_FORMAT = FB_DATE_FORMAT.replace(/yyyy/g, 'YYYY').replace(/yy/g, 'YY').replace(/dd/g, 'DD');

        // Price format from Fishbowl
        const PRICE_FORMAT = HAS_GET_PROPERTY ? getProperty('REPORT_DECIMAL_PRICE', '$ #,##0.00') : '$ #,##0.00';
        const DECIMAL_PLACES = (PRICE_FORMAT.match(/\.([0#]+)$/) || ['', '00'])[1].length;

        // FY start month
        const FY_START_MONTH = HAS_GET_PROPERTY ? parseInt(getProperty('BI_FY_START_MONTH', '7')) || 7 : 7;

        // SQL results state
        let currentSqlResults = [];
        let currentSqlColumns = [];
        let sqlSortColumn = null;
        let sqlSortDirection = 'asc';
        let currentSqlView = 'table';


        /* ============================================
           CURRENCY LOCALE FUNCTION
           ============================================
           This is the function being tested - uses Intl API
           instead of a fixed lookup table.
        */

        function currencyLocale(currencyCode, locale) {
            if (!currencyCode) return '$';
            try {
                const effectiveLocale = locale || 'en';
                const parts = new Intl.NumberFormat(effectiveLocale, {
                    style: 'currency',
                    currency: currencyCode.toUpperCase(),
                    currencyDisplay: 'narrowSymbol'
                }).formatToParts(0);
                const symbolPart = parts.find(p => p.type === 'currency');
                return symbolPart ? symbolPart.value : currencyCode;
            } catch (e) {
                try {
                    const parts = new Intl.NumberFormat(locale || 'en', {
                        style: 'currency',
                        currency: currencyCode.toUpperCase(),
                        currencyDisplay: 'symbol'
                    }).formatToParts(0);
                    const symbolPart = parts.find(p => p.type === 'currency');
                    return symbolPart ? symbolPart.value : currencyCode;
                } catch (e2) {
                    return currencyCode;
                }
            }
        }

        // Get symbol with a specific display mode
        function currencyLocaleWithDisplay(currencyCode, locale, displayMode) {
            if (!currencyCode) return '$';
            try {
                const parts = new Intl.NumberFormat(locale || 'en', {
                    style: 'currency',
                    currency: currencyCode.toUpperCase(),
                    currencyDisplay: displayMode
                }).formatToParts(0);
                const symbolPart = parts.find(p => p.type === 'currency');
                return symbolPart ? symbolPart.value : currencyCode;
            } catch (e) {
                return currencyCode;
            }
        }

        // Currency lookup table (same as Purchasing_Dashboard.htm)
        const CURRENCY_SYMBOLS = {
            'AUD': '$', 'USD': '$', 'NZD': '$', 'CAD': '$', 'SGD': '$',
            'HKD': '$', 'EUR': '\u20AC', 'GBP': '\u00A3', 'JPY': '\u00A5', 'CNY': '\u00A5',
            'CHF': 'CHF', 'SEK': 'kr', 'NOK': 'kr', 'DKK': 'kr', 'INR': '\u20B9',
            'ZAR': 'R', 'BRL': 'R$', 'MXN': '$', 'KRW': '\u20A9', 'THB': '\u0E3F',
            'MYR': 'RM', 'PHP': '\u20B1', 'IDR': 'Rp', 'AED': '\u062F.\u0625',
            'SAR': '\uFDFC', 'RUB': '\u20BD', 'PLN': 'z\u0142', 'TRY': '\u20BA',
            'ILS': '\u20AA', 'CZK': 'K\u010D', 'HUF': 'Ft', 'TWD': 'NT$', 'VND': '\u20AB'
        };

        // Resolve home currency symbol
        function getHomeCurrencySymbol() {
            try {
                if (!HAS_FISHBOWL) return '$';
                const query = `SELECT code FROM currency WHERE homeCurrency = 1 LIMIT 1`;
                const result = runQuery(query);
                if (result) {
                    const parsed = JSON.parse(result);
                    if (parsed && parsed.length > 0 && parsed[0].code) {
                        return currencyLocale(parsed[0].code.toUpperCase());
                    }
                }
            } catch (e) { /* fallback */ }
            return PRICE_FORMAT.match(/^[^#0,.\s]+/) ? PRICE_FORMAT.match(/^[^#0,.\s]+/)[0].trim() : '$';
        }

        const CURRENCY_SYMBOL = getHomeCurrencySymbol();


        /* ============================================
           UTILITY FUNCTIONS
           (Same as Core_Dashboard_Template.htm)
           ============================================ */

        function escapeSQL(str) {
            if (str === null || str === undefined) return '';
            return String(str).replace(/'/g, "''");
        }

        function formatCurrency(value, showDecimals = true) {
            const num = parseFloat(value || 0);
            const isNegative = num < 0;
            const absValue = Math.abs(num);
            const decimals = showDecimals ? DECIMAL_PLACES : 0;
            const formatted = absValue.toLocaleString('en-US', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            });
            return isNegative ? `-${CURRENCY_SYMBOL}${formatted}` : `${CURRENCY_SYMBOL}${formatted}`;
        }

        function formatNumber(value, decimals = 0) {
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            }).format(value || 0);
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            return moment(dateStr).format(MOMENT_DATE_FORMAT);
        }

        function getQuarterDates(quartersAgo) {
            const now = moment();
            const target = moment(now).startOf('quarter').subtract(quartersAgo, 'quarters');
            return {
                start: target.startOf('quarter').format('YYYY-MM-DD'),
                end: moment(target).endOf('quarter').format('YYYY-MM-DD')
            };
        }

        function getFYDates(yearsAgo) {
            const now = moment();
            const currentMonth = now.month() + 1;
            const currentYear = now.year();
            const fyStartMonth = Math.max(1, Math.min(12, FY_START_MONTH));
            let fyStartYear = currentMonth >= fyStartMonth ? currentYear : currentYear - 1;
            fyStartYear -= yearsAgo;
            let fyEndMonth, fyEndYear;
            if (fyStartMonth === 1) { fyEndMonth = 12; fyEndYear = fyStartYear; }
            else { fyEndMonth = fyStartMonth - 1; fyEndYear = fyStartYear + 1; }
            const endDate = moment([fyEndYear, fyEndMonth - 1, 1]).endOf('month');
            return {
                start: `${fyStartYear}-${String(fyStartMonth).padStart(2, '0')}-01`,
                end: endDate.format('YYYY-MM-DD')
            };
        }

        function getScheduleStatus(dateStr) {
            if (!dateStr) return '';
            const dateParts = dateStr.split(' ')[0].split('-');
            const schedDate = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
            schedDate.setHours(0, 0, 0, 0);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            if (schedDate.getTime() === today.getTime()) return 'orange';
            if (schedDate < today) return 'red';
            const todayDay = today.getDay();
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - todayDay);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            if (schedDate >= weekStart && schedDate <= weekEnd) return 'blue';
            return '';
        }


        /* ============================================
           TAB SWITCHING
           ============================================ */

        function switchTab(tab) {
            // Hide all panels
            document.getElementById('panelSql').classList.add('hidden');
            document.getElementById('panelFunctions').classList.add('hidden');
            document.getElementById('panelCurrency').classList.add('hidden');

            // Deactivate all tabs
            document.getElementById('tabSql').classList.remove('active');
            document.getElementById('tabFunctions').classList.remove('active');
            document.getElementById('tabCurrency').classList.remove('active');

            // Show selected
            document.getElementById('panel' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.remove('hidden');
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
        }


        /* ============================================
           SQL QUERY RUNNER
           ============================================ */

        const SQL_PRESETS = {
            tables: `SHOW TABLES`,
            columns: `-- Replace 'So' with any table name\nSHOW COLUMNS FROM So`,
            properties: `SELECT propertyName, propertyValue\nFROM sysProperty\nORDER BY propertyName\nLIMIT 50`,
            currency: `SELECT id, name, code, homeCurrency, rate\nFROM currency\nORDER BY homeCurrency DESC, name`,
            customers: `SELECT Customer.Id, Customer.Name, Customer.ActiveFlag\nFROM Customer\nWHERE Customer.ActiveFlag = 1\nORDER BY Customer.Name\nLIMIT 50`,
            vendors: `SELECT Vendor.Id, Vendor.Name, Vendor.ActiveFlag\nFROM Vendor\nWHERE Vendor.ActiveFlag = 1\nORDER BY Vendor.Name\nLIMIT 50`,
            locations: `SELECT LocationGroup.Id, LocationGroup.Name, LocationGroup.ActiveFlag\nFROM LocationGroup\nWHERE LocationGroup.ActiveFlag = 1\nORDER BY LocationGroup.Name`,
            so_recent: `SELECT\n    So.Num AS num,\n    Customer.Name AS customerName,\n    So.DateIssued AS dateIssued,\n    So.TotalPrice AS totalPrice,\n    SoStatus.Name AS statusName\nFROM So\nLEFT JOIN Customer ON So.CustomerId = Customer.Id\nLEFT JOIN SoStatus ON So.StatusId = SoStatus.Id\nORDER BY So.DateIssued DESC\nLIMIT 20`,
            po_recent: `SELECT\n    Po.Num AS num,\n    Vendor.Name AS vendorName,\n    Po.DateIssued AS dateIssued,\n    PoStatus.Name AS statusName\nFROM Po\nLEFT JOIN Vendor ON Po.VendorId = Vendor.Id\nLEFT JOIN PoStatus ON Po.StatusId = PoStatus.Id\nORDER BY Po.DateIssued DESC\nLIMIT 20`,
            wo_recent: `SELECT\n    Wo.Num AS num,\n    Wo.DateScheduled AS dateScheduled,\n    Wo.QtyScrapped,\n    Wo.QtyTarget,\n    WoStatus.Name AS statusName\nFROM Wo\nLEFT JOIN WoStatus ON Wo.StatusId = WoStatus.Id\nORDER BY Wo.DateScheduled DESC\nLIMIT 20`,
            inventory: `SELECT\n    Part.Num AS partNum,\n    Part.Description,\n    SUM(Tag.Qty) AS qtyOnHand,\n    Part.StdCost\nFROM Tag\nJOIN Part ON Tag.PartId = Part.Id\nWHERE Tag.Qty > 0\nGROUP BY Part.Num, Part.Description, Part.StdCost\nORDER BY qtyOnHand DESC\nLIMIT 30`
        };

        function loadSqlPreset() {
            const preset = document.getElementById('sqlPresets').value;
            if (preset && SQL_PRESETS[preset]) {
                document.getElementById('sqlInput').value = SQL_PRESETS[preset];
            }
            document.getElementById('sqlPresets').value = '';
        }

        function clearSqlEditor() {
            document.getElementById('sqlInput').value = '';
            document.getElementById('sqlResultsTable').innerHTML = '';
            document.getElementById('sqlResultsJson').innerHTML = '';
            document.getElementById('sqlRowCount').textContent = '';
            document.getElementById('sqlStatus').textContent = '';
            currentSqlResults = [];
            currentSqlColumns = [];
        }

        function runSqlQuery() {
            const sql = document.getElementById('sqlInput').value.trim();
            if (!sql) {
                alert('Please enter a SQL query');
                return;
            }

            if (!HAS_FISHBOWL) {
                document.getElementById('sqlStatus').textContent = 'Error: runQuery() not available (not running in Fishbowl)';
                document.getElementById('sqlStatus').className = 'text-xs text-red-500';

                // Show a demo result for testing outside Fishbowl
                const demoData = [
                    { id: 1, name: 'Demo Row 1', value: '100.00', status: 'Active' },
                    { id: 2, name: 'Demo Row 2', value: '250.50', status: 'Active' },
                    { id: 3, name: 'Demo Row 3', value: '75.25', status: 'Inactive' }
                ];
                displaySqlResults(demoData);
                document.getElementById('sqlRowCount').textContent = `${demoData.length} rows (demo data - not connected to Fishbowl)`;
                return;
            }

            const startTime = performance.now();
            document.getElementById('sqlStatus').textContent = 'Running...';
            document.getElementById('sqlStatus').className = 'text-xs text-blue-500';

            try {
                const result = runQuery(sql);
                const elapsed = (performance.now() - startTime).toFixed(0);

                if (!result) {
                    document.getElementById('sqlStatus').textContent = `Query returned no results (${elapsed}ms)`;
                    document.getElementById('sqlStatus').className = 'text-xs text-amber-500';
                    document.getElementById('sqlResultsTable').innerHTML = '<div class="text-center text-slate-400 py-8">No results returned</div>';
                    document.getElementById('sqlResultsJson').innerHTML = '';
                    currentSqlResults = [];
                    currentSqlColumns = [];
                    return;
                }

                const data = JSON.parse(result);
                displaySqlResults(data);

                document.getElementById('sqlRowCount').textContent = `${data.length} row${data.length !== 1 ? 's' : ''}`;
                document.getElementById('sqlStatus').textContent = `Success (${elapsed}ms, ${data.length} rows)`;
                document.getElementById('sqlStatus').className = 'text-xs text-green-600';

            } catch (error) {
                document.getElementById('sqlStatus').textContent = `Error: ${error.message}`;
                document.getElementById('sqlStatus').className = 'text-xs text-red-500';
                document.getElementById('sqlResultsTable').innerHTML = `<div class="text-center text-red-500 py-8">${error.message}</div>`;
            }
        }

        function displaySqlResults(data) {
            currentSqlResults = data;

            if (!data || data.length === 0) {
                document.getElementById('sqlResultsTable').innerHTML = '<div class="text-center text-slate-400 py-8">No results</div>';
                document.getElementById('sqlResultsJson').innerHTML = '';
                return;
            }

            // Get columns from first row
            currentSqlColumns = Object.keys(data[0]);

            renderSqlTable(data);
            renderSqlJson(data);
        }

        function renderSqlTable(data) {
            const container = document.getElementById('sqlResultsTable');
            const headers = currentSqlColumns.map((col, idx) =>
                `<th onclick="sortSqlResults(${idx})">${col}</th>`
            ).join('');

            const rows = data.map(row =>
                '<tr>' + currentSqlColumns.map(col => {
                    const val = row[col];
                    return `<td title="${String(val || '').replace(/"/g, '&quot;')}">${val !== null && val !== undefined ? val : '<span class="text-slate-300">NULL</span>'}</td>`;
                }).join('') + '</tr>'
            ).join('');

            container.innerHTML = `<table class="results-table"><thead><tr>${headers}</tr></thead><tbody>${rows}</tbody></table>`;
        }

        function renderSqlJson(data) {
            const container = document.getElementById('sqlResultsJson');
            container.innerHTML = `<pre class="json-output">${syntaxHighlightJson(JSON.stringify(data, null, 2))}</pre>`;
        }

        function sortSqlResults(columnIndex) {
            const col = currentSqlColumns[columnIndex];
            if (sqlSortColumn === columnIndex) {
                sqlSortDirection = sqlSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sqlSortColumn = columnIndex;
                sqlSortDirection = 'asc';
            }

            const sorted = [...currentSqlResults].sort((a, b) => {
                let aVal = a[col];
                let bVal = b[col];
                const aNum = parseFloat(aVal);
                const bNum = parseFloat(bVal);

                if (!isNaN(aNum) && !isNaN(bNum)) { aVal = aNum; bVal = bNum; }
                else { aVal = String(aVal || '').toLowerCase(); bVal = String(bVal || '').toLowerCase(); }

                return sqlSortDirection === 'asc' ? (aVal > bVal ? 1 : -1) : (aVal < bVal ? 1 : -1);
            });

            currentSqlResults = sorted;
            renderSqlTable(sorted);
        }

        function toggleSqlView(view) {
            currentSqlView = view;
            document.getElementById('sqlResultsTable').classList.toggle('hidden', view !== 'table');
            document.getElementById('sqlResultsJson').classList.toggle('hidden', view !== 'json');
            document.getElementById('viewTable').classList.toggle('bg-slate-100', view === 'table');
            document.getElementById('viewTable').classList.toggle('text-slate-700', view === 'table');
            document.getElementById('viewTable').classList.toggle('text-slate-500', view !== 'table');
            document.getElementById('viewJson').classList.toggle('bg-slate-100', view === 'json');
            document.getElementById('viewJson').classList.toggle('text-slate-700', view === 'json');
            document.getElementById('viewJson').classList.toggle('text-slate-500', view !== 'json');
        }

        function exportSqlResults() {
            if (!currentSqlResults || currentSqlResults.length === 0) {
                alert('No results to export');
                return;
            }
            const headers = currentSqlColumns.join(',');
            const rows = currentSqlResults.map(row =>
                currentSqlColumns.map(col => {
                    let value = row[col] || '';
                    if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                        value = `"${value.replace(/"/g, '""')}"`;
                    }
                    return value;
                }).join(',')
            ).join('\n');

            const csv = headers + '\n' + rows;
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `query_results_${moment().format('YYYY-MM-DD_HHmmss')}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }


        /* ============================================
           JS FUNCTION TESTER
           ============================================ */

        const FUNCTION_TESTS = [
            {
                name: 'currencyLocale("USD")',
                description: 'Get USD symbol via Intl API',
                fn: () => ({ result: currencyLocale('USD'), type: typeof currencyLocale('USD') })
            },
            {
                name: 'currencyLocale("AUD")',
                description: 'Get AUD symbol via Intl API',
                fn: () => ({ result: currencyLocale('AUD'), type: typeof currencyLocale('AUD') })
            },
            {
                name: 'currencyLocale("EUR")',
                description: 'Get EUR symbol via Intl API',
                fn: () => ({ result: currencyLocale('EUR'), type: typeof currencyLocale('EUR') })
            },
            {
                name: 'currencyLocale("GBP")',
                description: 'Get GBP symbol via Intl API',
                fn: () => ({ result: currencyLocale('GBP'), type: typeof currencyLocale('GBP') })
            },
            {
                name: 'currencyLocale("JPY")',
                description: 'Get JPY symbol via Intl API',
                fn: () => ({ result: currencyLocale('JPY'), type: typeof currencyLocale('JPY') })
            },
            {
                name: 'getHomeCurrencySymbol()',
                description: 'Resolve home currency from DB',
                fn: () => ({ result: CURRENCY_SYMBOL, source: HAS_FISHBOWL ? 'database' : 'fallback' })
            },
            {
                name: 'formatCurrency(1234567.89)',
                description: 'Format currency with resolved symbol',
                fn: () => ({
                    withDecimals: formatCurrency(1234567.89),
                    withoutDecimals: formatCurrency(1234567.89, false),
                    negative: formatCurrency(-500),
                    zero: formatCurrency(0)
                })
            },
            {
                name: 'formatNumber(1234567.89, 2)',
                description: 'Format number with commas',
                fn: () => ({
                    twoDecimals: formatNumber(1234567.89, 2),
                    noDecimals: formatNumber(1234567.89),
                    zero: formatNumber(0)
                })
            },
            {
                name: 'formatDate("2025-03-15 14:30:00")',
                description: 'Format SQL date to display format',
                fn: () => ({
                    result: formatDate('2025-03-15 14:30:00'),
                    format: MOMENT_DATE_FORMAT,
                    fbFormat: FB_DATE_FORMAT
                })
            },
            {
                name: 'getQuarterDates(0)',
                description: 'Current quarter date range',
                fn: () => ({
                    thisQuarter: getQuarterDates(0),
                    lastQuarter: getQuarterDates(1)
                })
            },
            {
                name: 'getFYDates(0)',
                description: 'Current financial year dates',
                fn: () => ({
                    thisFY: getFYDates(0),
                    lastFY: getFYDates(1),
                    fyStartMonth: FY_START_MONTH
                })
            },
            {
                name: 'getScheduleStatus()',
                description: 'Schedule indicator colors',
                fn: () => {
                    const today = moment().format('YYYY-MM-DD');
                    const yesterday = moment().subtract(1, 'days').format('YYYY-MM-DD');
                    const nextWeek = moment().add(8, 'days').format('YYYY-MM-DD');
                    const thisWeek = moment().add(2, 'days').format('YYYY-MM-DD');
                    return {
                        today: { date: today, status: getScheduleStatus(today), meaning: 'orange = due today' },
                        pastDue: { date: yesterday, status: getScheduleStatus(yesterday), meaning: 'red = past due' },
                        thisWeek: { date: thisWeek, status: getScheduleStatus(thisWeek), meaning: 'blue = this week' },
                        future: { date: nextWeek, status: getScheduleStatus(nextWeek), meaning: 'empty = future' }
                    };
                }
            },
            {
                name: 'System Properties',
                description: 'Current Fishbowl configuration',
                fn: () => ({
                    dateFormat: FB_DATE_FORMAT,
                    momentFormat: MOMENT_DATE_FORMAT,
                    priceFormat: PRICE_FORMAT,
                    decimalPlaces: DECIMAL_PLACES,
                    fyStartMonth: FY_START_MONTH,
                    currencySymbol: CURRENCY_SYMBOL,
                    hasFishbowl: HAS_FISHBOWL,
                    hasGetProperty: HAS_GET_PROPERTY
                })
            }
        ];

        function initFunctionTests() {
            const container = document.getElementById('functionTestList');
            container.innerHTML = FUNCTION_TESTS.map((test, idx) => `
                <div class="flex items-center justify-between p-2 bg-slate-50 rounded-lg hover:bg-slate-100 transition-colors cursor-pointer border border-slate-200"
                     onclick="runSingleTest(${idx})">
                    <div>
                        <code class="text-xs font-semibold text-indigo-600">${test.name}</code>
                        <p class="text-[10px] text-slate-500 mt-0.5">${test.description}</p>
                    </div>
                    <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                    </svg>
                </div>
            `).join('');
        }

        function runSingleTest(idx) {
            const test = FUNCTION_TESTS[idx];
            const output = document.getElementById('testOutput');
            try {
                const result = test.fn();
                output.innerHTML = `<div class="mb-2"><span class="text-blue-400 text-xs font-bold">${test.name}</span></div><pre class="json-output">${syntaxHighlightJson(JSON.stringify(result, null, 2))}</pre>`;
            } catch (error) {
                output.innerHTML = `<div class="mb-2"><span class="text-red-400 text-xs font-bold">${test.name}</span></div><pre class="json-output text-red-400">Error: ${error.message}</pre>`;
            }
        }

        function runAllTests() {
            const output = document.getElementById('testOutput');
            let html = '';

            FUNCTION_TESTS.forEach((test, idx) => {
                try {
                    const result = test.fn();
                    html += `<div class="mb-4"><div class="flex items-center gap-2 mb-1"><span class="text-green-400 text-[10px]">PASS</span> <span class="text-blue-400 text-xs font-bold">${test.name}</span></div><pre class="json-output text-xs">${syntaxHighlightJson(JSON.stringify(result, null, 2))}</pre></div>`;
                } catch (error) {
                    html += `<div class="mb-4"><div class="flex items-center gap-2 mb-1"><span class="text-red-400 text-[10px]">FAIL</span> <span class="text-red-400 text-xs font-bold">${test.name}</span></div><pre class="json-output text-red-400 text-xs">Error: ${error.message}</pre></div>`;
                }
            });

            output.innerHTML = html;
        }

        function runCustomFunction() {
            const code = document.getElementById('jsInput').value.trim();
            const output = document.getElementById('customFnOutput');

            if (!code) {
                output.innerHTML = '<div class="json-output text-slate-400 italic">Enter code to run</div>';
                return;
            }

            try {
                // Wrap in a function to support 'return' statements
                const fn = new Function(code);
                const result = fn();

                if (result !== undefined) {
                    const formatted = typeof result === 'object'
                        ? syntaxHighlightJson(JSON.stringify(result, null, 2))
                        : `<span class="text-green-400">${String(result)}</span>`;
                    output.innerHTML = `<pre class="json-output">${formatted}</pre>`;
                } else {
                    output.innerHTML = '<div class="json-output text-slate-400 italic">Function executed (no return value)</div>';
                }
            } catch (error) {
                output.innerHTML = `<pre class="json-output text-red-400">Error: ${error.message}\n\nStack: ${error.stack || 'N/A'}</pre>`;
            }
        }


        /* ============================================
           CURRENCY LOCALE TAB
           ============================================ */

        function testSingleCurrency() {
            const code = document.getElementById('currencyCode').value.trim().toUpperCase();
            const locale = document.getElementById('currencyLocaleInput').value.trim() || 'en';
            const container = document.getElementById('singleCurrencyResult');

            if (!code || code.length !== 3) {
                container.innerHTML = '<div class="text-sm text-red-500">Please enter a valid 3-letter currency code</div>';
                return;
            }

            try {
                const narrowSymbol = currencyLocaleWithDisplay(code, locale, 'narrowSymbol');
                const symbol = currencyLocaleWithDisplay(code, locale, 'symbol');
                const name = currencyLocaleWithDisplay(code, locale, 'name');
                const lookupSymbol = CURRENCY_SYMBOLS[code] || 'Not in lookup table';

                const formattedExample = new Intl.NumberFormat(locale, {
                    style: 'currency',
                    currency: code,
                    currencyDisplay: 'narrowSymbol'
                }).format(1234.56);

                container.innerHTML = `
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <div class="text-[10px] font-semibold text-slate-500 uppercase">narrowSymbol (recommended)</div>
                            <div class="text-2xl font-bold text-slate-900 mt-1">${narrowSymbol}</div>
                        </div>
                        <div>
                            <div class="text-[10px] font-semibold text-slate-500 uppercase">symbol</div>
                            <div class="text-2xl font-bold text-slate-900 mt-1">${symbol}</div>
                        </div>
                        <div>
                            <div class="text-[10px] font-semibold text-slate-500 uppercase">name</div>
                            <div class="text-sm text-slate-700 mt-1">${name}</div>
                        </div>
                        <div>
                            <div class="text-[10px] font-semibold text-slate-500 uppercase">Lookup Table</div>
                            <div class="text-sm text-slate-700 mt-1">${lookupSymbol}</div>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-slate-200">
                        <div class="text-[10px] font-semibold text-slate-500 uppercase">Formatted Example (1,234.56)</div>
                        <div class="text-lg font-bold text-indigo-600 mt-1">${formattedExample}</div>
                    </div>
                    <div class="mt-2 text-[10px] text-slate-400">Locale: ${locale} | Code: ${code}</div>
                `;
            } catch (error) {
                container.innerHTML = `<div class="text-sm text-red-500">Error: ${error.message}<br>This currency code may not be valid.</div>`;
            }
        }

        function testFormatAmount() {
            const amount = parseFloat(document.getElementById('testAmount').value) || 0;
            const code = document.getElementById('currencyCode').value.trim().toUpperCase() || 'USD';
            const locale = document.getElementById('currencyLocaleInput').value.trim() || 'en';
            const container = document.getElementById('formatResult');

            try {
                const symbol = currencyLocale(code, locale);

                // Format using our formatCurrency-style approach
                const formatted = amount.toLocaleString('en-US', {
                    minimumFractionDigits: DECIMAL_PLACES,
                    maximumFractionDigits: DECIMAL_PLACES
                });

                // Format using Intl.NumberFormat natively
                const intlFormatted = new Intl.NumberFormat(locale, {
                    style: 'currency',
                    currency: code,
                    currencyDisplay: 'narrowSymbol'
                }).format(amount);

                container.innerHTML = `
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <div class="text-[10px] font-semibold text-slate-500 uppercase">Our Format (symbol + localeString)</div>
                            <div class="text-lg font-bold text-slate-900 mt-1">${symbol}${formatted}</div>
                        </div>
                        <div>
                            <div class="text-[10px] font-semibold text-slate-500 uppercase">Native Intl.NumberFormat</div>
                            <div class="text-lg font-bold text-indigo-600 mt-1">${intlFormatted}</div>
                        </div>
                    </div>
                `;
            } catch (error) {
                container.innerHTML = `<div class="text-sm text-red-500">Error: ${error.message}</div>`;
            }
        }

        function testDbCurrency() {
            const container = document.getElementById('dbCurrencyResult');

            if (!HAS_FISHBOWL) {
                container.innerHTML = '<div class="text-sm text-amber-600">Not connected to Fishbowl. runQuery() is not available.</div>';
                return;
            }

            try {
                const query = `SELECT id, name, code, homeCurrency, rate FROM currency ORDER BY homeCurrency DESC, name`;
                const result = JSON.parse(runQuery(query));

                if (!result || result.length === 0) {
                    container.innerHTML = '<div class="text-sm text-slate-500">No currency records found</div>';
                    return;
                }

                const homeRow = result.find(r => r.homeCurrency === '1' || r.homeCurrency === 1);
                const homeCode = homeRow ? homeRow.code.toUpperCase() : 'N/A';
                const homeSymbol = homeRow ? currencyLocale(homeCode) : 'N/A';

                let html = `
                    <div class="mb-3 p-3 bg-green-50 rounded-lg border border-green-200">
                        <div class="text-xs font-semibold text-green-700">Home Currency</div>
                        <div class="text-lg font-bold text-green-900 mt-1">${homeCode} (${homeSymbol})</div>
                        <div class="text-xs text-green-600 mt-1">${homeRow ? homeRow.name : ''}</div>
                    </div>
                    <table class="results-table">
                        <thead><tr><th>Code</th><th>Name</th><th>Home?</th><th>Rate</th><th>Intl Symbol</th></tr></thead>
                        <tbody>
                `;

                result.forEach(row => {
                    const sym = currencyLocale(row.code.toUpperCase());
                    const isHome = row.homeCurrency === '1' || row.homeCurrency === 1;
                    html += `<tr class="${isHome ? 'bg-green-50' : ''}">
                        <td class="font-mono font-bold">${row.code}</td>
                        <td>${row.name}</td>
                        <td>${isHome ? 'Yes' : ''}</td>
                        <td>${row.rate}</td>
                        <td class="text-lg">${sym}</td>
                    </tr>`;
                });

                html += '</tbody></table>';
                container.innerHTML = html;

            } catch (error) {
                container.innerHTML = `<div class="text-sm text-red-500">Error: ${error.message}</div>`;
            }
        }

        function runCurrencyComparison() {
            const tbody = document.getElementById('currencyComparisonBody');

            // Extended list of currency codes to test
            const codes = [
                { code: 'AUD', name: 'Australian Dollar' },
                { code: 'USD', name: 'US Dollar' },
                { code: 'NZD', name: 'New Zealand Dollar' },
                { code: 'CAD', name: 'Canadian Dollar' },
                { code: 'SGD', name: 'Singapore Dollar' },
                { code: 'HKD', name: 'Hong Kong Dollar' },
                { code: 'EUR', name: 'Euro' },
                { code: 'GBP', name: 'British Pound' },
                { code: 'JPY', name: 'Japanese Yen' },
                { code: 'CNY', name: 'Chinese Yuan' },
                { code: 'CHF', name: 'Swiss Franc' },
                { code: 'SEK', name: 'Swedish Krona' },
                { code: 'NOK', name: 'Norwegian Krone' },
                { code: 'DKK', name: 'Danish Krone' },
                { code: 'INR', name: 'Indian Rupee' },
                { code: 'ZAR', name: 'South African Rand' },
                { code: 'BRL', name: 'Brazilian Real' },
                { code: 'MXN', name: 'Mexican Peso' },
                { code: 'KRW', name: 'South Korean Won' },
                { code: 'THB', name: 'Thai Baht' },
                { code: 'MYR', name: 'Malaysian Ringgit' },
                { code: 'PHP', name: 'Philippine Peso' },
                { code: 'IDR', name: 'Indonesian Rupiah' },
                { code: 'AED', name: 'UAE Dirham' },
                { code: 'SAR', name: 'Saudi Riyal' },
                { code: 'RUB', name: 'Russian Ruble' },
                { code: 'PLN', name: 'Polish Zloty' },
                { code: 'TRY', name: 'Turkish Lira' },
                { code: 'ILS', name: 'Israeli Shekel' },
                { code: 'CZK', name: 'Czech Koruna' },
                { code: 'HUF', name: 'Hungarian Forint' },
                { code: 'TWD', name: 'Taiwan Dollar' },
                { code: 'VND', name: 'Vietnamese Dong' },
            ];

            tbody.innerHTML = codes.map(item => {
                const narrow = currencyLocaleWithDisplay(item.code, 'en', 'narrowSymbol');
                const symbol = currencyLocaleWithDisplay(item.code, 'en', 'symbol');
                const lookup = CURRENCY_SYMBOLS[item.code] || '-';
                const match = narrow === lookup;

                return `<tr>
                    <td class="font-mono font-bold">${item.code}</td>
                    <td>${item.name}</td>
                    <td class="text-lg text-center">${narrow}</td>
                    <td class="text-lg text-center">${symbol}</td>
                    <td class="text-lg text-center">${lookup}</td>
                    <td class="text-center">
                        ${match
                            ? '<span class="text-green-600 font-bold">Yes</span>'
                            : '<span class="text-amber-600 font-bold">Diff</span>'
                        }
                    </td>
                </tr>`;
            }).join('');
        }


        /* ============================================
           JSON SYNTAX HIGHLIGHTING
           ============================================ */

        function syntaxHighlightJson(json) {
            return json.replace(/("(\\u[\da-fA-F]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function(match) {
                let cls = 'json-number';
                if (/^"/.test(match)) {
                    cls = /:$/.test(match) ? 'json-key' : 'json-string';
                } else if (/true|false/.test(match)) {
                    cls = 'json-boolean';
                } else if (/null/.test(match)) {
                    cls = 'json-null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }


        /* ============================================
           KEYBOARD SHORTCUTS
           ============================================ */

        document.addEventListener('keydown', function(e) {
            // Ctrl+Enter to run SQL query
            if (e.ctrlKey && e.key === 'Enter') {
                const activeElement = document.activeElement;
                if (activeElement && activeElement.id === 'sqlInput') {
                    e.preventDefault();
                    runSqlQuery();
                } else if (activeElement && activeElement.id === 'jsInput') {
                    e.preventDefault();
                    runCustomFunction();
                }
            }
        });


        /* ============================================
           INITIALIZATION
           ============================================ */

        window.addEventListener('DOMContentLoaded', function() {
            // Update connection status
            const statusEl = document.getElementById('connectionStatus');
            if (HAS_FISHBOWL) {
                statusEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500"></span> Connected to Fishbowl';
                statusEl.className = 'flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-green-50 text-green-700';
            } else {
                statusEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-amber-500"></span> Standalone Mode';
                statusEl.className = 'flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-amber-50 text-amber-700';
            }

            // Initialize function tests
            initFunctionTests();
        });
    </script>
</body>
</html>
