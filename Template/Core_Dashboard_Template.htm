<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Name - Fishbowl BI</title>

    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        /* ============================================
           GLOBAL STYLES & CSS VARIABLES
           ============================================ */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        :root {
            /* Brand Colors */
            --color-primary: #2d9cdb;
            --color-primary-dark: #1e7bb4;
            --color-sidebar: #06162d;
            --color-sidebar-hover: #0a1f3d;
        }

        /* ============================================
           TAILWIND COLOR OVERRIDES
           ============================================ */
        .bg-indigo-600 { background-color: var(--color-primary) !important; }
        .bg-indigo-50 { background-color: rgba(45, 156, 219, 0.1) !important; }
        .hover\:bg-indigo-700:hover { background-color: var(--color-primary-dark) !important; }
        .text-indigo-600 { color: var(--color-primary) !important; }
        .text-indigo-700 { color: var(--color-primary-dark) !important; }
        .border-indigo-200 { border-color: rgba(45, 156, 219, 0.3) !important; }
        .border-indigo-300 { border-color: rgba(45, 156, 219, 0.4) !important; }
        .hover\:text-indigo-600:hover { color: var(--color-primary) !important; }
        .hover\:bg-indigo-50:hover { background-color: rgba(45, 156, 219, 0.1) !important; }
        .hover\:bg-indigo-100:hover { background-color: rgba(45, 156, 219, 0.15) !important; }
        .focus\:ring-indigo-100:focus { --tw-ring-color: rgba(45, 156, 219, 0.2) !important; }
        .focus\:ring-indigo-500:focus { --tw-ring-color: var(--color-primary) !important; }
        .focus\:border-indigo-300:focus { border-color: rgba(45, 156, 219, 0.4) !important; }

        /* ============================================
           CUSTOM SCROLLBAR
           ============================================ */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* ============================================
           LOADING SPINNER
           ============================================ */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner {
            border: 3px solid #f1f5f9;
            border-top: 3px solid var(--color-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        /* ============================================
           D3 CHART STYLES
           ============================================ */
        .axis line, .axis path { stroke: #cbd5e1; shape-rendering: crispEdges; }
        .axis text { fill: #64748b; font-size: 11px; font-weight: 500; }
        .grid line { stroke: #e2e8f0; stroke-opacity: 0.7; shape-rendering: crispEdges; }
        .line { fill: none; stroke-width: 2.5px; }

        .tooltip {
            position: absolute;
            background: rgba(15, 23, 42, 0.95);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            max-width: 300px;
        }

        .tooltip-label { color: #94a3b8; display: inline-block; min-width: 90px; font-weight: 500; }
        .tooltip-value { color: #ffffff; font-weight: 600; margin-left: 8px; }

        /* ============================================
           CLICKABLE LINKS (Order #, SO #, PO #, etc.)
           ============================================ */
        .order-link {
            color: var(--color-primary);
            text-decoration: none;
            font-weight: 600;
            transition: color 0.2s ease;
            cursor: pointer;
        }
        .order-link:hover { color: var(--color-primary-dark); text-decoration: underline; }

        /* ============================================
           TABLE STYLES
           ============================================ */
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th {
            background-color: #f8fafc;
            padding: 12px 16px;
            text-align: left;
            font-size: 11px;
            font-weight: 700;
            color: #475569;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }
        .data-table th:hover { background-color: #e9ecef; }
        .data-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 13px;
            color: #334155;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .data-table tbody tr:hover { background-color: #f8fafc; }
        .data-table tbody tr:nth-child(even) { background-color: #fafafa; }
        .data-table tbody tr:nth-child(even):hover { background-color: #f8fafc; }

        /* ============================================
           STATUS BADGES
           ============================================ */
        .status-badge { display: inline-block; padding: 2px 8px; border-radius: 3px; font-size: 11px; font-weight: 600; }
        .status-estimate { background: #fff3cd; color: #856404; }
        .status-issued { background: #d4edda; color: #155724; }
        .status-inprogress { background: #cce5ff; color: #004085; }
        .status-partial { background: #fff3cd; color: #856404; }
        .status-fulfilled { background: #c3e6cb; color: #0f5132; }
        .status-closed { background: #e2e8f0; color: #475569; }

        /* ============================================
           SCHEDULE & AVAILABILITY INDICATORS
           ============================================ */
        .clock-icon { width: 16px; height: 16px; display: inline-block; vertical-align: middle; }
        .status-circle { width: 16px; height: 16px; border-radius: 50%; display: inline-block; vertical-align: middle; border: 2px solid transparent; }
        .status-circle.green { background-color: #10b981; border-color: #059669; }
        .status-circle.orange { background-color: #fff3cd; border-color: #b8860b; }
        .status-circle.red { background-color: #ef4444; border-color: #dc2626; }
        .status-circle.gray { background-color: #9ca3af; border-color: #6b7280; }

        /* ============================================
           FILTER ROW (for inline column filtering)
           ============================================ */
        .filter-row td { padding: 4px 6px; }
        .filter-row input {
            width: 100%;
            padding: 3px 4px;
            font-size: 10px;
            border: 1px solid #cbd5e1;
            border-radius: 3px;
        }
        .filter-row input:focus { outline: none; border-color: #2d9cdb; }
    </style>
</head>

<body class="bg-slate-50">
    <!-- ============================================
         MAIN LAYOUT
         ============================================ -->
    <div class="flex flex-col h-screen">

        <!-- HEADER -->
        <header class="h-20 bg-white border-b border-slate-200 px-8 flex items-center justify-between flex-shrink-0 z-20 shadow-sm">
            <!-- Left: Title + KPI Cards -->
            <div class="flex items-center gap-6">
                <div>
                    <h1 class="text-xl font-bold text-slate-900">
                        Dashboard Title
                        <span id="dateRangeDisplay" class="text-sm font-normal text-slate-500 ml-2"></span>
                    </h1>
                    <p class="text-xs text-slate-500 mt-0.5">Subtitle description</p>
                </div>

                <!-- KPI Cards - Populated dynamically -->
                <div id="kpiCards" class="hidden lg:flex items-center gap-3">
                    <!-- KPI cards rendered by updateKPIs() -->
                </div>
            </div>

            <!-- Right: Action Buttons -->
            <div class="flex items-center gap-3">
                <button onclick="exportToCSV()"
                    class="px-3 py-2 bg-slate-100 hover:bg-slate-200 border border-slate-300 text-slate-700 rounded-lg text-xs font-semibold transition-colors flex items-center gap-2">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Export CSV
                </button>
                <button onclick="loadDashboard()"
                    class="p-2.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-xl transition-all"
                    title="Refresh Data">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                </button>
            </div>
        </header>

        <!-- ============================================
             MAIN CONTENT AREA (Scrollable)
             ============================================ -->
        <div class="flex-1 overflow-y-auto custom-scrollbar">
            <div class="p-4 lg:p-8">

                <!-- FILTER CARD -->
                <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-4 mb-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-base font-bold text-slate-800 flex items-center gap-2">
                            <svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                            </svg>
                            <span>Filters</span>
                            <button onclick="clearAllFilters()"
                                class="ml-2 px-2 py-1 text-xs text-slate-500 hover:text-red-600 hover:bg-red-50 rounded transition-colors flex items-center gap-1"
                                title="Clear All Filters">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                                Clear
                            </button>
                        </h3>

                        <!-- Date Range Controls -->
                        <div class="flex items-center gap-1 bg-slate-50 px-2 py-1.5 rounded-lg border border-slate-200">
                            <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            <select id="dateRangeFilter" onchange="applyDateRange()"
                                class="px-2 py-0.5 text-xs border-0 bg-transparent focus:ring-0 focus:outline-none text-slate-700 font-semibold"
                                style="width: 180px;">
                                <option value="30">Last 30 Days</option>
                                <option value="60">Last 60 Days</option>
                                <option value="90">Last 90 Days</option>
                                <option value="180">Last 180 Days</option>
                                <option value="365">Last Year</option>
                                <option value="this_quarter">This Quarter</option>
                                <option value="last_quarter">Last Quarter</option>
                                <option value="current_fy" selected>Current Financial Year</option>
                                <option value="last_fy">Last Financial Year</option>
                                <option value="custom">Custom Date Range</option>
                            </select>
                        </div>
                    </div>

                    <!-- Filter Dropdowns Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
                        <!-- Example Filter 1: Customer/Vendor -->
                        <div>
                            <label class="block text-[11px] font-semibold text-slate-600 mb-1.5 uppercase tracking-wide">Customer</label>
                            <select id="customerFilter" onchange="loadDashboard()"
                                class="w-full px-2.5 py-1.5 bg-slate-50 border border-slate-300 rounded-lg text-sm font-medium text-slate-700 focus:outline-none focus:bg-white focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300 transition-all">
                                <option value="%">All Customers</option>
                                <!-- Populated via loadFilters() -->
                            </select>
                        </div>

                        <!-- Example Filter 2: Status -->
                        <div>
                            <label class="block text-[11px] font-semibold text-slate-600 mb-1.5 uppercase tracking-wide">Status</label>
                            <select id="statusFilter" onchange="loadDashboard()"
                                class="w-full px-2.5 py-1.5 bg-slate-50 border border-slate-300 rounded-lg text-sm font-medium text-slate-700 focus:outline-none focus:bg-white focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300 transition-all">
                                <option value="%">All Statuses</option>
                            </select>
                        </div>

                        <!-- Example Filter 3: Location -->
                        <div>
                            <label class="block text-[11px] font-semibold text-slate-600 mb-1.5 uppercase tracking-wide">Location</label>
                            <select id="locationFilter" onchange="loadDashboard()"
                                class="w-full px-2.5 py-1.5 bg-slate-50 border border-slate-300 rounded-lg text-sm font-medium text-slate-700 focus:outline-none focus:bg-white focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300 transition-all">
                                <option value="%">All Locations</option>
                            </select>
                        </div>

                        <!-- Example Filter 4: Category -->
                        <div>
                            <label class="block text-[11px] font-semibold text-slate-600 mb-1.5 uppercase tracking-wide">Category</label>
                            <select id="categoryFilter" onchange="loadDashboard()"
                                class="w-full px-2.5 py-1.5 bg-slate-50 border border-slate-300 rounded-lg text-sm font-medium text-slate-700 focus:outline-none focus:bg-white focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300 transition-all">
                                <option value="%">All Categories</option>
                            </select>
                        </div>
                    </div>

                    <!-- Custom Date Range (Hidden by default) -->
                    <div id="customDateRangeContainer" class="mt-3 p-3 bg-slate-50 rounded-lg border border-slate-200" style="display: none;">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-[11px] font-semibold text-slate-600 mb-1.5">Start Date</label>
                                <input type="date" id="customStartDate"
                                    class="w-full px-2.5 py-1.5 text-xs border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300">
                            </div>
                            <div>
                                <label class="block text-[11px] font-semibold text-slate-600 mb-1.5">End Date</label>
                                <input type="date" id="customEndDate"
                                    class="w-full px-2.5 py-1.5 text-xs border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300">
                            </div>
                        </div>
                        <button onclick="applyCustomDateRange()"
                            class="mt-2 px-3 py-1.5 bg-indigo-600 text-white text-xs font-medium rounded-lg hover:bg-indigo-700 transition-colors">
                            Apply Date Range
                        </button>
                    </div>
                </div>

                <!-- ============================================
                     CONTENT GRID - Charts & Tables
                     ============================================ -->

                <!-- Row 1: Main Chart + Summary Panel -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <!-- Chart Panel (2-col span) -->
                    <div class="lg:col-span-2 bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                                <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                </svg>
                                Monthly Trend
                            </h3>
                        </div>
                        <div id="chartContainer1" style="height: 280px;"></div>
                    </div>

                    <!-- Summary / Status Panel -->
                    <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                        <h3 class="text-lg font-bold text-slate-800 mb-4">Status Overview</h3>
                        <div id="statusChart"></div>
                    </div>
                </div>

                <!-- Row 2: Data Table -->
                <div class="grid grid-cols-1 gap-4 mt-4">
                    <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-slate-800">Data Table</h3>
                            <span id="tableCount" class="text-xs text-slate-500"></span>
                        </div>
                        <div class="overflow-auto custom-scrollbar" style="max-height: 400px;">
                            <table class="data-table" id="mainTable">
                                <thead id="mainTableHead">
                                    <!-- Populated dynamically -->
                                </thead>
                                <tbody id="mainTableBody">
                                    <!-- Populated dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Debug Console (hidden by default, shown if BI_SHOW_DEBUG=true) -->
                <div id="debugConsoleContainer" class="mt-6" style="display: none;">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                        <button onclick="toggleDebugConsole()" class="w-full px-6 py-3 flex items-center justify-between hover:bg-slate-50 transition-colors">
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/>
                                </svg>
                                <span class="text-sm font-semibold text-slate-700">Debug Console</span>
                                <span class="text-xs text-slate-400 font-normal">Auto-scrolls to latest entry</span>
                            </div>
                            <svg id="debugChevron" class="w-5 h-5 text-slate-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <div id="debugContent" class="hidden border-t border-slate-200">
                            <div class="bg-slate-900 px-4 py-2 flex items-center justify-between">
                                <span class="text-xs text-slate-400 font-mono">Query & Application Diagnostics</span>
                                <button onclick="clearDebugLog()" class="text-xs text-slate-400 hover:text-white transition-colors">Clear</button>
                            </div>
                            <div id="debugLog" class="bg-slate-950 text-slate-200 p-4 font-mono text-xs max-h-96 overflow-y-auto" style="scrollbar-width: thin;">
                                <div class="text-slate-500 italic">Waiting for application to initialize...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================
         LOADING OVERLAY
         ============================================ -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-xl p-8 flex flex-col items-center gap-4 shadow-2xl">
            <div class="spinner"></div>
            <p class="text-slate-700 font-semibold">Loading data...</p>
        </div>
    </div>

    <!-- ============================================
         DRILLDOWN MODAL
         ============================================ -->
    <div id="drilldownModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4" onclick="closeDrilldown(event)">
        <div class="bg-white rounded-2xl shadow-2xl w-11/12 max-w-6xl max-h-[90vh] flex flex-col" onclick="event.stopPropagation()">
            <!-- Modal Header -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-slate-200 flex-shrink-0">
                <div>
                    <h3 id="drilldownTitle" class="text-xl font-bold text-slate-900">Details</h3>
                    <p id="drilldownBreadcrumb" class="text-sm text-slate-500 mt-1"></p>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="exportDrilldownData()"
                        class="px-3 py-2 text-sm font-semibold text-slate-600 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-all flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        Export CSV
                    </button>
                    <button onclick="closeDrilldown()"
                        class="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Modal Body (Scrollable) -->
            <div class="flex-1 overflow-y-auto custom-scrollbar p-6">
                <!-- Search Box -->
                <div class="mb-4">
                    <input type="text" id="drilldownSearch" placeholder="Search..."
                        class="w-full px-4 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        oninput="filterDrilldownTable()">
                </div>
                <div class="overflow-x-auto">
                    <table class="data-table" id="drilldownTable">
                        <thead id="drilldownTableHead"></thead>
                        <tbody id="drilldownTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================
         JAVASCRIPT
         ============================================ -->
    <script>
        /* ============================================
           CONFIGURATION & GLOBAL STATE
           ============================================

           These settings are read from Fishbowl system properties.
           When running outside Fishbowl, fallback defaults are used.
        */

        // Financial Year start month (1-12, default 7 = July)
        const FY_START_MONTH = typeof getProperty === 'function'
            ? parseInt(getProperty('BI_FY_START_MONTH', '7')) || 7
            : 7;

        // Debug mode from Fishbowl system property
        const BI_SHOW_DEBUG_PROP = typeof getProperty === 'function'
            ? getProperty('BI_SHOW_DEBUG', 'false')
            : 'false';
        const DEBUG_MODE = BI_SHOW_DEBUG_PROP === 'true' || BI_SHOW_DEBUG_PROP === true;

        // Date format from Fishbowl system property (Java SimpleDateFormat)
        const FB_DATE_FORMAT = typeof getProperty === 'function'
            ? getProperty('DateFormatShort', 'MM/dd/yyyy')
            : 'MM/dd/yyyy';
        // Convert Java SimpleDateFormat to moment.js format (dd -> DD, yyyy -> YYYY)
        const MOMENT_DATE_FORMAT = FB_DATE_FORMAT
            .replace(/yyyy/g, 'YYYY')
            .replace(/yy/g, 'YY')
            .replace(/dd/g, 'DD');

        // Price formatting from Fishbowl system property
        const PRICE_FORMAT = typeof getProperty === 'function'
            ? getProperty('REPORT_DECIMAL_PRICE', '$ #,##0.00')
            : '$ #,##0.00';
        const DECIMAL_PLACES = (PRICE_FORMAT.match(/\.([0#]+)$/) || ['', '00'])[1].length;

        // Date range state
        let customStartDate = null;
        let customEndDate = null;

        // Drilldown state
        let currentDrilldownData = [];
        let currentDrilldownColumns = [];
        let currentSortColumn = null;
        let currentSortDirection = 'asc';

        // Color palette for charts
        const colorPalette = [
            '#2d9cdb', '#3b82f6', '#10b981', '#f59e0b', '#ef4444',
            '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16', '#f97316'
        ];

        // D3 Tooltip
        const tooltip = d3.select('body')
            .append('div')
            .attr('class', 'tooltip')
            .style('opacity', 0);


        /* ============================================
           CURRENCY FUNCTIONS
           ============================================

           Two approaches for getting the currency symbol:

           1. currencyLocale() - Uses the Intl API to automatically resolve
              the currency symbol from the currency code. No lookup table needed.

           2. getHomeCurrencySymbol() - Queries the database for the home
              currency code and uses a lookup table as fallback.
        */

        /**
         * Get locale-aware currency symbol using Intl.NumberFormat
         * This avoids needing a fixed lookup table of currency symbols.
         *
         * @param {string} currencyCode - ISO 4217 currency code (e.g. 'USD', 'AUD', 'EUR')
         * @param {string} [locale='en'] - BCP 47 locale string (e.g. 'en-US', 'en-AU', 'de-DE')
         * @returns {string} The currency symbol (e.g. '$', 'A$', 'EUR')
         */
        function currencyLocale(currencyCode, locale) {
            if (!currencyCode) return '$';
            try {
                // Use 'en' as default locale for broad compatibility
                const effectiveLocale = locale || 'en';
                const parts = new Intl.NumberFormat(effectiveLocale, {
                    style: 'currency',
                    currency: currencyCode.toUpperCase(),
                    currencyDisplay: 'narrowSymbol'
                }).formatToParts(0);

                const symbolPart = parts.find(p => p.type === 'currency');
                return symbolPart ? symbolPart.value : currencyCode;
            } catch (e) {
                // If narrowSymbol not supported, try symbol
                try {
                    const parts = new Intl.NumberFormat(locale || 'en', {
                        style: 'currency',
                        currency: currencyCode.toUpperCase(),
                        currencyDisplay: 'symbol'
                    }).formatToParts(0);
                    const symbolPart = parts.find(p => p.type === 'currency');
                    return symbolPart ? symbolPart.value : currencyCode;
                } catch (e2) {
                    return currencyCode;
                }
            }
        }

        /**
         * Get home currency symbol from database using Intl API
         * Falls back to parsing REPORT_DECIMAL_PRICE property
         */
        function getHomeCurrencySymbol() {
            try {
                if (typeof runQuery !== 'function') return '$';
                const query = `SELECT code FROM currency WHERE homeCurrency = 1 LIMIT 1`;
                const result = runQuery(query);
                if (result) {
                    const parsed = JSON.parse(result);
                    if (parsed && parsed.length > 0 && parsed[0].code) {
                        const code = parsed[0].code.toUpperCase();
                        const symbol = currencyLocale(code);
                        debugLog(`Home currency: ${code} -> Symbol: ${symbol}`, 'success');
                        return symbol;
                    }
                }
            } catch (e) {
                debugLog(`getHomeCurrencySymbol error: ${e.message}`, 'error');
            }
            // Fallback to parsing from REPORT_DECIMAL_PRICE
            return PRICE_FORMAT.match(/^[^#0,.\s]+/) ? PRICE_FORMAT.match(/^[^#0,.\s]+/)[0].trim() : '$';
        }

        // Resolve currency symbol at load time
        const CURRENCY_SYMBOL = getHomeCurrencySymbol();


        /* ============================================
           UTILITY FUNCTIONS
           ============================================ */

        /**
         * Escape SQL strings to prevent injection
         */
        function escapeSQL(str) {
            if (str === null || str === undefined) return '';
            return String(str).replace(/'/g, "''");
        }

        /**
         * Format currency values using resolved currency symbol
         * @param {number} value - The numeric value
         * @param {boolean} showDecimals - Whether to show decimal places (default true)
         */
        function formatCurrency(value, showDecimals = true) {
            const num = parseFloat(value || 0);
            const isNegative = num < 0;
            const absValue = Math.abs(num);
            const decimals = showDecimals ? DECIMAL_PLACES : 0;
            const formatted = absValue.toLocaleString('en-US', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            });
            return isNegative ? `-${CURRENCY_SYMBOL}${formatted}` : `${CURRENCY_SYMBOL}${formatted}`;
        }

        /**
         * Format number with commas
         */
        function formatNumber(value, decimals = 0) {
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            }).format(value || 0);
        }

        /**
         * Format date from SQL format to display format
         * Uses the Fishbowl DateFormatShort property
         */
        function formatDate(dateStr) {
            if (!dateStr) return '';
            return moment(dateStr).format(MOMENT_DATE_FORMAT);
        }


        /* ============================================
           DATE HANDLING
           ============================================ */

        /**
         * Get quarter date range
         * @param {number} quartersAgo - 0=current, 1=last quarter, etc.
         */
        function getQuarterDates(quartersAgo) {
            const now = moment();
            const targetQuarterStart = moment(now).startOf('quarter').subtract(quartersAgo, 'quarters');
            return {
                start: targetQuarterStart.startOf('quarter').format('YYYY-MM-DD'),
                end: moment(targetQuarterStart).endOf('quarter').format('YYYY-MM-DD')
            };
        }

        /**
         * Get financial year dates
         * Configurable via BI_FY_START_MONTH property (1-12)
         * Default: July (7) to June (6)
         * @param {number} yearsAgo - 0=current FY, 1=last FY, etc.
         */
        function getFYDates(yearsAgo) {
            const now = moment();
            const currentMonth = now.month() + 1;
            const currentYear = now.year();
            const fyStartMonth = Math.max(1, Math.min(12, FY_START_MONTH));

            let fyStartYear = currentMonth >= fyStartMonth ? currentYear : currentYear - 1;
            fyStartYear -= yearsAgo;

            let fyEndMonth, fyEndYear;
            if (fyStartMonth === 1) {
                fyEndMonth = 12;
                fyEndYear = fyStartYear;
            } else {
                fyEndMonth = fyStartMonth - 1;
                fyEndYear = fyStartYear + 1;
            }

            const endDate = moment([fyEndYear, fyEndMonth - 1, 1]).endOf('month');
            return {
                start: `${fyStartYear}-${String(fyStartMonth).padStart(2, '0')}-01`,
                end: endDate.format('YYYY-MM-DD')
            };
        }

        /**
         * Get calendar year dates
         */
        function getCalendarYearDates(offset = 0) {
            const year = moment().year() - offset;
            return { start: `${year}-01-01`, end: `${year}-12-31` };
        }

        /**
         * Get active date range (resolves current selection to start/end dates)
         */
        function getDateRange() {
            return { start: customStartDate, end: customEndDate };
        }

        /**
         * Build SQL date condition based on current date selection
         * @param {string} dateColumn - The SQL column name for the date field
         */
        function getDateCondition(dateColumn) {
            if (customStartDate && customEndDate) {
                return `${dateColumn} BETWEEN '${customStartDate}' AND '${customEndDate}'`;
            }

            const rangeValue = document.getElementById('dateRangeFilter').value;
            let dates;

            switch (rangeValue) {
                case 'this_quarter': dates = getQuarterDates(0); break;
                case 'last_quarter': dates = getQuarterDates(1); break;
                case 'current_fy': dates = getFYDates(0); break;
                case 'last_fy': dates = getFYDates(1); break;
                default:
                    const days = parseInt(rangeValue);
                    if (!isNaN(days)) {
                        return `${dateColumn} >= DATE_SUB(CURDATE(), INTERVAL ${days} DAY)`;
                    }
                    dates = getFYDates(0);
            }

            return `${dateColumn} BETWEEN '${dates.start}' AND '${dates.end}'`;
        }


        /* ============================================
           DATE RANGE UI HANDLERS
           ============================================ */

        function applyDateRange() {
            const rangeValue = document.getElementById('dateRangeFilter').value;
            const customContainer = document.getElementById('customDateRangeContainer');

            if (rangeValue === 'custom') {
                customContainer.style.display = 'block';
                return;
            } else {
                customContainer.style.display = 'none';
            }

            if (rangeValue === 'this_quarter') {
                const dates = getQuarterDates(0);
                customStartDate = dates.start;
                customEndDate = dates.end;
            } else if (rangeValue === 'last_quarter') {
                const dates = getQuarterDates(1);
                customStartDate = dates.start;
                customEndDate = dates.end;
            } else if (rangeValue === 'current_fy') {
                const dates = getFYDates(0);
                customStartDate = dates.start;
                customEndDate = dates.end;
            } else if (rangeValue === 'last_fy') {
                const dates = getFYDates(1);
                customStartDate = dates.start;
                customEndDate = dates.end;
            } else {
                const days = parseInt(rangeValue);
                if (!isNaN(days)) {
                    customEndDate = moment().format('YYYY-MM-DD');
                    customStartDate = moment().subtract(days, 'days').format('YYYY-MM-DD');
                } else {
                    customStartDate = null;
                    customEndDate = null;
                }
            }

            updateDateRangeDisplay();
            loadDashboard();
        }

        function applyCustomDateRange() {
            const startInput = document.getElementById('customStartDate');
            const endInput = document.getElementById('customEndDate');

            if (startInput.value && endInput.value) {
                customStartDate = startInput.value;
                customEndDate = endInput.value;
                updateDateRangeDisplay();
                loadDashboard();
            }
        }

        function updateDateRangeDisplay() {
            const displayEl = document.getElementById('dateRangeDisplay');
            if (!displayEl) return;
            if (customStartDate && customEndDate) {
                displayEl.textContent = `(${formatDate(customStartDate)} - ${formatDate(customEndDate)})`;
            } else {
                displayEl.textContent = '';
            }
        }


        /* ============================================
           FILTER FUNCTIONS
           ============================================ */

        /**
         * Clear all filters and reload
         */
        function clearAllFilters() {
            document.getElementById('dateRangeFilter').value = 'current_fy';
            document.querySelectorAll('select[id$="Filter"]').forEach(select => {
                if (select.id !== 'dateRangeFilter') select.value = '%';
            });
            customStartDate = null;
            customEndDate = null;
            document.getElementById('customStartDate').value = '';
            document.getElementById('customEndDate').value = '';
            document.getElementById('customDateRangeContainer').style.display = 'none';

            // Re-apply the default date range
            const fyDates = getFYDates(0);
            customStartDate = fyDates.start;
            customEndDate = fyDates.end;
            updateDateRangeDisplay();
            loadDashboard();
        }

        /**
         * Build SQL filter conditions from all active filters
         * Customize this for your specific report
         *
         * @param {string} dateColumn - SQL date column for date filtering
         * @returns {string} SQL WHERE clause
         */
        function buildFilterConditions(dateColumn) {
            const customer = document.getElementById('customerFilter').value;
            const status = document.getElementById('statusFilter').value;
            const location = document.getElementById('locationFilter').value;
            const category = document.getElementById('categoryFilter').value;

            let conditions = `WHERE ${getDateCondition(dateColumn || 'DateCreated')}`;

            if (customer !== '%') {
                conditions += ` AND Customer.Id = ${parseInt(customer)}`;
            }
            if (status !== '%') {
                conditions += ` AND Status.Name LIKE '${escapeSQL(status)}'`;
            }
            if (location !== '%') {
                conditions += ` AND LocationGroup.Id = ${parseInt(location)}`;
            }
            if (category !== '%') {
                conditions += ` AND ProductTree.Name = '${escapeSQL(category)}'`;
            }

            return conditions;
        }

        /**
         * Load filter dropdown options from database
         * Customize the queries for your specific tables
         */
        function loadFilters() {
            debugLog('Loading filter dropdowns...', 'info');

            // EXAMPLE: Load Customers
            // Uncomment and customize for your report:
            /*
            try {
                const query = `
                    SELECT DISTINCT Customer.Id as id, Customer.Name as name
                    FROM Customer
                    WHERE Customer.ActiveFlag = 1
                    ORDER BY Customer.Name
                `;
                const results = JSON.parse(runQuery(query));
                const selector = document.getElementById('customerFilter');
                selector.innerHTML = '<option value="%">All Customers</option>';
                results.forEach(item => {
                    selector.innerHTML += `<option value="${item.id}">${item.name}</option>`;
                });
                debugLog(`Loaded ${results.length} customers`, 'success');
            } catch (error) {
                debugLog('Error loading customers: ' + error, 'error');
            }
            */

            // EXAMPLE: Load Location Groups
            /*
            try {
                const query = `
                    SELECT DISTINCT LocationGroup.Id as id, LocationGroup.Name as name
                    FROM LocationGroup
                    WHERE LocationGroup.ActiveFlag = 1
                    ORDER BY LocationGroup.Name
                `;
                const results = JSON.parse(runQuery(query));
                const selector = document.getElementById('locationFilter');
                selector.innerHTML = '<option value="%">All Locations</option>';
                results.forEach(item => {
                    selector.innerHTML += `<option value="${item.id}">${item.name}</option>`;
                });
                debugLog(`Loaded ${results.length} locations`, 'success');
            } catch (error) {
                debugLog('Error loading locations: ' + error, 'error');
            }
            */

            debugLog('Filter loading complete (customize loadFilters() for your report)', 'info');
        }


        /* ============================================
           SCHEDULE & AVAILABILITY INDICATORS
           ============================================ */

        /**
         * Get schedule status color based on date
         * @param {string} dateStr - Date string in SQL format (YYYY-MM-DD HH:mm:ss)
         * @returns {string} 'red' (past due), 'orange' (today), 'blue' (this week), '' (future)
         */
        function getScheduleStatus(dateStr) {
            if (!dateStr) return '';
            const dateParts = dateStr.split(' ')[0].split('-');
            const schedDate = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
            schedDate.setHours(0, 0, 0, 0);

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (schedDate.getTime() === today.getTime()) return 'orange';
            if (schedDate < today) return 'red';

            // Check if within this calendar week
            const todayDay = today.getDay();
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - todayDay);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);

            if (schedDate >= weekStart && schedDate <= weekEnd) return 'blue';
            return '';
        }

        /**
         * Create schedule indicator HTML (clock icon with color)
         * @param {string} dateStr - SQL date string
         * @returns {string} HTML string for the indicator
         */
        function getScheduleIndicatorHTML(dateStr) {
            const status = getScheduleStatus(dateStr);
            if (!status) return '';
            const colors = { red: '#ef4444', orange: '#f59e0b', blue: '#2d9cdb' };
            const titles = { red: 'Past due', orange: 'Due today', blue: 'Due this week' };
            return `<svg viewBox="0 0 24 24" fill="none" stroke="${colors[status]}" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;display:inline-block;vertical-align:middle;" title="${titles[status]}"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>`;
        }


        /* ============================================
           MODULE OPENING FUNCTIONS
           ============================================
           Use these to open Fishbowl records when clicking order links.
        */

        function openSalesOrder(soNumber) {
            if (typeof openModule === 'function') openModule("Sales Order", soNumber);
        }
        function openPurchaseOrder(poNumber) {
            if (typeof openModule === 'function') openModule("Purchase Order", poNumber);
        }
        function openWorkOrder(woNumber) {
            if (typeof openModule === 'function') openModule("Work Order", woNumber);
        }


        /* ============================================
           KPI DISPLAY
           ============================================ */

        /**
         * Update the KPI cards in the header
         * @param {Array<{label: string, value: string, color: string}>} kpis - KPI definitions
         *
         * Colors: 'blue', 'emerald', 'purple', 'amber', 'red'
         */
        function updateKPIs(kpis) {
            const container = document.getElementById('kpiCards');
            const colorMap = {
                blue:    { bg: 'bg-blue-50',    border: 'border-blue-200',    icon: 'text-blue-600' },
                emerald: { bg: 'bg-emerald-50', border: 'border-emerald-200', icon: 'text-emerald-600' },
                purple:  { bg: 'bg-purple-50',  border: 'border-purple-200',  icon: 'text-purple-600' },
                amber:   { bg: 'bg-amber-50',   border: 'border-amber-200',   icon: 'text-amber-600' },
                red:     { bg: 'bg-red-50',      border: 'border-red-200',      icon: 'text-red-600' },
                indigo:  { bg: 'bg-indigo-50',  border: 'border-indigo-200',  icon: 'text-indigo-600' },
            };

            container.innerHTML = kpis.map(kpi => {
                const c = colorMap[kpi.color] || colorMap.blue;
                return `
                    <div class="flex items-center gap-2 px-3 py-2 ${c.bg} border ${c.border} rounded-lg">
                        <span class="text-xs font-semibold text-slate-600">${kpi.label}:</span>
                        <span class="text-sm font-bold text-slate-900">${kpi.value}</span>
                    </div>
                `;
            }).join('');
        }


        /* ============================================
           DRILLDOWN MODAL FUNCTIONS
           ============================================ */

        /**
         * Open drilldown modal with sortable, searchable table
         *
         * @param {string} title - Modal title
         * @param {string} breadcrumb - Context breadcrumb text
         * @param {Array<Object>} data - Array of row objects
         * @param {Array<{key: string, label: string, type?: string}>} columns - Column definitions
         *   type can be: 'currency', 'number', 'percent', 'date', or omitted for string
         */
        function openDrilldown(title, breadcrumb, data, columns) {
            if (!data || !Array.isArray(data)) {
                debugLog('openDrilldown called with invalid data', 'error');
                return;
            }
            debugLog(`Opening drilldown: "${title}" with ${data.length} rows`, 'info');
            currentDrilldownData = data;
            currentDrilldownColumns = columns;
            currentSortColumn = null;
            currentSortDirection = 'asc';

            document.getElementById('drilldownTitle').textContent = title;
            document.getElementById('drilldownBreadcrumb').textContent = breadcrumb;
            document.getElementById('drilldownSearch').value = '';

            renderDrilldownTable(data);

            const modal = document.getElementById('drilldownModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeDrilldown(event) {
            if (event && event.target !== event.currentTarget) return;
            const modal = document.getElementById('drilldownModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function renderDrilldownTable(data) {
            const thead = document.getElementById('drilldownTableHead');
            const tbody = document.getElementById('drilldownTableBody');

            thead.innerHTML = '<tr>' + currentDrilldownColumns.map((col, idx) => `
                <th onclick="sortDrilldownTable(${idx})">
                    <div class="flex items-center gap-2">
                        <span>${col.label}</span>
                        <svg class="w-3 h-3 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/>
                        </svg>
                    </div>
                </th>
            `).join('') + '</tr>';

            tbody.innerHTML = data.map(row =>
                '<tr>' + currentDrilldownColumns.map(col => {
                    let value = row[col.key];
                    let colorClass = '';
                    const numericValue = parseFloat(value || 0);

                    if (col.type === 'currency') {
                        value = formatCurrency(numericValue);
                        if (numericValue < 0) colorClass = 'text-red-600';
                    } else if (col.type === 'number') {
                        value = numericValue.toLocaleString('en-US');
                    } else if (col.type === 'percent') {
                        value = numericValue.toFixed(1) + '%';
                    } else if (col.type === 'date') {
                        value = formatDate(value);
                    }

                    return `<td class="${colorClass}">${value || ''}</td>`;
                }).join('') + '</tr>'
            ).join('');
        }

        function sortDrilldownTable(columnIndex) {
            const column = currentDrilldownColumns[columnIndex];
            if (currentSortColumn === columnIndex) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = columnIndex;
                currentSortDirection = 'asc';
            }

            const sorted = [...currentDrilldownData].sort((a, b) => {
                let aVal = a[column.key];
                let bVal = b[column.key];

                if (column.type === 'currency' || column.type === 'number' || column.type === 'percent') {
                    aVal = parseFloat(aVal || 0);
                    bVal = parseFloat(bVal || 0);
                } else if (column.type === 'date') {
                    aVal = new Date(aVal);
                    bVal = new Date(bVal);
                } else {
                    aVal = String(aVal || '').toLowerCase();
                    bVal = String(bVal || '').toLowerCase();
                }

                return currentSortDirection === 'asc'
                    ? (aVal > bVal ? 1 : -1)
                    : (aVal < bVal ? 1 : -1);
            });

            currentDrilldownData = sorted;
            renderDrilldownTable(sorted);
        }

        function filterDrilldownTable() {
            const searchValue = document.getElementById('drilldownSearch').value.toLowerCase();
            const filteredData = currentDrilldownData.filter(row =>
                currentDrilldownColumns.some(col =>
                    String(row[col.key] || '').toLowerCase().includes(searchValue)
                )
            );
            renderDrilldownTable(filteredData);
        }


        /* ============================================
           DATA EXPORT
           ============================================ */

        /**
         * Export the main table to CSV
         * Customize with your table's data source
         */
        function exportToCSV() {
            debugLog('Export to CSV triggered', 'info');
            // TODO: Implement based on your table's data
            // See exportDrilldownData() for a working example
        }

        /**
         * Export the drilldown modal data to CSV
         */
        function exportDrilldownData() {
            if (!currentDrilldownData || currentDrilldownData.length === 0) {
                alert('No data to export');
                return;
            }

            const headers = currentDrilldownColumns.map(col => col.label).join(',');
            const rows = currentDrilldownData.map(row =>
                currentDrilldownColumns.map(col => {
                    let value = row[col.key] || '';
                    if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                        value = `"${value.replace(/"/g, '""')}"`;
                    }
                    return value;
                }).join(',')
            ).join('\n');

            const csv = headers + '\n' + rows;
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `export_${moment().format('YYYY-MM-DD_HHmmss')}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }


        /* ============================================
           DEBUG CONSOLE
           ============================================ */

        function debugLog(message, type = 'info') {
            if (!DEBUG_MODE) return;

            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('debugLog');
            console.log(`[${timestamp}] ${message}`);

            if (!logDiv) return;
            if (logDiv.querySelector('.italic')) logDiv.innerHTML = '';

            const colors = {
                'info': 'text-blue-400',
                'success': 'text-green-400',
                'warning': 'text-yellow-400',
                'error': 'text-red-400',
                'click': 'text-purple-400'
            };

            const entry = document.createElement('div');
            entry.className = 'mb-1';
            entry.innerHTML = `<span class="text-slate-500">[${timestamp}]</span> <span class="${colors[type] || colors.info}">${message}</span>`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function toggleDebugConsole() {
            const content = document.getElementById('debugContent');
            const chevron = document.getElementById('debugChevron');
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                chevron.style.transform = 'rotate(180deg)';
            } else {
                content.classList.add('hidden');
                chevron.style.transform = 'rotate(0deg)';
            }
        }

        function clearDebugLog() {
            const logDiv = document.getElementById('debugLog');
            logDiv.innerHTML = '<div class="text-slate-500 italic">Log cleared</div>';
        }


        /* ============================================
           MAIN DASHBOARD LOAD
           ============================================

           This is the main entry point that loads all dashboard data.
           Customize this for your specific report.
        */

        function loadDashboard() {
            debugLog('Loading dashboard data...', 'info');
            const loading = document.getElementById('loadingOverlay');
            loading.style.display = 'flex';

            try {
                /*
                 * FISHBOWL TABLE NAMING CONVENTIONS:
                 * - Tables use PascalCase: So, Customer, SoStatus, Priority, Carrier, etc.
                 * - NOT lowercase: so, customer, sostatus
                 *
                 * EXAMPLE: Sales Order Query
                 * 
                 * const conditions = buildFilterConditions('So.DateIssued');
                 * const query = `
                 *     SELECT
                 *         So.Num AS num,
                 *         So.CustomerPO AS customerPO,
                 *         So.DateIssued AS dateIssued,
                 *         So.TotalPrice AS totalPrice,
                 *         Customer.Name AS customerName,
                 *         SoStatus.Name AS statusName,
                 *         Priority.Name AS priorityName
                 *     FROM So
                 *     LEFT JOIN Customer ON So.CustomerId = Customer.Id
                 *     LEFT JOIN SoStatus ON So.StatusId = SoStatus.Id
                 *     LEFT JOIN Priority ON So.PriorityId = Priority.Id
                 *     ${conditions}
                 *     ORDER BY So.DateIssued DESC
                 * `;
                 * const result = JSON.parse(runQuery(query));
                 *
                 * // Update KPIs
                 * updateKPIs([
                 *     { label: 'Total Revenue', value: formatCurrency(totalRevenue, false), color: 'blue' },
                 *     { label: 'Orders', value: formatNumber(orderCount), color: 'emerald' },
                 *     { label: 'Avg Order', value: formatCurrency(avgOrder, false), color: 'purple' },
                 * ]);
                 *
                 * // Render table
                 * renderMainTable(result);
                 *
                 * EXAMPLE: Purchase Order Query
                 * 
                 * const query = `
                 *     SELECT
                 *         Po.Num AS num,
                 *         Vendor.Name AS vendorName,
                 *         Po.DateIssued AS dateIssued,
                 *         PoStatus.Name AS statusName,
                 *         SUM(PoItem.QtyToFulfill * PoItem.UnitCost) AS totalValue
                 *     FROM Po
                 *     LEFT JOIN Vendor ON Po.VendorId = Vendor.Id
                 *     LEFT JOIN PoStatus ON Po.StatusId = PoStatus.Id
                 *     LEFT JOIN PoItem ON PoItem.PoId = Po.Id
                 *     ${conditions}
                 *     GROUP BY Po.Num, Vendor.Name, Po.DateIssued, PoStatus.Name
                 *     ORDER BY Po.DateIssued DESC
                 * `;
                 */

                debugLog('Dashboard loaded successfully', 'success');
                updateDateRangeDisplay();

            } catch (error) {
                console.error('Error loading dashboard:', error);
                debugLog(`Error: ${error.message}`, 'error');
                alert('Error loading dashboard data. Check console for details.');
            } finally {
                loading.style.display = 'none';
            }
        }


        /* ============================================
           INITIALIZATION
           ============================================ */

        window.addEventListener('DOMContentLoaded', function() {
            debugLog('Initializing dashboard...', 'info');

            // Show debug console if enabled
            if (DEBUG_MODE) {
                document.getElementById('debugConsoleContainer').style.display = 'block';
            }

            // Set default date range to current FY
            const fyDates = getFYDates(0);
            customStartDate = fyDates.start;
            customEndDate = fyDates.end;
            document.getElementById('dateRangeFilter').value = 'current_fy';

            loadFilters();
            loadDashboard();
        });
    </script>
</body>
</html>
