<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solidworks BOM Conversion Tool</title>

    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Fishbowl Modern Theme (overrides Bootstrap) -->
    <style>
        {% Style fishbowl-theme-modern %}
    </style>

    <style>
        /* Page-specific overrides and Bootstrap integration */
        h1 {
            text-align: center;
            margin-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            color: var(--fb-text-secondary);
            margin-bottom: 20px;
        }

        /* Upload section improvements */
        .upload-section {
            padding: 20px;
            background-color: var(--fb-primary-pale);
            border: 2px dashed var(--fb-primary);
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: var(--fb-primary-dark);
            background-color: #BBDEFB;
        }

        .upload-section.dragover {
            border-color: var(--fb-success);
            background-color: var(--fb-success-bg);
            border-style: solid;
        }

        .upload-section h3 {
            margin: 0 0 10px 0;
            color: var(--fb-primary-dark);
            font-size: 18px;
        }

        .upload-section p {
            margin: 5px 0;
            font-size: 14px;
        }

        /* Compact summary stats - inline badges */
        .summary-stats {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .stat-card {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 13px;
            font-weight: 600;
        }

        .stat-card.total {
            background-color: var(--fb-info);
            color: white;
        }

        .stat-card.parts {
            background-color: var(--fb-primary);
            color: white;
        }

        .stat-card.boms {
            background-color: var(--fb-secondary);
            color: white;
        }

        .stat-card.new-parts {
            background-color: var(--fb-success);
            color: white;
        }

        .stat-card.warning {
            background-color: var(--fb-warning);
            color: white;
        }

        .stat-card.error {
            background-color: var(--fb-danger);
            color: white;
        }

        .stat-number {
            font-size: 16px;
            font-weight: bold;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.95;
        }

        /* Results table with max height and scrolling */
        .results-table-container {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid var(--fb-border-light);
            border-radius: 6px;
            margin-bottom: 20px;
        }

        /* Offcanvas customization */
        .offcanvas {
            background-color: white !important;
            box-shadow: -4px 0 12px rgba(0, 0, 0, 0.15);
        }

        .offcanvas.offcanvas-start {
            box-shadow: 4px 0 12px rgba(0, 0, 0, 0.15);
        }

        .offcanvas-header {
            background-color: var(--fb-primary);
            color: var(--fb-text-white);
            border-bottom: 2px solid var(--fb-primary-dark);
        }

        .offcanvas-title {
            color: var(--fb-text-white);
            font-weight: 600;
        }

        .btn-close {
            filter: brightness(0) invert(1);
        }

        /* Toolbar area - fixed at top */
        .toolbar-area {
            position: sticky;
            top: 0;
            z-index: 1020;
            background-color: white;
            border-bottom: 2px solid var(--fb-border-light);
            padding: 10px 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .toolbar-btn {
            margin: 0 5px;
        }

        /* Configuration settings styling */
        .config-group {
            margin-bottom: 20px;
            padding: 15px;
            background-color: var(--fb-gray-50);
            border-radius: 6px;
            border: 1px solid var(--fb-border-light);
        }

        .config-group h5 {
            color: var(--fb-primary-dark);
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .config-item {
            margin-bottom: 10px;
        }

        .config-item label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--fb-text-primary);
            margin-bottom: 5px;
        }

        .form-check-label {
            font-size: 13px;
            color: var(--fb-text-primary);
        }

        /* BOM tree visualization */
        .bom-tree {
            margin-bottom: 20px;
        }

        .bom-item {
            padding: 8px;
            margin: 4px 0;
            border-left: 3px solid var(--fb-primary);
            background-color: var(--fb-gray-50);
        }

        .bom-item.level-0 {
            margin-left: 0;
            border-left-color: var(--fb-primary-dark);
            font-weight: 600;
        }

        .bom-item.level-1 {
            margin-left: 20px;
            border-left-color: var(--fb-primary);
        }

        .bom-item.level-2 {
            margin-left: 40px;
            border-left-color: var(--fb-primary-light);
        }

        .bom-item.level-3 {
            margin-left: 60px;
            border-left-color: var(--fb-primary-soft);
        }

        /* Export buttons */
        .export-section {
            margin: 20px 0;
            padding: 15px;
            background-color: var(--fb-gray-50);
            border-radius: 6px;
            text-align: center;
        }

        .export-btn {
            margin: 5px;
        }

        /* Hidden utility */
        .hidden {
            display: none !important;
        }

        /* Progress indicator */
        .progress-section {
            margin: 20px 0;
        }

        /* Alert customization */
        .alert {
            border-radius: 6px;
        }

        /* Info boxes in offcanvas */
        .info-box {
            padding: 12px;
            background-color: var(--fb-primary-pale);
            border-left: 4px solid var(--fb-primary);
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 13px;
        }

        .info-box ul {
            margin-bottom: 0;
            padding-left: 20px;
        }

        .info-box li {
            margin-bottom: 5px;
        }

        /* Debug accordion */
        .debug-section {
            margin-top: 30px;
            margin-bottom: 20px;
        }

        .debug-content {
            max-height: 400px;
            overflow-y: auto;
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.5;
        }

        .debug-entry {
            margin-bottom: 8px;
            padding: 4px 0;
            border-bottom: 1px solid #333;
        }

        .debug-timestamp {
            color: #858585;
            font-size: 11px;
        }

        .debug-type {
            font-weight: bold;
            margin-right: 8px;
        }

        .debug-type.info {
            color: #4fc3f7;
        }

        .debug-type.success {
            color: #66bb6a;
        }

        .debug-type.warning {
            color: #ffa726;
        }

        .debug-type.error {
            color: #ef5350;
        }

        .debug-message {
            color: #d4d4d4;
        }

        .debug-data {
            margin-top: 4px;
            padding-left: 15px;
            color: #ce9178;
            white-space: pre-wrap;
            word-break: break-all;
        }
    </style>
</head>

<body>
    <!-- Toolbar Buttons -->
    <div class="toolbar-area">
        <button class="btn btn-primary toolbar-btn" type="button" data-bs-toggle="offcanvas" data-bs-target="#settingsOffcanvas" aria-controls="settingsOffcanvas">
            <i class="bi bi-gear-fill"></i> Settings
        </button>
        <button class="btn btn-info toolbar-btn" type="button" data-bs-toggle="offcanvas" data-bs-target="#instructionsOffcanvas" aria-controls="instructionsOffcanvas">
            <i class="bi bi-book-fill"></i> Instructions
        </button>
        <button class="btn btn-secondary toolbar-btn" type="button" onclick="checkBOMImportHeaders()">
            <i class="bi bi-database-fill-check"></i> Check BOM Headers
        </button>
    </div>

    <!-- Left Offcanvas: Configuration Settings -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="settingsOffcanvas" aria-labelledby="settingsOffcanvasLabel" style="width: 380px;">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="settingsOffcanvasLabel"><i class="bi bi-gear-fill"></i> Configuration Settings</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <div class="config-group">
                <h5><i class="bi bi-box-seam"></i> Part Creation Options</h5>
                <div class="config-item">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="createAsInventory" checked>
                        <label class="form-check-label" for="createAsInventory">
                            Create new parts as Inventory type
                        </label>
                    </div>
                    <small class="text-muted d-block mt-1">All new parts will be created with Part Type = Inventory</small>
                </div>
                <div class="config-item">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="createFinishedGoodsAsProducts">
                        <label class="form-check-label" for="createFinishedGoodsAsProducts">
                            Create finished goods as Products
                        </label>
                    </div>
                    <small class="text-muted d-block mt-1">Parts that are output of a BOM/stage will also be created as products</small>
                </div>
            </div>

            <div class="config-group">
                <h5><i class="bi bi-diagram-3"></i> BOM Processing Options</h5>
                <div class="config-item">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="validatePartsExist" checked>
                        <label class="form-check-label" for="validatePartsExist">
                            Validate all parts before creating BOMs
                        </label>
                    </div>
                    <small class="text-muted d-block mt-1">Ensure all required parts exist before BOM creation</small>
                </div>
                <div class="config-item">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="processStagesSequentially" checked>
                        <label class="form-check-label" for="processStagesSequentially">
                            Process staged BOMs sequentially
                        </label>
                    </div>
                    <small class="text-muted d-block mt-1">Create parts from earlier stages before later stages</small>
                </div>
            </div>

            <div class="alert alert-info mt-3" style="font-size: 12px;">
                <i class="bi bi-info-circle-fill"></i> Changes take effect when you process the next file.
            </div>
        </div>
    </div>

    <!-- Right Offcanvas: Instructions -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="instructionsOffcanvas" aria-labelledby="instructionsOffcanvasLabel" style="width: 500px;">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="instructionsOffcanvasLabel"><i class="bi bi-book-fill"></i> How to Use This Tool</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <div class="info-box">
                <h6 class="fw-bold mb-2"><i class="bi bi-1-circle-fill"></i> Export from Solidworks</h6>
                <p>Export your Bill of Materials from Solidworks as a CSV file. The BOM should include:</p>
                <ul>
                    <li>Part numbers</li>
                    <li>Descriptions</li>
                    <li>Quantities</li>
                    <li>Dotted indentation levels (e.g., 1, 1.1, 1.1.1, 1.2, 2, 2.1)</li>
                </ul>
            </div>

            <div class="info-box">
                <h6 class="fw-bold mb-2"><i class="bi bi-2-circle-fill"></i> Upload & Process</h6>
                <p>Upload your Solidworks BOM CSV file using the file selector or drag-and-drop.</p>
                <p>The tool will automatically:</p>
                <ul>
                    <li>Parse the dotted indentation structure</li>
                    <li>Identify all unique parts</li>
                    <li>Determine which parts need to be created</li>
                    <li>Map the BOM hierarchy</li>
                </ul>
            </div>

            <div class="info-box">
                <h6 class="fw-bold mb-2"><i class="bi bi-3-circle-fill"></i> Review & Export</h6>
                <p>Review the identified parts and BOM structure, then export:</p>
                <ul>
                    <li><strong>Part Import CSV:</strong> Create new parts in Fishbowl (Part/Product/Vendor Pricing format)</li>
                    <li><strong>BOM Import CSV:</strong> Create Bill of Materials in Fishbowl</li>
                </ul>
            </div>

            <div class="info-box">
                <h6 class="fw-bold mb-2"><i class="bi bi-4-circle-fill"></i> Import to Fishbowl</h6>
                <p>Import the generated files in this order:</p>
                <ol>
                    <li>Import the <strong>Part Import CSV</strong> first to create all required parts</li>
                    <li>Then import the <strong>BOM Import CSV</strong> to create the Bill of Materials</li>
                </ol>
            </div>

            <div class="alert alert-warning mt-3" style="font-size: 12px;">
                <i class="bi bi-exclamation-triangle-fill"></i> <strong>Important:</strong> Always import parts before BOMs. BOMs cannot be created if the required parts don't exist in Fishbowl.
            </div>

            <div class="alert alert-info mt-3" style="font-size: 12px;">
                <i class="bi bi-info-circle-fill"></i> <strong>Note:</strong> This tool replaces the manual process required by Fishbowl's BOM Import Utility, which doesn't support dotted indentation from Solidworks.
            </div>
        </div>
    </div>

    <div class="container">
        <h1>Solidworks BOM Conversion Tool</h1>
        <p class="subtitle">Convert Solidworks BOM exports to Fishbowl-compatible Part and BOM imports</p>

        <!-- Upload Section -->
        <div class="upload-section" id="uploadSection">
            <h3>ðŸ“„ Upload Solidworks BOM CSV</h3>
            <p>Drag and drop file here, or <button type="button" class="btn btn-primary" onclick="document.getElementById('fileInput').click()">Choose File</button></p>
            <input type="file" id="fileInput" accept=".csv" onchange="handleFileSelect(event)" style="display: none;" />
            <p id="fileName" class="text-primary fw-bold"></p>
        </div>

        <!-- Summary Stats (hidden until file loaded) -->
        <div class="summary-stats hidden" id="summaryStats">
            <div class="stat-card total">
                <span class="stat-number" id="statTotal">0</span>
                <span class="stat-label">Total Items</span>
            </div>
            <div class="stat-card parts">
                <span class="stat-number" id="statParts">0</span>
                <span class="stat-label">Unique Parts</span>
            </div>
            <div class="stat-card new-parts">
                <span class="stat-number" id="statNewParts">0</span>
                <span class="stat-label">New Parts</span>
            </div>
            <div class="stat-card boms">
                <span class="stat-number" id="statBOMs">0</span>
                <span class="stat-label">BOMs/Stages</span>
            </div>
            <div class="stat-card warning">
                <span class="stat-number" id="statWarnings">0</span>
                <span class="stat-label">Warnings</span>
            </div>
            <div class="stat-card error">
                <span class="stat-number" id="statErrors">0</span>
                <span class="stat-label">Errors</span>
            </div>
        </div>

        <!-- Progress Section (hidden until processing) -->
        <div class="progress-section hidden" id="progressSection">
            <div class="alert alert-info">
                <i class="bi bi-hourglass-split"></i> <span id="progressText">Processing...</span>
            </div>
            <div class="progress">
                <div class="progress-bar progress-bar-striped progress-bar-animated" id="progressBar" role="progressbar" style="width: 0%"></div>
            </div>
        </div>

        <!-- BOM Structure Preview (hidden until file loaded) -->
        <div class="hidden" id="bomStructureSection">
            <h3>ðŸ“Š BOM Structure</h3>
            <div class="bom-tree" id="bomTree">
                <!-- Will be populated dynamically -->
            </div>
        </div>

        <!-- Parts to Create (hidden until file loaded) -->
        <div class="hidden" id="partsSection">
            <h3>ðŸ”§ Parts to Create</h3>
            <div class="results-table-container">
                <table class="table table-sm table-hover" id="partsTable">
                    <thead>
                        <tr>
                            <th>Part Number</th>
                            <th>Description</th>
                            <th>Type</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="partsTableBody">
                        <!-- Will be populated dynamically -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- BOMs to Create (hidden until file loaded) -->
        <div class="hidden" id="bomsSection">
            <h3>ðŸ“‹ BOMs to Create</h3>
            <div class="results-table-container">
                <table class="table table-sm table-hover" id="bomsTable">
                    <thead>
                        <tr>
                            <th>BOM Name</th>
                            <th>Parent Part</th>
                            <th>Items</th>
                            <th>Stage</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="bomsTableBody">
                        <!-- Will be populated dynamically -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Export Section (hidden until ready) -->
        <div class="export-section hidden" id="exportSection">
            <h4>ðŸ“¥ Export for Fishbowl Import</h4>
            <p class="text-muted mb-3">Generate CSV files ready for Fishbowl import</p>
            <button class="btn btn-success export-btn" onclick="exportPartImport()" id="exportPartsBtn">
                <i class="bi bi-download"></i> Download Part Import CSV
            </button>
            <button class="btn btn-primary export-btn" onclick="exportBOMImport()" id="exportBOMBtn">
                <i class="bi bi-download"></i> Download BOM Import CSV
            </button>
        </div>

        <!-- Messages/Alerts Section -->
        <div id="messagesSection">
            <!-- Dynamic alerts will appear here -->
        </div>

        <!-- Debug Section -->
        <div class="debug-section">
            <div class="accordion" id="debugAccordion">
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#debugContent" aria-expanded="false" aria-controls="debugContent">
                            <i class="bi bi-bug-fill me-2"></i> Debug Console
                        </button>
                    </h2>
                    <div id="debugContent" class="accordion-collapse collapse" data-bs-parent="#debugAccordion">
                        <div class="accordion-body p-0">
                            <div class="p-2 bg-dark text-white d-flex justify-content-between align-items-center">
                                <small>Debug log - Auto-scrolls to latest entry</small>
                                <button class="btn btn-sm btn-outline-light" onclick="clearDebugLog()">
                                    <i class="bi bi-trash"></i> Clear
                                </button>
                            </div>
                            <div class="debug-content" id="debugLog">
                                <div class="debug-entry">
                                    <span class="debug-timestamp">[00:00:00]</span>
                                    <span class="debug-type info">[INFO]</span>
                                    <span class="debug-message">Debug console initialized</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS Bundle (includes Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Configuration state
        const config = {
            createAsInventory: true,
            createFinishedGoodsAsProducts: false,
            validatePartsExist: true,
            processStagesSequentially: true
        };

        // Application state
        let solidworksData = null;
        let parsedBOM = null;
        let partsToCreate = [];
        let bomsToCreate = [];
        let bomImportHeaders = null;

        // Debug logging functions
        function debugLog(type, message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'debug-entry';

            let html = `
                <span class="debug-timestamp">[${timestamp}]</span>
                <span class="debug-type ${type}">[${type.toUpperCase()}]</span>
                <span class="debug-message">${message}</span>
            `;

            if (data) {
                const dataStr = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
                html += `<div class="debug-data">${dataStr}</div>`;
            }

            logEntry.innerHTML = html;

            const debugLogEl = document.getElementById('debugLog');
            debugLogEl.appendChild(logEntry);

            // Auto-scroll to bottom
            debugLogEl.scrollTop = debugLogEl.scrollHeight;

            // Also log to console
            console.log(`[${type.toUpperCase()}]`, message, data || '');
        }

        function clearDebugLog() {
            const debugLogEl = document.getElementById('debugLog');
            debugLogEl.innerHTML = `
                <div class="debug-entry">
                    <span class="debug-timestamp">[${new Date().toLocaleTimeString()}]</span>
                    <span class="debug-type info">[INFO]</span>
                    <span class="debug-message">Debug log cleared</span>
                </div>
            `;
        }

        // Check BOM Import API Headers
        function checkBOMImportHeaders() {
            debugLog('info', 'Checking BOM Import API headers...');

            const headerPayload = {
                "ImportHeaderRq": {
                    "Type": "ImportBillOfMaterials"
                }
            };

            try {
                debugLog('info', 'Sending ImportHeaderRq request', headerPayload);
                const headerResponse = runApiRequest('ImportHeaderRq', JSON.stringify(headerPayload));
                debugLog('success', 'Received ImportHeaderRq response', headerResponse);

                if (headerResponse) {
                    const headerResult = typeof headerResponse === 'string' ? JSON.parse(headerResponse) : headerResponse;
                    debugLog('info', 'Parsed header response', headerResult);

                    if (headerResult && headerResult.ImportHeaderRs && headerResult.ImportHeaderRs.Header) {
                        bomImportHeaders = headerResult.ImportHeaderRs.Header;
                        debugLog('success', 'BOM Import Headers retrieved successfully', bomImportHeaders);
                        showMessage('BOM Import headers retrieved successfully', 'success');
                        return bomImportHeaders;
                    } else {
                        debugLog('warning', 'No headers found in response');
                        showMessage('Could not find headers in API response', 'warning');
                    }
                } else {
                    debugLog('error', 'No response from ImportHeaderRq');
                    showMessage('No response from API', 'danger');
                }
            } catch (e) {
                debugLog('error', 'Error querying BOM import headers', e.toString());
                showMessage('Error querying BOM import headers: ' + e.message, 'danger');
            }

            return null;
        }

        // File handling
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        // Drag and drop support
        const uploadSection = document.getElementById('uploadSection');

        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');

            const file = e.dataTransfer.files[0];
            if (file && file.name.endsWith('.csv')) {
                processFile(file);
            } else {
                showMessage('Please drop a CSV file', 'danger');
            }
        });

        // Process uploaded file
        function processFile(file) {
            document.getElementById('fileName').textContent = file.name;

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                parseSolidworksCSV(content);
            };
            reader.readAsText(file);
        }

        // Parse Solidworks CSV
        function parseSolidworksCSV(csvContent) {
            debugLog('info', 'Starting Solidworks BOM parsing...');
            showMessage('Parsing Solidworks BOM...', 'info');

            try {
                // Parse CSV into rows
                const lines = csvContent.split('\n').map(line => line.trim()).filter(line => line.length > 0);
                debugLog('info', `Total lines in CSV: ${lines.length}`);

                if (lines.length < 2) {
                    debugLog('error', 'CSV file is empty or has no data rows');
                    showMessage('CSV file is empty or invalid', 'danger');
                    return;
                }

                // Parse header row
                const headers = parseCSVLine(lines[0]);
                debugLog('info', 'CSV Headers detected', headers);

                // Expected headers: LEVEL, Description, PGE P/N#, Ordering type, Qty, uom, Supplier, Cost/ea
                const levelIndex = headers.findIndex(h => h.toLowerCase().includes('level'));
                const descIndex = headers.findIndex(h => h.toLowerCase().includes('description'));
                const partNumIndex = headers.findIndex(h => h.toLowerCase().includes('p/n'));
                const typeIndex = headers.findIndex(h => h.toLowerCase().includes('type'));
                const qtyIndex = headers.findIndex(h => h.toLowerCase().includes('qty'));
                const uomIndex = headers.findIndex(h => h.toLowerCase().includes('uom'));

                if (levelIndex === -1 || partNumIndex === -1) {
                    debugLog('error', 'Required columns (LEVEL, Part Number) not found in CSV');
                    showMessage('CSV missing required columns (LEVEL, Part Number)', 'danger');
                    return;
                }

                debugLog('success', 'Column mapping established', {
                    levelIndex,
                    descIndex,
                    partNumIndex,
                    typeIndex,
                    qtyIndex,
                    uomIndex
                });

                // Parse data rows
                const bomItems = [];
                for (let i = 1; i < lines.length; i++) {
                    const row = parseCSVLine(lines[i]);
                    if (row.length > levelIndex && row[levelIndex]) {
                        const item = {
                            level: row[levelIndex] || '',
                            description: row[descIndex] || '',
                            partNumber: row[partNumIndex] || '',
                            type: row[typeIndex] || '',
                            quantity: row[qtyIndex] || '1',
                            uom: row[uomIndex] || 'ea',
                            lineNumber: i + 1
                        };
                        bomItems.push(item);
                    }
                }

                debugLog('success', `Parsed ${bomItems.length} BOM items`, bomItems.slice(0, 5));

                // Analyze BOM structure
                analyzeBOMStructure(bomItems);

                solidworksData = bomItems;
                showMessage(`Successfully parsed ${bomItems.length} items from Solidworks BOM`, 'success');

            } catch (error) {
                debugLog('error', 'Error parsing Solidworks CSV', error.toString());
                showMessage('Error parsing CSV: ' + error.message, 'danger');
            }
        }

        // Simple CSV line parser (handles quoted fields)
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];

                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }

            result.push(current.trim());
            return result;
        }

        // Analyze BOM structure and extract parts/BOMs
        function analyzeBOMStructure(bomItems) {
            debugLog('info', 'Analyzing BOM structure...');

            const uniqueParts = new Map();
            const bomStructure = [];
            let currentBOM = null;

            for (const item of bomItems) {
                // Parse level (e.g., "1", "1.1", "1.1.1")
                const levelParts = item.level.split('.');
                const depth = levelParts.length;

                debugLog('info', `Processing item: ${item.level} - ${item.partNumber}`, {
                    level: item.level,
                    depth,
                    partNumber: item.partNumber
                });

                // Track unique parts
                if (item.partNumber && !uniqueParts.has(item.partNumber)) {
                    uniqueParts.set(item.partNumber, {
                        partNumber: item.partNumber,
                        description: item.description,
                        type: item.type,
                        uom: item.uom
                    });
                }

                // Identify BOMs (items with children)
                // For now, we'll do a simple analysis
                // A BOM is typically a top-level item or an assembly/sub-assembly
            }

            partsToCreate = Array.from(uniqueParts.values());
            debugLog('success', `Identified ${partsToCreate.length} unique parts`, partsToCreate.slice(0, 5));

            updateStats({
                total: bomItems.length,
                parts: partsToCreate.length,
                newParts: partsToCreate.length, // Will be refined later
                boms: 0, // Will be calculated
                warnings: 0,
                errors: 0
            });

            // Show parts section
            displayPartsToCreate();
        }

        // Display parts to create in table
        function displayPartsToCreate() {
            const tbody = document.getElementById('partsTableBody');
            tbody.innerHTML = '';

            for (const part of partsToCreate) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${part.partNumber}</td>
                    <td>${part.description}</td>
                    <td>${config.createAsInventory ? 'Inventory' : part.type}</td>
                    <td><span class="badge bg-warning">To Create</span></td>
                `;
                tbody.appendChild(row);
            }

            document.getElementById('partsSection').classList.remove('hidden');
            document.getElementById('exportSection').classList.remove('hidden');
        }

        // Export functions
        function exportPartImport() {
            showMessage('Part export not yet implemented', 'warning');
            // TODO: Generate PPP format CSV for part creation
        }

        function exportBOMImport() {
            showMessage('BOM export not yet implemented', 'warning');
            // TODO: Generate Fishbowl BOM import CSV
        }

        // Utility functions
        function showMessage(message, type = 'info') {
            const messagesSection = document.getElementById('messagesSection');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            messagesSection.appendChild(alert);

            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        function updateStats(stats) {
            document.getElementById('statTotal').textContent = stats.total || 0;
            document.getElementById('statParts').textContent = stats.parts || 0;
            document.getElementById('statNewParts').textContent = stats.newParts || 0;
            document.getElementById('statBOMs').textContent = stats.boms || 0;
            document.getElementById('statWarnings').textContent = stats.warnings || 0;
            document.getElementById('statErrors').textContent = stats.errors || 0;

            document.getElementById('summaryStats').classList.remove('hidden');
        }

        // Configuration event listeners
        document.getElementById('createAsInventory').addEventListener('change', function() {
            config.createAsInventory = this.checked;
        });

        document.getElementById('createFinishedGoodsAsProducts').addEventListener('change', function() {
            config.createFinishedGoodsAsProducts = this.checked;
        });

        document.getElementById('validatePartsExist').addEventListener('change', function() {
            config.validatePartsExist = this.checked;
        });

        document.getElementById('processStagesSequentially').addEventListener('change', function() {
            config.processStagesSequentially = this.checked;
        });

        // Initialize
        console.log('Solidworks BOM Conversion Tool initialized');
        debugLog('info', 'Solidworks BOM Conversion Tool initialized');
        debugLog('info', 'Ready to process Solidworks BOM CSV files');
        debugLog('info', 'Click "Check BOM Headers" to retrieve Fishbowl BOM import format');

        // Auto-check BOM headers on load (optional - can comment out if not needed)
        // setTimeout(() => checkBOMImportHeaders(), 1000);
    </script>
</body>
</html>
