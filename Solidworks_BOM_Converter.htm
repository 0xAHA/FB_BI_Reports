<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solidworks BOM Conversion Tool</title>

    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Fishbowl Modern Theme (overrides Bootstrap) -->
    <style>
        {% Style fishbowl-theme-modern %}
    </style>

    <style>
        /* Page-specific overrides and Bootstrap integration */
        h1 {
            text-align: center;
            margin-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            color: var(--fb-text-secondary);
            margin-bottom: 20px;
        }

        /* Upload section improvements */
        .upload-section {
            padding: 20px;
            background-color: var(--fb-primary-pale);
            border: 2px dashed var(--fb-primary);
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: var(--fb-primary-dark);
            background-color: #BBDEFB;
        }

        .upload-section.dragover {
            border-color: var(--fb-success);
            background-color: var(--fb-success-bg);
            border-style: solid;
        }

        .upload-section h3 {
            margin: 0 0 10px 0;
            color: var(--fb-primary-dark);
            font-size: 18px;
        }

        .upload-section p {
            margin: 5px 0;
            font-size: 14px;
        }

        /* Compact summary stats - inline badges */
        .summary-stats {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .stat-card {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 13px;
            font-weight: 600;
        }

        .stat-card.total {
            background-color: var(--fb-info);
            color: white;
        }

        .stat-card.parts {
            background-color: var(--fb-primary);
            color: white;
        }

        .stat-card.boms {
            background-color: var(--fb-secondary);
            color: white;
        }

        .stat-card.new-parts {
            background-color: var(--fb-success);
            color: white;
        }

        .stat-card.warning {
            background-color: var(--fb-warning);
            color: white;
        }

        .stat-card.error {
            background-color: var(--fb-danger);
            color: white;
        }

        .stat-number {
            font-size: 16px;
            font-weight: bold;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.95;
        }

        /* Results table with max height and scrolling */
        .results-table-container {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid var(--fb-border-light);
            border-radius: 6px;
            margin-bottom: 20px;
        }

        /* Offcanvas customization */
        .offcanvas {
            background-color: white !important;
            box-shadow: -4px 0 12px rgba(0, 0, 0, 0.15);
        }

        .offcanvas.offcanvas-start {
            box-shadow: 4px 0 12px rgba(0, 0, 0, 0.15);
        }

        .offcanvas-header {
            background-color: var(--fb-primary);
            color: var(--fb-text-white);
            border-bottom: 2px solid var(--fb-primary-dark);
        }

        .offcanvas-title {
            color: var(--fb-text-white);
            font-weight: 600;
        }

        .btn-close {
            filter: brightness(0) invert(1);
        }

        /* Toolbar area - fixed at top */
        .toolbar-area {
            position: sticky;
            top: 0;
            z-index: 1020;
            background-color: white;
            border-bottom: 2px solid var(--fb-border-light);
            padding: 10px 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .toolbar-btn {
            margin: 0 5px;
        }

        /* Configuration settings styling */
        .config-group {
            margin-bottom: 20px;
            padding: 15px;
            background-color: var(--fb-gray-50);
            border-radius: 6px;
            border: 1px solid var(--fb-border-light);
        }

        .config-group h5 {
            color: var(--fb-primary-dark);
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .config-item {
            margin-bottom: 10px;
        }

        .config-item label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--fb-text-primary);
            margin-bottom: 5px;
        }

        .form-check-label {
            font-size: 13px;
            color: var(--fb-text-primary);
        }

        /* BOM tree visualization */
        .bom-tree {
            margin-bottom: 20px;
        }

        .bom-item {
            padding: 8px;
            margin: 4px 0;
            border-left: 3px solid var(--fb-primary);
            background-color: var(--fb-gray-50);
        }

        .bom-item.level-0 {
            margin-left: 0;
            border-left-color: var(--fb-primary-dark);
            font-weight: 600;
        }

        .bom-item.level-1 {
            margin-left: 20px;
            border-left-color: var(--fb-primary);
        }

        .bom-item.level-2 {
            margin-left: 40px;
            border-left-color: var(--fb-primary-light);
        }

        .bom-item.level-3 {
            margin-left: 60px;
            border-left-color: var(--fb-primary-soft);
        }

        /* Export buttons */
        .export-section {
            margin: 20px 0;
            padding: 15px;
            background-color: var(--fb-gray-50);
            border-radius: 6px;
            text-align: center;
        }

        .export-btn {
            margin: 5px;
        }

        /* Hidden utility */
        .hidden {
            display: none !important;
        }

        /* Progress indicator */
        .progress-section {
            margin: 20px 0;
        }

        /* Alert customization */
        .alert {
            border-radius: 6px;
        }

        /* Info boxes in offcanvas */
        .info-box {
            padding: 12px;
            background-color: var(--fb-primary-pale);
            border-left: 4px solid var(--fb-primary);
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 13px;
        }

        .info-box ul {
            margin-bottom: 0;
            padding-left: 20px;
        }

        .info-box li {
            margin-bottom: 5px;
        }

        /* Field mapping section */
        .mapping-section {
            margin: 20px 0;
            padding: 15px;
            background-color: var(--fb-gray-50);
            border-radius: 6px;
            border: 1px solid var(--fb-border-light);
        }

        .mapping-row {
            display: grid;
            grid-template-columns: 45% 10% 45%;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 8px;
            background-color: white;
            border-radius: 4px;
        }

        .mapping-label {
            font-weight: 500;
            color: var(--fb-text-primary);
            font-size: 13px;
        }

        .mapping-arrow {
            color: var(--fb-primary);
            font-size: 18px;
            text-align: center;
        }

        .mapping-select {
            padding: 6px 10px;
            border: 1px solid var(--fb-border-light);
            border-radius: 4px;
            font-size: 13px;
            width: 100%;
        }

        .required-field::after {
            content: " *";
            color: var(--fb-danger);
        }

        /* Debug accordion */
        .debug-section {
            margin-top: 30px;
            margin-bottom: 20px;
        }

        .debug-content {
            max-height: 400px;
            overflow-y: auto;
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.5;
        }

        .debug-entry {
            margin-bottom: 8px;
            padding: 4px 0;
            border-bottom: 1px solid #333;
        }

        .debug-timestamp {
            color: #858585;
            font-size: 11px;
        }

        .debug-type {
            font-weight: bold;
            margin-right: 8px;
        }

        .debug-type.info {
            color: #4fc3f7;
        }

        .debug-type.success {
            color: #66bb6a;
        }

        .debug-type.warning {
            color: #ffa726;
        }

        .debug-type.error {
            color: #ef5350;
        }

        .debug-message {
            color: #d4d4d4;
        }

        .debug-data {
            margin-top: 4px;
            padding-left: 15px;
            color: #ce9178;
            white-space: pre-wrap;
            word-break: break-all;
        }
    </style>
</head>

<body>
    <!-- Toolbar Buttons -->
    <div class="toolbar-area">
        <button class="btn btn-primary toolbar-btn" type="button" data-bs-toggle="offcanvas" data-bs-target="#settingsOffcanvas" aria-controls="settingsOffcanvas">
            <i class="bi bi-gear-fill"></i> Settings
        </button>
        <button class="btn btn-info toolbar-btn" type="button" data-bs-toggle="offcanvas" data-bs-target="#instructionsOffcanvas" aria-controls="instructionsOffcanvas">
            <i class="bi bi-book-fill"></i> Instructions
        </button>
        <button class="btn btn-secondary toolbar-btn" type="button" onclick="checkBOMImportHeaders()">
            <i class="bi bi-database-fill-check"></i> Check BOM Headers
        </button>
    </div>

    <!-- Left Offcanvas: Configuration Settings -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="settingsOffcanvas" aria-labelledby="settingsOffcanvasLabel" style="width: 380px;">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="settingsOffcanvasLabel"><i class="bi bi-gear-fill"></i> Configuration Settings</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <div class="config-group">
                <h5><i class="bi bi-sliders"></i> Default Values</h5>
                <div class="config-item">
                    <label for="defaultUOM">Default UOM (Part UOM)</label>
                    <select class="form-select form-select-sm" id="defaultUOM" onchange="saveSettings()">
                        <option value="ea" selected>ea (Each)</option>
                        <!-- Will be populated from Fishbowl -->
                    </select>
                    <small class="text-muted d-block mt-1">Default unit of measure for parts without specified UOM</small>
                </div>
                <div class="config-item">
                    <label for="defaultTaxCode">Default Tax Code</label>
                    <select class="form-select form-select-sm" id="defaultTaxCode" onchange="saveSettings()">
                        <option value="NON">NON (Non-Taxable)</option>
                        <!-- Will be populated from Fishbowl -->
                    </select>
                    <small class="text-muted d-block mt-1">Tax code for new parts</small>
                </div>
                <div class="config-item">
                    <label for="defaultWeightUOM">Default Weight UOM</label>
                    <select class="form-select form-select-sm" id="defaultWeightUOM" onchange="saveSettings()">
                        <optgroup label="Metric">
                            <option value="kg" selected>kg (Kilogram)</option>
                            <option value="g">g (Gram)</option>
                        </optgroup>
                        <optgroup label="Imperial">
                            <option value="lb">lb (Pound)</option>
                            <option value="oz">oz (Ounce)</option>
                        </optgroup>
                    </select>
                    <small class="text-muted d-block mt-1">Unit for part weights</small>
                </div>
                <div class="config-item">
                    <label for="defaultSizeUOM">Default Size UOM</label>
                    <select class="form-select form-select-sm" id="defaultSizeUOM" onchange="saveSettings()">
                        <optgroup label="Metric">
                            <option value="cm" selected>cm (Centimeter)</option>
                            <option value="mm">mm (Millimeter)</option>
                            <option value="m">m (Meter)</option>
                        </optgroup>
                        <optgroup label="Imperial">
                            <option value="in">in (Inch)</option>
                            <option value="ft">ft (Foot)</option>
                        </optgroup>
                    </select>
                    <small class="text-muted d-block mt-1">Unit for dimensions (width, height, length)</small>
                </div>
            </div>

            <div class="config-group">
                <h5><i class="bi bi-box-seam"></i> Part Creation Options</h5>
                <div class="config-item">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="createAsInventory" checked onchange="saveSettings()">
                        <label class="form-check-label" for="createAsInventory">
                            Create new parts as Inventory type
                        </label>
                    </div>
                    <small class="text-muted d-block mt-1">All new parts will be created with Part Type = Inventory</small>
                </div>
                <div class="config-item">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="createFinishedGoodsAsProducts" onchange="saveSettings()">
                        <label class="form-check-label" for="createFinishedGoodsAsProducts">
                            Create finished goods as Products
                        </label>
                    </div>
                    <small class="text-muted d-block mt-1">Parts that are output of a BOM/stage will also be created as products</small>
                </div>
            </div>

            <div class="config-group">
                <h5><i class="bi bi-diagram-3"></i> BOM Processing Options</h5>
                <div class="config-item">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="validatePartsExist" checked onchange="saveSettings()">
                        <label class="form-check-label" for="validatePartsExist">
                            Validate all parts before creating BOMs
                        </label>
                    </div>
                    <small class="text-muted d-block mt-1">Ensure all required parts exist before BOM creation</small>
                </div>
                <div class="config-item">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="processStagesSequentially" checked onchange="saveSettings()">
                        <label class="form-check-label" for="processStagesSequentially">
                            Process staged BOMs sequentially
                        </label>
                    </div>
                    <small class="text-muted d-block mt-1">Create parts from earlier stages before later stages</small>
                </div>
            </div>

            <div class="alert alert-info mt-3" style="font-size: 12px;">
                <i class="bi bi-info-circle-fill"></i> Changes take effect when you process the next file.
            </div>
        </div>
    </div>

    <!-- Right Offcanvas: Instructions -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="instructionsOffcanvas" aria-labelledby="instructionsOffcanvasLabel" style="width: 500px;">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="instructionsOffcanvasLabel"><i class="bi bi-book-fill"></i> How to Use This Tool</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <div class="info-box">
                <h6 class="fw-bold mb-2"><i class="bi bi-1-circle-fill"></i> Export from Solidworks</h6>
                <p>Export your Bill of Materials from Solidworks as a CSV file. The BOM should include:</p>
                <ul>
                    <li>Part numbers</li>
                    <li>Descriptions</li>
                    <li>Quantities</li>
                    <li>Dotted indentation levels (e.g., 1, 1.1, 1.1.1, 1.2, 2, 2.1)</li>
                </ul>
            </div>

            <div class="info-box">
                <h6 class="fw-bold mb-2"><i class="bi bi-2-circle-fill"></i> Upload & Process</h6>
                <p>Upload your Solidworks BOM CSV file using the file selector or drag-and-drop.</p>
                <p>The tool will automatically:</p>
                <ul>
                    <li>Parse the dotted indentation structure</li>
                    <li>Identify all unique parts</li>
                    <li>Determine which parts need to be created</li>
                    <li>Map the BOM hierarchy</li>
                </ul>
            </div>

            <div class="info-box">
                <h6 class="fw-bold mb-2"><i class="bi bi-3-circle-fill"></i> Review & Export</h6>
                <p>Review the identified parts and BOM structure, then export:</p>
                <ul>
                    <li><strong>Part Import CSV:</strong> Create new parts in Fishbowl (Part/Product/Vendor Pricing format)</li>
                    <li><strong>BOM Import CSV:</strong> Create Bill of Materials in Fishbowl</li>
                </ul>
            </div>

            <div class="info-box">
                <h6 class="fw-bold mb-2"><i class="bi bi-4-circle-fill"></i> Import to Fishbowl</h6>
                <p>Import the generated files in this order:</p>
                <ol>
                    <li>Import the <strong>Part Import CSV</strong> first to create all required parts</li>
                    <li>Then import the <strong>BOM Import CSV</strong> to create the Bill of Materials</li>
                </ol>
            </div>

            <div class="alert alert-warning mt-3" style="font-size: 12px;">
                <i class="bi bi-exclamation-triangle-fill"></i> <strong>Important:</strong> Always import parts before BOMs. BOMs cannot be created if the required parts don't exist in Fishbowl.
            </div>

            <div class="alert alert-info mt-3" style="font-size: 12px;">
                <i class="bi bi-info-circle-fill"></i> <strong>Note:</strong> This tool replaces the manual process required by Fishbowl's BOM Import Utility, which doesn't support dotted indentation from Solidworks.
            </div>
        </div>
    </div>

    <!-- Field Mapping Modal -->
    <div class="modal fade" id="fieldMappingModal" tabindex="-1" aria-labelledby="fieldMappingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background-color: var(--fb-primary); color: white;">
                    <h5 class="modal-title" id="fieldMappingModalLabel">
                        <i class="bi bi-arrows-angle-contract"></i> Map Solidworks Columns to Fishbowl BOM Import
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info mb-3">
                        <i class="bi bi-info-circle-fill"></i> Map your Solidworks BOM columns to Fishbowl fields. Fields marked with <span class="text-danger">*</span> are required.
                    </div>

                    <div style="display: grid; grid-template-columns: 45% 10% 45%; gap: 10px; margin-bottom: 15px; font-weight: bold;">
                        <div>Fishbowl Field</div>
                        <div style="text-align: center;"></div>
                        <div>Solidworks Column</div>
                    </div>

                    <!-- BOM field mappings -->
                    <div id="bomLevelMappings">
                        <!-- Will be populated dynamically -->
                    </div>

                    <!-- Hidden - not used anymore but keeping for compatibility -->
                    <div id="itemLevelMappings" style="display: none;"></div>

                    <div class="alert alert-warning mt-3 mb-0">
                        <small><i class="bi bi-lightbulb-fill"></i> <strong>Tip:</strong> Use "None" to skip optional fields. Required fields must be mapped.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="me-auto">
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="exportMappingFile()">
                            <i class="bi bi-download"></i> Export Mapping
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="importMappingFile()">
                            <i class="bi bi-upload"></i> Import Mapping
                        </button>
                    </div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveMappings()">
                        <i class="bi bi-save"></i> Save & Process
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <h1>Solidworks BOM Conversion Tool</h1>
        <p class="subtitle">Convert Solidworks BOM exports to Fishbowl-compatible Part and BOM imports</p>

        <!-- Upload Section -->
        <div class="upload-section" id="uploadSection">
            <h3>ðŸ“„ Upload Solidworks BOM CSV</h3>
            <p>Drag and drop file here, or <button type="button" class="btn btn-primary" onclick="document.getElementById('fileInput').click()">Choose File</button></p>
            <input type="file" id="fileInput" accept=".csv" onchange="handleFileSelect(event)" style="display: none;" />
            <p id="fileName" class="text-primary fw-bold"></p>
        </div>

        <!-- Field Mapping Button (hidden until file loaded) -->
        <div class="text-center mb-3 hidden" id="mappingButtonSection">
            <button class="btn btn-primary btn-lg" onclick="openFieldMappingDialog()">
                <i class="bi bi-arrows-angle-contract"></i> Configure Field Mapping
            </button>
            <button class="btn btn-outline-secondary btn-lg ms-2" onclick="importMappingFile()" title="Load saved field mappings from JSON file">
                <i class="bi bi-upload"></i> Load Saved Mappings
            </button>
            <p class="text-muted mt-2 mb-0">
                <small>Map Solidworks columns to Fishbowl fields, or load a saved mapping configuration</small>
            </p>
        </div>

        <!-- Summary Stats (hidden until file loaded) -->
        <div class="summary-stats hidden" id="summaryStats">
            <div class="stat-card total">
                <span class="stat-number" id="statTotal">0</span>
                <span class="stat-label">Total Items</span>
            </div>
            <div class="stat-card parts">
                <span class="stat-number" id="statParts">0</span>
                <span class="stat-label">Unique Parts</span>
            </div>
            <div class="stat-card new-parts">
                <span class="stat-number" id="statNewParts">0</span>
                <span class="stat-label">New Parts</span>
            </div>
            <div class="stat-card boms">
                <span class="stat-number" id="statBOMs">0</span>
                <span class="stat-label">BOMs/Stages</span>
            </div>
            <div class="stat-card warning">
                <span class="stat-number" id="statWarnings">0</span>
                <span class="stat-label">Warnings</span>
            </div>
            <div class="stat-card error">
                <span class="stat-number" id="statErrors">0</span>
                <span class="stat-label">Errors</span>
            </div>
        </div>

        <!-- Progress Section (hidden until processing) -->
        <div class="progress-section hidden" id="progressSection">
            <div class="alert alert-info">
                <i class="bi bi-hourglass-split"></i> <span id="progressText">Processing...</span>
            </div>
            <div class="progress">
                <div class="progress-bar progress-bar-striped progress-bar-animated" id="progressBar" role="progressbar" style="width: 0%"></div>
            </div>
        </div>

        <!-- BOM Structure Preview (hidden until file loaded) -->
        <div class="hidden" id="bomStructureSection">
            <h3>ðŸ“Š BOM Structure</h3>
            <div class="bom-tree" id="bomTree">
                <!-- Will be populated dynamically -->
            </div>
        </div>

        <!-- Parts to Create (hidden until file loaded) -->
        <div class="hidden" id="partsSection">
            <div class="accordion" id="partsAccordion">
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#partsContent" aria-expanded="true">
                            <i class="bi bi-box-seam me-2"></i> ðŸ”§ Parts to Create (<span id="partsCount">0</span>)
                        </button>
                    </h2>
                    <div id="partsContent" class="accordion-collapse collapse show" data-bs-parent="#partsAccordion">
                        <div class="accordion-body p-0">
                            <div class="results-table-container">
                                <table class="table table-sm table-hover mb-0" id="partsTable">
                                    <thead>
                                        <tr>
                                            <th>Part Number</th>
                                            <th>Description</th>
                                            <th>UOM</th>
                                            <th>Type</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="partsTableBody">
                                        <!-- Will be populated dynamically -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- BOMs to Create (hidden until file loaded) -->
        <div class="hidden" id="bomsSection">
            <div class="accordion" id="bomsAccordion">
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#bomsContent" aria-expanded="true">
                            <i class="bi bi-diagram-3 me-2"></i> ðŸ“‹ BOMs to Create (<span id="bomsCount">0</span>)
                        </button>
                    </h2>
                    <div id="bomsContent" class="accordion-collapse collapse show" data-bs-parent="#bomsAccordion">
                        <div class="accordion-body p-0">
                            <div class="results-table-container">
                                <table class="table table-sm table-hover mb-0" id="bomsTable">
                                    <thead>
                                        <tr>
                                            <th>BOM Name</th>
                                            <th>Parent Part</th>
                                            <th>Items</th>
                                            <th>Stage</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="bomsTableBody">
                                        <!-- Will be populated dynamically -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Section (hidden until ready) -->
        <div class="export-section hidden" id="exportSection">
            <h4>ðŸ“¥ Export & Import to Fishbowl</h4>
            <p class="text-muted mb-3">Download CSV files or import directly to Fishbowl</p>

            <div class="row">
                <div class="col-md-6">
                    <h6 class="text-secondary mb-2">CSV Export (Manual Import)</h6>
                    <button class="btn btn-outline-success export-btn w-100 mb-2" onclick="exportPartImport()">
                        <i class="bi bi-download"></i> Download Part Import CSV
                    </button>
                    <button class="btn btn-outline-primary export-btn w-100" onclick="exportBOMImport()">
                        <i class="bi bi-download"></i> Download BOM Import CSV
                    </button>
                </div>
                <div class="col-md-6">
                    <h6 class="text-secondary mb-2">Direct API Import</h6>
                    <button class="btn btn-success export-btn w-100 mb-2" onclick="importPartsToFishbowl()">
                        <i class="bi bi-cloud-upload-fill"></i> Import Parts to Fishbowl
                    </button>
                    <button class="btn btn-primary export-btn w-100" onclick="importBOMsToFishbowl()">
                        <i class="bi bi-cloud-upload-fill"></i> Import BOMs to Fishbowl
                    </button>
                </div>
            </div>

            <div class="alert alert-info mt-3 mb-0" style="font-size: 12px;">
                <i class="bi bi-info-circle-fill"></i> <strong>Tip:</strong> Import Parts first, then import BOMs. BOMs require all parts to exist in Fishbowl.
            </div>
        </div>

        <!-- Messages/Alerts Section -->
        <div id="messagesSection">
            <!-- Dynamic alerts will appear here -->
        </div>

        <!-- Debug Section -->
        <div class="debug-section">
            <div class="accordion" id="debugAccordion">
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#debugContent" aria-expanded="false" aria-controls="debugContent">
                            <i class="bi bi-bug-fill me-2"></i> Debug Console
                        </button>
                    </h2>
                    <div id="debugContent" class="accordion-collapse collapse" data-bs-parent="#debugAccordion">
                        <div class="accordion-body p-0">
                            <div class="p-2 bg-dark text-white d-flex justify-content-between align-items-center">
                                <small>Debug log - Auto-scrolls to latest entry</small>
                                <button class="btn btn-sm btn-outline-light" onclick="clearDebugLog()">
                                    <i class="bi bi-trash"></i> Clear
                                </button>
                            </div>
                            <div class="debug-content" id="debugLog">
                                <div class="debug-entry">
                                    <span class="debug-timestamp">[00:00:00]</span>
                                    <span class="debug-type info">[INFO]</span>
                                    <span class="debug-message">Debug console initialized</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS Bundle (includes Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Configuration state
        const config = {
            createAsInventory: true,
            createFinishedGoodsAsProducts: false,
            validatePartsExist: true,
            processStagesSequentially: true
        };

        // Application state
        let solidworksData = null;
        let rawCSVContent = null; // Store raw CSV before processing
        let parsedBOM = null;
        let partsToCreate = [];
        let bomsToCreate = [];
        let bomImportHeaders = null;
        let bomLevelHeaders = [];
        let itemLevelHeaders = [];
        let partImportHeaders = []; // Store part import headers from API
        let solidworksColumns = [];
        let fieldMappings = {};

        // Fishbowl data cache
        let fishbowlData = {
            uoms: [],
            uomDetails: [],
            vendors: [],
            taxCodes: [],
            existingParts: [], // Cache of existing parts in Fishbowl
            partTypes: ['Inventory', 'Non-Inventory', 'Service', 'Labor', 'Overhead', 'Miscellaneous', 'Internal Use', 'Capital Equipment', 'Shipping']
        };

        // User-configurable defaults
        let defaultValues = {
            uom: 'ea',
            taxCode: 'NON',
            weightUOM: 'kg', // Metric default
            sizeUOM: 'cm',   // Metric default
            active: true
        };

        // BOM Field definitions (from Fishbowl documentation)
        const bomFieldDefinitions = {
            'Level': { required: true, desc: 'Hierarchical level (1, 1.1, 1.2, etc.)', validate: false },
            'Number': { required: true, desc: 'Part number in Fishbowl', validate: false },
            'Description': { required: true, desc: 'Part description', validate: false },
            'Details': { required: false, desc: 'Additional details about the part', validate: false },
            'Revision': { required: false, desc: 'Revision identifier', validate: false },
            'Standard Cost': { required: false, desc: 'Anticipated cost per unit', validate: false },
            'Quantity': { required: true, desc: 'Quantity needed in BOM', validate: false },
            'UPC': { required: false, desc: 'Universal Product Code', validate: false },
            'UOM': { required: true, desc: 'Unit of Measure', validateUOM: true },
            'Weight': { required: false, desc: 'Part weight', validate: false },
            'Width': { required: false, desc: 'Part width', validate: false },
            'Height': { required: false, desc: 'Part height', validate: false },
            'Length': { required: false, desc: 'Part length', validate: false },
            'Vendor': { required: false, desc: 'Vendor name', validateVendor: true },
            'Vendor Number': { required: false, desc: 'Vendor part number', validate: false },
            'Vendor Cost': { required: false, desc: 'Cost from vendor', validate: false }
        };

        const MAPPING_STORAGE_KEY = 'solidworksBOMMappings';

        // Debug logging functions
        function debugLog(type, message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'debug-entry';

            let html = `
                <span class="debug-timestamp">[${timestamp}]</span>
                <span class="debug-type ${type}">[${type.toUpperCase()}]</span>
                <span class="debug-message">${message}</span>
            `;

            if (data) {
                const dataStr = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
                html += `<div class="debug-data">${dataStr}</div>`;
            }

            logEntry.innerHTML = html;

            const debugLogEl = document.getElementById('debugLog');
            debugLogEl.appendChild(logEntry);

            // Auto-scroll to bottom
            debugLogEl.scrollTop = debugLogEl.scrollHeight;

            // Also log to console
            console.log(`[${type.toUpperCase()}]`, message, data || '');
        }

        function clearDebugLog() {
            const debugLogEl = document.getElementById('debugLog');
            debugLogEl.innerHTML = `
                <div class="debug-entry">
                    <span class="debug-timestamp">[${new Date().toLocaleTimeString()}]</span>
                    <span class="debug-type info">[INFO]</span>
                    <span class="debug-message">Debug log cleared</span>
                </div>
            `;
        }

        // Check BOM Import API Headers
        function checkBOMImportHeaders() {
            debugLog('info', 'Checking BOM Import API headers...');

            const headerPayload = {
                "ImportHeaderRq": {
                    "Type": "ImportBillOfMaterials"
                }
            };

            try {
                const headerResponse = runApiRequest('ImportHeaderRq', JSON.stringify(headerPayload));

                if (headerResponse) {
                    const headerResult = typeof headerResponse === 'string' ? JSON.parse(headerResponse) : headerResponse;

                    if (headerResult && headerResult.ImportHeaderRs && headerResult.ImportHeaderRs.Header) {
                        bomImportHeaders = headerResult.ImportHeaderRs.Header;
                        debugLog('success', 'BOM Import Headers retrieved successfully');

                        // Parse the two header rows
                        if (bomImportHeaders.Row && bomImportHeaders.Row.length >= 2) {
                            // First row is BOM-level headers
                            bomLevelHeaders = parseCSVLine(bomImportHeaders.Row[0]);
                            debugLog('info', 'BOM-level headers', bomLevelHeaders);

                            // Second row is Item-level headers
                            itemLevelHeaders = parseCSVLine(bomImportHeaders.Row[1]);
                            debugLog('info', 'Item-level headers', itemLevelHeaders);
                        }

                        showMessage('BOM Import headers retrieved successfully', 'success');
                        return bomImportHeaders;
                    } else {
                        debugLog('warning', 'No headers found in response');
                        showMessage('Could not find headers in API response', 'warning');
                    }
                } else {
                    debugLog('error', 'No response from ImportHeaderRq');
                    showMessage('No response from API', 'danger');
                }
            } catch (e) {
                debugLog('error', 'Error querying BOM import headers', e.toString());
                showMessage('Error querying BOM import headers: ' + e.message, 'danger');
            }

            return null;
        }

        function checkPartImportHeaders() {
            debugLog('info', 'Checking Part Import API headers...');

            const headerPayload = {
                "ImportHeaderRq": {
                    "Type": "ImportPartProductAndVendorPricing"
                }
            };

            try {
                const headerResponse = runApiRequest('ImportHeaderRq', JSON.stringify(headerPayload));

                if (headerResponse) {
                    const headerResult = typeof headerResponse === 'string' ? JSON.parse(headerResponse) : headerResponse;

                    if (headerResult && headerResult.ImportHeaderRs && headerResult.ImportHeaderRs.Header) {
                        const headers = headerResult.ImportHeaderRs.Header;
                        debugLog('success', 'Part Import Headers retrieved successfully');

                        // Parse the header row (PPP import has single header row)
                        if (headers.Row && headers.Row.length > 0) {
                            partImportHeaders = parseCSVLine(headers.Row[0]);
                            debugLog('success', 'Part import headers', partImportHeaders);
                        }

                        showMessage('Part Import headers retrieved successfully', 'success');
                        return headers;
                    } else {
                        debugLog('warning', 'No headers found in response');
                        showMessage('Could not find headers in API response', 'warning');
                    }
                } else {
                    debugLog('error', 'No response from ImportHeaderRq');
                    showMessage('No response from API', 'danger');
                }
            } catch (e) {
                debugLog('error', 'Error querying Part import headers', e.toString());
                showMessage('Error querying Part import headers: ' + e.message, 'danger');
            }

            return null;
        }

        // File handling
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        // Drag and drop support
        const uploadSection = document.getElementById('uploadSection');

        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');

            const file = e.dataTransfer.files[0];
            if (file && file.name.endsWith('.csv')) {
                processFile(file);
            } else {
                showMessage('Please drop a CSV file', 'danger');
            }
        });

        // Process uploaded file
        function processFile(file) {
            document.getElementById('fileName').textContent = file.name;

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                parseSolidworksCSV(content);
            };
            reader.readAsText(file);
        }

        // Parse Solidworks CSV - ONLY extract headers
        function parseSolidworksCSV(csvContent) {
            debugLog('info', 'Loading Solidworks BOM CSV...');
            showMessage('Loading Solidworks BOM...', 'info');

            try {
                // Store raw content for later processing
                rawCSVContent = csvContent;

                // Parse CSV into rows
                const lines = csvContent.split('\n').map(line => line.trim()).filter(line => line.length > 0);
                debugLog('info', `Total lines in CSV: ${lines.length}`);

                if (lines.length < 2) {
                    debugLog('error', 'CSV file is empty or has no data rows');
                    showMessage('CSV file is empty or invalid', 'danger');
                    return;
                }

                // Parse header row ONLY
                const headers = parseCSVLine(lines[0]);
                solidworksColumns = headers;
                debugLog('success', `Detected ${headers.length} columns in Solidworks CSV`, headers);

                showMessage(`âœ“ CSV loaded with ${headers.length} columns. Next: Click "Check BOM Headers" button in the toolbar above.`, 'info');

                // Show field mapping button
                document.getElementById('mappingButtonSection').classList.remove('hidden');

                // Try to load saved mappings
                loadSavedMappings();

            } catch (error) {
                debugLog('error', 'Error loading Solidworks CSV', error.toString());
                showMessage('Error loading CSV: ' + error.message, 'danger');
            }
        }

        // Process BOM Data AFTER mappings are configured
        function processBOMData() {
            debugLog('info', 'Processing BOM data with configured mappings...');
            showMessage('Processing BOM data...', 'info');

            try {
                if (!rawCSVContent) {
                    showMessage('No CSV file loaded', 'danger');
                    return;
                }

                // Parse CSV into rows
                const lines = rawCSVContent.split('\n').map(line => line.trim()).filter(line => line.length > 0);

                // Get mapped column names from the new simplified structure
                const levelCol = fieldMappings['Level'];
                const partCol = fieldMappings['Number'];
                const descCol = fieldMappings['Description'];
                const detailsCol = fieldMappings['Details'];
                const revisionCol = fieldMappings['Revision'];
                const standardCostCol = fieldMappings['Standard Cost'];
                const qtyCol = fieldMappings['Quantity'];
                const upcCol = fieldMappings['UPC'];
                const uomCol = fieldMappings['UOM'];
                const weightCol = fieldMappings['Weight'];
                const widthCol = fieldMappings['Width'];
                const heightCol = fieldMappings['Height'];
                const lengthCol = fieldMappings['Length'];
                const vendorCol = fieldMappings['Vendor'];
                const vendorNumberCol = fieldMappings['Vendor Number'];
                const vendorCostCol = fieldMappings['Vendor Cost'];

                debugLog('info', 'Using mapped columns', fieldMappings);

                // Find column indices
                const levelIndex = levelCol ? solidworksColumns.indexOf(levelCol) : -1;
                const partNumIndex = partCol ? solidworksColumns.indexOf(partCol) : -1;
                const descIndex = descCol ? solidworksColumns.indexOf(descCol) : -1;
                const detailsIndex = detailsCol ? solidworksColumns.indexOf(detailsCol) : -1;
                const revisionIndex = revisionCol ? solidworksColumns.indexOf(revisionCol) : -1;
                const costIndex = standardCostCol ? solidworksColumns.indexOf(standardCostCol) : -1;
                const qtyIndex = qtyCol ? solidworksColumns.indexOf(qtyCol) : -1;
                const upcIndex = upcCol ? solidworksColumns.indexOf(upcCol) : -1;
                const uomIndex = uomCol ? solidworksColumns.indexOf(uomCol) : -1;
                const weightIndex = weightCol ? solidworksColumns.indexOf(weightCol) : -1;
                const widthIndex = widthCol ? solidworksColumns.indexOf(widthCol) : -1;
                const heightIndex = heightCol ? solidworksColumns.indexOf(heightCol) : -1;
                const lengthIndex = lengthCol ? solidworksColumns.indexOf(lengthCol) : -1;
                const vendorIndex = vendorCol ? solidworksColumns.indexOf(vendorCol) : -1;
                const vendorNumIndex = vendorNumberCol ? solidworksColumns.indexOf(vendorNumberCol) : -1;
                const vendorCostIndex = vendorCostCol ? solidworksColumns.indexOf(vendorCostCol) : -1;

                // Parse data rows
                const bomItems = [];
                for (let i = 1; i < lines.length; i++) {
                    const row = parseCSVLine(lines[i]);
                    if (row.length > 0) {
                        const item = {
                            level: levelIndex >= 0 ? row[levelIndex] : String(i),
                            partNumber: partNumIndex >= 0 ? row[partNumIndex] : '',
                            description: descIndex >= 0 ? row[descIndex] : '',
                            details: detailsIndex >= 0 ? row[detailsIndex] : '',
                            revision: revisionIndex >= 0 ? row[revisionIndex] : '',
                            standardCost: costIndex >= 0 ? row[costIndex] : '',
                            quantity: qtyIndex >= 0 ? row[qtyIndex] : '1',
                            upc: upcIndex >= 0 ? row[upcIndex] : '',
                            uom: uomIndex >= 0 ? row[uomIndex] : 'ea',
                            weight: weightIndex >= 0 ? row[weightIndex] : '',
                            width: widthIndex >= 0 ? row[widthIndex] : '',
                            height: heightIndex >= 0 ? row[heightIndex] : '',
                            length: lengthIndex >= 0 ? row[lengthIndex] : '',
                            vendor: vendorIndex >= 0 ? row[vendorIndex] : '',
                            vendorNumber: vendorNumIndex >= 0 ? row[vendorNumIndex] : '',
                            vendorCost: vendorCostIndex >= 0 ? row[vendorCostIndex] : '',
                            lineNumber: i + 1,
                            rawData: row // Store full row for later use
                        };
                        bomItems.push(item);
                    }
                }

                debugLog('success', `Parsed ${bomItems.length} BOM items`, bomItems.slice(0, 5));

                // Analyze BOM structure
                analyzeBOMStructure(bomItems);

                solidworksData = bomItems;
                showMessage(`Successfully processed ${bomItems.length} items from Solidworks BOM`, 'success');

            } catch (error) {
                debugLog('error', 'Error processing BOM data', error.toString());
                showMessage('Error processing BOM data: ' + error.message, 'danger');
            }
        }

        // Simple CSV line parser (handles quoted fields)
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];

                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }

            result.push(current.trim());
            return result;
        }

        // Analyze BOM structure and extract parts/BOMs
        function analyzeBOMStructure(bomItems) {
            debugLog('info', 'Analyzing BOM structure...');

            const uniqueParts = new Map();
            const bomStructure = [];
            const bomsByLevel = new Map(); // Track BOMs by their level

            // First pass: identify all unique parts and potential BOMs
            for (let i = 0; i < bomItems.length; i++) {
                const item = bomItems[i];
                const levelParts = item.level.split('.');
                const depth = levelParts.length;

                // Track unique parts
                if (item.partNumber && !uniqueParts.has(item.partNumber)) {
                    uniqueParts.set(item.partNumber, {
                        partNumber: item.partNumber,
                        description: item.description,
                        type: item.type,
                        uom: item.uom
                    });
                }

                // Check if this item has children (is a BOM parent)
                const hasChildren = i < bomItems.length - 1 &&
                    bomItems[i + 1].level.startsWith(item.level + '.');

                if (hasChildren) {
                    // This is a BOM/assembly
                    const bom = {
                        level: item.level,
                        partNumber: item.partNumber,
                        description: item.description,
                        uom: item.uom || defaultValues.uom, // Include UOM from item or default
                        items: [],
                        isStage: depth > 1 // Sub-assemblies are stages
                    };
                    bomsByLevel.set(item.level, bom);
                    bomStructure.push(bom);
                }
            }

            // Second pass: assign items to their parent BOMs
            for (const item of bomItems) {
                const levelParts = item.level.split('.');

                // Find the parent BOM (one level up)
                if (levelParts.length > 1) {
                    const parentLevel = levelParts.slice(0, -1).join('.');
                    const parentBOM = bomsByLevel.get(parentLevel);

                    if (parentBOM) {
                        // This item belongs to the parent BOM
                        parentBOM.items.push(item);
                    }
                }
            }

            // Filter out parts that already exist in Fishbowl (if validation enabled)
            let allParts = Array.from(uniqueParts.values());

            // Sort BOMs by depth (deepest first) so stages are created before their parent BOMs
            bomStructure.sort((a, b) => {
                const aDepth = a.level.split('.').length;
                const bDepth = b.level.split('.').length;
                return bDepth - aDepth; // Descending order (deepest first)
            });

            bomsToCreate = bomStructure;
            debugLog('info', `BOMs sorted by depth for bottom-up creation (deepest first)`);
            if (bomsToCreate.length > 0) {
                debugLog('info', `BOM creation order example: ${bomsToCreate.slice(0, 5).map(b => `${b.level} (${b.partNumber})`).join(', ')}`);
            }

            // Validate UOMs and apply defaults
            const invalidUOMs = [];
            const missingUOMs = [];
            allParts.forEach(part => {
                // Apply default UOM if missing or empty
                if (!part.uom || part.uom.trim() === '') {
                    part.uom = defaultValues.uom;
                    missingUOMs.push(part.partNumber);
                }

                // Validate UOM against Fishbowl UOMs (if loaded)
                if (fishbowlData.uoms.length > 0 && !fishbowlData.uoms.includes(part.uom)) {
                    invalidUOMs.push({ partNumber: part.partNumber, uom: part.uom });
                }
            });

            if (missingUOMs.length > 0) {
                debugLog('info', `Applied default UOM "${defaultValues.uom}" to ${missingUOMs.length} parts without UOM`, missingUOMs.slice(0, 10));
            }

            if (invalidUOMs.length > 0) {
                debugLog('warning', `Found ${invalidUOMs.length} parts with invalid UOMs (not in Fishbowl)`, invalidUOMs.slice(0, 10));
                showMessage(`âš ï¸ Warning: ${invalidUOMs.length} parts have UOMs that don't exist in Fishbowl. Create these UOMs first or update the BOM.`, 'warning');
            }

            if (config.validatePartsExist && fishbowlData.existingParts.length > 0) {
                const existingPartsSet = new Set(fishbowlData.existingParts);
                const newParts = [];
                const existingParts = [];

                allParts.forEach(part => {
                    if (existingPartsSet.has(part.partNumber)) {
                        existingParts.push(part);
                    } else {
                        newParts.push(part);
                    }
                });

                partsToCreate = newParts;

                debugLog('success', `Found ${allParts.length} unique parts: ${newParts.length} new, ${existingParts.length} already exist`);
                if (existingParts.length > 0) {
                    debugLog('info', 'Parts that already exist in Fishbowl', existingParts.slice(0, 10).map(p => p.partNumber));
                    showMessage(`Found ${existingParts.length} parts that already exist in Fishbowl - only creating ${newParts.length} new parts`, 'info');
                }
            } else {
                partsToCreate = allParts;
                debugLog('success', `Found ${partsToCreate.length} unique parts (validation ${config.validatePartsExist ? 'pending' : 'disabled'})`);
            }

            debugLog('success', `Identified ${partsToCreate.length} parts to create`, partsToCreate.slice(0, 5));
            debugLog('success', `Identified ${bomsToCreate.length} BOMs/assemblies`, bomsToCreate);

            updateStats({
                total: bomItems.length,
                parts: partsToCreate.length,
                newParts: partsToCreate.length, // Will be refined later
                boms: bomsToCreate.length,
                warnings: 0,
                errors: 0
            });

            // Show parts section and BOMs section
            displayPartsToCreate();
            displayBOMsToCreate();

            // Show field mapping button
            document.getElementById('mappingButtonSection').classList.remove('hidden');
        }

        // Display BOMs to create in table
        function displayBOMsToCreate() {
            const tbody = document.getElementById('bomsTableBody');
            tbody.innerHTML = '';

            for (const bom of bomsToCreate) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${bom.partNumber}</td>
                    <td>${bom.partNumber}</td>
                    <td>${bom.items.length}</td>
                    <td>${bom.isStage ? '<span class="badge bg-info">Stage</span>' : '<span class="badge bg-primary">Main</span>'}</td>
                    <td><span class="badge bg-warning">To Create</span></td>
                `;
                tbody.appendChild(row);
            }

            // Update count in accordion header
            document.getElementById('bomsCount').textContent = bomsToCreate.length;

            if (bomsToCreate.length > 0) {
                document.getElementById('bomsSection').classList.remove('hidden');
            }
        }

        // Load Fishbowl data (UOMs, Vendors, Tax Codes, etc.)
        function loadFishbowlData() {
            debugLog('info', 'Loading Fishbowl data (UOMs, Vendors, Tax Codes)...');

            try {
                // Load UOMs
                debugLog('info', 'Loading UOMs...');
                const uomQuery = `SELECT code, name, uomtype FROM uom WHERE activeflag = 1 ORDER BY code`;
                const uomResult = runQuery(uomQuery);

                if (uomResult) {
                    let uoms = JSON.parse(uomResult);
                    if (uoms && !Array.isArray(uoms)) uoms = [uoms];
                    fishbowlData.uoms = uoms.map(u => u.code);
                    fishbowlData.uomDetails = uoms;
                    debugLog('success', `Loaded ${fishbowlData.uoms.length} UOMs`, fishbowlData.uoms);
                } else {
                    debugLog('warning', 'No UOMs loaded from Fishbowl');
                    fishbowlData.uoms = [];
                    fishbowlData.uomDetails = [];
                }

                // Load Vendors
                debugLog('info', 'Loading Vendors...');
                const vendorQuery = `SELECT name FROM vendor WHERE activeflag = 1 ORDER BY name`;
                const vendorResult = runQuery(vendorQuery);

                if (vendorResult) {
                    let vendors = JSON.parse(vendorResult);
                    if (vendors && !Array.isArray(vendors)) vendors = [vendors];
                    fishbowlData.vendors = vendors.map(v => v.name);
                    debugLog('success', `Loaded ${fishbowlData.vendors.length} Vendors`, fishbowlData.vendors.slice(0, 10));
                } else {
                    debugLog('warning', 'No Vendors loaded from Fishbowl');
                    fishbowlData.vendors = [];
                }

                // Load Tax Codes
                debugLog('info', 'Loading Tax Codes...');
                const taxQuery = `SELECT code, name FROM taxrate WHERE activeflag = 1 ORDER BY code`;
                const taxResult = runQuery(taxQuery);

                if (taxResult) {
                    let taxCodes = JSON.parse(taxResult);
                    if (taxCodes && !Array.isArray(taxCodes)) taxCodes = [taxCodes];
                    fishbowlData.taxCodes = taxCodes.map(t => t.code);
                    debugLog('success', `Loaded ${fishbowlData.taxCodes.length} Tax Codes`, fishbowlData.taxCodes);
                } else {
                    debugLog('warning', 'No Tax Codes loaded from Fishbowl');
                    fishbowlData.taxCodes = [];
                }

                // Load Existing Parts (for validation)
                debugLog('info', 'Loading existing parts from Fishbowl...');
                const partsQuery = `SELECT num FROM part WHERE activeflag = 1`;
                const partsResult = runQuery(partsQuery);

                if (partsResult) {
                    let parts = JSON.parse(partsResult);
                    if (parts && !Array.isArray(parts)) parts = [parts];
                    fishbowlData.existingParts = parts.map(p => p.num);
                    debugLog('success', `Loaded ${fishbowlData.existingParts.length} existing parts from Fishbowl`);
                } else {
                    debugLog('warning', 'No existing parts loaded from Fishbowl');
                    fishbowlData.existingParts = [];
                }

                // Populate settings dropdowns if they exist
                populateSettingsDropdowns();

                return true;

            } catch (error) {
                debugLog('error', 'Error loading Fishbowl data', error.toString());
                showMessage('Warning: Could not load data from Fishbowl', 'warning');
                return false;
            }
        }

        // Field Mapping Functions
        function openFieldMappingDialog() {
            debugLog('info', 'User requested to open field mapping dialog');

            // Load Fishbowl data if not already loaded
            if (fishbowlData.uoms.length === 0 || fishbowlData.vendors.length === 0) {
                debugLog('info', 'Fishbowl data not loaded yet - loading...');
                showMessage('Loading UOMs and Vendors from Fishbowl...', 'info');
                loadFishbowlData();
            }

            // Populate the mapping UI
            populateFieldMappings();

            // Show the modal
            const modalElement = document.getElementById('fieldMappingModal');
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }

        function populateFieldMappings() {
            debugLog('info', 'Populating field mapping UI with simplified BOM fields');
            debugLog('info', `Solidworks columns count: ${solidworksColumns.length}`, solidworksColumns);

            if (solidworksColumns.length === 0) {
                debugLog('error', 'Solidworks columns are empty!');
                showMessage('No Solidworks columns detected. Please upload a valid CSV file.', 'danger');
                return;
            }

            // Clear existing mappings
            const bomMappingsDiv = document.getElementById('bomLevelMappings');
            const itemMappingsDiv = document.getElementById('itemLevelMappings');
            bomMappingsDiv.innerHTML = '';
            itemMappingsDiv.innerHTML = '';

            // Create mapping rows for each BOM field
            let rowCount = 0;
            Object.keys(bomFieldDefinitions).forEach((field, index) => {
                const fieldDef = bomFieldDefinitions[field];
                const isRequired = fieldDef.required;
                const row = createMappingRow(field, isRequired, 'bom', index, fieldDef.desc);
                bomMappingsDiv.appendChild(row);
                rowCount++;
            });

            debugLog('success', `Created ${rowCount} BOM field mapping rows`);
        }

        function createMappingRow(fishbowlField, isRequired, level, index, description) {
            const row = document.createElement('div');
            row.className = 'mapping-row';

            const labelDiv = document.createElement('div');
            labelDiv.className = 'mapping-label';

            const labelText = document.createElement('div');
            if (isRequired) {
                labelText.classList.add('required-field');
            }
            labelText.textContent = fishbowlField;
            labelDiv.appendChild(labelText);

            if (description) {
                const descText = document.createElement('small');
                descText.className = 'text-muted d-block';
                descText.style.fontSize = '11px';
                descText.style.fontWeight = 'normal';
                descText.textContent = description;
                labelDiv.appendChild(descText);
            }

            const arrow = document.createElement('div');
            arrow.className = 'mapping-arrow';
            arrow.innerHTML = '<i class="bi bi-arrow-left"></i>';

            const select = document.createElement('select');
            select.className = 'mapping-select form-select';
            select.id = `mapping-${level}-${index}`;
            select.dataset.field = fishbowlField;
            select.dataset.level = level;
            select.dataset.required = isRequired;

            // Add "None" option
            const noneOption = document.createElement('option');
            noneOption.value = '';
            noneOption.textContent = '-- None --';
            select.appendChild(noneOption);

            // Add Solidworks column options
            solidworksColumns.forEach(col => {
                const option = document.createElement('option');
                option.value = col;
                option.textContent = col;

                // Check if we have a loaded mapping for this field (takes priority)
                if (fieldMappings[fishbowlField] && fieldMappings[fishbowlField] === col) {
                    option.selected = true;
                }
                // Otherwise, try to auto-match based on field name similarity
                else if (!fieldMappings[fishbowlField] && autoMatchField(fishbowlField, col)) {
                    option.selected = true;
                }

                select.appendChild(option);
            });

            row.appendChild(labelDiv);
            row.appendChild(arrow);
            row.appendChild(select);

            return row;
        }

        function autoMatchField(fishbowlField, solidworksColumn) {
            const fb = fishbowlField.toLowerCase();
            const sw = solidworksColumn.toLowerCase();

            // Direct matches
            if (fb === sw) return true;

            // Common mappings
            const mappings = {
                'level': ['level', 'item', 'line'],
                'number': ['p/n', 'part', 'number', 'part number', 'partnumber', 'part num', 'pn', 'item'],
                'description': ['description', 'desc', 'name'],
                'details': ['details', 'notes', 'comments'],
                'revision': ['revision', 'rev', 'version'],
                'standard cost': ['cost', 'standard cost', 'unit cost'],
                'quantity': ['qty', 'quantity', 'amount', 'qnty'],
                'upc': ['upc', 'barcode', 'ean'],
                'uom': ['uom', 'unit', 'units', 'u/m'],
                'weight': ['weight', 'wt', 'mass'],
                'width': ['width', 'w'],
                'height': ['height', 'h'],
                'length': ['length', 'l', 'len'],
                'vendor': ['vendor', 'supplier', 'mfg', 'manufacturer'],
                'vendor number': ['vendor number', 'vendor p/n', 'vendor part', 'mfg part'],
                'vendor cost': ['vendor cost', 'purchase cost', 'buy cost']
            };

            if (mappings[fb]) {
                return mappings[fb].some(match => sw.includes(match));
            }

            return false;
        }

        function saveMappings() {
            debugLog('info', 'Saving field mappings...');

            const mappings = {};

            // Collect all field mappings
            const allSelects = document.querySelectorAll('select[data-level="bom"]');
            let hasErrors = false;

            allSelects.forEach(select => {
                const field = select.dataset.field;
                const isRequired = select.dataset.required === 'true';
                const value = select.value;

                if (isRequired && !value) {
                    showMessage(`Required field "${field}" must be mapped`, 'danger');
                    select.classList.add('is-invalid');
                    hasErrors = true;
                } else {
                    select.classList.remove('is-invalid');
                    if (value) {
                        mappings[field] = value;
                    }
                }
            });

            if (hasErrors) {
                debugLog('error', 'Field mapping validation failed - required fields missing');
                return;
            }

            fieldMappings = mappings;
            debugLog('success', 'Field mappings saved', fieldMappings);

            // Save to localStorage for future use
            saveMappingToLocalStorage(mappings);

            showMessage('Field mappings saved successfully', 'success');

            // Close the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('fieldMappingModal'));
            modal.hide();

            // Now process the BOM data with the configured mappings
            processBOMData();
        }

        // Save mapping to localStorage
        function saveMappingToLocalStorage(mappings) {
            try {
                const mappingData = {
                    mappings: mappings,
                    solidworksColumns: solidworksColumns,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem(MAPPING_STORAGE_KEY, JSON.stringify(mappingData));
                debugLog('success', 'Mappings saved to browser storage');
            } catch (e) {
                if (e.name === 'SecurityError') {
                    debugLog('info', 'localStorage not available (running in restricted context)');
                } else {
                    debugLog('warning', 'Could not save mappings to localStorage', e.toString());
                }
            }
        }

        // Load saved mappings from localStorage
        function loadSavedMappings() {
            try {
                const saved = localStorage.getItem(MAPPING_STORAGE_KEY);
                if (saved) {
                    const mappingData = JSON.parse(saved);
                    debugLog('info', 'Found saved mappings from ' + mappingData.timestamp);

                    // Check if the columns match
                    const savedCols = mappingData.solidworksColumns || [];
                    const currentCols = solidworksColumns;

                    const colsMatch = savedCols.length === currentCols.length &&
                        savedCols.every((col, i) => col === currentCols[i]);

                    if (colsMatch) {
                        debugLog('success', 'Saved mappings match current CSV columns - auto-loading');
                        fieldMappings = mappingData.mappings;

                        // Apply mappings to UI dropdowns
                        applyMappingsToUI();

                        showMessage('Loaded saved field mappings from previous session', 'success');

                        // Auto-process if we have CSV
                        if (rawCSVContent) {
                            debugLog('info', 'Auto-processing BOM with saved mappings');
                            setTimeout(() => processBOMData(), 500);
                        }
                    } else {
                        debugLog('warning', 'Saved mappings do not match current CSV columns');
                        showMessage('Found saved mappings but column structure has changed', 'warning');
                    }
                }
            } catch (e) {
                if (e.name === 'SecurityError') {
                    debugLog('info', 'localStorage not available (running in restricted context)');
                } else {
                    debugLog('error', 'Error loading saved mappings', e.toString());
                }
            }
        }

        // Export mapping to JSON file
        function exportMappingFile() {
            const mappingData = {
                mappings: fieldMappings,
                solidworksColumns: solidworksColumns,
                bomLevelHeaders: bomLevelHeaders,
                itemLevelHeaders: itemLevelHeaders,
                timestamp: new Date().toISOString(),
                version: '1.0'
            };

            const content = JSON.stringify(mappingData, null, 2);
            downloadCSV(content, 'bom_field_mappings.json');
            debugLog('success', 'Mapping configuration exported');
        }

        // Import mapping from JSON file
        function importMappingFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';

            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const mappingData = JSON.parse(event.target.result);
                        fieldMappings = mappingData.mappings;
                        debugLog('success', 'Mapping configuration imported from file', fieldMappings);

                        // Apply the loaded mappings to the UI dropdowns
                        applyMappingsToUI();

                        showMessage('Field mappings imported successfully', 'success');

                        // Apply the mappings if we have data
                        if (rawCSVContent) {
                            processBOMData();
                        }
                    } catch (err) {
                        debugLog('error', 'Error parsing mapping file', err.toString());
                        showMessage('Error importing mapping file: ' + err.message, 'danger');
                    }
                };
                reader.readAsText(file);
            };

            input.click();
        }

        // Apply loaded mappings to the UI dropdowns
        function applyMappingsToUI() {
            debugLog('info', 'Applying loaded mappings to UI');

            // Find all mapping dropdowns
            const allSelects = document.querySelectorAll('select[data-level="bom"]');

            allSelects.forEach(select => {
                const field = select.dataset.field;

                // If we have a mapping for this field, set the dropdown value
                if (fieldMappings[field]) {
                    select.value = fieldMappings[field];
                    debugLog('info', `Set ${field} -> ${fieldMappings[field]}`);
                }
            });

            debugLog('success', 'Applied mappings to UI dropdowns');
        }

        // Display parts to create in table
        function displayPartsToCreate() {
            const tbody = document.getElementById('partsTableBody');
            tbody.innerHTML = '';

            for (const part of partsToCreate) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${part.partNumber}</td>
                    <td>${part.description}</td>
                    <td>${part.uom || 'ea'}</td>
                    <td>${config.createAsInventory ? 'Inventory' : (part.type || 'Inventory')}</td>
                    <td><span class="badge bg-warning">To Create</span></td>
                `;
                tbody.appendChild(row);
            }

            // Update count in accordion header
            document.getElementById('partsCount').textContent = partsToCreate.length;

            document.getElementById('partsSection').classList.remove('hidden');
            document.getElementById('exportSection').classList.remove('hidden');
        }

        // Export functions
        function exportPartImport() {
            debugLog('info', 'Starting Part/Product/Vendor Pricing CSV export...');

            if (partsToCreate.length === 0) {
                showMessage('No parts to export', 'warning');
                return;
            }

            try {
                // PPP Import format with all key fields from Fishbowl documentation
                // Required fields: PartNumber, PartDescription, UOM, PartTypeID, Active, PartTaxCode
                const headers = [
                    'PartNumber', 'PartDescription', 'PartDetails', 'UOM', 'UPC',
                    'PartTypeID', 'Active', 'PartTaxCode', 'StdCost', 'ABCCode',
                    'Weight', 'WeightUOM', 'Width', 'Height', 'Len', 'SizeUOM',
                    'PartRevision', 'PartURL',
                    'Vendor', 'VendorPartNumber', 'Cost', 'VendorUOM', 'DefaultVendor'
                ];
                const rows = [];

                // Header row
                rows.push(headers.map(h => `"${h}"`).join(','));

                // Data rows
                for (const part of partsToCreate) {
                    // Map part type to PartTypeID (10=INVENTORY by default)
                    let partTypeID = '10'; // 10=INVENTORY (default)
                    if (!config.createAsInventory && part.type) {
                        const typeMap = {
                            'Inventory': '10',
                            'Service': '20',
                            'Labor': '21',
                            'Overhead': '22',
                            'Non-Inventory': '30',
                            'Internal Use': '40',
                            'Capital Equipment': '50',
                            'Shipping': '60'
                        };
                        partTypeID = typeMap[part.type] || '10';
                    }

                    const row = [
                        part.partNumber || '',
                        part.description || '',
                        part.details || '',
                        part.uom || defaultValues.uom,
                        part.upc || '',
                        partTypeID, // PartTypeID (required)
                        'true', // Active
                        defaultValues.taxCode, // PartTaxCode
                        part.standardCost || '', // StdCost
                        'B', // ABCCode (default to B)
                        part.weight || '',
                        part.weight ? defaultValues.weightUOM : '', // WeightUOM
                        part.width || '',
                        part.height || '',
                        part.length || '',
                        (part.width || part.height || part.length) ? defaultValues.sizeUOM : '', // SizeUOM
                        part.revision || '',
                        '', // PartURL
                        part.vendor || '',
                        part.vendorNumber || '',
                        part.vendorCost || '',
                        part.vendor ? (part.uom || defaultValues.uom) : '', // VendorUOM
                        part.vendor ? 'true' : '' // DefaultVendor
                    ];
                    rows.push(row.map(v => `"${v}"`).join(','));
                }

                const csvContent = rows.join('\n');
                debugLog('success', `Generated Part/Product/Vendor Pricing CSV with ${partsToCreate.length} parts`);

                downloadCSV(csvContent, 'part_product_vendor_pricing.csv');
                showMessage(`Exported ${partsToCreate.length} parts in PPP format`, 'success');

            } catch (error) {
                debugLog('error', 'Error generating Part Import CSV', error.toString());
                showMessage('Error generating Part Import CSV: ' + error.message, 'danger');
            }
        }

        function exportBOMImport() {
            debugLog('info', 'Starting BOM Import CSV export...');

            if (bomsToCreate.length === 0) {
                showMessage('No BOMs to export', 'warning');
                return;
            }

            // Check if mappings are configured (new flat structure)
            if (!fieldMappings || Object.keys(fieldMappings).length === 0) {
                showMessage('Please configure field mappings first', 'warning');
                debugLog('warning', 'Field mappings not configured');
                return;
            }

            // Auto-load BOM import headers if not loaded
            if (!bomLevelHeaders.length || !itemLevelHeaders.length) {
                debugLog('info', 'BOM import headers not loaded - loading now...');
                checkBOMImportHeaders();

                if (!bomLevelHeaders.length || !itemLevelHeaders.length) {
                    showMessage('Failed to load BOM import headers', 'danger');
                    return;
                }
            }

            try {
                const rows = [];

                // Row 1: BOM-level headers (exactly as from API)
                rows.push(bomLevelHeaders.map(h => `"${h}"`).join(','));

                // Row 2: Item-level headers (exactly as from API)
                rows.push(itemLevelHeaders.map(h => `"${h}"`).join(','));

                // Generate BOM rows
                for (let i = 0; i < bomsToCreate.length; i++) {
                    const bom = bomsToCreate[i];

                    // Log first BOM as example
                    if (i === 0) {
                        debugLog('info', `Generating BOM rows (example): ${bom.partNumber}`);
                    }

                    // BOM-level row (Flag = "BOM")
                    const bomRow = generateBOMRow(bom);
                    rows.push(bomRow);

                    // First item: Finished Good output
                    const finishedGoodRow = generateFinishedGoodRow(bom);
                    rows.push(finishedGoodRow);

                    // Item-level rows (Flag = "Item") for each component
                    for (const item of bom.items) {
                        const itemRow = generateItemRow(bom, item);
                        rows.push(itemRow);
                    }
                }

                const csvContent = rows.join('\n');
                debugLog('success', `Generated BOM Import CSV with ${bomsToCreate.length} BOMs`);
                debugLog('info', 'CSV Preview (first 500 chars)', csvContent.substring(0, 500));

                downloadCSV(csvContent, 'bom_import.csv');
                showMessage(`Exported ${bomsToCreate.length} BOMs successfully`, 'success');

            } catch (error) {
                debugLog('error', 'Error generating BOM Import CSV', error.toString());
                showMessage('Error generating BOM Import CSV: ' + error.message, 'danger');
            }
        }

        function generateBOMRow(bom) {
            const row = [];

            // For each BOM-level header, generate the value
            for (const header of bomLevelHeaders) {
                let value = '';

                if (header === 'Flag') {
                    value = 'BOM';
                } else if (header === 'Number') {
                    value = bom.partNumber || '';
                } else if (header === 'Description') {
                    value = bom.description || '';
                } else if (header === 'Active') {
                    value = 'true';
                } else {
                    // For other fields, leave empty
                    value = '';
                }

                // Properly escape quotes (like PPP validator)
                row.push('"' + String(value).replace(/"/g, '""') + '"');
            }

            return row.join(',');
        }

        function generateFinishedGoodRow(bom) {
            const row = [];

            // For each Item-level header, generate the Finished Good output
            for (const header of itemLevelHeaders) {
                let value = '';

                if (header === 'Flag') {
                    value = 'Item';
                } else if (header === 'Part') {
                    value = bom.partNumber || '';
                } else if (header === 'Quantity') {
                    value = '1';
                } else if (header === 'UOM') {
                    value = bom.uom || defaultValues.uom;
                } else if (header === 'Description') {
                    value = bom.description || '';
                } else if (header === 'Type') {
                    value = 'Finished Good';
                } else if (header === 'IsStage') {
                    value = 'false';
                } else if (header === 'StageBOMNumber') {
                    value = '';
                } else if (header === 'IsVariableQuantity') {
                    value = 'false';
                } else if (header === 'MinQuantity' || header === 'MaxQuantity') {
                    value = '0';
                } else if (header === 'IsGroupDefault') {
                    value = 'true';
                } else if (header === 'PriceAdjustment') {
                    value = '0.00';
                } else if (header === 'IsOneTimeItem') {
                    value = 'false';
                } else if (header === 'ConfigurationSortOrder') {
                    value = '1';
                } else {
                    // For any other fields, leave empty
                    value = '';
                }

                // Properly escape quotes (like PPP validator)
                row.push('"' + String(value).replace(/"/g, '""') + '"');
            }

            return row.join(',');
        }

        function generateItemRow(bom, item) {
            const row = [];

            // For each Item-level header, generate the value
            for (const header of itemLevelHeaders) {
                let value = '';

                if (header === 'Flag') {
                    value = 'Item';
                } else if (header === 'Part') {
                    value = item.partNumber || '';
                } else if (header === 'Quantity') {
                    value = item.quantity || '1';
                } else if (header === 'UOM') {
                    value = item.uom || defaultValues.uom;
                } else if (header === 'Description') {
                    value = item.description || '';
                } else if (header === 'Type') {
                    value = item.type || 'Raw Good';
                } else if (header === 'IsStage') {
                    // Check if this item has its own BOM
                    const hasOwnBOM = bomsToCreate.find(b => b.partNumber === item.partNumber);
                    value = hasOwnBOM ? 'true' : 'false';
                } else if (header === 'StageBOMNumber') {
                    // If it's a stage, reference the stage BOM
                    const hasOwnBOM = bomsToCreate.find(b => b.partNumber === item.partNumber);
                    value = hasOwnBOM ? item.partNumber : '';
                } else if (header === 'IsVariableQuantity') {
                    value = 'false';
                } else if (header === 'MinQuantity' || header === 'MaxQuantity') {
                    value = '0';
                } else if (header === 'IsGroupDefault') {
                    value = 'true';
                } else if (header === 'PriceAdjustment') {
                    value = '0.00';
                } else if (header === 'IsOneTimeItem') {
                    value = 'false';
                } else if (header === 'ConfigurationSortOrder') {
                    value = '1';
                } else {
                    // For any other fields, leave empty
                    value = '';
                }

                // Properly escape quotes (like PPP validator)
                row.push('"' + String(value).replace(/"/g, '""') + '"');
            }

            return row.join(',');
        }

        function getItemData(item) {
            // Find the original row data from solidworksData
            const foundItem = solidworksData.find(d => d.level === item.level && d.partNumber === item.partNumber);
            if (!foundItem) return null;

            // Create a map of column name to value
            const data = {};
            solidworksColumns.forEach((col, index) => {
                // Store the data using column names
                if (col === 'LEVEL') data[col] = foundItem.level;
                if (col === 'Description') data[col] = foundItem.description;
                if (col === 'PGE P/N#') data[col] = foundItem.partNumber;
                if (col === 'Ordering type') data[col] = foundItem.type;
                if (col === 'Qty') data[col] = foundItem.quantity;
                if (col === 'uom') data[col] = foundItem.uom;
            });

            return data;
        }

        // API Import Functions
        function importPartsToFishbowl() {
            debugLog('info', 'Starting direct Part import to Fishbowl...');

            if (partsToCreate.length === 0) {
                showMessage('No parts to import', 'warning');
                return;
            }

            try {
                // Use standard PPP import headers (same as PPP Pricing Validator)
                const headers = [
                    'PartNumber', 'PartDescription', 'PartDetails', 'UOM', 'UPC',
                    'PartTypeID', 'Active', 'PartTaxCode', 'StdCost', 'ABCCode',
                    'Weight', 'WeightUOM', 'Width', 'Height', 'Len', 'SizeUOM',
                    'PartRevision', 'PartURL',
                    'Vendor', 'VendorPartNumber', 'Cost', 'VendorUOM', 'DefaultVendor'
                ];

                const rows = [];

                // Header row (escape quotes like PPP validator)
                rows.push(headers.map(h => '"' + h.replace(/"/g, '""') + '"').join(','));

                // Data rows
                for (let i = 0; i < partsToCreate.length; i++) {
                    const part = partsToCreate[i];

                    // Log first part as example
                    if (i === 0) {
                        debugLog('info', `Generating part row (example): ${part.partNumber}`);
                    }

                    // Map part type to PartTypeID (10=INVENTORY by default)
                    let partTypeID = '10'; // 10=INVENTORY (default)
                    if (!config.createAsInventory && part.type) {
                        const typeMap = {
                            'Inventory': '10',
                            'Service': '20',
                            'Labor': '21',
                            'Overhead': '22',
                            'Non-Inventory': '30',
                            'Internal Use': '40',
                            'Capital Equipment': '50',
                            'Shipping': '60'
                        };
                        partTypeID = typeMap[part.type] || '10';
                    }

                    const row = [
                        part.partNumber || '',
                        part.description || '',
                        part.details || '',
                        part.uom || defaultValues.uom,
                        part.upc || '',
                        partTypeID, // PartTypeID (required)
                        'true', // Active
                        defaultValues.taxCode, // PartTaxCode
                        part.standardCost || '', // StdCost
                        'B', // ABCCode (default to B)
                        part.weight || '',
                        part.weight ? defaultValues.weightUOM : '', // WeightUOM
                        part.width || '',
                        part.height || '',
                        part.length || '',
                        (part.width || part.height || part.length) ? defaultValues.sizeUOM : '', // SizeUOM
                        part.revision || '',
                        '', // PartURL
                        part.vendor || '',
                        part.vendorNumber || '',
                        part.vendorCost || '',
                        part.vendor ? (part.uom || defaultValues.uom) : '', // VendorUOM
                        part.vendor ? 'true' : '' // DefaultVendor
                    ];

                    // Properly escape quotes in values (like PPP validator)
                    const escapedRow = row.map(v => '"' + String(v).replace(/"/g, '""') + '"').join(',');
                    rows.push(escapedRow);
                }

                // Build API request payload
                const payload = {
                    "ImportRq": {
                        "Type": "ImportPartProductAndVendorPricing",
                        "Rows": {
                            "Row": rows
                        }
                    }
                };

                debugLog('info', `Importing ${partsToCreate.length} parts to Fishbowl...`);
                debugLog('info', 'Import payload preview (first 3 rows)', rows.slice(0, 3));

                showMessage(`Importing ${partsToCreate.length} parts to Fishbowl...`, 'info');
                showProgress('Importing parts to Fishbowl...', 50);

                // Call the Fishbowl API
                const response = runApiRequest('ImportRq', JSON.stringify(payload));
                debugLog('info', 'Part import response received', response);

                hideProgress();

                if (!response) {
                    showMessage('Part import failed: No response from API', 'danger');
                    debugLog('error', 'Part import failed: No response from API');
                    return;
                }

                // Parse response
                const result = typeof response === 'string' ? JSON.parse(response) : response;
                debugLog('success', 'Part import response parsed', result);

                // Check for errors in response
                if (result && result.ImportRs) {
                    const importRs = result.ImportRs;

                    // statusCode can be either number or string
                    if (importRs.statusCode === 1000 || importRs.statusCode === '1000') {
                        // Success
                        showMessage(`âœ“ Successfully imported ${partsToCreate.length} parts to Fishbowl!`, 'success');
                        debugLog('success', `Part import successful - ${partsToCreate.length} parts created`);

                        // Update UI to show parts were imported
                        updatePartsStatus('imported');
                    } else {
                        // Error
                        const errorMsg = importRs.statusMessage || 'Unknown error';
                        showMessage(`Part import failed: ${errorMsg}`, 'danger');
                        debugLog('error', 'Part import failed', importRs);
                    }
                } else {
                    showMessage('Unexpected response format from API', 'warning');
                    debugLog('warning', 'Unexpected response format', result);
                }

            } catch (error) {
                hideProgress();
                debugLog('error', 'Error during Part import', error.toString());
                showMessage('Error importing parts: ' + error.message, 'danger');
            }
        }

        function importBOMsToFishbowl() {
            debugLog('info', 'Starting direct BOM import to Fishbowl...');

            if (bomsToCreate.length === 0) {
                showMessage('No BOMs to import', 'warning');
                return;
            }

            // Check if mappings are configured (new flat structure)
            if (!fieldMappings || Object.keys(fieldMappings).length === 0) {
                showMessage('Please configure field mappings first', 'warning');
                debugLog('warning', 'Field mappings not configured');
                return;
            }

            // Auto-load BOM import headers if not loaded
            if (!bomLevelHeaders.length || !itemLevelHeaders.length) {
                debugLog('info', 'BOM import headers not loaded - loading now...');
                checkBOMImportHeaders();

                if (!bomLevelHeaders.length || !itemLevelHeaders.length) {
                    showMessage('Failed to load BOM import headers', 'danger');
                    return;
                }
            }

            try {
                const rows = [];

                // Row 1: BOM-level headers (exactly as from API)
                rows.push(bomLevelHeaders.map(h => `"${h}"`).join(','));

                // Row 2: Item-level headers (exactly as from API)
                rows.push(itemLevelHeaders.map(h => `"${h}"`).join(','));

                // Generate BOM rows
                for (let i = 0; i < bomsToCreate.length; i++) {
                    const bom = bomsToCreate[i];

                    // Log first BOM as example
                    if (i === 0) {
                        debugLog('info', `Adding BOM to import (example): ${bom.partNumber}`);
                    }

                    // BOM-level row (Flag = "BOM")
                    const bomRow = generateBOMRow(bom);
                    rows.push(bomRow);

                    // First item: Finished Good output
                    const finishedGoodRow = generateFinishedGoodRow(bom);
                    rows.push(finishedGoodRow);

                    // Item-level rows (Flag = "Item") for each component
                    for (const item of bom.items) {
                        const itemRow = generateItemRow(bom, item);
                        rows.push(itemRow);
                    }
                }

                // Build API request payload
                const payload = {
                    "ImportRq": {
                        "Type": "ImportBillOfMaterials",
                        "Rows": {
                            "Row": rows
                        }
                    }
                };

                debugLog('info', `Importing ${bomsToCreate.length} BOMs to Fishbowl...`);
                debugLog('info', 'Import payload preview (first 5 rows)', rows.slice(0, 5));

                showMessage(`Importing ${bomsToCreate.length} BOMs to Fishbowl...`, 'info');
                showProgress('Importing BOMs to Fishbowl...', 50);

                // Call the Fishbowl API
                const response = runApiRequest('ImportRq', JSON.stringify(payload));
                debugLog('info', 'BOM import response received', response);

                hideProgress();

                if (!response) {
                    showMessage('BOM import failed: No response from API', 'danger');
                    debugLog('error', 'BOM import failed: No response from API');
                    return;
                }

                // Parse response
                const result = typeof response === 'string' ? JSON.parse(response) : response;
                debugLog('success', 'BOM import response parsed', result);

                // Check for errors in response
                if (result && result.ImportRs) {
                    const importRs = result.ImportRs;

                    // statusCode can be either number or string
                    if (importRs.statusCode === 1000 || importRs.statusCode === '1000') {
                        // Success
                        showMessage(`âœ“ Successfully imported ${bomsToCreate.length} BOMs to Fishbowl!`, 'success');
                        debugLog('success', `BOM import successful - ${bomsToCreate.length} BOMs created`);

                        // Update UI to show BOMs were imported
                        updateBOMsStatus('imported');
                    } else {
                        // Error
                        const errorMsg = importRs.statusMessage || 'Unknown error';
                        showMessage(`BOM import failed: ${errorMsg}`, 'danger');
                        debugLog('error', 'BOM import failed', importRs);
                    }
                } else {
                    showMessage('Unexpected response format from API', 'warning');
                    debugLog('warning', 'Unexpected response format', result);
                }

            } catch (error) {
                hideProgress();
                debugLog('error', 'Error during BOM import', error.toString());
                showMessage('Error importing BOMs: ' + error.message, 'danger');
            }
        }

        // Update parts table status
        function updatePartsStatus(status) {
            const tbody = document.getElementById('partsTableBody');
            const rows = tbody.getElementsByTagName('tr');

            for (const row of rows) {
                const statusCell = row.cells[4]; // Updated index (was 3, now 4 due to UOM column)
                if (status === 'imported') {
                    statusCell.innerHTML = '<span class="badge bg-success">Imported</span>';
                }
            }
        }

        // Update BOMs table status
        function updateBOMsStatus(status) {
            const tbody = document.getElementById('bomsTableBody');
            const rows = tbody.getElementsByTagName('tr');

            for (const row of rows) {
                const statusCell = row.cells[4];
                if (status === 'imported') {
                    statusCell.innerHTML = '<span class="badge bg-success">Imported</span>';
                }
            }
        }

        // Show/hide progress indicator
        function showProgress(message, percent) {
            const progressSection = document.getElementById('progressSection');
            const progressText = document.getElementById('progressText');
            const progressBar = document.getElementById('progressBar');

            progressText.textContent = message;
            progressBar.style.width = percent + '%';
            progressSection.classList.remove('hidden');
        }

        function hideProgress() {
            const progressSection = document.getElementById('progressSection');
            progressSection.classList.add('hidden');
        }

        function downloadCSV(csvContent, filename) {
            debugLog('info', `Downloading CSV file: ${filename}`);

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');

            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                debugLog('success', `CSV file downloaded: ${filename}`);
            } else {
                showMessage('Download not supported in this browser', 'danger');
                debugLog('error', 'Download not supported');
            }
        }

        // Utility functions
        function showMessage(message, type = 'info') {
            const messagesSection = document.getElementById('messagesSection');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            messagesSection.appendChild(alert);

            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        function updateStats(stats) {
            document.getElementById('statTotal').textContent = stats.total || 0;
            document.getElementById('statParts').textContent = stats.parts || 0;
            document.getElementById('statNewParts').textContent = stats.newParts || 0;
            document.getElementById('statBOMs').textContent = stats.boms || 0;
            document.getElementById('statWarnings').textContent = stats.warnings || 0;
            document.getElementById('statErrors').textContent = stats.errors || 0;

            document.getElementById('summaryStats').classList.remove('hidden');
        }

        // Populate settings dropdowns with Fishbowl data
        function populateSettingsDropdowns() {
            // Populate UOM dropdown
            const uomSelect = document.getElementById('defaultUOM');
            if (uomSelect && fishbowlData.uoms.length > 0) {
                // Clear existing options except the first (ea)
                while (uomSelect.options.length > 1) {
                    uomSelect.remove(1);
                }

                // Add UOMs from Fishbowl
                fishbowlData.uoms.forEach(uom => {
                    if (uom !== 'ea') { // Don't duplicate ea
                        const option = document.createElement('option');
                        option.value = uom;
                        option.textContent = uom;
                        uomSelect.appendChild(option);
                    }
                });

                debugLog('success', `Populated ${fishbowlData.uoms.length} UOMs in settings`);
            }

            // Populate Tax Code dropdown
            const taxCodeSelect = document.getElementById('defaultTaxCode');
            if (taxCodeSelect && fishbowlData.taxCodes.length > 0) {
                // Clear existing options except the first (NON)
                while (taxCodeSelect.options.length > 1) {
                    taxCodeSelect.remove(1);
                }

                // Add tax codes from Fishbowl
                fishbowlData.taxCodes.forEach(code => {
                    if (code !== 'NON') { // Don't duplicate NON
                        const option = document.createElement('option');
                        option.value = code;
                        option.textContent = code;
                        taxCodeSelect.appendChild(option);
                    }
                });

                debugLog('success', `Populated ${fishbowlData.taxCodes.length} tax codes in settings`);
            }

            // Load saved settings after populating dropdowns
            loadSettings();
        }

        // Save settings to localStorage
        function saveSettings() {
            const settings = {
                defaultUOM: document.getElementById('defaultUOM').value,
                defaultTaxCode: document.getElementById('defaultTaxCode').value,
                defaultWeightUOM: document.getElementById('defaultWeightUOM').value,
                defaultSizeUOM: document.getElementById('defaultSizeUOM').value,
                createAsInventory: document.getElementById('createAsInventory').checked,
                createFinishedGoodsAsProducts: document.getElementById('createFinishedGoodsAsProducts').checked,
                validatePartsExist: document.getElementById('validatePartsExist').checked,
                processStagesSequentially: document.getElementById('processStagesSequentially').checked
            };

            localStorage.setItem('bomConverterSettings', JSON.stringify(settings));

            // Update the in-memory config and defaultValues
            defaultValues.uom = settings.defaultUOM;
            defaultValues.taxCode = settings.defaultTaxCode;
            defaultValues.weightUOM = settings.defaultWeightUOM;
            defaultValues.sizeUOM = settings.defaultSizeUOM;
            config.createAsInventory = settings.createAsInventory;
            config.createFinishedGoodsAsProducts = settings.createFinishedGoodsAsProducts;
            config.validatePartsExist = settings.validatePartsExist;
            config.processStagesSequentially = settings.processStagesSequentially;

            debugLog('info', 'Settings saved', settings);
        }

        // Load settings from localStorage
        function loadSettings() {
            const savedSettings = localStorage.getItem('bomConverterSettings');
            if (savedSettings) {
                try {
                    const settings = JSON.parse(savedSettings);

                    // Apply settings to UI elements
                    if (settings.defaultUOM) document.getElementById('defaultUOM').value = settings.defaultUOM;
                    if (settings.defaultTaxCode) document.getElementById('defaultTaxCode').value = settings.defaultTaxCode;
                    if (settings.defaultWeightUOM) document.getElementById('defaultWeightUOM').value = settings.defaultWeightUOM;
                    if (settings.defaultSizeUOM) document.getElementById('defaultSizeUOM').value = settings.defaultSizeUOM;
                    if (settings.createAsInventory !== undefined) document.getElementById('createAsInventory').checked = settings.createAsInventory;
                    if (settings.createFinishedGoodsAsProducts !== undefined) document.getElementById('createFinishedGoodsAsProducts').checked = settings.createFinishedGoodsAsProducts;
                    if (settings.validatePartsExist !== undefined) document.getElementById('validatePartsExist').checked = settings.validatePartsExist;
                    if (settings.processStagesSequentially !== undefined) document.getElementById('processStagesSequentially').checked = settings.processStagesSequentially;

                    // Update in-memory config and defaultValues
                    defaultValues.uom = settings.defaultUOM || 'ea';
                    defaultValues.taxCode = settings.defaultTaxCode || 'NON';
                    defaultValues.weightUOM = settings.defaultWeightUOM || 'kg'; // Metric default
                    defaultValues.sizeUOM = settings.defaultSizeUOM || 'cm';      // Metric default
                    config.createAsInventory = settings.createAsInventory !== undefined ? settings.createAsInventory : true;
                    config.createFinishedGoodsAsProducts = settings.createFinishedGoodsAsProducts || false;
                    config.validatePartsExist = settings.validatePartsExist !== undefined ? settings.validatePartsExist : true;
                    config.processStagesSequentially = settings.processStagesSequentially !== undefined ? settings.processStagesSequentially : true;

                    debugLog('success', 'Settings loaded from localStorage', settings);
                } catch (error) {
                    debugLog('error', 'Error loading settings', error.toString());
                }
            } else {
                debugLog('info', 'No saved settings found, using defaults');
            }
        }

        // Configuration event listeners
        document.getElementById('defaultUOM').addEventListener('change', function() {
            defaultValues.uom = this.value;
            debugLog('info', `Default UOM changed to: ${this.value}`);
        });

        document.getElementById('defaultTaxCode').addEventListener('change', function() {
            defaultValues.taxCode = this.value;
            debugLog('info', `Default tax code changed to: ${this.value}`);
        });

        document.getElementById('defaultWeightUOM').addEventListener('change', function() {
            defaultValues.weightUOM = this.value;
            debugLog('info', `Default weight UOM changed to: ${this.value}`);
        });

        document.getElementById('defaultSizeUOM').addEventListener('change', function() {
            defaultValues.sizeUOM = this.value;
            debugLog('info', `Default size UOM changed to: ${this.value}`);
        });

        document.getElementById('createAsInventory').addEventListener('change', function() {
            config.createAsInventory = this.checked;
        });

        document.getElementById('createFinishedGoodsAsProducts').addEventListener('change', function() {
            config.createFinishedGoodsAsProducts = this.checked;
        });

        document.getElementById('validatePartsExist').addEventListener('change', function() {
            config.validatePartsExist = this.checked;
        });

        document.getElementById('processStagesSequentially').addEventListener('change', function() {
            config.processStagesSequentially = this.checked;
        });

        // Initialize
        console.log('Solidworks BOM Conversion Tool initialized');
        debugLog('info', 'Solidworks BOM Conversion Tool initialized');
        debugLog('info', 'Ready to process Solidworks BOM CSV files');
        debugLog('info', 'Click "Check BOM Headers" to retrieve Fishbowl BOM import format');

        // Auto-check BOM headers on load (optional - can comment out if not needed)
        // setTimeout(() => checkBOMImportHeaders(), 1000);
    </script>
</body>
</html>
