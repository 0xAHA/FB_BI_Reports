<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Dashboard - Fishbowl Advanced</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- D3.js v7 -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- Moment.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        /* Custom Brand Colors (matching Gantt v3) */
        :root {
            --color-primary: #2d9cdb;
            --color-primary-dark: #1e7bb4;
            --color-sidebar: #06162d;
            --color-sidebar-hover: #0a1f3d;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Override Tailwind indigo with custom blue */
        .bg-indigo-600 { background-color: var(--color-primary) !important; }
        .bg-indigo-50 { background-color: rgba(45, 156, 219, 0.1) !important; }
        .text-indigo-600 { color: var(--color-primary) !important; }
        .text-indigo-700 { color: var(--color-primary-dark) !important; }
        .border-indigo-200 { border-color: rgba(45, 156, 219, 0.3) !important; }
        .border-indigo-300 { border-color: rgba(45, 156, 219, 0.4) !important; }
        .hover\:text-indigo-600:hover { color: var(--color-primary) !important; }
        .hover\:bg-indigo-50:hover { background-color: rgba(45, 156, 219, 0.1) !important; }
        .hover\:bg-indigo-100:hover { background-color: rgba(45, 156, 219, 0.15) !important; }
        .focus\:ring-indigo-100:focus { --tw-ring-color: rgba(45, 156, 219, 0.2) !important; }
        .focus\:ring-indigo-500:focus { --tw-ring-color: var(--color-primary) !important; }
        .focus\:border-indigo-300:focus { border-color: rgba(45, 156, 219, 0.4) !important; }

        /* D3 Chart Styles */
        .axis line, .axis path {
            stroke: #cbd5e1;
            shape-rendering: crispEdges;
        }

        .axis text {
            fill: #64748b;
            font-size: 11px;
            font-weight: 500;
        }

        .grid line {
            stroke: #e2e8f0;
            stroke-opacity: 0.7;
            shape-rendering: crispEdges;
        }

        .line {
            fill: none;
            stroke-width: 2.5px;
        }

        .area {
            opacity: 0.3;
        }

        .tooltip {
            position: absolute;
            background: rgba(15, 23, 42, 0.95);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            max-width: 300px;
        }

        .tooltip-label {
            color: #94a3b8;
            display: inline-block;
            min-width: 90px;
            font-weight: 500;
        }

        .tooltip-value {
            color: #ffffff;
            font-weight: 600;
            margin-left: 8px;
        }

        /* Loading spinner */
        .spinner {
            border: 3px solid #f1f5f9;
            border-top: 3px solid var(--color-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Margin color coding */
        .margin-good { fill: #10b981; }
        .margin-medium { fill: #f59e0b; }
        .margin-low { fill: #ef4444; }
    </style>
</head>
<body class="bg-slate-50">
    <div class="flex flex-col h-screen">
        <!-- Header (matching Gantt v3) -->
        <header class="h-20 bg-white border-b border-slate-200 px-8 flex items-center justify-between flex-shrink-0 z-20 shadow-sm">
            <div class="flex items-center gap-6">
                <div>
                    <h1 class="text-xl font-bold text-slate-900">Sales Dashboard</h1>
                    <p class="text-xs text-slate-500 mt-0.5">Revenue, margins, and sales analytics</p>
                </div>

                <!-- KPI Summary in Header -->
                <div id="kpiCards" class="hidden lg:flex items-center gap-3">
                    <!-- Will be populated dynamically -->
                </div>
            </div>

            <div class="flex items-center gap-3">
                <!-- Export Button -->
                <button onclick="exportToCSV()" class="px-3 py-2 bg-slate-100 hover:bg-slate-200 border border-slate-300 rounded-lg text-sm font-medium transition-colors" title="Export CSV">
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Export
                </button>

                <!-- Refresh Button -->
                <button onclick="loadDashboard()" class="p-2.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-xl transition-all" title="Refresh Data">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                </button>
            </div>
        </header>

        <!-- Content Area -->
        <div class="flex-1 overflow-y-auto custom-scrollbar p-4 lg:p-8">
            <!-- Filters Section -->
            <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                        </svg>
                        <span>Filters</span>
                    </h3>

                    <div class="flex items-center gap-2">
                        <!-- Date Range Buttons -->
                        <div class="flex items-center gap-1 bg-slate-50 px-2 py-1.5 rounded-lg border border-slate-200">
                            <button onclick="setDateRange(30)" class="px-2 py-1 text-xs font-semibold hover:bg-white rounded transition-colors text-slate-600" title="Last 30 Days">30D</button>
                            <button onclick="setDateRange(60)" class="px-2 py-1 text-xs font-semibold hover:bg-white rounded transition-colors text-slate-600" title="Last 60 Days">60D</button>
                            <button onclick="setDateRange(90)" class="px-2 py-1 text-xs font-semibold bg-white rounded text-slate-800" title="Last 90 Days">90D</button>
                            <button onclick="setDateRange(180)" class="px-2 py-1 text-xs font-semibold hover:bg-white rounded transition-colors text-slate-600" title="Last 6 Months">6M</button>
                            <button onclick="setDateRange(365)" class="px-2 py-1 text-xs font-semibold hover:bg-white rounded transition-colors text-slate-600" title="Last Year">1Y</button>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <!-- Customer Group -->
                    <div>
                        <label class="block text-xs font-semibold text-slate-600 mb-2">Customer Group</label>
                        <select id="customerGroupFilter" onchange="loadDashboard()" class="w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-lg text-sm font-medium focus:bg-white focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300 transition-all outline-none text-slate-600">
                            <option value="%">All Groups</option>
                        </select>
                    </div>

                    <!-- Account Manager -->
                    <div>
                        <label class="block text-xs font-semibold text-slate-600 mb-2">Account Manager</label>
                        <select id="accountManagerFilter" onchange="loadDashboard()" class="w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-lg text-sm font-medium focus:bg-white focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300 transition-all outline-none text-slate-600">
                            <option value="%">All Managers</option>
                        </select>
                    </div>

                    <!-- Product Category -->
                    <div>
                        <label class="block text-xs font-semibold text-slate-600 mb-2">Product Category</label>
                        <select id="productCategoryFilter" onchange="loadDashboard()" class="w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-lg text-sm font-medium focus:bg-white focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300 transition-all outline-none text-slate-600">
                            <option value="%">All Categories</option>
                        </select>
                    </div>

                    <!-- Margin Filter -->
                    <div>
                        <label class="block text-xs font-semibold text-slate-600 mb-2">Margin Level</label>
                        <select id="marginFilter" onchange="loadDashboard()" class="w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-lg text-sm font-medium focus:bg-white focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300 transition-all outline-none text-slate-600">
                            <option value="%">All Margins</option>
                            <option value="good">Good (&gt; 30%)</option>
                            <option value="medium">Medium (15-30%)</option>
                            <option value="low">Low (&lt; 15%)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Top Row Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Sales Revenue Over Time -->
                <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                            <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                            </svg>
                            Monthly Sales & Margin
                        </h3>
                        <div class="flex items-center gap-1 bg-slate-50 px-2 py-1.5 rounded-lg border border-slate-200">
                            <button onclick="toggleRevenueChartMode('line')" id="revenueLineBtn" class="px-2 py-1 text-xs font-semibold bg-white rounded transition-colors text-slate-800" title="Line Chart">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                                </svg>
                            </button>
                            <button onclick="toggleRevenueChartMode('bar')" id="revenueBarBtn" class="px-2 py-1 text-xs font-semibold hover:bg-white rounded transition-colors text-slate-600" title="Bar Chart">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div id="revenueChart" style="height: 300px;"></div>
                </div>

                <!-- Top 10 Customers by Revenue -->
                <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                        Top 10 Customers by Revenue
                    </h3>
                    <div id="customersChart" style="height: 300px;"></div>
                </div>
            </div>

            <!-- Middle Row Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <!-- Sales by Product Category -->
                <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                        </svg>
                        Sales by Category
                    </h3>
                    <div id="categoryChart" style="height: 280px;"></div>
                </div>

                <!-- Sales by Account Manager -->
                <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        Sales by Manager
                    </h3>
                    <div id="managerChart" style="height: 280px;"></div>
                </div>

                <!-- Margin Analysis -->
                <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        Margin Trend
                    </h3>
                    <div id="marginChart" style="height: 280px;"></div>
                </div>
            </div>

            <!-- Bottom Row Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Top Salespeople -->
                <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                        </svg>
                        Top Salespeople
                    </h3>
                    <div id="salespeopleChart" style="height: 280px;"></div>
                </div>

                <!-- Sales by Customer Group -->
                <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                        Customer Groups
                    </h3>
                    <div id="groupChart" style="height: 280px;"></div>
                </div>

                <!-- Top 10 Products -->
                <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                        </svg>
                        Top Products
                    </h3>
                    <div id="productsChart" style="height: 280px;"></div>
                </div>
            </div>

            <!-- Loading Overlay -->
            <div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 9999; align-items: center; justify-content: center;">
                <div style="background: white; padding: 2rem; border-radius: 1rem; text-align: center;">
                    <div class="spinner mx-auto mb-4"></div>
                    <p class="text-slate-700 font-medium">Loading sales data...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tooltip -->
    <div id="tooltip" class="tooltip"></div>

    <script>
        // ============================================
        // Global Variables
        // ============================================
        let currentDateRange = 90;
        const tooltip = d3.select('#tooltip');

        // Color palette (matching Gantt v3 theme)
        const colorPalette = [
            '#2d9cdb', '#3b82f6', '#10b981', '#f59e0b', '#ef4444',
            '#8b5cf6', '#ec4899', '#14b8a6', '#f97316', '#06b6d4'
        ];

        // Margin thresholds
        const MARGIN_GOOD = 0.30;
        const MARGIN_MEDIUM = 0.15;

        // Revenue chart view mode
        let revenueChartMode = 'line'; // 'line' or 'bar'

        // ============================================
        // Fishbowl SQL Queries
        // ============================================

        function getSalesRevenueOverTime() {
            const customerGroup = document.getElementById('customerGroupFilter').value;
            const accountManager = document.getElementById('accountManagerFilter').value;
            const productCategory = document.getElementById('productCategoryFilter').value;
            const marginFilter = document.getElementById('marginFilter').value;

            let conditions = `WHERE PostSo.PostDate >= DATE_SUB(NOW(), INTERVAL ${currentDateRange} DAY)
                AND SoItem.TypeId NOT IN (30,40)`;

            if (customerGroup !== '%') {
                conditions += ` AND AccountGroup.Name = '${customerGroup}'`;
            }
            if (accountManager !== '%') {
                conditions += ` AND CONCAT(SysUser.FirstName,' ',SysUser.LastName) = '${accountManager}'`;
            }
            if (productCategory !== '%') {
                conditions += ` AND ProductTree.Name = '${productCategory}'`;
            }

            // Add margin filter in HAVING clause
            let havingClause = '';
            if (marginFilter === 'good') {
                havingClause = 'HAVING avg_margin >= 0.30';
            } else if (marginFilter === 'medium') {
                havingClause = 'HAVING avg_margin >= 0.15 AND avg_margin < 0.30';
            } else if (marginFilter === 'low') {
                havingClause = 'HAVING avg_margin < 0.15';
            }

            const query = `
                SELECT
                    DATE_FORMAT(PostSo.PostDate, '%Y-%m-01') as month,
                    SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) as total_revenue,
                    SUM(PostSoItem.PostedTotalCost) as total_cogs,
                    SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) - SUM(PostSoItem.PostedTotalCost) as total_margin_dollar,
                    COUNT(DISTINCT So.Num) as order_count,
                    AVG((((COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty)-PostSoItem.PostedTotalCost)/(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty))) as avg_margin
                FROM PostSo
                JOIN PostSoItem ON PostSoItem.PostSoId = PostSo.Id
                LEFT JOIN ShipItem ON ShipItem.Id = PostSoItem.ShipItemId
                JOIN SoItem ON SoItem.Id = PostSoItem.SoItemId
                JOIN So ON So.Id = SoItem.SoId
                LEFT JOIN PostSoItem PSI ON PSI.SoItemId = COALESCE((SELECT K.Id FROM SoItem K WHERE K.SoLineItem = SoItem.SoLineItem+1 AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1), (SELECT K.Id FROM SoItem K WHERE K.SoLineItem > SoItem.SoLineItem AND EXISTS (SELECT * FROM SoItem J WHERE J.TypeId = 40 AND J.SoId = K.SoId AND J.SoLineItem >= K.SoLineItem-1 ORDER BY J.SoLineItem ASC) AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1)) AND PSI.PostSoId = PostSo.Id
                LEFT JOIN Product ON Product.Id = SoItem.ProductId
                LEFT JOIN ProductTree ON ProductTree.Id = (SELECT ProductToTree.ProductTreeId FROM ProductToTree WHERE ProductToTree.ProductId = Product.Id ORDER BY ProductToTree.Id ASC LIMIT 1)
                LEFT JOIN Customer ON Customer.Id = So.CustomerId
                LEFT JOIN SysUser ON SysUser.Id = Customer.DefaultSalesManId
                LEFT JOIN AccountGroup ON AccountGroup.Id = (SELECT AccountGroupRelation.GroupId FROM AccountGroupRelation WHERE AccountGroupRelation.AccountId = Customer.AccountId ORDER BY AccountGroupRelation.AccountId ASC LIMIT 1)
                ${conditions}
                GROUP BY DATE_FORMAT(PostSo.PostDate, '%Y-%m-01')
                ${havingClause}
                ORDER BY month ASC
            `;

            console.log('Monthly Revenue Query:', query);
            return JSON.parse(runQuery(query));
        }

        function getTopCustomers() {
            const conditions = buildFilterConditions();
            const query = `
                SELECT
                    Customer.Name as customer_name,
                    SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) as total_revenue,
                    COUNT(DISTINCT So.Num) as order_count,
                    AVG((((COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty)-PostSoItem.PostedTotalCost)/(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty))) as avg_margin
                FROM PostSo
                JOIN PostSoItem ON PostSoItem.PostSoId = PostSo.Id
                JOIN SoItem ON SoItem.Id = PostSoItem.SoItemId
                JOIN So ON So.Id = SoItem.SoId
                LEFT JOIN PostSoItem PSI ON PSI.SoItemId = COALESCE((SELECT K.Id FROM SoItem K WHERE K.SoLineItem = SoItem.SoLineItem+1 AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1), (SELECT K.Id FROM SoItem K WHERE K.SoLineItem > SoItem.SoLineItem AND EXISTS (SELECT * FROM SoItem J WHERE J.TypeId = 40 AND J.SoId = K.SoId AND J.SoLineItem >= K.SoLineItem-1 ORDER BY J.SoLineItem ASC) AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1)) AND PSI.PostSoId = PostSo.Id
                LEFT JOIN Product ON Product.Id = SoItem.ProductId
                LEFT JOIN ProductTree ON ProductTree.Id = (SELECT ProductToTree.ProductTreeId FROM ProductToTree WHERE ProductToTree.ProductId = Product.Id ORDER BY ProductToTree.Id ASC LIMIT 1)
                LEFT JOIN Customer ON Customer.Id = So.CustomerId
                LEFT JOIN SysUser ON SysUser.Id = Customer.DefaultSalesManId
                LEFT JOIN AccountGroup ON AccountGroup.Id = (SELECT AccountGroupRelation.GroupId FROM AccountGroupRelation WHERE AccountGroupRelation.AccountId = Customer.AccountId ORDER BY AccountGroupRelation.AccountId ASC LIMIT 1)
                ${conditions}
                GROUP BY Customer.Name
                ORDER BY total_revenue DESC
                LIMIT 10
            `;

            console.log('Top Customers Query:', query);
            return JSON.parse(runQuery(query));
        }

        function getSalesByCategory() {
            const conditions = buildFilterConditions();
            const query = `
                SELECT
                    COALESCE(ProductTree.Name, 'No Category') as category,
                    SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) as total_revenue
                FROM PostSo
                JOIN PostSoItem ON PostSoItem.PostSoId = PostSo.Id
                JOIN SoItem ON SoItem.Id = PostSoItem.SoItemId
                JOIN So ON So.Id = SoItem.SoId
                LEFT JOIN PostSoItem PSI ON PSI.SoItemId = COALESCE((SELECT K.Id FROM SoItem K WHERE K.SoLineItem = SoItem.SoLineItem+1 AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1), (SELECT K.Id FROM SoItem K WHERE K.SoLineItem > SoItem.SoLineItem AND EXISTS (SELECT * FROM SoItem J WHERE J.TypeId = 40 AND J.SoId = K.SoId AND J.SoLineItem >= K.SoLineItem-1 ORDER BY J.SoLineItem ASC) AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1)) AND PSI.PostSoId = PostSo.Id
                LEFT JOIN Product ON Product.Id = SoItem.ProductId
                LEFT JOIN ProductTree ON ProductTree.Id = (SELECT ProductToTree.ProductTreeId FROM ProductToTree WHERE ProductToTree.ProductId = Product.Id ORDER BY ProductToTree.Id ASC LIMIT 1)
                LEFT JOIN Customer ON Customer.Id = So.CustomerId
                LEFT JOIN SysUser ON SysUser.Id = Customer.DefaultSalesManId
                LEFT JOIN AccountGroup ON AccountGroup.Id = (SELECT AccountGroupRelation.GroupId FROM AccountGroupRelation WHERE AccountGroupRelation.AccountId = Customer.AccountId ORDER BY AccountGroupRelation.AccountId ASC LIMIT 1)
                ${conditions}
                GROUP BY category
                ORDER BY total_revenue DESC
                LIMIT 8
            `;

            console.log('Sales by Category Query:', query);
            return JSON.parse(runQuery(query));
        }

        function getSalesByManager() {
            const conditions = buildFilterConditions();
            const query = `
                SELECT
                    COALESCE(CONCAT(SysUser.FirstName,' ',SysUser.LastName), 'Head Office') as manager_name,
                    SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) as total_revenue,
                    COUNT(DISTINCT So.Num) as order_count
                FROM PostSo
                JOIN PostSoItem ON PostSoItem.PostSoId = PostSo.Id
                JOIN SoItem ON SoItem.Id = PostSoItem.SoItemId
                JOIN So ON So.Id = SoItem.SoId
                LEFT JOIN PostSoItem PSI ON PSI.SoItemId = COALESCE((SELECT K.Id FROM SoItem K WHERE K.SoLineItem = SoItem.SoLineItem+1 AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1), (SELECT K.Id FROM SoItem K WHERE K.SoLineItem > SoItem.SoLineItem AND EXISTS (SELECT * FROM SoItem J WHERE J.TypeId = 40 AND J.SoId = K.SoId AND J.SoLineItem >= K.SoLineItem-1 ORDER BY J.SoLineItem ASC) AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1)) AND PSI.PostSoId = PostSo.Id
                LEFT JOIN Product ON Product.Id = SoItem.ProductId
                LEFT JOIN ProductTree ON ProductTree.Id = (SELECT ProductToTree.ProductTreeId FROM ProductToTree WHERE ProductToTree.ProductId = Product.Id ORDER BY ProductToTree.Id ASC LIMIT 1)
                LEFT JOIN Customer ON Customer.Id = So.CustomerId
                LEFT JOIN SysUser ON SysUser.Id = Customer.DefaultSalesManId
                LEFT JOIN AccountGroup ON AccountGroup.Id = (SELECT AccountGroupRelation.GroupId FROM AccountGroupRelation WHERE AccountGroupRelation.AccountId = Customer.AccountId ORDER BY AccountGroupRelation.AccountId ASC LIMIT 1)
                ${conditions}
                GROUP BY manager_name
                ORDER BY total_revenue DESC
                LIMIT 8
            `;

            console.log('Sales by Manager Query:', query);
            return JSON.parse(runQuery(query));
        }

        function getMarginTrend() {
            const conditions = buildFilterConditions();
            const query = `
                SELECT
                    DATE(PostSo.PostDate) as date,
                    AVG((((COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty)-PostSoItem.PostedTotalCost)/(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty))) as avg_margin
                FROM PostSo
                JOIN PostSoItem ON PostSoItem.PostSoId = PostSo.Id
                JOIN SoItem ON SoItem.Id = PostSoItem.SoItemId
                JOIN So ON So.Id = SoItem.SoId
                LEFT JOIN PostSoItem PSI ON PSI.SoItemId = COALESCE((SELECT K.Id FROM SoItem K WHERE K.SoLineItem = SoItem.SoLineItem+1 AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1), (SELECT K.Id FROM SoItem K WHERE K.SoLineItem > SoItem.SoLineItem AND EXISTS (SELECT * FROM SoItem J WHERE J.TypeId = 40 AND J.SoId = K.SoId AND J.SoLineItem >= K.SoLineItem-1 ORDER BY J.SoLineItem ASC) AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1)) AND PSI.PostSoId = PostSo.Id
                LEFT JOIN Product ON Product.Id = SoItem.ProductId
                LEFT JOIN ProductTree ON ProductTree.Id = (SELECT ProductToTree.ProductTreeId FROM ProductToTree WHERE ProductToTree.ProductId = Product.Id ORDER BY ProductToTree.Id ASC LIMIT 1)
                LEFT JOIN Customer ON Customer.Id = So.CustomerId
                LEFT JOIN SysUser ON SysUser.Id = Customer.DefaultSalesManId
                LEFT JOIN AccountGroup ON AccountGroup.Id = (SELECT AccountGroupRelation.GroupId FROM AccountGroupRelation WHERE AccountGroupRelation.AccountId = Customer.AccountId ORDER BY AccountGroupRelation.AccountId ASC LIMIT 1)
                ${conditions}
                GROUP BY DATE(PostSo.PostDate)
                ORDER BY date ASC
            `;

            console.log('Margin Trend Query:', query);
            return JSON.parse(runQuery(query));
        }

        function getTopSalespeople() {
            const conditions = buildFilterConditions();
            const query = `
                SELECT
                    So.salesman as salesman,
                    SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) as total_revenue,
                    COUNT(DISTINCT So.Num) as order_count
                FROM PostSo
                JOIN PostSoItem ON PostSoItem.PostSoId = PostSo.Id
                JOIN SoItem ON SoItem.Id = PostSoItem.SoItemId
                JOIN So ON So.Id = SoItem.SoId
                LEFT JOIN PostSoItem PSI ON PSI.SoItemId = COALESCE((SELECT K.Id FROM SoItem K WHERE K.SoLineItem = SoItem.SoLineItem+1 AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1), (SELECT K.Id FROM SoItem K WHERE K.SoLineItem > SoItem.SoLineItem AND EXISTS (SELECT * FROM SoItem J WHERE J.TypeId = 40 AND J.SoId = K.SoId AND J.SoLineItem >= K.SoLineItem-1 ORDER BY J.SoLineItem ASC) AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1)) AND PSI.PostSoId = PostSo.Id
                LEFT JOIN Product ON Product.Id = SoItem.ProductId
                LEFT JOIN ProductTree ON ProductTree.Id = (SELECT ProductToTree.ProductTreeId FROM ProductToTree WHERE ProductToTree.ProductId = Product.Id ORDER BY ProductToTree.Id ASC LIMIT 1)
                LEFT JOIN Customer ON Customer.Id = So.CustomerId
                LEFT JOIN SysUser ON SysUser.Id = Customer.DefaultSalesManId
                LEFT JOIN AccountGroup ON AccountGroup.Id = (SELECT AccountGroupRelation.GroupId FROM AccountGroupRelation WHERE AccountGroupRelation.AccountId = Customer.AccountId ORDER BY AccountGroupRelation.AccountId ASC LIMIT 1)
                ${conditions}
                GROUP BY So.salesman
                ORDER BY total_revenue DESC
                LIMIT 10
            `;

            console.log('Top Salespeople Query:', query);
            return JSON.parse(runQuery(query));
        }

        function getSalesByGroup() {
            const conditions = buildFilterConditions();
            const query = `
                SELECT
                    COALESCE(AccountGroup.Name, 'No Group') as group_name,
                    SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) as total_revenue
                FROM PostSo
                JOIN PostSoItem ON PostSoItem.PostSoId = PostSo.Id
                JOIN SoItem ON SoItem.Id = PostSoItem.SoItemId
                JOIN So ON So.Id = SoItem.SoId
                LEFT JOIN PostSoItem PSI ON PSI.SoItemId = COALESCE((SELECT K.Id FROM SoItem K WHERE K.SoLineItem = SoItem.SoLineItem+1 AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1), (SELECT K.Id FROM SoItem K WHERE K.SoLineItem > SoItem.SoLineItem AND EXISTS (SELECT * FROM SoItem J WHERE J.TypeId = 40 AND J.SoId = K.SoId AND J.SoLineItem >= K.SoLineItem-1 ORDER BY J.SoLineItem ASC) AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1)) AND PSI.PostSoId = PostSo.Id
                LEFT JOIN Product ON Product.Id = SoItem.ProductId
                LEFT JOIN ProductTree ON ProductTree.Id = (SELECT ProductToTree.ProductTreeId FROM ProductToTree WHERE ProductToTree.ProductId = Product.Id ORDER BY ProductToTree.Id ASC LIMIT 1)
                LEFT JOIN Customer ON Customer.Id = So.CustomerId
                LEFT JOIN SysUser ON SysUser.Id = Customer.DefaultSalesManId
                LEFT JOIN AccountGroup ON AccountGroup.Id = (SELECT AccountGroupRelation.GroupId FROM AccountGroupRelation WHERE AccountGroupRelation.AccountId = Customer.AccountId ORDER BY AccountGroupRelation.AccountId ASC LIMIT 1)
                ${conditions}
                GROUP BY group_name
                ORDER BY total_revenue DESC
                LIMIT 8
            `;

            console.log('Sales by Group Query:', query);
            return JSON.parse(runQuery(query));
        }

        function getTopProducts() {
            const conditions = buildFilterConditions();
            const query = `
                SELECT
                    Product.Num as product_num,
                    Product.Description as product_desc,
                    SUM(IF(SoItem.TypeId IN (20,21), (PostSoItem.Qty*-1), PostSoItem.Qty)) as total_qty,
                    SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) as total_revenue
                FROM PostSo
                JOIN PostSoItem ON PostSoItem.PostSoId = PostSo.Id
                JOIN SoItem ON SoItem.Id = PostSoItem.SoItemId
                JOIN So ON So.Id = SoItem.SoId
                LEFT JOIN PostSoItem PSI ON PSI.SoItemId = COALESCE((SELECT K.Id FROM SoItem K WHERE K.SoLineItem = SoItem.SoLineItem+1 AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1), (SELECT K.Id FROM SoItem K WHERE K.SoLineItem > SoItem.SoLineItem AND EXISTS (SELECT * FROM SoItem J WHERE J.TypeId = 40 AND J.SoId = K.SoId AND J.SoLineItem >= K.SoLineItem-1 ORDER BY J.SoLineItem ASC) AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1)) AND PSI.PostSoId = PostSo.Id
                LEFT JOIN Product ON Product.Id = SoItem.ProductId
                LEFT JOIN ProductTree ON ProductTree.Id = (SELECT ProductToTree.ProductTreeId FROM ProductToTree WHERE ProductToTree.ProductId = Product.Id ORDER BY ProductToTree.Id ASC LIMIT 1)
                LEFT JOIN Customer ON Customer.Id = So.CustomerId
                LEFT JOIN SysUser ON SysUser.Id = Customer.DefaultSalesManId
                LEFT JOIN AccountGroup ON AccountGroup.Id = (SELECT AccountGroupRelation.GroupId FROM AccountGroupRelation WHERE AccountGroupRelation.AccountId = Customer.AccountId ORDER BY AccountGroupRelation.AccountId ASC LIMIT 1)
                ${conditions}
                GROUP BY Product.Num, Product.Description
                ORDER BY total_qty DESC
                LIMIT 10
            `;

            console.log('Top Products Query:', query);
            return JSON.parse(runQuery(query));
        }

        function getKPIMetrics() {
            const conditions = buildFilterConditions();
            const query = `
                SELECT
                    SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) as total_revenue,
                    COUNT(DISTINCT So.Num) as order_count,
                    AVG((((COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty)-PostSoItem.PostedTotalCost)/(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty))) as avg_margin,
                    SUM(CASE WHEN (((COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty)-PostSoItem.PostedTotalCost)/(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty)) < 0.20 THEN 1 ELSE 0 END) as low_margin_orders
                FROM PostSo
                JOIN PostSoItem ON PostSoItem.PostSoId = PostSo.Id
                JOIN SoItem ON SoItem.Id = PostSoItem.SoItemId
                JOIN So ON So.Id = SoItem.SoId
                LEFT JOIN PostSoItem PSI ON PSI.SoItemId = COALESCE((SELECT K.Id FROM SoItem K WHERE K.SoLineItem = SoItem.SoLineItem+1 AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1), (SELECT K.Id FROM SoItem K WHERE K.SoLineItem > SoItem.SoLineItem AND EXISTS (SELECT * FROM SoItem J WHERE J.TypeId = 40 AND J.SoId = K.SoId AND J.SoLineItem >= K.SoLineItem-1 ORDER BY J.SoLineItem ASC) AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1)) AND PSI.PostSoId = PostSo.Id
                LEFT JOIN Product ON Product.Id = SoItem.ProductId
                LEFT JOIN ProductTree ON ProductTree.Id = (SELECT ProductToTree.ProductTreeId FROM ProductToTree WHERE ProductToTree.ProductId = Product.Id ORDER BY ProductToTree.Id ASC LIMIT 1)
                LEFT JOIN Customer ON Customer.Id = So.CustomerId
                LEFT JOIN SysUser ON SysUser.Id = Customer.DefaultSalesManId
                LEFT JOIN AccountGroup ON AccountGroup.Id = (SELECT AccountGroupRelation.GroupId FROM AccountGroupRelation WHERE AccountGroupRelation.AccountId = Customer.AccountId ORDER BY AccountGroupRelation.AccountId ASC LIMIT 1)
                ${conditions}
            `;

            console.log('KPI Query:', query);
            return JSON.parse(runQuery(query));
        }

        function buildFilterConditions() {
            const customerGroup = document.getElementById('customerGroupFilter').value;
            const accountManager = document.getElementById('accountManagerFilter').value;
            const productCategory = document.getElementById('productCategoryFilter').value;

            let conditions = `WHERE PostSo.PostDate >= DATE_SUB(NOW(), INTERVAL ${currentDateRange} DAY)
                AND SoItem.TypeId NOT IN (30,40)`;

            if (customerGroup !== '%') {
                conditions += ` AND AccountGroup.Name = '${customerGroup}'`;
            }
            if (accountManager !== '%') {
                conditions += ` AND CONCAT(SysUser.FirstName,' ',SysUser.LastName) = '${accountManager}'`;
            }
            if (productCategory !== '%') {
                conditions += ` AND ProductTree.Name = '${productCategory}'`;
            }

            return conditions;
        }

        function loadFilters() {
            // Load Customer Groups
            const cgQuery = `
                SELECT DISTINCT COALESCE(AccountGroup.Name, 'No Group') as name
                FROM So
                JOIN Customer ON Customer.Id = So.CustomerId
                LEFT JOIN AccountGroup ON AccountGroup.Id = (SELECT AccountGroupRelation.GroupId FROM AccountGroupRelation WHERE AccountGroupRelation.AccountId = Customer.AccountId ORDER BY AccountGroupRelation.AccountId ASC LIMIT 1)
                ORDER BY name
            `;
            const customerGroups = JSON.parse(runQuery(cgQuery));
            const cgSelector = document.getElementById('customerGroupFilter');
            cgSelector.innerHTML = '<option value="%">All Groups</option>';
            customerGroups.forEach(cg => {
                if (cg.name) cgSelector.innerHTML += `<option value="${cg.name}">${cg.name}</option>`;
            });

            // Load Account Managers
            const amQuery = `
                SELECT DISTINCT CONCAT(SysUser.FirstName,' ',SysUser.LastName) as name
                FROM Customer
                LEFT JOIN SysUser ON SysUser.Id = Customer.DefaultSalesManId
                WHERE SysUser.FirstName IS NOT NULL
                ORDER BY name
            `;
            const accountManagers = JSON.parse(runQuery(amQuery));
            const amSelector = document.getElementById('accountManagerFilter');
            amSelector.innerHTML = '<option value="%">All Managers</option>';
            accountManagers.forEach(am => {
                if (am.name) amSelector.innerHTML += `<option value="${am.name}">${am.name}</option>`;
            });

            // Load Product Categories
            const pcQuery = `
                SELECT DISTINCT ProductTree.Name as name
                FROM ProductTree
                WHERE ProductTree.Name IS NOT NULL
                ORDER BY name
            `;
            const productCategories = JSON.parse(runQuery(pcQuery));
            const pcSelector = document.getElementById('productCategoryFilter');
            pcSelector.innerHTML = '<option value="%">All Categories</option>';
            productCategories.forEach(pc => {
                if (pc.name) pcSelector.innerHTML += `<option value="${pc.name}">${pc.name}</option>`;
            });
        }

        // ============================================
        // Chart Rendering Functions
        // ============================================

        function renderRevenueChart(data) {
            const container = document.getElementById('revenueChart');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-12 text-sm">No data available</p>';
                return;
            }

            const margin = { top: 20, right: 30, bottom: 40, left: 80 };
            const width = container.offsetWidth - margin.left - margin.right;
            const height = 300 - margin.top - margin.bottom;

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            // Scales
            const x = d3.scaleTime()
                .domain(d3.extent(data, d => new Date(d.date)))
                .range([0, width]);

            const y = d3.scaleLinear()
                .domain([0, d3.max(data, d => parseFloat(d.total_revenue))])
                .nice()
                .range([height, 0]);

            // Grid
            svg.append('g')
                .attr('class', 'grid')
                .attr('opacity', 0.1)
                .call(d3.axisLeft(y).tickSize(-width).tickFormat(''));

            // Area
            const area = d3.area()
                .x(d => x(new Date(d.date)))
                .y0(height)
                .y1(d => y(parseFloat(d.total_revenue)));

            svg.append('path')
                .datum(data)
                .attr('class', 'area')
                .attr('d', area)
                .attr('fill', colorPalette[0]);

            // Line
            const line = d3.line()
                .x(d => x(new Date(d.date)))
                .y(d => y(parseFloat(d.total_revenue)));

            svg.append('path')
                .datum(data)
                .attr('class', 'line')
                .attr('d', line)
                .attr('stroke', colorPalette[0]);

            // Points
            svg.selectAll('.dot')
                .data(data)
                .enter()
                .append('circle')
                .attr('cx', d => x(new Date(d.date)))
                .attr('cy', d => y(parseFloat(d.total_revenue)))
                .attr('r', 4)
                .attr('fill', 'white')
                .attr('stroke', colorPalette[0])
                .attr('stroke-width', 2)
                .on('mouseover', function(event, d) {
                    d3.select(this).attr('r', 6);
                    tooltip.style('opacity', 1)
                        .html(`
                            <div><span class="tooltip-label">Date:</span><span class="tooltip-value">${moment(d.date).format('MMM D, YYYY')}</span></div>
                            <div><span class="tooltip-label">Revenue:</span><span class="tooltip-value">$${parseFloat(d.total_revenue).toLocaleString('en-US', {minimumFractionDigits: 2})}</span></div>
                            <div><span class="tooltip-label">Orders:</span><span class="tooltip-value">${d.order_count}</span></div>
                            <div><span class="tooltip-label">Avg Margin:</span><span class="tooltip-value">${(parseFloat(d.avg_margin) * 100).toFixed(1)}%</span></div>
                        `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    d3.select(this).attr('r', 4);
                    tooltip.style('opacity', 0);
                });

            // Axes
            svg.append('g')
                .attr('class', 'axis')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x).ticks(6).tickFormat(d3.timeFormat('%b %d')));

            svg.append('g')
                .attr('class', 'axis')
                .call(d3.axisLeft(y).ticks(5).tickFormat(d => '$' + d3.format('.2s')(d)));
        }

        function renderCustomersChart(data) {
            const container = document.getElementById('customersChart');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-12 text-sm">No data available</p>';
                return;
            }

            const margin = { top: 20, right: 30, bottom: 40, left: 120 };
            const width = container.offsetWidth - margin.left - margin.right;
            const height = 300 - margin.top - margin.bottom;

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            // Scales
            const x = d3.scaleLinear()
                .domain([0, d3.max(data, d => parseFloat(d.total_revenue))])
                .nice()
                .range([0, width]);

            const y = d3.scaleBand()
                .domain(data.map(d => d.customer_name))
                .range([0, height])
                .padding(0.2);

            // Bars with margin-based coloring
            svg.selectAll('.bar')
                .data(data)
                .enter()
                .append('rect')
                .attr('class', 'bar')
                .attr('x', 0)
                .attr('y', d => y(d.customer_name))
                .attr('width', d => x(parseFloat(d.total_revenue)))
                .attr('height', y.bandwidth())
                .attr('rx', 4)
                .attr('fill', d => {
                    const margin = parseFloat(d.avg_margin);
                    if (margin >= MARGIN_GOOD) return colorPalette[2]; // Green
                    if (margin >= MARGIN_MEDIUM) return colorPalette[3]; // Orange
                    return colorPalette[4]; // Red
                })
                .on('mouseover', function(event, d) {
                    d3.select(this).style('opacity', 0.8);
                    tooltip.style('opacity', 1)
                        .html(`
                            <div><span class="tooltip-label">Customer:</span><span class="tooltip-value">${d.customer_name}</span></div>
                            <div><span class="tooltip-label">Revenue:</span><span class="tooltip-value">$${parseFloat(d.total_revenue).toLocaleString('en-US', {minimumFractionDigits: 2})}</span></div>
                            <div><span class="tooltip-label">Orders:</span><span class="tooltip-value">${d.order_count}</span></div>
                            <div><span class="tooltip-label">Avg Margin:</span><span class="tooltip-value">${(parseFloat(d.avg_margin) * 100).toFixed(1)}%</span></div>
                        `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    d3.select(this).style('opacity', 1);
                    tooltip.style('opacity', 0);
                });

            // Axes
            svg.append('g')
                .attr('class', 'axis')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x).ticks(4).tickFormat(d => '$' + d3.format('.2s')(d)));

            svg.append('g')
                .attr('class', 'axis')
                .call(d3.axisLeft(y))
                .selectAll('text')
                .style('font-size', '10px');
        }

        function renderCategoryChart(data) {
            const container = document.getElementById('categoryChart');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-12 text-sm">No data available</p>';
                return;
            }

            const width = 280;
            const height = 280;
            const radius = Math.min(width, height) / 2;

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height)
                .append('g')
                .attr('transform', `translate(${width / 2},${height / 2})`);

            const color = d3.scaleOrdinal()
                .domain(data.map(d => d.category))
                .range(colorPalette);

            const pie = d3.pie()
                .value(d => parseFloat(d.total_revenue))
                .sort(null);

            const arc = d3.arc()
                .innerRadius(radius * 0.5)
                .outerRadius(radius * 0.8);

            const arcs = svg.selectAll('.arc')
                .data(pie(data))
                .enter()
                .append('g')
                .attr('class', 'arc');

            arcs.append('path')
                .attr('d', arc)
                .attr('fill', d => color(d.data.category))
                .attr('stroke', 'white')
                .attr('stroke-width', 2)
                .on('mouseover', function(event, d) {
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr('d', d3.arc().innerRadius(radius * 0.5).outerRadius(radius * 0.85));

                    const total = d3.sum(data, d => parseFloat(d.total_revenue));
                    const percent = (parseFloat(d.data.total_revenue) / total * 100).toFixed(1);

                    tooltip.style('opacity', 1)
                        .html(`
                            <div><span class="tooltip-label">Category:</span><span class="tooltip-value">${d.data.category}</span></div>
                            <div><span class="tooltip-label">Revenue:</span><span class="tooltip-value">$${parseFloat(d.data.total_revenue).toLocaleString('en-US', {minimumFractionDigits: 2})}</span></div>
                            <div><span class="tooltip-label">Percentage:</span><span class="tooltip-value">${percent}%</span></div>
                        `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr('d', arc);
                    tooltip.style('opacity', 0);
                });
        }

        function updateKPIs(data) {
            if (!data || data.length === 0) return;

            const metrics = data[0];
            const kpiCardsContainer = document.getElementById('kpiCards');

            const totalRevenue = '$' + parseFloat(metrics.total_revenue || 0).toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
            const orderCount = (metrics.order_count || 0).toLocaleString();
            const avgOrderValue = '$' + (parseFloat(metrics.total_revenue || 0) / (metrics.order_count || 1)).toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
            const avgMargin = ((parseFloat(metrics.avg_margin || 0)) * 100).toFixed(1) + '%';
            const lowMarginOrders = (metrics.low_margin_orders || 0).toLocaleString();

            kpiCardsContainer.innerHTML = `
                <div class="flex items-center gap-2 px-3 py-2 bg-blue-50 border border-blue-200 rounded-lg">
                    <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="text-xs font-semibold text-slate-600">Revenue:</span>
                    <span class="text-sm font-bold text-slate-900">${totalRevenue}</span>
                </div>
                <div class="flex items-center gap-2 px-3 py-2 bg-emerald-50 border border-emerald-200 rounded-lg">
                    <svg class="w-4 h-4 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <span class="text-xs font-semibold text-slate-600">Orders:</span>
                    <span class="text-sm font-bold text-slate-900">${orderCount}</span>
                </div>
                <div class="flex items-center gap-2 px-3 py-2 bg-purple-50 border border-purple-200 rounded-lg">
                    <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                    </svg>
                    <span class="text-xs font-semibold text-slate-600">Avg Order:</span>
                    <span class="text-sm font-bold text-slate-900">${avgOrderValue}</span>
                </div>
                <div class="flex items-center gap-2 px-3 py-2 bg-amber-50 border border-amber-200 rounded-lg">
                    <svg class="w-4 h-4 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    <span class="text-xs font-semibold text-slate-600">Margin:</span>
                    <span class="text-sm font-bold text-slate-900">${avgMargin}</span>
                </div>
                ${lowMarginOrders > 0 ? `
                <div class="flex items-center gap-2 px-3 py-2 bg-red-50 border border-red-200 rounded-lg">
                    <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                    <span class="text-xs font-semibold text-slate-600">Low Margin:</span>
                    <span class="text-sm font-bold text-slate-900">${lowMarginOrders}</span>
                </div>
                ` : ''}
            `;
        }

        function renderManagerChart(data) {
            const container = document.getElementById('managerChart');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-12 text-sm">No data available</p>';
                return;
            }

            const margin = { top: 20, right: 30, bottom: 40, left: 90 };
            const width = container.offsetWidth - margin.left - margin.right;
            const height = 280 - margin.top - margin.bottom;

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const x = d3.scaleLinear()
                .domain([0, d3.max(data, d => parseFloat(d.total_revenue))])
                .nice()
                .range([0, width]);

            const y = d3.scaleBand()
                .domain(data.map(d => d.manager_name))
                .range([0, height])
                .padding(0.2);

            svg.selectAll('.bar')
                .data(data)
                .enter()
                .append('rect')
                .attr('x', 0)
                .attr('y', d => y(d.manager_name))
                .attr('width', d => x(parseFloat(d.total_revenue)))
                .attr('height', y.bandwidth())
                .attr('fill', colorPalette[1])
                .attr('rx', 4)
                .on('mouseover', function(event, d) {
                    d3.select(this).attr('fill', colorPalette[0]);
                    tooltip.style('opacity', 1)
                        .html(`
                            <div><span class="tooltip-label">Manager:</span><span class="tooltip-value">${d.manager_name}</span></div>
                            <div><span class="tooltip-label">Revenue:</span><span class="tooltip-value">$${parseFloat(d.total_revenue).toLocaleString('en-US', {minimumFractionDigits: 2})}</span></div>
                            <div><span class="tooltip-label">Orders:</span><span class="tooltip-value">${d.order_count}</span></div>
                        `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    d3.select(this).attr('fill', colorPalette[1]);
                    tooltip.style('opacity', 0);
                });

            svg.append('g')
                .attr('class', 'axis')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x).ticks(4).tickFormat(d => '$' + d3.format('.2s')(d)));

            svg.append('g')
                .attr('class', 'axis')
                .call(d3.axisLeft(y))
                .selectAll('text')
                .style('font-size', '10px');
        }

        function renderMarginChart(data) {
            const container = document.getElementById('marginChart');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-12 text-sm">No data available</p>';
                return;
            }

            const margin = { top: 20, right: 50, bottom: 40, left: 60 };
            const width = container.offsetWidth - margin.left - margin.right;
            const height = 280 - margin.top - margin.bottom;

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const x = d3.scaleTime()
                .domain(d3.extent(data, d => new Date(d.date)))
                .range([0, width]);

            const yMargin = d3.scaleLinear()
                .domain([0, 1])
                .range([height, 0]);

            // Line for margin %
            const line = d3.line()
                .x(d => x(new Date(d.date)))
                .y(d => yMargin(parseFloat(d.avg_margin)));

            svg.append('path')
                .datum(data)
                .attr('class', 'line')
                .attr('d', line)
                .attr('stroke', colorPalette[3])
                .attr('stroke-width', 3);

            // Axes
            svg.append('g')
                .attr('class', 'axis')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x).ticks(5).tickFormat(d3.timeFormat('%b %d')));

            svg.append('g')
                .attr('class', 'axis')
                .call(d3.axisLeft(yMargin).ticks(5).tickFormat(d => (d * 100).toFixed(0) + '%'));

            // Reference lines for margin thresholds
            svg.append('line')
                .attr('x1', 0)
                .attr('x2', width)
                .attr('y1', yMargin(MARGIN_GOOD))
                .attr('y2', yMargin(MARGIN_GOOD))
                .attr('stroke', colorPalette[2])
                .attr('stroke-dasharray', '4,4')
                .attr('opacity', 0.5);

            svg.append('line')
                .attr('x1', 0)
                .attr('x2', width)
                .attr('y1', yMargin(MARGIN_MEDIUM))
                .attr('y2', yMargin(MARGIN_MEDIUM))
                .attr('stroke', colorPalette[3])
                .attr('stroke-dasharray', '4,4')
                .attr('opacity', 0.5);
        }

        function renderSalespeopleChart(data) {
            const container = document.getElementById('salespeopleChart');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-12 text-sm">No data available</p>';
                return;
            }

            const margin = { top: 20, right: 30, bottom: 40, left: 90 };
            const width = container.offsetWidth - margin.left - margin.right;
            const height = 280 - margin.top - margin.bottom;

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const x = d3.scaleLinear()
                .domain([0, d3.max(data, d => parseFloat(d.total_revenue))])
                .nice()
                .range([0, width]);

            const y = d3.scaleBand()
                .domain(data.map(d => d.salesman))
                .range([0, height])
                .padding(0.2);

            svg.selectAll('.bar')
                .data(data)
                .enter()
                .append('rect')
                .attr('x', 0)
                .attr('y', d => y(d.salesman))
                .attr('width', d => x(parseFloat(d.total_revenue)))
                .attr('height', y.bandwidth())
                .attr('fill', colorPalette[5])
                .attr('rx', 4)
                .on('mouseover', function(event, d) {
                    d3.select(this).attr('fill', colorPalette[4]);
                    tooltip.style('opacity', 1)
                        .html(`
                            <div><span class="tooltip-label">Salesperson:</span><span class="tooltip-value">${d.salesman}</span></div>
                            <div><span class="tooltip-label">Revenue:</span><span class="tooltip-value">$${parseFloat(d.total_revenue).toLocaleString('en-US', {minimumFractionDigits: 2})}</span></div>
                            <div><span class="tooltip-label">Orders:</span><span class="tooltip-value">${d.order_count}</span></div>
                        `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    d3.select(this).attr('fill', colorPalette[5]);
                    tooltip.style('opacity', 0);
                });

            svg.append('g')
                .attr('class', 'axis')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x).ticks(4).tickFormat(d => '$' + d3.format('.2s')(d)));

            svg.append('g')
                .attr('class', 'axis')
                .call(d3.axisLeft(y))
                .selectAll('text')
                .style('font-size', '10px');
        }

        function renderGroupChart(data) {
            const container = document.getElementById('groupChart');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-12 text-sm">No data available</p>';
                return;
            }

            const width = 280;
            const height = 280;
            const radius = Math.min(width, height) / 2;

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height)
                .append('g')
                .attr('transform', `translate(${width / 2},${height / 2})`);

            const color = d3.scaleOrdinal()
                .domain(data.map(d => d.group_name))
                .range(colorPalette);

            const pie = d3.pie()
                .value(d => parseFloat(d.total_revenue))
                .sort(null);

            const arc = d3.arc()
                .innerRadius(radius * 0.5)
                .outerRadius(radius * 0.8);

            const arcs = svg.selectAll('.arc')
                .data(pie(data))
                .enter()
                .append('g')
                .attr('class', 'arc');

            arcs.append('path')
                .attr('d', arc)
                .attr('fill', d => color(d.data.group_name))
                .attr('stroke', 'white')
                .attr('stroke-width', 2)
                .on('mouseover', function(event, d) {
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr('d', d3.arc().innerRadius(radius * 0.5).outerRadius(radius * 0.85));

                    const total = d3.sum(data, d => parseFloat(d.total_revenue));
                    const percent = (parseFloat(d.data.total_revenue) / total * 100).toFixed(1);

                    tooltip.style('opacity', 1)
                        .html(`
                            <div><span class="tooltip-label">Group:</span><span class="tooltip-value">${d.data.group_name}</span></div>
                            <div><span class="tooltip-label">Revenue:</span><span class="tooltip-value">$${parseFloat(d.data.total_revenue).toLocaleString('en-US', {minimumFractionDigits: 2})}</span></div>
                            <div><span class="tooltip-label">Percentage:</span><span class="tooltip-value">${percent}%</span></div>
                        `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr('d', arc);
                    tooltip.style('opacity', 0);
                });
        }

        function renderProductsChart(data) {
            const container = document.getElementById('productsChart');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-12 text-sm">No data available</p>';
                return;
            }

            const margin = { top: 20, right: 30, bottom: 40, left: 90 };
            const width = container.offsetWidth - margin.left - margin.right;
            const height = 280 - margin.top - margin.bottom;

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const x = d3.scaleLinear()
                .domain([0, d3.max(data, d => parseFloat(d.total_qty))])
                .nice()
                .range([0, width]);

            const y = d3.scaleBand()
                .domain(data.map(d => d.product_num))
                .range([0, height])
                .padding(0.2);

            svg.selectAll('.bar')
                .data(data)
                .enter()
                .append('rect')
                .attr('x', 0)
                .attr('y', d => y(d.product_num))
                .attr('width', d => x(parseFloat(d.total_qty)))
                .attr('height', y.bandwidth())
                .attr('fill', colorPalette[7])
                .attr('rx', 4)
                .on('mouseover', function(event, d) {
                    d3.select(this).attr('fill', colorPalette[6]);
                    tooltip.style('opacity', 1)
                        .html(`
                            <div><span class="tooltip-label">Product:</span><span class="tooltip-value">${d.product_num}</span></div>
                            <div><span class="tooltip-label">Description:</span><span class="tooltip-value">${d.product_desc}</span></div>
                            <div><span class="tooltip-label">Quantity:</span><span class="tooltip-value">${parseFloat(d.total_qty).toLocaleString()}</span></div>
                            <div><span class="tooltip-label">Revenue:</span><span class="tooltip-value">$${parseFloat(d.total_revenue).toLocaleString('en-US', {minimumFractionDigits: 2})}</span></div>
                        `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    d3.select(this).attr('fill', colorPalette[7]);
                    tooltip.style('opacity', 0);
                });

            svg.append('g')
                .attr('class', 'axis')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x).ticks(4));

            svg.append('g')
                .attr('class', 'axis')
                .call(d3.axisLeft(y))
                .selectAll('text')
                .style('font-size', '10px');
        }

        // ============================================
        // UI Functions
        // ============================================
        function setDateRange(days) {
            currentDateRange = days;

            // Update button states
            document.querySelectorAll('.bg-slate-50 button').forEach(btn => {
                btn.classList.remove('bg-white', 'text-slate-800');
                btn.classList.add('text-slate-600');
            });
            event.target.classList.add('bg-white', 'text-slate-800');
            event.target.classList.remove('text-slate-600');

            loadDashboard();
        }

        // ============================================
        // Data Loading and Refresh
        // ============================================
        function loadDashboard() {
            const loading = document.getElementById('loadingOverlay');
            loading.style.display = 'flex';

            try {
                // Load KPIs
                const kpiData = getKPIMetrics();
                updateKPIs(kpiData);

                // Load charts
                const revenueData = getSalesRevenueOverTime();
                renderRevenueChart(revenueData);

                const customersData = getTopCustomers();
                renderCustomersChart(customersData);

                const categoryData = getSalesByCategory();
                renderCategoryChart(categoryData);

                const managerData = getSalesByManager();
                renderManagerChart(managerData);

                const marginData = getMarginTrend();
                renderMarginChart(marginData);

                const salespeopleData = getTopSalespeople();
                renderSalespeopleChart(salespeopleData);

                const groupData = getSalesByGroup();
                renderGroupChart(groupData);

                const productsData = getTopProducts();
                renderProductsChart(productsData);

            } catch (error) {
                console.error('Error loading dashboard:', error);
                alert('Error loading sales data. Please check console for details.');
            } finally {
                loading.style.display = 'none';
            }
        }

        function exportToCSV() {
            try {
                const kpiData = getKPIMetrics();
                const customersData = getTopCustomers();
                const productsData = getTopProducts();

                // Build CSV header
                let csv = 'Sales Dashboard Export - ' + moment().format('YYYY-MM-DD HH:mm:ss') + '\n\n';

                // KPI Summary
                csv += 'Key Metrics\n';
                csv += 'Metric,Value\n';
                if (kpiData && kpiData.length > 0) {
                    const metrics = kpiData[0];
                    csv += `Total Revenue,$${parseFloat(metrics.total_revenue || 0).toFixed(2)}\n`;
                    csv += `Total Orders,${metrics.order_count || 0}\n`;
                    csv += `Average Order Value,$${(parseFloat(metrics.total_revenue || 0) / (metrics.order_count || 1)).toFixed(2)}\n`;
                    csv += `Average Margin,${(parseFloat(metrics.avg_margin || 0) * 100).toFixed(1)}%\n`;
                    csv += `Low Margin Orders,${metrics.low_margin_orders || 0}\n`;
                }

                csv += '\n\nTop 10 Customers by Revenue\n';
                csv += 'Customer Name,Revenue,Orders,Average Margin\n';
                customersData.forEach(customer => {
                    csv += `"${(customer.customer_name || '').replace(/"/g, '""')}",`;
                    csv += `${parseFloat(customer.total_revenue).toFixed(2)},`;
                    csv += `${customer.order_count},`;
                    csv += `${(parseFloat(customer.avg_margin) * 100).toFixed(1)}%\n`;
                });

                csv += '\n\nTop 10 Products by Quantity\n';
                csv += 'Product Number,Description,Quantity,Revenue\n';
                productsData.forEach(product => {
                    csv += `"${product.product_num}","${(product.product_desc || '').replace(/"/g, '""')}",`;
                    csv += `${parseFloat(product.total_qty).toFixed(2)},`;
                    csv += `${parseFloat(product.total_revenue).toFixed(2)}\n`;
                });

                // Create download link
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);

                link.setAttribute('href', url);
                link.setAttribute('download', 'Sales_Dashboard_' + moment().format('YYYY-MM-DD_HHmmss') + '.csv');
                link.style.visibility = 'hidden';

                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                console.log('CSV export completed successfully');
            } catch (error) {
                console.error('Error exporting CSV:', error);
                alert('Error exporting CSV. Please check console for details.');
            }
        }

        // ============================================
        // Event Listeners
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            loadFilters();
            loadDashboard();

            // Window resize handler
            let resizeTimeout;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(loadDashboard, 250);
            });
        });
    </script>
</body>
</html>
