<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Dashboard - Fishbowl Advanced</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- D3.js v7 -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- Moment.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        /* Custom Brand Colors (matching Gantt v3) */
        :root {
            --color-primary: #2d9cdb;
            --color-primary-dark: #1e7bb4;
            --color-sidebar: #06162d;
            --color-sidebar-hover: #0a1f3d;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Override Tailwind indigo with custom blue */
        .bg-indigo-600 { background-color: var(--color-primary) !important; }
        .bg-indigo-50 { background-color: rgba(45, 156, 219, 0.1) !important; }
        .text-indigo-600 { color: var(--color-primary) !important; }
        .text-indigo-700 { color: var(--color-primary-dark) !important; }
        .border-indigo-200 { border-color: rgba(45, 156, 219, 0.3) !important; }
        .border-indigo-300 { border-color: rgba(45, 156, 219, 0.4) !important; }
        .hover\:text-indigo-600:hover { color: var(--color-primary) !important; }
        .hover\:bg-indigo-50:hover { background-color: rgba(45, 156, 219, 0.1) !important; }
        .hover\:bg-indigo-100:hover { background-color: rgba(45, 156, 219, 0.15) !important; }
        .focus\:ring-indigo-100:focus { --tw-ring-color: rgba(45, 156, 219, 0.2) !important; }
        .focus\:ring-indigo-500:focus { --tw-ring-color: var(--color-primary) !important; }
        .focus\:border-indigo-300:focus { border-color: rgba(45, 156, 219, 0.4) !important; }

        /* D3 Chart Styles */
        .axis line, .axis path {
            stroke: #cbd5e1;
            shape-rendering: crispEdges;
        }

        .axis text {
            fill: #64748b;
            font-size: 11px;
            font-weight: 500;
        }

        .grid line {
            stroke: #e2e8f0;
            stroke-opacity: 0.7;
            shape-rendering: crispEdges;
        }

        .line {
            fill: none;
            stroke-width: 2.5px;
        }

        .area {
            opacity: 0.3;
        }

        .tooltip {
            position: absolute;
            background: rgba(15, 23, 42, 0.95);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            max-width: 300px;
        }

        .tooltip-label {
            color: #94a3b8;
            display: inline-block;
            min-width: 90px;
            font-weight: 500;
        }

        .tooltip-value {
            color: #ffffff;
            font-weight: 600;
            margin-left: 8px;
        }

        /* Loading spinner */
        .spinner {
            border: 3px solid #f1f5f9;
            border-top: 3px solid var(--color-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Margin color coding */
        .margin-good { fill: #10b981; }
        .margin-medium { fill: #f59e0b; }
        .margin-low { fill: #ef4444; }
    </style>
</head>
<body class="bg-slate-50">
    <div class="flex flex-col h-screen">
        <!-- Header (matching Gantt v3) -->
        <header class="h-20 bg-white border-b border-slate-200 px-8 flex items-center justify-between flex-shrink-0 z-20 shadow-sm">
            <div class="flex items-center gap-6">
                <div>
                    <h1 class="text-xl font-bold text-slate-900">Sales Dashboard</h1>
                    <p class="text-xs text-slate-500 mt-0.5">Revenue, margins, and sales analytics</p>
                </div>

                <!-- KPI Summary in Header -->
                <div id="kpiCards" class="hidden lg:flex items-center gap-3">
                    <!-- Will be populated dynamically -->
                </div>
            </div>

            <div class="flex items-center gap-3">
                <!-- Export Button -->
                <button onclick="exportToCSV()" class="px-3 py-2 bg-slate-100 hover:bg-slate-200 border border-slate-300 rounded-lg text-sm font-medium transition-colors" title="Export CSV">
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Export
                </button>

                <!-- Refresh Button -->
                <button onclick="loadDashboard()" class="p-2.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-xl transition-all" title="Refresh Data">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                </button>
            </div>
        </header>

        <!-- Content Area -->
        <div class="flex-1 overflow-y-auto custom-scrollbar p-4 lg:p-8">
            <!-- Filters Section -->
            <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                        </svg>
                        <span>Filters</span>
                    </h3>

                    <div class="flex items-center gap-2 flex-wrap">
                        <!-- Comparison Toggle -->
                        <div id="comparisonToggleContainer" class="flex items-center gap-2 bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-200" style="display: none;">
                            <input type="checkbox" id="comparisonToggle" onchange="toggleComparison()" class="w-3.5 h-3.5 text-indigo-600 border-slate-300 rounded focus:ring-indigo-500">
                            <label for="comparisonToggle" class="text-xs font-semibold text-slate-700 cursor-pointer">Compare to Previous Period</label>
                        </div>

                        <!-- Date Range Dropdown -->
                        <div class="flex items-center gap-1 bg-slate-50 px-2 py-1.5 rounded-lg border border-slate-200">
                            <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            <select id="dateRangeFilter" onchange="applyDateRange()" class="px-2 py-0.5 text-xs border-0 bg-transparent focus:ring-0 focus:outline-none text-slate-700 font-semibold" style="width: 180px;">
                                <option value="90">Last 90 Days</option>
                                <option value="30">Last 30 Days</option>
                                <option value="60">Last 60 Days</option>
                                <option value="180">Last 6 Months</option>
                                <option value="365">Last Year</option>
                                <option value="this_quarter">This Quarter</option>
                                <option value="last_quarter">Last Quarter</option>
                                <option value="current_fy">Current Financial Year</option>
                                <option value="last_fy">Last Financial Year</option>
                                <option value="current_cy">Current Calendar Year</option>
                                <option value="last_cy">Last Calendar Year</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>

                        <!-- Custom Date Range Picker -->
                        <div id="customDateRangeContainer" class="flex items-center gap-1 bg-slate-50 px-2 py-1.5 rounded-lg border border-slate-200" style="display: none;">
                            <input type="date" id="customStartDate" class="px-2 py-0.5 text-xs border-0 bg-transparent focus:ring-0 focus:outline-none text-slate-700" style="width: 110px;" onchange="applyCustomDateRange()" title="Start Date">
                            <span class="text-slate-400 text-xs">to</span>
                            <input type="date" id="customEndDate" class="px-2 py-0.5 text-xs border-0 bg-transparent focus:ring-0 focus:outline-none text-slate-700" style="width: 110px;" onchange="applyCustomDateRange()" title="End Date">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <!-- Customer Group -->
                    <div>
                        <label class="block text-xs font-semibold text-slate-600 mb-2">Customer Group</label>
                        <select id="customerGroupFilter" onchange="loadDashboard()" class="w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-lg text-sm font-medium focus:bg-white focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300 transition-all outline-none text-slate-600">
                            <option value="%">All Groups</option>
                        </select>
                    </div>

                    <!-- Product Category -->
                    <div>
                        <label class="block text-xs font-semibold text-slate-600 mb-2">Product Category</label>
                        <select id="productCategoryFilter" onchange="loadDashboard()" class="w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-lg text-sm font-medium focus:bg-white focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300 transition-all outline-none text-slate-600">
                            <option value="%">All Categories</option>
                        </select>
                    </div>

                    <!-- Sales Person -->
                    <div>
                        <label class="block text-xs font-semibold text-slate-600 mb-2">Sales Person</label>
                        <select id="accountManagerFilter" onchange="loadDashboard()" class="w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-lg text-sm font-medium focus:bg-white focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300 transition-all outline-none text-slate-600">
                            <option value="%">All Sales People</option>
                        </select>
                    </div>

                    <!-- Margin Filter -->
                    <div>
                        <label class="block text-xs font-semibold text-slate-600 mb-2">Margin Level</label>
                        <select id="marginFilter" onchange="loadDashboard()" class="w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-lg text-sm font-medium focus:bg-white focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300 transition-all outline-none text-slate-600">
                            <option value="%">All Margins</option>
                            <option value="good">Good (&gt; 30%)</option>
                            <option value="medium">Medium (15-30%)</option>
                            <option value="low">Low (&lt; 15%)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Monthly Sales & Margin - Full Width -->
            <div class="grid grid-cols-1 gap-6 mb-6">
                <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                            <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                            </svg>
                            Monthly Sales & Margin
                        </h3>
                        <div class="flex items-center gap-1 bg-slate-50 px-2 py-1.5 rounded-lg border border-slate-200">
                            <button onclick="toggleRevenueChartMode('line')" id="revenueLineBtn" class="px-2 py-1 text-xs font-semibold bg-white rounded transition-colors text-slate-800" title="Line Chart">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                                </svg>
                            </button>
                            <button onclick="toggleRevenueChartMode('bar')" id="revenueBarBtn" class="px-2 py-1 text-xs font-semibold hover:bg-white rounded transition-colors text-slate-600" title="Bar Chart">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div id="revenueChart" style="height: 300px;"></div>
                </div>
            </div>

            <!-- Top Row: Customers, Products, and Sales People -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <!-- Top 10 Customers by Revenue -->
                <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                        Top 10 Customers by Revenue
                    </h3>
                    <div id="customersChart" style="height: 300px;"></div>
                </div>

                <!-- Top Products -->
                <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                        </svg>
                        Top Products
                    </h3>
                    <div id="productsChart" style="height: 300px;"></div>
                </div>

                <!-- Top Salespeople -->
                <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                        </svg>
                        Top Sales People
                    </h3>
                    <div id="salespeopleChart" style="height: 280px;"></div>
                </div>
            </div>

            <!-- Product Tree and Customer Groups Row -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Product Tree (formerly Sales by Category) -->
                <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                        </svg>
                        Product Tree
                    </h3>
                    <div id="categoryChart" style="height: 280px;"></div>
                </div>

                <!-- Customer Groups -->
                <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                        Customer Groups
                    </h3>
                    <div id="groupChart" style="height: 280px;"></div>
                </div>
            </div>

            <!-- Critical Alerts Row: Low Margin, Negative Margin, High Value -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
                <!-- Low Margin Sales (< 15%) -->
                <div class="bg-white rounded-2xl shadow-md border border-amber-200 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                        Low Margin Sales (&lt; 15%)
                    </h3>
                    <div id="lowMarginMetric" class="text-center mb-4">
                        <div class="text-4xl font-bold text-amber-600">-</div>
                        <div class="text-sm text-slate-500 mt-1">Orders</div>
                    </div>
                    <div id="lowMarginChart" style="height: 200px;"></div>
                </div>

                <!-- Negative Margin Orders -->
                <div class="bg-white rounded-2xl shadow-md border border-red-200 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Negative Margin Orders
                    </h3>
                    <div id="negativeMarginMetric" class="text-center mb-4">
                        <div class="text-4xl font-bold text-red-600">-</div>
                        <div class="text-sm text-slate-500 mt-1">Orders at Loss</div>
                    </div>
                    <div id="negativeMarginChart" style="height: 200px;"></div>
                </div>

                <!-- High Value Orders -->
                <div class="bg-white rounded-2xl shadow-md border border-green-200 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        High Value Orders (&gt; $10k)
                    </h3>
                    <div id="highValueMetric" class="text-center mb-4">
                        <div class="text-4xl font-bold text-green-600">-</div>
                        <div class="text-sm text-slate-500 mt-1">Large Orders</div>
                    </div>
                    <div id="highValueChart" style="height: 200px;"></div>
                </div>
            </div>

            <!-- Customer Insights Row -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
                <!-- New vs Repeat Customers -->
                <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                        </svg>
                        New vs Repeat Customers
                    </h3>
                    <div id="newRepeatChart" style="height: 280px;"></div>
                </div>

                <!-- Top Customers by Margin % -->
                <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
                        </svg>
                        Top Customers by Margin %
                    </h3>
                    <div id="topMarginCustomersChart" style="height: 280px;"></div>
                </div>

                <!-- Inactive Customers -->
                <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Inactive Customers (90+ Days)
                    </h3>
                    <div id="inactiveCustomersMetric" class="text-center mb-4">
                        <div class="text-4xl font-bold text-slate-700">-</div>
                        <div class="text-sm text-slate-500 mt-1">Inactive</div>
                    </div>
                    <div id="inactiveCustomersChart" style="height: 200px;"></div>
                </div>
            </div>

            <!-- Product Performance Row -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                <!-- Product Mix Analysis (stacked chart) -->
                <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path>
                        </svg>
                        Product Mix Analysis
                    </h3>
                    <div id="productMixChart" style="height: 280px;"></div>
                </div>

                <!-- Slow-Moving Inventory -->
                <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                        </svg>
                        Slow-Moving Inventory
                    </h3>
                    <div id="slowMovingChart" style="height: 280px;"></div>
                </div>
            </div>

            <!-- Sales Team Performance Row -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
                <!-- Sales Orders per Salesperson -->
                <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                        </svg>
                        Orders per Salesperson
                    </h3>
                    <div id="ordersPerSalespersonChart" style="height: 280px;"></div>
                </div>

                <!-- Average Order Value -->
                <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Average Order Value
                    </h3>
                    <div id="aovMetric" class="text-center">
                        <div class="text-5xl font-bold text-indigo-600 mb-2">-</div>
                        <div class="text-sm text-slate-500 mb-4">Current Period</div>
                        <div id="aovComparison" class="hidden text-sm text-slate-600">
                            <span class="font-semibold">Previous:</span> <span id="aovPrevious">-</span>
                        </div>
                    </div>
                </div>

                <!-- Average Days to Ship -->
                <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0"></path>
                        </svg>
                        Avg Days to Ship
                    </h3>
                    <div id="avgDaysMetric" class="text-center">
                        <div class="text-5xl font-bold text-indigo-600 mb-2">-</div>
                        <div class="text-sm text-slate-500 mb-4">Days (Order to Ship)</div>
                        <div id="avgDaysComparison" class="hidden text-sm text-slate-600">
                            <span class="font-semibold">Previous:</span> <span id="avgDaysPrevious">-</span> days
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading Overlay -->
            <div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 9999; align-items: center; justify-content: center;">
                <div style="background: white; padding: 2rem; border-radius: 1rem; text-align: center;">
                    <div class="spinner mx-auto mb-4"></div>
                    <p class="text-slate-700 font-medium">Loading sales data...</p>
                </div>
            </div>

            <!-- Debug Console -->
            <div class="mt-6">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <button onclick="toggleDebugConsole()" class="w-full px-6 py-3 flex items-center justify-between hover:bg-slate-50 transition-colors">
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                            </svg>
                            <span class="text-sm font-semibold text-slate-700">Debug Console</span>
                            <span class="text-xs text-slate-400 font-normal">Auto-scrolls to latest entry</span>
                        </div>
                        <svg id="debugChevron" class="w-5 h-5 text-slate-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>

                    <div id="debugContent" class="hidden border-t border-slate-200">
                        <div class="bg-slate-900 px-4 py-2 flex items-center justify-between">
                            <span class="text-xs text-slate-400 font-mono">Drill-down & Application Diagnostics</span>
                            <button onclick="clearDebugLog()" class="text-xs text-slate-400 hover:text-white transition-colors">
                                Clear
                            </button>
                        </div>
                        <div id="debugLog" class="bg-slate-950 text-slate-200 p-4 font-mono text-xs max-h-96 overflow-y-auto" style="scrollbar-width: thin;">
                            <div class="text-slate-500 italic">Waiting for application to initialize...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tooltip -->
    <div id="tooltip" class="tooltip"></div>

    <!-- Drill-down Modal -->
    <div id="drilldownModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center" onclick="closeDrilldown(event)">
        <div class="bg-white rounded-2xl shadow-2xl w-11/12 max-w-6xl max-h-[90vh] flex flex-col" onclick="event.stopPropagation()">
            <!-- Modal Header -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-slate-200">
                <div>
                    <h2 id="drilldownTitle" class="text-xl font-bold text-slate-800"></h2>
                    <div id="drilldownBreadcrumb" class="text-sm text-slate-500 mt-1"></div>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="exportDrilldownData()" class="px-3 py-2 text-sm font-semibold text-slate-600 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-all flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Export CSV
                    </button>
                    <button onclick="closeDrilldown()" class="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Modal Body -->
            <div class="flex-1 overflow-auto px-6 py-4">
                <!-- Search Box -->
                <div class="mb-4">
                    <input type="text" id="drilldownSearch" placeholder="Search..." class="w-full px-4 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" oninput="filterDrilldownTable()">
                </div>

                <!-- Table -->
                <div class="overflow-x-auto">
                    <table id="drilldownTable" class="w-full text-sm">
                        <thead id="drilldownTableHead" class="bg-slate-50 sticky top-0">
                            <!-- Dynamic headers -->
                        </thead>
                        <tbody id="drilldownTableBody" class="divide-y divide-slate-200">
                            <!-- Dynamic rows -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // Global Variables
        // ============================================
        let currentDateRange = 90;
        let comparisonEnabled = false;
        let customStartDate = null;
        let customEndDate = null;
        const tooltip = d3.select('#tooltip');

        // Color palette (matching Gantt v3 theme)
        const colorPalette = [
            '#2d9cdb', '#3b82f6', '#10b981', '#f59e0b', '#ef4444',
            '#8b5cf6', '#ec4899', '#14b8a6', '#f97316', '#06b6d4'
        ];

        // Margin thresholds
        const MARGIN_GOOD = 0.30;
        const MARGIN_MEDIUM = 0.15;

        // ============================================
        // SQL Helper Functions
        // ============================================
        function escapeSQL(str) {
            if (str === null || str === undefined) return str;
            // Escape single quotes by doubling them
            return str.toString().replace(/'/g, "''");
        }

        // Revenue chart view mode
        let revenueChartMode = 'line'; // 'line' or 'bar'

        // Drill-down data
        let currentDrilldownData = [];
        let currentDrilldownColumns = [];
        let currentSortColumn = null;
        let currentSortDirection = 'asc';

        // ============================================
        // Helper Functions
        // ============================================
        // Date range calculation functions
        function getQuarterDates(offset = 0) {
            const now = moment();
            const currentMonth = now.month();
            const currentYear = now.year();
            const quarterStartMonth = Math.floor(currentMonth / 3) * 3 - (offset * 3);

            const startDate = moment([currentYear, quarterStartMonth, 1]).startOf('month');
            const endDate = moment(startDate).add(2, 'months').endOf('month');

            return {
                start: startDate.format('YYYY-MM-DD'),
                end: endDate.format('YYYY-MM-DD')
            };
        }

        function getFYDates(offset = 0) {
            // Financial Year: July 1 - June 30
            const now = moment();
            const currentMonth = now.month(); // 0-11
            const currentYear = now.year();

            // If we're in Jan-Jun (months 0-5), we're in FY that started last year
            // If we're in Jul-Dec (months 6-11), we're in FY that started this year
            let fyStartYear = currentMonth >= 6 ? currentYear : currentYear - 1;
            fyStartYear -= offset;

            return {
                start: `${fyStartYear}-07-01`,
                end: `${fyStartYear + 1}-06-30`
            };
        }

        function getCalendarYearDates(offset = 0) {
            const year = moment().year() - offset;
            return {
                start: `${year}-01-01`,
                end: `${year}-12-31`
            };
        }

        function getPreviousPeriodDates() {
            if (!customStartDate || !customEndDate) return null;

            const start = moment(customStartDate);
            const end = moment(customEndDate);
            const duration = end.diff(start, 'days');

            const prevEnd = moment(customStartDate).subtract(1, 'day');
            const prevStart = prevEnd.clone().subtract(duration, 'days');

            return {
                start: prevStart.format('YYYY-MM-DD'),
                end: prevEnd.format('YYYY-MM-DD')
            };
        }

        function getDateCondition(usePreviousPeriod = false) {
            if (usePreviousPeriod && comparisonEnabled) {
                const prevDates = getPreviousPeriodDates();
                if (prevDates) {
                    return `PostSo.PostDate >= '${prevDates.start}' AND PostSo.PostDate <= '${prevDates.end}'`;
                }
            }

            if (customStartDate && customEndDate) {
                return `PostSo.PostDate >= '${customStartDate}' AND PostSo.PostDate <= '${customEndDate}'`;
            } else {
                return `PostSo.PostDate >= DATE_SUB(NOW(), INTERVAL ${currentDateRange} DAY)`;
            }
        }

        function debugLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('debugLog');

            // Clear initial message
            if (logDiv.querySelector('.italic')) {
                logDiv.innerHTML = '';
            }

            const colors = {
                'info': 'text-blue-400',
                'success': 'text-green-400',
                'warning': 'text-yellow-400',
                'error': 'text-red-400',
                'click': 'text-purple-400'
            };

            const entry = document.createElement('div');
            entry.className = 'mb-1';
            entry.innerHTML = `<span class="text-slate-500">[${timestamp}]</span> <span class="${colors[type] || colors.info}">${message}</span>`;

            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function toggleDebugConsole() {
            const content = document.getElementById('debugContent');
            const chevron = document.getElementById('debugChevron');

            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                chevron.style.transform = 'rotate(180deg)';
            } else {
                content.classList.add('hidden');
                chevron.style.transform = 'rotate(0deg)';
            }
        }

        function clearDebugLog() {
            const logDiv = document.getElementById('debugLog');
            logDiv.innerHTML = '<div class="text-slate-500 italic">Log cleared</div>';
        }

        // ============================================
        // Fishbowl SQL Queries
        // ============================================

        function getSalesRevenueOverTime() {
            const customerGroup = document.getElementById('customerGroupFilter').value;
            const accountManager = document.getElementById('accountManagerFilter').value;
            const productCategory = document.getElementById('productCategoryFilter').value;
            const marginFilter = document.getElementById('marginFilter').value;

            let conditions = `WHERE ${getDateCondition()}
                AND SoItem.TypeId NOT IN (30,40)`;

            if (customerGroup !== '%') {
                conditions += ` AND AccountGroup.Name = '${escapeSQL(customerGroup)}'`;
            }
            if (accountManager !== '%') {
                conditions += ` AND So.salesman = '${escapeSQL(accountManager)}'`;
            }
            if (productCategory !== '%') {
                conditions += ` AND ProductTree.Name = '${escapeSQL(productCategory)}'`;
            }

            // Add margin filter in HAVING clause
            let havingClause = '';
            if (marginFilter === 'good') {
                havingClause = 'HAVING avg_margin >= 0.30';
            } else if (marginFilter === 'medium') {
                havingClause = 'HAVING avg_margin >= 0.15 AND avg_margin < 0.30';
            } else if (marginFilter === 'low') {
                havingClause = 'HAVING avg_margin < 0.15';
            }

            const query = `
                SELECT
                    DATE_FORMAT(PostSo.PostDate, '%Y-%m-01') as month,
                    SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) as total_revenue,
                    SUM(PostSoItem.PostedTotalCost) as total_cogs,
                    SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) - SUM(PostSoItem.PostedTotalCost) as total_margin_dollar,
                    COUNT(DISTINCT So.Num) as order_count,
                    AVG((((COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty)-PostSoItem.PostedTotalCost)/(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty))) as avg_margin
                FROM PostSo
                JOIN PostSoItem ON PostSoItem.PostSoId = PostSo.Id
                LEFT JOIN ShipItem ON ShipItem.Id = PostSoItem.ShipItemId
                JOIN SoItem ON SoItem.Id = PostSoItem.SoItemId
                JOIN So ON So.Id = SoItem.SoId
                LEFT JOIN PostSoItem PSI ON PSI.SoItemId = COALESCE((SELECT K.Id FROM SoItem K WHERE K.SoLineItem = SoItem.SoLineItem+1 AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1), (SELECT K.Id FROM SoItem K WHERE K.SoLineItem > SoItem.SoLineItem AND EXISTS (SELECT * FROM SoItem J WHERE J.TypeId = 40 AND J.SoId = K.SoId AND J.SoLineItem >= K.SoLineItem-1 ORDER BY J.SoLineItem ASC) AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1)) AND PSI.PostSoId = PostSo.Id
                LEFT JOIN Product ON Product.Id = SoItem.ProductId
                LEFT JOIN ProductTree ON ProductTree.Id = (SELECT ProductToTree.ProductTreeId FROM ProductToTree WHERE ProductToTree.ProductId = Product.Id ORDER BY ProductToTree.Id ASC LIMIT 1)
                LEFT JOIN Customer ON Customer.Id = So.CustomerId
                LEFT JOIN SysUser ON SysUser.Id = Customer.DefaultSalesManId
                LEFT JOIN AccountGroup ON AccountGroup.Id = (SELECT AccountGroupRelation.GroupId FROM AccountGroupRelation WHERE AccountGroupRelation.AccountId = Customer.AccountId ORDER BY AccountGroupRelation.AccountId ASC LIMIT 1)
                ${conditions}
                GROUP BY DATE_FORMAT(PostSo.PostDate, '%Y-%m-01')
                ${havingClause}
                ORDER BY month ASC
            `;

            console.log('Monthly Revenue Query:', query);
            const currentData = JSON.parse(runQuery(query));

            // Fetch previous period data if comparison is enabled
            if (comparisonEnabled && customStartDate && customEndDate) {
                let prevConditions = `WHERE ${getDateCondition(true)}
                    AND SoItem.TypeId NOT IN (30,40)`;

                if (customerGroup !== '%') {
                    prevConditions += ` AND AccountGroup.Name = '${customerGroup}'`;
                }
                if (accountManager !== '%') {
                    prevConditions += ` AND So.salesman = '${accountManager}'`;
                }
                if (productCategory !== '%') {
                    prevConditions += ` AND ProductTree.Name = '${productCategory}'`;
                }

                const prevQuery = query.replace(conditions, prevConditions);
                console.log('Previous Period Revenue Query:', prevQuery);
                const previousData = JSON.parse(runQuery(prevQuery));

                return { current: currentData, previous: previousData };
            }

            return { current: currentData, previous: null };
        }

        function getTopCustomers() {
            const conditions = buildFilterConditions();
            const query = `
                SELECT
                    Customer.Name as customer_name,
                    SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) as total_revenue,
                    COUNT(DISTINCT So.Num) as order_count,
                    AVG((((COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty)-PostSoItem.PostedTotalCost)/(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty))) as avg_margin
                FROM PostSo
                JOIN PostSoItem ON PostSoItem.PostSoId = PostSo.Id
                JOIN SoItem ON SoItem.Id = PostSoItem.SoItemId
                JOIN So ON So.Id = SoItem.SoId
                LEFT JOIN PostSoItem PSI ON PSI.SoItemId = COALESCE((SELECT K.Id FROM SoItem K WHERE K.SoLineItem = SoItem.SoLineItem+1 AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1), (SELECT K.Id FROM SoItem K WHERE K.SoLineItem > SoItem.SoLineItem AND EXISTS (SELECT * FROM SoItem J WHERE J.TypeId = 40 AND J.SoId = K.SoId AND J.SoLineItem >= K.SoLineItem-1 ORDER BY J.SoLineItem ASC) AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1)) AND PSI.PostSoId = PostSo.Id
                LEFT JOIN Product ON Product.Id = SoItem.ProductId
                LEFT JOIN ProductTree ON ProductTree.Id = (SELECT ProductToTree.ProductTreeId FROM ProductToTree WHERE ProductToTree.ProductId = Product.Id ORDER BY ProductToTree.Id ASC LIMIT 1)
                LEFT JOIN Customer ON Customer.Id = So.CustomerId
                LEFT JOIN SysUser ON SysUser.Id = Customer.DefaultSalesManId
                LEFT JOIN AccountGroup ON AccountGroup.Id = (SELECT AccountGroupRelation.GroupId FROM AccountGroupRelation WHERE AccountGroupRelation.AccountId = Customer.AccountId ORDER BY AccountGroupRelation.AccountId ASC LIMIT 1)
                ${conditions}
                GROUP BY Customer.Name
                ORDER BY total_revenue DESC
                LIMIT 10
            `;

            console.log('Top Customers Query:', query);
            return JSON.parse(runQuery(query));
        }

        function getSalesByCategory() {
            const conditions = buildFilterConditions();
            const query = `
                SELECT
                    COALESCE(ProductTree.Name, 'No Category') as category,
                    SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) as total_revenue
                FROM PostSo
                JOIN PostSoItem ON PostSoItem.PostSoId = PostSo.Id
                JOIN SoItem ON SoItem.Id = PostSoItem.SoItemId
                JOIN So ON So.Id = SoItem.SoId
                LEFT JOIN PostSoItem PSI ON PSI.SoItemId = COALESCE((SELECT K.Id FROM SoItem K WHERE K.SoLineItem = SoItem.SoLineItem+1 AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1), (SELECT K.Id FROM SoItem K WHERE K.SoLineItem > SoItem.SoLineItem AND EXISTS (SELECT * FROM SoItem J WHERE J.TypeId = 40 AND J.SoId = K.SoId AND J.SoLineItem >= K.SoLineItem-1 ORDER BY J.SoLineItem ASC) AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1)) AND PSI.PostSoId = PostSo.Id
                LEFT JOIN Product ON Product.Id = SoItem.ProductId
                LEFT JOIN ProductTree ON ProductTree.Id = (SELECT ProductToTree.ProductTreeId FROM ProductToTree WHERE ProductToTree.ProductId = Product.Id ORDER BY ProductToTree.Id ASC LIMIT 1)
                LEFT JOIN Customer ON Customer.Id = So.CustomerId
                LEFT JOIN SysUser ON SysUser.Id = Customer.DefaultSalesManId
                LEFT JOIN AccountGroup ON AccountGroup.Id = (SELECT AccountGroupRelation.GroupId FROM AccountGroupRelation WHERE AccountGroupRelation.AccountId = Customer.AccountId ORDER BY AccountGroupRelation.AccountId ASC LIMIT 1)
                ${conditions}
                GROUP BY category
                ORDER BY total_revenue DESC
                LIMIT 8
            `;

            console.log('Product Tree Query:', query);
            return JSON.parse(runQuery(query));
        }

        function getSalesByManager() {
            const conditions = buildFilterConditions();
            const query = `
                SELECT
                    COALESCE(CONCAT(SysUser.FirstName,' ',SysUser.LastName), 'Head Office') as manager_name,
                    SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) as total_revenue,
                    COUNT(DISTINCT So.Num) as order_count
                FROM PostSo
                JOIN PostSoItem ON PostSoItem.PostSoId = PostSo.Id
                JOIN SoItem ON SoItem.Id = PostSoItem.SoItemId
                JOIN So ON So.Id = SoItem.SoId
                LEFT JOIN PostSoItem PSI ON PSI.SoItemId = COALESCE((SELECT K.Id FROM SoItem K WHERE K.SoLineItem = SoItem.SoLineItem+1 AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1), (SELECT K.Id FROM SoItem K WHERE K.SoLineItem > SoItem.SoLineItem AND EXISTS (SELECT * FROM SoItem J WHERE J.TypeId = 40 AND J.SoId = K.SoId AND J.SoLineItem >= K.SoLineItem-1 ORDER BY J.SoLineItem ASC) AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1)) AND PSI.PostSoId = PostSo.Id
                LEFT JOIN Product ON Product.Id = SoItem.ProductId
                LEFT JOIN ProductTree ON ProductTree.Id = (SELECT ProductToTree.ProductTreeId FROM ProductToTree WHERE ProductToTree.ProductId = Product.Id ORDER BY ProductToTree.Id ASC LIMIT 1)
                LEFT JOIN Customer ON Customer.Id = So.CustomerId
                LEFT JOIN SysUser ON SysUser.Id = Customer.DefaultSalesManId
                LEFT JOIN AccountGroup ON AccountGroup.Id = (SELECT AccountGroupRelation.GroupId FROM AccountGroupRelation WHERE AccountGroupRelation.AccountId = Customer.AccountId ORDER BY AccountGroupRelation.AccountId ASC LIMIT 1)
                ${conditions}
                GROUP BY manager_name
                ORDER BY total_revenue DESC
                LIMIT 8
            `;

            console.log('Sales by Manager Query:', query);
            return JSON.parse(runQuery(query));
        }

        function getMarginTrend() {
            const conditions = buildFilterConditions();
            const query = `
                SELECT
                    DATE(PostSo.PostDate) as date,
                    AVG((((COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty)-PostSoItem.PostedTotalCost)/(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty))) as avg_margin
                FROM PostSo
                JOIN PostSoItem ON PostSoItem.PostSoId = PostSo.Id
                JOIN SoItem ON SoItem.Id = PostSoItem.SoItemId
                JOIN So ON So.Id = SoItem.SoId
                LEFT JOIN PostSoItem PSI ON PSI.SoItemId = COALESCE((SELECT K.Id FROM SoItem K WHERE K.SoLineItem = SoItem.SoLineItem+1 AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1), (SELECT K.Id FROM SoItem K WHERE K.SoLineItem > SoItem.SoLineItem AND EXISTS (SELECT * FROM SoItem J WHERE J.TypeId = 40 AND J.SoId = K.SoId AND J.SoLineItem >= K.SoLineItem-1 ORDER BY J.SoLineItem ASC) AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1)) AND PSI.PostSoId = PostSo.Id
                LEFT JOIN Product ON Product.Id = SoItem.ProductId
                LEFT JOIN ProductTree ON ProductTree.Id = (SELECT ProductToTree.ProductTreeId FROM ProductToTree WHERE ProductToTree.ProductId = Product.Id ORDER BY ProductToTree.Id ASC LIMIT 1)
                LEFT JOIN Customer ON Customer.Id = So.CustomerId
                LEFT JOIN SysUser ON SysUser.Id = Customer.DefaultSalesManId
                LEFT JOIN AccountGroup ON AccountGroup.Id = (SELECT AccountGroupRelation.GroupId FROM AccountGroupRelation WHERE AccountGroupRelation.AccountId = Customer.AccountId ORDER BY AccountGroupRelation.AccountId ASC LIMIT 1)
                ${conditions}
                GROUP BY DATE(PostSo.PostDate)
                ORDER BY date ASC
            `;

            console.log('Margin Trend Query:', query);
            return JSON.parse(runQuery(query));
        }

        function getTopSalespeople() {
            const conditions = buildFilterConditions();
            const query = `
                SELECT
                    COALESCE(CONCAT(SalesUser.FirstName, ' ', SalesUser.LastName), So.salesman) as salesman,
                    SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) as total_revenue,
                    COUNT(DISTINCT So.Num) as order_count,
                    AVG((((COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty)-PostSoItem.PostedTotalCost)/(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty))) as avg_margin
                FROM PostSo
                JOIN PostSoItem ON PostSoItem.PostSoId = PostSo.Id
                JOIN SoItem ON SoItem.Id = PostSoItem.SoItemId
                JOIN So ON So.Id = SoItem.SoId
                LEFT JOIN SysUser AS SalesUser ON SalesUser.userName = So.salesman
                LEFT JOIN PostSoItem PSI ON PSI.SoItemId = COALESCE((SELECT K.Id FROM SoItem K WHERE K.SoLineItem = SoItem.SoLineItem+1 AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1), (SELECT K.Id FROM SoItem K WHERE K.SoLineItem > SoItem.SoLineItem AND EXISTS (SELECT * FROM SoItem J WHERE J.TypeId = 40 AND J.SoId = K.SoId AND J.SoLineItem >= K.SoLineItem-1 ORDER BY J.SoLineItem ASC) AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1)) AND PSI.PostSoId = PostSo.Id
                LEFT JOIN Product ON Product.Id = SoItem.ProductId
                LEFT JOIN ProductTree ON ProductTree.Id = (SELECT ProductToTree.ProductTreeId FROM ProductToTree WHERE ProductToTree.ProductId = Product.Id ORDER BY ProductToTree.Id ASC LIMIT 1)
                LEFT JOIN Customer ON Customer.Id = So.CustomerId
                LEFT JOIN SysUser ON SysUser.Id = Customer.DefaultSalesManId
                LEFT JOIN AccountGroup ON AccountGroup.Id = (SELECT AccountGroupRelation.GroupId FROM AccountGroupRelation WHERE AccountGroupRelation.AccountId = Customer.AccountId ORDER BY AccountGroupRelation.AccountId ASC LIMIT 1)
                ${conditions}
                GROUP BY So.salesman, SalesUser.FirstName, SalesUser.LastName
                ORDER BY total_revenue DESC
                LIMIT 10
            `;

            console.log('Top Salespeople Query:', query);
            return JSON.parse(runQuery(query));
        }

        function getSalesByGroup() {
            const conditions = buildFilterConditions();
            const query = `
                SELECT
                    COALESCE(AccountGroup.Name, 'No Group') as group_name,
                    SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) as total_revenue
                FROM PostSo
                JOIN PostSoItem ON PostSoItem.PostSoId = PostSo.Id
                JOIN SoItem ON SoItem.Id = PostSoItem.SoItemId
                JOIN So ON So.Id = SoItem.SoId
                LEFT JOIN PostSoItem PSI ON PSI.SoItemId = COALESCE((SELECT K.Id FROM SoItem K WHERE K.SoLineItem = SoItem.SoLineItem+1 AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1), (SELECT K.Id FROM SoItem K WHERE K.SoLineItem > SoItem.SoLineItem AND EXISTS (SELECT * FROM SoItem J WHERE J.TypeId = 40 AND J.SoId = K.SoId AND J.SoLineItem >= K.SoLineItem-1 ORDER BY J.SoLineItem ASC) AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1)) AND PSI.PostSoId = PostSo.Id
                LEFT JOIN Product ON Product.Id = SoItem.ProductId
                LEFT JOIN ProductTree ON ProductTree.Id = (SELECT ProductToTree.ProductTreeId FROM ProductToTree WHERE ProductToTree.ProductId = Product.Id ORDER BY ProductToTree.Id ASC LIMIT 1)
                LEFT JOIN Customer ON Customer.Id = So.CustomerId
                LEFT JOIN SysUser ON SysUser.Id = Customer.DefaultSalesManId
                LEFT JOIN AccountGroup ON AccountGroup.Id = (SELECT AccountGroupRelation.GroupId FROM AccountGroupRelation WHERE AccountGroupRelation.AccountId = Customer.AccountId ORDER BY AccountGroupRelation.AccountId ASC LIMIT 1)
                ${conditions}
                GROUP BY group_name
                ORDER BY total_revenue DESC
                LIMIT 8
            `;

            console.log('Sales by Group Query:', query);
            return JSON.parse(runQuery(query));
        }

        function getTopProducts() {
            const conditions = buildFilterConditions();
            const query = `
                SELECT
                    Product.Num as product_num,
                    Product.Description as product_desc,
                    SUM(IF(SoItem.TypeId IN (20,21), (PostSoItem.Qty*-1), PostSoItem.Qty)) as total_qty,
                    SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) as total_revenue
                FROM PostSo
                JOIN PostSoItem ON PostSoItem.PostSoId = PostSo.Id
                JOIN SoItem ON SoItem.Id = PostSoItem.SoItemId
                JOIN So ON So.Id = SoItem.SoId
                LEFT JOIN PostSoItem PSI ON PSI.SoItemId = COALESCE((SELECT K.Id FROM SoItem K WHERE K.SoLineItem = SoItem.SoLineItem+1 AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1), (SELECT K.Id FROM SoItem K WHERE K.SoLineItem > SoItem.SoLineItem AND EXISTS (SELECT * FROM SoItem J WHERE J.TypeId = 40 AND J.SoId = K.SoId AND J.SoLineItem >= K.SoLineItem-1 ORDER BY J.SoLineItem ASC) AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1)) AND PSI.PostSoId = PostSo.Id
                LEFT JOIN Product ON Product.Id = SoItem.ProductId
                LEFT JOIN ProductTree ON ProductTree.Id = (SELECT ProductToTree.ProductTreeId FROM ProductToTree WHERE ProductToTree.ProductId = Product.Id ORDER BY ProductToTree.Id ASC LIMIT 1)
                LEFT JOIN Customer ON Customer.Id = So.CustomerId
                LEFT JOIN SysUser ON SysUser.Id = Customer.DefaultSalesManId
                LEFT JOIN AccountGroup ON AccountGroup.Id = (SELECT AccountGroupRelation.GroupId FROM AccountGroupRelation WHERE AccountGroupRelation.AccountId = Customer.AccountId ORDER BY AccountGroupRelation.AccountId ASC LIMIT 1)
                ${conditions}
                GROUP BY Product.Num, Product.Description
                ORDER BY total_qty DESC
                LIMIT 10
            `;

            console.log('Top Products Query:', query);
            return JSON.parse(runQuery(query));
        }

        function getKPIMetrics() {
            const conditions = buildFilterConditions();
            const query = `
                SELECT
                    SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) as total_revenue,
                    COUNT(DISTINCT So.Num) as order_count,
                    AVG((((COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty)-PostSoItem.PostedTotalCost)/(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty))) as avg_margin,
                    SUM(CASE WHEN (((COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty)-PostSoItem.PostedTotalCost)/(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty)) < 0.20 THEN 1 ELSE 0 END) as low_margin_orders
                FROM PostSo
                JOIN PostSoItem ON PostSoItem.PostSoId = PostSo.Id
                JOIN SoItem ON SoItem.Id = PostSoItem.SoItemId
                JOIN So ON So.Id = SoItem.SoId
                LEFT JOIN PostSoItem PSI ON PSI.SoItemId = COALESCE((SELECT K.Id FROM SoItem K WHERE K.SoLineItem = SoItem.SoLineItem+1 AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1), (SELECT K.Id FROM SoItem K WHERE K.SoLineItem > SoItem.SoLineItem AND EXISTS (SELECT * FROM SoItem J WHERE J.TypeId = 40 AND J.SoId = K.SoId AND J.SoLineItem >= K.SoLineItem-1 ORDER BY J.SoLineItem ASC) AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1)) AND PSI.PostSoId = PostSo.Id
                LEFT JOIN Product ON Product.Id = SoItem.ProductId
                LEFT JOIN ProductTree ON ProductTree.Id = (SELECT ProductToTree.ProductTreeId FROM ProductToTree WHERE ProductToTree.ProductId = Product.Id ORDER BY ProductToTree.Id ASC LIMIT 1)
                LEFT JOIN Customer ON Customer.Id = So.CustomerId
                LEFT JOIN SysUser ON SysUser.Id = Customer.DefaultSalesManId
                LEFT JOIN AccountGroup ON AccountGroup.Id = (SELECT AccountGroupRelation.GroupId FROM AccountGroupRelation WHERE AccountGroupRelation.AccountId = Customer.AccountId ORDER BY AccountGroupRelation.AccountId ASC LIMIT 1)
                ${conditions}
            `;

            console.log('KPI Query:', query);
            return JSON.parse(runQuery(query));
        }

        function buildFilterConditions() {
            const customerGroup = document.getElementById('customerGroupFilter').value;
            const accountManager = document.getElementById('accountManagerFilter').value;
            const productCategory = document.getElementById('productCategoryFilter').value;

            let conditions = `WHERE ${getDateCondition()}
                AND SoItem.TypeId NOT IN (30,40)`;

            if (customerGroup !== '%') {
                conditions += ` AND AccountGroup.Name = '${escapeSQL(customerGroup)}'`;
            }
            if (accountManager !== '%') {
                conditions += ` AND So.salesman = '${escapeSQL(accountManager)}'`;
            }
            if (productCategory !== '%') {
                conditions += ` AND ProductTree.Name = '${escapeSQL(productCategory)}'`;
            }

            return conditions;
        }

        function loadFilters() {
            // Load Customer Groups
            const cgQuery = `
                SELECT DISTINCT COALESCE(AccountGroup.Name, 'No Group') as name
                FROM So
                JOIN Customer ON Customer.Id = So.CustomerId
                LEFT JOIN AccountGroup ON AccountGroup.Id = (SELECT AccountGroupRelation.GroupId FROM AccountGroupRelation WHERE AccountGroupRelation.AccountId = Customer.AccountId ORDER BY AccountGroupRelation.AccountId ASC LIMIT 1)
                ORDER BY name
            `;
            const customerGroups = JSON.parse(runQuery(cgQuery));
            const cgSelector = document.getElementById('customerGroupFilter');
            cgSelector.innerHTML = '<option value="%">All Groups</option>';
            customerGroups.forEach(cg => {
                if (cg.name) cgSelector.innerHTML += `<option value="${cg.name}">${cg.name}</option>`;
            });

            // Load Sales People
            const amQuery = `
                SELECT DISTINCT
                    So.salesman as userName,
                    COALESCE(
                        CONCAT(SysUser.FirstName, ' ', SysUser.LastName),
                        So.salesman
                    ) as fullName
                FROM So
                LEFT JOIN SysUser ON SysUser.userName = So.salesman
                WHERE So.salesman IS NOT NULL AND So.salesman != ''
                ORDER BY fullName
            `;
            debugLog('Loading sales people with query: ' + amQuery, 'info');
            const accountManagers = JSON.parse(runQuery(amQuery));
            debugLog(`Loaded ${accountManagers.length} sales people`, 'info');
            const amSelector = document.getElementById('accountManagerFilter');
            amSelector.innerHTML = '<option value="%">All Sales People</option>';
            accountManagers.forEach(am => {
                if (am.userName) {
                    const displayName = am.fullName || am.userName;
                    amSelector.innerHTML += `<option value="${am.userName}">${displayName}</option>`;
                }
            });

            // Load Product Categories
            const pcQuery = `
                SELECT DISTINCT ProductTree.Name as name
                FROM ProductTree
                WHERE ProductTree.Name IS NOT NULL
                ORDER BY name
            `;
            const productCategories = JSON.parse(runQuery(pcQuery));
            const pcSelector = document.getElementById('productCategoryFilter');
            pcSelector.innerHTML = '<option value="%">All Categories</option>';
            productCategories.forEach(pc => {
                if (pc.name) pcSelector.innerHTML += `<option value="${pc.name}">${pc.name}</option>`;
            });
        }

        // ============================================
        // New Metrics Data Query Functions
        // ============================================

        // Low Margin Sales (< 15%)
        function getLowMarginSales() {
            const conditions = buildFilterConditions();
            const query = `
                SELECT
                    So.Num as order_num,
                    PostSo.PostDate as order_date,
                    Customer.Name as customer_name,
                    So.TotalPrice as order_total,
                    So.salesman,
                    COALESCE(
                        (So.TotalPrice - (
                            SELECT SUM(PostSoItem.PostedTotalCost)
                            FROM SoItem
                            LEFT JOIN PostSoItem ON PostSoItem.SoItemId = SoItem.Id
                            WHERE SoItem.SoId = So.Id
                            AND SoItem.TypeId NOT IN (30,40)
                        )) / NULLIF(So.TotalPrice, 0),
                        0
                    ) as margin_percent
                FROM PostSo
                JOIN So ON So.Id = PostSo.SoId
                JOIN Customer ON Customer.Id = So.CustomerId
                LEFT JOIN AccountGroup ON AccountGroup.Id = (
                    SELECT AccountGroupRelation.GroupId
                    FROM AccountGroupRelation
                    WHERE AccountGroupRelation.AccountId = Customer.AccountId
                    ORDER BY AccountGroupRelation.AccountId ASC
                    LIMIT 1
                )
                ${conditions}
                HAVING margin_percent < 0.15 AND margin_percent >= 0
                ORDER BY margin_percent ASC
                LIMIT 100
            `;
            debugLog('Low Margin Sales query: ' + query, 'info');
            return JSON.parse(runQuery(query));
        }

        // Negative Margin Orders
        function getNegativeMarginOrders() {
            const conditions = buildFilterConditions();
            const query = `
                SELECT
                    So.Num as order_num,
                    PostSo.PostDate as order_date,
                    Customer.Name as customer_name,
                    So.TotalPrice as order_total,
                    So.salesman,
                    COALESCE(
                        (So.TotalPrice - (
                            SELECT SUM(PostSoItem.PostedTotalCost)
                            FROM SoItem
                            LEFT JOIN PostSoItem ON PostSoItem.SoItemId = SoItem.Id
                            WHERE SoItem.SoId = So.Id
                            AND SoItem.TypeId NOT IN (30,40)
                        )) / NULLIF(So.TotalPrice, 0),
                        0
                    ) as margin_percent
                FROM PostSo
                JOIN So ON So.Id = PostSo.SoId
                JOIN Customer ON Customer.Id = So.CustomerId
                LEFT JOIN AccountGroup ON AccountGroup.Id = (
                    SELECT AccountGroupRelation.GroupId
                    FROM AccountGroupRelation
                    WHERE AccountGroupRelation.AccountId = Customer.AccountId
                    ORDER BY AccountGroupRelation.AccountId ASC
                    LIMIT 1
                )
                ${conditions}
                HAVING margin_percent < 0
                ORDER BY margin_percent ASC
                LIMIT 100
            `;
            debugLog('Negative Margin Orders query: ' + query, 'info');
            return JSON.parse(runQuery(query));
        }

        // High Value Orders (> $10k)
        function getHighValueOrders() {
            const conditions = buildFilterConditions();
            const query = `
                SELECT
                    So.Num as order_num,
                    PostSo.PostDate as order_date,
                    Customer.Name as customer_name,
                    So.TotalPrice as order_total,
                    So.salesman,
                    COALESCE(
                        (So.TotalPrice - (
                            SELECT SUM(PostSoItem.PostedTotalCost)
                            FROM SoItem
                            LEFT JOIN PostSoItem ON PostSoItem.SoItemId = SoItem.Id
                            WHERE SoItem.SoId = So.Id
                            AND SoItem.TypeId NOT IN (30,40)
                        )) / NULLIF(So.TotalPrice, 0),
                        0
                    ) as margin_percent
                FROM PostSo
                JOIN So ON So.Id = PostSo.SoId
                JOIN Customer ON Customer.Id = So.CustomerId
                LEFT JOIN AccountGroup ON AccountGroup.Id = (
                    SELECT AccountGroupRelation.GroupId
                    FROM AccountGroupRelation
                    WHERE AccountGroupRelation.AccountId = Customer.AccountId
                    ORDER BY AccountGroupRelation.AccountId ASC
                    LIMIT 1
                )
                ${conditions}
                AND So.TotalPrice > 10000
                ORDER BY So.TotalPrice DESC
                LIMIT 100
            `;
            debugLog('High Value Orders query: ' + query, 'info');
            return JSON.parse(runQuery(query));
        }

        // Average Order Value
        function getAverageOrderValue() {
            const currentConditions = buildFilterConditions();
            const currentQuery = `
                SELECT
                    COALESCE(AVG(So.TotalPrice), 0) as avg_order_value,
                    COUNT(DISTINCT So.Id) as order_count
                FROM PostSo
                JOIN So ON So.Id = PostSo.SoId
                JOIN Customer ON Customer.Id = So.CustomerId
                LEFT JOIN AccountGroup ON AccountGroup.Id = (
                    SELECT AccountGroupRelation.GroupId
                    FROM AccountGroupRelation
                    WHERE AccountGroupRelation.AccountId = Customer.AccountId
                    ORDER BY AccountGroupRelation.AccountId ASC
                    LIMIT 1
                )
                ${currentConditions}
            `;

            const currentData = JSON.parse(runQuery(currentQuery));

            // Get previous period if comparison is enabled
            if (document.getElementById('comparisonToggle').checked) {
                const prevConditions = buildFilterConditions(true);
                const prevQuery = `
                    SELECT
                        COALESCE(AVG(So.TotalPrice), 0) as avg_order_value
                    FROM PostSo
                    JOIN So ON So.Id = PostSo.SoId
                    JOIN Customer ON Customer.Id = So.CustomerId
                    LEFT JOIN AccountGroup ON AccountGroup.Id = (
                        SELECT AccountGroupRelation.GroupId
                        FROM AccountGroupRelation
                        WHERE AccountGroupRelation.AccountId = Customer.AccountId
                        ORDER BY AccountGroupRelation.AccountId ASC
                        LIMIT 1
                    )
                    ${prevConditions}
                `;
                const prevData = JSON.parse(runQuery(prevQuery));
                return {
                    current: currentData[0],
                    previous: prevData[0]
                };
            }

            return currentData[0];
        }

        // New vs Repeat Customers
        function getNewVsRepeatCustomers() {
            const conditions = buildFilterConditions();
            const { start, end } = getDateRange();

            const query = `
                SELECT
                    Customer.Id as customer_id,
                    Customer.Name as customer_name,
                    MIN(PostSo.PostDate) as first_order_date,
                    COUNT(DISTINCT So.Id) as order_count,
                    SUM(So.TotalPrice) as total_revenue
                FROM PostSo
                JOIN So ON So.Id = PostSo.SoId
                JOIN Customer ON Customer.Id = So.CustomerId
                LEFT JOIN AccountGroup ON AccountGroup.Id = (
                    SELECT AccountGroupRelation.GroupId
                    FROM AccountGroupRelation
                    WHERE AccountGroupRelation.AccountId = Customer.AccountId
                    ORDER BY AccountGroupRelation.AccountId ASC
                    LIMIT 1
                )
                ${conditions}
                GROUP BY Customer.Id, Customer.Name
            `;

            const customers = JSON.parse(runQuery(query));

            let newCustomers = 0;
            let repeatCustomers = 0;
            let newRevenue = 0;
            let repeatRevenue = 0;

            customers.forEach(c => {
                const firstOrderDate = moment(c.first_order_date);
                const periodStart = moment(start);

                if (firstOrderDate >= periodStart) {
                    newCustomers++;
                    newRevenue += parseFloat(c.total_revenue || 0);
                } else {
                    repeatCustomers++;
                    repeatRevenue += parseFloat(c.total_revenue || 0);
                }
            });

            return [
                { type: 'New', count: newCustomers, revenue: newRevenue },
                { type: 'Repeat', count: repeatCustomers, revenue: repeatRevenue }
            ];
        }

        // Top Customers by Margin %
        function getTopCustomersByMargin() {
            const conditions = buildFilterConditions();
            const query = `
                SELECT
                    Customer.Name as customer_name,
                    Customer.Id as customer_id,
                    SUM(So.TotalPrice) as total_revenue,
                    AVG(
                        COALESCE(
                            (So.TotalPrice - (
                                SELECT SUM(PostSoItem.PostedTotalCost)
                                FROM SoItem
                                LEFT JOIN PostSoItem ON PostSoItem.SoItemId = SoItem.Id
                                WHERE SoItem.SoId = So.Id
                                AND SoItem.TypeId NOT IN (30,40)
                            )) / NULLIF(So.TotalPrice, 0),
                            0
                        )
                    ) as avg_margin_percent,
                    COUNT(DISTINCT So.Id) as order_count
                FROM PostSo
                JOIN So ON So.Id = PostSo.SoId
                JOIN Customer ON Customer.Id = So.CustomerId
                LEFT JOIN AccountGroup ON AccountGroup.Id = (
                    SELECT AccountGroupRelation.GroupId
                    FROM AccountGroupRelation
                    WHERE AccountGroupRelation.AccountId = Customer.AccountId
                    ORDER BY AccountGroupRelation.AccountId ASC
                    LIMIT 1
                )
                ${conditions}
                GROUP BY Customer.Id, Customer.Name
                HAVING SUM(So.TotalPrice) > 1000
                ORDER BY avg_margin_percent DESC
                LIMIT 10
            `;
            debugLog('Top Customers by Margin query: ' + query, 'info');
            return JSON.parse(runQuery(query));
        }

        // Inactive Customers (90+ days since last order)
        function getInactiveCustomers() {
            const inactiveDays = 90;
            const cutoffDate = moment().subtract(inactiveDays, 'days').format('YYYY-MM-DD');

            const query = `
                SELECT
                    Customer.Id as customer_id,
                    Customer.Name as customer_name,
                    MAX(PostSo.PostDate) as last_order_date,
                    COUNT(DISTINCT So.Id) as total_orders,
                    SUM(So.TotalPrice) as lifetime_revenue,
                    DATEDIFF(CURDATE(), MAX(PostSo.PostDate)) as days_since_order
                FROM PostSo
                JOIN So ON So.Id = PostSo.SoId
                JOIN Customer ON Customer.Id = So.CustomerId
                GROUP BY Customer.Id, Customer.Name
                HAVING last_order_date < '${cutoffDate}' AND total_orders > 0
                ORDER BY lifetime_revenue DESC
                LIMIT 100
            `;
            debugLog('Inactive Customers query: ' + query, 'info');
            return JSON.parse(runQuery(query));
        }

        // Slow-Moving Inventory
        function getSlowMovingInventory() {
            const conditions = buildFilterConditions();
            const { start, end } = getDateRange();
            const daysDiff = moment(end).diff(moment(start), 'days') || 1;

            const query = `
                SELECT
                    Product.Num as product_num,
                    Product.Description as product_name,
                    COALESCE(SUM(PostSoItem.Qty), 0) as qty_sold,
                    COALESCE(SUM(PostSoItem.Qty), 0) / ${daysDiff} as daily_velocity,
                    (
                        SELECT SUM(PartTracking.Qty)
                        FROM PartTracking
                        WHERE PartTracking.PartId = Product.Id
                    ) as qty_on_hand,
                    (
                        SELECT SUM(PartTracking.Qty)
                        FROM PartTracking
                        WHERE PartTracking.PartId = Product.Id
                    ) / NULLIF(COALESCE(SUM(PostSoItem.Qty), 0) / ${daysDiff}, 0) as days_of_supply
                FROM Product
                LEFT JOIN PostSoItem ON PostSoItem.ProductId = Product.Id
                LEFT JOIN SoItem ON SoItem.Id = PostSoItem.SoItemId
                LEFT JOIN So ON So.Id = SoItem.SoId
                LEFT JOIN PostSo ON PostSo.SoId = So.Id
                LEFT JOIN Customer ON Customer.Id = So.CustomerId
                LEFT JOIN AccountGroup ON AccountGroup.Id = (
                    SELECT AccountGroupRelation.GroupId
                    FROM AccountGroupRelation
                    WHERE AccountGroupRelation.AccountId = Customer.AccountId
                    ORDER BY AccountGroupRelation.AccountId ASC
                    LIMIT 1
                )
                ${conditions.replace('WHERE', 'WHERE (PostSo.PostDate IS NULL OR (')}${conditions.includes('WHERE') ? '))' : ''}
                GROUP BY Product.Id, Product.Num, Product.Description
                HAVING qty_on_hand > 0 AND daily_velocity < 1
                ORDER BY days_of_supply DESC
                LIMIT 20
            `;
            debugLog('Slow-Moving Inventory query: ' + query, 'info');
            return JSON.parse(runQuery(query));
        }

        // Product Mix Analysis (Revenue by Category over Time)
        function getProductMixAnalysis() {
            const conditions = buildFilterConditions();
            const query = `
                SELECT
                    DATE_FORMAT(PostSo.PostDate, '%Y-%m') as month,
                    COALESCE(ProductTree.Name, 'No Category') as category,
                    SUM(PostSoItem.Qty * PostSoItem.ProductPrice) as revenue
                FROM PostSo
                JOIN So ON So.Id = PostSo.SoId
                JOIN SoItem ON SoItem.SoId = So.Id
                JOIN PostSoItem ON PostSoItem.SoItemId = SoItem.Id
                JOIN Product ON Product.Id = PostSoItem.ProductId
                LEFT JOIN ProductTree ON ProductTree.Id = Product.ProductTreeId
                JOIN Customer ON Customer.Id = So.CustomerId
                LEFT JOIN AccountGroup ON AccountGroup.Id = (
                    SELECT AccountGroupRelation.GroupId
                    FROM AccountGroupRelation
                    WHERE AccountGroupRelation.AccountId = Customer.AccountId
                    ORDER BY AccountGroupRelation.AccountId ASC
                    LIMIT 1
                )
                ${conditions}
                AND SoItem.TypeId NOT IN (30,40)
                GROUP BY month, category
                ORDER BY month ASC, revenue DESC
            `;
            debugLog('Product Mix Analysis query: ' + query, 'info');
            return JSON.parse(runQuery(query));
        }

        // Sales Orders per Salesperson
        function getOrdersPerSalesperson() {
            const conditions = buildFilterConditions();
            const query = `
                SELECT
                    So.salesman as userName,
                    COALESCE(
                        CONCAT(SysUser.FirstName, ' ', SysUser.LastName),
                        So.salesman
                    ) as fullName,
                    COUNT(DISTINCT So.Id) as order_count,
                    SUM(So.TotalPrice) as total_revenue
                FROM PostSo
                JOIN So ON So.Id = PostSo.SoId
                JOIN Customer ON Customer.Id = So.CustomerId
                LEFT JOIN SysUser ON SysUser.userName = So.salesman
                LEFT JOIN AccountGroup ON AccountGroup.Id = (
                    SELECT AccountGroupRelation.GroupId
                    FROM AccountGroupRelation
                    WHERE AccountGroupRelation.AccountId = Customer.AccountId
                    ORDER BY AccountGroupRelation.AccountId ASC
                    LIMIT 1
                )
                ${conditions}
                AND So.salesman IS NOT NULL AND So.salesman != ''
                GROUP BY So.salesman, SysUser.FirstName, SysUser.LastName
                ORDER BY order_count DESC
                LIMIT 10
            `;
            debugLog('Orders per Salesperson query: ' + query, 'info');
            return JSON.parse(runQuery(query));
        }

        // Average Days to Ship
        function getAvgDaysToShip() {
            const currentConditions = buildFilterConditions();
            const currentQuery = `
                SELECT
                    AVG(DATEDIFF(Ship.ShipDate, So.DateCreated)) as avg_days
                FROM PostSo
                JOIN So ON So.Id = PostSo.SoId
                JOIN Ship ON Ship.SoId = So.Id
                JOIN Customer ON Customer.Id = So.CustomerId
                LEFT JOIN AccountGroup ON AccountGroup.Id = (
                    SELECT AccountGroupRelation.GroupId
                    FROM AccountGroupRelation
                    WHERE AccountGroupRelation.AccountId = Customer.AccountId
                    ORDER BY AccountGroupRelation.AccountId ASC
                    LIMIT 1
                )
                ${currentConditions}
                AND Ship.ShipDate IS NOT NULL
            `;

            const currentData = JSON.parse(runQuery(currentQuery));

            // Get previous period if comparison is enabled
            if (document.getElementById('comparisonToggle').checked) {
                const prevConditions = buildFilterConditions(true);
                const prevQuery = `
                    SELECT
                        AVG(DATEDIFF(Ship.ShipDate, So.DateCreated)) as avg_days
                    FROM PostSo
                    JOIN So ON So.Id = PostSo.SoId
                    JOIN Ship ON Ship.SoId = So.Id
                    JOIN Customer ON Customer.Id = So.CustomerId
                    LEFT JOIN AccountGroup ON AccountGroup.Id = (
                        SELECT AccountGroupRelation.GroupId
                        FROM AccountGroupRelation
                        WHERE AccountGroupRelation.AccountId = Customer.AccountId
                        ORDER BY AccountGroupRelation.AccountId ASC
                        LIMIT 1
                    )
                    ${prevConditions}
                    AND Ship.ShipDate IS NOT NULL
                `;
                const prevData = JSON.parse(runQuery(prevQuery));
                return {
                    current: currentData[0],
                    previous: prevData[0]
                };
            }

            return currentData[0];
        }

        // ============================================
        // Chart Rendering Functions
        // ============================================

        function renderRevenueChart(data) {
            const container = document.getElementById('revenueChart');
            container.innerHTML = '';

            // Handle new data structure with current and previous periods
            let currentData = data;
            let previousData = null;

            if (data && data.current) {
                currentData = data.current;
                previousData = data.previous;
            }

            if (!currentData || currentData.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-12 text-sm">No data available</p>';
                return;
            }

            // Map previous period data to current period months for proper alignment
            if (previousData && previousData.length > 0) {
                previousData = previousData.map((d, i) => ({
                    ...d,
                    originalMonth: d.month,  // Keep original for tooltip
                    month: currentData[i] ? currentData[i].month : d.month  // Map to current period month
                }));
            }

            const margin = { top: 20, right: 80, bottom: 40, left: 80 };
            const width = container.offsetWidth - margin.left - margin.right;
            const height = 300 - margin.top - margin.bottom;

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            // Scales - calculate max across both current and previous data
            const allData = previousData ? [...currentData, ...previousData] : currentData;

            const x = d3.scaleBand()
                .domain(currentData.map(d => d.month))
                .range([0, width])
                .padding(0.3);

            const yRevenue = d3.scaleLinear()
                .domain([0, d3.max(allData, d => parseFloat(d.total_revenue))])
                .nice()
                .range([height, 0]);

            const yMargin = d3.scaleLinear()
                .domain([0, d3.max(allData, d => parseFloat(d.avg_margin) * 100)])
                .nice()
                .range([height, 0]);

            // Grid
            svg.append('g')
                .attr('class', 'grid')
                .attr('opacity', 0.1)
                .call(d3.axisLeft(yRevenue).tickSize(-width).tickFormat(''));

            if (revenueChartMode === 'bar') {
                // Bar chart mode
                const hasPrevious = previousData && previousData.length > 0;
                const numBarsPerGroup = hasPrevious ? 4 : 2; // 4 bars if comparison, 2 otherwise
                const barWidth = x.bandwidth() / numBarsPerGroup;
                const barGap = 2; // Small gap between bars

                // Previous period bars (if available) - lighter shades
                if (hasPrevious) {
                    // Previous Revenue bars
                    svg.selectAll('.bar-prev-revenue')
                        .data(previousData)
                        .enter()
                        .append('rect')
                        .attr('class', 'bar-prev-revenue')
                        .attr('x', d => x(d.month))
                        .attr('y', d => yRevenue(parseFloat(d.total_revenue)))
                        .attr('width', barWidth - barGap)
                        .attr('height', d => height - yRevenue(parseFloat(d.total_revenue)))
                        .attr('fill', colorPalette[0])
                        .attr('opacity', 0.5)
                        .style('cursor', 'pointer')
                        .on('mouseover', function(event, d) {
                            d3.select(this).attr('opacity', 0.7);
                            showMonthlyTooltip(event, d, false, true);
                        })
                        .on('mouseout', function() {
                            d3.select(this).attr('opacity', 0.5);
                            tooltip.style('opacity', 0);
                        });

                    // Current period Revenue bars
                    svg.selectAll('.bar-revenue')
                        .data(currentData)
                        .enter()
                        .append('rect')
                        .attr('class', 'bar-revenue')
                        .attr('x', d => x(d.month) + barWidth)
                        .attr('y', d => yRevenue(parseFloat(d.total_revenue)))
                        .attr('width', barWidth - barGap)
                        .attr('height', d => height - yRevenue(parseFloat(d.total_revenue)))
                        .attr('fill', colorPalette[0])
                        .attr('opacity', 0.8)
                        .style('cursor', 'pointer')
                        .on('mouseover', function(event, d) {
                            d3.select(this).attr('opacity', 1);
                            showMonthlyTooltip(event, d, true);
                        })
                        .on('mouseout', function() {
                            d3.select(this).attr('opacity', 0.8);
                            tooltip.style('opacity', 0);
                        })
                        .on('click', function(event, d) {
                            drilldownMonth(d.month);
                        });

                    // Previous Margin bars
                    svg.selectAll('.bar-prev-margin')
                        .data(previousData)
                        .enter()
                        .append('rect')
                        .attr('class', 'bar-prev-margin')
                        .attr('x', d => x(d.month) + (barWidth * 2))
                        .attr('y', d => yMargin(parseFloat(d.avg_margin) * 100))
                        .attr('width', barWidth - barGap)
                        .attr('height', d => height - yMargin(parseFloat(d.avg_margin) * 100))
                        .attr('fill', colorPalette[3])
                        .attr('opacity', 0.5)
                        .style('cursor', 'pointer')
                        .on('mouseover', function(event, d) {
                            d3.select(this).attr('opacity', 0.7);
                            showMonthlyTooltip(event, d, false, true);
                        })
                        .on('mouseout', function() {
                            d3.select(this).attr('opacity', 0.5);
                            tooltip.style('opacity', 0);
                        });

                    // Current period Margin bars
                    svg.selectAll('.bar-margin')
                        .data(currentData)
                        .enter()
                        .append('rect')
                        .attr('class', 'bar-margin')
                        .attr('x', d => x(d.month) + (barWidth * 3))
                        .attr('y', d => yMargin(parseFloat(d.avg_margin) * 100))
                        .attr('width', barWidth - barGap)
                        .attr('height', d => height - yMargin(parseFloat(d.avg_margin) * 100))
                        .attr('fill', colorPalette[3])
                        .attr('opacity', 0.8)
                        .style('cursor', 'pointer')
                        .on('mouseover', function(event, d) {
                            d3.select(this).attr('opacity', 1);
                            showMonthlyTooltip(event, d, true);
                        })
                        .on('mouseout', function() {
                            d3.select(this).attr('opacity', 0.8);
                            tooltip.style('opacity', 0);
                        })
                        .on('click', function(event, d) {
                            drilldownMonth(d.month);
                        });
                } else {
                    // No comparison - use original 2-bar layout
                    // Current period Revenue bars
                    svg.selectAll('.bar-revenue')
                        .data(currentData)
                        .enter()
                        .append('rect')
                        .attr('class', 'bar-revenue')
                        .attr('x', d => x(d.month))
                        .attr('y', d => yRevenue(parseFloat(d.total_revenue)))
                        .attr('width', barWidth - barGap)
                        .attr('height', d => height - yRevenue(parseFloat(d.total_revenue)))
                        .attr('fill', colorPalette[0])
                        .attr('opacity', 0.8)
                        .style('cursor', 'pointer')
                        .on('mouseover', function(event, d) {
                            d3.select(this).attr('opacity', 1);
                            showMonthlyTooltip(event, d, true);
                        })
                        .on('mouseout', function() {
                            d3.select(this).attr('opacity', 0.8);
                            tooltip.style('opacity', 0);
                        })
                        .on('click', function(event, d) {
                            drilldownMonth(d.month);
                        });

                    // Current period Margin bars
                    svg.selectAll('.bar-margin')
                        .data(currentData)
                        .enter()
                        .append('rect')
                        .attr('class', 'bar-margin')
                        .attr('x', d => x(d.month) + barWidth)
                        .attr('y', d => yMargin(parseFloat(d.avg_margin) * 100))
                        .attr('width', barWidth - barGap)
                        .attr('height', d => height - yMargin(parseFloat(d.avg_margin) * 100))
                        .attr('fill', colorPalette[3])
                        .attr('opacity', 0.8)
                        .style('cursor', 'pointer')
                        .on('mouseover', function(event, d) {
                            d3.select(this).attr('opacity', 1);
                            showMonthlyTooltip(event, d, true);
                        })
                        .on('mouseout', function() {
                            d3.select(this).attr('opacity', 0.8);
                            tooltip.style('opacity', 0);
                        })
                        .on('click', function(event, d) {
                            drilldownMonth(d.month);
                        });
                }

            } else {
                // Line chart mode

                // Previous period lines (if available) - lighter shades
                if (previousData && previousData.length > 0) {
                    // Previous Revenue line
                    const prevRevenueLine = d3.line()
                        .x(d => x(d.month) + x.bandwidth() / 2)
                        .y(d => yRevenue(parseFloat(d.total_revenue)));

                    svg.append('path')
                        .datum(previousData)
                        .attr('class', 'line-prev')
                        .attr('d', prevRevenueLine)
                        .attr('stroke', colorPalette[0])
                        .attr('stroke-width', 2)
                        .attr('fill', 'none')
                        .attr('opacity', 0.5)
                        .attr('stroke-dasharray', '5,5');

                    // Previous Revenue points
                    svg.selectAll('.dot-prev-revenue')
                        .data(previousData)
                        .enter()
                        .append('circle')
                        .attr('class', 'dot-prev-revenue')
                        .attr('cx', d => x(d.month) + x.bandwidth() / 2)
                        .attr('cy', d => yRevenue(parseFloat(d.total_revenue)))
                        .attr('r', 4)
                        .attr('fill', 'white')
                        .attr('stroke', colorPalette[0])
                        .attr('stroke-width', 2)
                        .attr('opacity', 0.5)
                        .style('cursor', 'pointer')
                        .on('mouseover', function(event, d) {
                            d3.select(this).attr('r', 6).attr('opacity', 0.8);
                            showMonthlyTooltip(event, d, false, true);
                        })
                        .on('mouseout', function() {
                            d3.select(this).attr('r', 4).attr('opacity', 0.5);
                            tooltip.style('opacity', 0);
                        });

                    // Previous Margin line
                    const prevMarginLine = d3.line()
                        .x(d => x(d.month) + x.bandwidth() / 2)
                        .y(d => yMargin(parseFloat(d.avg_margin) * 100));

                    svg.append('path')
                        .datum(previousData)
                        .attr('class', 'line-prev')
                        .attr('d', prevMarginLine)
                        .attr('stroke', colorPalette[3])
                        .attr('stroke-width', 2)
                        .attr('fill', 'none')
                        .attr('opacity', 0.5)
                        .attr('stroke-dasharray', '5,5');

                    // Previous Margin points
                    svg.selectAll('.dot-prev-margin')
                        .data(previousData)
                        .enter()
                        .append('circle')
                        .attr('class', 'dot-prev-margin')
                        .attr('cx', d => x(d.month) + x.bandwidth() / 2)
                        .attr('cy', d => yMargin(parseFloat(d.avg_margin) * 100))
                        .attr('r', 4)
                        .attr('fill', 'white')
                        .attr('stroke', colorPalette[3])
                        .attr('stroke-width', 2)
                        .attr('opacity', 0.5)
                        .on('mouseover', function(event, d) {
                            d3.select(this).attr('r', 6).attr('opacity', 0.8);
                            showMonthlyTooltip(event, d, false, true);
                        })
                        .on('mouseout', function() {
                            d3.select(this).attr('r', 4).attr('opacity', 0.5);
                            tooltip.style('opacity', 0);
                        });
                }

                // Current period Revenue line
                const revenueLine = d3.line()
                    .x(d => x(d.month) + x.bandwidth() / 2)
                    .y(d => yRevenue(parseFloat(d.total_revenue)));

                svg.append('path')
                    .datum(currentData)
                    .attr('class', 'line')
                    .attr('d', revenueLine)
                    .attr('stroke', colorPalette[0])
                    .attr('stroke-width', 3)
                    .attr('fill', 'none');

                // Current period Revenue points
                svg.selectAll('.dot-revenue')
                    .data(currentData)
                    .enter()
                    .append('circle')
                    .attr('class', 'dot-revenue')
                    .attr('cx', d => x(d.month) + x.bandwidth() / 2)
                    .attr('cy', d => yRevenue(parseFloat(d.total_revenue)))
                    .attr('r', 5)
                    .attr('fill', 'white')
                    .attr('stroke', colorPalette[0])
                    .attr('stroke-width', 3)
                    .style('cursor', 'pointer')
                    .on('mouseover', function(event, d) {
                        d3.select(this).attr('r', 7);
                        showMonthlyTooltip(event, d, true);
                    })
                    .on('mouseout', function() {
                        d3.select(this).attr('r', 5);
                        tooltip.style('opacity', 0);
                    })
                    .on('click', function(event, d) {
                        drilldownMonth(d.month);
                    });

                // Current period Margin line
                const marginLine = d3.line()
                    .x(d => x(d.month) + x.bandwidth() / 2)
                    .y(d => yMargin(parseFloat(d.avg_margin) * 100));

                svg.append('path')
                    .datum(currentData)
                    .attr('class', 'line')
                    .attr('d', marginLine)
                    .attr('stroke', colorPalette[3])
                    .attr('stroke-width', 3)
                    .attr('fill', 'none')
                    .attr('stroke-dasharray', '5,5');

                // Current period Margin points
                svg.selectAll('.dot-margin')
                    .data(currentData)
                    .enter()
                    .append('circle')
                    .attr('class', 'dot-margin')
                    .attr('cx', d => x(d.month) + x.bandwidth() / 2)
                    .attr('cy', d => yMargin(parseFloat(d.avg_margin) * 100))
                    .attr('r', 5)
                    .attr('fill', 'white')
                    .attr('stroke', colorPalette[3])
                    .attr('stroke-width', 3)
                    .on('mouseover', function(event, d) {
                        d3.select(this).attr('r', 7);
                        showMonthlyTooltip(event, d);
                    })
                    .on('mouseout', function() {
                        d3.select(this).attr('r', 5);
                        tooltip.style('opacity', 0);
                    });
            }

            // Axes
            svg.append('g')
                .attr('class', 'axis')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x).tickFormat(d => moment(d).format('MMM YY')));

            // Left axis (Revenue)
            svg.append('g')
                .attr('class', 'axis')
                .call(d3.axisLeft(yRevenue).ticks(5).tickFormat(d => '$' + d3.format('.2s')(d)));

            svg.append('text')
                .attr('transform', 'rotate(-90)')
                .attr('y', -65)
                .attr('x', -height / 2)
                .attr('text-anchor', 'middle')
                .attr('fill', colorPalette[0])
                .attr('font-size', '12px')
                .attr('font-weight', '600')
                .text('Revenue');

            // Right axis (Margin %)
            svg.append('g')
                .attr('class', 'axis')
                .attr('transform', `translate(${width}, 0)`)
                .call(d3.axisRight(yMargin).ticks(5).tickFormat(d => d.toFixed(0) + '%'));

            svg.append('text')
                .attr('transform', 'rotate(-90)')
                .attr('y', width + 65)
                .attr('x', -height / 2)
                .attr('text-anchor', 'middle')
                .attr('fill', colorPalette[3])
                .attr('font-size', '12px')
                .attr('font-weight', '600')
                .text('Margin %');

            // Helper function for tooltip
            function showMonthlyTooltip(event, d, clickable = false, isPreviousPeriod = false) {
                const marginDollar = parseFloat(d.total_margin_dollar);
                const marginPercent = parseFloat(d.avg_margin) * 100;
                const clickHint = clickable ? '<div class="text-xs text-slate-500 mt-1">Click to view top customers</div>' : '';
                const periodLabel = isPreviousPeriod ? '<div class="text-xs font-semibold text-slate-400 mb-1">Previous Period</div>' : '';
                // Use originalMonth if available (for previous period), otherwise use month
                const displayMonth = d.originalMonth || d.month;
                tooltip.style('opacity', 1)
                    .html(`
                        ${periodLabel}
                        <div><span class="tooltip-label">Month:</span><span class="tooltip-value">${moment(displayMonth).format('MMM YYYY')}</span></div>
                        <div><span class="tooltip-label">Revenue:</span><span class="tooltip-value">$${parseFloat(d.total_revenue).toLocaleString('en-US', {minimumFractionDigits: 2})}</span></div>
                        <div><span class="tooltip-label">Margin $:</span><span class="tooltip-value">$${marginDollar.toLocaleString('en-US', {minimumFractionDigits: 2})}</span></div>
                        <div><span class="tooltip-label">Margin %:</span><span class="tooltip-value">${marginPercent.toFixed(1)}%</span></div>
                        <div><span class="tooltip-label">Orders:</span><span class="tooltip-value">${d.order_count}</span></div>
                        ${clickHint}
                    `)
                    .style('left', (event.pageX + 10) + 'px')
                    .style('top', (event.pageY - 10) + 'px');
            }
        }

        function renderCustomersChart(data) {
            const container = document.getElementById('customersChart');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-12 text-sm">No data available</p>';
                return;
            }

            const margin = { top: 20, right: 30, bottom: 40, left: 120 };
            const width = container.offsetWidth - margin.left - margin.right;
            const height = 300 - margin.top - margin.bottom;

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            // Scales
            const x = d3.scaleLinear()
                .domain([0, d3.max(data, d => parseFloat(d.total_revenue))])
                .nice()
                .range([0, width]);

            const y = d3.scaleBand()
                .domain(data.map(d => d.customer_name))
                .range([0, height])
                .padding(0.2);

            // Bars with margin-based coloring
            svg.selectAll('.bar')
                .data(data)
                .enter()
                .append('rect')
                .attr('class', 'bar')
                .attr('x', 0)
                .attr('y', d => y(d.customer_name))
                .attr('width', d => x(parseFloat(d.total_revenue)))
                .attr('height', y.bandwidth())
                .attr('rx', 4)
                .attr('fill', d => {
                    const margin = parseFloat(d.avg_margin);
                    if (margin >= MARGIN_GOOD) return colorPalette[2]; // Green
                    if (margin >= MARGIN_MEDIUM) return colorPalette[3]; // Orange
                    return colorPalette[4]; // Red
                })
                .style('cursor', 'pointer')
                .on('mouseover', function(event, d) {
                    d3.select(this).style('opacity', 0.8);
                    tooltip.style('opacity', 1)
                        .html(`
                            <div><span class="tooltip-label">Customer:</span><span class="tooltip-value">${d.customer_name}</span></div>
                            <div><span class="tooltip-label">Revenue:</span><span class="tooltip-value">$${parseFloat(d.total_revenue).toLocaleString('en-US', {minimumFractionDigits: 2})}</span></div>
                            <div><span class="tooltip-label">Orders:</span><span class="tooltip-value">${d.order_count}</span></div>
                            <div><span class="tooltip-label">Avg Margin:</span><span class="tooltip-value">${(parseFloat(d.avg_margin) * 100).toFixed(1)}%</span></div>
                            <div class="text-xs text-slate-500 mt-1">Click to view orders</div>
                        `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    d3.select(this).style('opacity', 1);
                    tooltip.style('opacity', 0);
                })
                .on('click', function(event, d) {
                    drilldownCustomer(d.customer_name);
                });

            // Axes
            svg.append('g')
                .attr('class', 'axis')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x).ticks(4).tickFormat(d => '$' + d3.format('.2s')(d)));

            svg.append('g')
                .attr('class', 'axis')
                .call(d3.axisLeft(y))
                .selectAll('text')
                .style('font-size', '10px');
        }

        function renderCategoryChart(data) {
            const container = document.getElementById('categoryChart');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-12 text-sm">No data available</p>';
                return;
            }

            // Create flex container for chart and legend
            const wrapper = d3.select(container)
                .append('div')
                .style('display', 'flex')
                .style('align-items', 'center')
                .style('gap', '20px');

            // Chart container (left side)
            const chartDiv = wrapper.append('div')
                .style('flex-shrink', '0');

            const width = 240;
            const height = 280;
            const radius = Math.min(width, height) / 2;

            const svg = chartDiv.append('svg')
                .attr('width', width)
                .attr('height', height)
                .append('g')
                .attr('transform', `translate(${width / 2},${height / 2})`);

            const color = d3.scaleOrdinal()
                .domain(data.map(d => d.category))
                .range(colorPalette);

            const pie = d3.pie()
                .value(d => parseFloat(d.total_revenue))
                .sort(null);

            const arc = d3.arc()
                .innerRadius(radius * 0.35)
                .outerRadius(radius * 0.9);

            const arcs = svg.selectAll('.arc')
                .data(pie(data))
                .enter()
                .append('g')
                .attr('class', 'arc');

            arcs.append('path')
                .attr('d', arc)
                .attr('fill', d => color(d.data.category))
                .attr('stroke', 'white')
                .attr('stroke-width', 2)
                .style('cursor', 'pointer')
                .on('mouseover', function(event, d) {
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr('d', d3.arc().innerRadius(radius * 0.35).outerRadius(radius * 0.95));

                    const total = d3.sum(data, d => parseFloat(d.total_revenue));
                    const percent = (parseFloat(d.data.total_revenue) / total * 100).toFixed(1);

                    tooltip.style('opacity', 1)
                        .html(`
                            <div><span class="tooltip-label">Category:</span><span class="tooltip-value">${d.data.category}</span></div>
                            <div><span class="tooltip-label">Revenue:</span><span class="tooltip-value">$${parseFloat(d.data.total_revenue).toLocaleString('en-US', {minimumFractionDigits: 2})}</span></div>
                            <div><span class="tooltip-label">Percentage:</span><span class="tooltip-value">${percent}%</span></div>
                            <div class="text-xs text-slate-500 mt-1">Click to view products</div>
                        `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr('d', arc);
                    tooltip.style('opacity', 0);
                })
                .on('click', function(event, d) {
                    drilldownCategory(d.data.category);
                });

            // Add percentage labels on segments
            const total = d3.sum(data, d => parseFloat(d.total_revenue));
            arcs.append('text')
                .attr('transform', d => {
                    const pos = arc.centroid(d);
                    return `translate(${pos})`;
                })
                .attr('text-anchor', 'middle')
                .style('fill', 'white')
                .style('font-size', '12px')
                .style('font-weight', 'bold')
                .style('pointer-events', 'none')
                .text(d => {
                    const percent = (parseFloat(d.data.total_revenue) / total * 100);
                    return percent > 5 ? percent.toFixed(0) + '%' : '';
                });

            // Legend container (right side)
            const legendContainer = wrapper.append('div')
                .style('flex', '1')
                .style('max-height', '280px')
                .style('overflow-y', 'auto');

            const legendItems = legendContainer.selectAll('.legend-item')
                .data(data)
                .enter()
                .append('div')
                .attr('class', 'legend-item')
                .style('display', 'flex')
                .style('align-items', 'center')
                .style('margin-bottom', '8px')
                .style('font-size', '11px')
                .style('cursor', 'pointer')
                .on('click', (event, d) => drilldownCategory(d.category));

            legendItems.append('div')
                .style('width', '12px')
                .style('height', '12px')
                .style('background-color', d => color(d.category))
                .style('margin-right', '8px')
                .style('border-radius', '2px')
                .style('flex-shrink', '0');

            legendItems.append('div')
                .style('color', '#475569')
                .text(d => `${d.category} ($${d3.format('.2s')(parseFloat(d.total_revenue))})`);
        }

        function updateKPIs(data) {
            if (!data || data.length === 0) return;

            const metrics = data[0];
            const kpiCardsContainer = document.getElementById('kpiCards');

            const totalRevenue = '$' + parseFloat(metrics.total_revenue || 0).toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
            const orderCount = (metrics.order_count || 0).toLocaleString();
            const avgOrderValue = '$' + (parseFloat(metrics.total_revenue || 0) / (metrics.order_count || 1)).toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
            const avgMargin = ((parseFloat(metrics.avg_margin || 0)) * 100).toFixed(1) + '%';
            const lowMarginOrders = (metrics.low_margin_orders || 0).toLocaleString();

            kpiCardsContainer.innerHTML = `
                <div class="flex items-center gap-2 px-3 py-2 bg-blue-50 border border-blue-200 rounded-lg">
                    <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="text-xs font-semibold text-slate-600">Revenue:</span>
                    <span class="text-sm font-bold text-slate-900">${totalRevenue}</span>
                </div>
                <div class="flex items-center gap-2 px-3 py-2 bg-emerald-50 border border-emerald-200 rounded-lg">
                    <svg class="w-4 h-4 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <span class="text-xs font-semibold text-slate-600">Orders:</span>
                    <span class="text-sm font-bold text-slate-900">${orderCount}</span>
                </div>
                <div class="flex items-center gap-2 px-3 py-2 bg-purple-50 border border-purple-200 rounded-lg">
                    <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                    </svg>
                    <span class="text-xs font-semibold text-slate-600">Avg Order:</span>
                    <span class="text-sm font-bold text-slate-900">${avgOrderValue}</span>
                </div>
                <div class="flex items-center gap-2 px-3 py-2 bg-amber-50 border border-amber-200 rounded-lg">
                    <svg class="w-4 h-4 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    <span class="text-xs font-semibold text-slate-600">Margin:</span>
                    <span class="text-sm font-bold text-slate-900">${avgMargin}</span>
                </div>
                ${lowMarginOrders > 0 ? `
                <div class="flex items-center gap-2 px-3 py-2 bg-red-50 border border-red-200 rounded-lg">
                    <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                    <span class="text-xs font-semibold text-slate-600">Low Margin:</span>
                    <span class="text-sm font-bold text-slate-900">${lowMarginOrders}</span>
                </div>
                ` : ''}
            `;
        }

        function renderManagerChart(data) {
            const container = document.getElementById('managerChart');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-12 text-sm">No data available</p>';
                return;
            }

            const margin = { top: 20, right: 30, bottom: 40, left: 90 };
            const width = container.offsetWidth - margin.left - margin.right;
            const height = 280 - margin.top - margin.bottom;

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const x = d3.scaleLinear()
                .domain([0, d3.max(data, d => parseFloat(d.total_revenue))])
                .nice()
                .range([0, width]);

            const y = d3.scaleBand()
                .domain(data.map(d => d.manager_name))
                .range([0, height])
                .padding(0.2);

            svg.selectAll('.bar')
                .data(data)
                .enter()
                .append('rect')
                .attr('x', 0)
                .attr('y', d => y(d.manager_name))
                .attr('width', d => x(parseFloat(d.total_revenue)))
                .attr('height', y.bandwidth())
                .attr('fill', colorPalette[1])
                .attr('rx', 4)
                .style('cursor', 'pointer')
                .on('mouseover', function(event, d) {
                    d3.select(this).attr('fill', colorPalette[0]);
                    tooltip.style('opacity', 1)
                        .html(`
                            <div><span class="tooltip-label">Manager:</span><span class="tooltip-value">${d.manager_name}</span></div>
                            <div><span class="tooltip-label">Revenue:</span><span class="tooltip-value">$${parseFloat(d.total_revenue).toLocaleString('en-US', {minimumFractionDigits: 2})}</span></div>
                            <div><span class="tooltip-label">Orders:</span><span class="tooltip-value">${d.order_count}</span></div>
                            <div class="text-xs text-slate-500 mt-1">Click to view customers</div>
                        `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    d3.select(this).attr('fill', colorPalette[1]);
                    tooltip.style('opacity', 0);
                })
                .on('click', function(event, d) {
                    drilldownManager(d.manager_name);
                });

            svg.append('g')
                .attr('class', 'axis')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x).ticks(4).tickFormat(d => '$' + d3.format('.2s')(d)));

            svg.append('g')
                .attr('class', 'axis')
                .call(d3.axisLeft(y))
                .selectAll('text')
                .style('font-size', '10px');
        }

        function renderMarginChart(data) {
            const container = document.getElementById('marginChart');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-12 text-sm">No data available</p>';
                return;
            }

            const margin = { top: 20, right: 50, bottom: 40, left: 60 };
            const width = container.offsetWidth - margin.left - margin.right;
            const height = 280 - margin.top - margin.bottom;

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const x = d3.scaleTime()
                .domain(d3.extent(data, d => new Date(d.date)))
                .range([0, width]);

            const yMargin = d3.scaleLinear()
                .domain([0, 1])
                .range([height, 0]);

            // Line for margin %
            const line = d3.line()
                .x(d => x(new Date(d.date)))
                .y(d => yMargin(parseFloat(d.avg_margin)));

            svg.append('path')
                .datum(data)
                .attr('class', 'line')
                .attr('d', line)
                .attr('stroke', colorPalette[3])
                .attr('stroke-width', 3);

            // Axes
            svg.append('g')
                .attr('class', 'axis')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x).ticks(5).tickFormat(d3.timeFormat('%b %d')));

            svg.append('g')
                .attr('class', 'axis')
                .call(d3.axisLeft(yMargin).ticks(5).tickFormat(d => (d * 100).toFixed(0) + '%'));

            // Reference lines for margin thresholds
            svg.append('line')
                .attr('x1', 0)
                .attr('x2', width)
                .attr('y1', yMargin(MARGIN_GOOD))
                .attr('y2', yMargin(MARGIN_GOOD))
                .attr('stroke', colorPalette[2])
                .attr('stroke-dasharray', '4,4')
                .attr('opacity', 0.5);

            svg.append('line')
                .attr('x1', 0)
                .attr('x2', width)
                .attr('y1', yMargin(MARGIN_MEDIUM))
                .attr('y2', yMargin(MARGIN_MEDIUM))
                .attr('stroke', colorPalette[3])
                .attr('stroke-dasharray', '4,4')
                .attr('opacity', 0.5);
        }

        function renderSalespeopleChart(data) {
            const container = document.getElementById('salespeopleChart');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-12 text-sm">No data available</p>';
                return;
            }

            const margin = { top: 20, right: 30, bottom: 40, left: 90 };
            const width = container.offsetWidth - margin.left - margin.right;
            const height = 280 - margin.top - margin.bottom;

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const x = d3.scaleLinear()
                .domain([0, d3.max(data, d => parseFloat(d.total_revenue))])
                .nice()
                .range([0, width]);

            const y = d3.scaleBand()
                .domain(data.map(d => d.salesman))
                .range([0, height])
                .padding(0.2);

            svg.selectAll('.bar')
                .data(data)
                .enter()
                .append('rect')
                .attr('x', 0)
                .attr('y', d => y(d.salesman))
                .attr('width', d => x(parseFloat(d.total_revenue)))
                .attr('height', y.bandwidth())
                .attr('fill', colorPalette[5])
                .attr('rx', 4)
                .style('cursor', 'pointer')
                .on('mouseover', function(event, d) {
                    d3.select(this).attr('fill', colorPalette[4]);
                    tooltip.style('opacity', 1)
                        .html(`
                            <div><span class="tooltip-label">Salesperson:</span><span class="tooltip-value">${d.salesman}</span></div>
                            <div><span class="tooltip-label">Revenue:</span><span class="tooltip-value">$${parseFloat(d.total_revenue).toLocaleString('en-US', {minimumFractionDigits: 2})}</span></div>
                            <div><span class="tooltip-label">Orders:</span><span class="tooltip-value">${d.order_count}</span></div>
                            <div><span class="tooltip-label">Avg Margin:</span><span class="tooltip-value">${(parseFloat(d.avg_margin || 0) * 100).toFixed(1)}%</span></div>
                            <div class="text-xs text-slate-500 mt-1">Click to view orders</div>
                        `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    d3.select(this).attr('fill', colorPalette[5]);
                    tooltip.style('opacity', 0);
                })
                .on('click', function(event, d) {
                    drilldownSalesperson(d.salesman);
                });

            // Add value labels showing revenue and margin
            svg.selectAll('.value-label')
                .data(data)
                .enter()
                .append('text')
                .attr('class', 'value-label')
                .attr('x', d => x(parseFloat(d.total_revenue)) + 5)
                .attr('y', d => y(d.salesman) + y.bandwidth() / 2)
                .attr('dy', '0.35em')
                .style('font-size', '10px')
                .style('fill', '#475569')
                .style('font-weight', '600')
                .text(d => {
                    const revenue = '$' + d3.format('.2s')(parseFloat(d.total_revenue));
                    const margin = (parseFloat(d.avg_margin || 0) * 100).toFixed(0) + '%';
                    return `${revenue} (${margin})`;
                });

            svg.append('g')
                .attr('class', 'axis')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x).ticks(4).tickFormat(d => '$' + d3.format('.2s')(d)));

            svg.append('g')
                .attr('class', 'axis')
                .call(d3.axisLeft(y))
                .selectAll('text')
                .style('font-size', '10px');
        }

        function renderGroupChart(data) {
            const container = document.getElementById('groupChart');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-12 text-sm">No data available</p>';
                return;
            }

            // Create flex container for chart and legend
            const wrapper = d3.select(container)
                .append('div')
                .style('display', 'flex')
                .style('align-items', 'center')
                .style('gap', '20px');

            // Chart container (left side)
            const chartDiv = wrapper.append('div')
                .style('flex-shrink', '0');

            const width = 240;
            const height = 280;
            const radius = Math.min(width, height) / 2;

            const svg = chartDiv.append('svg')
                .attr('width', width)
                .attr('height', height)
                .append('g')
                .attr('transform', `translate(${width / 2},${height / 2})`);

            const color = d3.scaleOrdinal()
                .domain(data.map(d => d.group_name))
                .range(colorPalette);

            const pie = d3.pie()
                .value(d => parseFloat(d.total_revenue))
                .sort(null);

            const arc = d3.arc()
                .innerRadius(radius * 0.35)
                .outerRadius(radius * 0.9);

            const arcs = svg.selectAll('.arc')
                .data(pie(data))
                .enter()
                .append('g')
                .attr('class', 'arc');

            arcs.append('path')
                .attr('d', arc)
                .attr('fill', d => color(d.data.group_name))
                .attr('stroke', 'white')
                .attr('stroke-width', 2)
                .style('cursor', 'pointer')
                .on('mouseover', function(event, d) {
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr('d', d3.arc().innerRadius(radius * 0.35).outerRadius(radius * 0.95));

                    const total = d3.sum(data, d => parseFloat(d.total_revenue));
                    const percent = (parseFloat(d.data.total_revenue) / total * 100).toFixed(1);

                    tooltip.style('opacity', 1)
                        .html(`
                            <div><span class="tooltip-label">Group:</span><span class="tooltip-value">${d.data.group_name}</span></div>
                            <div><span class="tooltip-label">Revenue:</span><span class="tooltip-value">$${parseFloat(d.data.total_revenue).toLocaleString('en-US', {minimumFractionDigits: 2})}</span></div>
                            <div><span class="tooltip-label">Percentage:</span><span class="tooltip-value">${percent}%</span></div>
                            <div class="text-xs text-slate-500 mt-1">Click to view orders</div>
                        `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr('d', arc);
                    tooltip.style('opacity', 0);
                })
                .on('click', function(event, d) {
                    drilldownCustomerGroup(d.data.group_name);
                });

            // Add percentage labels on segments
            const total = d3.sum(data, d => parseFloat(d.total_revenue));
            arcs.append('text')
                .attr('transform', d => {
                    const pos = arc.centroid(d);
                    return `translate(${pos})`;
                })
                .attr('text-anchor', 'middle')
                .style('fill', 'white')
                .style('font-size', '12px')
                .style('font-weight', 'bold')
                .style('pointer-events', 'none')
                .text(d => {
                    const percent = (parseFloat(d.data.total_revenue) / total * 100);
                    return percent > 5 ? percent.toFixed(0) + '%' : '';
                });

            // Legend container (right side)
            const legendContainer = wrapper.append('div')
                .style('flex', '1')
                .style('max-height', '280px')
                .style('overflow-y', 'auto');

            const legendItems = legendContainer.selectAll('.legend-item')
                .data(data)
                .enter()
                .append('div')
                .attr('class', 'legend-item')
                .style('display', 'flex')
                .style('align-items', 'center')
                .style('margin-bottom', '8px')
                .style('font-size', '11px');

            legendItems.append('div')
                .style('width', '12px')
                .style('height', '12px')
                .style('background-color', d => color(d.group_name))
                .style('margin-right', '8px')
                .style('border-radius', '2px')
                .style('flex-shrink', '0');

            legendItems.append('div')
                .style('color', '#475569')
                .text(d => `${d.group_name} ($${d3.format('.2s')(parseFloat(d.total_revenue))})`);
        }

        function renderProductsChart(data) {
            const container = document.getElementById('productsChart');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-12 text-sm">No data available</p>';
                return;
            }

            const margin = { top: 20, right: 30, bottom: 40, left: 90 };
            const width = container.offsetWidth - margin.left - margin.right;
            const height = 280 - margin.top - margin.bottom;

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const x = d3.scaleLinear()
                .domain([0, d3.max(data, d => parseFloat(d.total_qty))])
                .nice()
                .range([0, width]);

            const y = d3.scaleBand()
                .domain(data.map(d => d.product_num))
                .range([0, height])
                .padding(0.2);

            svg.selectAll('.bar')
                .data(data)
                .enter()
                .append('rect')
                .attr('x', 0)
                .attr('y', d => y(d.product_num))
                .attr('width', d => x(parseFloat(d.total_qty)))
                .attr('height', y.bandwidth())
                .attr('fill', colorPalette[7])
                .attr('rx', 4)
                .style('cursor', 'pointer')
                .on('mouseover', function(event, d) {
                    d3.select(this).attr('fill', colorPalette[6]);
                    tooltip.style('opacity', 1)
                        .html(`
                            <div><span class="tooltip-label">Product:</span><span class="tooltip-value">${d.product_num}</span></div>
                            <div><span class="tooltip-label">Description:</span><span class="tooltip-value">${d.product_desc}</span></div>
                            <div><span class="tooltip-label">Quantity:</span><span class="tooltip-value">${parseFloat(d.total_qty).toLocaleString()}</span></div>
                            <div><span class="tooltip-label">Revenue:</span><span class="tooltip-value">$${parseFloat(d.total_revenue).toLocaleString('en-US', {minimumFractionDigits: 2})}</span></div>
                            <div class="text-xs text-slate-500 mt-1">Click to view orders</div>
                        `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    d3.select(this).attr('fill', colorPalette[7]);
                    tooltip.style('opacity', 0);
                })
                .on('click', function(event, d) {
                    drilldownProduct(d.product_num, d.product_desc);
                });

            svg.append('g')
                .attr('class', 'axis')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x).ticks(4));

            svg.append('g')
                .attr('class', 'axis')
                .call(d3.axisLeft(y))
                .selectAll('text')
                .style('font-size', '10px');
        }

        // ============================================
        // New Metrics Rendering Functions
        // ============================================

        // Render Low Margin Sales (continues next comment for brevity)
        function renderLowMarginChart(data) {
            // Update metric count
            document.querySelector('#lowMarginMetric .text-4xl').textContent = data.length;

            // Render simple list in chart area
            const container = document.getElementById('lowMarginChart');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-400 py-8">No low margin orders found</div>';
                return;
            }

            // Create clickable list
            const list = document.createElement('div');
            list.className = 'space-y-2 overflow-y-auto';
            list.style.maxHeight = '200px';

            data.slice(0, 5).forEach(order => {
                const item = document.createElement('div');
                item.className = 'p-2 bg-amber-50 rounded cursor-pointer hover:bg-amber-100 transition-colors';
                item.onclick = () => drilldownLowMargin();
                item.innerHTML = `
                    <div class="flex justify-between text-sm">
                        <span class="font-semibold text-slate-700">${order.order_num}</span>
                        <span class="text-amber-700 font-bold">${(order.margin_percent * 100).toFixed(1)}%</span>
                    </div>
                    <div class="text-xs text-slate-500">${order.customer_name}</div>
                `;
                list.appendChild(item);
            });

            container.appendChild(list);
        }

        function renderNegativeMarginChart(data) {
            // Update metric count
            document.querySelector('#negativeMarginMetric .text-4xl').textContent = data.length;

            const container = document.getElementById('negativeMarginChart');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<div class="text-center text-green-600 py-8 font-semibold"> No negative margin orders!</div>';
                return;
            }

            const list = document.createElement('div');
            list.className = 'space-y-2 overflow-y-auto';
            list.style.maxHeight = '200px';

            data.slice(0, 5).forEach(order => {
                const item = document.createElement('div');
                item.className = 'p-2 bg-red-50 rounded cursor-pointer hover:bg-red-100 transition-colors';
                item.onclick = () => drilldownNegativeMargin();
                item.innerHTML = `
                    <div class="flex justify-between text-sm">
                        <span class="font-semibold text-slate-700">${order.order_num}</span>
                        <span class="text-red-700 font-bold">${(order.margin_percent * 100).toFixed(1)}%</span>
                    </div>
                    <div class="text-xs text-slate-500">${order.customer_name}</div>
                `;
                list.appendChild(item);
            });

            container.appendChild(list);
        }

        function renderHighValueChart(data) {
            // Update metric count
            document.querySelector('#highValueMetric .text-4xl').textContent = data.length;

            const container = document.getElementById('highValueChart');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-400 py-8">No high value orders found</div>';
                return;
            }

            const list = document.createElement('div');
            list.className = 'space-y-2 overflow-y-auto';
            list.style.maxHeight = '200px';

            data.slice(0, 5).forEach(order => {
                const item = document.createElement('div');
                item.className = 'p-2 bg-green-50 rounded cursor-pointer hover:bg-green-100 transition-colors';
                item.onclick = () => drilldownHighValue();
                item.innerHTML = `
                    <div class="flex justify-between text-sm">
                        <span class="font-semibold text-slate-700">${order.order_num}</span>
                        <span class="text-green-700 font-bold">$${parseFloat(order.order_total).toLocaleString('en-US', {maximumFractionDigits: 0})}</span>
                    </div>
                    <div class="text-xs text-slate-500">${order.customer_name}</div>
                `;
                list.appendChild(item);
            });

            container.appendChild(list);
        }

        function renderAverageOrderValue(data) {
            const hasPrevious = data.current !== undefined;
            const currentData = hasPrevious ? data.current : data;
            const aov = parseFloat(currentData.avg_order_value || 0);

            document.querySelector('#aovMetric .text-5xl').textContent = `$${aov.toLocaleString('en-US', {maximumFractionDigits: 0})}`;

            if (hasPrevious && data.previous) {
                const prevAov = parseFloat(data.previous.avg_order_value || 0);
                const change = ((aov - prevAov) / prevAov * 100).toFixed(1);
                const isPositive = change >= 0;

                document.getElementById('aovComparison').classList.remove('hidden');
                document.getElementById('aovPrevious').textContent = `$${prevAov.toLocaleString('en-US', {maximumFractionDigits: 0})} (${isPositive ? '+' : ''}${change}%)`;
                document.getElementById('aovPrevious').className = isPositive ? 'text-green-600' : 'text-red-600';
            } else {
                document.getElementById('aovComparison').classList.add('hidden');
            }
        }

        function renderNewVsRepeatChart(data) {
            const container = document.getElementById('newRepeatChart');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-400 py-8">No data available</div>';
                return;
            }

            const width = container.clientWidth;
            const height = 280;
            const radius = Math.min(width, height) / 2 - 40;

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            const g = svg.append('g')
                .attr('transform', `translate(${width / 2}, ${height / 2})`);

            const color = d3.scaleOrdinal()
                .domain(['New', 'Repeat'])
                .range(['#2d9cdb', '#27ae60']);

            const pie = d3.pie()
                .value(d => d.count)
                .sort(null);

            const arc = d3.arc()
                .innerRadius(radius * 0.6)
                .outerRadius(radius);

            const arcs = g.selectAll('arc')
                .data(pie(data))
                .enter()
                .append('g')
                .attr('class', 'arc')
                .style('cursor', 'pointer')
                .on('click', (event, d) => drilldownNewRepeat(d.data.type));

            arcs.append('path')
                .attr('d', arc)
                .attr('fill', d => color(d.data.type))
                .attr('stroke', 'white')
                .attr('stroke-width', 2)
                .on('mouseover', function() {
                    d3.select(this).style('opacity', 0.8);
                })
                .on('mouseout', function() {
                    d3.select(this).style('opacity', 1);
                });

            arcs.append('text')
                .attr('transform', d => `translate(${arc.centroid(d)})`)
                .attr('text-anchor', 'middle')
                .attr('fill', 'white')
                .attr('font-weight', 'bold')
                .attr('font-size', '14px')
                .text(d => d.data.count);

            // Legend
            const legend = svg.append('g')
                .attr('transform', `translate(10, ${height - 60})`);

            data.forEach((d, i) => {
                const legendRow = legend.append('g')
                    .attr('transform', `translate(0, ${i * 20})`);

                legendRow.append('rect')
                    .attr('width', 12)
                    .attr('height', 12)
                    .attr('fill', color(d.type));

                legendRow.append('text')
                    .attr('x', 18)
                    .attr('y', 10)
                    .attr('font-size', '11px')
                    .attr('fill', '#64748b')
                    .text(`${d.type}: ${d.count} ($${d.revenue.toLocaleString('en-US', {maximumFractionDigits: 0})})`);
            });
        }

        function renderTopMarginCustomersChart(data) {
            const container = document.getElementById('topMarginCustomersChart');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-400 py-8">No data available</div>';
                return;
            }

            const width = container.clientWidth;
            const height = 280;
            const margin = { top: 10, right: 10, bottom: 60, left: 40 };

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            const x = d3.scaleBand()
                .domain(data.map(d => d.customer_name))
                .range([margin.left, width - margin.right])
                .padding(0.3);

            const y = d3.scaleLinear()
                .domain([0, d3.max(data, d => d.avg_margin_percent)])
                .nice()
                .range([height - margin.bottom, margin.top]);

            const color = d3.scaleSequential()
                .domain([0, d3.max(data, d => d.avg_margin_percent)])
                .interpolator(d3.interpolateGreens);

            svg.selectAll('rect')
                .data(data)
                .enter()
                .append('rect')
                .attr('x', d => x(d.customer_name))
                .attr('y', d => y(d.avg_margin_percent))
                .attr('width', x.bandwidth())
                .attr('height', d => height - margin.bottom - y(d.avg_margin_percent))
                .attr('fill', d => color(d.avg_margin_percent))
                .style('cursor', 'pointer')
                .on('click', (event, d) => drilldownCustomer(d.customer_name))
                .on('mouseover', function(event, d) {
                    d3.select(this).style('opacity', 0.7);
                    showTooltip(event, `
                        <strong>${d.customer_name}</strong><br>
                        Avg Margin: ${(d.avg_margin_percent * 100).toFixed(1)}%<br>
                        Revenue: $${parseFloat(d.total_revenue).toLocaleString()}<br>
                        Orders: ${d.order_count}
                    `);
                })
                .on('mouseout', function() {
                    d3.select(this).style('opacity', 1);
                    hideTooltip();
                });

            svg.append('g')
                .attr('transform', `translate(0, ${height - margin.bottom})`)
                .attr('class', 'axis')
                .call(d3.axisBottom(x))
                .selectAll('text')
                .attr('transform', 'rotate(-45)')
                .style('text-anchor', 'end')
                .style('font-size', '9px')
                .text(d => d.length > 15 ? d.substring(0, 15) + '...' : d);

            svg.append('g')
                .attr('transform', `translate(${margin.left}, 0)`)
                .attr('class', 'axis')
                .call(d3.axisLeft(y).tickFormat(d => (d * 100).toFixed(0) + '%'));
        }

        function renderInactiveCustomersChart(data) {
            // Update metric count
            document.querySelector('#inactiveCustomersMetric .text-4xl').textContent = data.length;

            const container = document.getElementById('inactiveCustomersChart');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<div class="text-center text-green-600 py-8 font-semibold"> No inactive customers!</div>';
                return;
            }

            const list = document.createElement('div');
            list.className = 'space-y-2 overflow-y-auto';
            list.style.maxHeight = '200px';

            data.slice(0, 5).forEach(customer => {
                const item = document.createElement('div');
                item.className = 'p-2 bg-slate-50 rounded cursor-pointer hover:bg-slate-100 transition-colors';
                item.onclick = () => drilldownInactiveCustomers();
                item.innerHTML = `
                    <div class="flex justify-between text-sm">
                        <span class="font-semibold text-slate-700">${customer.customer_name}</span>
                        <span class="text-slate-600 text-xs">${customer.days_since_order} days</span>
                    </div>
                    <div class="text-xs text-slate-500">Lifetime: $${parseFloat(customer.lifetime_revenue).toLocaleString('en-US', {maximumFractionDigits: 0})}</div>
                `;
                list.appendChild(item);
            });

            container.appendChild(list);
        }

        function renderProductMixChart(data) {
            const container = document.getElementById('productMixChart');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-400 py-8">No data available</div>';
                return;
            }

            // Group data by month and category
            const months = [...new Set(data.map(d => d.month))].sort();
            const categories = [...new Set(data.map(d => d.category))];

            // Create stacked data structure
            const stackData = months.map(month => {
                const monthData = { month };
                categories.forEach(cat => {
                    const found = data.find(d => d.month === month && d.category === cat);
                    monthData[cat] = found ? parseFloat(found.revenue) : 0;
                });
                return monthData;
            });

            const width = container.clientWidth;
            const height = 280;
            const margin = { top: 10, right: 120, bottom: 40, left: 60 };

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            const x = d3.scaleBand()
                .domain(months)
                .range([margin.left, width - margin.right])
                .padding(0.1);

            const y = d3.scaleLinear()
                .domain([0, d3.max(stackData, d => {
                    return categories.reduce((sum, cat) => sum + (d[cat] || 0), 0);
                })])
                .nice()
                .range([height - margin.bottom, margin.top]);

            const color = d3.scaleOrdinal()
                .domain(categories)
                .range(d3.schemeCategory10);

            const stack = d3.stack()
                .keys(categories);

            const series = stack(stackData);

            svg.append('g')
                .selectAll('g')
                .data(series)
                .enter().append('g')
                .attr('fill', d => color(d.key))
                .selectAll('rect')
                .data(d => d)
                .enter().append('rect')
                .attr('x', d => x(d.data.month))
                .attr('y', d => y(d[1]))
                .attr('height', d => y(d[0]) - y(d[1]))
                .attr('width', x.bandwidth())
                .on('mouseover', function(event, d) {
                    const category = d3.select(this.parentNode).datum().key;
                    const value = d.data[category];
                    showTooltip(event, `
                        <strong>${category}</strong><br>
                        Month: ${d.data.month}<br>
                        Revenue: $${value.toLocaleString()}
                    `);
                })
                .on('mouseout', hideTooltip);

            svg.append('g')
                .attr('transform', `translate(0, ${height - margin.bottom})`)
                .attr('class', 'axis')
                .call(d3.axisBottom(x))
                .selectAll('text')
                .style('font-size', '9px');

            svg.append('g')
                .attr('transform', `translate(${margin.left}, 0)`)
                .attr('class', 'axis')
                .call(d3.axisLeft(y).tickFormat(d => '$' + (d / 1000).toFixed(0) + 'k'));

            // Legend
            const legend = svg.append('g')
                .attr('transform', `translate(${width - margin.right + 10}, ${margin.top})`);

            categories.forEach((cat, i) => {
                const legendRow = legend.append('g')
                    .attr('transform', `translate(0, ${i * 18})`);

                legendRow.append('rect')
                    .attr('width', 12)
                    .attr('height', 12)
                    .attr('fill', color(cat));

                legendRow.append('text')
                    .attr('x', 16)
                    .attr('y', 10)
                    .attr('font-size', '10px')
                    .attr('fill', '#64748b')
                    .text(cat.length > 12 ? cat.substring(0, 12) + '...' : cat);
            });
        }

        function renderSlowMovingChart(data) {
            const container = document.getElementById('slowMovingChart');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-400 py-8">No slow-moving inventory found</div>';
                return;
            }

            const width = container.clientWidth;
            const height = 280;
            const margin = { top: 10, right: 10, bottom: 60, left: 100 };

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            const topData = data.slice(0, 10);

            const x = d3.scaleLinear()
                .domain([0, d3.max(topData, d => d.days_of_supply)])
                .nice()
                .range([margin.left, width - margin.right]);

            const y = d3.scaleBand()
                .domain(topData.map(d => d.product_name))
                .range([margin.top, height - margin.bottom])
                .padding(0.2);

            svg.selectAll('rect')
                .data(topData)
                .enter()
                .append('rect')
                .attr('x', margin.left)
                .attr('y', d => y(d.product_name))
                .attr('width', d => x(d.days_of_supply) - margin.left)
                .attr('height', y.bandwidth())
                .attr('fill', '#f97316')
                .style('cursor', 'pointer')
                .on('click', (event, d) => drilldownProduct(d.product_num))
                .on('mouseover', function(event, d) {
                    d3.select(this).style('opacity', 0.7);
                    showTooltip(event, `
                        <strong>${d.product_name}</strong><br>
                        On Hand: ${d.qty_on_hand}<br>
                        Sold (period): ${d.qty_sold}<br>
                        Days of Supply: ${d.days_of_supply ? d.days_of_supply.toFixed(0) : 'N/A'}
                    `);
                })
                .on('mouseout', function() {
                    d3.select(this).style('opacity', 1);
                    hideTooltip();
                });

            svg.append('g')
                .attr('transform', `translate(0, ${height - margin.bottom})`)
                .attr('class', 'axis')
                .call(d3.axisBottom(x));

            svg.append('g')
                .attr('transform', `translate(${margin.left}, 0)`)
                .attr('class', 'axis')
                .call(d3.axisLeft(y))
                .selectAll('text')
                .style('font-size', '9px')
                .text(d => d.length > 20 ? d.substring(0, 20) + '...' : d);
        }

        function renderOrdersPerSalespersonChart(data) {
            const container = document.getElementById('ordersPerSalespersonChart');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-400 py-8">No data available</div>';
                return;
            }

            const width = container.clientWidth;
            const height = 280;
            const margin = { top: 10, right: 10, bottom: 60, left: 40 };

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            const x = d3.scaleBand()
                .domain(data.map(d => d.fullName || d.userName))
                .range([margin.left, width - margin.right])
                .padding(0.3);

            const y = d3.scaleLinear()
                .domain([0, d3.max(data, d => d.order_count)])
                .nice()
                .range([height - margin.bottom, margin.top]);

            svg.selectAll('rect')
                .data(data)
                .enter()
                .append('rect')
                .attr('x', d => x(d.fullName || d.userName))
                .attr('y', d => y(d.order_count))
                .attr('width', x.bandwidth())
                .attr('height', d => height - margin.bottom - y(d.order_count))
                .attr('fill', '#2d9cdb')
                .style('cursor', 'pointer')
                .on('click', (event, d) => drilldownSalesperson(d.userName))
                .on('mouseover', function(event, d) {
                    d3.select(this).style('opacity', 0.7);
                    showTooltip(event, `
                        <strong>${d.fullName || d.userName}</strong><br>
                        Orders: ${d.order_count}<br>
                        Revenue: $${parseFloat(d.total_revenue).toLocaleString()}
                    `);
                })
                .on('mouseout', function() {
                    d3.select(this).style('opacity', 1);
                    hideTooltip();
                });

            svg.append('g')
                .attr('transform', `translate(0, ${height - margin.bottom})`)
                .attr('class', 'axis')
                .call(d3.axisBottom(x))
                .selectAll('text')
                .attr('transform', 'rotate(-45)')
                .style('text-anchor', 'end')
                .style('font-size', '9px')
                .text(d => d.length > 12 ? d.substring(0, 12) + '...' : d);

            svg.append('g')
                .attr('transform', `translate(${margin.left}, 0)`)
                .attr('class', 'axis')
                .call(d3.axisLeft(y));
        }

        function renderAvgDaysToShip(data) {
            const hasPrevious = data.current !== undefined;
            const currentData = hasPrevious ? data.current : data;
            const avgDays = parseFloat(currentData.avg_days || 0);

            document.querySelector('#avgDaysMetric .text-5xl').textContent = avgDays.toFixed(1);

            if (hasPrevious && data.previous) {
                const prevDays = parseFloat(data.previous.avg_days || 0);
                const change = ((avgDays - prevDays) / prevDays * 100).toFixed(1);
                const isImprovement = avgDays < prevDays;

                document.getElementById('avgDaysComparison').classList.remove('hidden');
                document.getElementById('avgDaysPrevious').textContent = `${prevDays.toFixed(1)} (${isImprovement ? '' : '+'}${change}%)`;
                document.getElementById('avgDaysPrevious').className = isImprovement ? 'text-green-600' : 'text-red-600';
            } else {
                document.getElementById('avgDaysComparison').classList.add('hidden');
            }
        }

        // ============================================
        // UI Functions
        // ============================================
        function applyDateRange() {
            const rangeValue = document.getElementById('dateRangeFilter').value;
            const customContainer = document.getElementById('customDateRangeContainer');
            const comparisonContainer = document.getElementById('comparisonToggleContainer');

            // Hide/show custom date picker
            if (rangeValue === 'custom') {
                customContainer.style.display = 'flex';
                comparisonContainer.style.display = 'none';
                return; // Don't load dashboard until custom dates are set
            } else {
                customContainer.style.display = 'none';
            }

            // Show comparison toggle for current periods
            const showComparison = ['this_quarter', 'current_fy', 'current_cy'].includes(rangeValue);
            comparisonContainer.style.display = showComparison ? 'flex' : 'none';

            // Calculate date range
            let dates;
            switch(rangeValue) {
                case 'this_quarter':
                    dates = getQuarterDates(0);
                    break;
                case 'last_quarter':
                    dates = getQuarterDates(1);
                    break;
                case 'current_fy':
                    dates = getFYDates(0);
                    break;
                case 'last_fy':
                    dates = getFYDates(1);
                    break;
                case 'current_cy':
                    dates = getCalendarYearDates(0);
                    break;
                case 'last_cy':
                    dates = getCalendarYearDates(1);
                    break;
                default:
                    // Numeric days
                    currentDateRange = parseInt(rangeValue);
                    customStartDate = null;
                    customEndDate = null;
                    loadDashboard();
                    return;
            }

            customStartDate = dates.start;
            customEndDate = dates.end;
            document.getElementById('customStartDate').value = dates.start;
            document.getElementById('customEndDate').value = dates.end;

            loadDashboard();
        }

        function toggleComparison() {
            comparisonEnabled = document.getElementById('comparisonToggle').checked;
            loadDashboard();
        }

        function setDateRange(days) {
            // Legacy function for backward compatibility
            document.getElementById('dateRangeFilter').value = days.toString();
            applyDateRange();
        }

        function toggleRevenueChartMode(mode) {
            revenueChartMode = mode;

            // Update button states
            const lineBtn = document.getElementById('revenueLineBtn');
            const barBtn = document.getElementById('revenueBarBtn');

            if (mode === 'line') {
                lineBtn.classList.add('bg-white', 'text-slate-800');
                lineBtn.classList.remove('text-slate-600');
                barBtn.classList.remove('bg-white', 'text-slate-800');
                barBtn.classList.add('text-slate-600');
            } else {
                barBtn.classList.add('bg-white', 'text-slate-800');
                barBtn.classList.remove('text-slate-600');
                lineBtn.classList.remove('bg-white', 'text-slate-800');
                lineBtn.classList.add('text-slate-600');
            }

            // Re-render the chart with new mode
            const data = getSalesRevenueOverTime();
            renderRevenueChart(data);
        }

        function applyCustomDateRange() {
            const startInput = document.getElementById('customStartDate');
            const endInput = document.getElementById('customEndDate');

            if (startInput.value && endInput.value) {
                customStartDate = startInput.value;
                customEndDate = endInput.value;
                currentDateRange = null; // Clear preset range

                // Clear preset button states
                document.querySelectorAll('.bg-slate-50 button').forEach(btn => {
                    btn.classList.remove('bg-white', 'text-slate-800');
                    btn.classList.add('text-slate-600');
                });

                loadDashboard();
            }
        }

        // ============================================
        // Drill-down Modal Functions
        // ============================================
        function openDrilldown(title, breadcrumb, data, columns) {
            if (!data || !Array.isArray(data)) {
                debugLog('openDrilldown called with invalid data', 'error');
                return;
            }
            debugLog(`Opening drilldown: "${title}" with ${data.length} rows`, 'info');
            currentDrilldownData = data;
            currentDrilldownColumns = columns;
            currentSortColumn = null;
            currentSortDirection = 'asc';

            document.getElementById('drilldownTitle').textContent = title;
            document.getElementById('drilldownBreadcrumb').textContent = breadcrumb;
            document.getElementById('drilldownSearch').value = '';

            renderDrilldownTable(data);

            const modal = document.getElementById('drilldownModal');
            debugLog('Modal element found: ' + (modal ? 'YES' : 'NO'), modal ? 'success' : 'error');
            debugLog('Setting modal display to flex...', 'info');
            modal.style.display = 'flex';
            debugLog('Modal display is now: ' + modal.style.display, modal.style.display === 'flex' ? 'success' : 'error');
        }

        function closeDrilldown(event) {
            if (event && event.target !== event.currentTarget) return;

            debugLog('Closing drilldown modal', 'info');
            const modal = document.getElementById('drilldownModal');
            modal.style.display = 'none';
        }

        function renderDrilldownTable(data) {
            const thead = document.getElementById('drilldownTableHead');
            const tbody = document.getElementById('drilldownTableBody');

            // Render headers
            thead.innerHTML = '<tr>' + currentDrilldownColumns.map((col, idx) => `
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider cursor-pointer hover:bg-slate-100 transition-colors" onclick="sortDrilldownTable(${idx})">
                    <div class="flex items-center gap-2">
                        <span>${col.label}</span>
                        <svg class="w-3 h-3 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                        </svg>
                    </div>
                </th>
            `).join('') + '</tr>';

            // Render rows
            tbody.innerHTML = data.map((row, rowIndex) => {
                const isOrderRow = row.hasOwnProperty('order_num');
                const rowClass = isOrderRow ? 'hover:bg-indigo-50 cursor-pointer transition-colors' : 'hover:bg-slate-50 transition-colors';
                const rowClick = isOrderRow ? `onclick="toggleOrderLineItems(${rowIndex}, '${escapeSQL(row.order_num)}')"` : '';

                return `<tr class="${rowClass}" ${rowClick} data-row-index="${rowIndex}">` +
                    currentDrilldownColumns.map(col => {
                        let value = row[col.key];

                        // Format based on type
                        if (col.type === 'currency') {
                            value = '$' + parseFloat(value || 0).toLocaleString('en-US', {minimumFractionDigits: 2});
                        } else if (col.type === 'number') {
                            value = parseFloat(value || 0).toLocaleString('en-US');
                        } else if (col.type === 'percent') {
                            value = (parseFloat(value || 0) * 100).toFixed(1) + '%';
                        } else if (col.type === 'date') {
                            value = moment(value).format('MMM D, YYYY');
                        }

                        // Color coding for margin
                        let colorClass = '';
                        if (col.key.includes('margin') && col.type === 'percent') {
                            const marginVal = parseFloat(row[col.key] || 0);
                            if (marginVal >= MARGIN_GOOD) colorClass = 'text-green-600 font-semibold';
                            else if (marginVal >= MARGIN_MEDIUM) colorClass = 'text-yellow-600 font-semibold';
                            else colorClass = 'text-red-600 font-semibold';
                        }

                        // Add expand icon for order_num column
                        const expandIcon = col.key === 'order_num' && isOrderRow ?
                            '<svg class="w-4 h-4 inline-block mr-1 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>' : '';

                        return `<td class="px-4 py-3 text-slate-700 ${colorClass}">${expandIcon}${value}</td>`;
                    }).join('') +
                '</tr>';
            }).join('');
        }

        function toggleOrderLineItems(rowIndex, orderNum) {
            const tbody = document.getElementById('drilldownTableBody');
            const existingExpandedRow = tbody.querySelector(`tr[data-expanded-for="${rowIndex}"]`);

            // If already expanded, collapse it
            if (existingExpandedRow) {
                existingExpandedRow.remove();
                return;
            }

            // Fetch line items for this order
            const conditions = buildFilterConditions();
            const query = `
                SELECT
                    Product.Num as product_num,
                    Product.Description as product_desc,
                    PostSoItem.Qty as qty,
                    COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) as unit_price,
                    COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty as line_total,
                    PostSoItem.PostedTotalCost as cost,
                    ((COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty)-PostSoItem.PostedTotalCost)/(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) as margin_percent
                FROM PostSo
                JOIN PostSoItem ON PostSoItem.PostSoId = PostSo.Id
                JOIN SoItem ON SoItem.Id = PostSoItem.SoItemId
                JOIN So ON So.Id = SoItem.SoId
                LEFT JOIN PostSoItem PSI ON PSI.SoItemId = COALESCE((SELECT K.Id FROM SoItem K WHERE K.SoLineItem = SoItem.SoLineItem+1 AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1), (SELECT K.Id FROM SoItem K WHERE K.SoLineItem > SoItem.SoLineItem AND EXISTS (SELECT * FROM SoItem J WHERE J.TypeId = 40 AND J.SoId = K.SoId AND J.SoLineItem >= K.SoLineItem-1 ORDER BY J.SoLineItem ASC) AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1)) AND PSI.PostSoId = PostSo.Id
                LEFT JOIN Product ON Product.Id = SoItem.ProductId
                WHERE So.Num = '${escapeSQL(orderNum)}'
                    AND SoItem.TypeId NOT IN (30,40)
                ORDER BY SoItem.Id ASC
            `;

            console.log('Line Items Query:', query);
            const queryResult = runQuery(query);
            const lineItems = queryResult ? JSON.parse(queryResult) : null;

            if (!lineItems || lineItems.length === 0) {
                alert('No line items found for this order.');
                return;
            }

            // Create expanded row with line items table
            const targetRow = tbody.querySelector(`tr[data-row-index="${rowIndex}"]`);
            const expandedRow = document.createElement('tr');
            expandedRow.setAttribute('data-expanded-for', rowIndex);
            expandedRow.innerHTML = `
                <td colspan="${currentDrilldownColumns.length}" class="px-4 py-2 bg-slate-50 border-t border-b border-slate-200">
                    <div class="pl-8">
                        <div class="text-xs font-semibold text-slate-600 mb-2">Line Items for Order ${orderNum}:</div>
                        <table class="w-full text-xs">
                            <thead>
                                <tr class="text-left text-slate-600">
                                    <th class="py-1">Product #</th>
                                    <th class="py-1">Description</th>
                                    <th class="py-1 text-right">Qty</th>
                                    <th class="py-1 text-right">Unit Price</th>
                                    <th class="py-1 text-right">Line Total</th>
                                    <th class="py-1 text-right">Cost</th>
                                    <th class="py-1 text-right">Margin %</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${lineItems.map(item => `
                                    <tr class="border-t border-slate-200">
                                        <td class="py-1 text-slate-700">${item.product_num || ''}</td>
                                        <td class="py-1 text-slate-700">${item.product_desc || ''}</td>
                                        <td class="py-1 text-right text-slate-700">${parseFloat(item.qty || 0).toLocaleString()}</td>
                                        <td class="py-1 text-right text-slate-700">$${parseFloat(item.unit_price || 0).toFixed(2)}</td>
                                        <td class="py-1 text-right text-slate-700">$${parseFloat(item.line_total || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                                        <td class="py-1 text-right text-slate-700">$${parseFloat(item.cost || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                                        <td class="py-1 text-right ${
                                            parseFloat(item.margin_percent) >= MARGIN_GOOD ? 'text-green-600 font-semibold' :
                                            parseFloat(item.margin_percent) >= MARGIN_MEDIUM ? 'text-yellow-600 font-semibold' :
                                            'text-red-600 font-semibold'
                                        }">${(parseFloat(item.margin_percent || 0) * 100).toFixed(1)}%</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </td>
            `;

            targetRow.insertAdjacentElement('afterend', expandedRow);
        }

        function filterDrilldownTable() {
            const searchValue = document.getElementById('drilldownSearch').value.toLowerCase();

            const filteredData = currentDrilldownData.filter(row =>
                currentDrilldownColumns.some(col =>
                    String(row[col.key] || '').toLowerCase().includes(searchValue)
                )
            );

            renderDrilldownTable(filteredData);
        }

        function sortDrilldownTable(columnIndex) {
            const column = currentDrilldownColumns[columnIndex];

            if (currentSortColumn === columnIndex) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = columnIndex;
                currentSortDirection = 'asc';
            }

            const sorted = [...currentDrilldownData].sort((a, b) => {
                let aVal = a[column.key];
                let bVal = b[column.key];

                // Convert to numbers if applicable
                if (column.type === 'currency' || column.type === 'number' || column.type === 'percent') {
                    aVal = parseFloat(aVal || 0);
                    bVal = parseFloat(bVal || 0);
                } else if (column.type === 'date') {
                    aVal = new Date(aVal);
                    bVal = new Date(bVal);
                }

                if (currentSortDirection === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });

            renderDrilldownTable(sorted);
        }

        function exportDrilldownData() {
            const title = document.getElementById('drilldownTitle').textContent;
            const headers = currentDrilldownColumns.map(col => col.label).join(',');
            const rows = currentDrilldownData.map(row =>
                currentDrilldownColumns.map(col => {
                    let value = row[col.key] || '';
                    // Escape commas and quotes
                    if (String(value).includes(',') || String(value).includes('"')) {
                        value = '"' + String(value).replace(/"/g, '""') + '"';
                    }
                    return value;
                }).join(',')
            ).join('\n');

            const csv = headers + '\n' + rows;
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${title.replace(/\s+/g, '_')}_${moment().format('YYYY-MM-DD')}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ============================================
        // Drill-down Data Functions
        // ============================================
        function drilldownManager(managerName) {
            try {
                debugLog(`Chart clicked: Sales by Manager - "${managerName}"`, 'click');
                const conditions = buildFilterConditions();
                debugLog('Building SQL query for manager customers...', 'info');
                const query = `
                SELECT
                    Customer.Name as customer_name,
                    COUNT(DISTINCT So.Num) as order_count,
                    SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) as total_revenue,
                    SUM(PostSoItem.PostedTotalCost) as total_cost,
                    AVG((((COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty)-PostSoItem.PostedTotalCost)/(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty))) as avg_margin,
                    MAX(PostSo.PostDate) as last_order_date
                FROM PostSo
                JOIN PostSoItem ON PostSoItem.PostSoId = PostSo.Id
                JOIN SoItem ON SoItem.Id = PostSoItem.SoItemId
                JOIN So ON So.Id = SoItem.SoId
                LEFT JOIN SoItem as PSI ON PSI.ParentId = SoItem.Id AND PSI.TypeId = 60
                LEFT JOIN Product ON Product.Id = SoItem.ProductId
                LEFT JOIN ProductTree ON ProductTree.Id = (SELECT ProductToTree.ProductTreeId FROM ProductToTree WHERE ProductToTree.ProductId = Product.Id ORDER BY ProductToTree.Id ASC LIMIT 1)
                LEFT JOIN Customer ON Customer.Id = So.CustomerId
                LEFT JOIN SysUser ON SysUser.Id = Customer.DefaultSalesManId
                LEFT JOIN AccountGroup ON AccountGroup.Id = (SELECT AccountGroupRelation.GroupId FROM AccountGroupRelation WHERE AccountGroupRelation.AccountId = Customer.AccountId ORDER BY AccountGroupRelation.AccountId ASC LIMIT 1)
                ${conditions}
                AND So.salesman = '${escapeSQL(managerName)}'
                GROUP BY Customer.Name
                ORDER BY total_revenue DESC
            `;

            const queryResult = runQuery(query);
            debugLog(`Query result: ${queryResult ? 'received' : 'null'}`, queryResult ? 'success' : 'error');

            const data = queryResult ? JSON.parse(queryResult) : null;
            if (!data || !Array.isArray(data)) {
                debugLog('Query returned no data or invalid data', 'error');
                alert('No data available for this selection. The query may have returned no results.');
                return;
            }
            debugLog(`Query returned ${data.length} customers`, 'success');

            const columns = [
                { key: 'customer_name', label: 'Customer', type: 'string' },
                { key: 'order_count', label: 'Orders', type: 'number' },
                { key: 'total_revenue', label: 'Revenue', type: 'currency' },
                { key: 'avg_margin', label: 'Avg Margin %', type: 'percent' },
                { key: 'last_order_date', label: 'Last Order', type: 'date' }
            ];

                debugLog('Executing query...', 'info');
                openDrilldown(
                    `Customers for ${managerName}`,
                    `Sales by Manager > ${managerName}`,
                    data,
                    columns
                );
            } catch (error) {
                debugLog(`ERROR in drilldownManager: ${error.message}`, 'error');
                debugLog(`Stack: ${error.stack}`, 'error');
            }
        }

        function drilldownCustomer(customerName) {
            try {
                debugLog(`Chart clicked: Top Customers - "${customerName}"`, 'click');
                const conditions = buildFilterConditions();
                debugLog('Building SQL query for customer orders...', 'info');
                const query = `
                    SELECT
                        So.Num as order_num,
                        PostSo.PostDate as order_date,
                        COUNT(DISTINCT SoItem.Id) as item_count,
                        SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) as total_revenue,
                        SUM(PostSoItem.PostedTotalCost) as total_cost,
                        (SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) - SUM(PostSoItem.PostedTotalCost)) / SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) as margin_percent,
                        So.salesman as salesman
                    FROM PostSo
                    JOIN PostSoItem ON PostSoItem.PostSoId = PostSo.Id
                    JOIN SoItem ON SoItem.Id = PostSoItem.SoItemId
                    JOIN So ON So.Id = SoItem.SoId
                    LEFT JOIN PostSoItem PSI ON PSI.SoItemId = COALESCE((SELECT K.Id FROM SoItem K WHERE K.SoLineItem = SoItem.SoLineItem+1 AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1), (SELECT K.Id FROM SoItem K WHERE K.SoLineItem > SoItem.SoLineItem AND EXISTS (SELECT * FROM SoItem J WHERE J.TypeId = 40 AND J.SoId = K.SoId AND J.SoLineItem >= K.SoLineItem-1 ORDER BY J.SoLineItem ASC) AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1)) AND PSI.PostSoId = PostSo.Id
                    LEFT JOIN Product ON Product.Id = SoItem.ProductId
                    LEFT JOIN ProductTree ON ProductTree.Id = (SELECT ProductToTree.ProductTreeId FROM ProductToTree WHERE ProductToTree.ProductId = Product.Id ORDER BY ProductToTree.Id ASC LIMIT 1)
                    LEFT JOIN Customer ON Customer.Id = So.CustomerId
                    LEFT JOIN SysUser ON SysUser.Id = Customer.DefaultSalesManId
                    LEFT JOIN AccountGroup ON AccountGroup.Id = (SELECT AccountGroupRelation.GroupId FROM AccountGroupRelation WHERE AccountGroupRelation.AccountId = Customer.AccountId ORDER BY AccountGroupRelation.AccountId ASC LIMIT 1)
                    ${conditions}
                    AND Customer.Name = '${escapeSQL(customerName)}'
                    GROUP BY So.Num, PostSo.PostDate, So.salesman
                    ORDER BY PostSo.PostDate DESC
                `;

                debugLog('Executing query...', 'info');
                console.log('SQL Query:', query);
                debugLog(`SQL Query: ${query}`, 'info');
                const queryResult = runQuery(query);
                debugLog(`Query result: ${queryResult ? 'received' : 'null'}`, queryResult ? 'success' : 'error');

                const data = queryResult ? JSON.parse(queryResult) : null;
                if (!data || !Array.isArray(data)) {
                    debugLog('Query returned no data or invalid data', 'error');
                    debugLog(`Failed SQL: ${query}`, 'error');
                    alert('No data available for this selection. The query may have returned no results.');
                    return;
                }
                debugLog(`Query returned ${data.length} orders`, 'success');

                const columns = [
                    { key: 'order_num', label: 'Order #', type: 'string' },
                    { key: 'order_date', label: 'Date', type: 'date' },
                    { key: 'item_count', label: 'Items', type: 'number' },
                    { key: 'total_revenue', label: 'Total', type: 'currency' },
                    { key: 'margin_percent', label: 'Margin %', type: 'percent' },
                    { key: 'salesman', label: 'Salesman', type: 'string' }
                ];

                openDrilldown(
                    `Orders for ${customerName}`,
                    `Top Customers > ${customerName}`,
                    data,
                    columns
                );
            } catch (error) {
                debugLog(`ERROR in drilldownCustomer: ${error.message}`, 'error');
                debugLog(`Stack: ${error.stack}`, 'error');
            }
        }

        function drilldownCategory(categoryName) {
            try {
                debugLog(`Chart clicked: Product Categories - "${categoryName}"`, 'click');
                const conditions = buildFilterConditions();
                debugLog('Building SQL query for category products...', 'info');

                // Handle "No Category" specially - it represents null/blank categories
                const categoryCondition = categoryName === 'No Category'
                    ? `AND (ProductTree.Name IS NULL OR ProductTree.Name = '')`
                    : `AND ProductTree.Name = '${escapeSQL(categoryName)}'`;

                const query = `
                SELECT
                    Product.Num as product_num,
                    Product.Description as product_name,
                    SUM(PostSoItem.Qty) as units_sold,
                    SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) as total_revenue,
                    AVG(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty)) as avg_price,
                    AVG((((COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty)-PostSoItem.PostedTotalCost)/(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty))) as avg_margin
                FROM PostSo
                JOIN PostSoItem ON PostSoItem.PostSoId = PostSo.Id
                JOIN SoItem ON SoItem.Id = PostSoItem.SoItemId
                JOIN So ON So.Id = SoItem.SoId
                LEFT JOIN PostSoItem PSI ON PSI.SoItemId = COALESCE((SELECT K.Id FROM SoItem K WHERE K.SoLineItem = SoItem.SoLineItem+1 AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1), (SELECT K.Id FROM SoItem K WHERE K.SoLineItem > SoItem.SoLineItem AND EXISTS (SELECT * FROM SoItem J WHERE J.TypeId = 40 AND J.SoId = K.SoId AND J.SoLineItem >= K.SoLineItem-1 ORDER BY J.SoLineItem ASC) AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1)) AND PSI.PostSoId = PostSo.Id
                LEFT JOIN Product ON Product.Id = SoItem.ProductId
                LEFT JOIN ProductTree ON ProductTree.Id = (SELECT ProductToTree.ProductTreeId FROM ProductToTree WHERE ProductToTree.ProductId = Product.Id ORDER BY ProductToTree.Id ASC LIMIT 1)
                LEFT JOIN Customer ON Customer.Id = So.CustomerId
                LEFT JOIN SysUser ON SysUser.Id = Customer.DefaultSalesManId
                LEFT JOIN AccountGroup ON AccountGroup.Id = (SELECT AccountGroupRelation.GroupId FROM AccountGroupRelation WHERE AccountGroupRelation.AccountId = Customer.AccountId ORDER BY AccountGroupRelation.AccountId ASC LIMIT 1)
                ${conditions}
                ${categoryCondition}
                GROUP BY Product.Num, Product.Description
                ORDER BY total_revenue DESC
            `;

            debugLog('Executing query...', 'info');
            console.log('SQL Query:', query);
            debugLog(`SQL Query: ${query}`, 'info');
            const queryResult = runQuery(query);
            debugLog(`Query result: ${queryResult ? 'received' : 'null'}`, queryResult ? 'success' : 'error');

            const data = queryResult ? JSON.parse(queryResult) : null;
            if (!data || !Array.isArray(data)) {
                debugLog('Query returned no data or invalid data', 'error');
                debugLog(`Failed SQL: ${query}`, 'error');
                alert('No data available for this selection. The query may have returned no results.');
                return;
            }
            debugLog(`Query returned ${data.length} products`, 'success');

            const columns = [
                { key: 'product_num', label: 'Product #', type: 'string' },
                { key: 'product_name', label: 'Product Name', type: 'string' },
                { key: 'units_sold', label: 'Units Sold', type: 'number' },
                { key: 'total_revenue', label: 'Revenue', type: 'currency' },
                { key: 'avg_price', label: 'Avg Price', type: 'currency' },
                { key: 'avg_margin', label: 'Avg Margin %', type: 'percent' }
            ];

                debugLog('Executing query...', 'info');
                openDrilldown(
                    `Products in ${categoryName}`,
                    `Product Tree > ${categoryName}`,
                    data,
                    columns
                );
            } catch (error) {
                debugLog(`ERROR in drilldownCategory: ${error.message}`, 'error');
                debugLog(`Stack: ${error.stack}`, 'error');
            }
        }

        function drilldownMonth(month) {
            try {
                debugLog(`Chart clicked: Monthly Sales - "${moment(month).format('MMM YYYY')}"`, 'click');
                const conditions = buildFilterConditions();
                debugLog('Building SQL query for month customers...', 'info');
                const query = `
                SELECT
                    Customer.Name as customer_name,
                    COUNT(DISTINCT So.Num) as order_count,
                    SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) as total_revenue,
                    AVG((((COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty)-PostSoItem.PostedTotalCost)/(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty))) as avg_margin
                FROM PostSo
                JOIN PostSoItem ON PostSoItem.PostSoId = PostSo.Id
                JOIN SoItem ON SoItem.Id = PostSoItem.SoItemId
                JOIN So ON So.Id = SoItem.SoId
                LEFT JOIN SoItem as PSI ON PSI.ParentId = SoItem.Id AND PSI.TypeId = 60
                LEFT JOIN Product ON Product.Id = SoItem.ProductId
                LEFT JOIN ProductTree ON ProductTree.Id = (SELECT ProductToTree.ProductTreeId FROM ProductToTree WHERE ProductToTree.ProductId = Product.Id ORDER BY ProductToTree.Id ASC LIMIT 1)
                LEFT JOIN Customer ON Customer.Id = So.CustomerId
                LEFT JOIN SysUser ON SysUser.Id = Customer.DefaultSalesManId
                LEFT JOIN AccountGroup ON AccountGroup.Id = (SELECT AccountGroupRelation.GroupId FROM AccountGroupRelation WHERE AccountGroupRelation.AccountId = Customer.AccountId ORDER BY AccountGroupRelation.AccountId ASC LIMIT 1)
                ${conditions}
                AND DATE_FORMAT(PostSo.PostDate, '%Y-%m-01') = '${escapeSQL(month)}'
                GROUP BY Customer.Name
                ORDER BY total_revenue DESC
                LIMIT 20
            `;

            const queryResult = runQuery(query);
            debugLog(`Query result: ${queryResult ? 'received' : 'null'}`, queryResult ? 'success' : 'error');

            const data = queryResult ? JSON.parse(queryResult) : null;
            if (!data || !Array.isArray(data)) {
                debugLog('Query returned no data or invalid data', 'error');
                alert('No data available for this selection. The query may have returned no results.');
                return;
            }
            debugLog(`Query returned ${data.length} customers`, 'success');

            const columns = [
                { key: 'customer_name', label: 'Customer', type: 'string' },
                { key: 'order_count', label: 'Orders', type: 'number' },
                { key: 'total_revenue', label: 'Revenue', type: 'currency' },
                { key: 'avg_margin', label: 'Avg Margin %', type: 'percent' }
            ];

                debugLog('Executing query...', 'info');
                openDrilldown(
                    `Top Customers for ${moment(month).format('MMMM YYYY')}`,
                    `Monthly Sales > ${moment(month).format('MMM YYYY')}`,
                    data,
                    columns
                );
            } catch (error) {
                debugLog(`ERROR in drilldownMonth: ${error.message}`, 'error');
                debugLog(`Stack: ${error.stack}`, 'error');
            }
        }

        function drilldownSalesperson(salesmanName) {
            try {
                debugLog(`Chart clicked: Top Sales People - "${salesmanName}"`, 'click');
                const conditions = buildFilterConditions();
                debugLog('Building SQL query for salesperson orders...', 'info');
                const query = `
                    SELECT
                        So.Num as order_num,
                        PostSo.PostDate as order_date,
                        Customer.Name as customer_name,
                        COUNT(DISTINCT SoItem.Id) as item_count,
                        SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) as total_revenue,
                        SUM(PostSoItem.PostedTotalCost) as total_cost,
                        (SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) - SUM(PostSoItem.PostedTotalCost)) / SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) as margin_percent
                    FROM PostSo
                    JOIN PostSoItem ON PostSoItem.PostSoId = PostSo.Id
                    JOIN SoItem ON SoItem.Id = PostSoItem.SoItemId
                    JOIN So ON So.Id = SoItem.SoId
                    LEFT JOIN PostSoItem PSI ON PSI.SoItemId = COALESCE((SELECT K.Id FROM SoItem K WHERE K.SoLineItem = SoItem.SoLineItem+1 AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1), (SELECT K.Id FROM SoItem K WHERE K.SoLineItem > SoItem.SoLineItem AND EXISTS (SELECT * FROM SoItem J WHERE J.TypeId = 40 AND J.SoId = K.SoId AND J.SoLineItem >= K.SoLineItem-1 ORDER BY J.SoLineItem ASC) AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1)) AND PSI.PostSoId = PostSo.Id
                    LEFT JOIN Product ON Product.Id = SoItem.ProductId
                    LEFT JOIN ProductTree ON ProductTree.Id = (SELECT ProductToTree.ProductTreeId FROM ProductToTree WHERE ProductToTree.ProductId = Product.Id ORDER BY ProductToTree.Id ASC LIMIT 1)
                    LEFT JOIN Customer ON Customer.Id = So.CustomerId
                    LEFT JOIN SysUser ON SysUser.Id = Customer.DefaultSalesManId
                    LEFT JOIN AccountGroup ON AccountGroup.Id = (SELECT AccountGroupRelation.GroupId FROM AccountGroupRelation WHERE AccountGroupRelation.AccountId = Customer.AccountId ORDER BY AccountGroupRelation.AccountId ASC LIMIT 1)
                    LEFT JOIN SysUser AS SalesUser ON SalesUser.userName = So.salesman
                    ${conditions}
                    AND COALESCE(CONCAT(SalesUser.FirstName, ' ', SalesUser.LastName), So.salesman) = '${escapeSQL(salesmanName)}'
                    GROUP BY So.Num, PostSo.PostDate, Customer.Name
                    ORDER BY PostSo.PostDate DESC
                `;

                debugLog('Executing query...', 'info');
                console.log('SQL Query:', query);
                debugLog(`SQL Query: ${query}`, 'info');
                const queryResult = runQuery(query);
                debugLog(`Query result: ${queryResult ? 'received' : 'null'}`, queryResult ? 'success' : 'error');

                const data = queryResult ? JSON.parse(queryResult) : null;
                if (!data || !Array.isArray(data)) {
                    debugLog('Query returned no data or invalid data', 'error');
                    debugLog(`Failed SQL: ${query}`, 'error');
                    alert('No data available for this selection. The query may have returned no results.');
                    return;
                }
                debugLog(`Query returned ${data.length} orders`, 'success');

                const columns = [
                    { key: 'order_num', label: 'Order #', type: 'string' },
                    { key: 'order_date', label: 'Date', type: 'date' },
                    { key: 'customer_name', label: 'Customer', type: 'string' },
                    { key: 'item_count', label: 'Items', type: 'number' },
                    { key: 'total_revenue', label: 'Total', type: 'currency' },
                    { key: 'margin_percent', label: 'Margin %', type: 'percent' }
                ];

                openDrilldown(
                    `Orders for ${salesmanName}`,
                    `Top Sales People > ${salesmanName}`,
                    data,
                    columns
                );
            } catch (error) {
                debugLog(`ERROR in drilldownSalesperson: ${error.message}`, 'error');
                debugLog(`Stack: ${error.stack}`, 'error');
            }
        }

        function drilldownCustomerGroup(groupName) {
            try {
                debugLog(`Chart clicked: Customer Groups - "${groupName}"`, 'click');
                const conditions = buildFilterConditions();
                debugLog('Building SQL query for customer group orders...', 'info');

                // Handle "No Group" specially - it represents null/blank groups
                const groupCondition = groupName === 'No Group'
                    ? `AND (AccountGroup.Name IS NULL OR AccountGroup.Name = '')`
                    : `AND AccountGroup.Name = '${escapeSQL(groupName)}'`;

                const query = `
                    SELECT
                        So.Num as order_num,
                        PostSo.PostDate as order_date,
                        Customer.Name as customer_name,
                        COUNT(DISTINCT SoItem.Id) as item_count,
                        SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) as total_revenue,
                        SUM(PostSoItem.PostedTotalCost) as total_cost,
                        (SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) - SUM(PostSoItem.PostedTotalCost)) / SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) as margin_percent,
                        So.salesman as salesman
                    FROM PostSo
                    JOIN PostSoItem ON PostSoItem.PostSoId = PostSo.Id
                    JOIN SoItem ON SoItem.Id = PostSoItem.SoItemId
                    JOIN So ON So.Id = SoItem.SoId
                    LEFT JOIN PostSoItem PSI ON PSI.SoItemId = COALESCE((SELECT K.Id FROM SoItem K WHERE K.SoLineItem = SoItem.SoLineItem+1 AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1), (SELECT K.Id FROM SoItem K WHERE K.SoLineItem > SoItem.SoLineItem AND EXISTS (SELECT * FROM SoItem J WHERE J.TypeId = 40 AND J.SoId = K.SoId AND J.SoLineItem >= K.SoLineItem-1 ORDER BY J.SoLineItem ASC) AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1)) AND PSI.PostSoId = PostSo.Id
                    LEFT JOIN Product ON Product.Id = SoItem.ProductId
                    LEFT JOIN ProductTree ON ProductTree.Id = (SELECT ProductToTree.ProductTreeId FROM ProductToTree WHERE ProductToTree.ProductId = Product.Id ORDER BY ProductToTree.Id ASC LIMIT 1)
                    LEFT JOIN Customer ON Customer.Id = So.CustomerId
                    LEFT JOIN SysUser ON SysUser.Id = Customer.DefaultSalesManId
                    LEFT JOIN AccountGroup ON AccountGroup.Id = (SELECT AccountGroupRelation.GroupId FROM AccountGroupRelation WHERE AccountGroupRelation.AccountId = Customer.AccountId ORDER BY AccountGroupRelation.AccountId ASC LIMIT 1)
                    ${conditions}
                    ${groupCondition}
                    GROUP BY So.Num, PostSo.PostDate, Customer.Name, So.salesman
                    ORDER BY PostSo.PostDate DESC
                `;

                debugLog('Executing query...', 'info');
                console.log('SQL Query:', query);
                debugLog(`SQL Query: ${query}`, 'info');
                const queryResult = runQuery(query);
                debugLog(`Query result: ${queryResult ? 'received' : 'null'}`, queryResult ? 'success' : 'error');

                const data = queryResult ? JSON.parse(queryResult) : null;
                if (!data || !Array.isArray(data)) {
                    debugLog('Query returned no data or invalid data', 'error');
                    debugLog(`Failed SQL: ${query}`, 'error');
                    alert('No data available for this selection. The query may have returned no results.');
                    return;
                }
                debugLog(`Query returned ${data.length} orders`, 'success');

                const columns = [
                    { key: 'order_num', label: 'Order #', type: 'string' },
                    { key: 'order_date', label: 'Date', type: 'date' },
                    { key: 'customer_name', label: 'Customer', type: 'string' },
                    { key: 'item_count', label: 'Items', type: 'number' },
                    { key: 'total_revenue', label: 'Total', type: 'currency' },
                    { key: 'margin_percent', label: 'Margin %', type: 'percent' },
                    { key: 'salesman', label: 'Salesman', type: 'string' }
                ];

                openDrilldown(
                    `Orders for ${groupName}`,
                    `Customer Groups > ${groupName}`,
                    data,
                    columns
                );
            } catch (error) {
                debugLog(`ERROR in drilldownCustomerGroup: ${error.message}`, 'error');
                debugLog(`Stack: ${error.stack}`, 'error');
            }
        }

        function drilldownProduct(productNum, productDesc) {
            try {
                debugLog(`Chart clicked: Top Products - "${productNum} - ${productDesc}"`, 'click');
                const conditions = buildFilterConditions();
                debugLog('Building SQL query for product orders...', 'info');
                const query = `
                    SELECT
                        So.Num as order_num,
                        PostSo.PostDate as order_date,
                        Customer.Name as customer_name,
                        SUM(PostSoItem.Qty) as qty,
                        SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) as line_total,
                        AVG(((COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty)-PostSoItem.PostedTotalCost)/(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty)) as margin_percent,
                        So.salesman as salesman
                    FROM PostSo
                    JOIN PostSoItem ON PostSoItem.PostSoId = PostSo.Id
                    JOIN SoItem ON SoItem.Id = PostSoItem.SoItemId
                    JOIN So ON So.Id = SoItem.SoId
                    LEFT JOIN PostSoItem PSI ON PSI.SoItemId = COALESCE((SELECT K.Id FROM SoItem K WHERE K.SoLineItem = SoItem.SoLineItem+1 AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1), (SELECT K.Id FROM SoItem K WHERE K.SoLineItem > SoItem.SoLineItem AND EXISTS (SELECT * FROM SoItem J WHERE J.TypeId = 40 AND J.SoId = K.SoId AND J.SoLineItem >= K.SoLineItem-1 ORDER BY J.SoLineItem ASC) AND K.TypeId = 30 AND SoItem.TypeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1)) AND PSI.PostSoId = PostSo.Id
                    LEFT JOIN Product ON Product.Id = SoItem.ProductId
                    LEFT JOIN ProductTree ON ProductTree.Id = (SELECT ProductToTree.ProductTreeId FROM ProductToTree WHERE ProductToTree.ProductId = Product.Id ORDER BY ProductToTree.Id ASC LIMIT 1)
                    LEFT JOIN Customer ON Customer.Id = So.CustomerId
                    LEFT JOIN SysUser ON SysUser.Id = Customer.DefaultSalesManId
                    LEFT JOIN AccountGroup ON AccountGroup.Id = (SELECT AccountGroupRelation.GroupId FROM AccountGroupRelation WHERE AccountGroupRelation.AccountId = Customer.AccountId ORDER BY AccountGroupRelation.AccountId ASC LIMIT 1)
                    ${conditions}
                    AND Product.Num = '${escapeSQL(productNum)}'
                    AND SoItem.TypeId NOT IN (30,40)
                    GROUP BY So.Num, PostSo.PostDate, Customer.Name, So.salesman
                    ORDER BY PostSo.PostDate DESC
                `;

                debugLog('Executing query...', 'info');
                console.log('SQL Query:', query);
                debugLog(`SQL Query: ${query}`, 'info');
                const queryResult = runQuery(query);
                debugLog(`Query result: ${queryResult ? 'received' : 'null'}`, queryResult ? 'success' : 'error');

                const data = queryResult ? JSON.parse(queryResult) : null;
                if (!data || !Array.isArray(data)) {
                    debugLog('Query returned no data or invalid data', 'error');
                    debugLog(`Failed SQL: ${query}`, 'error');
                    alert('No data available for this selection. The query may have returned no results.');
                    return;
                }
                debugLog(`Query returned ${data.length} orders with this product`, 'success');

                const columns = [
                    { key: 'order_num', label: 'Order #', type: 'string' },
                    { key: 'order_date', label: 'Date', type: 'date' },
                    { key: 'customer_name', label: 'Customer', type: 'string' },
                    { key: 'qty', label: 'Qty', type: 'number' },
                    { key: 'line_total', label: 'Line Total', type: 'currency' },
                    { key: 'margin_percent', label: 'Margin %', type: 'percent' },
                    { key: 'salesman', label: 'Salesman', type: 'string' }
                ];

                openDrilldown(
                    `Orders containing ${productNum} - ${productDesc}`,
                    `Top Products > ${productNum}`,
                    data,
                    columns
                );
            } catch (error) {
                debugLog(`ERROR in drilldownProduct: ${error.message}`, 'error');
                debugLog(`Stack: ${error.stack}`, 'error');
            }
        }

        // ============================================
        // New Metrics Drill-down Functions
        // ============================================

        function drilldownLowMargin() {
            try {
                debugLog('Drill-down: Low Margin Sales', 'click');
                const data = getLowMarginSales();

                const columns = [
                    { key: 'order_num', label: 'Order #' },
                    { key: 'order_date', label: 'Date', format: (v) => moment(v).format('MM/DD/YYYY') },
                    { key: 'customer_name', label: 'Customer' },
                    { key: 'order_total', label: 'Total', format: (v) => '$' + parseFloat(v).toLocaleString('en-US', {minimumFractionDigits: 2}) },
                    { key: 'margin_percent', label: 'Margin %', format: (v) => (parseFloat(v) * 100).toFixed(1) + '%' },
                    { key: 'salesman', label: 'Salesperson' }
                ];

                showDrilldownModal(
                    'Low Margin Sales (< 15%)',
                    data,
                    columns
                );
            } catch (error) {
                debugLog(`ERROR in drilldownLowMargin: ${error.message}`, 'error');
            }
        }

        function drilldownNegativeMargin() {
            try {
                debugLog('Drill-down: Negative Margin Orders', 'click');
                const data = getNegativeMarginOrders();

                const columns = [
                    { key: 'order_num', label: 'Order #' },
                    { key: 'order_date', label: 'Date', format: (v) => moment(v).format('MM/DD/YYYY') },
                    { key: 'customer_name', label: 'Customer' },
                    { key: 'order_total', label: 'Total', format: (v) => '$' + parseFloat(v).toLocaleString('en-US', {minimumFractionDigits: 2}) },
                    { key: 'margin_percent', label: 'Margin %', format: (v) => (parseFloat(v) * 100).toFixed(1) + '%' },
                    { key: 'salesman', label: 'Salesperson' }
                ];

                showDrilldownModal(
                    'Negative Margin Orders',
                    data,
                    columns
                );
            } catch (error) {
                debugLog(`ERROR in drilldownNegativeMargin: ${error.message}`, 'error');
            }
        }

        function drilldownHighValue() {
            try {
                debugLog('Drill-down: High Value Orders', 'click');
                const data = getHighValueOrders();

                const columns = [
                    { key: 'order_num', label: 'Order #' },
                    { key: 'order_date', label: 'Date', format: (v) => moment(v).format('MM/DD/YYYY') },
                    { key: 'customer_name', label: 'Customer' },
                    { key: 'order_total', label: 'Total', format: (v) => '$' + parseFloat(v).toLocaleString('en-US', {minimumFractionDigits: 2}) },
                    { key: 'margin_percent', label: 'Margin %', format: (v) => (parseFloat(v) * 100).toFixed(1) + '%' },
                    { key: 'salesman', label: 'Salesperson' }
                ];

                showDrilldownModal(
                    'High Value Orders (> $10k)',
                    data,
                    columns
                );
            } catch (error) {
                debugLog(`ERROR in drilldownHighValue: ${error.message}`, 'error');
            }
        }

        function drilldownNewRepeat(customerType) {
            try {
                debugLog(`Drill-down: ${customerType} Customers`, 'click');
                const conditions = buildFilterConditions();
                const { start, end } = getDateRange();

                const query = `
                    SELECT
                        Customer.Id as customer_id,
                        Customer.Name as customer_name,
                        MIN(PostSo.PostDate) as first_order_date,
                        COUNT(DISTINCT So.Id) as order_count,
                        SUM(So.TotalPrice) as total_revenue,
                        MAX(PostSo.PostDate) as last_order_date
                    FROM PostSo
                    JOIN So ON So.Id = PostSo.SoId
                    JOIN Customer ON Customer.Id = So.CustomerId
                    LEFT JOIN AccountGroup ON AccountGroup.Id = (
                        SELECT AccountGroupRelation.GroupId
                        FROM AccountGroupRelation
                        WHERE AccountGroupRelation.AccountId = Customer.AccountId
                        ORDER BY AccountGroupRelation.AccountId ASC
                        LIMIT 1
                    )
                    ${conditions}
                    GROUP BY Customer.Id, Customer.Name
                `;

                const customers = JSON.parse(runQuery(query));

                // Filter by customer type
                const filteredData = customers.filter(c => {
                    const firstOrderDate = moment(c.first_order_date);
                    const periodStart = moment(start);
                    const isNew = firstOrderDate >= periodStart;
                    return customerType === 'New' ? isNew : !isNew;
                });

                const columns = [
                    { key: 'customer_name', label: 'Customer' },
                    { key: 'first_order_date', label: 'First Order', format: (v) => moment(v).format('MM/DD/YYYY') },
                    { key: 'last_order_date', label: 'Last Order', format: (v) => moment(v).format('MM/DD/YYYY') },
                    { key: 'order_count', label: 'Orders' },
                    { key: 'total_revenue', label: 'Revenue', format: (v) => '$' + parseFloat(v).toLocaleString('en-US', {minimumFractionDigits: 2}) }
                ];

                showDrilldownModal(
                    `${customerType} Customers`,
                    filteredData,
                    columns
                );
            } catch (error) {
                debugLog(`ERROR in drilldownNewRepeat: ${error.message}`, 'error');
            }
        }

        function drilldownInactiveCustomers() {
            try {
                debugLog('Drill-down: Inactive Customers', 'click');
                const data = getInactiveCustomers();

                const columns = [
                    { key: 'customer_name', label: 'Customer' },
                    { key: 'last_order_date', label: 'Last Order', format: (v) => moment(v).format('MM/DD/YYYY') },
                    { key: 'days_since_order', label: 'Days Inactive' },
                    { key: 'total_orders', label: 'Total Orders' },
                    { key: 'lifetime_revenue', label: 'Lifetime Revenue', format: (v) => '$' + parseFloat(v).toLocaleString('en-US', {minimumFractionDigits: 2}) }
                ];

                showDrilldownModal(
                    'Inactive Customers (90+ Days)',
                    data,
                    columns
                );
            } catch (error) {
                debugLog(`ERROR in drilldownInactiveCustomers: ${error.message}`, 'error');
            }
        }

        // ============================================
        // Data Loading and Refresh
        // ============================================
        function loadDashboard() {
            debugLog('Loading dashboard data...', 'info');
            const loading = document.getElementById('loadingOverlay');
            loading.style.display = 'flex';

            try {
                // Load KPIs
                const kpiData = getKPIMetrics();
                updateKPIs(kpiData);

                // Load charts
                const revenueData = getSalesRevenueOverTime();
                renderRevenueChart(revenueData);

                const customersData = getTopCustomers();
                renderCustomersChart(customersData);

                const categoryData = getSalesByCategory();
                renderCategoryChart(categoryData);

                const salespeopleData = getTopSalespeople();
                renderSalespeopleChart(salespeopleData);

                const groupData = getSalesByGroup();
                renderGroupChart(groupData);

                const productsData = getTopProducts();
                renderProductsChart(productsData);

                // Load new metrics
                const lowMarginData = getLowMarginSales();
                renderLowMarginChart(lowMarginData);

                const negativeMarginData = getNegativeMarginOrders();
                renderNegativeMarginChart(negativeMarginData);

                const highValueData = getHighValueOrders();
                renderHighValueChart(highValueData);

                const aovData = getAverageOrderValue();
                renderAverageOrderValue(aovData);

                const newRepeatData = getNewVsRepeatCustomers();
                renderNewVsRepeatChart(newRepeatData);

                const topMarginCustomersData = getTopCustomersByMargin();
                renderTopMarginCustomersChart(topMarginCustomersData);

                const inactiveCustomersData = getInactiveCustomers();
                renderInactiveCustomersChart(inactiveCustomersData);

                const productMixData = getProductMixAnalysis();
                renderProductMixChart(productMixData);

                const slowMovingData = getSlowMovingInventory();
                renderSlowMovingChart(slowMovingData);

                const ordersPerSalespersonData = getOrdersPerSalesperson();
                renderOrdersPerSalespersonChart(ordersPerSalespersonData);

                const avgDaysData = getAvgDaysToShip();
                renderAvgDaysToShip(avgDaysData);

            } catch (error) {
                console.error('Error loading dashboard:', error);
                alert('Error loading sales data. Please check console for details.');
            } finally {
                loading.style.display = 'none';
            }
        }

        function exportToCSV() {
            try {
                const kpiData = getKPIMetrics();
                const customersData = getTopCustomers();
                const productsData = getTopProducts();

                // Build CSV header
                let csv = 'Sales Dashboard Export - ' + moment().format('YYYY-MM-DD HH:mm:ss') + '\n\n';

                // KPI Summary
                csv += 'Key Metrics\n';
                csv += 'Metric,Value\n';
                if (kpiData && kpiData.length > 0) {
                    const metrics = kpiData[0];
                    csv += `Total Revenue,$${parseFloat(metrics.total_revenue || 0).toFixed(2)}\n`;
                    csv += `Total Orders,${metrics.order_count || 0}\n`;
                    csv += `Average Order Value,$${(parseFloat(metrics.total_revenue || 0) / (metrics.order_count || 1)).toFixed(2)}\n`;
                    csv += `Average Margin,${(parseFloat(metrics.avg_margin || 0) * 100).toFixed(1)}%\n`;
                    csv += `Low Margin Orders,${metrics.low_margin_orders || 0}\n`;
                }

                csv += '\n\nTop 10 Customers by Revenue\n';
                csv += 'Customer Name,Revenue,Orders,Average Margin\n';
                customersData.forEach(customer => {
                    csv += `"${(customer.customer_name || '').replace(/"/g, '""')}",`;
                    csv += `${parseFloat(customer.total_revenue).toFixed(2)},`;
                    csv += `${customer.order_count},`;
                    csv += `${(parseFloat(customer.avg_margin) * 100).toFixed(1)}%\n`;
                });

                csv += '\n\nTop 10 Products by Quantity\n';
                csv += 'Product Number,Description,Quantity,Revenue\n';
                productsData.forEach(product => {
                    csv += `"${product.product_num}","${(product.product_desc || '').replace(/"/g, '""')}",`;
                    csv += `${parseFloat(product.total_qty).toFixed(2)},`;
                    csv += `${parseFloat(product.total_revenue).toFixed(2)}\n`;
                });

                // Create download link
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);

                link.setAttribute('href', url);
                link.setAttribute('download', 'Sales_Dashboard_' + moment().format('YYYY-MM-DD_HHmmss') + '.csv');
                link.style.visibility = 'hidden';

                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                console.log('CSV export completed successfully');
            } catch (error) {
                console.error('Error exporting CSV:', error);
                alert('Error exporting CSV. Please check console for details.');
            }
        }

        // ============================================
        // Event Listeners
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('Sales Dashboard initialized', 'success');
            debugLog('Click any chart element to drill down', 'info');

            // Set default date range to Current Financial Year
            const fyDates = getFYDates(0);
            customStartDate = fyDates.start;
            customEndDate = fyDates.end;
            document.getElementById('dateRangeFilter').value = 'current_fy';
            document.getElementById('customStartDate').value = fyDates.start;
            document.getElementById('customEndDate').value = fyDates.end;

            loadFilters();
            loadDashboard();

            // Window resize handler
            let resizeTimeout;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(loadDashboard, 250);
            });
        });
    </script>
</body>
</html>
