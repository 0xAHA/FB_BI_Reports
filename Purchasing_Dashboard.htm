<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchasing Dashboard - Fishbowl Advanced</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- D3.js v7 -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- Moment.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        /* Custom Brand Colors */
        :root {
            --color-primary: #2d9cdb;
            --color-primary-dark: #1e7bb4;
            --color-sidebar: #06162d;
            --color-sidebar-hover: #0a1f3d;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Override Tailwind indigo with custom blue */
        .bg-indigo-600 { background-color: var(--color-primary) !important; }
        .bg-indigo-50 { background-color: rgba(45, 156, 219, 0.1) !important; }
        .text-indigo-600 { color: var(--color-primary) !important; }
        .text-indigo-700 { color: var(--color-primary-dark) !important; }
        .border-indigo-200 { border-color: rgba(45, 156, 219, 0.3) !important; }
        .border-indigo-300 { border-color: rgba(45, 156, 219, 0.4) !important; }
        .hover\:text-indigo-600:hover { color: var(--color-primary) !important; }
        .hover\:bg-indigo-50:hover { background-color: rgba(45, 156, 219, 0.1) !important; }
        .hover\:bg-indigo-100:hover { background-color: rgba(45, 156, 219, 0.15) !important; }
        .focus\:ring-indigo-100:focus { --tw-ring-color: rgba(45, 156, 219, 0.2) !important; }
        .focus\:ring-indigo-500:focus { --tw-ring-color: var(--color-primary) !important; }
        .focus\:border-indigo-300:focus { border-color: rgba(45, 156, 219, 0.4) !important; }

        /* D3 Chart Styles */
        .axis line, .axis path {
            stroke: #cbd5e1;
            shape-rendering: crispEdges;
        }

        .axis text {
            fill: #64748b;
            font-size: 11px;
            font-weight: 500;
        }

        .grid line {
            stroke: #e2e8f0;
            stroke-opacity: 0.7;
            shape-rendering: crispEdges;
        }

        .line {
            fill: none;
            stroke-width: 2.5px;
        }

        .area {
            opacity: 0.3;
        }

        .tooltip {
            position: absolute;
            background: rgba(15, 23, 42, 0.95);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            max-width: 300px;
        }

        .tooltip-label {
            color: #94a3b8;
            display: inline-block;
            min-width: 90px;
            font-weight: 500;
        }

        .tooltip-value {
            color: #ffffff;
            font-weight: 600;
            margin-left: 8px;
        }

        /* Loading spinner */
        .spinner {
            border: 3px solid #f1f5f9;
            border-top: 3px solid var(--color-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Status color coding */
        .status-issued { fill: #3b82f6; }
        .status-partial { fill: #f59e0b; }
        .status-fulfilled { fill: #10b981; }
        .status-overdue { fill: #ef4444; }

        /* Order link styling */
        .order-link {
            color: var(--color-primary);
            text-decoration: none;
            font-weight: 600;
            transition: color 0.2s ease;
        }

        .order-link:hover {
            color: var(--color-primary-dark);
            text-decoration: underline;
        }
    </style>
</head>
<body class="bg-slate-50">
    <div class="flex flex-col h-screen">
        <!-- Header -->
        <header class="h-20 bg-white border-b border-slate-200 px-8 flex items-center justify-between flex-shrink-0 z-20 shadow-sm">
            <div class="flex items-center gap-6">
                <div>
                    <h1 class="text-xl font-bold text-slate-900">
                        Purchasing Dashboard
                        <span id="dateRangeDisplay" class="text-sm font-normal text-slate-500 ml-2"></span>
                    </h1>
                    <p class="text-xs text-slate-500 mt-0.5">Purchase orders, vendor performance, and spend analytics</p>
                </div>

                <!-- KPI Summary in Header -->
                <div id="kpiCards" class="hidden lg:flex items-center gap-3">
                    <!-- Will be populated dynamically -->
                </div>
            </div>

            <div class="flex items-center gap-3">
                <!-- Export Button -->
                <button onclick="exportToCSV()" class="px-3 py-2 bg-slate-100 hover:bg-slate-200 border border-slate-300 rounded-lg text-sm font-medium transition-colors" title="Export CSV">
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Export
                </button>

                <!-- Refresh Button -->
                <button onclick="loadDashboard()" class="p-2.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-xl transition-all" title="Refresh Data">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                </button>
            </div>
        </header>

        <!-- Content Area -->
        <div class="flex-1 overflow-y-auto custom-scrollbar p-4 lg:p-8">
            <!-- Filters Section -->
            <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-4 mb-4">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-base font-bold text-slate-800 flex items-center gap-2">
                        <svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                        </svg>
                        <span>Filters</span>
                        <button onclick="clearAllFilters()" class="ml-2 px-2 py-1 text-xs text-slate-500 hover:text-red-600 hover:bg-red-50 rounded transition-colors flex items-center gap-1" title="Clear All Filters">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            Clear
                        </button>
                    </h3>

                    <!-- Date Range Selector -->
                    <div class="flex items-center gap-1 bg-slate-50 px-2 py-1.5 rounded-lg border border-slate-200">
                        <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <select id="dateRangeFilter" onchange="applyDateRange()" class="px-2 py-0.5 text-xs border-0 bg-transparent focus:ring-0 focus:outline-none text-slate-700 font-semibold" style="width: 180px;">
                            <option value="30">Last 30 Days</option>
                            <option value="60">Last 60 Days</option>
                            <option value="90">Last 90 Days</option>
                            <option value="180">Last 180 Days</option>
                            <option value="365">Last Year</option>
                            <option value="this_quarter">This Quarter</option>
                            <option value="last_quarter">Last Quarter</option>
                            <option value="current_fy" selected>Current Financial Year</option>
                            <option value="last_fy">Last Financial Year</option>
                            <option value="custom">Custom Date Range</option>
                        </select>
                    </div>
                </div>

                <!-- Filter Controls -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
                    <!-- Vendor Filter -->
                    <div>
                        <label class="block text-[11px] font-semibold text-slate-600 mb-1.5">Vendor</label>
                        <select id="vendorFilter" onchange="loadDashboard()" class="w-full px-2.5 py-1.5 text-xs border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300">
                            <option value="%">All Vendors</option>
                        </select>
                    </div>

                    <!-- Product Category Filter -->
                    <div>
                        <label class="block text-[11px] font-semibold text-slate-600 mb-1.5">Product Category</label>
                        <select id="productCategoryFilter" onchange="loadDashboard()" class="w-full px-2.5 py-1.5 text-xs border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300">
                            <option value="%">All Categories</option>
                        </select>
                    </div>

                    <!-- ABC Code Filter -->
                    <div>
                        <label class="block text-[11px] font-semibold text-slate-600 mb-1.5">ABC Code</label>
                        <select id="abcCodeFilter" onchange="loadDashboard()" class="w-full px-2.5 py-1.5 text-xs border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300">
                            <option value="%">All</option>
                            <option value="A">A - High Value</option>
                            <option value="B">B - Medium Value</option>
                            <option value="C">C - Low Value</option>
                            <option value="N">N - None</option>
                        </select>
                    </div>

                    <!-- Location Group Filter -->
                    <div>
                        <label class="block text-[11px] font-semibold text-slate-600 mb-1.5">Location</label>
                        <select id="locationFilter" onchange="loadDashboard()" class="w-full px-2.5 py-1.5 text-xs border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300">
                            <option value="%">All Locations</option>
                        </select>
                    </div>
                </div>

                <!-- Custom Date Range (Hidden by default) -->
                <div id="customDateRangeContainer" class="mt-3 p-3 bg-slate-50 rounded-lg border border-slate-200" style="display: none;">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-[11px] font-semibold text-slate-600 mb-1.5">Start Date</label>
                            <input type="date" id="customStartDate" class="w-full px-2.5 py-1.5 text-xs border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300">
                        </div>
                        <div>
                            <label class="block text-[11px] font-semibold text-slate-600 mb-1.5">End Date</label>
                            <input type="date" id="customEndDate" class="w-full px-2.5 py-1.5 text-xs border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300">
                        </div>
                    </div>
                    <button onclick="applyCustomDateRange()" class="mt-2 px-3 py-1.5 bg-indigo-600 text-white text-xs font-medium rounded-lg hover:bg-indigo-700 transition-colors">Apply Date Range</button>
                </div>
            </div>

            <!-- Dashboard Content -->
            <div id="dashboardContent">
                <!-- Row 1: Main Chart + Status Overview -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mt-4">
                    <!-- Monthly PO Spend Trend (2-col span) -->
                    <div class="lg:col-span-2 bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-slate-800">Monthly PO Spend Trend</h3>
                            <div class="flex gap-2">
                                <button id="spendLineBtn" onclick="toggleSpendChartMode('line')" class="p-2 rounded bg-white text-slate-800 border border-slate-300 hover:bg-slate-50 transition-colors" title="Line Chart">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                                    </svg>
                                </button>
                                <button id="spendBarBtn" onclick="toggleSpendChartMode('bar')" class="p-2 rounded text-slate-600 border border-slate-300 hover:bg-slate-50 transition-colors" title="Bar Chart">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div id="monthlySpendChart"></div>
                    </div>

                    <!-- PO Status Overview -->
                    <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                        <h3 class="text-lg font-bold text-slate-800 mb-4">PO Status Overview</h3>
                        <div id="poStatusChart"></div>
                    </div>
                </div>

                <!-- Row 2: Upcoming & Alerts (PRIORITIZED) -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mt-4">
                    <!-- Expected Receipts This Week -->
                    <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h3 class="text-lg font-bold text-slate-800">Expected Receipts</h3>
                                <p class="text-xs text-slate-500">Next 7 days</p>
                            </div>
                            <div id="expectedReceiptsMetric" class="text-right">
                                <div class="text-4xl font-bold text-blue-600">-</div>
                                <div class="text-xs text-slate-500 mt-1">POs</div>
                            </div>
                        </div>
                        <div id="expectedReceiptsChart"></div>
                    </div>

                    <!-- Overdue POs -->
                    <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h3 class="text-lg font-bold text-slate-800">Overdue POs</h3>
                                <p class="text-xs text-slate-500">Past due date</p>
                            </div>
                            <div id="overduePOsMetric" class="text-right">
                                <div class="text-4xl font-bold text-red-600">-</div>
                                <div class="text-xs text-slate-500 mt-1">POs</div>
                            </div>
                        </div>
                        <div id="overduePOsChart"></div>
                    </div>

                    <!-- Recently Received -->
                    <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h3 class="text-lg font-bold text-slate-800">Recently Received</h3>
                                <p class="text-xs text-slate-500">Last 10 receipts</p>
                            </div>
                            <div id="recentlyReceivedMetric" class="text-right">
                                <div class="text-4xl font-bold text-green-600">-</div>
                                <div class="text-xs text-slate-500 mt-1">POs</div>
                            </div>
                        </div>
                        <div id="recentlyReceivedChart"></div>
                    </div>
                </div>

                <!-- Row 3: Vendor Performance -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mt-4">
                    <!-- Top Vendors by Spend -->
                    <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                        <h3 class="text-lg font-bold text-slate-800 mb-4">Top Vendors by Spend</h3>
                        <div id="topVendorsSpendChart"></div>
                    </div>

                    <!-- Top Vendors by PO Count -->
                    <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                        <h3 class="text-lg font-bold text-slate-800 mb-4">Top Vendors by PO Count</h3>
                        <div id="topVendorsCountChart"></div>
                    </div>

                    <!-- Vendor On-Time Performance -->
                    <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                        <h3 class="text-lg font-bold text-slate-800 mb-4">Vendor On-Time %</h3>
                        <div id="vendorOnTimeChart"></div>
                    </div>
                </div>

                <!-- Row 4: Product & Analytics -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mt-4">
                    <!-- Top Products by Quantity -->
                    <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                        <h3 class="text-lg font-bold text-slate-800 mb-4">Top Products by Qty</h3>
                        <div id="topProductsChart"></div>
                    </div>

                    <!-- Purchases by Category -->
                    <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                        <h3 class="text-lg font-bold text-slate-800 mb-4">Purchases by Category</h3>
                        <div id="categoryChart"></div>
                    </div>

                    <!-- High Value POs -->
                    <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h3 class="text-lg font-bold text-slate-800">High Value POs</h3>
                                <p class="text-xs text-slate-500">Orders over $10,000</p>
                            </div>
                            <div id="highValueMetric" class="text-right">
                                <div class="text-4xl font-bold text-purple-600">-</div>
                                <div class="text-xs text-slate-500 mt-1">POs</div>
                            </div>
                        </div>
                        <div id="highValueChart"></div>
                    </div>
                </div>

                <!-- Debug Console -->
                <div class="mt-6">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                        <button onclick="toggleDebugConsole()" class="w-full px-6 py-3 flex items-center justify-between hover:bg-slate-50 transition-colors">
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                                </svg>
                                <span class="text-sm font-semibold text-slate-700">Debug Console</span>
                                <span class="text-xs text-slate-400 font-normal">Auto-scrolls to latest entry</span>
                            </div>
                            <svg id="debugChevron" class="w-5 h-5 text-slate-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>

                        <div id="debugContent" class="hidden border-t border-slate-200">
                            <div class="bg-slate-900 px-4 py-2 flex items-center justify-between">
                                <span class="text-xs text-slate-400 font-mono">Query & Application Diagnostics</span>
                                <button onclick="clearDebugLog()" class="text-xs text-slate-400 hover:text-white transition-colors">
                                    Clear
                                </button>
                            </div>
                            <div id="debugLog" class="bg-slate-950 text-slate-200 p-4 font-mono text-xs max-h-96 overflow-y-auto" style="scrollbar-width: thin;">
                                <div class="text-slate-500 italic">Waiting for application to initialize...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-xl p-8 flex flex-col items-center gap-4">
            <div class="spinner"></div>
            <p class="text-slate-700 font-semibold">Loading purchasing data...</p>
        </div>
    </div>

    <!-- Drilldown Modal -->
    <div id="drilldownModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center" onclick="closeDrilldown(event)">
        <div class="bg-white rounded-2xl shadow-2xl w-11/12 max-w-6xl max-h-[90vh] flex flex-col" onclick="event.stopPropagation()">
            <!-- Modal Header -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-slate-200">
                <div>
                    <h2 id="drilldownTitle" class="text-xl font-bold text-slate-800"></h2>
                    <div id="drilldownBreadcrumb" class="text-sm text-slate-500 mt-1"></div>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="exportDrilldownData()" class="px-3 py-2 text-sm font-semibold text-slate-600 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-all flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Export CSV
                    </button>
                    <button onclick="closeDrilldown()" class="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Modal Body -->
            <div class="flex-1 overflow-auto px-6 py-4">
                <!-- Search Box -->
                <div class="mb-4">
                    <input type="text" id="drilldownSearch" placeholder="Search..." class="w-full px-4 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" oninput="filterDrilldownTable()">
                </div>

                <!-- Table -->
                <div class="overflow-x-auto">
                    <table id="drilldownTable" class="w-full text-sm">
                        <thead id="drilldownTableHead" class="bg-slate-50 sticky top-0">
                            <!-- Dynamic headers -->
                        </thead>
                        <tbody id="drilldownTableBody" class="divide-y divide-slate-200">
                            <!-- Dynamic rows -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentDateRange = 'current_fy';
        let customStartDate = null;
        let customEndDate = null;

        // Color palette for charts
        const colorPalette = [
            '#2d9cdb', '#3b82f6', '#10b981', '#f59e0b', '#ef4444',
            '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16', '#f97316'
        ];

        // Drilldown state
        let currentDrilldownData = [];
        let currentDrilldownColumns = [];
        let currentSortColumn = null;
        let currentSortDirection = 'asc';

        // PO Status chart state - track which statuses are hidden
        let hiddenStatuses = new Set(['Fulfilled']); // Hide Fulfilled by default
        let poStatusData = []; // Store the full dataset for re-rendering

        // Tooltip element
        const tooltip = d3.select('body')
            .append('div')
            .attr('class', 'tooltip')
            .style('opacity', 0);

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', function() {
            console.log('Purchasing Dashboard initializing...');
            loadFilters();
            loadDashboard();
        });

        // ============================================
        // Date Helper Functions
        // ============================================
        function getDateRange() {
            return {
                start: customStartDate,
                end: customEndDate
            };
        }

        function getDateCondition() {
            if (customStartDate && customEndDate) {
                return `postpo.postdate BETWEEN '${customStartDate}' AND '${customEndDate}'`;
            }

            const rangeValue = document.getElementById('dateRangeFilter').value;

            if (rangeValue === 'this_quarter') {
                const dates = getQuarterDates(0);
                return `postpo.postdate BETWEEN '${dates.start}' AND '${dates.end}'`;
            } else if (rangeValue === 'last_quarter') {
                const dates = getQuarterDates(1);
                return `postpo.postdate BETWEEN '${dates.start}' AND '${dates.end}'`;
            } else if (rangeValue === 'current_fy') {
                const dates = getFYDates(0);
                return `postpo.postdate BETWEEN '${dates.start}' AND '${dates.end}'`;
            } else if (rangeValue === 'last_fy') {
                const dates = getFYDates(1);
                return `postpo.postdate BETWEEN '${dates.start}' AND '${dates.end}'`;
            }

            const days = parseInt(rangeValue) || 90;
            return `postpo.postdate >= DATE_SUB(CURDATE(), INTERVAL ${days} DAY)`;
        }

        function getQuarterDates(quartersAgo) {
            const now = moment();
            const quarter = now.quarter() - quartersAgo;
            const year = now.year() - Math.floor((now.quarter() - quartersAgo - 1) / 4);
            const targetQuarter = ((quarter - 1 + 4) % 4) + 1;

            const start = moment().year(year).quarter(targetQuarter).startOf('quarter').format('YYYY-MM-DD');
            const end = moment().year(year).quarter(targetQuarter).endOf('quarter').format('YYYY-MM-DD');

            return { start, end };
        }

        function getFYDates(yearsAgo) {
            const fyStartMonth = 6; // July (0-indexed = 6)
            const now = moment();
            const currentMonth = now.month();

            let fyYear = now.year() - yearsAgo;
            if (currentMonth < fyStartMonth) {
                fyYear -= 1;
            }

            const start = moment().year(fyYear).month(fyStartMonth).date(1).format('YYYY-MM-DD');
            const end = moment().year(fyYear + 1).month(fyStartMonth).date(1).subtract(1, 'day').format('YYYY-MM-DD');

            return { start, end };
        }

        // ============================================
        // Filter Building Functions
        // ============================================
        function buildFilterConditions() {
            const vendor = document.getElementById('vendorFilter').value;
            const productCategory = document.getElementById('productCategoryFilter').value;
            const abcCode = document.getElementById('abcCodeFilter').value;
            const location = document.getElementById('locationFilter').value;

            let conditions = `WHERE ${getDateCondition()}`;

            if (vendor !== '%') {
                conditions += ` AND vendor.id = ${parseInt(vendor)}`;
            }
            if (productCategory !== '%') {
                conditions += ` AND ProductTree.Name = '${escapeSQL(productCategory)}'`;
            }
            if (abcCode !== '%') {
                conditions += ` AND part.abcCode = '${escapeSQL(abcCode)}'`;
            }
            if (location !== '%') {
                conditions += ` AND locationgroup.id = ${parseInt(location)}`;
            }

            return conditions;
        }

        // ============================================
        // Filter Loading Functions
        // ============================================
        function loadFilters() {
            debugLog('Loading filter dropdowns...', 'info');

            // Load Vendors
            const vendorQuery = `
                SELECT DISTINCT vendor.id, vendor.name
                FROM po
                JOIN vendor ON vendor.id = po.vendorid
                WHERE vendor.activeFlag = 1
                ORDER BY vendor.name
            `;
            try {
                const vendors = JSON.parse(runQuery(vendorQuery));
                const vendorSelector = document.getElementById('vendorFilter');
                vendorSelector.innerHTML = '<option value="%">All Vendors</option>';
                vendors.forEach(v => {
                    vendorSelector.innerHTML += `<option value="${v.id}">${v.name}</option>`;
                });
                debugLog(`Loaded ${vendors.length} vendors`, 'success');
            } catch (error) {
                debugLog('Error loading vendors: ' + error, 'error');
            }

            // Load Product Categories
            const categoryQuery = `
                SELECT DISTINCT ProductTree.Name as name
                FROM part
                LEFT JOIN ProductToTree ON ProductToTree.ProductId = part.Id
                LEFT JOIN ProductTree ON ProductTree.Id = ProductToTree.ProductTreeId
                WHERE ProductTree.Name IS NOT NULL
                ORDER BY ProductTree.Name
            `;
            try {
                const categories = JSON.parse(runQuery(categoryQuery));
                const categorySelector = document.getElementById('productCategoryFilter');
                categorySelector.innerHTML = '<option value="%">All Categories</option>';
                categories.forEach(c => {
                    if (c.name) categorySelector.innerHTML += `<option value="${c.name}">${c.name}</option>`;
                });
                debugLog(`Loaded ${categories.length} categories`, 'success');
            } catch (error) {
                debugLog('Error loading categories: ' + error, 'error');
            }

            // Load Location Groups
            const locationQuery = `
                SELECT DISTINCT locationgroup.id, locationgroup.name
                FROM locationgroup
                WHERE locationgroup.activeFlag = 1
                ORDER BY locationgroup.name
            `;
            try {
                const locations = JSON.parse(runQuery(locationQuery));
                const locationSelector = document.getElementById('locationFilter');
                locationSelector.innerHTML = '<option value="%">All Locations</option>';
                locations.forEach(l => {
                    locationSelector.innerHTML += `<option value="${l.id}">${l.name}</option>`;
                });
                debugLog(`Loaded ${locations.length} locations`, 'success');
            } catch (error) {
                debugLog('Error loading locations: ' + error, 'error');
            }
        }

        // ============================================
        // KPI Metrics Query
        // ============================================
        function getKPIMetrics() {
            const conditions = buildFilterConditions();
            const query = `
                SELECT
                    SUM(postpoitem.postedtotalcost) as total_spend,
                    COUNT(DISTINCT po.num) as po_count,
                    AVG(po_totals.po_total) as avg_po_value
                FROM postpoitem
                JOIN postpo ON postpoitem.postpoid = postpo.id
                JOIN poitem ON postpoitem.poitemid = poitem.id
                LEFT JOIN part ON poitem.partid = part.id
                LEFT JOIN ProductToTree ON ProductToTree.ProductId = part.Id
                LEFT JOIN ProductTree ON ProductTree.Id = ProductToTree.ProductTreeId
                JOIN po ON poitem.poid = po.id
                JOIN vendor ON po.vendorid = vendor.id
                JOIN locationgroup ON po.locationgroupid = locationgroup.id
                LEFT JOIN (
                    SELECT
                        po.id as po_id,
                        SUM(postpoitem.postedtotalcost) as po_total
                    FROM postpoitem
                    JOIN postpo ON postpoitem.postpoid = postpo.id
                    JOIN poitem ON postpoitem.poitemid = poitem.id
                    JOIN po ON poitem.poid = po.id
                    GROUP BY po.id
                ) as po_totals ON po_totals.po_id = po.id
                ${conditions}
            `;

            debugLog('KPI Query: ' + query, 'info');
            return JSON.parse(runQuery(query));
        }

        // ============================================
        // Main Dashboard Loading Function
        // ============================================
        function loadDashboard() {
            debugLog('Loading dashboard data...', 'info');
            const loading = document.getElementById('loadingOverlay');
            loading.style.display = 'flex';

            try {
                // Load KPIs (including average lead time)
                const kpiData = getKPIMetrics();
                const avgLeadTimeData = getAverageLeadTime();
                updateKPIs(kpiData, avgLeadTimeData);

                // Load all charts and tiles
                const monthlySpendData = getMonthlySpend();
                renderMonthlySpendChart(monthlySpendData);

                const poStatusData = getPOStatusBreakdown();
                renderPOStatusChart(poStatusData);

                const expectedReceiptsData = getExpectedReceipts();
                renderExpectedReceiptsChart(expectedReceiptsData);

                const overduePOsData = getOverduePOs();
                renderOverduePOsChart(overduePOsData);

                const recentlyReceivedData = getRecentlyReceived();
                renderRecentlyReceivedChart(recentlyReceivedData);

                const topVendorsSpendData = getTopVendorsBySpend();
                renderTopVendorsSpendChart(topVendorsSpendData);

                const topVendorsCountData = getTopVendorsByCount();
                renderTopVendorsCountChart(topVendorsCountData);

                const vendorOnTimeData = getVendorOnTimePerformance();
                renderVendorOnTimeChart(vendorOnTimeData);

                const topProductsData = getTopProducts();
                renderTopProductsChart(topProductsData);

                const categoryData = getPurchasesByCategory();
                renderCategoryChart(categoryData);

                const highValueData = getHighValuePOs();
                renderHighValueChart(highValueData);

                debugLog('Dashboard loaded successfully', 'success');
            } catch (error) {
                console.error('Error loading dashboard:', error);
                alert('Error loading purchasing data. Please check console for details.');
            } finally {
                loading.style.display = 'none';
                updateDateRangeDisplay();
            }
        }

        // ============================================
        // KPI Display Update
        // ============================================
        function updateKPIs(data, avgLeadTimeData) {
            if (!data || data.length === 0) return;

            const metrics = data[0];
            const kpiCardsContainer = document.getElementById('kpiCards');

            const totalSpend = '$' + parseFloat(metrics.total_spend || 0).toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
            const poCount = (metrics.po_count || 0).toLocaleString();
            const avgPOValue = '$' + parseFloat(metrics.avg_po_value || 0).toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});

            // Get average lead time
            let avgLeadTime = 'N/A';
            if (avgLeadTimeData && avgLeadTimeData.length > 0 && avgLeadTimeData[0].avg_lead_time !== null) {
                avgLeadTime = Math.round(avgLeadTimeData[0].avg_lead_time) + ' days';
            }

            kpiCardsContainer.innerHTML = `
                <div class="flex items-center gap-2 px-3 py-2 bg-blue-50 border border-blue-200 rounded-lg">
                    <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="text-xs font-semibold text-slate-600">Total Spend:</span>
                    <span class="text-sm font-bold text-slate-900">${totalSpend}</span>
                </div>
                <div class="flex items-center gap-2 px-3 py-2 bg-emerald-50 border border-emerald-200 rounded-lg">
                    <svg class="w-4 h-4 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <span class="text-xs font-semibold text-slate-600">POs Received:</span>
                    <span class="text-sm font-bold text-slate-900">${poCount}</span>
                </div>
                <div class="flex items-center gap-2 px-3 py-2 bg-purple-50 border border-purple-200 rounded-lg">
                    <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                    </svg>
                    <span class="text-xs font-semibold text-slate-600">Avg PO:</span>
                    <span class="text-sm font-bold text-slate-900">${avgPOValue}</span>
                </div>
                <div class="flex items-center gap-2 px-3 py-2 bg-indigo-50 border border-indigo-200 rounded-lg">
                    <svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="text-xs font-semibold text-slate-600">Avg Lead Time:</span>
                    <span class="text-sm font-bold text-slate-900">${avgLeadTime}</span>
                </div>
            `;
        }

        // ============================================
        // Data Query Functions
        // ============================================
        // NOTE: KPI and spend metrics use postpoitem table, which only includes received POs
        // This automatically excludes Bid status (10) and un-received POs from spend calculations

        // Monthly PO Spend Trend
        function getMonthlySpend() {
            const conditions = buildFilterConditions();
            const query = `
                SELECT
                    DATE_FORMAT(postpo.postdate, '%Y-%m') as month,
                    SUM(postpoitem.postedtotalcost) as total_spend
                FROM postpoitem
                JOIN postpo ON postpoitem.postpoid = postpo.id
                JOIN poitem ON postpoitem.poitemid = poitem.id
                LEFT JOIN part ON poitem.partid = part.id
                LEFT JOIN ProductToTree ON ProductToTree.ProductId = part.Id
                LEFT JOIN ProductTree ON ProductTree.Id = ProductToTree.ProductTreeId
                JOIN po ON poitem.poid = po.id
                JOIN vendor ON po.vendorid = vendor.id
                JOIN locationgroup ON po.locationgroupid = locationgroup.id
                ${conditions}
                GROUP BY month
                ORDER BY month
            `;
            debugLog('Monthly Spend Query: ' + query, 'info');
            return JSON.parse(runQuery(query));
        }

        // PO Status Overview - Shows distribution across all active PO statuses
        // Only filters by vendor, location, and date - not by product category/ABC (since POs contain multiple parts)
        function getPOStatusBreakdown() {
            try {
                const vendor = document.getElementById('vendorFilter').value;
                const location = document.getElementById('locationFilter').value;

                const { start, end } = getDateRange();

                // Include all statuses for overview: Bid(10), Issued(20), Picking(30), Partial(40), Fulfilled(60), Closed Short(70), Void(95)
                let conditions = `WHERE postatus.id IN (10, 20, 30, 40, 60, 70, 95)`;

                // Date filter based on date range
                if (start && end) {
                    conditions += ` AND po.dateIssued BETWEEN '${start}' AND '${end}'`;
                    debugLog(`Date range: ${start} to ${end}`, 'info');
                }

                if (vendor !== '%') {
                    conditions += ` AND vendor.id = ${parseInt(vendor)}`;
                    debugLog(`Vendor filter: ${vendor}`, 'info');
                }
                if (location !== '%') {
                    conditions += ` AND locationgroup.id = ${parseInt(location)}`;
                    debugLog(`Location filter: ${location}`, 'info');
                }

                const query = `
                    SELECT
                        postatus.name as status_name,
                        COUNT(DISTINCT po.id) as po_count
                    FROM po
                    JOIN postatus ON po.statusid = postatus.id
                    JOIN vendor ON po.vendorid = vendor.id
                    JOIN locationgroup ON po.locationgroupid = locationgroup.id
                    ${conditions}
                    GROUP BY postatus.name, postatus.id
                    ORDER BY postatus.id
                `;
                debugLog('PO Status Query: ' + query, 'info');

                const result = runQuery(query);
                debugLog('PO Status query result received: ' + (result ? result.length + ' chars' : 'null'), result ? 'success' : 'error');

                const parsedData = JSON.parse(result);
                debugLog(`PO Status data parsed: ${parsedData.length} statuses found`, 'success');

                return parsedData;
            } catch (error) {
                debugLog(`ERROR in getPOStatusBreakdown: ${error.message}`, 'error');
                console.error('Full error:', error);
                return [];
            }
        }

        // Expected Receipts This Week
        function getExpectedReceipts() {
            const vendor = document.getElementById('vendorFilter').value;
            const productCategory = document.getElementById('productCategoryFilter').value;
            const abcCode = document.getElementById('abcCodeFilter').value;
            const location = document.getElementById('locationFilter').value;

            let conditions = `WHERE po.statusid IN (20, 30, 40)
                AND poitem.dateScheduledFulfillment BETWEEN CURDATE() AND DATE_ADD(CURDATE(), INTERVAL 7 DAY)`;

            if (vendor !== '%') {
                conditions += ` AND vendor.id = ${parseInt(vendor)}`;
            }
            if (productCategory !== '%') {
                conditions += ` AND ProductTree.Name = '${escapeSQL(productCategory)}'`;
            }
            if (abcCode !== '%') {
                conditions += ` AND part.abcCode = '${escapeSQL(abcCode)}'`;
            }
            if (location !== '%') {
                conditions += ` AND locationgroup.id = ${parseInt(location)}`;
            }

            const query = `
                SELECT
                    po.num as po_num,
                    vendor.name as vendor_name,
                    poitem.dateScheduledFulfillment as due_date,
                    SUM(poitem.qtytofulfill * poitem.unitcost) as po_value
                FROM po
                JOIN poitem ON poitem.poid = po.id
                LEFT JOIN part ON poitem.partid = part.id
                LEFT JOIN ProductToTree ON ProductToTree.ProductId = part.Id
                LEFT JOIN ProductTree ON ProductTree.Id = ProductToTree.ProductTreeId
                JOIN vendor ON po.vendorid = vendor.id
                JOIN locationgroup ON po.locationgroupid = locationgroup.id
                ${conditions}
                GROUP BY po.num, vendor.name, poitem.dateScheduledFulfillment
                ORDER BY poitem.dateScheduledFulfillment
                LIMIT 100
            `;
            debugLog('Expected Receipts Query: ' + query, 'info');
            return JSON.parse(runQuery(query));
        }

        // Overdue POs
        function getOverduePOs() {
            const vendor = document.getElementById('vendorFilter').value;
            const productCategory = document.getElementById('productCategoryFilter').value;
            const abcCode = document.getElementById('abcCodeFilter').value;
            const location = document.getElementById('locationFilter').value;

            let conditions = `WHERE po.statusid IN (20, 30, 40)
                AND poitem.dateScheduledFulfillment < CURDATE()`;

            if (vendor !== '%') {
                conditions += ` AND vendor.id = ${parseInt(vendor)}`;
            }
            if (productCategory !== '%') {
                conditions += ` AND ProductTree.Name = '${escapeSQL(productCategory)}'`;
            }
            if (abcCode !== '%') {
                conditions += ` AND part.abcCode = '${escapeSQL(abcCode)}'`;
            }
            if (location !== '%') {
                conditions += ` AND locationgroup.id = ${parseInt(location)}`;
            }

            const query = `
                SELECT
                    po.num as po_num,
                    vendor.name as vendor_name,
                    poitem.dateScheduledFulfillment as due_date,
                    DATEDIFF(CURDATE(), poitem.dateScheduledFulfillment) as days_overdue,
                    SUM(poitem.qtytofulfill * poitem.unitcost) as po_value
                FROM po
                JOIN poitem ON poitem.poid = po.id
                LEFT JOIN part ON poitem.partid = part.id
                LEFT JOIN ProductToTree ON ProductToTree.ProductId = part.Id
                LEFT JOIN ProductTree ON ProductTree.Id = ProductToTree.ProductTreeId
                JOIN vendor ON po.vendorid = vendor.id
                JOIN locationgroup ON po.locationgroupid = locationgroup.id
                ${conditions}
                GROUP BY po.num, vendor.name, poitem.dateScheduledFulfillment
                ORDER BY days_overdue DESC
                LIMIT 100
            `;
            debugLog('Overdue POs Query: ' + query, 'info');
            return JSON.parse(runQuery(query));
        }

        // Recently Received POs
        function getRecentlyReceived() {
            const conditions = buildFilterConditions();
            const query = `
                SELECT
                    po.num as po_num,
                    vendor.name as vendor_name,
                    postpo.postdate as received_date,
                    SUM(postpoitem.postedtotalcost) as po_value
                FROM postpoitem
                JOIN postpo ON postpoitem.postpoid = postpo.id
                JOIN poitem ON postpoitem.poitemid = poitem.id
                LEFT JOIN part ON poitem.partid = part.id
                LEFT JOIN ProductToTree ON ProductToTree.ProductId = part.Id
                LEFT JOIN ProductTree ON ProductTree.Id = ProductToTree.ProductTreeId
                JOIN po ON poitem.poid = po.id
                JOIN vendor ON po.vendorid = vendor.id
                JOIN locationgroup ON po.locationgroupid = locationgroup.id
                ${conditions}
                GROUP BY po.num, vendor.name, postpo.postdate
                ORDER BY postpo.postdate DESC
                LIMIT 10
            `;
            debugLog('Recently Received Query: ' + query, 'info');
            return JSON.parse(runQuery(query));
        }

        // Top Vendors by Spend
        function getTopVendorsBySpend() {
            const conditions = buildFilterConditions();
            const query = `
                SELECT
                    vendor.name as vendor_name,
                    SUM(postpoitem.postedtotalcost) as total_spend,
                    COUNT(DISTINCT po.num) as po_count
                FROM postpoitem
                JOIN postpo ON postpoitem.postpoid = postpo.id
                JOIN poitem ON postpoitem.poitemid = poitem.id
                LEFT JOIN part ON poitem.partid = part.id
                LEFT JOIN ProductToTree ON ProductToTree.ProductId = part.Id
                LEFT JOIN ProductTree ON ProductTree.Id = ProductToTree.ProductTreeId
                JOIN po ON poitem.poid = po.id
                JOIN vendor ON po.vendorid = vendor.id
                JOIN locationgroup ON po.locationgroupid = locationgroup.id
                ${conditions}
                GROUP BY vendor.name
                ORDER BY total_spend DESC
                LIMIT 10
            `;
            debugLog('Top Vendors by Spend Query: ' + query, 'info');
            return JSON.parse(runQuery(query));
        }

        // Top Vendors by PO Count
        function getTopVendorsByCount() {
            const conditions = buildFilterConditions();
            const query = `
                SELECT
                    vendor.name as vendor_name,
                    COUNT(DISTINCT po.num) as po_count,
                    SUM(postpoitem.postedtotalcost) as total_spend
                FROM postpoitem
                JOIN postpo ON postpoitem.postpoid = postpo.id
                JOIN poitem ON postpoitem.poitemid = poitem.id
                LEFT JOIN part ON poitem.partid = part.id
                LEFT JOIN ProductToTree ON ProductToTree.ProductId = part.Id
                LEFT JOIN ProductTree ON ProductTree.Id = ProductToTree.ProductTreeId
                JOIN po ON poitem.poid = po.id
                JOIN vendor ON po.vendorid = vendor.id
                JOIN locationgroup ON po.locationgroupid = locationgroup.id
                ${conditions}
                GROUP BY vendor.name
                ORDER BY po_count DESC
                LIMIT 10
            `;
            debugLog('Top Vendors by Count Query: ' + query, 'info');
            return JSON.parse(runQuery(query));
        }

        // Vendor On-Time Performance
        function getVendorOnTimePerformance() {
            const conditions = buildFilterConditions();
            const query = `
                SELECT
                    vendor.name as vendor_name,
                    COUNT(*) as total_orders,
                    SUM(CASE WHEN postpo.postdate <= poitem.dateScheduledFulfillment THEN 1 ELSE 0 END) as on_time_orders,
                    ROUND((SUM(CASE WHEN postpo.postdate <= poitem.dateScheduledFulfillment THEN 1 ELSE 0 END) / COUNT(*)) * 100, 1) as on_time_percent
                FROM postpoitem
                JOIN postpo ON postpoitem.postpoid = postpo.id
                JOIN poitem ON postpoitem.poitemid = poitem.id
                LEFT JOIN part ON poitem.partid = part.id
                LEFT JOIN ProductToTree ON ProductToTree.ProductId = part.Id
                LEFT JOIN ProductTree ON ProductTree.Id = ProductToTree.ProductTreeId
                JOIN po ON poitem.poid = po.id
                JOIN vendor ON po.vendorid = vendor.id
                JOIN locationgroup ON po.locationgroupid = locationgroup.id
                ${conditions}
                AND poitem.dateScheduledFulfillment IS NOT NULL
                GROUP BY vendor.name
                HAVING total_orders >= 3
                ORDER BY on_time_percent DESC
                LIMIT 10
            `;
            debugLog('Vendor On-Time Performance Query: ' + query, 'info');
            return JSON.parse(runQuery(query));
        }

        // Top Products by Quantity
        function getTopProducts() {
            const conditions = buildFilterConditions();
            const query = `
                SELECT
                    poitem.partnum as part_num,
                    poitem.description as part_description,
                    SUM(postpoitem.qty) as total_qty,
                    SUM(postpoitem.postedtotalcost) as total_cost
                FROM postpoitem
                JOIN postpo ON postpoitem.postpoid = postpo.id
                JOIN poitem ON postpoitem.poitemid = poitem.id
                LEFT JOIN part ON poitem.partid = part.id
                LEFT JOIN ProductToTree ON ProductToTree.ProductId = part.Id
                LEFT JOIN ProductTree ON ProductTree.Id = ProductToTree.ProductTreeId
                JOIN po ON poitem.poid = po.id
                JOIN vendor ON po.vendorid = vendor.id
                JOIN locationgroup ON po.locationgroupid = locationgroup.id
                ${conditions}
                GROUP BY poitem.partnum, poitem.description
                ORDER BY total_qty DESC
                LIMIT 10
            `;
            debugLog('Top Products Query: ' + query, 'info');
            return JSON.parse(runQuery(query));
        }

        // Purchases by Category
        function getPurchasesByCategory() {
            const conditions = buildFilterConditions();
            const query = `
                SELECT
                    COALESCE(ProductTree.Name, 'Uncategorized') as category_name,
                    SUM(postpoitem.postedtotalcost) as total_spend,
                    COUNT(DISTINCT po.num) as po_count
                FROM postpoitem
                JOIN postpo ON postpoitem.postpoid = postpo.id
                JOIN poitem ON postpoitem.poitemid = poitem.id
                LEFT JOIN part ON poitem.partid = part.id
                LEFT JOIN ProductToTree ON ProductToTree.ProductId = part.Id
                LEFT JOIN ProductTree ON ProductTree.Id = ProductToTree.ProductTreeId
                JOIN po ON poitem.poid = po.id
                JOIN vendor ON po.vendorid = vendor.id
                JOIN locationgroup ON po.locationgroupid = locationgroup.id
                ${conditions}
                GROUP BY ProductTree.Name
                ORDER BY total_spend DESC
                LIMIT 10
            `;
            debugLog('Purchases by Category Query: ' + query, 'info');
            return JSON.parse(runQuery(query));
        }

        // Average Lead Time
        function getAverageLeadTime() {
            const conditions = buildFilterConditions();
            const query = `
                SELECT
                    AVG(DATEDIFF(postpo.postdate, po.dateIssued)) as avg_lead_time
                FROM postpoitem
                JOIN postpo ON postpoitem.postpoid = postpo.id
                JOIN poitem ON postpoitem.poitemid = poitem.id
                LEFT JOIN part ON poitem.partid = part.id
                LEFT JOIN ProductToTree ON ProductToTree.ProductId = part.Id
                LEFT JOIN ProductTree ON ProductTree.Id = ProductToTree.ProductTreeId
                JOIN po ON poitem.poid = po.id
                JOIN vendor ON po.vendorid = vendor.id
                JOIN locationgroup ON po.locationgroupid = locationgroup.id
                ${conditions}
                AND po.dateIssued IS NOT NULL
                AND postpo.postdate IS NOT NULL
            `;
            debugLog('Average Lead Time Query: ' + query, 'info');
            return JSON.parse(runQuery(query));
        }

        // High Value POs
        function getHighValuePOs() {
            const conditions = buildFilterConditions();
            const query = `
                SELECT
                    po.num as po_num,
                    vendor.name as vendor_name,
                    postpo.postdate as received_date,
                    SUM(postpoitem.postedtotalcost) as po_value
                FROM postpoitem
                JOIN postpo ON postpoitem.postpoid = postpo.id
                JOIN poitem ON postpoitem.poitemid = poitem.id
                LEFT JOIN part ON poitem.partid = part.id
                LEFT JOIN ProductToTree ON ProductToTree.ProductId = part.Id
                LEFT JOIN ProductTree ON ProductTree.Id = ProductToTree.ProductTreeId
                JOIN po ON poitem.poid = po.id
                JOIN vendor ON po.vendorid = vendor.id
                JOIN locationgroup ON po.locationgroupid = locationgroup.id
                ${conditions}
                GROUP BY po.num, vendor.name, postpo.postdate
                HAVING po_value >= 10000
                ORDER BY po_value DESC
                LIMIT 100
            `;
            debugLog('High Value POs Query: ' + query, 'info');
            return JSON.parse(runQuery(query));
        }

        // ============================================
        // Render Functions (Placeholders)
        // ============================================

        function renderMonthlySpendChart(data) {
            const container = document.getElementById('monthlySpendChart');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-12 text-sm">No data available</p>';
                return;
            }

            const margin = { top: 20, right: 20, bottom: 40, left: 80 };
            const width = container.offsetWidth - margin.left - margin.right;
            const height = 200 - margin.top - margin.bottom;

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const x = d3.scaleBand()
                .domain(data.map(d => d.month))
                .range([0, width])
                .padding(0.3);

            const y = d3.scaleLinear()
                .domain([0, d3.max(data, d => parseFloat(d.total_spend))])
                .nice()
                .range([height, 0]);

            // Grid
            svg.append('g')
                .attr('class', 'grid')
                .attr('opacity', 0.1)
                .call(d3.axisLeft(y).tickSize(-width).tickFormat(''));

            if (spendChartMode === 'bar') {
                // Bar chart mode
                svg.selectAll('.bar')
                    .data(data)
                    .enter()
                    .append('rect')
                    .attr('class', 'bar')
                    .attr('x', d => x(d.month))
                    .attr('y', d => y(parseFloat(d.total_spend)))
                    .attr('width', x.bandwidth())
                    .attr('height', d => height - y(parseFloat(d.total_spend)))
                    .attr('fill', colorPalette[0])
                    .attr('rx', 4)
                    .style('cursor', 'pointer')
                    .on('mouseover', function(event, d) {
                        d3.select(this).attr('opacity', 0.8);
                        tooltip.style('opacity', 1)
                            .html(`
                                <div><span class="tooltip-label">Month:</span><span class="tooltip-value">${moment(d.month).format('MMM YYYY')}</span></div>
                                <div><span class="tooltip-label">Total Spend:</span><span class="tooltip-value">$${parseFloat(d.total_spend).toLocaleString('en-US', {minimumFractionDigits: 2})}</span></div>
                            `)
                            .style('left', (event.pageX + 10) + 'px')
                            .style('top', (event.pageY - 10) + 'px');
                    })
                    .on('mouseout', function() {
                        d3.select(this).attr('opacity', 1);
                        tooltip.style('opacity', 0);
                    });
            } else {
                // Line chart mode
                const line = d3.line()
                    .x(d => x(d.month) + x.bandwidth() / 2)
                    .y(d => y(parseFloat(d.total_spend)))
                    .curve(d3.curveMonotoneX);

                svg.append('path')
                    .datum(data)
                    .attr('class', 'line')
                    .attr('d', line)
                    .attr('stroke', colorPalette[0])
                    .attr('stroke-width', 3)
                    .attr('fill', 'none');

                // Add dots
                svg.selectAll('.dot')
                    .data(data)
                    .enter()
                    .append('circle')
                    .attr('class', 'dot')
                    .attr('cx', d => x(d.month) + x.bandwidth() / 2)
                    .attr('cy', d => y(parseFloat(d.total_spend)))
                    .attr('r', 5)
                    .attr('fill', colorPalette[0])
                    .attr('stroke', 'white')
                    .attr('stroke-width', 2)
                    .style('cursor', 'pointer')
                    .on('mouseover', function(event, d) {
                        d3.select(this).attr('r', 7);
                        tooltip.style('opacity', 1)
                            .html(`
                                <div><span class="tooltip-label">Month:</span><span class="tooltip-value">${moment(d.month).format('MMM YYYY')}</span></div>
                                <div><span class="tooltip-label">Total Spend:</span><span class="tooltip-value">$${parseFloat(d.total_spend).toLocaleString('en-US', {minimumFractionDigits: 2})}</span></div>
                            `)
                            .style('left', (event.pageX + 10) + 'px')
                            .style('top', (event.pageY - 10) + 'px');
                    })
                    .on('mouseout', function() {
                        d3.select(this).attr('r', 5);
                        tooltip.style('opacity', 0);
                    });
            }

            // Axes
            svg.append('g')
                .attr('class', 'axis')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x).tickFormat(d => moment(d).format('MMM YY')))
                .selectAll('text')
                .style('text-anchor', 'end')
                .attr('dx', '-.8em')
                .attr('dy', '.15em')
                .attr('transform', 'rotate(-45)');

            svg.append('g')
                .attr('class', 'axis')
                .call(d3.axisLeft(y).ticks(5).tickFormat(d => '$' + (d / 1000).toFixed(0) + 'k'));

            debugLog(`Monthly spend chart rendered: ${data.length} months`, 'success');
        }

        function renderPOStatusChart(data) {
            const container = document.getElementById('poStatusChart');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-12 text-sm">No data available</p>';
                return;
            }

            // Store full dataset for toggling
            poStatusData = data;

            // Filter out hidden statuses for rendering
            const visibleData = data.filter(d => !hiddenStatuses.has(d.status_name));

            // Create wrapper for chart and legend
            const wrapper = d3.select(container)
                .append('div')
                .style('display', 'flex')
                .style('flex-direction', 'row')
                .style('align-items', 'center')
                .style('gap', '16px')
                .style('width', '100%');

            // Chart container - 75% width
            const chartDiv = wrapper.append('div')
                .style('flex', '0 0 75%')
                .style('display', 'flex')
                .style('justify-content', 'center');

            const width = 240;
            const height = 240;
            const radius = Math.min(width, height) / 2;

            const svg = chartDiv.append('svg')
                .attr('width', width)
                .attr('height', height)
                .append('g')
                .attr('transform', `translate(${width / 2},${height / 2})`);

            const color = d3.scaleOrdinal()
                .domain(data.map(d => d.status_name))
                .range(colorPalette);

            // Only render visible data
            if (visibleData.length > 0) {
                const pie = d3.pie()
                    .value(d => parseInt(d.po_count))
                    .sort(null);

                const arc = d3.arc()
                    .innerRadius(radius * 0.35)
                    .outerRadius(radius * 0.85);

                const arcs = svg.selectAll('.arc')
                    .data(pie(visibleData))
                    .enter()
                    .append('g')
                    .attr('class', 'arc');

                arcs.append('path')
                    .attr('d', arc)
                    .attr('fill', d => color(d.data.status_name))
                    .attr('stroke', 'white')
                    .attr('stroke-width', 2)
                    .style('cursor', 'pointer')
                    .on('mouseover', function(event, d) {
                        d3.select(this)
                            .transition()
                            .duration(200)
                            .attr('d', d3.arc().innerRadius(radius * 0.35).outerRadius(radius * 0.9));

                        const total = d3.sum(visibleData, d => parseInt(d.po_count));
                        const percent = (parseInt(d.data.po_count) / total * 100).toFixed(1);

                        tooltip.style('opacity', 1)
                            .html(`
                                <div><span class="tooltip-label">Status:</span><span class="tooltip-value">${d.data.status_name}</span></div>
                                <div><span class="tooltip-label">PO Count:</span><span class="tooltip-value">${parseInt(d.data.po_count).toLocaleString()}</span></div>
                                <div><span class="tooltip-label">Percentage:</span><span class="tooltip-value">${percent}%</span></div>
                            `)
                            .style('left', (event.pageX + 10) + 'px')
                            .style('top', (event.pageY - 10) + 'px');
                    })
                    .on('mouseout', function() {
                        d3.select(this)
                            .transition()
                            .duration(200)
                            .attr('d', arc);
                        tooltip.style('opacity', 0);
                    });
            }

            // Add center text showing total of visible statuses
            const total = d3.sum(visibleData, d => parseInt(d.po_count));
            svg.append('text')
                .attr('text-anchor', 'middle')
                .attr('dy', '-0.2em')
                .style('font-size', '32px')
                .style('font-weight', 'bold')
                .style('fill', '#1e293b')
                .text(total);

            svg.append('text')
                .attr('text-anchor', 'middle')
                .attr('dy', '1.5em')
                .style('font-size', '12px')
                .style('fill', '#64748b')
                .text('Total POs');

            // Add legend - show ALL statuses (both visible and hidden)
            const legendDiv = wrapper.append('div')
                .style('flex', '0 0 25%')
                .style('display', 'flex')
                .style('flex-direction', 'column')
                .style('gap', '6px');

            data.forEach(d => {
                const isHidden = hiddenStatuses.has(d.status_name);

                const legendItem = legendDiv.append('div')
                    .style('display', 'flex')
                    .style('align-items', 'center')
                    .style('justify-content', 'space-between')
                    .style('gap', '8px')
                    .style('font-size', '11px')
                    .style('cursor', 'pointer')
                    .style('padding', '4px 6px')
                    .style('border-radius', '4px')
                    .style('opacity', isHidden ? '0.4' : '1')
                    .style('transition', 'all 0.2s ease')
                    .on('mouseover', function() {
                        d3.select(this).style('background-color', '#f1f5f9');
                    })
                    .on('mouseout', function() {
                        d3.select(this).style('background-color', 'transparent');
                    })
                    .on('click', function() {
                        togglePOStatus(d.status_name);
                    });

                const leftSection = legendItem.append('div')
                    .style('display', 'flex')
                    .style('align-items', 'center')
                    .style('gap', '6px');

                leftSection.append('div')
                    .style('width', '12px')
                    .style('height', '12px')
                    .style('border-radius', '2px')
                    .style('background-color', color(d.status_name))
                    .style('flex-shrink', '0');

                leftSection.append('span')
                    .style('color', '#475569')
                    .style('font-weight', '500')
                    .style('text-decoration', isHidden ? 'line-through' : 'none')
                    .text(d.status_name);

                legendItem.append('span')
                    .style('color', '#1e293b')
                    .style('font-weight', '600')
                    .style('text-decoration', isHidden ? 'line-through' : 'none')
                    .text(parseInt(d.po_count).toLocaleString());
            });

            debugLog(`PO status chart rendered: ${visibleData.length}/${data.length} statuses visible`, 'success');
        }

        function togglePOStatus(statusName) {
            if (hiddenStatuses.has(statusName)) {
                hiddenStatuses.delete(statusName);
                debugLog(`Showing ${statusName} status`, 'click');
            } else {
                hiddenStatuses.add(statusName);
                debugLog(`Hiding ${statusName} status`, 'click');
            }

            // Re-render the chart with updated visibility
            renderPOStatusChart(poStatusData);
        }

        function renderExpectedReceiptsChart(data) {
            const container = document.getElementById('expectedReceiptsChart');
            const metric = document.querySelector('#expectedReceiptsMetric .text-4xl');
            metric.textContent = data.length;
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-400 py-8 text-sm">No POs expected in next 7 days</div>';
                return;
            }

            const list = document.createElement('div');
            list.className = 'space-y-2 overflow-y-auto custom-scrollbar';
            list.style.maxHeight = '200px';

            data.forEach(po => {
                const item = document.createElement('div');
                item.className = 'p-2 bg-blue-50 rounded hover:bg-blue-100 transition-colors cursor-pointer';
                const daysUntil = moment(po.due_date).diff(moment(), 'days');
                item.innerHTML = `
                    <div class="flex justify-between text-sm">
                        <span class="font-semibold text-slate-700">PO ${po.po_num}</span>
                        <span class="text-blue-700 font-bold">$${parseFloat(po.po_value).toLocaleString('en-US', {maximumFractionDigits: 0})}</span>
                    </div>
                    <div class="flex justify-between text-xs text-slate-500 mt-1">
                        <span>${po.vendor_name}</span>
                        <span class="text-indigo-600 font-medium">${daysUntil} days</span>
                    </div>
                `;
                item.addEventListener('click', () => drilldownExpectedReceipts());
                list.appendChild(item);
            });

            container.appendChild(list);
            debugLog(`Expected receipts: ${data.length} POs`, 'success');
        }

        function renderOverduePOsChart(data) {
            const container = document.getElementById('overduePOsChart');
            const metric = document.querySelector('#overduePOsMetric .text-4xl');
            metric.textContent = data.length;
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-400 py-8 text-sm">No overdue POs</div>';
                return;
            }

            const list = document.createElement('div');
            list.className = 'space-y-2 overflow-y-auto custom-scrollbar';
            list.style.maxHeight = '200px';

            data.forEach(po => {
                const item = document.createElement('div');
                item.className = 'p-2 bg-red-50 rounded hover:bg-red-100 transition-colors cursor-pointer';
                item.innerHTML = `
                    <div class="flex justify-between text-sm">
                        <span class="font-semibold text-slate-700">PO ${po.po_num}</span>
                        <span class="text-red-700 font-bold">$${parseFloat(po.po_value).toLocaleString('en-US', {maximumFractionDigits: 0})}</span>
                    </div>
                    <div class="flex justify-between text-xs text-slate-500 mt-1">
                        <span>${po.vendor_name}</span>
                        <span class="text-red-600 font-medium">${po.days_overdue} days overdue</span>
                    </div>
                `;
                item.addEventListener('click', () => drilldownOverduePOs());
                list.appendChild(item);
            });

            container.appendChild(list);
            debugLog(`Overdue POs: ${data.length}`, 'success');
        }

        function renderRecentlyReceivedChart(data) {
            const container = document.getElementById('recentlyReceivedChart');
            const metric = document.querySelector('#recentlyReceivedMetric .text-4xl');
            metric.textContent = data.length;
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-400 py-8 text-sm">No recent receipts</div>';
                return;
            }

            const list = document.createElement('div');
            list.className = 'space-y-2 overflow-y-auto custom-scrollbar';
            list.style.maxHeight = '200px';

            data.forEach(po => {
                const item = document.createElement('div');
                item.className = 'p-2 bg-green-50 rounded hover:bg-green-100 transition-colors cursor-pointer';
                item.innerHTML = `
                    <div class="flex justify-between text-sm">
                        <span class="font-semibold text-slate-700">PO ${po.po_num}</span>
                        <span class="text-green-700 font-bold">$${parseFloat(po.po_value).toLocaleString('en-US', {maximumFractionDigits: 0})}</span>
                    </div>
                    <div class="flex justify-between text-xs text-slate-500 mt-1">
                        <span>${po.vendor_name}</span>
                        <span class="text-green-600 font-medium">${moment(po.received_date).format('MMM D')}</span>
                    </div>
                `;
                item.addEventListener('click', () => drilldownRecentlyReceived());
                list.appendChild(item);
            });

            container.appendChild(list);
            debugLog(`Recently received: ${data.length} POs`, 'success');
        }

        function renderTopVendorsSpendChart(data) {
            const container = document.getElementById('topVendorsSpendChart');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-12 text-sm">No data available</p>';
                return;
            }

            const margin = { top: 10, right: 30, bottom: 30, left: 120 };
            const width = container.offsetWidth - margin.left - margin.right;
            const height = 280 - margin.top - margin.bottom;

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const x = d3.scaleLinear()
                .domain([0, d3.max(data, d => parseFloat(d.total_spend))])
                .nice()
                .range([0, width]);

            const y = d3.scaleBand()
                .domain(data.map(d => d.vendor_name))
                .range([0, height])
                .padding(0.2);

            svg.selectAll('.bar')
                .data(data)
                .enter()
                .append('rect')
                .attr('x', 0)
                .attr('y', d => y(d.vendor_name))
                .attr('width', d => x(parseFloat(d.total_spend)))
                .attr('height', y.bandwidth())
                .attr('fill', colorPalette[0])
                .attr('rx', 4)
                .style('cursor', 'pointer')
                .on('mouseover', function(event, d) {
                    d3.select(this).attr('fill', colorPalette[1]);
                    tooltip.style('opacity', 1)
                        .html(`
                            <div><span class="tooltip-label">Vendor:</span><span class="tooltip-value">${d.vendor_name}</span></div>
                            <div><span class="tooltip-label">Total Spend:</span><span class="tooltip-value">$${parseFloat(d.total_spend).toLocaleString('en-US', {minimumFractionDigits: 2})}</span></div>
                            <div><span class="tooltip-label">PO Count:</span><span class="tooltip-value">${parseInt(d.po_count).toLocaleString()}</span></div>
                            <div class="text-xs text-slate-500 mt-1">Click to view POs</div>
                        `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    d3.select(this).attr('fill', colorPalette[0]);
                    tooltip.style('opacity', 0);
                })
                .on('click', function(event, d) {
                    drilldownVendor(d.vendor_name);
                });

            svg.append('g')
                .attr('class', 'axis')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x).ticks(4).tickFormat(d => '$' + (d / 1000).toFixed(0) + 'k'));

            svg.append('g')
                .attr('class', 'axis')
                .call(d3.axisLeft(y))
                .selectAll('text')
                .style('font-size', '10px')
                .text(d => d.length > 15 ? d.substring(0, 15) + '...' : d);

            debugLog(`Top vendors by spend chart rendered: ${data.length} vendors`, 'success');
        }

        function renderTopVendorsCountChart(data) {
            const container = document.getElementById('topVendorsCountChart');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-12 text-sm">No data available</p>';
                return;
            }

            const margin = { top: 10, right: 30, bottom: 30, left: 120 };
            const width = container.offsetWidth - margin.left - margin.right;
            const height = 280 - margin.top - margin.bottom;

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const x = d3.scaleLinear()
                .domain([0, d3.max(data, d => parseInt(d.po_count))])
                .nice()
                .range([0, width]);

            const y = d3.scaleBand()
                .domain(data.map(d => d.vendor_name))
                .range([0, height])
                .padding(0.2);

            svg.selectAll('.bar')
                .data(data)
                .enter()
                .append('rect')
                .attr('x', 0)
                .attr('y', d => y(d.vendor_name))
                .attr('width', d => x(parseInt(d.po_count)))
                .attr('height', y.bandwidth())
                .attr('fill', colorPalette[2])
                .attr('rx', 4)
                .style('cursor', 'pointer')
                .on('mouseover', function(event, d) {
                    d3.select(this).attr('fill', colorPalette[3]);
                    tooltip.style('opacity', 1)
                        .html(`
                            <div><span class="tooltip-label">Vendor:</span><span class="tooltip-value">${d.vendor_name}</span></div>
                            <div><span class="tooltip-label">PO Count:</span><span class="tooltip-value">${parseInt(d.po_count).toLocaleString()}</span></div>
                            <div><span class="tooltip-label">Total Spend:</span><span class="tooltip-value">$${parseFloat(d.total_spend).toLocaleString('en-US', {minimumFractionDigits: 2})}</span></div>
                        `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    d3.select(this).attr('fill', colorPalette[2]);
                    tooltip.style('opacity', 0);
                });

            svg.append('g')
                .attr('class', 'axis')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x).ticks(4));

            svg.append('g')
                .attr('class', 'axis')
                .call(d3.axisLeft(y))
                .selectAll('text')
                .style('font-size', '10px')
                .text(d => d.length > 15 ? d.substring(0, 15) + '...' : d);

            debugLog(`Top vendors by count chart rendered: ${data.length} vendors`, 'success');
        }

        function renderVendorOnTimeChart(data) {
            const container = document.getElementById('vendorOnTimeChart');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-12 text-sm">No data available</p>';
                return;
            }

            const margin = { top: 10, right: 30, bottom: 30, left: 120 };
            const width = container.offsetWidth - margin.left - margin.right;
            const height = 280 - margin.top - margin.bottom;

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const x = d3.scaleLinear()
                .domain([0, 100])
                .range([0, width]);

            const y = d3.scaleBand()
                .domain(data.map(d => d.vendor_name))
                .range([0, height])
                .padding(0.2);

            // Color scale for on-time performance
            const getColor = (percent) => {
                if (percent >= 90) return '#10b981'; // green
                if (percent >= 75) return '#f59e0b'; // orange
                return '#ef4444'; // red
            };

            svg.selectAll('.bar')
                .data(data)
                .enter()
                .append('rect')
                .attr('x', 0)
                .attr('y', d => y(d.vendor_name))
                .attr('width', d => x(parseFloat(d.on_time_percent)))
                .attr('height', y.bandwidth())
                .attr('fill', d => getColor(parseFloat(d.on_time_percent)))
                .attr('rx', 4)
                .style('cursor', 'pointer')
                .on('mouseover', function(event, d) {
                    d3.select(this).attr('opacity', 0.8);
                    tooltip.style('opacity', 1)
                        .html(`
                            <div><span class="tooltip-label">Vendor:</span><span class="tooltip-value">${d.vendor_name}</span></div>
                            <div><span class="tooltip-label">On-Time %:</span><span class="tooltip-value">${parseFloat(d.on_time_percent).toFixed(1)}%</span></div>
                            <div><span class="tooltip-label">On-Time Orders:</span><span class="tooltip-value">${parseInt(d.on_time_orders)} / ${parseInt(d.total_orders)}</span></div>
                        `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    d3.select(this).attr('opacity', 1);
                    tooltip.style('opacity', 0);
                });

            // Add percentage labels on bars
            svg.selectAll('.label')
                .data(data)
                .enter()
                .append('text')
                .attr('x', d => x(parseFloat(d.on_time_percent)) + 5)
                .attr('y', d => y(d.vendor_name) + y.bandwidth() / 2)
                .attr('dy', '0.35em')
                .style('font-size', '11px')
                .style('font-weight', 'bold')
                .style('fill', '#1e293b')
                .text(d => parseFloat(d.on_time_percent).toFixed(0) + '%');

            svg.append('g')
                .attr('class', 'axis')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x).ticks(5).tickFormat(d => d + '%'));

            svg.append('g')
                .attr('class', 'axis')
                .call(d3.axisLeft(y))
                .selectAll('text')
                .style('font-size', '10px')
                .text(d => d.length > 15 ? d.substring(0, 15) + '...' : d);

            debugLog(`Vendor on-time chart rendered: ${data.length} vendors`, 'success');
        }

        function renderTopProductsChart(data) {
            const container = document.getElementById('topProductsChart');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-12 text-sm">No data available</p>';
                return;
            }

            const margin = { top: 10, right: 30, bottom: 30, left: 100 };
            const width = container.offsetWidth - margin.left - margin.right;
            const height = 280 - margin.top - margin.bottom;

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const x = d3.scaleLinear()
                .domain([0, d3.max(data, d => parseFloat(d.total_qty))])
                .nice()
                .range([0, width]);

            const y = d3.scaleBand()
                .domain(data.map(d => d.part_num))
                .range([0, height])
                .padding(0.2);

            svg.selectAll('.bar')
                .data(data)
                .enter()
                .append('rect')
                .attr('x', 0)
                .attr('y', d => y(d.part_num))
                .attr('width', d => x(parseFloat(d.total_qty)))
                .attr('height', y.bandwidth())
                .attr('fill', colorPalette[5])
                .attr('rx', 4)
                .style('cursor', 'pointer')
                .on('mouseover', function(event, d) {
                    d3.select(this).attr('fill', colorPalette[6]);
                    tooltip.style('opacity', 1)
                        .html(`
                            <div><span class="tooltip-label">Part:</span><span class="tooltip-value">${d.part_num}</span></div>
                            <div><span class="tooltip-label">Description:</span><span class="tooltip-value">${d.part_description}</span></div>
                            <div><span class="tooltip-label">Quantity:</span><span class="tooltip-value">${parseFloat(d.total_qty).toLocaleString()}</span></div>
                            <div><span class="tooltip-label">Total Cost:</span><span class="tooltip-value">$${parseFloat(d.total_cost).toLocaleString('en-US', {minimumFractionDigits: 2})}</span></div>
                        `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    d3.select(this).attr('fill', colorPalette[5]);
                    tooltip.style('opacity', 0);
                });

            svg.append('g')
                .attr('class', 'axis')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x).ticks(4));

            svg.append('g')
                .attr('class', 'axis')
                .call(d3.axisLeft(y))
                .selectAll('text')
                .style('font-size', '10px');

            debugLog(`Top products chart rendered: ${data.length} products`, 'success');
        }

        function renderCategoryChart(data) {
            const container = document.getElementById('categoryChart');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-12 text-sm">No data available</p>';
                return;
            }

            const margin = { top: 10, right: 30, bottom: 30, left: 120 };
            const width = container.offsetWidth - margin.left - margin.right;
            const height = 280 - margin.top - margin.bottom;

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const x = d3.scaleLinear()
                .domain([0, d3.max(data, d => parseFloat(d.total_spend))])
                .nice()
                .range([0, width]);

            const y = d3.scaleBand()
                .domain(data.map(d => d.category_name))
                .range([0, height])
                .padding(0.2);

            svg.selectAll('.bar')
                .data(data)
                .enter()
                .append('rect')
                .attr('x', 0)
                .attr('y', d => y(d.category_name))
                .attr('width', d => x(parseFloat(d.total_spend)))
                .attr('height', y.bandwidth())
                .attr('fill', colorPalette[7])
                .attr('rx', 4)
                .style('cursor', 'pointer')
                .on('mouseover', function(event, d) {
                    d3.select(this).attr('fill', colorPalette[8]);
                    tooltip.style('opacity', 1)
                        .html(`
                            <div><span class="tooltip-label">Category:</span><span class="tooltip-value">${d.category_name}</span></div>
                            <div><span class="tooltip-label">Total Spend:</span><span class="tooltip-value">$${parseFloat(d.total_spend).toLocaleString('en-US', {minimumFractionDigits: 2})}</span></div>
                            <div><span class="tooltip-label">PO Count:</span><span class="tooltip-value">${parseInt(d.po_count).toLocaleString()}</span></div>
                            <div class="text-xs text-slate-500 mt-1">Click to view POs</div>
                        `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    d3.select(this).attr('fill', colorPalette[7]);
                    tooltip.style('opacity', 0);
                })
                .on('click', function(event, d) {
                    drilldownCategory(d.category_name);
                });

            svg.append('g')
                .attr('class', 'axis')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x).ticks(4).tickFormat(d => '$' + (d / 1000).toFixed(0) + 'k'));

            svg.append('g')
                .attr('class', 'axis')
                .call(d3.axisLeft(y))
                .selectAll('text')
                .style('font-size', '10px')
                .text(d => d.length > 15 ? d.substring(0, 15) + '...' : d);

            debugLog(`Category chart rendered: ${data.length} categories`, 'success');
        }

        function renderHighValueChart(data) {
            const container = document.getElementById('highValueChart');
            const metric = document.querySelector('#highValueMetric .text-4xl');
            metric.textContent = data.length;
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-400 py-8 text-sm">No high value POs found</div>';
                return;
            }

            const list = document.createElement('div');
            list.className = 'space-y-2 overflow-y-auto custom-scrollbar';
            list.style.maxHeight = '200px';

            data.forEach(po => {
                const item = document.createElement('div');
                item.className = 'p-2 bg-purple-50 rounded hover:bg-purple-100 transition-colors';
                item.innerHTML = `
                    <div class="flex justify-between text-sm">
                        <span class="font-semibold text-slate-700">PO ${po.po_num}</span>
                        <span class="text-purple-700 font-bold">$${parseFloat(po.po_value).toLocaleString('en-US', {maximumFractionDigits: 0})}</span>
                    </div>
                    <div class="flex justify-between text-xs text-slate-500 mt-1">
                        <span>${po.vendor_name}</span>
                        <span class="text-purple-600 font-medium">${moment(po.received_date).format('MMM D, YYYY')}</span>
                    </div>
                `;
                list.appendChild(item);
            });

            container.appendChild(list);
            debugLog(`High value POs: ${data.length}`, 'success');
        }

        function clearAllFilters() {
            document.getElementById('dateRangeFilter').value = 'current_fy';
            document.getElementById('vendorFilter').value = '%';
            document.getElementById('productCategoryFilter').value = '%';
            document.getElementById('abcCodeFilter').value = '%';
            document.getElementById('locationFilter').value = '%';
            customStartDate = null;
            customEndDate = null;
            document.getElementById('customStartDate').value = '';
            document.getElementById('customEndDate').value = '';
            document.getElementById('customDateRangeContainer').style.display = 'none';
            loadDashboard();
        }

        function applyDateRange() {
            const rangeValue = document.getElementById('dateRangeFilter').value;
            const customContainer = document.getElementById('customDateRangeContainer');

            if (rangeValue === 'custom') {
                customContainer.style.display = 'block';
                return;
            } else {
                customContainer.style.display = 'none';
            }

            currentDateRange = parseInt(rangeValue) || rangeValue;

            // Calculate customStartDate and customEndDate based on the range
            if (rangeValue === 'this_quarter') {
                const dates = getQuarterDates(0);
                customStartDate = dates.start;
                customEndDate = dates.end;
            } else if (rangeValue === 'last_quarter') {
                const dates = getQuarterDates(1);
                customStartDate = dates.start;
                customEndDate = dates.end;
            } else if (rangeValue === 'current_fy') {
                const dates = getFYDates(0);
                customStartDate = dates.start;
                customEndDate = dates.end;
            } else if (rangeValue === 'last_fy') {
                const dates = getFYDates(1);
                customStartDate = dates.start;
                customEndDate = dates.end;
            } else {
                // For numeric ranges (30, 60, 90, etc. days)
                const days = parseInt(rangeValue);
                if (!isNaN(days)) {
                    customEndDate = moment().format('YYYY-MM-DD');
                    customStartDate = moment().subtract(days, 'days').format('YYYY-MM-DD');
                } else {
                    customStartDate = null;
                    customEndDate = null;
                }
            }

            updateDateRangeDisplay();
            loadDashboard();
        }

        function applyCustomDateRange() {
            const startInput = document.getElementById('customStartDate');
            const endInput = document.getElementById('customEndDate');

            if (startInput.value && endInput.value) {
                customStartDate = startInput.value;
                customEndDate = endInput.value;
                currentDateRange = null;
                updateDateRangeDisplay();
                loadDashboard();
            }
        }

        function updateDateRangeDisplay() {
            const displayEl = document.getElementById('dateRangeDisplay');
            if (!displayEl) return;

            const rangeValue = document.getElementById('dateRangeFilter').value;
            let displayText = '';

            if (customStartDate && customEndDate) {
                displayText = `(${moment(customStartDate).format('D MMM YYYY')} - ${moment(customEndDate).format('D MMM YYYY')})`;
            } else if (rangeValue === 'this_quarter') {
                displayText = '(This Quarter)';
            } else if (rangeValue === 'last_quarter') {
                displayText = '(Last Quarter)';
            } else if (rangeValue === 'current_fy') {
                displayText = '(Current Financial Year)';
            } else if (rangeValue === 'last_fy') {
                displayText = '(Last Financial Year)';
            } else if (rangeValue) {
                displayText = `(Last ${rangeValue} Days)`;
            }

            displayEl.textContent = displayText;
        }

        function exportToCSV() {
            alert('Export functionality will be implemented in next chunk');
        }

        function escapeSQL(str) {
            if (typeof str !== 'string') return str;
            return str.replace(/'/g, "''");
        }

        let spendChartMode = 'line';

        function toggleSpendChartMode(mode) {
            spendChartMode = mode;

            const lineBtn = document.getElementById('spendLineBtn');
            const barBtn = document.getElementById('spendBarBtn');

            if (mode === 'line') {
                lineBtn.classList.add('bg-white', 'text-slate-800');
                lineBtn.classList.remove('text-slate-600');
                barBtn.classList.remove('bg-white', 'text-slate-800');
                barBtn.classList.add('text-slate-600');
            } else {
                barBtn.classList.add('bg-white', 'text-slate-800');
                barBtn.classList.remove('text-slate-600');
                lineBtn.classList.remove('bg-white', 'text-slate-800');
                lineBtn.classList.add('text-slate-600');
            }

            // Re-render the chart
            const monthlySpendData = getMonthlySpend();
            renderMonthlySpendChart(monthlySpendData);
        }

        function debugLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('debugLog');

            // Also log to console
            const prefix = type === 'error' ? '' : type === 'success' ? '' : '';
            console.log(`${prefix} [${timestamp}] ${message}`);

            if (!logDiv) return;

            // Clear initial message
            if (logDiv.querySelector('.italic')) {
                logDiv.innerHTML = '';
            }

            const colors = {
                'info': 'text-blue-400',
                'success': 'text-green-400',
                'warning': 'text-yellow-400',
                'error': 'text-red-400',
                'click': 'text-purple-400'
            };

            const entry = document.createElement('div');
            entry.className = 'mb-1';
            entry.innerHTML = `<span class="text-slate-500">[${timestamp}]</span> <span class="${colors[type] || colors.info}">${message}</span>`;

            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function toggleDebugConsole() {
            const content = document.getElementById('debugContent');
            const chevron = document.getElementById('debugChevron');

            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                chevron.style.transform = 'rotate(180deg)';
            } else {
                content.classList.add('hidden');
                chevron.style.transform = 'rotate(0deg)';
            }
        }

        function clearDebugLog() {
            const logDiv = document.getElementById('debugLog');
            logDiv.innerHTML = '<div class="text-slate-500 italic">Log cleared</div>';
        }

        // ============================================
        // Module Opening Functions
        // ============================================

        function openPurchaseOrder(poNumber) {
            openModule("Purchase Order", poNumber);
        }

        // ============================================
        // Drilldown Modal Functions
        // ============================================

        function openDrilldown(title, breadcrumb, data, columns) {
            if (!data || !Array.isArray(data)) {
                debugLog('openDrilldown called with invalid data', 'error');
                return;
            }
            debugLog(`Opening drilldown: "${title}" with ${data.length} rows`, 'info');
            currentDrilldownData = data;
            currentDrilldownColumns = columns;
            currentSortColumn = null;
            currentSortDirection = 'asc';

            document.getElementById('drilldownTitle').textContent = title;
            document.getElementById('drilldownBreadcrumb').textContent = breadcrumb;
            document.getElementById('drilldownSearch').value = '';

            renderDrilldownTable(data);

            const modal = document.getElementById('drilldownModal');
            modal.style.display = 'flex';
        }

        function closeDrilldown(event) {
            if (event && event.target !== event.currentTarget) return;

            debugLog('Closing drilldown modal', 'info');
            const modal = document.getElementById('drilldownModal');
            modal.style.display = 'none';
        }

        function renderDrilldownTable(data) {
            const thead = document.getElementById('drilldownTableHead');
            const tbody = document.getElementById('drilldownTableBody');

            // Render headers
            thead.innerHTML = '<tr>' + currentDrilldownColumns.map((col, idx) => `
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider cursor-pointer hover:bg-slate-100 transition-colors" onclick="sortDrilldownTable(${idx})">
                    <div class="flex items-center gap-2">
                        <span>${col.label}</span>
                        <svg class="w-3 h-3 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                        </svg>
                    </div>
                </th>
            `).join('') + '</tr>';

            // Render rows
            tbody.innerHTML = data.map((row, rowIndex) => {
                const isPORow = row.hasOwnProperty('po_num');
                const rowClass = isPORow ? 'hover:bg-indigo-50 cursor-pointer transition-colors' : 'hover:bg-slate-50 transition-colors';
                const rowClick = isPORow ? `onclick="togglePOLineItems(${rowIndex}, '${escapeSQL(row.po_num)}')"` : '';

                return `<tr class="${rowClass}" ${rowClick} data-row-index="${rowIndex}">` +
                    currentDrilldownColumns.map(col => {
                        let value = row[col.key];

                        // Format based on type
                        if (col.type === 'currency') {
                            value = '$' + parseFloat(value || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                        } else if (col.type === 'number') {
                            value = parseFloat(value || 0).toLocaleString('en-US');
                        } else if (col.type === 'percent') {
                            value = (parseFloat(value || 0) * 100).toFixed(1) + '%';
                        } else if (col.type === 'date') {
                            value = moment(value).format('D MMM YYYY');
                        } else if (col.format) {
                            value = col.format(value);
                        }

                        // Make PO numbers clickable
                        if (col.key === 'po_num' && value) {
                            value = `<a href="#" class="order-link" onclick="event.stopPropagation(); openPurchaseOrder('${escapeSQL(value)}'); return false;">${value}</a>`;
                        }

                        return `<td class="px-4 py-3 text-sm text-slate-700">${value || ''}</td>`;
                    }).join('') +
                `</tr>`;
            }).join('');
        }

        function togglePOLineItems(rowIndex, poNum) {
            const tbody = document.getElementById('drilldownTableBody');
            const existingExpanded = tbody.querySelector(`tr[data-expanded-for="${rowIndex}"]`);

            if (existingExpanded) {
                existingExpanded.remove();
                return;
            }

            // Query for PO line items
            const query = `
                SELECT
                    poitem.partnum as part_num,
                    poitem.description as part_description,
                    poitem.qtytofulfill as qty,
                    poitem.unitcost as unit_cost,
                    (poitem.qtytofulfill * poitem.unitcost) as line_total
                FROM po
                JOIN poitem ON poitem.poid = po.id
                WHERE po.num = '${escapeSQL(poNum)}'
                ORDER BY poitem.id ASC
            `;

            const queryResult = runQuery(query);
            const lineItems = queryResult ? JSON.parse(queryResult) : null;

            if (!lineItems || lineItems.length === 0) {
                alert('No line items found for this PO.');
                return;
            }

            // Create expanded row with line items table
            const targetRow = tbody.querySelector(`tr[data-row-index="${rowIndex}"]`);
            const expandedRow = document.createElement('tr');
            expandedRow.setAttribute('data-expanded-for', rowIndex);
            expandedRow.innerHTML = `
                <td colspan="${currentDrilldownColumns.length}" class="px-4 py-2 bg-slate-50 border-t border-b border-slate-200">
                    <div class="pl-8">
                        <div class="text-xs font-semibold text-slate-600 mb-2">Line Items for PO ${poNum}:</div>
                        <table class="w-full text-xs">
                            <thead>
                                <tr class="text-left text-slate-600">
                                    <th class="py-1">Part #</th>
                                    <th class="py-1">Description</th>
                                    <th class="py-1 text-right">Qty</th>
                                    <th class="py-1 text-right">Unit Cost</th>
                                    <th class="py-1 text-right">Line Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${lineItems.map(item => `
                                    <tr class="border-t border-slate-200">
                                        <td class="py-1 text-slate-700">${item.part_num || ''}</td>
                                        <td class="py-1 text-slate-700">${item.part_description || ''}</td>
                                        <td class="py-1 text-right text-slate-700">${parseFloat(item.qty || 0).toLocaleString()}</td>
                                        <td class="py-1 text-right text-slate-700">$${parseFloat(item.unit_cost || 0).toFixed(2)}</td>
                                        <td class="py-1 text-right text-slate-700">$${parseFloat(item.line_total || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </td>
            `;

            targetRow.insertAdjacentElement('afterend', expandedRow);
        }

        function filterDrilldownTable() {
            const searchValue = document.getElementById('drilldownSearch').value.toLowerCase();

            const filteredData = currentDrilldownData.filter(row =>
                currentDrilldownColumns.some(col =>
                    String(row[col.key] || '').toLowerCase().includes(searchValue)
                )
            );

            renderDrilldownTable(filteredData);
        }

        function sortDrilldownTable(columnIndex) {
            const column = currentDrilldownColumns[columnIndex];

            if (currentSortColumn === columnIndex) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = columnIndex;
                currentSortDirection = 'asc';
            }

            const sorted = [...currentDrilldownData].sort((a, b) => {
                let aVal = a[column.key];
                let bVal = b[column.key];

                // Convert to numbers if applicable
                if (column.type === 'currency' || column.type === 'number' || column.type === 'percent') {
                    aVal = parseFloat(aVal || 0);
                    bVal = parseFloat(bVal || 0);
                } else if (column.type === 'date') {
                    aVal = new Date(aVal);
                    bVal = new Date(bVal);
                }

                if (currentSortDirection === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });

            currentDrilldownData = sorted;
            renderDrilldownTable(sorted);
        }

        function exportDrilldownData() {
            if (!currentDrilldownData || currentDrilldownData.length === 0) {
                alert('No data to export');
                return;
            }

            // Create CSV content
            const headers = currentDrilldownColumns.map(col => col.label).join(',');
            const rows = currentDrilldownData.map(row =>
                currentDrilldownColumns.map(col => {
                    let value = row[col.key] || '';
                    // Escape commas and quotes
                    if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                        value = `"${value.replace(/"/g, '""')}"`;
                    }
                    return value;
                }).join(',')
            ).join('\n');

            const csv = headers + '\n' + rows;

            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `purchasing_drilldown_${moment().format('YYYY-MM-DD')}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // ============================================
        // Specific Drilldown Functions
        // ============================================

        function drilldownVendor(vendorName) {
            try {
                debugLog(`Drill-down: Vendor "${vendorName}"`, 'click');
                const conditions = buildFilterConditions();

                const query = `
                    SELECT
                        po.num as po_num,
                        po.dateIssued as po_date,
                        postpo.postdate as received_date,
                        SUM(postpoitem.postedtotalcost) as po_value,
                        postatus.name as status
                    FROM postpoitem
                    JOIN postpo ON postpoitem.postpoid = postpo.id
                    JOIN poitem ON postpoitem.poitemid = poitem.id
                    LEFT JOIN part ON poitem.partid = part.id
                    LEFT JOIN ProductToTree ON ProductToTree.ProductId = part.Id
                    LEFT JOIN ProductTree ON ProductTree.Id = ProductToTree.ProductTreeId
                    JOIN po ON poitem.poid = po.id
                    JOIN vendor ON po.vendorid = vendor.id
                    JOIN postatus ON po.statusid = postatus.id
                    JOIN locationgroup ON po.locationgroupid = locationgroup.id
                    ${conditions}
                    AND vendor.name = '${escapeSQL(vendorName)}'
                    GROUP BY po.num, po.dateIssued, postpo.postdate, postatus.name
                    ORDER BY postpo.postdate DESC
                `;

                const data = JSON.parse(runQuery(query));

                const columns = [
                    { key: 'po_num', label: 'PO #' },
                    { key: 'po_date', label: 'Issued', type: 'date' },
                    { key: 'received_date', label: 'Received', type: 'date' },
                    { key: 'po_value', label: 'Value', type: 'currency' },
                    { key: 'status', label: 'Status' }
                ];

                openDrilldown(
                    `POs from ${vendorName}`,
                    `Vendor: ${vendorName}`,
                    data,
                    columns
                );
            } catch (error) {
                debugLog(`ERROR in drilldownVendor: ${error.message}`, 'error');
            }
        }

        function drilldownCategory(categoryName) {
            try {
                debugLog(`Drill-down: Category "${categoryName}"`, 'click');
                const conditions = buildFilterConditions();

                const categoryCondition = categoryName === 'Uncategorized'
                    ? `AND (ProductTree.Name IS NULL OR ProductTree.Name = '')`
                    : `AND ProductTree.Name = '${escapeSQL(categoryName)}'`;

                const query = `
                    SELECT
                        po.num as po_num,
                        vendor.name as vendor_name,
                        postpo.postdate as received_date,
                        SUM(postpoitem.postedtotalcost) as po_value
                    FROM postpoitem
                    JOIN postpo ON postpoitem.postpoid = postpo.id
                    JOIN poitem ON postpoitem.poitemid = poitem.id
                    LEFT JOIN part ON poitem.partid = part.id
                    LEFT JOIN ProductToTree ON ProductToTree.ProductId = part.Id
                    LEFT JOIN ProductTree ON ProductTree.Id = ProductToTree.ProductTreeId
                    JOIN po ON poitem.poid = po.id
                    JOIN vendor ON po.vendorid = vendor.id
                    JOIN locationgroup ON po.locationgroupid = locationgroup.id
                    ${conditions}
                    ${categoryCondition}
                    GROUP BY po.num, vendor.name, postpo.postdate
                    ORDER BY po_value DESC
                `;

                const data = JSON.parse(runQuery(query));

                const columns = [
                    { key: 'po_num', label: 'PO #' },
                    { key: 'vendor_name', label: 'Vendor' },
                    { key: 'received_date', label: 'Received', type: 'date' },
                    { key: 'po_value', label: 'Value', type: 'currency' }
                ];

                openDrilldown(
                    `POs in ${categoryName}`,
                    `Category: ${categoryName}`,
                    data,
                    columns
                );
            } catch (error) {
                debugLog(`ERROR in drilldownCategory: ${error.message}`, 'error');
            }
        }

        function drilldownExpectedReceipts() {
            try {
                debugLog('Drill-down: Expected Receipts', 'click');
                const vendor = document.getElementById('vendorFilter').value;
                const productCategory = document.getElementById('productCategoryFilter').value;
                const abcCode = document.getElementById('abcCodeFilter').value;
                const location = document.getElementById('locationFilter').value;

                let conditions = `WHERE po.statusid IN (20, 30, 40)
                    AND poitem.dateScheduledFulfillment BETWEEN CURDATE() AND DATE_ADD(CURDATE(), INTERVAL 7 DAY)`;

                if (vendor !== '%') {
                    conditions += ` AND vendor.id = ${parseInt(vendor)}`;
                }
                if (productCategory !== '%') {
                    conditions += ` AND ProductTree.Name = '${escapeSQL(productCategory)}'`;
                }
                if (abcCode !== '%') {
                    conditions += ` AND part.abcCode = '${escapeSQL(abcCode)}'`;
                }
                if (location !== '%') {
                    conditions += ` AND locationgroup.id = ${parseInt(location)}`;
                }

                const query = `
                    SELECT
                        po.num as po_num,
                        vendor.name as vendor_name,
                        poitem.dateScheduledFulfillment as due_date,
                        DATEDIFF(poitem.dateScheduledFulfillment, CURDATE()) as days_until,
                        SUM(poitem.qtytofulfill * poitem.unitcost) as po_value,
                        postatus.name as status
                    FROM po
                    JOIN poitem ON poitem.poid = po.id
                    LEFT JOIN part ON poitem.partid = part.id
                    LEFT JOIN ProductToTree ON ProductToTree.ProductId = part.Id
                    LEFT JOIN ProductTree ON ProductTree.Id = ProductToTree.ProductTreeId
                    JOIN vendor ON po.vendorid = vendor.id
                    JOIN postatus ON po.statusid = postatus.id
                    JOIN locationgroup ON po.locationgroupid = locationgroup.id
                    ${conditions}
                    GROUP BY po.num, vendor.name, poitem.dateScheduledFulfillment, postatus.name
                    ORDER BY poitem.dateScheduledFulfillment
                `;

                const data = JSON.parse(runQuery(query));

                const columns = [
                    { key: 'po_num', label: 'PO #' },
                    { key: 'vendor_name', label: 'Vendor' },
                    { key: 'due_date', label: 'Due Date', type: 'date' },
                    { key: 'days_until', label: 'Days Until', type: 'number' },
                    { key: 'po_value', label: 'Value', type: 'currency' },
                    { key: 'status', label: 'Status' }
                ];

                openDrilldown(
                    'Expected Receipts (Next 7 Days)',
                    'Expected PO Receipts',
                    data,
                    columns
                );
            } catch (error) {
                debugLog(`ERROR in drilldownExpectedReceipts: ${error.message}`, 'error');
            }
        }

        function drilldownOverduePOs() {
            try {
                debugLog('Drill-down: Overdue POs', 'click');
                const vendor = document.getElementById('vendorFilter').value;
                const productCategory = document.getElementById('productCategoryFilter').value;
                const abcCode = document.getElementById('abcCodeFilter').value;
                const location = document.getElementById('locationFilter').value;

                let conditions = `WHERE po.statusid IN (20, 30, 40)
                    AND poitem.dateScheduledFulfillment < CURDATE()`;

                if (vendor !== '%') {
                    conditions += ` AND vendor.id = ${parseInt(vendor)}`;
                }
                if (productCategory !== '%') {
                    conditions += ` AND ProductTree.Name = '${escapeSQL(productCategory)}'`;
                }
                if (abcCode !== '%') {
                    conditions += ` AND part.abcCode = '${escapeSQL(abcCode)}'`;
                }
                if (location !== '%') {
                    conditions += ` AND locationgroup.id = ${parseInt(location)}`;
                }

                const query = `
                    SELECT
                        po.num as po_num,
                        vendor.name as vendor_name,
                        poitem.dateScheduledFulfillment as due_date,
                        DATEDIFF(CURDATE(), poitem.dateScheduledFulfillment) as days_overdue,
                        SUM(poitem.qtytofulfill * poitem.unitcost) as po_value,
                        postatus.name as status
                    FROM po
                    JOIN poitem ON poitem.poid = po.id
                    LEFT JOIN part ON poitem.partid = part.id
                    LEFT JOIN ProductToTree ON ProductToTree.ProductId = part.Id
                    LEFT JOIN ProductTree ON ProductTree.Id = ProductToTree.ProductTreeId
                    JOIN vendor ON po.vendorid = vendor.id
                    JOIN postatus ON po.statusid = postatus.id
                    JOIN locationgroup ON po.locationgroupid = locationgroup.id
                    ${conditions}
                    GROUP BY po.num, vendor.name, poitem.dateScheduledFulfillment, postatus.name
                    ORDER BY days_overdue DESC
                `;

                const data = JSON.parse(runQuery(query));

                const columns = [
                    { key: 'po_num', label: 'PO #' },
                    { key: 'vendor_name', label: 'Vendor' },
                    { key: 'due_date', label: 'Due Date', type: 'date' },
                    { key: 'days_overdue', label: 'Days Overdue', type: 'number' },
                    { key: 'po_value', label: 'Value', type: 'currency' },
                    { key: 'status', label: 'Status' }
                ];

                openDrilldown(
                    'Overdue Purchase Orders',
                    'Overdue POs',
                    data,
                    columns
                );
            } catch (error) {
                debugLog(`ERROR in drilldownOverduePOs: ${error.message}`, 'error');
            }
        }

        function drilldownRecentlyReceived() {
            try {
                debugLog('Drill-down: Recently Received', 'click');
                const conditions = buildFilterConditions();

                const query = `
                    SELECT
                        po.num as po_num,
                        vendor.name as vendor_name,
                        postpo.postdate as received_date,
                        SUM(postpoitem.postedtotalcost) as po_value,
                        postatus.name as status
                    FROM postpoitem
                    JOIN postpo ON postpoitem.postpoid = postpo.id
                    JOIN poitem ON postpoitem.poitemid = poitem.id
                    LEFT JOIN part ON poitem.partid = part.id
                    LEFT JOIN ProductToTree ON ProductToTree.ProductId = part.Id
                    LEFT JOIN ProductTree ON ProductTree.Id = ProductToTree.ProductTreeId
                    JOIN po ON poitem.poid = po.id
                    JOIN vendor ON po.vendorid = vendor.id
                    JOIN postatus ON po.statusid = postatus.id
                    JOIN locationgroup ON po.locationgroupid = locationgroup.id
                    ${conditions}
                    GROUP BY po.num, vendor.name, postpo.postdate, postatus.name
                    ORDER BY postpo.postdate DESC
                    LIMIT 100
                `;

                const data = JSON.parse(runQuery(query));

                const columns = [
                    { key: 'po_num', label: 'PO #' },
                    { key: 'vendor_name', label: 'Vendor' },
                    { key: 'received_date', label: 'Received Date', type: 'date' },
                    { key: 'po_value', label: 'Value', type: 'currency' },
                    { key: 'status', label: 'Status' }
                ];

                openDrilldown(
                    'Recently Received POs',
                    'Recently Received',
                    data,
                    columns
                );
            } catch (error) {
                debugLog(`ERROR in drilldownRecentlyReceived: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
