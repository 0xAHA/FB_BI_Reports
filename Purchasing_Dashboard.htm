<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchasing Dashboard - Fishbowl Advanced</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- D3.js v7 -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- Moment.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        /* Custom Brand Colors */
        :root {
            --color-primary: #2d9cdb;
            --color-primary-dark: #1e7bb4;
            --color-sidebar: #06162d;
            --color-sidebar-hover: #0a1f3d;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Override Tailwind indigo with custom blue */
        .bg-indigo-600 { background-color: var(--color-primary) !important; }
        .bg-indigo-50 { background-color: rgba(45, 156, 219, 0.1) !important; }
        .text-indigo-600 { color: var(--color-primary) !important; }
        .text-indigo-700 { color: var(--color-primary-dark) !important; }
        .border-indigo-200 { border-color: rgba(45, 156, 219, 0.3) !important; }
        .border-indigo-300 { border-color: rgba(45, 156, 219, 0.4) !important; }
        .hover\:text-indigo-600:hover { color: var(--color-primary) !important; }
        .hover\:bg-indigo-50:hover { background-color: rgba(45, 156, 219, 0.1) !important; }
        .hover\:bg-indigo-100:hover { background-color: rgba(45, 156, 219, 0.15) !important; }
        .focus\:ring-indigo-100:focus { --tw-ring-color: rgba(45, 156, 219, 0.2) !important; }
        .focus\:ring-indigo-500:focus { --tw-ring-color: var(--color-primary) !important; }
        .focus\:border-indigo-300:focus { border-color: rgba(45, 156, 219, 0.4) !important; }

        /* D3 Chart Styles */
        .axis line, .axis path {
            stroke: #cbd5e1;
            shape-rendering: crispEdges;
        }

        .axis text {
            fill: #64748b;
            font-size: 11px;
            font-weight: 500;
        }

        .grid line {
            stroke: #e2e8f0;
            stroke-opacity: 0.7;
            shape-rendering: crispEdges;
        }

        .line {
            fill: none;
            stroke-width: 2.5px;
        }

        .area {
            opacity: 0.3;
        }

        .tooltip {
            position: absolute;
            background: rgba(15, 23, 42, 0.95);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            max-width: 300px;
        }

        .tooltip-label {
            color: #94a3b8;
            display: inline-block;
            min-width: 90px;
            font-weight: 500;
        }

        .tooltip-value {
            color: #ffffff;
            font-weight: 600;
            margin-left: 8px;
        }

        /* Loading spinner */
        .spinner {
            border: 3px solid #f1f5f9;
            border-top: 3px solid var(--color-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Status color coding */
        .status-issued { fill: #3b82f6; }
        .status-partial { fill: #f59e0b; }
        .status-fulfilled { fill: #10b981; }
        .status-overdue { fill: #ef4444; }
    </style>
</head>
<body class="bg-slate-50">
    <div class="flex flex-col h-screen">
        <!-- Header -->
        <header class="h-20 bg-white border-b border-slate-200 px-8 flex items-center justify-between flex-shrink-0 z-20 shadow-sm">
            <div class="flex items-center gap-6">
                <div>
                    <h1 class="text-xl font-bold text-slate-900">
                        Purchasing Dashboard
                        <span id="dateRangeDisplay" class="text-sm font-normal text-slate-500 ml-2"></span>
                    </h1>
                    <p class="text-xs text-slate-500 mt-0.5">Purchase orders, vendor performance, and spend analytics</p>
                </div>

                <!-- KPI Summary in Header -->
                <div id="kpiCards" class="hidden lg:flex items-center gap-3">
                    <!-- Will be populated dynamically -->
                </div>
            </div>

            <div class="flex items-center gap-3">
                <!-- Export Button -->
                <button onclick="exportToCSV()" class="px-3 py-2 bg-slate-100 hover:bg-slate-200 border border-slate-300 rounded-lg text-sm font-medium transition-colors" title="Export CSV">
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Export
                </button>

                <!-- Refresh Button -->
                <button onclick="loadDashboard()" class="p-2.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-xl transition-all" title="Refresh Data">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                </button>
            </div>
        </header>

        <!-- Content Area -->
        <div class="flex-1 overflow-y-auto custom-scrollbar p-4 lg:p-8">
            <!-- Filters Section -->
            <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-4 mb-4">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-base font-bold text-slate-800 flex items-center gap-2">
                        <svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                        </svg>
                        <span>Filters</span>
                        <button onclick="clearAllFilters()" class="ml-2 px-2 py-1 text-xs text-slate-500 hover:text-red-600 hover:bg-red-50 rounded transition-colors flex items-center gap-1" title="Clear All Filters">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            Clear
                        </button>
                    </h3>
                </div>

                <!-- Filter Controls -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-3">
                    <!-- Date Range Filter -->
                    <div>
                        <label class="block text-[11px] font-semibold text-slate-600 mb-1.5">Date Range</label>
                        <select id="dateRangeFilter" onchange="applyDateRange()" class="w-full px-2.5 py-1.5 text-xs border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300">
                            <option value="30">Last 30 Days</option>
                            <option value="60">Last 60 Days</option>
                            <option value="90" selected>Last 90 Days</option>
                            <option value="180">Last 180 Days</option>
                            <option value="365">Last Year</option>
                            <option value="this_quarter">This Quarter</option>
                            <option value="last_quarter">Last Quarter</option>
                            <option value="current_fy">Current Financial Year</option>
                            <option value="last_fy">Last Financial Year</option>
                            <option value="custom">Custom Date Range</option>
                        </select>
                    </div>

                    <!-- Vendor Filter -->
                    <div>
                        <label class="block text-[11px] font-semibold text-slate-600 mb-1.5">Vendor</label>
                        <select id="vendorFilter" onchange="loadDashboard()" class="w-full px-2.5 py-1.5 text-xs border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300">
                            <option value="%">All Vendors</option>
                        </select>
                    </div>

                    <!-- Product Category Filter -->
                    <div>
                        <label class="block text-[11px] font-semibold text-slate-600 mb-1.5">Product Category</label>
                        <select id="productCategoryFilter" onchange="loadDashboard()" class="w-full px-2.5 py-1.5 text-xs border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300">
                            <option value="%">All Categories</option>
                        </select>
                    </div>

                    <!-- ABC Code Filter -->
                    <div>
                        <label class="block text-[11px] font-semibold text-slate-600 mb-1.5">ABC Code</label>
                        <select id="abcCodeFilter" onchange="loadDashboard()" class="w-full px-2.5 py-1.5 text-xs border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300">
                            <option value="%">All</option>
                            <option value="A">A - High Value</option>
                            <option value="B">B - Medium Value</option>
                            <option value="C">C - Low Value</option>
                            <option value="N">N - None</option>
                        </select>
                    </div>

                    <!-- Location Group Filter -->
                    <div>
                        <label class="block text-[11px] font-semibold text-slate-600 mb-1.5">Location</label>
                        <select id="locationFilter" onchange="loadDashboard()" class="w-full px-2.5 py-1.5 text-xs border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300">
                            <option value="%">All Locations</option>
                        </select>
                    </div>
                </div>

                <!-- Custom Date Range (Hidden by default) -->
                <div id="customDateRangeContainer" class="mt-3 p-3 bg-slate-50 rounded-lg border border-slate-200" style="display: none;">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-[11px] font-semibold text-slate-600 mb-1.5">Start Date</label>
                            <input type="date" id="customStartDate" class="w-full px-2.5 py-1.5 text-xs border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300">
                        </div>
                        <div>
                            <label class="block text-[11px] font-semibold text-slate-600 mb-1.5">End Date</label>
                            <input type="date" id="customEndDate" class="w-full px-2.5 py-1.5 text-xs border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300">
                        </div>
                    </div>
                    <button onclick="applyCustomDateRange()" class="mt-2 px-3 py-1.5 bg-indigo-600 text-white text-xs font-medium rounded-lg hover:bg-indigo-700 transition-colors">Apply Date Range</button>
                </div>
            </div>

            <!-- Dashboard Content -->
            <div id="dashboardContent">
                <!-- Row 1: Main Chart + Status Overview -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mt-4">
                    <!-- Monthly PO Spend Trend (2-col span) -->
                    <div class="lg:col-span-2 bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-slate-800">Monthly PO Spend Trend</h3>
                            <div class="flex gap-2">
                                <button id="spendLineBtn" onclick="toggleSpendChartMode('line')" class="px-3 py-1 text-xs font-medium rounded bg-white text-slate-800 border border-slate-300">Line</button>
                                <button id="spendBarBtn" onclick="toggleSpendChartMode('bar')" class="px-3 py-1 text-xs font-medium rounded text-slate-600 border border-slate-300">Bar</button>
                            </div>
                        </div>
                        <div id="monthlySpendChart"></div>
                    </div>

                    <!-- PO Status Overview -->
                    <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                        <h3 class="text-lg font-bold text-slate-800 mb-4">PO Status Overview</h3>
                        <div id="poStatusChart"></div>
                    </div>
                </div>

                <!-- Row 2: Upcoming & Alerts (PRIORITIZED) -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mt-4">
                    <!-- Expected Receipts This Week -->
                    <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h3 class="text-lg font-bold text-slate-800">Expected Receipts</h3>
                                <p class="text-xs text-slate-500">Next 7 days</p>
                            </div>
                            <div id="expectedReceiptsMetric" class="text-right">
                                <div class="text-4xl font-bold text-blue-600">-</div>
                                <div class="text-xs text-slate-500 mt-1">POs</div>
                            </div>
                        </div>
                        <div id="expectedReceiptsChart"></div>
                    </div>

                    <!-- Overdue POs -->
                    <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h3 class="text-lg font-bold text-slate-800">Overdue POs</h3>
                                <p class="text-xs text-slate-500">Past due date</p>
                            </div>
                            <div id="overduePOsMetric" class="text-right">
                                <div class="text-4xl font-bold text-red-600">-</div>
                                <div class="text-xs text-slate-500 mt-1">POs</div>
                            </div>
                        </div>
                        <div id="overduePOsChart"></div>
                    </div>

                    <!-- Recently Received -->
                    <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h3 class="text-lg font-bold text-slate-800">Recently Received</h3>
                                <p class="text-xs text-slate-500">Last 10 receipts</p>
                            </div>
                            <div id="recentlyReceivedMetric" class="text-right">
                                <div class="text-4xl font-bold text-green-600">-</div>
                                <div class="text-xs text-slate-500 mt-1">POs</div>
                            </div>
                        </div>
                        <div id="recentlyReceivedChart"></div>
                    </div>
                </div>

                <!-- Row 3: Vendor Performance -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mt-4">
                    <!-- Top Vendors by Spend -->
                    <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                        <h3 class="text-lg font-bold text-slate-800 mb-4">Top Vendors by Spend</h3>
                        <div id="topVendorsSpendChart"></div>
                    </div>

                    <!-- Top Vendors by PO Count -->
                    <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                        <h3 class="text-lg font-bold text-slate-800 mb-4">Top Vendors by PO Count</h3>
                        <div id="topVendorsCountChart"></div>
                    </div>

                    <!-- Vendor On-Time Performance -->
                    <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                        <h3 class="text-lg font-bold text-slate-800 mb-4">Vendor On-Time %</h3>
                        <div id="vendorOnTimeChart"></div>
                    </div>
                </div>

                <!-- Row 4: Product & Analytics -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mt-4">
                    <!-- Top Products by Quantity -->
                    <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                        <h3 class="text-lg font-bold text-slate-800 mb-4">Top Products by Qty</h3>
                        <div id="topProductsChart"></div>
                    </div>

                    <!-- Purchases by Category -->
                    <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                        <h3 class="text-lg font-bold text-slate-800 mb-4">Purchases by Category</h3>
                        <div id="categoryChart"></div>
                    </div>

                    <!-- Average Lead Time -->
                    <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                        <div class="flex flex-col h-full justify-center items-center text-center">
                            <h3 class="text-lg font-bold text-slate-800 mb-2">Average Lead Time</h3>
                            <p class="text-xs text-slate-500 mb-4">From issue to receipt</p>
                            <div id="avgLeadTimeMetric" class="text-6xl font-bold text-indigo-600">-</div>
                            <div class="text-sm text-slate-600 mt-2">days</div>
                        </div>
                    </div>
                </div>

                <!-- Row 5: Financial -->
                <div class="grid grid-cols-1 gap-4 mt-4">
                    <!-- High Value POs -->
                    <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h3 class="text-lg font-bold text-slate-800">High Value POs</h3>
                                <p class="text-xs text-slate-500">Orders over $10,000</p>
                            </div>
                            <div id="highValueMetric" class="text-right">
                                <div class="text-4xl font-bold text-purple-600">-</div>
                                <div class="text-xs text-slate-500 mt-1">POs</div>
                            </div>
                        </div>
                        <div id="highValueChart"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-xl p-8 flex flex-col items-center gap-4">
            <div class="spinner"></div>
            <p class="text-slate-700 font-semibold">Loading purchasing data...</p>
        </div>
    </div>

    <script>
        // Global variables
        let currentDateRange = 90;
        let customStartDate = null;
        let customEndDate = null;

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', function() {
            console.log('Purchasing Dashboard initializing...');
            loadFilters();
            loadDashboard();
        });

        // Placeholder functions - will be implemented in next chunks
        function loadFilters() {
            console.log('Loading filters...');
            // TODO: Implement filter loading
        }

        function loadDashboard() {
            console.log('Loading dashboard...');
            // TODO: Implement dashboard loading
        }

        function clearAllFilters() {
            document.getElementById('dateRangeFilter').value = '90';
            document.getElementById('vendorFilter').value = '%';
            document.getElementById('productCategoryFilter').value = '%';
            document.getElementById('abcCodeFilter').value = '%';
            document.getElementById('locationFilter').value = '%';
            customStartDate = null;
            customEndDate = null;
            document.getElementById('customStartDate').value = '';
            document.getElementById('customEndDate').value = '';
            document.getElementById('customDateRangeContainer').style.display = 'none';
            loadDashboard();
        }

        function applyDateRange() {
            const rangeValue = document.getElementById('dateRangeFilter').value;
            const customContainer = document.getElementById('customDateRangeContainer');

            if (rangeValue === 'custom') {
                customContainer.style.display = 'block';
                return;
            } else {
                customContainer.style.display = 'none';
            }

            currentDateRange = parseInt(rangeValue) || rangeValue;
            customStartDate = null;
            customEndDate = null;
            updateDateRangeDisplay();
            loadDashboard();
        }

        function applyCustomDateRange() {
            const startInput = document.getElementById('customStartDate');
            const endInput = document.getElementById('customEndDate');

            if (startInput.value && endInput.value) {
                customStartDate = startInput.value;
                customEndDate = endInput.value;
                currentDateRange = null;
                updateDateRangeDisplay();
                loadDashboard();
            }
        }

        function updateDateRangeDisplay() {
            const displayEl = document.getElementById('dateRangeDisplay');
            if (!displayEl) return;

            const rangeValue = document.getElementById('dateRangeFilter').value;
            let displayText = '';

            if (customStartDate && customEndDate) {
                displayText = `(${moment(customStartDate).format('D MMM YYYY')} - ${moment(customEndDate).format('D MMM YYYY')})`;
            } else if (rangeValue === 'this_quarter') {
                displayText = '(This Quarter)';
            } else if (rangeValue === 'last_quarter') {
                displayText = '(Last Quarter)';
            } else if (rangeValue === 'current_fy') {
                displayText = '(Current Financial Year)';
            } else if (rangeValue === 'last_fy') {
                displayText = '(Last Financial Year)';
            } else if (rangeValue) {
                displayText = `(Last ${rangeValue} Days)`;
            }

            displayEl.textContent = displayText;
        }

        function exportToCSV() {
            alert('Export functionality will be implemented in next chunk');
        }

        function escapeSQL(str) {
            if (typeof str !== 'string') return str;
            return str.replace(/'/g, "''");
        }

        let spendChartMode = 'line';

        function toggleSpendChartMode(mode) {
            spendChartMode = mode;

            const lineBtn = document.getElementById('spendLineBtn');
            const barBtn = document.getElementById('spendBarBtn');

            if (mode === 'line') {
                lineBtn.classList.add('bg-white', 'text-slate-800');
                lineBtn.classList.remove('text-slate-600');
                barBtn.classList.remove('bg-white', 'text-slate-800');
                barBtn.classList.add('text-slate-600');
            } else {
                barBtn.classList.add('bg-white', 'text-slate-800');
                barBtn.classList.remove('text-slate-600');
                lineBtn.classList.remove('bg-white', 'text-slate-800');
                lineBtn.classList.add('text-slate-600');
            }

            // Re-render the chart - will be implemented in next chunk
            console.log('Chart mode changed to:', mode);
        }

        function debugLog(message, type = 'info') {
            const prefix = type === 'error' ? '❌' : type === 'success' ? '✅' : 'ℹ️';
            console.log(`${prefix} [${new Date().toLocaleTimeString()}] ${message}`);
        }
    </script>
</body>
</html>
