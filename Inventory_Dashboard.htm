<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Dashboard - Fishbowl Advanced</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- D3.js v7 -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- Moment.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #f8fafc;
        }

        /* Custom Brand Colors (matching Gantt v3) */
        :root {
            --color-primary: #2d9cdb;
            --color-primary-dark: #1e7bb4;
            --color-sidebar: #06162d;
            --color-sidebar-hover: #0a1f3d;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Override Tailwind colors with custom brand */
        .bg-indigo-600 { background-color: var(--color-primary) !important; }
        .bg-indigo-50 { background-color: rgba(45, 156, 219, 0.1) !important; }
        .text-indigo-600 { color: var(--color-primary) !important; }
        .text-indigo-700 { color: var(--color-primary-dark) !important; }
        .border-indigo-200 { border-color: rgba(45, 156, 219, 0.3) !important; }
        .hover\:bg-indigo-50:hover { background-color: rgba(45, 156, 219, 0.1) !important; }

        /* Chart containers */
        .chart-container {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
        }

        /* D3 Chart Styles */
        .axis line, .axis path {
            stroke: #cbd5e1;
            shape-rendering: crispEdges;
        }

        .axis text {
            fill: #64748b;
            font-size: 11px;
            font-weight: 500;
        }

        .grid line {
            stroke: #e2e8f0;
            stroke-opacity: 0.7;
            shape-rendering: crispEdges;
        }

        .line {
            fill: none;
            stroke-width: 2.5px;
        }

        .area {
            opacity: 0.3;
        }

        .tooltip {
            position: absolute;
            background: rgba(15, 23, 42, 0.95);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            max-width: 280px;
        }

        .tooltip-label {
            color: #94a3b8;
            display: inline-block;
            min-width: 100px;
            font-weight: 500;
        }

        .tooltip-value {
            color: #ffffff;
            font-weight: 600;
            margin-left: 8px;
        }

        .legend-item {
            display: inline-flex;
            align-items: center;
            margin-right: 16px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .legend-item:hover {
            background-color: #f1f5f9;
        }

        .legend-color {
            width: 20px;
            height: 4px;
            border-radius: 2px;
            margin-right: 8px;
        }

        .kpi-card {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            border-left: 4px solid;
        }

        /* Loading spinner */
        .spinner {
            border: 3px solid #f1f5f9;
            border-top: 3px solid var(--color-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Button styles */
        .btn-primary {
            background-color: var(--color-primary);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
        }

        .btn-primary:hover {
            background-color: var(--color-primary-dark);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        .btn-secondary {
            background-color: white;
            color: #475569;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            border: 1px solid #cbd5e1;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background-color: #f8fafc;
            border-color: var(--color-primary);
            color: var(--color-primary);
        }
    </style>
</head>
<body class="custom-scrollbar">
    <!-- Main Container -->
    <div class="min-h-screen bg-slate-50">
        <!-- Header -->
        <div class="bg-white shadow-sm border-b border-slate-200">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold text-slate-900">üìä Inventory Dashboard</h1>
                        <p class="text-sm text-slate-600 mt-1">Real-time inventory analytics and insights</p>
                    </div>
                    <div class="flex gap-3">
                        <button id="exportBtn" class="btn-secondary">
                            <span>üì• Export CSV</span>
                        </button>
                        <button id="refreshBtn" class="btn-primary">
                            <span>üîÑ Refresh</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="max-w-7xl mx-auto px-6 py-6">
            <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                <h3 class="text-lg font-semibold text-slate-900 mb-4">üìå Filters</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <!-- Date Range -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Date Range</label>
                        <select id="dateRangeFilter" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="30">Last 30 Days</option>
                            <option value="60">Last 60 Days</option>
                            <option value="90" selected>Last 90 Days</option>
                            <option value="180">Last 6 Months</option>
                            <option value="365">Last Year</option>
                        </select>
                    </div>

                    <!-- Location Group -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Location Group</label>
                        <select id="locationGroupFilter" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="%">All Locations</option>
                        </select>
                    </div>

                    <!-- Part Type -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Part Type</label>
                        <select id="partTypeFilter" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="%">All Types</option>
                            <option value="10">Inventory</option>
                            <option value="12">Non-Inventory</option>
                            <option value="21">Serialized</option>
                        </select>
                    </div>

                    <!-- Tracking Type -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Tracking</label>
                        <select id="trackingFilter" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="%">All</option>
                            <option value="10">Quantity</option>
                            <option value="20">Serial Number</option>
                            <option value="30">Lot Number</option>
                            <option value="40">Revision/Serial</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- KPI Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                <div class="kpi-card" style="border-color: #3b82f6;">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-slate-600">Total Inventory Value</p>
                            <p id="kpiTotalValue" class="text-3xl font-bold text-slate-900 mt-2">$0</p>
                            <p id="kpiValueChange" class="text-xs text-slate-500 mt-1">vs previous period</p>
                        </div>
                        <div class="text-4xl">üí∞</div>
                    </div>
                </div>

                <div class="kpi-card" style="border-color: #10b981;">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-slate-600">Active Parts</p>
                            <p id="kpiPartCount" class="text-3xl font-bold text-slate-900 mt-2">0</p>
                            <p id="kpiPartChange" class="text-xs text-slate-500 mt-1">unique SKUs</p>
                        </div>
                        <div class="text-4xl">üì¶</div>
                    </div>
                </div>

                <div class="kpi-card" style="border-color: #f59e0b;">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-slate-600">Total Quantity</p>
                            <p id="kpiTotalQty" class="text-3xl font-bold text-slate-900 mt-2">0</p>
                            <p id="kpiQtyChange" class="text-xs text-slate-500 mt-1">units on hand</p>
                        </div>
                        <div class="text-4xl">üìä</div>
                    </div>
                </div>

                <div class="kpi-card" style="border-color: #ef4444;">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-slate-600">Below Reorder</p>
                            <p id="kpiReorder" class="text-3xl font-bold text-slate-900 mt-2">0</p>
                            <p id="kpiReorderChange" class="text-xs text-slate-500 mt-1">items need ordering</p>
                        </div>
                        <div class="text-4xl">‚ö†Ô∏è</div>
                    </div>
                </div>
            </div>

            <!-- Charts Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Stock Value Over Time -->
                <div class="chart-container">
                    <h3 class="text-lg font-semibold text-slate-900 mb-4">üìà Stock Value Over Time</h3>
                    <div id="valueChart" style="height: 300px;"></div>
                </div>

                <!-- Stock Levels by Location -->
                <div class="chart-container">
                    <h3 class="text-lg font-semibold text-slate-900 mb-4">üìç Stock Levels by Location</h3>
                    <div id="locationChart" style="height: 300px;"></div>
                </div>
            </div>

            <!-- Bottom Row Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Top Parts by Value -->
                <div class="chart-container">
                    <h3 class="text-lg font-semibold text-slate-900 mb-4">üèÜ Top Parts by Value</h3>
                    <div id="topPartsChart" style="height: 280px;"></div>
                </div>

                <!-- Stock Movement Trend -->
                <div class="chart-container">
                    <h3 class="text-lg font-semibold text-slate-900 mb-4">üîÑ Stock Movement (In/Out)</h3>
                    <div id="movementChart" style="height: 280px;"></div>
                </div>

                <!-- Availability Status -->
                <div class="chart-container">
                    <h3 class="text-lg font-semibold text-slate-900 mb-4">‚úÖ Availability Status</h3>
                    <div id="statusChart" style="height: 280px;"></div>
                </div>
            </div>

            <!-- Loading Overlay -->
            <div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 9999; align-items: center; justify-content: center;">
                <div style="background: white; padding: 2rem; border-radius: 1rem; text-align: center;">
                    <div class="spinner mx-auto mb-4"></div>
                    <p class="text-slate-700 font-medium">Loading dashboard data...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tooltip -->
    <div id="tooltip" class="tooltip"></div>

    <script>
        // ============================================
        // Global Variables
        // ============================================
        let inventoryData = [];
        let locationData = [];
        let movementData = [];
        let filteredData = [];

        const tooltip = d3.select('#tooltip');

        // Color palette (matching Gantt v3 theme)
        const colorPalette = [
            '#2d9cdb', '#3b82f6', '#10b981', '#f59e0b', '#ef4444',
            '#8b5cf6', '#ec4899', '#14b8a6', '#f97316', '#06b6d4'
        ];

        // ============================================
        // Fishbowl SQL Queries
        // ============================================
        function getInventoryValueOverTime() {
            const days = parseInt(document.getElementById('dateRangeFilter').value);
            const locationGroup = document.getElementById('locationGroupFilter').value;
            const partType = document.getElementById('partTypeFilter').value;
            const tracking = document.getElementById('trackingFilter').value;

            let lgCondition = locationGroup !== '%' ? `AND lg.id = ${locationGroup}` : '';
            let typeCondition = partType !== '%' ? `AND p.typeid = ${partType}` : '';
            let trackCondition = tracking !== '%' ? `AND p.trackingTypeId = ${tracking}` : '';

            const query = `
                SELECT
                    DATE(il.dateCreated) as date,
                    SUM(il.qtyOnHand * COALESCE(p.stdCost, 0)) as total_value,
                    SUM(il.qtyOnHand) as total_qty,
                    COUNT(DISTINCT p.id) as part_count
                FROM inventorylog il
                JOIN part p ON il.partId = p.id
                JOIN location loc ON il.locationId = loc.id
                JOIN locationgroup lg ON loc.locationGroupId = lg.id
                WHERE il.dateCreated >= DATE_SUB(NOW(), INTERVAL ${days} DAY)
                    AND p.activeflag = 1
                    ${lgCondition}
                    ${typeCondition}
                    ${trackCondition}
                GROUP BY DATE(il.dateCreated)
                ORDER BY date ASC
            `;

            console.log('Value Over Time Query:', query);
            return JSON.parse(runQuery(query));
        }

        function getStockByLocation() {
            const days = parseInt(document.getElementById('dateRangeFilter').value);
            const locationGroup = document.getElementById('locationGroupFilter').value;
            const partType = document.getElementById('partTypeFilter').value;

            let lgCondition = locationGroup !== '%' ? `AND lg.id = ${locationGroup}` : '';
            let typeCondition = partType !== '%' ? `AND p.typeid = ${partType}` : '';

            const query = `
                SELECT
                    lg.name as location,
                    DATE(il.dateCreated) as date,
                    SUM(il.qtyOnHand) as qty
                FROM inventorylog il
                JOIN part p ON il.partId = p.id
                JOIN location loc ON il.locationId = loc.id
                JOIN locationgroup lg ON loc.locationGroupId = lg.id
                WHERE il.dateCreated >= DATE_SUB(NOW(), INTERVAL ${days} DAY)
                    AND p.activeflag = 1
                    ${lgCondition}
                    ${typeCondition}
                GROUP BY lg.name, DATE(il.dateCreated)
                ORDER BY lg.name, date ASC
            `;

            console.log('Stock by Location Query:', query);
            return JSON.parse(runQuery(query));
        }

        function getTopPartsByValue() {
            const locationGroup = document.getElementById('locationGroupFilter').value;
            let lgCondition = locationGroup !== '%' ? `AND lg.id = ${locationGroup}` : '';

            const query = `
                SELECT
                    p.num as part_num,
                    p.description,
                    SUM(qoh.qty * COALESCE(p.stdCost, 0)) as total_value,
                    SUM(qoh.qty) as total_qty
                FROM part p
                JOIN qtyonhand qoh ON p.id = qoh.partid
                JOIN locationgroup lg ON qoh.locationgroupid = lg.id
                WHERE p.activeflag = 1
                    ${lgCondition}
                GROUP BY p.id, p.num, p.description
                HAVING total_value > 0
                ORDER BY total_value DESC
                LIMIT 10
            `;

            console.log('Top Parts Query:', query);
            return JSON.parse(runQuery(query));
        }

        function getAvailabilityStatus() {
            const locationGroup = document.getElementById('locationGroupFilter').value;
            let lgCondition = locationGroup !== '%' ? `AND qit.locationgroupid = ${locationGroup}` : '';

            const query = `
                SELECT
                    'Available' as status,
                    SUM(qit.qtyavailable) as qty
                FROM qtyinventorytotals qit
                WHERE 1=1 ${lgCondition}
                UNION ALL
                SELECT
                    'Committed' as status,
                    SUM(qc.qty) as qty
                FROM qtycommitted qc
                WHERE 1=1 ${lgCondition.replace('qit', 'qc')}
                UNION ALL
                SELECT
                    'Allocated' as status,
                    SUM(qa.qty) as qty
                FROM qtyallocated qa
                WHERE 1=1 ${lgCondition.replace('qit', 'qa')}
                UNION ALL
                SELECT
                    'Not Available' as status,
                    SUM(qna.qty) as qty
                FROM qtynotavailable qna
                WHERE 1=1 ${lgCondition.replace('qit', 'qna')}
            `;

            console.log('Availability Query:', query);
            return JSON.parse(runQuery(query));
        }

        function getKPIMetrics() {
            const locationGroup = document.getElementById('locationGroupFilter').value;
            let lgCondition = locationGroup !== '%' ? `AND lg.id = ${locationGroup}` : '';

            const query = `
                SELECT
                    SUM(qoh.qty * COALESCE(p.stdCost, 0)) as total_value,
                    COUNT(DISTINCT p.id) as part_count,
                    SUM(qoh.qty) as total_qty,
                    SUM(CASE
                        WHEN qoh.qty < COALESCE(pr.reorderpoint, 0)
                        AND pr.reorderpoint IS NOT NULL
                        THEN 1 ELSE 0
                    END) as below_reorder
                FROM part p
                JOIN qtyonhand qoh ON p.id = qoh.partid
                JOIN locationgroup lg ON qoh.locationgroupid = lg.id
                LEFT JOIN partreorder pr ON p.id = pr.partid AND qoh.locationgroupid = pr.locationgroupid
                WHERE p.activeflag = 1
                    ${lgCondition}
            `;

            console.log('KPI Query:', query);
            return JSON.parse(runQuery(query));
        }

        function loadLocationGroups() {
            const query = `SELECT id, name FROM locationgroup WHERE activeflag = 1 ORDER BY name`;
            const locations = JSON.parse(runQuery(query));

            const selector = document.getElementById('locationGroupFilter');
            selector.innerHTML = '<option value="%">All Locations</option>';

            locations.forEach(lg => {
                selector.innerHTML += `<option value="${lg.id}">${lg.name}</option>`;
            });
        }

        // ============================================
        // Chart Rendering Functions
        // ============================================

        function renderValueOverTimeChart(data) {
            const container = document.getElementById('valueChart');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-12">No data available</p>';
                return;
            }

            const margin = { top: 20, right: 30, bottom: 40, left: 70 };
            const width = container.offsetWidth - margin.left - margin.right;
            const height = 300 - margin.top - margin.bottom;

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            // Scales
            const x = d3.scaleTime()
                .domain(d3.extent(data, d => new Date(d.date)))
                .range([0, width]);

            const y = d3.scaleLinear()
                .domain([0, d3.max(data, d => parseFloat(d.total_value))])
                .nice()
                .range([height, 0]);

            // Grid
            svg.append('g')
                .attr('class', 'grid')
                .attr('opacity', 0.1)
                .call(d3.axisLeft(y).tickSize(-width).tickFormat(''));

            // Area
            const area = d3.area()
                .x(d => x(new Date(d.date)))
                .y0(height)
                .y1(d => y(parseFloat(d.total_value)));

            svg.append('path')
                .datum(data)
                .attr('class', 'area')
                .attr('d', area)
                .attr('fill', colorPalette[0]);

            // Line
            const line = d3.line()
                .x(d => x(new Date(d.date)))
                .y(d => y(parseFloat(d.total_value)));

            svg.append('path')
                .datum(data)
                .attr('class', 'line')
                .attr('d', line)
                .attr('stroke', colorPalette[0]);

            // Points
            svg.selectAll('.dot')
                .data(data)
                .enter()
                .append('circle')
                .attr('cx', d => x(new Date(d.date)))
                .attr('cy', d => y(parseFloat(d.total_value)))
                .attr('r', 4)
                .attr('fill', 'white')
                .attr('stroke', colorPalette[0])
                .attr('stroke-width', 2)
                .on('mouseover', function(event, d) {
                    d3.select(this).attr('r', 6);
                    tooltip.style('opacity', 1)
                        .html(`
                            <div><span class="tooltip-label">Date:</span><span class="tooltip-value">${moment(d.date).format('MMM D, YYYY')}</span></div>
                            <div><span class="tooltip-label">Value:</span><span class="tooltip-value">$${parseFloat(d.total_value).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span></div>
                            <div><span class="tooltip-label">Quantity:</span><span class="tooltip-value">${parseFloat(d.total_qty).toLocaleString()}</span></div>
                            <div><span class="tooltip-label">Parts:</span><span class="tooltip-value">${d.part_count}</span></div>
                        `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    d3.select(this).attr('r', 4);
                    tooltip.style('opacity', 0);
                });

            // Axes
            svg.append('g')
                .attr('class', 'axis')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x).ticks(6).tickFormat(d3.timeFormat('%b %d')));

            svg.append('g')
                .attr('class', 'axis')
                .call(d3.axisLeft(y).ticks(5).tickFormat(d => '$' + d3.format('.2s')(d)));
        }

        function renderLocationChart(data) {
            const container = document.getElementById('locationChart');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-12">No data available</p>';
                return;
            }

            // Group data by location
            const grouped = d3.group(data, d => d.location);
            const locations = Array.from(grouped.keys());

            const margin = { top: 20, right: 120, bottom: 40, left: 60 };
            const width = container.offsetWidth - margin.left - margin.right;
            const height = 300 - margin.top - margin.bottom;

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            // Scales
            const x = d3.scaleTime()
                .domain(d3.extent(data, d => new Date(d.date)))
                .range([0, width]);

            const y = d3.scaleLinear()
                .domain([0, d3.max(data, d => parseFloat(d.qty))])
                .nice()
                .range([height, 0]);

            // Grid
            svg.append('g')
                .attr('class', 'grid')
                .attr('opacity', 0.1)
                .call(d3.axisLeft(y).tickSize(-width).tickFormat(''));

            // Line generator
            const line = d3.line()
                .x(d => x(new Date(d.date)))
                .y(d => y(parseFloat(d.qty)));

            // Draw lines for each location
            locations.forEach((location, i) => {
                const locationData = grouped.get(location);
                const color = colorPalette[i % colorPalette.length];

                svg.append('path')
                    .datum(locationData)
                    .attr('class', 'line')
                    .attr('d', line)
                    .attr('stroke', color);
            });

            // Axes
            svg.append('g')
                .attr('class', 'axis')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x).ticks(6).tickFormat(d3.timeFormat('%b %d')));

            svg.append('g')
                .attr('class', 'axis')
                .call(d3.axisLeft(y).ticks(5));

            // Legend
            const legend = svg.append('g')
                .attr('transform', `translate(${width + 10}, 0)`);

            locations.forEach((location, i) => {
                const legendRow = legend.append('g')
                    .attr('transform', `translate(0, ${i * 22})`);

                legendRow.append('rect')
                    .attr('width', 18)
                    .attr('height', 4)
                    .attr('fill', colorPalette[i % colorPalette.length]);

                legendRow.append('text')
                    .attr('x', 24)
                    .attr('y', 4)
                    .attr('text-anchor', 'start')
                    .style('font-size', '11px')
                    .style('fill', '#64748b')
                    .text(location);
            });
        }

        function renderTopPartsChart(data) {
            const container = document.getElementById('topPartsChart');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-12">No data available</p>';
                return;
            }

            const margin = { top: 20, right: 30, bottom: 60, left: 100 };
            const width = container.offsetWidth - margin.left - margin.right;
            const height = 280 - margin.top - margin.bottom;

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            // Scales
            const x = d3.scaleLinear()
                .domain([0, d3.max(data, d => parseFloat(d.total_value))])
                .nice()
                .range([0, width]);

            const y = d3.scaleBand()
                .domain(data.map(d => d.part_num))
                .range([0, height])
                .padding(0.2);

            // Bars
            svg.selectAll('.bar')
                .data(data)
                .enter()
                .append('rect')
                .attr('class', 'bar')
                .attr('x', 0)
                .attr('y', d => y(d.part_num))
                .attr('width', d => x(parseFloat(d.total_value)))
                .attr('height', y.bandwidth())
                .attr('fill', colorPalette[0])
                .attr('rx', 4)
                .on('mouseover', function(event, d) {
                    d3.select(this).attr('fill', colorPalette[1]);
                    tooltip.style('opacity', 1)
                        .html(`
                            <div><span class="tooltip-label">Part:</span><span class="tooltip-value">${d.part_num}</span></div>
                            <div><span class="tooltip-label">Description:</span><span class="tooltip-value">${d.description}</span></div>
                            <div><span class="tooltip-label">Value:</span><span class="tooltip-value">$${parseFloat(d.total_value).toLocaleString('en-US', {minimumFractionDigits: 2})}</span></div>
                            <div><span class="tooltip-label">Quantity:</span><span class="tooltip-value">${parseFloat(d.total_qty).toLocaleString()}</span></div>
                        `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    d3.select(this).attr('fill', colorPalette[0]);
                    tooltip.style('opacity', 0);
                });

            // Axes
            svg.append('g')
                .attr('class', 'axis')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x).ticks(4).tickFormat(d => '$' + d3.format('.2s')(d)));

            svg.append('g')
                .attr('class', 'axis')
                .call(d3.axisLeft(y));
        }

        function renderStatusChart(data) {
            const container = document.getElementById('statusChart');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-12">No data available</p>';
                return;
            }

            const width = 280;
            const height = 280;
            const radius = Math.min(width, height) / 2;

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height)
                .append('g')
                .attr('transform', `translate(${width / 2},${height / 2})`);

            const color = d3.scaleOrdinal()
                .domain(data.map(d => d.status))
                .range([colorPalette[2], colorPalette[3], colorPalette[4], colorPalette[5]]);

            const pie = d3.pie()
                .value(d => parseFloat(d.qty))
                .sort(null);

            const arc = d3.arc()
                .innerRadius(radius * 0.5)
                .outerRadius(radius * 0.8);

            const arcs = svg.selectAll('.arc')
                .data(pie(data))
                .enter()
                .append('g')
                .attr('class', 'arc');

            arcs.append('path')
                .attr('d', arc)
                .attr('fill', d => color(d.data.status))
                .attr('stroke', 'white')
                .attr('stroke-width', 2)
                .on('mouseover', function(event, d) {
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr('d', d3.arc().innerRadius(radius * 0.5).outerRadius(radius * 0.85));

                    tooltip.style('opacity', 1)
                        .html(`
                            <div><span class="tooltip-label">Status:</span><span class="tooltip-value">${d.data.status}</span></div>
                            <div><span class="tooltip-label">Quantity:</span><span class="tooltip-value">${parseFloat(d.data.qty).toLocaleString()}</span></div>
                        `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr('d', arc);
                    tooltip.style('opacity', 0);
                });

            // Legend
            const legend = svg.append('g')
                .attr('transform', `translate(${-radius * 0.4},${radius + 30})`);

            data.forEach((d, i) => {
                const legendRow = legend.append('g')
                    .attr('transform', `translate(0, ${i * 20})`);

                legendRow.append('rect')
                    .attr('width', 12)
                    .attr('height', 12)
                    .attr('fill', color(d.status));

                legendRow.append('text')
                    .attr('x', 18)
                    .attr('y', 10)
                    .attr('text-anchor', 'start')
                    .style('font-size', '11px')
                    .style('fill', '#64748b')
                    .text(d.status);
            });
        }

        function renderMovementChart() {
            // Placeholder for movement chart
            const container = document.getElementById('movementChart');
            container.innerHTML = '<p class="text-center text-slate-500 py-12">Movement data coming soon</p>';
        }

        function updateKPIs(data) {
            if (!data || data.length === 0) return;

            const metrics = data[0];
            document.getElementById('kpiTotalValue').textContent =
                '$' + parseFloat(metrics.total_value || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});

            document.getElementById('kpiPartCount').textContent =
                (metrics.part_count || 0).toLocaleString();

            document.getElementById('kpiTotalQty').textContent =
                parseFloat(metrics.total_qty || 0).toLocaleString();

            document.getElementById('kpiReorder').textContent =
                (metrics.below_reorder || 0).toLocaleString();
        }

        // ============================================
        // Data Loading and Refresh
        // ============================================
        function loadDashboard() {
            const loading = document.getElementById('loadingOverlay');
            loading.style.display = 'flex';

            try {
                // Load KPIs
                const kpiData = getKPIMetrics();
                updateKPIs(kpiData);

                // Load charts
                const valueData = getInventoryValueOverTime();
                renderValueOverTimeChart(valueData);

                const locationData = getStockByLocation();
                renderLocationChart(locationData);

                const topPartsData = getTopPartsByValue();
                renderTopPartsChart(topPartsData);

                const statusData = getAvailabilityStatus();
                renderStatusChart(statusData);

                renderMovementChart();

            } catch (error) {
                console.error('Error loading dashboard:', error);
                alert('Error loading dashboard data. Please check console for details.');
            } finally {
                loading.style.display = 'none';
            }
        }

        function exportToCSV() {
            try {
                const kpiData = getKPIMetrics();
                const topPartsData = getTopPartsByValue();

                // Build CSV header
                let csv = 'Inventory Dashboard Export - ' + moment().format('YYYY-MM-DD HH:mm:ss') + '\n\n';

                // KPI Summary
                csv += 'Key Metrics\n';
                csv += 'Metric,Value\n';
                if (kpiData && kpiData.length > 0) {
                    const metrics = kpiData[0];
                    csv += `Total Inventory Value,$${parseFloat(metrics.total_value || 0).toFixed(2)}\n`;
                    csv += `Active Parts,${metrics.part_count || 0}\n`;
                    csv += `Total Quantity,${parseFloat(metrics.total_qty || 0).toFixed(2)}\n`;
                    csv += `Below Reorder Point,${metrics.below_reorder || 0}\n`;
                }

                csv += '\n\nTop Parts by Value\n';
                csv += 'Part Number,Description,Total Value,Quantity\n';
                topPartsData.forEach(part => {
                    csv += `"${part.part_num}","${(part.description || '').replace(/"/g, '""')}",`;
                    csv += `${parseFloat(part.total_value).toFixed(2)},${parseFloat(part.total_qty).toFixed(2)}\n`;
                });

                // Create download link
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);

                link.setAttribute('href', url);
                link.setAttribute('download', 'Inventory_Dashboard_' + moment().format('YYYY-MM-DD_HHmmss') + '.csv');
                link.style.visibility = 'hidden';

                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                console.log('CSV export completed successfully');
            } catch (error) {
                console.error('Error exporting CSV:', error);
                alert('Error exporting CSV. Please check console for details.');
            }
        }

        // ============================================
        // Event Listeners
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            loadLocationGroups();
            loadDashboard();

            // Filter change handlers
            document.getElementById('dateRangeFilter').addEventListener('change', loadDashboard);
            document.getElementById('locationGroupFilter').addEventListener('change', loadDashboard);
            document.getElementById('partTypeFilter').addEventListener('change', loadDashboard);
            document.getElementById('trackingFilter').addEventListener('change', loadDashboard);

            // Button handlers
            document.getElementById('refreshBtn').addEventListener('click', loadDashboard);
            document.getElementById('exportBtn').addEventListener('click', exportToCSV);

            // Window resize handler
            let resizeTimeout;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(loadDashboard, 250);
            });
        });
    </script>
</body>
</html>
