<!DOCTYPE html>
<html lang="en">
<head>
    {% Template Inventory_Watch_List %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Availability by Location Group</title>
    <style>
        table.dataTable {
            width: 100% !important;
            table-layout: fixed;
        }
        table.dataTable thead th.dt-center,
        table.dataTable thead td.dt-center {
            text-align: center;
        }
        table.dataTable tbody td.dt-center {
            text-align: center;
        }
        table.dataTable tbody td {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        table.dataTable tbody td.dt-right {
            text-align: right;
        }
        .group-header {
            background-color: #e8e8e8 !important;
            font-weight: bold;
            font-size: 13px;
            padding: 10px !important;
            border-top: 2px solid #ccc;
        }
        .subgroup-header {
            background-color: #f5f5f5 !important;
            font-weight: bold;
            font-style: italic;
            font-size: 11px;
            padding: 8px !important;
            padding-left: 20px !important;
        }
    </style>
</head>
<body>
    <div class="overflowHidden" style="position: relative; height: 100%; width: 100%">
        <div id="headerContainer" style="float: left;">
            <h1>Inventory Availability by Location Group</h1>
        </div>
        <div id="bodyContainer">
            <div id="body">
                <table id="report-table" class="display" style="width:100%"></table>
            </div>
        </div>
    </div>
    <script>
    let locationGroupId = '$LG{Location_Group|%|General}';
    locationGroupId = (locationGroupId == -1 || locationGroupId == '' || !locationGroupId) ? '%' : locationGroupId;

    let dataset;

    function getData() {
        let lgCondition = locationGroupId !== '%'
            ? `AND locationgroup.id = ${locationGroupId}`
            : '';

        let query = `SELECT
            part.num AS PART,
            part.description AS DESCRIPTION,
            uom.code AS UOMCODE,
            locationgroup.name AS LG,
            locationgroup.id AS LGID,
            COALESCE(qtyonhand.qty, 0) AS QTY,
            COALESCE(qtyonorder.qty, 0) AS ONORDER,
            COALESCE(NULLIF(CustomFieldByName(part.customfields, 'Medicine'), ''), 'false') AS MEDICINES,
            CustomFieldByName(part.customfields, 'Inv Assets') AS INVASSETS
        FROM part
            CROSS JOIN locationgroup
            LEFT JOIN uom ON part.uomid = uom.id
            LEFT JOIN qtyonorder ON qtyonorder.partid = part.id
                AND qtyonorder.locationgroupid = locationgroup.id
            LEFT JOIN qtyonhand ON qtyonhand.partid = part.id
                AND qtyonhand.locationgroupid = locationgroup.id
        WHERE part.id != 0
            AND part.typeid = 10
            AND part.activeflag = 1
            AND locationgroup.activeflag = 1
            ${lgCondition}
        HAVING (QTY + ONORDER) > 0
        ORDER BY locationgroup.name, MEDICINES DESC, INVASSETS, part.num`;

        console.log('Executing query:', query);
        console.log('Location Group ID:', locationGroupId);
        let dataset = JSON.parse(runQuery(query));
        console.log('Query results:', dataset);
        console.log('First row:', dataset && dataset.length > 0 ? dataset[0] : 'No data');
        return dataset;
    }

    function drawTable() {
        dataset = getData();

        // Insert location group, medicine, and asset type header rows
        let groupedData = [];
        let currentLG = null;
        let currentMedicine = null;
        let currentAssetType = null;

        dataset.forEach(function(row) {
            // Location Group header
            if (row.LG !== currentLG) {
                currentLG = row.LG;
                currentMedicine = null;
                currentAssetType = null;
                groupedData.push({
                    isLocationGroupHeader: true,
                    LG: currentLG
                });
            }

            // Medicine group header
            if (row.MEDICINES !== currentMedicine) {
                currentMedicine = row.MEDICINES;
                currentAssetType = null;
                groupedData.push({
                    isMedicineHeader: true,
                    MEDICINES: currentMedicine
                });
            }

            // Asset type subgroup header
            let assetType = row.INVASSETS == null || row.INVASSETS === '' || row.INVASSETS === 'Inventory'
                ? 'Inventory Assets'
                : row.INVASSETS;

            if (assetType !== currentAssetType) {
                currentAssetType = assetType;
                groupedData.push({
                    isAssetTypeHeader: true,
                    INVASSETS: currentAssetType
                });
            }

            groupedData.push(row);
        });

        let table = $('#report-table');
        table.empty();

        $(window).on('resize scroll', function() {
            table.columns.adjust();
        });

        table.DataTable({
            dom: 'B<"clear">lfrtip',
            data: groupedData,
            ordering: false,
            autoWidth: false,
            pageLength: 100,
            columns: [
                {
                    title: 'Part',
                    data: 'PART',
                    defaultContent: '',
                    width: '12%',
                    render: function(data, type, row) {
                        if (row.isLocationGroupHeader) return row.LG;
                        if (row.isMedicineHeader) return row.MEDICINES === 'true' ? 'Medicine Items' : 'Non-Medicine Items';
                        if (row.isAssetTypeHeader) return row.INVASSETS;
                        if (type === 'display') {
                            return '<strong style="color: #000099;">' + data + '</strong>';
                        }
                        return data;
                    },
                    createdCell: function(td, cellData, rowData, row, col) {
                        if (rowData.isLocationGroupHeader) {
                            $(td).attr('colspan', 5);
                            $(td).addClass('group-header');
                            $(td).nextAll().remove();
                        } else if (rowData.isMedicineHeader) {
                            $(td).attr('colspan', 5);
                            $(td).addClass('group-header');
                            $(td).nextAll().remove();
                        } else if (rowData.isAssetTypeHeader) {
                            $(td).attr('colspan', 5);
                            $(td).addClass('subgroup-header');
                            $(td).nextAll().remove();
                        }
                    }
                },
                {
                    title: 'Description',
                    data: 'DESCRIPTION',
                    defaultContent: '',
                    width: '50%',
                    render: function(data, type, row) {
                        if (row.isLocationGroupHeader || row.isMedicineHeader || row.isAssetTypeHeader) return '';
                        return data;
                    }
                },
                {
                    title: 'UOM',
                    data: 'UOMCODE',
                    defaultContent: '',
                    width: '8%',
                    className: 'dt-center',
                    render: function(data, type, row) {
                        if (row.isLocationGroupHeader || row.isMedicineHeader || row.isAssetTypeHeader) return '';
                        return data;
                    }
                },
                {
                    title: 'On Hand',
                    data: 'QTY',
                    defaultContent: '',
                    width: '15%',
                    className: 'dt-right',
                    render: function(data, type, row) {
                        if (row.isLocationGroupHeader || row.isMedicineHeader || row.isAssetTypeHeader) return '';
                        if (type === 'display') {
                            return parseFloat(data).toFixed(2);
                        }
                        return data;
                    }
                },
                {
                    title: 'On Order',
                    data: 'ONORDER',
                    defaultContent: '',
                    width: '15%',
                    className: 'dt-right',
                    render: function(data, type, row) {
                        if (row.isLocationGroupHeader || row.isMedicineHeader || row.isAssetTypeHeader) return '';
                        if (type === 'display') {
                            return parseFloat(data).toFixed(2);
                        }
                        return data;
                    }
                }
            ],
            fixedHeader: true,
            colReorder: false,
            pagingType: 'simple',
            responsive: false,
            deferRender: true,
            buttons: ['csv'],
            language: {
                paginate: {
                    previous: 'PREV',
                    next: 'NEXT'
                }
            }
        });
    }

    $(document).ready(function() {
        drawTable();
        $(".dt-buttons").addClass("csv-button-margin");
    });

    const displayHeader = $CHECK{Display_header|true};
    let headerContainer = document.getElementById('headerContainer');
    displayHeader ? headerContainer.style.display = 'block' : headerContainer.style.display = 'none';

    </script>
</body>
</html>
