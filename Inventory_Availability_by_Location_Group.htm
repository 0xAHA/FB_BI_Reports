<!DOCTYPE html>
<html lang="en">
<head>
    {% Template Inventory_Watch_List %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Availability by Location Group</title>
    <style>
        table.dataTable {
            width: 100% !important;
            table-layout: fixed;
        }
        table.dataTable thead th.dt-center,
        table.dataTable thead td.dt-center {
            text-align: center;
        }
        table.dataTable tbody td.dt-center {
            text-align: center;
        }
        table.dataTable tbody td {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        table.dataTable tbody td.dt-right {
            text-align: right;
        }
        .group-header {
            background-color: #e8e8e8 !important;
            font-weight: bold;
            font-size: 13px;
            padding: 10px !important;
            border-top: 2px solid #ccc;
        }
        .subgroup-header {
            background-color: #f5f5f5 !important;
            font-weight: bold;
            font-style: italic;
            font-size: 11px;
            padding: 8px !important;
            padding-left: 20px !important;
        }
    </style>
</head>
<body>
    <div class="overflowHidden" style="position: relative; height: 100%; width: 100%">
        <div id="headerContainer" style="float: left;">
            <h1>Inventory Availability by Location Group</h1>
        </div>
        <div id="bodyContainer">
            <div id="body">
                <div style="margin-bottom: 10px;">
                    <button onclick="toggleDebug()" style="padding: 5px 10px; cursor: pointer;">Toggle Debug</button>
                </div>
                <div id="debugPanel" style="display: none; background-color: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 6px; font-family: monospace; font-size: 12px; margin-bottom: 20px; max-height: 400px; overflow-y: auto;">
                    <h3 style="margin-top: 0; color: #4dabf7;">Debug Output</h3>
                    <div id="debugOutput"></div>
                </div>
                <table id="report-table" class="display" style="width:100%"></table>
            </div>
        </div>
    </div>
    <script>
    let locationGroupId = '$LG{Location_Group|%|General}';
    locationGroupId = (locationGroupId == -1 || locationGroupId == '' || !locationGroupId) ? '%' : locationGroupId;

    let dataset;

    function toggleDebug() {
        let panel = document.getElementById('debugPanel');
        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }

    function debugLog(label, data) {
        let output = document.getElementById('debugOutput');
        let entry = document.createElement('div');
        entry.style.marginBottom = '15px';
        entry.style.paddingBottom = '15px';
        entry.style.borderBottom = '1px solid #444';

        let labelDiv = document.createElement('div');
        labelDiv.style.color = '#4dabf7';
        labelDiv.style.fontWeight = 'bold';
        labelDiv.textContent = label;
        entry.appendChild(labelDiv);

        let dataDiv = document.createElement('pre');
        dataDiv.style.marginTop = '5px';
        dataDiv.style.whiteSpace = 'pre-wrap';
        dataDiv.style.wordWrap = 'break-word';

        if (typeof data === 'object') {
            dataDiv.textContent = JSON.stringify(data, null, 2);
        } else {
            dataDiv.textContent = data;
        }
        entry.appendChild(dataDiv);

        output.appendChild(entry);
    }

    function getData() {
        let lgCondition = locationGroupId !== '%'
            ? `AND locationgroup.id = ${locationGroupId}`
            : '';

        let query = `SELECT
            part.num AS PART,
            part.description AS DESCRIPTION,
            uom.code AS UOMCODE,
            locationgroup.name AS LG,
            locationgroup.id AS LGID,
            COALESCE(qtyonhand.qty, 0) AS QTY,
            COALESCE(qtyonorder.qty, 0) AS ONORDER,
            COALESCE(NULLIF(CustomFieldByName(part.customfields, 'Medicine'), ''), 'false') AS MEDICINES,
            CustomFieldByName(part.customfields, 'Inv Assets') AS INVASSETS
        FROM part
            CROSS JOIN locationgroup
            LEFT JOIN uom ON part.uomid = uom.id
            LEFT JOIN qtyonorder ON qtyonorder.partid = part.id
                AND qtyonorder.locationgroupid = locationgroup.id
            LEFT JOIN qtyonhand ON qtyonhand.partid = part.id
                AND qtyonhand.locationgroupid = locationgroup.id
        WHERE part.id != 0
            AND part.typeid = 10
            AND part.activeflag = 1
            AND locationgroup.activeflag = 1
            ${lgCondition}
        HAVING (QTY + ONORDER) > 0
        ORDER BY locationgroup.name, MEDICINES DESC, INVASSETS, part.num`;

        debugLog('Location Group ID', locationGroupId);
        debugLog('Executing Query', query);

        let dataset = JSON.parse(runQuery(query));

        debugLog('Row Count', dataset ? dataset.length : 0);
        debugLog('First Row', dataset && dataset.length > 0 ? dataset[0] : 'No data');
        debugLog('All Results (first 5)', dataset ? dataset.slice(0, 5) : 'No data');

        return dataset;
    }

    function drawTable() {
        dataset = getData();

        // Insert location group, medicine, and asset type header rows
        let groupedData = [];
        let currentLG = null;
        let currentMedicine = null;
        let currentAssetType = null;

        dataset.forEach(function(row) {
            // Location Group header
            if (row.lg !== currentLG) {
                currentLG = row.lg;
                currentMedicine = null;
                currentAssetType = null;
                groupedData.push({
                    isLocationGroupHeader: true,
                    lg: currentLG
                });
            }

            // Medicine group header
            if (row.medicines !== currentMedicine) {
                currentMedicine = row.medicines;
                currentAssetType = null;
                groupedData.push({
                    isMedicineHeader: true,
                    medicines: currentMedicine
                });
            }

            // Asset type subgroup header
            let assetType = row.invassets == null || row.invassets === '' || row.invassets === 'Inventory'
                ? 'Inventory Assets'
                : row.invassets;

            if (assetType !== currentAssetType) {
                currentAssetType = assetType;
                groupedData.push({
                    isAssetTypeHeader: true,
                    invassets: currentAssetType
                });
            }

            groupedData.push(row);
        });

        let table = $('#report-table');
        table.empty();

        $(window).on('resize scroll', function() {
            table.columns.adjust();
        });

        table.DataTable({
            dom: 'B<"clear">lfrtip',
            data: groupedData,
            ordering: false,
            autoWidth: false,
            pageLength: 100,
            columns: [
                {
                    title: 'Part',
                    data: 'part',
                    defaultContent: '',
                    width: '12%',
                    render: function(data, type, row) {
                        if (row.isLocationGroupHeader) return row.lg;
                        if (row.isMedicineHeader) return row.medicines === 'true' ? 'Medicine Items' : 'Non-Medicine Items';
                        if (row.isAssetTypeHeader) return row.invassets;
                        if (type === 'display') {
                            return '<strong style="color: #000099;">' + data + '</strong>';
                        }
                        return data;
                    },
                    createdCell: function(td, cellData, rowData, row, col) {
                        if (rowData.isLocationGroupHeader) {
                            $(td).attr('colspan', 5);
                            $(td).addClass('group-header');
                            $(td).nextAll().remove();
                        } else if (rowData.isMedicineHeader) {
                            $(td).attr('colspan', 5);
                            $(td).addClass('group-header');
                            $(td).nextAll().remove();
                        } else if (rowData.isAssetTypeHeader) {
                            $(td).attr('colspan', 5);
                            $(td).addClass('subgroup-header');
                            $(td).nextAll().remove();
                        }
                    }
                },
                {
                    title: 'Description',
                    data: 'description',
                    defaultContent: '',
                    width: '50%',
                    render: function(data, type, row) {
                        if (row.isLocationGroupHeader || row.isMedicineHeader || row.isAssetTypeHeader) return '';
                        return data;
                    }
                },
                {
                    title: 'UOM',
                    data: 'uomcode',
                    defaultContent: '',
                    width: '8%',
                    className: 'dt-center',
                    render: function(data, type, row) {
                        if (row.isLocationGroupHeader || row.isMedicineHeader || row.isAssetTypeHeader) return '';
                        return data;
                    }
                },
                {
                    title: 'On Hand',
                    data: 'qty',
                    defaultContent: '',
                    width: '15%',
                    className: 'dt-right',
                    render: function(data, type, row) {
                        if (row.isLocationGroupHeader || row.isMedicineHeader || row.isAssetTypeHeader) return '';
                        if (type === 'display') {
                            return parseFloat(data).toFixed(2);
                        }
                        return data;
                    }
                },
                {
                    title: 'On Order',
                    data: 'onorder',
                    defaultContent: '',
                    width: '15%',
                    className: 'dt-right',
                    render: function(data, type, row) {
                        if (row.isLocationGroupHeader || row.isMedicineHeader || row.isAssetTypeHeader) return '';
                        if (type === 'display') {
                            return parseFloat(data).toFixed(2);
                        }
                        return data;
                    }
                }
            ],
            fixedHeader: true,
            colReorder: false,
            pagingType: 'simple',
            responsive: false,
            deferRender: true,
            buttons: ['csv'],
            language: {
                paginate: {
                    previous: 'PREV',
                    next: 'NEXT'
                }
            }
        });
    }

    $(document).ready(function() {
        drawTable();
        $(".dt-buttons").addClass("csv-button-margin");
    });

    const displayHeader = $CHECK{Display_header|true};
    let headerContainer = document.getElementById('headerContainer');
    displayHeader ? headerContainer.style.display = 'block' : headerContainer.style.display = 'none';

    </script>
</body>
</html>
