<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Dashboard - Fishbowl Advanced</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- D3.js v7 -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- Moment.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        /* Custom Brand Colors (matching Gantt v3) */
        :root {
            --color-primary: #2d9cdb;
            --color-primary-dark: #1e7bb4;
            --color-sidebar: #06162d;
            --color-sidebar-hover: #0a1f3d;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Override Tailwind indigo with custom blue */
        .bg-indigo-600 { background-color: var(--color-primary) !important; }
        .bg-indigo-50 { background-color: rgba(45, 156, 219, 0.1) !important; }
        .text-indigo-600 { color: var(--color-primary) !important; }
        .text-indigo-700 { color: var(--color-primary-dark) !important; }
        .border-indigo-200 { border-color: rgba(45, 156, 219, 0.3) !important; }
        .border-indigo-300 { border-color: rgba(45, 156, 219, 0.4) !important; }
        .hover\:text-indigo-600:hover { color: var(--color-primary) !important; }
        .hover\:bg-indigo-50:hover { background-color: rgba(45, 156, 219, 0.1) !important; }
        .hover\:bg-indigo-100:hover { background-color: rgba(45, 156, 219, 0.15) !important; }
        .focus\:ring-indigo-100:focus { --tw-ring-color: rgba(45, 156, 219, 0.2) !important; }
        .focus\:ring-indigo-500:focus { --tw-ring-color: var(--color-primary) !important; }
        .focus\:border-indigo-300:focus { border-color: rgba(45, 156, 219, 0.4) !important; }

        /* D3 Chart Styles */
        .axis line, .axis path {
            stroke: #cbd5e1;
            shape-rendering: crispEdges;
        }

        .axis text {
            fill: #64748b;
            font-size: 11px;
            font-weight: 500;
        }

        .grid line {
            stroke: #e2e8f0;
            stroke-opacity: 0.7;
            shape-rendering: crispEdges;
        }

        .line {
            fill: none;
            stroke-width: 2.5px;
        }

        .area {
            opacity: 0.3;
        }

        .tooltip {
            position: absolute;
            background: rgba(15, 23, 42, 0.95);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            max-width: 280px;
        }

        .tooltip-label {
            color: #94a3b8;
            display: inline-block;
            min-width: 90px;
            font-weight: 500;
        }

        .tooltip-value {
            color: #ffffff;
            font-weight: 600;
            margin-left: 8px;
        }

        .legend-item {
            display: inline-flex;
            align-items: center;
            margin-right: 14px;
            cursor: pointer;
            padding: 3px 6px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .legend-item:hover {
            background-color: #f1f5f9;
        }

        .legend-color {
            width: 18px;
            height: 3px;
            border-radius: 2px;
            margin-right: 6px;
        }

        /* Loading spinner */
        .spinner {
            border: 3px solid #f1f5f9;
            border-top: 3px solid var(--color-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Drilldown table styles */
        .drilldown-table-wrapper {
            overflow: auto;
            max-height: calc(90vh - 180px);
        }

        .drilldown-table {
            width: 100%;
            table-layout: auto;
            border-collapse: collapse;
        }

        .drilldown-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .drilldown-table thead th {
            background-color: #f1f5f9;
            box-shadow: inset 0 -1px 0 #e2e8f0;
        }

        .drilldown-table th.sortable {
            cursor: pointer;
            user-select: none;
        }

        .drilldown-table th.sortable:hover {
            background-color: #e2e8f0;
        }

        .drilldown-table th .sort-icon {
            display: inline-block;
            margin-left: 4px;
            opacity: 0.3;
        }

        .drilldown-table th.sort-asc .sort-icon,
        .drilldown-table th.sort-desc .sort-icon {
            opacity: 1;
        }

        .drilldown-table th.sort-desc .sort-icon {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="bg-slate-50">
    <div class="flex flex-col h-screen">
        <!-- Header (matching Gantt v3) -->
        <header class="h-20 bg-white border-b border-slate-200 px-8 flex items-center justify-between flex-shrink-0 z-20 shadow-sm">
            <div class="flex items-center gap-6">
                <div>
                    <h1 class="text-xl font-bold text-slate-900">
                        Inventory Dashboard
                        <span id="dateRangeDisplay" class="text-sm font-normal text-slate-500 ml-2"></span>
                    </h1>
                    <p class="text-xs text-slate-500 mt-0.5">Real-time inventory analytics</p>
                </div>

                <!-- KPI Summary in Header -->
                <div id="kpiCards" class="hidden lg:flex items-center gap-3">
                    <!-- Will be populated dynamically -->
                </div>
            </div>

            <div class="flex items-center gap-3">
                <!-- Refresh Button -->
                <button onclick="loadDashboard()" class="p-2.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-xl transition-all" title="Refresh Data">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                </button>
            </div>
        </header>

        <!-- Content Area -->
        <div class="flex-1 overflow-y-auto custom-scrollbar p-4 lg:p-8">
            <!-- Filters Section -->
            <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-4 mb-4">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-base font-bold text-slate-800 flex items-center gap-2">
                        <svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                        </svg>
                        <span>Filters</span>
                        <button onclick="clearAllFilters()" class="ml-2 px-2 py-1 text-xs text-slate-500 hover:text-red-600 hover:bg-red-50 rounded transition-colors flex items-center gap-1" title="Clear All Filters">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            Clear
                        </button>
                    </h3>

                    <div class="flex items-center gap-2 flex-wrap">
                        <!-- Date Range Dropdown -->
                        <div class="flex items-center gap-1 bg-slate-50 px-2 py-1.5 rounded-lg border border-slate-200">
                            <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            <select id="dateRangeFilter" onchange="applyDateRange()" class="px-2 py-0.5 text-xs border-0 bg-transparent focus:ring-0 focus:outline-none text-slate-700 font-semibold" style="width: 180px;">
                                <option value="current_fy" selected>Current Financial Year</option>
                                <option value="30">Last 30 Days</option>
                                <option value="60">Last 60 Days</option>
                                <option value="90">Last 90 Days</option>
                                <option value="180">Last 6 Months</option>
                                <option value="365">Last Year</option>
                                <option value="this_quarter">This Quarter</option>
                                <option value="last_quarter">Last Quarter</option>
                                <option value="last_fy">Last Financial Year</option>
                                <option value="current_cy">Current Calendar Year</option>
                                <option value="last_cy">Last Calendar Year</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>

                        <!-- Custom Date Range Picker -->
                        <div id="customDateRangeContainer" class="flex items-center gap-1 bg-slate-50 px-2 py-1.5 rounded-lg border border-slate-200" style="display: none;">
                            <input type="date" id="customStartDate" class="px-2 py-0.5 text-xs border-0 bg-transparent focus:ring-0 focus:outline-none text-slate-700" style="width: 110px;" onchange="applyCustomDateRange()" title="Start Date">
                            <span class="text-slate-400 text-xs">to</span>
                            <input type="date" id="customEndDate" class="px-2 py-0.5 text-xs border-0 bg-transparent focus:ring-0 focus:outline-none text-slate-700" style="width: 110px;" onchange="applyCustomDateRange()" title="End Date">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <!-- Location Group -->
                    <div>
                        <label class="block text-[11px] font-semibold text-slate-600 mb-1.5">Location Group</label>
                        <select id="locationGroupFilter" onchange="loadDashboard()" class="w-full px-2.5 py-1.5 bg-slate-50 border border-slate-300 rounded-lg text-sm font-medium focus:bg-white focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300 transition-all outline-none text-slate-600">
                            <option value="%">All Locations</option>
                        </select>
                    </div>

                    <!-- Hidden product category filter (removed from UI but kept for code compatibility) -->
                    <input type="hidden" id="productCategoryFilter" value="%">

                    <!-- Vendor -->
                    <div>
                        <label class="block text-[11px] font-semibold text-slate-600 mb-1.5">Vendor</label>
                        <select id="vendorFilter" onchange="loadDashboard()" class="w-full px-2.5 py-1.5 bg-slate-50 border border-slate-300 rounded-lg text-sm font-medium focus:bg-white focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300 transition-all outline-none text-slate-600">
                            <option value="%">All Vendors</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Pipeline KPIs Row - 3 equal tiles -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <!-- Stock Loss (Cycle Count + Scrapped) -->
                <div class="bg-white rounded-xl shadow-md border border-slate-300 p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <div class="p-2 bg-amber-100 rounded-lg">
                                <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                            </div>
                            <h4 class="text-sm font-bold text-slate-800">Stock Loss</h4>
                        </div>
                        <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-center" style="height: 120px; align-content: center;">
                        <div class="cursor-pointer hover:bg-blue-50 rounded-lg p-2 transition-colors" onclick="showCycleCountModal()">
                            <div id="cycleCountValue" class="text-2xl font-bold text-blue-600">$0</div>
                            <div id="cycleCountParts" class="text-xs text-slate-500">0 parts</div>
                            <div class="text-xs text-slate-400 mt-1">Cycle Count</div>
                        </div>
                        <div class="cursor-pointer hover:bg-red-50 rounded-lg p-2 transition-colors" onclick="showScrapModal()">
                            <div id="scrapValue" class="text-2xl font-bold text-red-600">$0</div>
                            <div id="scrapParts" class="text-xs text-slate-500">0 parts</div>
                            <div class="text-xs text-slate-400 mt-1">Scrapped</div>
                        </div>
                    </div>
                    <div class="bg-amber-50 rounded-lg p-3 text-center mt-2">
                        <div class="text-xs text-slate-500">Total Loss Value</div>
                        <div id="stockLossTotalValue" class="text-lg font-bold text-amber-600">$0</div>
                    </div>
                </div>

                <!-- Short Pick Items -->
                <div class="bg-white rounded-xl shadow-md border border-slate-300 p-4 cursor-pointer hover:border-red-300 transition-colors" onclick="showShortPartsModal()">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <div class="p-2 bg-red-100 rounded-lg">
                                <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                            </div>
                            <h4 class="text-sm font-bold text-slate-800">Short Pick Items</h4>
                        </div>
                        <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </div>
                    <div class="grid grid-cols-3 gap-2 text-center" style="height: 120px; align-content: center;">
                        <div>
                            <div id="shortPickPartsCount" class="text-2xl font-bold text-red-600">0</div>
                            <div class="text-xs text-slate-500">Parts</div>
                        </div>
                        <div>
                            <div id="shortPickLinesCount" class="text-2xl font-bold text-red-600">0</div>
                            <div class="text-xs text-slate-500">Line Items</div>
                        </div>
                        <div>
                            <div id="shortPickPicksCount" class="text-2xl font-bold text-red-600">0</div>
                            <div class="text-xs text-slate-500">Picks</div>
                        </div>
                    </div>
                    <div class="bg-red-50 rounded-lg p-3 text-center mt-2">
                        <div class="text-xs text-slate-500">At-Risk Order Value</div>
                        <div id="shortPickValue" class="text-lg font-bold text-red-600">$0</div>
                    </div>
                </div>

                <!-- Picked - Awaiting Pack/Ship -->
                <div class="bg-white rounded-xl shadow-md border border-slate-300 p-4 cursor-pointer hover:border-cyan-300 transition-colors" onclick="showFulfillmentPipelineModal()">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <div class="p-2 bg-cyan-100 rounded-lg">
                                <svg class="w-5 h-5 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path>
                                </svg>
                            </div>
                            <h4 class="text-sm font-bold text-slate-800">Picked - Awaiting Ship</h4>
                        </div>
                        <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-center" style="height: 120px; align-content: center;">
                        <div>
                            <div id="fulfillmentOrdersCount" class="text-2xl font-bold text-cyan-600">0</div>
                            <div class="text-xs text-slate-500">Orders</div>
                        </div>
                        <div>
                            <div id="fulfillmentItemCount" class="text-2xl font-bold text-cyan-600">0</div>
                            <div class="text-xs text-slate-500">Line Items</div>
                        </div>
                    </div>
                    <div class="bg-cyan-50 rounded-lg p-3 text-center mt-2">
                        <div class="text-xs text-slate-500">Ready to Ship Value</div>
                        <div id="fulfillmentTotalValue" class="text-lg font-bold text-cyan-600">$0</div>
                    </div>
                </div>
            </div>

            <!-- Charts Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Stock Value Over Time -->
                <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                        </svg>
                        Stock Value Over Time
                    </h3>
                    <div id="valueChart" style="height: 300px;"></div>
                </div>

                <!-- Stock Levels by Location -->
                <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        Stock Levels by Location
                    </h3>
                    <div id="locationChart" style="height: 300px;"></div>
                </div>
            </div>

            <!-- Bottom Row Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-4 gap-6">
                <!-- Top Parts by Value -->
                <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        Top Parts by Value
                    </h3>
                    <div id="topPartsChart" style="height: 280px;"></div>
                </div>

                <!-- Stock Movement Trend -->
                <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                        </svg>
                        Stock Movement
                    </h3>
                    <div id="movementChart" style="height: 280px;"></div>
                </div>

                <!-- Availability Status -->
                <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Availability Status
                    </h3>
                    <div id="statusChart" style="height: 280px;"></div>
                </div>

                <!-- Slow-Moving Inventory -->
                <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                        </svg>
                        Slow-Moving Inventory
                    </h3>
                    <div id="slowMovingChart" style="height: 280px;"></div>
                </div>
            </div>

            <!-- Loading Overlay -->
            <div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 9999; align-items: center; justify-content: center;">
                <div style="background: white; padding: 2rem; border-radius: 1rem; text-align: center;">
                    <div class="spinner mx-auto mb-4"></div>
                    <p class="text-slate-700 font-medium">Loading dashboard data...</p>
                </div>
            </div>

            <!-- Debug Console (hidden by default, shown if BI_SHOW_DEBUG=true) -->
            <div id="debugConsoleContainer" class="mt-6" style="display: none;">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <button onclick="toggleDebugConsole()" class="w-full px-6 py-3 flex items-center justify-between hover:bg-slate-50 transition-colors">
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                            </svg>
                            <span class="text-sm font-semibold text-slate-700">Debug Console</span>
                            <span class="text-xs text-slate-400 font-normal">Auto-scrolls to latest entry</span>
                        </div>
                        <svg id="debugChevron" class="w-5 h-5 text-slate-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>

                    <div id="debugContent" class="hidden border-t border-slate-200">
                        <div class="bg-slate-900 px-4 py-2 flex items-center justify-between">
                            <span class="text-xs text-slate-400 font-mono">Drill-down & Application Diagnostics</span>
                            <button onclick="clearDebugLog()" class="text-xs text-slate-400 hover:text-white transition-colors">
                                Clear
                            </button>
                        </div>
                        <div id="debugLog" class="bg-slate-950 text-slate-200 p-4 font-mono text-xs max-h-96 overflow-y-auto" style="scrollbar-width: thin;">
                            <div class="text-slate-500 italic">Waiting for application to initialize...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tooltip -->
    <div id="tooltip" class="tooltip"></div>

    <!-- Drill-down Modal -->
    <div id="drilldownModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center" onclick="closeDrilldown(event)">
        <div class="bg-white rounded-2xl shadow-2xl w-11/12 max-w-6xl max-h-[90vh] flex flex-col" onclick="event.stopPropagation()">
            <!-- Modal Header -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-slate-200">
                <div>
                    <h2 id="drilldownTitle" class="text-xl font-bold text-slate-800"></h2>
                    <div id="drilldownSubtitle" class="text-sm text-slate-500 mt-1"></div>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="exportDrilldownData()" class="px-3 py-2 text-sm font-semibold text-slate-600 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-all flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Export CSV
                    </button>
                    <button onclick="closeDrilldown()" class="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Modal Content -->
            <div id="drilldownContent" class="flex-1 overflow-hidden px-6 pb-6 pt-0">
                <!-- Content will be populated dynamically -->
            </div>

            <!-- Modal Footer with Summary -->
            <div id="drilldownFooter" class="px-6 py-3 border-t border-slate-200 bg-slate-50 text-sm text-slate-600">
                <!-- Summary will be populated dynamically -->
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // Global Variables
        // ============================================
        let currentDateRange = 90;
        let customStartDate = null;
        let customEndDate = null;
        const tooltip = d3.select('#tooltip');

        // Drilldown sorting state
        let currentDrilldownSort = { column: null, direction: 'asc' };
        let currentDrilldownRenderFn = null;

        // Financial Year start month (1-12, default 7 = July)
        // Configure via Fishbowl property: BI_FY_START_MONTH
        const FY_START_MONTH = parseInt(getProperty('BI_FY_START_MONTH', '7')) || 7;

        // Debug mode from Fishbowl system property (default to false)
        const BI_SHOW_DEBUG_PROP = typeof getProperty === 'function' ? getProperty('BI_SHOW_DEBUG', 'false') : 'false';
        const DEBUG_MODE = BI_SHOW_DEBUG_PROP === 'true' || BI_SHOW_DEBUG_PROP === true;

        // Date format from Fishbowl system property (default to US format)
        const FB_DATE_FORMAT = typeof getProperty === 'function' ? getProperty('DateFormatShort', 'MM/dd/yyyy') : 'MM/dd/yyyy';
        // Convert Java SimpleDateFormat to moment.js format (dd -> DD, yyyy -> YYYY)
        const MOMENT_DATE_FORMAT = FB_DATE_FORMAT
            .replace(/yyyy/g, 'YYYY')
            .replace(/yy/g, 'YY')
            .replace(/dd/g, 'DD');

        // Price formatting from Fishbowl system property
        const PRICE_FORMAT = getProperty('REPORT_DECIMAL_PRICE', '$ #,##0.00');

        // Currency code to symbol mapping (ISO 4217 codes)
        const CURRENCY_SYMBOLS = {
            'AUD': '$',      // Australian Dollar
            'USD': '$',      // US Dollar
            'NZD': '$',      // New Zealand Dollar
            'CAD': '$',      // Canadian Dollar
            'SGD': '$',      // Singapore Dollar
            'HKD': '$',      // Hong Kong Dollar
            'EUR': '€',      // Euro
            'GBP': '£',      // British Pound
            'JPY': '¥',      // Japanese Yen
            'CNY': '¥',      // Chinese Yuan
            'CHF': 'CHF',    // Swiss Franc
            'SEK': 'kr',     // Swedish Krona
            'NOK': 'kr',     // Norwegian Krone
            'DKK': 'kr',     // Danish Krone
            'INR': '₹',      // Indian Rupee
            'ZAR': 'R',      // South African Rand
            'BRL': 'R$',     // Brazilian Real
            'MXN': '$',      // Mexican Peso
            'KRW': '₩',      // South Korean Won
            'THB': '฿',      // Thai Baht
            'MYR': 'RM',     // Malaysian Ringgit
            'PHP': '₱',      // Philippine Peso
            'IDR': 'Rp',     // Indonesian Rupiah
            'AED': 'د.إ',    // UAE Dirham
            'SAR': '﷼',      // Saudi Riyal
            'RUB': '₽',      // Russian Ruble
            'PLN': 'zł',     // Polish Zloty
            'TRY': '₺',      // Turkish Lira
            'ILS': '₪',      // Israeli Shekel
            'CZK': 'Kč',     // Czech Koruna
            'HUF': 'Ft',     // Hungarian Forint
            'TWD': 'NT$',    // Taiwan Dollar
            'VND': '₫',      // Vietnamese Dong
        };

        // Get home currency symbol from database
        function getHomeCurrencySymbol() {
            try {
                const query = `SELECT code FROM currency WHERE homeCurrency = 1 LIMIT 1`;
                const result = runQuery(query);
                if (result) {
                    const parsed = JSON.parse(result);
                    if (parsed && parsed.length > 0 && parsed[0].code) {
                        const code = parsed[0].code.toUpperCase();
                        const symbol = CURRENCY_SYMBOLS[code] || code;
                        console.log(`Home currency: ${code} → Symbol: ${symbol}`);
                        return symbol;
                    }
                }
            } catch (e) {
                console.error(`getHomeCurrencySymbol error: ${e.message}`);
            }
            // Fallback to parsing from REPORT_DECIMAL_PRICE
            return PRICE_FORMAT.match(/^[^#0,.\s]+/) ? PRICE_FORMAT.match(/^[^#0,.\s]+/)[0].trim() : '$';
        }

        // Parse decimal places from price format
        const DECIMAL_PLACES = (PRICE_FORMAT.match(/\.([0#]+)$/) || ['', '00'])[1].length;

        // Get the currency symbol (from DB or fallback)
        const CURRENCY_SYMBOL = getHomeCurrencySymbol();

        // Global currency formatting function
        function formatCurrency(value, showDecimals = true) {
            const num = parseFloat(value || 0);
            const isNegative = num < 0;
            const absValue = Math.abs(num);
            const decimals = showDecimals ? DECIMAL_PLACES : 0;
            const formatted = absValue.toLocaleString('en-US', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            });
            return isNegative ? `-${CURRENCY_SYMBOL}${formatted}` : `${CURRENCY_SYMBOL}${formatted}`;
        }

        // Format quantity to 2 decimal places
        function formatQty(value) {
            const num = parseFloat(value || 0);
            return num.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // Drilldown table sorting
        function sortDrilldownData(data, column, direction, type = 'string') {
            return [...data].sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];

                if (type === 'number') {
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                } else if (type === 'date') {
                    aVal = new Date(aVal || 0).getTime();
                    bVal = new Date(bVal || 0).getTime();
                } else {
                    aVal = (aVal || '').toString().toLowerCase();
                    bVal = (bVal || '').toString().toLowerCase();
                }

                if (aVal < bVal) return direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return direction === 'asc' ? 1 : -1;
                return 0;
            });
        }

        function handleColumnSort(column, type, renderFn) {
            if (currentDrilldownSort.column === column) {
                currentDrilldownSort.direction = currentDrilldownSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentDrilldownSort.column = column;
                currentDrilldownSort.direction = 'asc';
            }
            currentDrilldownRenderFn = renderFn;
            renderFn();
        }

        function getSortIcon() {
            return '<span class="sort-icon">▲</span>';
        }

        function getSortClass(column) {
            if (currentDrilldownSort.column !== column) return 'sortable';
            return `sortable sort-${currentDrilldownSort.direction}`;
        }

        // Escape SQL strings for safe use in queries
        function escapeSQL(str) {
            if (str === null || str === undefined) return str;
            return str.toString().replace(/'/g, "''");
        }

        // Module opener functions for drilldown links
        function openPick(pickNumber) {
            openModule("Picking", pickNumber);
        }

        function openSalesOrder(orderNumber) {
            openModule("Sales Order", orderNumber);
        }

        function openPurchaseOrder(orderNumber) {
            openModule("Purchase Order", orderNumber);
        }

        function openWorkOrder(orderNumber) {
            openModule("Work Order", orderNumber);
        }

        function openTransferOrder(orderNumber) {
            openModule("Transfer Order", orderNumber);
        }

        // Color palette (matching Gantt v3 theme)
        const colorPalette = [
            '#2d9cdb', '#3b82f6', '#10b981', '#f59e0b', '#ef4444',
            '#8b5cf6', '#ec4899', '#14b8a6', '#f97316', '#06b6d4'
        ];

        // ============================================
        // Date Range Helper Functions
        // ============================================
        function getQuarterDates(offset = 0) {
            const now = moment();
            const currentQuarterStart = moment(now).startOf('quarter');
            const targetQuarterStart = moment(currentQuarterStart).subtract(offset, 'quarters');

            const startDate = targetQuarterStart.startOf('quarter');
            const endDate = moment(startDate).endOf('quarter');

            return {
                start: startDate.format('YYYY-MM-DD'),
                end: endDate.format('YYYY-MM-DD')
            };
        }

        function getFYDates(offset = 0) {
            const now = moment();
            const currentMonth = now.month() + 1;
            const currentYear = now.year();

            const fyStartMonth = Math.max(1, Math.min(12, FY_START_MONTH));

            let fyStartYear = currentMonth >= fyStartMonth ? currentYear : currentYear - 1;
            fyStartYear -= offset;

            let fyEndMonth, fyEndYear;
            if (fyStartMonth === 1) {
                fyEndMonth = 12;
                fyEndYear = fyStartYear;
            } else {
                fyEndMonth = fyStartMonth - 1;
                fyEndYear = fyStartYear + 1;
            }

            const endDate = moment([fyEndYear, fyEndMonth - 1, 1]).endOf('month');

            return {
                start: `${fyStartYear}-${String(fyStartMonth).padStart(2, '0')}-01`,
                end: endDate.format('YYYY-MM-DD')
            };
        }

        function getCalendarYearDates(offset = 0) {
            const year = moment().year() - offset;
            return {
                start: `${year}-01-01`,
                end: `${year}-12-31`
            };
        }

        function getDateCondition(dateColumn = 'il.dateCreated') {
            if (customStartDate && customEndDate) {
                return `${dateColumn} >= '${customStartDate}' AND ${dateColumn} <= '${customEndDate}'`;
            } else {
                const days = currentDateRange || 90;
                return `${dateColumn} >= DATE_SUB(NOW(), INTERVAL ${days} DAY)`;
            }
        }

        function getDateRange() {
            // Return current date range for queries that need start/end dates
            if (customStartDate && customEndDate) {
                return {
                    start: customStartDate,
                    end: customEndDate
                };
            }
            // Default to last 365 days if no custom range set
            const end = moment().format('YYYY-MM-DD');
            const start = moment().subtract(365, 'days').format('YYYY-MM-DD');
            return { start, end };
        }

        // ============================================
        // Debug Functions
        // ============================================
        function debugLog(message, type = 'info') {
            // Only log if DEBUG_MODE is enabled
            if (!DEBUG_MODE) return;

            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('debugLog');

            // Clear initial message
            if (logDiv.querySelector('.italic')) {
                logDiv.innerHTML = '';
            }

            const colors = {
                'info': 'text-blue-400',
                'success': 'text-green-400',
                'warning': 'text-yellow-400',
                'error': 'text-red-400',
                'click': 'text-purple-400'
            };

            const entry = document.createElement('div');
            entry.className = 'py-0.5';
            entry.innerHTML = `<span class="text-slate-500">[${timestamp}]</span> <span class="${colors[type] || colors.info}">${message}</span>`;

            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function showTooltip(event, html) {
            tooltip.style('opacity', 1)
                .html(html)
                .style('left', (event.pageX + 10) + 'px')
                .style('top', (event.pageY - 10) + 'px');
        }

        function hideTooltip() {
            tooltip.style('opacity', 0);
        }

        function toggleDebugConsole() {
            const content = document.getElementById('debugContent');
            const chevron = document.getElementById('debugChevron');

            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                chevron.style.transform = 'rotate(180deg)';
            } else {
                content.classList.add('hidden');
                chevron.style.transform = 'rotate(0deg)';
            }
        }

        function clearDebugLog() {
            const logDiv = document.getElementById('debugLog');
            logDiv.innerHTML = '<div class="text-slate-500 italic">Log cleared</div>';
        }

        // ============================================
        // Modal Functions
        // ============================================
        let currentDrilldownData = [];
        let currentDrilldownTitle = '';

        function showDrilldown(title, subtitle, content, footerText) {
            document.getElementById('drilldownTitle').textContent = title;
            document.getElementById('drilldownSubtitle').textContent = subtitle || '';
            document.getElementById('drilldownContent').innerHTML = content;
            document.getElementById('drilldownFooter').innerHTML = footerText || '';
            document.getElementById('drilldownModal').classList.remove('hidden');
            document.getElementById('drilldownModal').classList.add('flex');
            currentDrilldownTitle = title;
            debugLog(`Opened drilldown: ${title}`, 'click');
        }

        function closeDrilldown(event) {
            if (!event || event.target === document.getElementById('drilldownModal')) {
                document.getElementById('drilldownModal').classList.add('hidden');
                document.getElementById('drilldownModal').classList.remove('flex');
            }
        }

        function exportDrilldownData() {
            if (currentDrilldownData.length === 0) {
                alert('No data to export');
                return;
            }

            const headers = Object.keys(currentDrilldownData[0]);
            let csv = headers.join(',') + '\n';

            currentDrilldownData.forEach(row => {
                csv += headers.map(h => {
                    const val = row[h] || '';
                    return typeof val === 'string' && (val.includes(',') || val.includes('"'))
                        ? `"${val.replace(/"/g, '""')}"`
                        : val;
                }).join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.setAttribute('href', URL.createObjectURL(blob));
            link.setAttribute('download', `${currentDrilldownTitle.replace(/\s+/g, '_')}_${moment().format('YYYY-MM-DD_HHmmss')}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            debugLog(`Exported ${currentDrilldownData.length} rows to CSV`, 'success');
        }

        // ============================================
        // Fishbowl SQL Queries
        // ============================================
        function getInventoryValueOverTime() {
            const locationGroup = document.getElementById('locationGroupFilter').value;
            const productCategory = document.getElementById('productCategoryFilter').value;
            const vendorFilter = document.getElementById('vendorFilter').value;

            let lgCondition = locationGroup !== '%' ? `AND lg.id = ${locationGroup}` : '';
            let categoryCondition = productCategory !== '%' ? `AND pt.name = '${productCategory}'` : '';
            let vendorCondition = vendorFilter !== '%' ? `AND EXISTS (SELECT 1 FROM vendorparts vp WHERE vp.partid = p.id AND vp.vendorid = ${vendorFilter} AND vp.defaultflag = 1)` : '';

            const query = `
                SELECT
                    DATE(il.dateCreated) as date,
                    SUM(il.qtyOnHand * COALESCE(p.stdCost, 0)) as total_value,
                    SUM(il.qtyOnHand) as total_qty,
                    COUNT(DISTINCT p.id) as part_count
                FROM inventorylog il
                JOIN part p ON il.partId = p.id
                JOIN locationgroup lg ON il.locationgroupid = lg.id
                LEFT JOIN producttree pt ON p.treeId = pt.id
                WHERE ${getDateCondition('il.dateCreated')}
                    AND p.activeflag = 1
                    AND p.typeid = 10
                    ${lgCondition}
                    ${categoryCondition}
                    ${vendorCondition}
                GROUP BY DATE(il.dateCreated)
                ORDER BY date ASC
            `;

            console.log('Value Over Time Query:', query);
            return JSON.parse(runQuery(query));
        }

        function getStockByLocation() {
            const locationGroup = document.getElementById('locationGroupFilter').value;
            const productCategory = document.getElementById('productCategoryFilter').value;
            const vendorFilter = document.getElementById('vendorFilter').value;

            let lgCondition = locationGroup !== '%' ? `AND lg.id = ${locationGroup}` : '';
            let categoryCondition = productCategory !== '%' ? `AND pt.name = '${productCategory}'` : '';
            let vendorCondition = vendorFilter !== '%' ? `AND EXISTS (SELECT 1 FROM vendorparts vp WHERE vp.partid = p.id AND vp.vendorid = ${vendorFilter} AND vp.defaultflag = 1)` : '';

            const query = `
                SELECT
                    lg.name as location,
                    DATE(il.dateCreated) as date,
                    SUM(il.qtyOnHand) as qty
                FROM inventorylog il
                JOIN part p ON il.partId = p.id
                JOIN locationgroup lg ON il.locationgroupid = lg.id
                LEFT JOIN producttree pt ON p.treeId = pt.id
                WHERE ${getDateCondition('il.dateCreated')}
                    AND p.activeflag = 1
                    AND p.typeid = 10
                    ${lgCondition}
                    ${categoryCondition}
                    ${vendorCondition}
                GROUP BY lg.name, DATE(il.dateCreated)
                ORDER BY lg.name, date ASC
            `;

            console.log('Stock by Location Query:', query);
            return JSON.parse(runQuery(query));
        }

        function getTopPartsByValue() {
            const locationGroup = document.getElementById('locationGroupFilter').value;
            const productCategory = document.getElementById('productCategoryFilter').value;
            const vendorFilter = document.getElementById('vendorFilter').value;

            let lgCondition = locationGroup !== '%' ? `AND locationgroup.id = ${locationGroup}` : '';
            let categoryCondition = productCategory !== '%' ? `AND pt.name = '${productCategory}'` : '';
            let vendorCondition = vendorFilter !== '%' ? `AND EXISTS (SELECT 1 FROM vendorparts vp WHERE vp.partid = part.id AND vp.vendorid = ${vendorFilter} AND vp.defaultflag = 1)` : '';

            // Based on Fishbowl Inventory Availability by Location Group report
            const query = `
                SELECT
                    part.num AS part_num,
                    part.description,
                    uom.code AS uom,
                    locationgroup.name AS location_group,
                    COALESCE(qtyonhand.qty, 0) AS qty_on_hand,
                    COALESCE(qtynotavailable.qty, 0) AS qty_unavailable,
                    COALESCE(qtycommitted.qty, 0) AS qty_committed,
                    COALESCE(qtyallocated.qty, 0) AS qty_allocated,
                    COALESCE(qtyonorder.qty, 0) AS qty_on_order,
                    COALESCE(qtydropship.qty, 0) AS qty_dropship,
                    (COALESCE(qtyonhand.qty, 0) - COALESCE(qtynotavailable.qty, 0) - COALESCE(qtycommitted.qty, 0) - COALESCE(qtyallocated.qty, 0)) AS qty_available,
                    COALESCE(qtyonhand.qty, 0) * COALESCE(part.stdCost, 0) AS total_value
                FROM part
                LEFT JOIN locationgroup ON locationgroup.activeflag = 1
                LEFT JOIN uom ON part.uomid = uom.id
                LEFT JOIN producttree pt ON part.treeId = pt.id
                LEFT JOIN qtyonorder ON qtyonorder.partid = part.id AND qtyonorder.locationgroupid = locationgroup.id
                LEFT JOIN qtyallocated ON qtyallocated.partid = part.id AND qtyallocated.locationgroupid = locationgroup.id
                LEFT JOIN qtycommitted ON qtycommitted.partid = part.id AND qtycommitted.locationgroupid = locationgroup.id
                LEFT JOIN qtynotavailable ON qtynotavailable.partid = part.id AND qtynotavailable.locationgroupid = locationgroup.id
                LEFT JOIN qtydropship ON qtydropship.partid = part.id AND qtydropship.locationgroupid = locationgroup.id
                LEFT JOIN qtyonhand ON qtyonhand.partid = part.id AND qtyonhand.locationgroupid = locationgroup.id
                WHERE part.id != 0
                    AND part.typeid = 10
                    AND part.activeflag = 1
                    ${lgCondition}
                    ${categoryCondition}
                    ${vendorCondition}
                HAVING (qty_on_hand + qty_unavailable + qty_dropship + qty_committed + qty_allocated + qty_on_order) > 0
                ORDER BY total_value DESC
                LIMIT 10
            `;

            console.log('Top Parts Query:', query);
            return JSON.parse(runQuery(query));
        }

        function getInventoryAvailability() {
            const locationGroup = document.getElementById('locationGroupFilter').value;
            const productCategory = document.getElementById('productCategoryFilter').value;
            const vendorFilter = document.getElementById('vendorFilter').value;

            let lgCondition = locationGroup !== '%' ? `AND locationgroup.id = ${locationGroup}` : '';
            let categoryCondition = productCategory !== '%' ? `AND pt.name = '${productCategory}'` : '';
            let vendorCondition = vendorFilter !== '%' ? `AND EXISTS (SELECT 1 FROM vendorparts vp WHERE vp.partid = part.id AND vp.vendorid = ${vendorFilter} AND vp.defaultflag = 1)` : '';

            // Full inventory availability query from Fishbowl report
            const query = `
                SELECT
                    part.num AS part_num,
                    part.description,
                    uom.code AS uom,
                    part.id AS part_id,
                    locationgroup.name AS location_group,
                    COALESCE(qtyonhand.qty, 0) AS qty_on_hand,
                    COALESCE(qtynotavailable.qty, 0) AS qty_unavailable,
                    COALESCE(qtydropship.qty, 0) AS qty_dropship,
                    COALESCE(qtycommitted.qty, 0) AS qty_committed,
                    COALESCE(qtyallocated.qty, 0) AS qty_allocated,
                    COALESCE(qtyonorder.qty, 0) AS qty_on_order,
                    (COALESCE(qtyonhand.qty, 0) - COALESCE(qtynotavailable.qty, 0) - COALESCE(qtycommitted.qty, 0) - COALESCE(qtyallocated.qty, 0)) AS qty_available
                FROM part
                LEFT JOIN locationgroup ON locationgroup.activeflag = 1
                LEFT JOIN uom ON part.uomid = uom.id
                LEFT JOIN producttree pt ON part.treeId = pt.id
                LEFT JOIN qtyonorder ON qtyonorder.partid = part.id AND qtyonorder.locationgroupid = locationgroup.id
                LEFT JOIN qtyallocated ON qtyallocated.partid = part.id AND qtyallocated.locationgroupid = locationgroup.id
                LEFT JOIN qtycommitted ON qtycommitted.partid = part.id AND qtycommitted.locationgroupid = locationgroup.id
                LEFT JOIN qtynotavailable ON qtynotavailable.partid = part.id AND qtynotavailable.locationgroupid = locationgroup.id
                LEFT JOIN qtydropship ON qtydropship.partid = part.id AND qtydropship.locationgroupid = locationgroup.id
                LEFT JOIN qtyonhand ON qtyonhand.partid = part.id AND qtyonhand.locationgroupid = locationgroup.id
                WHERE part.id != 0
                    AND part.typeid = 10
                    AND part.activeflag = 1
                    ${lgCondition}
                    ${categoryCondition}
                    ${vendorCondition}
                HAVING (qty_on_hand + qty_unavailable + qty_dropship + qty_committed + qty_allocated + qty_on_order) > 0
                ORDER BY locationgroup.id, part.num
            `;

            console.log('Inventory Availability Query:', query);
            return JSON.parse(runQuery(query));
        }

        function getAvailabilityStatus() {
            const locationGroup = document.getElementById('locationGroupFilter').value;
            const productCategory = document.getElementById('productCategoryFilter').value;
            const vendorFilter = document.getElementById('vendorFilter').value;

            let lgCondition = locationGroup !== '%' ? `AND lg.id = ${locationGroup}` : '';
            let categoryCondition = productCategory !== '%' ? `AND pt.name = '${productCategory}'` : '';
            let vendorCondition = vendorFilter !== '%' ? `AND EXISTS (SELECT 1 FROM vendorparts vp WHERE vp.partid = p.id AND vp.vendorid = ${vendorFilter} AND vp.defaultflag = 1)` : '';

            // Use a more comprehensive query that joins with part to filter by category
            const query = `
                SELECT
                    'On Hand' as status,
                    SUM(COALESCE(qoh.qty, 0)) as qty
                FROM part p
                LEFT JOIN qtyonhand qoh ON p.id = qoh.partid
                LEFT JOIN locationgroup lg ON qoh.locationgroupid = lg.id
                LEFT JOIN producttree pt ON p.treeId = pt.id
                WHERE p.activeflag = 1 AND p.typeid = 10 ${lgCondition} ${categoryCondition} ${vendorCondition}
                UNION ALL
                SELECT
                    'Committed' as status,
                    SUM(COALESCE(qc.qty, 0)) as qty
                FROM part p
                LEFT JOIN qtycommitted qc ON p.id = qc.partid
                LEFT JOIN locationgroup lg ON qc.locationgroupid = lg.id
                LEFT JOIN producttree pt ON p.treeId = pt.id
                WHERE p.activeflag = 1 AND p.typeid = 10 ${lgCondition} ${categoryCondition} ${vendorCondition}
                UNION ALL
                SELECT
                    'Allocated' as status,
                    SUM(COALESCE(qa.qty, 0)) as qty
                FROM part p
                LEFT JOIN qtyallocated qa ON p.id = qa.partid
                LEFT JOIN locationgroup lg ON qa.locationgroupid = lg.id
                LEFT JOIN producttree pt ON p.treeId = pt.id
                WHERE p.activeflag = 1 AND p.typeid = 10 ${lgCondition} ${categoryCondition} ${vendorCondition}
                UNION ALL
                SELECT
                    'Not Available' as status,
                    SUM(COALESCE(qna.qty, 0)) as qty
                FROM part p
                LEFT JOIN qtynotavailable qna ON p.id = qna.partid
                LEFT JOIN locationgroup lg ON qna.locationgroupid = lg.id
                LEFT JOIN producttree pt ON p.treeId = pt.id
                WHERE p.activeflag = 1 AND p.typeid = 10 ${lgCondition} ${categoryCondition} ${vendorCondition}
                UNION ALL
                SELECT
                    'On Order' as status,
                    SUM(COALESCE(qoo.qty, 0)) as qty
                FROM part p
                LEFT JOIN qtyonorder qoo ON p.id = qoo.partid
                LEFT JOIN locationgroup lg ON qoo.locationgroupid = lg.id
                LEFT JOIN producttree pt ON p.treeId = pt.id
                WHERE p.activeflag = 1 AND p.typeid = 10 ${lgCondition} ${categoryCondition} ${vendorCondition}
            `;

            console.log('Availability Query:', query);
            return JSON.parse(runQuery(query));
        }

        function getKPIMetrics() {
            const locationGroup = document.getElementById('locationGroupFilter').value;
            let locationCondition = locationGroup !== '%' ? `AND qoh.locationgroupid = ${locationGroup}` : '';

            let query = `
                SELECT
                    SUM(qoh.qty * COALESCE(pc.avgCost, 0)) as total_value,
                    COUNT(DISTINCT part.id) as part_count,
                    SUM(qoh.qty) as total_qty
                FROM part
                INNER JOIN qtyonhand qoh ON part.id = qoh.partid
                LEFT JOIN partcost pc ON part.id = pc.partid
                WHERE part.activeflag = 1
                    AND qoh.qty > 0
                    ${locationCondition}
            `;

            debugLog('KPI Query: ' + query.replace(/\s+/g, ' ').trim(), 'info');
            try {
                const rawResult = runQuery(query);
                debugLog('KPI Query raw result: ' + rawResult, 'info');
                if (!rawResult || rawResult === 'null' || rawResult === '') {
                    debugLog('KPI Query returned empty/null result', 'warning');
                    return [];
                }
                const result = JSON.parse(rawResult);
                debugLog('KPI Query parsed: ' + JSON.stringify(result), 'info');
                return result;
            } catch (e) {
                debugLog('Error getting KPI metrics: ' + e.message, 'error');
                console.error('KPI Query error:', e);
                console.log('Query was:', query);
                return [];
            }
        }

        function getBelowReorderCount() {
            const locationGroup = document.getElementById('locationGroupFilter').value;
            const productCategory = document.getElementById('productCategoryFilter').value;
            const vendorFilter = document.getElementById('vendorFilter').value;

            let lgCondition = locationGroup !== '%' ? `AND lg.id = ${locationGroup}` : '';
            let categoryCondition = productCategory !== '%' ? `AND pt.name = '${productCategory}'` : '';
            let vendorCondition = vendorFilter !== '%' ? `AND EXISTS (SELECT 1 FROM vendorparts vp WHERE vp.partid = p.id AND vp.vendorid = ${vendorFilter} AND vp.defaultflag = 1)` : '';

            // Count parts below reorder point
            const query = `
                SELECT COUNT(DISTINCT p.id) as below_reorder
                FROM part p
                INNER JOIN partreorder pr ON p.id = pr.partid
                INNER JOIN locationgroup lg ON pr.locationgroupid = lg.id
                LEFT JOIN qtyonhand qoh ON p.id = qoh.partid AND qoh.locationgroupid = lg.id
                LEFT JOIN producttree pt ON p.treeId = pt.id
                WHERE p.activeflag = 1
                    AND p.typeid = 10
                    AND pr.reorderpoint IS NOT NULL
                    AND pr.reorderpoint > 0
                    AND COALESCE(qoh.qty, 0) < pr.reorderpoint
                    ${lgCondition}
                    ${categoryCondition}
                    ${vendorCondition}
            `;

            debugLog('Below Reorder Query executing...', 'info');
            try {
                const result = JSON.parse(runQuery(query));
                return result && result.length > 0 ? parseInt(result[0].below_reorder || 0) : 0;
            } catch (e) {
                debugLog('Error getting below reorder count: ' + e.message, 'error');
                return 0;
            }
        }

        function loadLocationGroups() {
            const query = `SELECT id, name FROM locationgroup WHERE activeflag = 1 ORDER BY name`;
            const locations = JSON.parse(runQuery(query));

            const selector = document.getElementById('locationGroupFilter');
            selector.innerHTML = '<option value="%">All Locations</option>';

            locations.forEach(lg => {
                selector.innerHTML += `<option value="${lg.id}">${lg.name}</option>`;
            });
        }

        function loadProductCategories() {
            const query = `SELECT DISTINCT name FROM producttree WHERE activeflag = 1 AND name IS NOT NULL AND name != '' ORDER BY name`;
            try {
                const categories = JSON.parse(runQuery(query));
                const selector = document.getElementById('productCategoryFilter');
                selector.innerHTML = '<option value="%">All Categories</option>';

                categories.forEach(cat => {
                    if (cat.name) {
                        selector.innerHTML += `<option value="${cat.name}">${cat.name}</option>`;
                    }
                });
            } catch (e) {
                console.error('Error loading product categories:', e);
            }
        }

        function loadVendors() {
            const query = `
                SELECT DISTINCT v.id, v.name
                FROM vendor v
                INNER JOIN vendorparts vp ON v.id = vp.vendorid AND vp.defaultflag = 1
                WHERE v.activeflag = 1
                ORDER BY v.name
            `;
            try {
                const vendors = JSON.parse(runQuery(query));
                const selector = document.getElementById('vendorFilter');
                selector.innerHTML = '<option value="%">All Vendors</option>';

                vendors.forEach(vendor => {
                    if (vendor.name) {
                        selector.innerHTML += `<option value="${vendor.id}">${vendor.name}</option>`;
                    }
                });
            } catch (e) {
                console.error('Error loading vendors:', e);
            }
        }

        function getShortParts() {
            const locationGroup = document.getElementById('locationGroupFilter').value;
            let lgCondition = locationGroup !== '%' ? `AND Pick.LocationGroupId = ${locationGroup}` : '';

            // Count distinct parts in picking that are short (insufficient qty to fulfill pick)
            const query = `
                SELECT COUNT(DISTINCT pi.partId) as short_count
                FROM PickItem pi
                INNER JOIN Pick ON pi.PickId = Pick.Id
                WHERE Pick.StatusId < 40
                    AND pi.StatusId < 40
                    ${lgCondition}
                    AND (
                        pi.StatusId IN (5, 6)
                        OR (
                            pi.StatusId IN (10, 11, 20)
                            AND (
                                COALESCE((SELECT qty FROM qtyonhand WHERE partId = pi.PartId AND locationGroupId = Pick.LocationGroupId), 0)
                                - COALESCE((SELECT qty FROM qtycommitted WHERE partId = pi.PartId AND locationGroupId = Pick.LocationGroupId), 0)
                                - COALESCE((SELECT qty FROM qtynotavailabletopick WHERE partId = pi.PartId AND locationGroupId = Pick.LocationGroupId), 0)
                            ) < pi.Qty
                        )
                    )
            `;

            debugLog('Short Parts Query: ' + query.substring(0, 100) + '...', 'info');
            try {
                const result = JSON.parse(runQuery(query));
                return result && result.length > 0 ? parseInt(result[0].short_count || 0) : 0;
            } catch (e) {
                debugLog('Error getting short parts: ' + e.message, 'error');
                return 0;
            }
        }

        function getShortPartsDetail() {
            const locationGroup = document.getElementById('locationGroupFilter').value;
            let lgCondition = locationGroup !== '%' ? `AND Pick.LocationGroupId = ${locationGroup}` : '';

            // Get detailed short parts info with pick numbers and availability
            const query = `
                SELECT
                    p.num AS part_num,
                    p.description,
                    Pick.num AS pick_num,
                    pi.Qty AS qty_needed,
                    (
                        COALESCE((SELECT qty FROM qtyonhand WHERE partId = p.id AND locationGroupId = Pick.LocationGroupId), 0)
                        - COALESCE((SELECT qty FROM qtycommitted WHERE partId = p.id AND locationGroupId = Pick.LocationGroupId), 0)
                        - COALESCE((SELECT qty FROM qtynotavailabletopick WHERE partId = p.id AND locationGroupId = Pick.LocationGroupId), 0)
                    ) AS qty_available,
                    COALESCE(
                        (SELECT So.Num FROM SoItem si JOIN So ON si.SoId = So.Id WHERE si.Id = pi.SoItemId),
                        (SELECT Po.Num FROM PoItem JOIN Po ON PoItem.PoId = Po.Id WHERE PoItem.Id = pi.PoItemId),
                        (SELECT Wo.Num FROM WoItem JOIN Wo ON WoItem.WoId = Wo.Id WHERE WoItem.Id = pi.WoItemId),
                        'N/A'
                    ) AS order_num,
                    pi.OrderTypeId AS order_type_id,
                    COALESCE(SoItem.UnitPrice, 0) AS unit_price,
                    (pi.Qty * COALESCE(SoItem.UnitPrice, 0)) AS line_value
                FROM PickItem pi
                INNER JOIN Pick ON pi.PickId = Pick.Id
                INNER JOIN part p ON pi.PartId = p.id
                LEFT JOIN SoItem ON SoItem.Id = pi.SoItemId
                WHERE Pick.StatusId < 40
                    AND pi.StatusId < 40
                    ${lgCondition}
                    AND (
                        pi.StatusId IN (5, 6)
                        OR (
                            pi.StatusId IN (10, 11, 20)
                            AND (
                                COALESCE((SELECT qty FROM qtyonhand WHERE partId = pi.PartId AND locationGroupId = Pick.LocationGroupId), 0)
                                - COALESCE((SELECT qty FROM qtycommitted WHERE partId = pi.PartId AND locationGroupId = Pick.LocationGroupId), 0)
                                - COALESCE((SELECT qty FROM qtynotavailabletopick WHERE partId = pi.PartId AND locationGroupId = Pick.LocationGroupId), 0)
                            ) < pi.Qty
                        )
                    )
                ORDER BY p.num, Pick.num
            `;

            debugLog('Short Parts Detail Query executing...', 'info');
            console.log('Short Parts Detail Query:', query);
            try {
                const rawResult = runQuery(query);
                debugLog('Short Parts Detail raw result: ' + (rawResult ? rawResult.substring(0, 200) : 'null'), 'info');
                const result = JSON.parse(rawResult);
                debugLog('Short Parts Detail returned ' + (result ? result.length : 0) + ' rows', 'info');
                return result;
            } catch (e) {
                debugLog('Error getting short parts detail: ' + e.message, 'error');
                console.error('Short Parts Detail error:', e);
                return [];
            }
        }

        function getCycleCountData() {
            const locationGroup = document.getElementById('locationGroupFilter').value;
            const vendorFilter = document.getElementById('vendorFilter').value;
            let lgCondition = locationGroup !== '%' ? `AND INVENTORYLOG.LOCATIONGROUPID = ${locationGroup}` : '';
            let vendorCondition = vendorFilter !== '%' ? `AND EXISTS (SELECT 1 FROM vendorparts vp WHERE vp.partid = PART.id AND vp.vendorid = ${vendorFilter} AND vp.defaultflag = 1)` : '';

            // Cycle count adjustments using POST table for historical cost
            // POST.TYPEID = 50 for inventory adjustments, REFITEMID = 3 for Cycle Count
            // Exclude zero-quantity adjustments (inventory count with no change)
            const query = `
                SELECT
                    COUNT(DISTINCT PART.id) AS part_count,
                    SUM(ABS(COALESCE(POST.QUANTITY, 0))) AS total_qty_adjusted,
                    SUM(COALESCE(POST.AMOUNT, 0)) AS net_value_change
                FROM POST
                INNER JOIN PART ON POST.REFID = PART.ID
                LEFT JOIN INVENTORYLOG ON INVENTORYLOG.RECORDID = POST.ID AND INVENTORYLOG.TABLEID = -1407594912
                WHERE POST.TYPEID = 50
                    AND POST.REFITEMID = 3
                    AND COALESCE(POST.QUANTITY, 0) != 0
                    AND ${getDateCondition('POST.DATECREATED')}
                    AND PART.activeflag = 1
                    AND PART.typeid = 10
                    ${lgCondition}
                    ${vendorCondition}
            `;

            debugLog('Cycle Count Query: ' + query.replace(/\\s+/g, ' ').trim(), 'info');
            try {
                return JSON.parse(runQuery(query));
            } catch (e) {
                debugLog('Error getting cycle count data: ' + e.message, 'error');
                return [];
            }
        }

        function getCycleCountDetail() {
            const locationGroup = document.getElementById('locationGroupFilter').value;
            const vendorFilter = document.getElementById('vendorFilter').value;
            let lgCondition = locationGroup !== '%' ? `AND INVENTORYLOG.LOCATIONGROUPID = ${locationGroup}` : '';
            let vendorCondition = vendorFilter !== '%' ? `AND EXISTS (SELECT 1 FROM vendorparts vp WHERE vp.partid = PART.id AND vp.vendorid = ${vendorFilter} AND vp.defaultflag = 1)` : '';

            // Cycle count detail using POST table for historical cost - individual adjustments (not grouped)
            // Exclude zero-quantity adjustments (inventory count with no change)
            const query = `
                SELECT
                    PART.num AS part_num,
                    PART.description,
                    COALESCE(POST.QUANTITY, 0) AS qty_adjusted,
                    COALESCE(POST.AMOUNT, 0) AS value_adjusted,
                    POST.DATECREATED AS date_adjusted,
                    COALESCE(LOCGRP.name, 'Unknown') AS location_group,
                    COALESCE(INVENTORYLOG.info, '') AS notes
                FROM POST
                INNER JOIN PART ON POST.REFID = PART.ID
                LEFT JOIN INVENTORYLOG ON INVENTORYLOG.RECORDID = POST.ID AND INVENTORYLOG.TABLEID = -1407594912
                LEFT JOIN LOCATIONGROUP LOCGRP ON INVENTORYLOG.LOCATIONGROUPID = LOCGRP.ID
                WHERE POST.TYPEID = 50
                    AND POST.REFITEMID = 3
                    AND COALESCE(POST.QUANTITY, 0) != 0
                    AND ${getDateCondition('POST.DATECREATED')}
                    AND PART.activeflag = 1
                    AND PART.typeid = 10
                    ${lgCondition}
                    ${vendorCondition}
                ORDER BY POST.DATECREATED DESC
            `;

            debugLog('Cycle Count Detail Query: ' + query.replace(/\\s+/g, ' ').trim(), 'info');
            try {
                return JSON.parse(runQuery(query));
            } catch (e) {
                debugLog('Error getting cycle count detail: ' + e.message, 'error');
                return [];
            }
        }

        function getScrapData() {
            const locationGroup = document.getElementById('locationGroupFilter').value;
            const vendorFilter = document.getElementById('vendorFilter').value;
            let lgCondition = locationGroup !== '%' ? `AND INVENTORYLOG.LOCATIONGROUPID = ${locationGroup}` : '';
            let vendorCondition = vendorFilter !== '%' ? `AND EXISTS (SELECT 1 FROM vendorparts vp WHERE vp.partid = PART.id AND vp.vendorid = ${vendorFilter} AND vp.defaultflag = 1)` : '';

            // Scrap using POST table for historical cost
            // POST.TYPEID = 50 for inventory adjustments, REFITEMID = 2 for Scrap
            const query = `
                SELECT
                    COUNT(DISTINCT PART.id) AS part_count,
                    SUM(ABS(COALESCE(POST.AMOUNT, 0))) AS total_value_scrapped,
                    SUM(ABS(COALESCE(POST.QUANTITY, 0))) AS total_qty_scrapped
                FROM POST
                INNER JOIN PART ON POST.REFID = PART.ID
                LEFT JOIN INVENTORYLOG ON INVENTORYLOG.RECORDID = POST.ID AND INVENTORYLOG.TABLEID = -1407594912
                WHERE POST.TYPEID = 50
                    AND POST.REFITEMID = 2
                    AND ${getDateCondition('POST.DATECREATED')}
                    AND PART.activeflag = 1
                    AND PART.typeid = 10
                    ${lgCondition}
                    ${vendorCondition}
            `;

            debugLog('Scrap Query: ' + query.replace(/\\s+/g, ' ').trim(), 'info');
            try {
                return JSON.parse(runQuery(query));
            } catch (e) {
                debugLog('Error getting scrap data: ' + e.message, 'error');
                return [];
            }
        }

        function getScrapDetail() {
            const locationGroup = document.getElementById('locationGroupFilter').value;
            const vendorFilter = document.getElementById('vendorFilter').value;
            let lgCondition = locationGroup !== '%' ? `AND INVENTORYLOG.LOCATIONGROUPID = ${locationGroup}` : '';
            let vendorCondition = vendorFilter !== '%' ? `AND EXISTS (SELECT 1 FROM vendorparts vp WHERE vp.partid = PART.id AND vp.vendorid = ${vendorFilter} AND vp.defaultflag = 1)` : '';

            // Scrap detail using POST table for historical cost - individual scrap entries (not grouped)
            const query = `
                SELECT
                    PART.num AS part_num,
                    PART.description,
                    ABS(COALESCE(POST.QUANTITY, 0)) AS qty_scrapped,
                    ABS(COALESCE(POST.AMOUNT, 0)) AS value_scrapped,
                    POST.DATECREATED AS date_scrapped,
                    COALESCE(LOCGRP.name, 'Unknown') AS location_group,
                    COALESCE(INVENTORYLOG.info, '') AS notes
                FROM POST
                INNER JOIN PART ON POST.REFID = PART.ID
                LEFT JOIN INVENTORYLOG ON INVENTORYLOG.RECORDID = POST.ID AND INVENTORYLOG.TABLEID = -1407594912
                LEFT JOIN LOCATIONGROUP LOCGRP ON INVENTORYLOG.LOCATIONGROUPID = LOCGRP.ID
                WHERE POST.TYPEID = 50
                    AND POST.REFITEMID = 2
                    AND ${getDateCondition('POST.DATECREATED')}
                    AND PART.activeflag = 1
                    AND PART.typeid = 10
                    ${lgCondition}
                    ${vendorCondition}
                ORDER BY POST.DATECREATED DESC
            `;

            debugLog('Scrap Detail Query: ' + query.replace(/\\s+/g, ' ').trim(), 'info');
            try {
                return JSON.parse(runQuery(query));
            } catch (e) {
                debugLog('Error getting scrap detail: ' + e.message, 'error');
                return [];
            }
        }

        // Fulfillment Pipeline - SO items picked but awaiting pack/ship
        // Uses Ship.StatusId: 10 = Entered (not packed), 20 = Packed (awaiting ship)
        // OrderTypeId 20 = Sales Orders only
        function getFulfillmentPipeline() {
            try {
                const query = `
                    SELECT
                        Ship.Id AS shipId,
                        Ship.Num AS shipNum,
                        Ship.StatusId AS statusId,
                        ShipStatus.Name AS statusName,
                        So.Num AS soNum,
                        So.Id AS soId,
                        Customer.Name AS customerName,
                        So.DateFirstShip AS dateScheduled,
                        ShipItem.QtyShipped AS qty,
                        SoItem.UnitPrice AS unitPrice,
                        (ShipItem.QtyShipped * SoItem.UnitPrice) AS lineValue,
                        Product.Num AS productNum,
                        Product.Description AS productDesc,
                        Part.Num AS partNum
                    FROM Ship
                    INNER JOIN ShipItem ON ShipItem.ShipId = Ship.Id
                    INNER JOIN SoItem ON SoItem.Id = ShipItem.SoItemId
                    INNER JOIN So ON So.Id = SoItem.SoId
                    INNER JOIN Product ON Product.Id = SoItem.ProductId
                    INNER JOIN Part ON Part.Id = Product.PartId
                    LEFT JOIN Customer ON Customer.Id = So.CustomerId
                    LEFT JOIN ShipStatus ON ShipStatus.Id = Ship.StatusId
                    WHERE Ship.OrderTypeId = 20
                    AND Ship.StatusId IN (10, 20)
                    ORDER BY So.DateFirstShip ASC, So.Num, Ship.Num
                `;
                debugLog('Fulfillment Pipeline query: ' + query.replace(/\\s+/g, ' ').trim(), 'info');
                const result = JSON.parse(runQuery(query));
                debugLog('Fulfillment Pipeline returned ' + (result ? result.length : 0) + ' rows', 'info');
                return result || [];
            } catch (error) {
                debugLog('ERROR in getFulfillmentPipeline: ' + error.message, 'error');
                return [];
            }
        }

        // Fulfillment Pipeline Summary (aggregated counts and values by status)
        function getFulfillmentPipelineSummary() {
            try {
                const query = `
                    SELECT
                        Ship.StatusId AS statusId,
                        ShipStatus.Name AS statusName,
                        COUNT(DISTINCT Ship.Id) AS shipCount,
                        COUNT(ShipItem.Id) AS itemCount,
                        SUM(ShipItem.QtyShipped * SoItem.UnitPrice) AS totalValue
                    FROM Ship
                    INNER JOIN ShipItem ON ShipItem.ShipId = Ship.Id
                    INNER JOIN SoItem ON SoItem.Id = ShipItem.SoItemId
                    LEFT JOIN ShipStatus ON ShipStatus.Id = Ship.StatusId
                    WHERE Ship.OrderTypeId = 20
                    AND Ship.StatusId IN (10, 20)
                    GROUP BY Ship.StatusId, ShipStatus.Name
                    ORDER BY Ship.StatusId
                `;
                debugLog('Fulfillment Pipeline Summary query: ' + query.replace(/\\s+/g, ' ').trim(), 'info');
                const result = JSON.parse(runQuery(query));
                debugLog('Fulfillment Pipeline Summary returned ' + (result ? result.length : 0) + ' rows', 'info');
                return result || [];
            } catch (error) {
                debugLog('ERROR in getFulfillmentPipelineSummary: ' + error.message, 'error');
                return [];
            }
        }

        function getUnavailableData() {
            const locationGroup = document.getElementById('locationGroupFilter').value;
            const productCategory = document.getElementById('productCategoryFilter').value;
            const vendorFilter = document.getElementById('vendorFilter').value;

            let lgCondition = locationGroup !== '%' ? `AND qna.locationgroupid = ${locationGroup}` : '';
            let categoryCondition = productCategory !== '%' ? `AND pt.name = '${productCategory}'` : '';
            let vendorCondition = vendorFilter !== '%' ? `AND EXISTS (SELECT 1 FROM vendorparts vp WHERE vp.partid = p.id AND vp.vendorid = ${vendorFilter} AND vp.defaultflag = 1)` : '';

            const query = `
                SELECT
                    SUM(qna.qty * COALESCE(pc.avgCost, 0)) AS total_value,
                    COUNT(DISTINCT qna.partid) AS part_count,
                    SUM(qna.qty) AS total_qty
                FROM qtynotavailable qna
                INNER JOIN part p ON qna.partid = p.id
                LEFT JOIN partcost pc ON p.id = pc.partid
                LEFT JOIN producttree pt ON p.treeId = pt.id
                WHERE p.activeflag = 1
                    AND p.typeid = 10
                    ${lgCondition}
                    ${categoryCondition}
                    ${vendorCondition}
            `;

            debugLog('Unavailable Stock Query executing...', 'info');
            try {
                return JSON.parse(runQuery(query));
            } catch (e) {
                debugLog('Error getting unavailable data: ' + e.message, 'error');
                return [];
            }
        }

        function getUnavailableDetail() {
            const locationGroup = document.getElementById('locationGroupFilter').value;
            const productCategory = document.getElementById('productCategoryFilter').value;
            const vendorFilter = document.getElementById('vendorFilter').value;

            let lgCondition = locationGroup !== '%' ? `AND qna.locationgroupid = ${locationGroup}` : '';
            let categoryCondition = productCategory !== '%' ? `AND pt.name = '${productCategory}'` : '';
            let vendorCondition = vendorFilter !== '%' ? `AND EXISTS (SELECT 1 FROM vendorparts vp WHERE vp.partid = p.id AND vp.vendorid = ${vendorFilter} AND vp.defaultflag = 1)` : '';

            const query = `
                SELECT
                    p.num AS part_num,
                    p.description,
                    lg.name AS location_group,
                    qna.qty AS qty_unavailable,
                    qna.qty * COALESCE(pc.avgCost, 0) AS value_unavailable,
                    COALESCE(pc.avgCost, 0) AS avg_cost
                FROM qtynotavailable qna
                INNER JOIN part p ON qna.partid = p.id
                INNER JOIN locationgroup lg ON qna.locationgroupid = lg.id
                LEFT JOIN partcost pc ON p.id = pc.partid
                LEFT JOIN producttree pt ON p.treeId = pt.id
                WHERE p.activeflag = 1
                    AND p.typeid = 10
                    AND qna.qty > 0
                    ${lgCondition}
                    ${categoryCondition}
                    ${vendorCondition}
                ORDER BY value_unavailable DESC
            `;

            debugLog('Unavailable Detail Query executing...', 'info');
            try {
                return JSON.parse(runQuery(query));
            } catch (e) {
                debugLog('Error getting unavailable detail: ' + e.message, 'error');
                return [];
            }
        }

        function getBelowReorderDetail() {
            const locationGroup = document.getElementById('locationGroupFilter').value;
            const productCategory = document.getElementById('productCategoryFilter').value;
            const vendorFilter = document.getElementById('vendorFilter').value;

            let lgCondition = locationGroup !== '%' ? `AND lg.id = ${locationGroup}` : '';
            let categoryCondition = productCategory !== '%' ? `AND pt.name = '${productCategory}'` : '';
            let vendorCondition = vendorFilter !== '%' ? `AND EXISTS (SELECT 1 FROM vendorparts vp WHERE vp.partid = p.id AND vp.vendorid = ${vendorFilter} AND vp.defaultflag = 1)` : '';

            const query = `
                SELECT
                    p.num AS part_num,
                    p.description,
                    lg.name AS location_group,
                    COALESCE(qoh.qty, 0) AS qty_on_hand,
                    pr.reorderpoint AS reorder_point,
                    (pr.reorderpoint - COALESCE(qoh.qty, 0)) AS qty_short,
                    COALESCE(pc.avgCost, 0) AS avg_cost
                FROM part p
                INNER JOIN partreorder pr ON p.id = pr.partid
                INNER JOIN locationgroup lg ON pr.locationgroupid = lg.id
                LEFT JOIN qtyonhand qoh ON p.id = qoh.partid AND qoh.locationgroupid = lg.id
                LEFT JOIN partcost pc ON p.id = pc.partid
                LEFT JOIN producttree pt ON p.treeId = pt.id
                WHERE p.activeflag = 1
                    AND p.typeid = 10
                    AND pr.reorderpoint IS NOT NULL
                    AND pr.reorderpoint > 0
                    AND COALESCE(qoh.qty, 0) < pr.reorderpoint
                    ${lgCondition}
                    ${categoryCondition}
                    ${vendorCondition}
                ORDER BY qty_short DESC
            `;

            debugLog('Below Reorder Detail Query executing...', 'info');
            try {
                return JSON.parse(runQuery(query));
            } catch (e) {
                debugLog('Error getting below reorder detail: ' + e.message, 'error');
                return [];
            }
        }

        // ============================================
        // Modal Show Functions
        // ============================================
        function showShortPartsModal() {
            try {
                debugLog('Loading short parts details...', 'click');
                const data = getShortPartsDetail();
                currentDrilldownData = data;
                currentDrilldownSort = { column: null, direction: 'asc' };

                if (!data || data.length === 0) {
                    showDrilldown('Short Parts in Picking', 'Parts with insufficient stock', '<p class="text-center text-slate-500 py-8">No short parts found</p>', '');
                    return;
                }

                // Helper to get order type prefix and opener function
                const getOrderInfo = (typeId) => {
                    if (typeId === 10) return { prefix: 'PO-', opener: 'openPurchaseOrder' };
                    if (typeId === 20) return { prefix: 'SO-', opener: 'openSalesOrder' };
                    if (typeId === 30) return { prefix: 'WO-', opener: 'openWorkOrder' };
                    if (typeId === 40) return { prefix: 'TO-', opener: 'openTransferOrder' };
                    return { prefix: '', opener: null };
                };

                function renderTable() {
                    let sortedData = data;
                    if (currentDrilldownSort.column) {
                        const colTypes = { part_num: 'string', description: 'string', pick_num: 'string', order_num: 'string', qty_needed: 'number', qty_available: 'number', qty_short: 'number' };
                        sortedData = sortDrilldownData(data, currentDrilldownSort.column, currentDrilldownSort.direction, colTypes[currentDrilldownSort.column] || 'string');
                    }

                    const uniqueParts = new Set(data.map(r => r.part_num)).size;
                    const uniquePicks = new Set(data.map(r => r.pick_num)).size;

                    let tableHtml = `
                        <div class="drilldown-table-wrapper">
                            <table class="drilldown-table text-sm">
                                <thead>
                                    <tr>
                                        <th class="${getSortClass('part_num')} px-4 py-3 text-left font-semibold text-slate-700" onclick="handleColumnSort('part_num', 'string', renderShortPartsTable)">Part Number${getSortIcon()}</th>
                                        <th class="${getSortClass('description')} px-4 py-3 text-left font-semibold text-slate-700" onclick="handleColumnSort('description', 'string', renderShortPartsTable)">Description${getSortIcon()}</th>
                                        <th class="${getSortClass('pick_num')} px-4 py-3 text-left font-semibold text-slate-700" onclick="handleColumnSort('pick_num', 'string', renderShortPartsTable)">Pick #${getSortIcon()}</th>
                                        <th class="${getSortClass('order_num')} px-4 py-3 text-left font-semibold text-slate-700" onclick="handleColumnSort('order_num', 'string', renderShortPartsTable)">Order #${getSortIcon()}</th>
                                        <th class="${getSortClass('qty_needed')} px-4 py-3 text-right font-semibold text-slate-700" onclick="handleColumnSort('qty_needed', 'number', renderShortPartsTable)">Needed${getSortIcon()}</th>
                                        <th class="${getSortClass('qty_available')} px-4 py-3 text-right font-semibold text-slate-700" onclick="handleColumnSort('qty_available', 'number', renderShortPartsTable)">Available${getSortIcon()}</th>
                                        <th class="${getSortClass('qty_short')} px-4 py-3 text-right font-semibold text-slate-700" onclick="handleColumnSort('qty_short', 'number', renderShortPartsTable)">Short${getSortIcon()}</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-200">
                    `;

                    sortedData.forEach(row => {
                        const qtyNeeded = parseFloat(row.qty_needed || 0);
                        const qtyAvailable = parseFloat(row.qty_available || 0);
                        const qtyShort = Math.max(0, qtyNeeded - Math.max(0, qtyAvailable));
                        row.qty_short = qtyShort; // Add for sorting
                        const orderInfo = getOrderInfo(row.order_type_id);
                        const orderNum = row.order_num || '';
                        const orderDisplay = orderInfo.prefix + orderNum;

                        const pickLink = row.pick_num
                            ? `<a href="#" class="text-blue-600 hover:text-blue-800 hover:underline" onclick="event.stopPropagation(); openPick('${escapeSQL(row.pick_num)}'); return false;">${row.pick_num}</a>`
                            : '';

                        let orderLink = orderDisplay;
                        if (orderNum && orderNum !== 'N/A' && orderInfo.opener) {
                            orderLink = `<a href="#" class="text-blue-600 hover:text-blue-800 hover:underline" onclick="event.stopPropagation(); ${orderInfo.opener}('${escapeSQL(orderNum)}'); return false;">${orderDisplay}</a>`;
                        }

                        tableHtml += `
                            <tr class="hover:bg-slate-50">
                                <td class="px-4 py-3 font-mono text-sm">${row.part_num || ''}</td>
                                <td class="px-4 py-3">${row.description || ''}</td>
                                <td class="px-4 py-3 font-mono text-sm">${pickLink}</td>
                                <td class="px-4 py-3 font-mono text-sm">${orderLink}</td>
                                <td class="px-4 py-3 text-right">${formatQty(qtyNeeded)}</td>
                                <td class="px-4 py-3 text-right ${qtyAvailable < 0 ? 'text-red-600' : ''}">${formatQty(qtyAvailable)}</td>
                                <td class="px-4 py-3 text-right text-red-600 font-medium">${formatQty(qtyShort)}</td>
                            </tr>
                        `;
                    });

                    tableHtml += '</tbody></table></div>';

                    const footer = `
                        <div class="flex justify-between items-center">
                            <span><strong>${uniqueParts}</strong> unique parts short</span>
                            <span><strong>${uniquePicks}</strong> picks affected</span>
                            <span><strong>${data.length}</strong> line items</span>
                        </div>
                    `;

                    document.getElementById('drilldownContent').innerHTML = tableHtml;
                    document.getElementById('drilldownFooter').innerHTML = footer;
                }

                window.renderShortPartsTable = renderTable;
                renderTable();
                document.getElementById('drilldownTitle').textContent = 'Short Parts in Picking';
                document.getElementById('drilldownSubtitle').textContent = 'Parts with insufficient stock to complete picks';
                document.getElementById('drilldownModal').classList.remove('hidden');
                document.getElementById('drilldownModal').classList.add('flex');
            } catch (e) {
                debugLog('Error in showShortPartsModal: ' + e.message, 'error');
                showDrilldown('Short Parts in Picking', 'Error', '<p class="text-center text-red-500 py-8">Error loading data: ' + e.message + '</p>', '');
            }
        }

        function showCycleCountModal() {
            debugLog('Loading cycle count details...', 'click');
            const data = getCycleCountDetail();
            currentDrilldownData = data;

            if (data.length === 0) {
                showDrilldown('Cycle Count Adjustments', 'No cycle count adjustments found', '<p class="text-center text-slate-500 py-8">No cycle count adjustments in this period</p>', '');
                return;
            }

            const totalValueAdjusted = data.reduce((sum, r) => sum + parseFloat(r.value_adjusted || 0), 0);
            const totalQtyAdjusted = data.reduce((sum, r) => sum + parseFloat(r.qty_adjusted || 0), 0);
            const uniqueParts = new Set(data.map(r => r.part_num)).size;

            let tableHtml = `
                <table class="w-full text-sm">
                    <thead class="bg-slate-100 sticky top-0 z-10">
                        <tr>
                            <th class="px-4 py-3 text-left font-semibold text-slate-700">Date</th>
                            <th class="px-4 py-3 text-left font-semibold text-slate-700">Part Number</th>
                            <th class="px-4 py-3 text-left font-semibold text-slate-700">Description</th>
                            <th class="px-4 py-3 text-left font-semibold text-slate-700">Location</th>
                            <th class="px-4 py-3 text-right font-semibold text-slate-700">Qty</th>
                            <th class="px-4 py-3 text-right font-semibold text-slate-700">Value</th>
                            <th class="px-4 py-3 text-left font-semibold text-slate-700">Notes</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-200">
            `;

            data.forEach(row => {
                const qtyAdj = parseFloat(row.qty_adjusted || 0);
                const valueAdj = parseFloat(row.value_adjusted || 0);
                const qtyColor = qtyAdj >= 0 ? 'text-green-600' : 'text-red-600';
                const valueColor = valueAdj >= 0 ? 'text-green-600' : 'text-red-600';

                tableHtml += `
                    <tr class="hover:bg-slate-50">
                        <td class="px-4 py-3 text-slate-500">${moment(row.date_adjusted).format(MOMENT_DATE_FORMAT)}</td>
                        <td class="px-4 py-3 font-mono text-sm">${row.part_num}</td>
                        <td class="px-4 py-3">${row.description || ''}</td>
                        <td class="px-4 py-3">${row.location_group || ''}</td>
                        <td class="px-4 py-3 text-right ${qtyColor} font-medium">${qtyAdj >= 0 ? '+' : ''}${formatQty(qtyAdj)}</td>
                        <td class="px-4 py-3 text-right ${valueColor} font-medium">${valueAdj >= 0 ? '+' : ''}${formatCurrency(valueAdj)}</td>
                        <td class="px-4 py-3 text-xs text-slate-500 max-w-xs truncate" title="${row.notes || ''}">${row.notes || '-'}</td>
                    </tr>
                `;
            });

            tableHtml += '</tbody></table>';

            const netColor = totalValueAdjusted >= 0 ? 'text-green-600' : 'text-red-600';
            const footer = `
                <div class="flex justify-between items-center">
                    <span><strong>${uniqueParts}</strong> unique parts adjusted</span>
                    <span><strong>${data.length}</strong> total adjustments</span>
                    <span>Net Value: <strong class="${netColor}">${totalValueAdjusted >= 0 ? '+' : ''}${formatCurrency(totalValueAdjusted)}</strong></span>
                </div>
            `;

            showDrilldown('Cycle Count Adjustments', 'Inventory adjustments in selected period', tableHtml, footer);
        }

        function showScrapModal() {
            debugLog('Loading scrap details...', 'click');
            const data = getScrapDetail();
            currentDrilldownData = data;

            if (data.length === 0) {
                showDrilldown('Scrapped Items', 'No scrapped items found', '<p class="text-center text-slate-500 py-8">No scrapped items in this period</p>', '');
                return;
            }

            const totalValueScrapped = data.reduce((sum, r) => sum + parseFloat(r.value_scrapped || 0), 0);
            const totalQtyScrapped = data.reduce((sum, r) => sum + parseFloat(r.qty_scrapped || 0), 0);
            const uniqueParts = new Set(data.map(r => r.part_num)).size;

            let tableHtml = `
                <table class="w-full text-sm">
                    <thead class="bg-slate-100 sticky top-0 z-10">
                        <tr>
                            <th class="px-4 py-3 text-left font-semibold text-slate-700">Date</th>
                            <th class="px-4 py-3 text-left font-semibold text-slate-700">Part Number</th>
                            <th class="px-4 py-3 text-left font-semibold text-slate-700">Description</th>
                            <th class="px-4 py-3 text-left font-semibold text-slate-700">Location</th>
                            <th class="px-4 py-3 text-right font-semibold text-slate-700">Qty</th>
                            <th class="px-4 py-3 text-right font-semibold text-slate-700">Value</th>
                            <th class="px-4 py-3 text-left font-semibold text-slate-700">Notes</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-200">
            `;

            data.forEach(row => {
                tableHtml += `
                    <tr class="hover:bg-slate-50">
                        <td class="px-4 py-3 text-slate-500">${moment(row.date_scrapped).format(MOMENT_DATE_FORMAT)}</td>
                        <td class="px-4 py-3 font-mono text-sm">${row.part_num}</td>
                        <td class="px-4 py-3">${row.description || ''}</td>
                        <td class="px-4 py-3">${row.location_group || ''}</td>
                        <td class="px-4 py-3 text-right text-red-600 font-medium">${formatQty(row.qty_scrapped)}</td>
                        <td class="px-4 py-3 text-right text-red-600 font-medium">${formatCurrency(row.value_scrapped)}</td>
                        <td class="px-4 py-3 text-xs text-slate-500 max-w-xs truncate" title="${row.notes || ''}">${row.notes || '-'}</td>
                    </tr>
                `;
            });

            tableHtml += '</tbody></table>';

            const footer = `
                <div class="flex justify-between items-center">
                    <span><strong>${uniqueParts}</strong> unique parts scrapped</span>
                    <span><strong>${data.length}</strong> total scrap entries</span>
                    <span>Total Value Lost: <strong class="text-red-600">${formatCurrency(totalValueScrapped)}</strong></span>
                </div>
            `;

            showDrilldown('Scrapped Items', 'Items scrapped in selected period', tableHtml, footer);
        }

        function showFulfillmentPipelineModal() {
            debugLog('Loading fulfillment pipeline details...', 'click');
            const data = getFulfillmentPipeline();
            currentDrilldownData = data;
            currentDrilldownSort = { column: null, direction: 'asc' };

            if (data.length === 0) {
                showDrilldown('Picked - Awaiting Pack/Ship', 'No items awaiting pack/ship', '<p class="text-center text-slate-500 py-8">No items awaiting pack/ship</p>', '');
                return;
            }

            function renderTable() {
                let sortedData = data;
                if (currentDrilldownSort.column) {
                    const colTypes = { sonum: 'string', shipnum: 'string', statusname: 'string', customername: 'string', productnum: 'string', qty: 'number', unitprice: 'number', linevalue: 'number', datescheduled: 'date' };
                    sortedData = sortDrilldownData(data, currentDrilldownSort.column, currentDrilldownSort.direction, colTypes[currentDrilldownSort.column] || 'string');
                }

                const totalValue = data.reduce((sum, r) => sum + parseFloat(r.linevalue || 0), 0);
                const uniqueSOs = new Set(data.map(r => r.sonum)).size;

                let tableHtml = `
                    <div class="drilldown-table-wrapper">
                        <table class="drilldown-table text-sm">
                            <thead>
                                <tr>
                                    <th class="${getSortClass('sonum')} px-4 py-3 text-left font-semibold text-slate-700" onclick="handleColumnSort('sonum', 'string', renderFulfillmentTable)">SO #${getSortIcon()}</th>
                                    <th class="${getSortClass('shipnum')} px-4 py-3 text-left font-semibold text-slate-700" onclick="handleColumnSort('shipnum', 'string', renderFulfillmentTable)">Ship #${getSortIcon()}</th>
                                    <th class="${getSortClass('statusname')} px-4 py-3 text-left font-semibold text-slate-700" onclick="handleColumnSort('statusname', 'string', renderFulfillmentTable)">Status${getSortIcon()}</th>
                                    <th class="${getSortClass('customername')} px-4 py-3 text-left font-semibold text-slate-700" onclick="handleColumnSort('customername', 'string', renderFulfillmentTable)">Customer${getSortIcon()}</th>
                                    <th class="${getSortClass('productnum')} px-4 py-3 text-left font-semibold text-slate-700" onclick="handleColumnSort('productnum', 'string', renderFulfillmentTable)">Product${getSortIcon()}</th>
                                    <th class="px-4 py-3 text-left font-semibold text-slate-700">Description</th>
                                    <th class="${getSortClass('qty')} px-4 py-3 text-right font-semibold text-slate-700" onclick="handleColumnSort('qty', 'number', renderFulfillmentTable)">Qty${getSortIcon()}</th>
                                    <th class="${getSortClass('unitprice')} px-4 py-3 text-right font-semibold text-slate-700" onclick="handleColumnSort('unitprice', 'number', renderFulfillmentTable)">Unit Price${getSortIcon()}</th>
                                    <th class="${getSortClass('linevalue')} px-4 py-3 text-right font-semibold text-slate-700" onclick="handleColumnSort('linevalue', 'number', renderFulfillmentTable)">Line Value${getSortIcon()}</th>
                                    <th class="${getSortClass('datescheduled')} px-4 py-3 text-left font-semibold text-slate-700" onclick="handleColumnSort('datescheduled', 'date', renderFulfillmentTable)">Scheduled${getSortIcon()}</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-200">
                `;

                sortedData.forEach(row => {
                    const scheduledDate = row.datescheduled ? moment(row.datescheduled).format(MOMENT_DATE_FORMAT) : '-';
                    tableHtml += `
                        <tr class="hover:bg-slate-50">
                            <td class="px-4 py-3"><a href="#" class="text-cyan-600 hover:underline font-medium" onclick="openModule('Sales Order', '${row.sonum}'); return false;">${row.sonum}</a></td>
                            <td class="px-4 py-3"><a href="#" class="text-cyan-600 hover:underline" onclick="openModule('Shipping', '${row.shipnum}'); return false;">${row.shipnum}</a></td>
                            <td class="px-4 py-3"><span class="px-2 py-1 text-xs rounded ${row.statusid === 10 ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700'}">${row.statusname}</span></td>
                            <td class="px-4 py-3">${row.customername || ''}</td>
                            <td class="px-4 py-3 font-mono text-sm">${row.productnum}</td>
                            <td class="px-4 py-3 max-w-xs truncate" title="${row.productdesc || ''}">${row.productdesc || ''}</td>
                            <td class="px-4 py-3 text-right font-medium">${formatQty(row.qty)}</td>
                            <td class="px-4 py-3 text-right">${formatCurrency(row.unitprice)}</td>
                            <td class="px-4 py-3 text-right font-medium text-cyan-600">${formatCurrency(row.linevalue)}</td>
                            <td class="px-4 py-3 text-slate-500">${scheduledDate}</td>
                        </tr>
                    `;
                });

                tableHtml += '</tbody></table></div>';

                const footer = `
                    <div class="flex justify-between items-center">
                        <span><strong>${uniqueSOs}</strong> Sales Orders</span>
                        <span><strong>${data.length}</strong> line items</span>
                        <span>Total Value: <strong class="text-cyan-600">${formatCurrency(totalValue)}</strong></span>
                    </div>
                `;

                document.getElementById('drilldownContent').innerHTML = tableHtml;
                document.getElementById('drilldownFooter').innerHTML = footer;
            }

            window.renderFulfillmentTable = renderTable;
            renderTable();
            document.getElementById('drilldownTitle').textContent = 'Picked - Awaiting Pack/Ship';
            document.getElementById('drilldownSubtitle').textContent = 'SO items picked but not yet shipped';
            document.getElementById('drilldownModal').classList.remove('hidden');
            document.getElementById('drilldownModal').classList.add('flex');
        }

        function showUnavailableModal() {
            debugLog('Loading unavailable stock details...', 'click');
            const data = getUnavailableDetail();
            currentDrilldownData = data;

            if (data.length === 0) {
                showDrilldown('Unavailable Stock', 'No unavailable stock found', '<p class="text-center text-slate-500 py-8">No unavailable stock</p>', '');
                return;
            }

            const totalValue = data.reduce((sum, r) => sum + parseFloat(r.value_unavailable || 0), 0);
            const totalQty = data.reduce((sum, r) => sum + parseFloat(r.qty_unavailable || 0), 0);

            let tableHtml = `
                <table class="w-full text-sm">
                    <thead class="bg-slate-100 sticky top-0">
                        <tr>
                            <th class="px-4 py-3 text-left font-semibold text-slate-700">Part Number</th>
                            <th class="px-4 py-3 text-left font-semibold text-slate-700">Description</th>
                            <th class="px-4 py-3 text-left font-semibold text-slate-700">Location</th>
                            <th class="px-4 py-3 text-right font-semibold text-slate-700">Qty Unavailable</th>
                            <th class="px-4 py-3 text-right font-semibold text-slate-700">Avg Cost</th>
                            <th class="px-4 py-3 text-right font-semibold text-slate-700">Value</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-200">
            `;

            data.forEach(row => {
                tableHtml += `
                    <tr class="hover:bg-slate-50">
                        <td class="px-4 py-3 font-mono text-sm">${row.part_num}</td>
                        <td class="px-4 py-3">${row.description || ''}</td>
                        <td class="px-4 py-3">${row.location_group || ''}</td>
                        <td class="px-4 py-3 text-right text-amber-600 font-medium">${formatQty(row.qty_unavailable)}</td>
                        <td class="px-4 py-3 text-right">${formatCurrency(row.avg_cost)}</td>
                        <td class="px-4 py-3 text-right font-medium text-amber-600">${formatCurrency(row.value_unavailable)}</td>
                    </tr>
                `;
            });

            tableHtml += '</tbody></table>';

            const footer = `
                <div class="flex justify-between items-center">
                    <span><strong>${data.length}</strong> parts unavailable</span>
                    <span><strong>${formatQty(totalQty)}</strong> total units</span>
                    <span>Total Value: <strong class="text-amber-600">${formatCurrency(totalValue)}</strong></span>
                </div>
            `;

            showDrilldown('Unavailable Stock', 'Stock currently not available for allocation', tableHtml, footer);
        }

        function showBelowReorderModal() {
            debugLog('Loading below reorder details...', 'click');
            const data = getBelowReorderDetail();
            currentDrilldownData = data;

            if (data.length === 0) {
                showDrilldown('Below Reorder Point', 'No parts below reorder', '<p class="text-center text-slate-500 py-8">All parts are above reorder point</p>', '');
                return;
            }

            let tableHtml = `
                <table class="w-full text-sm">
                    <thead class="bg-slate-100 sticky top-0">
                        <tr>
                            <th class="px-4 py-3 text-left font-semibold text-slate-700">Part Number</th>
                            <th class="px-4 py-3 text-left font-semibold text-slate-700">Description</th>
                            <th class="px-4 py-3 text-left font-semibold text-slate-700">Location</th>
                            <th class="px-4 py-3 text-right font-semibold text-slate-700">On Hand</th>
                            <th class="px-4 py-3 text-right font-semibold text-slate-700">Reorder Point</th>
                            <th class="px-4 py-3 text-right font-semibold text-slate-700">Qty Short</th>
                            <th class="px-4 py-3 text-right font-semibold text-slate-700">Avg Cost</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-200">
            `;

            data.forEach(row => {
                const qtyShort = parseFloat(row.qty_short || 0);
                tableHtml += `
                    <tr class="hover:bg-slate-50">
                        <td class="px-4 py-3 font-mono text-sm">${row.part_num}</td>
                        <td class="px-4 py-3">${row.description || ''}</td>
                        <td class="px-4 py-3">${row.location_group || ''}</td>
                        <td class="px-4 py-3 text-right">${formatQty(row.qty_on_hand)}</td>
                        <td class="px-4 py-3 text-right">${formatQty(row.reorder_point)}</td>
                        <td class="px-4 py-3 text-right text-orange-600 font-medium">${formatQty(qtyShort)}</td>
                        <td class="px-4 py-3 text-right">${formatCurrency(row.avg_cost)}</td>
                    </tr>
                `;
            });

            tableHtml += '</tbody></table>';

            const footer = `
                <div class="flex justify-between items-center">
                    <span><strong>${data.length}</strong> parts below reorder point</span>
                    <span>Click Export to download list</span>
                </div>
            `;

            showDrilldown('Below Reorder Point', 'Parts with stock below reorder level', tableHtml, footer);
        }

        function getStockMovements() {
            const locationGroup = document.getElementById('locationGroupFilter').value;
            const productCategory = document.getElementById('productCategoryFilter').value;
            const vendorFilter = document.getElementById('vendorFilter').value;

            let lgCondition = locationGroup !== '%' ? `AND LOCGRP.id = ${locationGroup}` : '';
            let categoryCondition = productCategory !== '%' ? `AND pt.name = '${productCategory}'` : '';
            let vendorCondition = vendorFilter !== '%' ? `AND EXISTS (SELECT 1 FROM vendorparts vp WHERE vp.partid = PART.id AND vp.vendorid = ${vendorFilter} AND vp.defaultflag = 1)` : '';

            // Simplified Part Activity query - grouped by date and event type
            const query = `
                SELECT
                    DATE(INVENTORYLOG.eventDate) as date,
                    INVENTORYLOGTYPE.DESCRIPTION as event_type,
                    SUM(INVENTORYLOG.CHANGEQTY) as total_change,
                    COUNT(*) as transaction_count
                FROM INVENTORYLOG
                INNER JOIN LOCATIONGROUP LOCGRP ON INVENTORYLOG.LOCATIONGROUPID = LOCGRP.ID
                INNER JOIN INVENTORYLOGTYPE ON INVENTORYLOG.TYPEID = INVENTORYLOGTYPE.ID
                INNER JOIN PART ON INVENTORYLOG.PARTID = PART.ID
                LEFT JOIN producttree pt ON PART.treeId = pt.id
                WHERE ${getDateCondition('INVENTORYLOG.eventDate')}
                    AND PART.activeflag = 1
                    AND PART.typeid = 10
                    ${lgCondition}
                    ${categoryCondition}
                    ${vendorCondition}
                GROUP BY DATE(INVENTORYLOG.eventDate), INVENTORYLOGTYPE.DESCRIPTION
                ORDER BY date ASC, event_type
            `;

            console.log('Stock Movements Query:', query);
            return JSON.parse(runQuery(query));
        }

        function getMovementSummary() {
            const locationGroup = document.getElementById('locationGroupFilter').value;
            const productCategory = document.getElementById('productCategoryFilter').value;
            const vendorFilter = document.getElementById('vendorFilter').value;

            let lgCondition = locationGroup !== '%' ? `AND LOCGRP.id = ${locationGroup}` : '';
            let categoryCondition = productCategory !== '%' ? `AND pt.name = '${productCategory}'` : '';
            let vendorCondition = vendorFilter !== '%' ? `AND EXISTS (SELECT 1 FROM vendorparts vp WHERE vp.partid = PART.id AND vp.vendorid = ${vendorFilter} AND vp.defaultflag = 1)` : '';

            // Summarize movements by type using correct inventorylogtype IDs:
            // 10=Receive, 20=Ship, 30=Transfer, 40=Yield, 50=Consume
            // 64=Adjust Inc, 65=Adjust Dec, 67=Scrap, 68=Cycle Count
            const query = `
                SELECT
                    CASE
                        WHEN INVENTORYLOGTYPE.ID = 10 THEN 'Receiving'
                        WHEN INVENTORYLOGTYPE.ID = 20 THEN 'Shipping'
                        WHEN INVENTORYLOGTYPE.ID = 30 THEN 'Transfers'
                        WHEN INVENTORYLOGTYPE.ID IN (64, 65, 67, 68) THEN 'Adjustments'
                        WHEN INVENTORYLOGTYPE.ID IN (40, 50) THEN 'Production'
                        ELSE 'Other'
                    END as category,
                    SUM(INVENTORYLOG.CHANGEQTY) as total_qty,
                    COUNT(*) as count
                FROM INVENTORYLOG
                INNER JOIN LOCATIONGROUP LOCGRP ON INVENTORYLOG.LOCATIONGROUPID = LOCGRP.ID
                INNER JOIN INVENTORYLOGTYPE ON INVENTORYLOG.TYPEID = INVENTORYLOGTYPE.ID
                INNER JOIN PART ON INVENTORYLOG.PARTID = PART.ID
                LEFT JOIN producttree pt ON PART.treeId = pt.id
                WHERE ${getDateCondition('INVENTORYLOG.eventDate')}
                    AND PART.activeflag = 1
                    AND PART.typeid = 10
                    ${lgCondition}
                    ${categoryCondition}
                    ${vendorCondition}
                GROUP BY category
                ORDER BY count DESC
            `;

            debugLog('Movement Summary Query executing...', 'info');
            return JSON.parse(runQuery(query));
        }

        // Slow-Moving Inventory - parts with high days of supply based on sales velocity
        // Using exact working query from Sales Dashboard
        function getSlowMovingInventory() {
            try {
                const { start, end } = getDateRange();
                const daysDiff = moment(end).diff(moment(start), 'days') || 364;

                const query = `
                    SELECT
                        Product.Num AS part_num,
                        Product.Description AS part_name,
                        COALESCE(SUM(CASE WHEN PostSo.DATECREATED IS NOT NULL THEN PostSoItem.Qty ELSE 0 END), 0) AS qty_sold,
                        COALESCE(SUM(CASE WHEN PostSo.DATECREATED IS NOT NULL THEN PostSoItem.Qty ELSE 0 END), 0) / ${daysDiff} AS daily_velocity,
                        (
                            SELECT SUM(qtyOnHand)
                            FROM qtyInventoryTotals
                            WHERE partId = Product.Id
                        ) AS qty_on_hand,
                        (
                            SELECT SUM(qtyOnHand)
                            FROM qtyInventoryTotals
                            WHERE partId = Product.Id
                        ) / NULLIF(COALESCE(SUM(CASE WHEN PostSo.DATECREATED IS NOT NULL THEN PostSoItem.Qty ELSE 0 END), 0) / ${daysDiff}, 0) AS days_of_supply
                    FROM Product
                    LEFT JOIN SoItem ON SoItem.ProductId = Product.Id AND SoItem.typeId NOT IN (30, 40)
                    LEFT JOIN PostSoItem ON PostSoItem.SoItemId = SoItem.Id
                    LEFT JOIN So ON So.Id = SoItem.SoId
                    LEFT JOIN PostSo ON PostSo.SoId = So.Id AND PostSo.DATECREATED >= '${start}' AND PostSo.DATECREATED <= '${end}'
                    LEFT JOIN Customer ON Customer.Id = So.CustomerId
                    LEFT JOIN AccountGroup ON AccountGroup.Id = (
                        SELECT AccountGroupRelation.GroupId
                        FROM AccountGroupRelation
                        WHERE AccountGroupRelation.AccountId = Customer.AccountId
                        ORDER BY AccountGroupRelation.AccountId ASC
                        LIMIT 1
                    )
                    WHERE 1=1
                    GROUP BY Product.Id, Product.Num, Product.Description
                    HAVING qty_on_hand > 0 AND daily_velocity < 1
                    ORDER BY days_of_supply DESC
                    LIMIT 20
                `;

                debugLog('Slow-Moving Inventory query executing...', 'info');
                const result = JSON.parse(runQuery(query));
                debugLog(`Slow-Moving Inventory returned ${result ? result.length : 0} rows`, 'info');
                return result || [];
            } catch (error) {
                debugLog(`ERROR in getSlowMovingInventory: ${error.message}`, 'error');
                return [];
            }
        }

        // ============================================
        // Chart Rendering Functions
        // ============================================

        function renderValueOverTimeChart(data) {
            const container = document.getElementById('valueChart');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-12 text-sm">No data available</p>';
                return;
            }

            const margin = { top: 20, right: 30, bottom: 40, left: 70 };
            const width = container.offsetWidth - margin.left - margin.right;
            const height = 300 - margin.top - margin.bottom;

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            // Scales
            const x = d3.scaleTime()
                .domain(d3.extent(data, d => new Date(d.date)))
                .range([0, width]);

            const y = d3.scaleLinear()
                .domain([0, d3.max(data, d => parseFloat(d.total_value))])
                .nice()
                .range([height, 0]);

            // Grid
            svg.append('g')
                .attr('class', 'grid')
                .attr('opacity', 0.1)
                .call(d3.axisLeft(y).tickSize(-width).tickFormat(''));

            // Area
            const area = d3.area()
                .x(d => x(new Date(d.date)))
                .y0(height)
                .y1(d => y(parseFloat(d.total_value)));

            svg.append('path')
                .datum(data)
                .attr('class', 'area')
                .attr('d', area)
                .attr('fill', colorPalette[0]);

            // Line
            const line = d3.line()
                .x(d => x(new Date(d.date)))
                .y(d => y(parseFloat(d.total_value)));

            svg.append('path')
                .datum(data)
                .attr('class', 'line')
                .attr('d', line)
                .attr('stroke', colorPalette[0]);

            // Points
            svg.selectAll('.dot')
                .data(data)
                .enter()
                .append('circle')
                .attr('cx', d => x(new Date(d.date)))
                .attr('cy', d => y(parseFloat(d.total_value)))
                .attr('r', 4)
                .attr('fill', 'white')
                .attr('stroke', colorPalette[0])
                .attr('stroke-width', 2)
                .on('mouseover', function(event, d) {
                    d3.select(this).attr('r', 6);
                    tooltip.style('opacity', 1)
                        .html(`
                            <div><span class="tooltip-label">Date:</span><span class="tooltip-value">${moment(d.date).format(MOMENT_DATE_FORMAT)}</span></div>
                            <div><span class="tooltip-label">Value:</span><span class="tooltip-value">${formatCurrency(d.total_value)}</span></div>
                            <div><span class="tooltip-label">Quantity:</span><span class="tooltip-value">${formatQty(d.total_qty)}</span></div>
                            <div><span class="tooltip-label">Parts:</span><span class="tooltip-value">${d.part_count}</span></div>
                        `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    d3.select(this).attr('r', 4);
                    tooltip.style('opacity', 0);
                });

            // Axes
            svg.append('g')
                .attr('class', 'axis')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x).ticks(6).tickFormat(d3.timeFormat('%b %d')));

            svg.append('g')
                .attr('class', 'axis')
                .call(d3.axisLeft(y).ticks(5).tickFormat(d => CURRENCY_SYMBOL + d3.format('.2s')(d)));
        }

        function renderLocationChart(data) {
            const container = document.getElementById('locationChart');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-12 text-sm">No data available</p>';
                return;
            }

            // Group data by location
            const grouped = d3.group(data, d => d.location);
            const locations = Array.from(grouped.keys());

            const margin = { top: 20, right: 120, bottom: 40, left: 60 };
            const width = container.offsetWidth - margin.left - margin.right;
            const height = 300 - margin.top - margin.bottom;

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            // Scales
            const x = d3.scaleTime()
                .domain(d3.extent(data, d => new Date(d.date)))
                .range([0, width]);

            const y = d3.scaleLinear()
                .domain([0, d3.max(data, d => parseFloat(d.qty))])
                .nice()
                .range([height, 0]);

            // Grid
            svg.append('g')
                .attr('class', 'grid')
                .attr('opacity', 0.1)
                .call(d3.axisLeft(y).tickSize(-width).tickFormat(''));

            // Line generator
            const line = d3.line()
                .x(d => x(new Date(d.date)))
                .y(d => y(parseFloat(d.qty)));

            // Draw lines for each location
            locations.forEach((location, i) => {
                const locationData = grouped.get(location);
                const color = colorPalette[i % colorPalette.length];

                svg.append('path')
                    .datum(locationData)
                    .attr('class', 'line')
                    .attr('d', line)
                    .attr('stroke', color);
            });

            // Axes
            svg.append('g')
                .attr('class', 'axis')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x).ticks(6).tickFormat(d3.timeFormat('%b %d')));

            svg.append('g')
                .attr('class', 'axis')
                .call(d3.axisLeft(y).ticks(5));

            // Legend
            const legend = svg.append('g')
                .attr('transform', `translate(${width + 10}, 0)`);

            locations.forEach((location, i) => {
                const legendRow = legend.append('g')
                    .attr('transform', `translate(0, ${i * 20})`);

                legendRow.append('rect')
                    .attr('width', 16)
                    .attr('height', 3)
                    .attr('fill', colorPalette[i % colorPalette.length]);

                legendRow.append('text')
                    .attr('x', 22)
                    .attr('y', 3)
                    .attr('text-anchor', 'start')
                    .style('font-size', '11px')
                    .style('fill', '#64748b')
                    .text(location);
            });
        }

        function renderTopPartsChart(data) {
            const container = document.getElementById('topPartsChart');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-12 text-sm">No data available</p>';
                return;
            }

            const margin = { top: 20, right: 30, bottom: 60, left: 100 };
            const width = container.offsetWidth - margin.left - margin.right;
            const height = 280 - margin.top - margin.bottom;

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            // Scales
            const x = d3.scaleLinear()
                .domain([0, d3.max(data, d => parseFloat(d.total_value))])
                .nice()
                .range([0, width]);

            const y = d3.scaleBand()
                .domain(data.map(d => d.part_num))
                .range([0, height])
                .padding(0.2);

            // Bars
            svg.selectAll('.bar')
                .data(data)
                .enter()
                .append('rect')
                .attr('class', 'bar')
                .attr('x', 0)
                .attr('y', d => y(d.part_num))
                .attr('width', d => x(parseFloat(d.total_value)))
                .attr('height', y.bandwidth())
                .attr('fill', colorPalette[0])
                .attr('rx', 4)
                .on('mouseover', function(event, d) {
                    d3.select(this).attr('fill', colorPalette[1]);
                    tooltip.style('opacity', 1)
                        .html(`
                            <div><span class="tooltip-label">Part:</span><span class="tooltip-value">${d.part_num}</span></div>
                            <div><span class="tooltip-label">Description:</span><span class="tooltip-value">${d.description || ''}</span></div>
                            <div><span class="tooltip-label">Value:</span><span class="tooltip-value">${formatCurrency(d.total_value)}</span></div>
                            <div><span class="tooltip-label">On Hand:</span><span class="tooltip-value">${formatQty(d.qty_on_hand)}</span></div>
                            <div><span class="tooltip-label">Available:</span><span class="tooltip-value">${formatQty(d.qty_available)}</span></div>
                            <div><span class="tooltip-label">Committed:</span><span class="tooltip-value">${formatQty(d.qty_committed)}</span></div>
                            <div><span class="tooltip-label">On Order:</span><span class="tooltip-value">${formatQty(d.qty_on_order)}</span></div>
                        `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    d3.select(this).attr('fill', colorPalette[0]);
                    tooltip.style('opacity', 0);
                });

            // Axes
            svg.append('g')
                .attr('class', 'axis')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x).ticks(4).tickFormat(d => CURRENCY_SYMBOL + d3.format('.2s')(d)));

            svg.append('g')
                .attr('class', 'axis')
                .call(d3.axisLeft(y));
        }

        function renderStatusChart(data) {
            const container = document.getElementById('statusChart');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-12 text-sm">No data available</p>';
                return;
            }

            const width = 280;
            const height = 280;
            const radius = Math.min(width, height) / 2;

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height)
                .append('g')
                .attr('transform', `translate(${width / 2},${height / 2})`);

            const color = d3.scaleOrdinal()
                .domain(data.map(d => d.status))
                .range([colorPalette[2], colorPalette[3], colorPalette[4], colorPalette[5]]);

            const pie = d3.pie()
                .value(d => parseFloat(d.qty))
                .sort(null);

            const arc = d3.arc()
                .innerRadius(radius * 0.5)
                .outerRadius(radius * 0.8);

            const arcs = svg.selectAll('.arc')
                .data(pie(data))
                .enter()
                .append('g')
                .attr('class', 'arc');

            arcs.append('path')
                .attr('d', arc)
                .attr('fill', d => color(d.data.status))
                .attr('stroke', 'white')
                .attr('stroke-width', 2)
                .on('mouseover', function(event, d) {
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr('d', d3.arc().innerRadius(radius * 0.5).outerRadius(radius * 0.85));

                    tooltip.style('opacity', 1)
                        .html(`
                            <div><span class="tooltip-label">Status:</span><span class="tooltip-value">${d.data.status}</span></div>
                            <div><span class="tooltip-label">Quantity:</span><span class="tooltip-value">${formatQty(d.data.qty)}</span></div>
                        `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr('d', arc);
                    tooltip.style('opacity', 0);
                });

            // Legend
            const legend = svg.append('g')
                .attr('transform', `translate(${-radius * 0.4},${radius + 30})`);

            data.forEach((d, i) => {
                const legendRow = legend.append('g')
                    .attr('transform', `translate(0, ${i * 18})`);

                legendRow.append('rect')
                    .attr('width', 10)
                    .attr('height', 10)
                    .attr('fill', color(d.status));

                legendRow.append('text')
                    .attr('x', 16)
                    .attr('y', 9)
                    .attr('text-anchor', 'start')
                    .style('font-size', '10px')
                    .style('fill', '#64748b')
                    .text(d.status);
            });
        }

        function renderMovementChart(data) {
            const container = document.getElementById('movementChart');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-12 text-sm">No movement data available</p>';
                return;
            }

            const width = 280;
            const height = 280;
            const radius = Math.min(width, height) / 2;

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height)
                .append('g')
                .attr('transform', `translate(${width / 2},${height / 2})`);

            // Movement category colors
            const movementColors = {
                'Receiving': '#10b981',   // Green
                'Shipping': '#ef4444',    // Red
                'Adjustments': '#f59e0b', // Amber
                'Transfers': '#3b82f6',   // Blue
                'Production': '#8b5cf6',  // Purple
                'Other': '#94a3b8'        // Gray
            };

            const color = d3.scaleOrdinal()
                .domain(data.map(d => d.category))
                .range(data.map(d => movementColors[d.category] || '#94a3b8'));

            const pie = d3.pie()
                .value(d => Math.abs(parseFloat(d.count)))
                .sort(null);

            const arc = d3.arc()
                .innerRadius(radius * 0.5)
                .outerRadius(radius * 0.8);

            const arcs = svg.selectAll('.arc')
                .data(pie(data))
                .enter()
                .append('g')
                .attr('class', 'arc');

            arcs.append('path')
                .attr('d', arc)
                .attr('fill', d => color(d.data.category))
                .attr('stroke', 'white')
                .attr('stroke-width', 2)
                .on('mouseover', function(event, d) {
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr('d', d3.arc().innerRadius(radius * 0.5).outerRadius(radius * 0.85));

                    const qtyChange = parseFloat(d.data.total_qty || 0);
                    const qtyDisplay = qtyChange >= 0 ? `+${formatQty(qtyChange)}` : formatQty(qtyChange);

                    tooltip.style('opacity', 1)
                        .html(`
                            <div><span class="tooltip-label">Category:</span><span class="tooltip-value">${d.data.category}</span></div>
                            <div><span class="tooltip-label">Transactions:</span><span class="tooltip-value">${parseFloat(d.data.count).toLocaleString()}</span></div>
                            <div><span class="tooltip-label">Net Qty Change:</span><span class="tooltip-value" style="color: ${qtyChange >= 0 ? '#10b981' : '#ef4444'}">${qtyDisplay}</span></div>
                        `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr('d', arc);
                    tooltip.style('opacity', 0);
                });

            // Center text showing total transactions
            const totalTransactions = data.reduce((sum, d) => sum + parseInt(d.count || 0), 0);
            svg.append('text')
                .attr('text-anchor', 'middle')
                .attr('dominant-baseline', 'middle')
                .attr('class', 'text-2xl font-bold')
                .style('font-size', '24px')
                .style('font-weight', '700')
                .style('fill', '#1e293b')
                .text(totalTransactions.toLocaleString());

            svg.append('text')
                .attr('text-anchor', 'middle')
                .attr('dominant-baseline', 'middle')
                .attr('y', 20)
                .style('font-size', '11px')
                .style('fill', '#64748b')
                .text('Transactions');

            // Legend (below chart)
            const legend = d3.select(container)
                .append('div')
                .style('display', 'flex')
                .style('flex-wrap', 'wrap')
                .style('justify-content', 'center')
                .style('gap', '8px')
                .style('margin-top', '12px');

            data.forEach(d => {
                legend.append('div')
                    .style('display', 'flex')
                    .style('align-items', 'center')
                    .style('gap', '4px')
                    .style('font-size', '10px')
                    .html(`<span style="width:10px;height:10px;background:${movementColors[d.category] || '#94a3b8'};border-radius:2px;display:inline-block;"></span>${d.category}`);
            });
        }

        function renderSlowMovingChart(data) {
            const container = document.getElementById('slowMovingChart');
            container.innerHTML = '';

            if (!data || !Array.isArray(data) || data.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-400 py-8">No slow-moving inventory found</div>';
                return;
            }

            const width = container.clientWidth;
            const height = 280;
            const margin = { top: 10, right: 10, bottom: 60, left: 100 };

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            const topData = data.slice(0, 10);

            // Cap days_of_supply at a reasonable maximum for display
            const maxDays = Math.min(d3.max(topData, d => parseFloat(d.days_of_supply) || 0), 365);

            const x = d3.scaleLinear()
                .domain([0, maxDays])
                .nice()
                .range([margin.left, width - margin.right]);

            const y = d3.scaleBand()
                .domain(topData.map(d => d.part_name || d.part_num))
                .range([margin.top, height - margin.bottom])
                .padding(0.2);

            svg.selectAll('rect')
                .data(topData)
                .enter()
                .append('rect')
                .attr('x', margin.left)
                .attr('y', d => y(d.part_name || d.part_num))
                .attr('width', d => Math.max(0, x(Math.min(parseFloat(d.days_of_supply) || 0, maxDays)) - margin.left))
                .attr('height', y.bandwidth())
                .attr('fill', '#f97316')
                .style('cursor', 'pointer')
                .on('mouseover', function(event, d) {
                    d3.select(this).style('opacity', 0.7);
                    showTooltip(event, `
                        <strong>${d.part_name || d.part_num}</strong><br>
                        On Hand: ${formatQty(d.qty_on_hand)}<br>
                        Sold (period): ${formatQty(d.qty_sold)}<br>
                        Days of Supply: ${d.days_of_supply && d.days_of_supply < 99999 ? parseFloat(d.days_of_supply).toFixed(0) : '∞'}
                    `);
                })
                .on('mouseout', function() {
                    d3.select(this).style('opacity', 1);
                    hideTooltip();
                });

            svg.append('g')
                .attr('transform', `translate(0, ${height - margin.bottom})`)
                .attr('class', 'axis')
                .call(d3.axisBottom(x));

            // Add X-axis label
            svg.append('text')
                .attr('x', width / 2)
                .attr('y', height - 5)
                .attr('text-anchor', 'middle')
                .style('font-size', '12px')
                .style('fill', '#64748b')
                .text('Days of Stock');

            svg.append('g')
                .attr('transform', `translate(${margin.left}, 0)`)
                .attr('class', 'axis')
                .call(d3.axisLeft(y))
                .selectAll('text')
                .style('font-size', '9px')
                .text(d => d && d.length > 15 ? d.substring(0, 15) + '...' : d);
        }

        // Store KPI values globally for header updates
        let kpiValues = {
            totalValue: 0,
            partCount: 0,
            belowReorder: 0,
            shortParts: 0,
            shortPickValue: 0,
            cycleCountValue: 0,
            scrapValue: 0
        };

        function updateHeaderKPIs() {
            const kpiCardsContainer = document.getElementById('kpiCards');
            if (!kpiCardsContainer) return;

            kpiCardsContainer.innerHTML = `
                <div class="flex items-center gap-2 px-3 py-2 bg-emerald-50 border border-emerald-200 rounded-lg">
                    <svg class="w-4 h-4 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="text-xs font-semibold text-slate-600">Inventory Value:</span>
                    <span class="text-sm font-bold text-slate-900">${formatCurrency(kpiValues.totalValue, false)}</span>
                </div>
                <div class="flex items-center gap-2 px-3 py-2 bg-blue-50 border border-blue-200 rounded-lg">
                    <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                    </svg>
                    <span class="text-xs font-semibold text-slate-600">Parts in Stock:</span>
                    <span class="text-sm font-bold text-slate-900">${kpiValues.partCount.toLocaleString()}</span>
                </div>
                ${kpiValues.belowReorder > 0 ? `
                <div class="flex items-center gap-2 px-3 py-2 bg-orange-50 border border-orange-200 rounded-lg cursor-pointer hover:bg-orange-100" onclick="showBelowReorderModal()">
                    <svg class="w-4 h-4 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                    <span class="text-xs font-semibold text-slate-600">Low Stock:</span>
                    <span class="text-sm font-bold text-orange-600">${kpiValues.belowReorder}</span>
                </div>
                ` : ''}
            `;
        }

        function updateKPIs(data) {
            if (!data || data.length === 0) {
                debugLog('No KPI data returned', 'warning');
                kpiValues.totalValue = 0;
                kpiValues.partCount = 0;
            } else {
                const metrics = data[0];
                kpiValues.totalValue = parseFloat(metrics.total_value || 0);
                kpiValues.partCount = parseInt(metrics.part_count || 0);
                debugLog(`KPIs updated: Value=${formatCurrency(kpiValues.totalValue)}, Parts=${kpiValues.partCount}`, 'success');
            }
            updateHeaderKPIs();
        }

        function updateBelowReorderKPI(count) {
            kpiValues.belowReorder = count || 0;
            updateHeaderKPIs();
        }

        function updateUnavailableKPI(data) {
            // Unavailable is shown in Activity row, not header
            // No action needed here for header
        }

        // ============================================
        // UI Functions
        // ============================================
        function applyDateRange() {
            const rangeValue = document.getElementById('dateRangeFilter').value;
            const customContainer = document.getElementById('customDateRangeContainer');

            // Hide/show custom date picker
            if (rangeValue === 'custom') {
                customContainer.style.display = 'flex';
                return; // Don't load dashboard until custom dates are set
            } else {
                customContainer.style.display = 'none';
            }

            // Calculate date range
            let dates;
            switch(rangeValue) {
                case 'this_quarter':
                    dates = getQuarterDates(0);
                    break;
                case 'last_quarter':
                    dates = getQuarterDates(1);
                    break;
                case 'current_fy':
                    dates = getFYDates(0);
                    break;
                case 'last_fy':
                    dates = getFYDates(1);
                    break;
                case 'current_cy':
                    dates = getCalendarYearDates(0);
                    break;
                case 'last_cy':
                    dates = getCalendarYearDates(1);
                    break;
                default:
                    // Numeric days
                    currentDateRange = parseInt(rangeValue);
                    customStartDate = null;
                    customEndDate = null;
                    updateDateRangeDisplay();
                    loadDashboard();
                    return;
            }

            customStartDate = dates.start;
            customEndDate = dates.end;
            document.getElementById('customStartDate').value = dates.start;
            document.getElementById('customEndDate').value = dates.end;

            updateDateRangeDisplay();
            loadDashboard();
        }

        function setDateRange(days) {
            // Legacy function for backward compatibility
            document.getElementById('dateRangeFilter').value = days.toString();
            applyDateRange();
        }

        function updateDateRangeDisplay() {
            const displayEl = document.getElementById('dateRangeDisplay');
            if (!displayEl) return;

            const rangeValue = document.getElementById('dateRangeFilter').value;
            let displayText = '';

            // Always show the actual date range using DateFormatShort property
            if (customStartDate && customEndDate) {
                displayText = `(${moment(customStartDate).format(MOMENT_DATE_FORMAT)} - ${moment(customEndDate).format(MOMENT_DATE_FORMAT)})`;
            }

            displayEl.textContent = displayText;
        }

        function applyCustomDateRange() {
            const startInput = document.getElementById('customStartDate');
            const endInput = document.getElementById('customEndDate');

            if (startInput.value && endInput.value) {
                customStartDate = startInput.value;
                customEndDate = endInput.value;
                currentDateRange = null;

                updateDateRangeDisplay();
                loadDashboard();
            }
        }

        function clearAllFilters() {
            // Reset all filter dropdowns to default "All" values
            document.getElementById('locationGroupFilter').value = '%';
            document.getElementById('productCategoryFilter').value = '%';
            document.getElementById('vendorFilter').value = '%';
            document.getElementById('dateRangeFilter').value = 'current_fy';

            // Reset custom dates and apply FY dates
            const dates = getFYDates(0);
            customStartDate = dates.start;
            customEndDate = dates.end;
            document.getElementById('customStartDate').value = dates.start;
            document.getElementById('customEndDate').value = dates.end;

            // Hide custom date picker
            document.getElementById('customDateRangeContainer').style.display = 'none';

            // Reload dashboard with cleared filters
            updateDateRangeDisplay();
            loadDashboard();
        }

        // ============================================
        // Data Loading and Refresh
        // ============================================
        function loadDashboard() {
            const loading = document.getElementById('loadingOverlay');
            loading.style.display = 'flex';
            debugLog('Loading dashboard...', 'info');

            try {
                // Load KPIs (inventory valuation)
                const kpiData = getKPIMetrics();
                updateKPIs(kpiData);

                // Load below reorder count
                const belowReorderCount = getBelowReorderCount();
                updateBelowReorderKPI(belowReorderCount);

                // Load short parts count and value
                const shortPartsData = getShortPartsDetail();
                const shortLinesCount = shortPartsData ? shortPartsData.length : 0;
                const shortPartsCount = shortPartsData ? new Set(shortPartsData.map(r => r.part_num)).size : 0;
                const shortPicksCount = shortPartsData ? new Set(shortPartsData.map(r => r.pick_num)).size : 0;
                // Calculate at-risk value from short parts (using qty * SoItem.UnitPrice)
                const shortValue = shortPartsData ? shortPartsData.reduce((sum, r) => sum + parseFloat(r.line_value || 0), 0) : 0;
                updateShortPickTile(shortPartsCount, shortLinesCount, shortPicksCount, shortValue);

                // Load cycle count data
                const cycleCountData = getCycleCountData();
                updateCycleCountKPI(cycleCountData);

                // Load scrap data
                const scrapData = getScrapData();
                updateScrapKPI(scrapData);

                // Load fulfillment pipeline data (picked/packed SO items)
                const fulfillmentDetailData = getFulfillmentPipeline();
                const fulfillmentSummaryData = getFulfillmentPipelineSummary();
                updateFulfillmentPipeline(fulfillmentDetailData, fulfillmentSummaryData);

                // Load unavailable stock data
                const unavailableData = getUnavailableData();
                updateUnavailableKPI(unavailableData);

                // Load charts
                const valueData = getInventoryValueOverTime();
                renderValueOverTimeChart(valueData);

                const locationData = getStockByLocation();
                renderLocationChart(locationData);

                const topPartsData = getTopPartsByValue();
                renderTopPartsChart(topPartsData);

                const statusData = getAvailabilityStatus();
                renderStatusChart(statusData);

                // Load stock movement data
                const movementData = getMovementSummary();
                renderMovementChart(movementData);

                // Load slow-moving inventory data
                const slowMovingData = getSlowMovingInventory();
                renderSlowMovingChart(slowMovingData);

                debugLog('Dashboard loaded successfully', 'success');

            } catch (error) {
                debugLog('Error loading dashboard: ' + error.message, 'error');
                console.error('Error loading dashboard:', error);
                alert('Error loading dashboard data. Please check console for details.');
            } finally {
                loading.style.display = 'none';
            }
        }

        function updateCycleCountKPI(data) {
            const partsEl = document.getElementById('cycleCountParts');
            const valueEl = document.getElementById('cycleCountValue');

            if (data && data.length > 0 && data[0]) {
                const metrics = data[0];
                const partCount = parseInt(metrics.part_count || 0);
                const netValue = parseFloat(metrics.net_value_change || 0);

                if (partsEl) partsEl.textContent = partCount.toLocaleString() + ' parts';

                const valueStr = netValue >= 0 ? `+${formatCurrency(netValue)}` : formatCurrency(netValue);
                if (valueEl) valueEl.textContent = valueStr;

                // Track for stock loss total - use absolute value for losses
                kpiValues.cycleCountValue = Math.abs(netValue < 0 ? netValue : 0);
            } else {
                if (partsEl) partsEl.textContent = '0 parts';
                if (valueEl) valueEl.textContent = '$0';
                kpiValues.cycleCountValue = 0;
            }
            updateStockLossTotal();
        }

        function updateScrapKPI(data) {
            const partsEl = document.getElementById('scrapParts');
            const valueEl = document.getElementById('scrapValue');

            if (data && data.length > 0 && data[0]) {
                const metrics = data[0];
                const partCount = parseInt(metrics.part_count || 0);
                const totalValue = parseFloat(metrics.total_value_scrapped || 0);

                if (partsEl) partsEl.textContent = partCount.toLocaleString() + ' parts';
                if (valueEl) valueEl.textContent = formatCurrency(totalValue);

                kpiValues.scrapValue = totalValue;
            } else {
                if (partsEl) partsEl.textContent = '0 parts';
                if (valueEl) valueEl.textContent = '$0';
                kpiValues.scrapValue = 0;
            }
            updateStockLossTotal();
        }

        function updateStockLossTotal() {
            const totalEl = document.getElementById('stockLossTotalValue');
            const cycleVal = kpiValues.cycleCountValue || 0;
            const scrapVal = kpiValues.scrapValue || 0;
            const total = cycleVal + scrapVal;

            if (totalEl) totalEl.textContent = formatCurrency(total);
        }

        function updateShortPickTile(partsCount, linesCount, picksCount, value) {
            const partsEl = document.getElementById('shortPickPartsCount');
            const linesEl = document.getElementById('shortPickLinesCount');
            const picksEl = document.getElementById('shortPickPicksCount');
            const valueEl = document.getElementById('shortPickValue');

            kpiValues.shortParts = partsCount || 0;
            kpiValues.shortPickValue = value || 0;

            if (partsEl) partsEl.textContent = (partsCount || 0).toLocaleString();
            if (linesEl) linesEl.textContent = (linesCount || 0).toLocaleString();
            if (picksEl) picksEl.textContent = (picksCount || 0).toLocaleString();
            if (valueEl) valueEl.textContent = formatCurrency(value);

            updateHeaderKPIs();
        }

        function updateFulfillmentPipeline(detailData, summaryData) {
            const ordersCountEl = document.getElementById('fulfillmentOrdersCount');
            const itemCountEl = document.getElementById('fulfillmentItemCount');
            const totalValueEl = document.getElementById('fulfillmentTotalValue');

            // Calculate totals from detail data
            const totalItems = detailData ? detailData.length : 0;
            const totalOrders = detailData ? new Set(detailData.map(r => r.shipnum)).size : 0;
            const totalValue = detailData ? detailData.reduce((sum, item) => sum + (parseFloat(item.linevalue) || 0), 0) : 0;

            if (ordersCountEl) ordersCountEl.textContent = totalOrders.toLocaleString();
            if (itemCountEl) itemCountEl.textContent = totalItems.toLocaleString();
            if (totalValueEl) totalValueEl.textContent = formatCurrency(totalValue);

            debugLog('Fulfillment Pipeline updated: ' + totalOrders + ' orders, ' + totalItems + ' items, ' + formatCurrency(totalValue), 'success');
        }

        function exportToCSV() {
            try {
                const kpiData = getKPIMetrics();
                const topPartsData = getTopPartsByValue();

                // Build CSV header
                let csv = 'Inventory Dashboard Export - ' + moment().format('YYYY-MM-DD HH:mm:ss') + '\n\n';

                // KPI Summary
                csv += 'Key Metrics\n';
                csv += 'Metric,Value\n';
                if (kpiData && kpiData.length > 0) {
                    const metrics = kpiData[0];
                    csv += `Total Inventory Value,${formatCurrency(metrics.total_value || 0)}\n`;
                    csv += `Active Parts,${metrics.part_count || 0}\n`;
                    csv += `Total Quantity,${parseFloat(metrics.total_qty || 0).toFixed(2)}\n`;
                    csv += `Below Reorder Point,${metrics.below_reorder || 0}\n`;
                }

                csv += '\n\nTop Parts by Value\n';
                csv += 'Part Number,Description,Location Group,On Hand,Available,Committed,On Order,Total Value\n';
                topPartsData.forEach(part => {
                    csv += `"${part.part_num}","${(part.description || '').replace(/"/g, '""')}",`;
                    csv += `"${part.location_group || ''}",`;
                    csv += `${parseFloat(part.qty_on_hand || 0).toFixed(0)},`;
                    csv += `${parseFloat(part.qty_available || 0).toFixed(0)},`;
                    csv += `${parseFloat(part.qty_committed || 0).toFixed(0)},`;
                    csv += `${parseFloat(part.qty_on_order || 0).toFixed(0)},`;
                    csv += `${parseFloat(part.total_value || 0).toFixed(2)}\n`;
                });

                // Create download link
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);

                link.setAttribute('href', url);
                link.setAttribute('download', 'Inventory_Dashboard_' + moment().format('YYYY-MM-DD_HHmmss') + '.csv');
                link.style.visibility = 'hidden';

                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                console.log('CSV export completed successfully');
            } catch (error) {
                console.error('Error exporting CSV:', error);
                alert('Error exporting CSV. Please check console for details.');
            }
        }

        // ============================================
        // Event Listeners
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            // Show debug console if DEBUG_MODE is enabled
            if (DEBUG_MODE) {
                document.getElementById('debugConsoleContainer').style.display = 'block';
            }

            // Load filter options
            loadLocationGroups();
            loadProductCategories();
            loadVendors();

            // Initialize with Current Financial Year dates
            const dates = getFYDates(0);
            customStartDate = dates.start;
            customEndDate = dates.end;
            document.getElementById('customStartDate').value = dates.start;
            document.getElementById('customEndDate').value = dates.end;

            updateDateRangeDisplay();
            loadDashboard();

            // Window resize handler
            let resizeTimeout;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(loadDashboard, 250);
            });
        });
    </script>
</body>
</html>
