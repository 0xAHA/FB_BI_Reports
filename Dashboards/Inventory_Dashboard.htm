<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Dashboard - Fishbowl Advanced</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- D3.js v7 -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- Moment.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        /* Custom Brand Colors (matching Gantt v3) */
        :root {
            --color-primary: #2d9cdb;
            --color-primary-dark: #1e7bb4;
            --color-sidebar: #06162d;
            --color-sidebar-hover: #0a1f3d;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Override Tailwind indigo with custom blue */
        .bg-indigo-600 { background-color: var(--color-primary) !important; }
        .bg-indigo-50 { background-color: rgba(45, 156, 219, 0.1) !important; }
        .text-indigo-600 { color: var(--color-primary) !important; }
        .text-indigo-700 { color: var(--color-primary-dark) !important; }
        .border-indigo-200 { border-color: rgba(45, 156, 219, 0.3) !important; }
        .border-indigo-300 { border-color: rgba(45, 156, 219, 0.4) !important; }
        .hover\:text-indigo-600:hover { color: var(--color-primary) !important; }
        .hover\:bg-indigo-50:hover { background-color: rgba(45, 156, 219, 0.1) !important; }
        .hover\:bg-indigo-100:hover { background-color: rgba(45, 156, 219, 0.15) !important; }
        .focus\:ring-indigo-100:focus { --tw-ring-color: rgba(45, 156, 219, 0.2) !important; }
        .focus\:ring-indigo-500:focus { --tw-ring-color: var(--color-primary) !important; }
        .focus\:border-indigo-300:focus { border-color: rgba(45, 156, 219, 0.4) !important; }

        /* D3 Chart Styles */
        .axis line, .axis path {
            stroke: #cbd5e1;
            shape-rendering: crispEdges;
        }

        .axis text {
            fill: #64748b;
            font-size: 11px;
            font-weight: 500;
        }

        .grid line {
            stroke: #e2e8f0;
            stroke-opacity: 0.7;
            shape-rendering: crispEdges;
        }

        .line {
            fill: none;
            stroke-width: 2.5px;
        }

        .area {
            opacity: 0.3;
        }

        .tooltip {
            position: absolute;
            background: rgba(15, 23, 42, 0.95);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            max-width: 280px;
        }

        .tooltip-label {
            color: #94a3b8;
            display: inline-block;
            min-width: 90px;
            font-weight: 500;
        }

        .tooltip-value {
            color: #ffffff;
            font-weight: 600;
            margin-left: 8px;
        }

        /* Responsive chart grid - matches Pipeline KPIs layout for alignment */
        .chart-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        /* 3 columns at md breakpoint (768px) to match KPI tiles */
        @media (min-width: 768px) {
            .chart-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 1rem;
            }
        }

        .legend-item {
            display: inline-flex;
            align-items: center;
            margin-right: 14px;
            cursor: pointer;
            padding: 3px 6px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .legend-item:hover {
            background-color: #f1f5f9;
        }

        .legend-color {
            width: 18px;
            height: 3px;
            border-radius: 2px;
            margin-right: 6px;
        }

        /* Loading spinner */
        .spinner {
            border: 3px solid #f1f5f9;
            border-top: 3px solid var(--color-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Drilldown table styles */
        .drilldown-table-wrapper {
            overflow: auto;
            max-height: calc(90vh - 180px);
        }

        .drilldown-table {
            width: 100%;
            table-layout: auto;
            border-collapse: collapse;
        }

        .drilldown-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .drilldown-table thead th {
            background-color: #f1f5f9;
            box-shadow: inset 0 -1px 0 #e2e8f0;
        }

        .drilldown-table th.sortable {
            cursor: pointer;
            user-select: none;
        }

        .drilldown-table th.sortable:hover {
            background-color: #e2e8f0;
        }

        .drilldown-table th .sort-icon {
            display: inline-block;
            margin-left: 4px;
            opacity: 0.3;
        }

        .drilldown-table th.sort-asc .sort-icon,
        .drilldown-table th.sort-desc .sort-icon {
            opacity: 1;
        }

        .drilldown-table th.sort-desc .sort-icon {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="bg-slate-50">
    <div class="flex flex-col h-screen">
        <!-- Header (matching Gantt v3) -->
        <header class="h-20 bg-white border-b border-slate-200 px-8 flex items-center justify-between flex-shrink-0 z-20 shadow-sm">
            <div class="flex items-center gap-6">
                <div>
                    <h1 class="text-xl font-bold text-slate-900">
                        Inventory Dashboard
                        <span id="dateRangeDisplay" class="text-sm font-normal text-slate-500 ml-2"></span>
                    </h1>
                    <p class="text-xs text-slate-500 mt-0.5">Real-time inventory analytics</p>
                </div>

                <!-- KPI Summary in Header -->
                <div id="kpiCards" class="hidden lg:flex items-center gap-3">
                    <!-- Will be populated dynamically -->
                </div>
            </div>

            <div class="flex items-center gap-3">
                <!-- Refresh Button -->
                <button onclick="loadDashboard()" class="p-2.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-xl transition-all" title="Refresh Data">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                </button>
            </div>
        </header>

        <!-- Content Area -->
        <div class="flex-1 overflow-y-auto custom-scrollbar p-4 lg:p-8">
            <!-- Filters Section -->
            <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-4 mb-4">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-base font-bold text-slate-800 flex items-center gap-2">
                        <svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                        </svg>
                        <span>Filters</span>
                        <button onclick="clearAllFilters()" class="ml-2 px-2 py-1 text-xs text-slate-500 hover:text-red-600 hover:bg-red-50 rounded transition-colors flex items-center gap-1" title="Clear All Filters">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            Clear
                        </button>
                    </h3>

                    <div class="flex items-center gap-2 flex-wrap">
                        <!-- Date Range Dropdown -->
                        <div class="flex items-center gap-1 bg-slate-50 px-2 py-1.5 rounded-lg border border-slate-200">
                            <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            <select id="dateRangeFilter" onchange="applyDateRange()" class="px-2 py-0.5 text-xs border-0 bg-transparent focus:ring-0 focus:outline-none text-slate-700 font-semibold" style="width: 180px;">
                                <option value="today">Today</option>
                                <option value="this_week">This Week</option>
                                <option value="this_month">This Month</option>
                                <option value="last_month">Last Month</option>
                                <option value="30">Last 30 Days</option>
                                <option value="60">Last 60 Days</option>
                                <option value="90" selected>Last 90 Days</option>
                                <option value="180">Last 6 Months</option>
                                <option value="365">Last Year</option>
                                <option value="this_quarter">This Quarter</option>
                                <option value="last_quarter">Last Quarter</option>
                                <option value="current_fy" class="fy-option">Current Financial Year</option>
                                <option value="last_fy" class="fy-option">Last Financial Year</option>
                                <option value="current_cy">Current Calendar Year</option>
                                <option value="last_cy">Last Calendar Year</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>

                        <!-- Custom Date Range Picker -->
                        <div id="customDateRangeContainer" class="flex items-center gap-1 bg-slate-50 px-2 py-1.5 rounded-lg border border-slate-200" style="display: none;">
                            <input type="date" id="customStartDate" class="px-2 py-0.5 text-xs border-0 bg-transparent focus:ring-0 focus:outline-none text-slate-700" style="width: 110px;" onchange="applyCustomDateRange()" title="Start Date">
                            <span class="text-slate-400 text-xs">to</span>
                            <input type="date" id="customEndDate" class="px-2 py-0.5 text-xs border-0 bg-transparent focus:ring-0 focus:outline-none text-slate-700" style="width: 110px;" onchange="applyCustomDateRange()" title="End Date">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <!-- Location Group -->
                    <div>
                        <label class="block text-[11px] font-semibold text-slate-600 mb-1.5">Location Group</label>
                        <select id="locationGroupFilter" onchange="loadDashboard()" class="w-full px-2.5 py-1.5 bg-slate-50 border border-slate-300 rounded-lg text-sm font-medium focus:bg-white focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300 transition-all outline-none text-slate-600">
                            <option value="%">All Locations</option>
                        </select>
                    </div>

                    <!-- Hidden product category filter (removed from UI but kept for code compatibility) -->
                    <input type="hidden" id="productCategoryFilter" value="%">

                    <!-- Vendor -->
                    <div>
                        <label class="block text-[11px] font-semibold text-slate-600 mb-1.5">Vendor</label>
                        <select id="vendorFilter" onchange="loadDashboard()" class="w-full px-2.5 py-1.5 bg-slate-50 border border-slate-300 rounded-lg text-sm font-medium focus:bg-white focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300 transition-all outline-none text-slate-600">
                            <option value="%">All Vendors</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Pipeline KPIs Row - 3 equal tiles -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <!-- Stock Loss (Cycle Count + Scrapped) -->
                <div class="bg-white rounded-xl shadow-md border border-slate-300 p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <div class="p-2 bg-amber-100 rounded-lg">
                                <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                            </div>
                            <h4 class="text-sm font-bold text-slate-800">Stock Loss</h4>
                        </div>
                        <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-center" style="height: 120px; align-content: center;">
                        <div class="cursor-pointer hover:bg-blue-50 rounded-lg p-2 transition-colors" onclick="showCycleCountModal()">
                            <div id="cycleCountValue" class="text-lg xl:text-2xl font-bold text-blue-600">$0</div>
                            <div id="cycleCountParts" class="text-xs text-slate-500">0 parts</div>
                            <div class="text-xs text-slate-400 mt-1">Cycle Count</div>
                        </div>
                        <div class="cursor-pointer hover:bg-red-50 rounded-lg p-2 transition-colors" onclick="showScrapModal()">
                            <div id="scrapValue" class="text-lg xl:text-2xl font-bold text-red-600">$0</div>
                            <div id="scrapParts" class="text-xs text-slate-500">0 parts</div>
                            <div class="text-xs text-slate-400 mt-1">Scrapped</div>
                        </div>
                    </div>
                    <div class="bg-amber-50 rounded-lg p-3 text-center mt-2">
                        <div class="text-xs text-slate-500">Total Loss Value</div>
                        <div id="stockLossTotalValue" class="text-lg font-bold text-amber-600">$0</div>
                    </div>
                </div>

                <!-- Short Pick Items -->
                <div class="bg-white rounded-xl shadow-md border border-slate-300 p-4 cursor-pointer hover:border-red-300 transition-colors" onclick="showShortPartsModal()">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <div class="p-2 bg-red-100 rounded-lg">
                                <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                            </div>
                            <h4 class="text-sm font-bold text-slate-800">Short Pick Items</h4>
                        </div>
                        <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </div>
                    <div class="grid grid-cols-3 gap-2 text-center" style="height: 120px; align-content: center;">
                        <div>
                            <div id="shortPickPartsCount" class="text-lg xl:text-2xl font-bold text-red-600">0</div>
                            <div class="text-xs text-slate-500">Parts</div>
                        </div>
                        <div>
                            <div id="shortPickLinesCount" class="text-lg xl:text-2xl font-bold text-red-600">0</div>
                            <div class="text-xs text-slate-500">Line Items</div>
                        </div>
                        <div>
                            <div id="shortPickPicksCount" class="text-lg xl:text-2xl font-bold text-red-600">0</div>
                            <div class="text-xs text-slate-500">Picks</div>
                        </div>
                    </div>
                    <div class="bg-red-50 rounded-lg p-3 text-center mt-2">
                        <div class="text-xs text-slate-500">At-Risk Order Value</div>
                        <div id="shortPickValue" class="text-lg font-bold text-red-600">$0</div>
                    </div>
                </div>

                <!-- Picked - Awaiting Pack/Ship -->
                <div class="bg-white rounded-xl shadow-md border border-slate-300 p-4 cursor-pointer hover:border-cyan-300 transition-colors" onclick="showFulfillmentPipelineModal()">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <div class="p-2 bg-cyan-100 rounded-lg">
                                <svg class="w-5 h-5 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path>
                                </svg>
                            </div>
                            <h4 class="text-sm font-bold text-slate-800">Picked - Awaiting Ship</h4>
                        </div>
                        <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-center" style="height: 120px; align-content: center;">
                        <div>
                            <div id="fulfillmentOrdersCount" class="text-lg xl:text-2xl font-bold text-cyan-600">0</div>
                            <div class="text-xs text-slate-500">Orders</div>
                        </div>
                        <div>
                            <div id="fulfillmentItemCount" class="text-lg xl:text-2xl font-bold text-cyan-600">0</div>
                            <div class="text-xs text-slate-500">Line Items</div>
                        </div>
                    </div>
                    <div class="bg-cyan-50 rounded-lg p-3 text-center mt-2">
                        <div class="text-xs text-slate-500">Ready to Ship Value</div>
                        <div id="fulfillmentTotalValue" class="text-lg font-bold text-cyan-600">$0</div>
                    </div>
                </div>
            </div>

            <!-- Chart Tiles -->
            <div class="chart-grid">
                <!-- Stock Value by Location Group -->
                <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        Stock Value by Location Group
                    </h3>
                    <div id="locationChart" style="height: 300px; overflow-y: auto;"></div>
                </div>

                <!-- Stock Value by ABC Code -->
                <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        Stock Value by ABC Code
                    </h3>
                    <div id="statusChart" style="height: 300px;"></div>
                </div>

                <!-- Stock Value Flow -->
                <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                        </svg>
                        Stock Value Flow
                    </h3>
                    <div id="movementChart" style="height: 300px;"></div>
                </div>

                <!-- Top Parts by Value -->
                <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        Top Parts by Value
                    </h3>
                    <div id="topPartsChart" style="height: 300px;"></div>
                </div>

                <!-- Slow-Moving Inventory -->
                <div class="bg-white rounded-2xl shadow-md border border-slate-300 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                        </svg>
                        Slow-Moving Inventory
                    </h3>
                    <div id="slowMovingChart" style="height: 300px;"></div>
                </div>
            </div>

            <!-- Loading Overlay -->
            <div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 9999; align-items: center; justify-content: center;">
                <div style="background: white; padding: 2rem; border-radius: 1rem; text-align: center;">
                    <div class="spinner mx-auto mb-4"></div>
                    <p class="text-slate-700 font-medium">Loading dashboard data...</p>
                </div>
            </div>

            <!-- Debug Console (hidden by default, shown if BI_SHOW_DEBUG=true) -->
            <div id="debugConsoleContainer" class="mt-6" style="display: none;">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <button onclick="toggleDebugConsole()" class="w-full px-6 py-3 flex items-center justify-between hover:bg-slate-50 transition-colors">
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                            </svg>
                            <span class="text-sm font-semibold text-slate-700">Debug Console</span>
                            <span class="text-xs text-slate-400 font-normal">Auto-scrolls to latest entry</span>
                        </div>
                        <svg id="debugChevron" class="w-5 h-5 text-slate-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>

                    <div id="debugContent" class="hidden border-t border-slate-200">
                        <div class="bg-slate-900 px-4 py-2 flex items-center justify-between">
                            <span class="text-xs text-slate-400 font-mono">Drill-down & Application Diagnostics</span>
                            <button onclick="clearDebugLog()" class="text-xs text-slate-400 hover:text-white transition-colors">
                                Clear
                            </button>
                        </div>
                        <div id="debugLog" class="bg-slate-950 text-slate-200 p-4 font-mono text-xs max-h-96 overflow-y-auto" style="scrollbar-width: thin;">
                            <div class="text-slate-500 italic">Waiting for application to initialize...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tooltip -->
    <div id="tooltip" class="tooltip"></div>

    <!-- Drill-down Modal -->
    <div id="drilldownModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center" onclick="closeDrilldown(event)">
        <div class="bg-white rounded-2xl shadow-2xl w-11/12 max-w-6xl max-h-[90vh] flex flex-col" onclick="event.stopPropagation()">
            <!-- Modal Header -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-slate-200">
                <div>
                    <h2 id="drilldownTitle" class="text-xl font-bold text-slate-800"></h2>
                    <div id="drilldownSubtitle" class="text-sm text-slate-500 mt-1"></div>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="exportDrilldownData()" class="px-3 py-2 text-sm font-semibold text-slate-600 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-all flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Export CSV
                    </button>
                    <button onclick="closeDrilldown()" class="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Modal Content -->
            <div id="drilldownContent" class="flex-1 overflow-hidden px-6 pb-6 pt-0">
                <!-- Content will be populated dynamically -->
            </div>

            <!-- Modal Footer with Summary -->
            <div id="drilldownFooter" class="px-6 py-3 border-t border-slate-200 bg-slate-50 text-sm text-slate-600">
                <!-- Summary will be populated dynamically -->
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // Global Variables
        // ============================================
        let currentDateRange = 90;
        let customStartDate = null;
        let customEndDate = null;
        const tooltip = d3.select('#tooltip');

        // Drilldown sorting state
        let currentDrilldownSort = { column: null, direction: 'asc' };
        let currentDrilldownRenderFn = null;

        // Financial Year start month (1-12, default 1 = January/Calendar Year)
        // Configure via Fishbowl property: BI_FY_START_MONTH
        // Common values: 1=Calendar Year, 4=UK/Japan/India, 7=Australia/NZ, 10=US Federal
        const FY_START_MONTH = parseInt(getProperty('BI_FY_START_MONTH', '1')) || 1;

        // Debug mode from Fishbowl system property (default to false)
        const BI_SHOW_DEBUG_PROP = typeof getProperty === 'function' ? getProperty('BI_SHOW_DEBUG', 'false') : 'false';
        const DEBUG_MODE = BI_SHOW_DEBUG_PROP === 'true' || BI_SHOW_DEBUG_PROP === true;

        // Date format from Fishbowl system property (default to US format)
        const FB_DATE_FORMAT = typeof getProperty === 'function' ? getProperty('DateFormatShort', 'MM/dd/yyyy') : 'MM/dd/yyyy';
        // Convert Java SimpleDateFormat to moment.js format (dd -> DD, yyyy -> YYYY)
        const MOMENT_DATE_FORMAT = FB_DATE_FORMAT
            .replace(/yyyy/g, 'YYYY')
            .replace(/yy/g, 'YY')
            .replace(/dd/g, 'DD');

        // Price formatting from Fishbowl system property
        const PRICE_FORMAT = getProperty('REPORT_DECIMAL_PRICE', '$ #,##0.00');

        // Currency code to symbol mapping (ISO 4217 codes)
        const CURRENCY_SYMBOLS = {
            'AUD': '$',      // Australian Dollar
            'USD': '$',      // US Dollar
            'NZD': '$',      // New Zealand Dollar
            'CAD': '$',      // Canadian Dollar
            'SGD': '$',      // Singapore Dollar
            'HKD': '$',      // Hong Kong Dollar
            'EUR': '€',      // Euro
            'GBP': '£',      // British Pound
            'JPY': '¥',      // Japanese Yen
            'CNY': '¥',      // Chinese Yuan
            'CHF': 'CHF',    // Swiss Franc
            'SEK': 'kr',     // Swedish Krona
            'NOK': 'kr',     // Norwegian Krone
            'DKK': 'kr',     // Danish Krone
            'INR': '₹',      // Indian Rupee
            'ZAR': 'R',      // South African Rand
            'BRL': 'R$',     // Brazilian Real
            'MXN': '$',      // Mexican Peso
            'KRW': '₩',      // South Korean Won
            'THB': '฿',      // Thai Baht
            'MYR': 'RM',     // Malaysian Ringgit
            'PHP': '₱',      // Philippine Peso
            'IDR': 'Rp',     // Indonesian Rupiah
            'AED': 'د.إ',    // UAE Dirham
            'SAR': '﷼',      // Saudi Riyal
            'RUB': '₽',      // Russian Ruble
            'PLN': 'zł',     // Polish Zloty
            'TRY': '₺',      // Turkish Lira
            'ILS': '₪',      // Israeli Shekel
            'CZK': 'Kč',     // Czech Koruna
            'HUF': 'Ft',     // Hungarian Forint
            'TWD': 'NT$',    // Taiwan Dollar
            'VND': '₫',      // Vietnamese Dong
        };

        // Get home currency symbol from database
        function getHomeCurrencySymbol() {
            try {
                const query = `SELECT code FROM currency WHERE homeCurrency = 1 LIMIT 1`;
                const result = runQuery(query);
                if (result) {
                    const parsed = JSON.parse(result);
                    if (parsed && parsed.length > 0 && parsed[0].code) {
                        const code = parsed[0].code.toUpperCase();
                        const symbol = CURRENCY_SYMBOLS[code] || code;
                        console.log(`Home currency: ${code} → Symbol: ${symbol}`);
                        return symbol;
                    }
                }
            } catch (e) {
                console.error(`getHomeCurrencySymbol error: ${e.message}`);
            }
            // Fallback to parsing from REPORT_DECIMAL_PRICE
            return PRICE_FORMAT.match(/^[^#0,.\s]+/) ? PRICE_FORMAT.match(/^[^#0,.\s]+/)[0].trim() : '$';
        }

        // Parse decimal places from price format
        const DECIMAL_PLACES = (PRICE_FORMAT.match(/\.([0#]+)$/) || ['', '00'])[1].length;

        // Get the currency symbol (from DB or fallback)
        const CURRENCY_SYMBOL = getHomeCurrencySymbol();

        // Currency formatting function
        function formatCurrencyValue(value, showDecimals = true) {
            const num = parseFloat(value || 0);
            const isNegative = num < 0;
            const absValue = Math.abs(num);
            const decimals = showDecimals ? DECIMAL_PLACES : 0;
            const formatted = absValue.toLocaleString('en-US', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            });
            return isNegative ? `-${CURRENCY_SYMBOL}${formatted}` : `${CURRENCY_SYMBOL}${formatted}`;
        }

        // Format quantity to 2 decimal places
        function formatQty(value) {
            const num = parseFloat(value || 0);
            return num.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // Drilldown table sorting
        function sortDrilldownData(data, column, direction, type = 'string') {
            return [...data].sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];

                if (type === 'number') {
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                } else if (type === 'date') {
                    aVal = new Date(aVal || 0).getTime();
                    bVal = new Date(bVal || 0).getTime();
                } else {
                    aVal = (aVal || '').toString().toLowerCase();
                    bVal = (bVal || '').toString().toLowerCase();
                }

                if (aVal < bVal) return direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return direction === 'asc' ? 1 : -1;
                return 0;
            });
        }

        function handleColumnSort(column, type, renderFn) {
            if (currentDrilldownSort.column === column) {
                currentDrilldownSort.direction = currentDrilldownSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentDrilldownSort.column = column;
                currentDrilldownSort.direction = 'asc';
            }
            currentDrilldownRenderFn = renderFn;
            renderFn();
        }

        function getSortIcon() {
            return '<span class="sort-icon">▲</span>';
        }

        function getSortClass(column) {
            if (currentDrilldownSort.column !== column) return 'sortable';
            return `sortable sort-${currentDrilldownSort.direction}`;
        }

        // Escape SQL strings for safe use in queries
        function escapeSQL(str) {
            if (str === null || str === undefined) return str;
            return str.toString().replace(/'/g, "''");
        }

        // Module opener functions for drilldown links
        function openPick(pickNumber) {
            openModule("Picking", pickNumber);
        }

        function openSalesOrder(orderNumber) {
            openModule("Sales Order", orderNumber);
        }

        function openPurchaseOrder(orderNumber) {
            openModule("Purchase Order", orderNumber);
        }

        function openWorkOrder(orderNumber) {
            openModule("Work Order", orderNumber);
        }

        function openTransferOrder(orderNumber) {
            openModule("Transfer Order", orderNumber);
        }

        // Color palette (matching Gantt v3 theme)
        const colorPalette = [
            '#2d9cdb', '#3b82f6', '#10b981', '#f59e0b', '#ef4444',
            '#8b5cf6', '#ec4899', '#14b8a6', '#f97316', '#06b6d4'
        ];

        // ============================================
        // Date Range Helper Functions
        // ============================================
        function getQuarterDates(offset = 0) {
            const now = moment();
            const currentQuarterStart = moment(now).startOf('quarter');
            const targetQuarterStart = moment(currentQuarterStart).subtract(offset, 'quarters');

            const startDate = targetQuarterStart.startOf('quarter');
            const endDate = moment(startDate).endOf('quarter');

            return {
                start: startDate.format('YYYY-MM-DD'),
                end: endDate.format('YYYY-MM-DD')
            };
        }

        function getFYDates(offset = 0) {
            const now = moment();
            const currentMonth = now.month() + 1;
            const currentYear = now.year();

            const fyStartMonth = Math.max(1, Math.min(12, FY_START_MONTH));

            let fyStartYear = currentMonth >= fyStartMonth ? currentYear : currentYear - 1;
            fyStartYear -= offset;

            let fyEndMonth, fyEndYear;
            if (fyStartMonth === 1) {
                fyEndMonth = 12;
                fyEndYear = fyStartYear;
            } else {
                fyEndMonth = fyStartMonth - 1;
                fyEndYear = fyStartYear + 1;
            }

            const endDate = moment([fyEndYear, fyEndMonth - 1, 1]).endOf('month');

            return {
                start: `${fyStartYear}-${String(fyStartMonth).padStart(2, '0')}-01`,
                end: endDate.format('YYYY-MM-DD')
            };
        }

        function getCalendarYearDates(offset = 0) {
            const year = moment().year() - offset;
            return {
                start: `${year}-01-01`,
                end: `${year}-12-31`
            };
        }

        function getDateCondition(dateColumn = 'il.dateCreated') {
            if (customStartDate && customEndDate) {
                return `${dateColumn} >= '${customStartDate}' AND ${dateColumn} <= '${customEndDate}'`;
            } else {
                const days = currentDateRange || 90;
                return `${dateColumn} >= DATE_SUB(NOW(), INTERVAL ${days} DAY)`;
            }
        }

        function getDateRange() {
            // Return current date range for queries that need start/end dates
            if (customStartDate && customEndDate) {
                return {
                    start: customStartDate,
                    end: customEndDate
                };
            }
            // Default to last 365 days if no custom range set
            const end = moment().format('YYYY-MM-DD');
            const start = moment().subtract(365, 'days').format('YYYY-MM-DD');
            return { start, end };
        }

        // ============================================
        // Debug Functions
        // ============================================
        function debugLog(message, type = 'info') {
            // Only log if DEBUG_MODE is enabled
            if (!DEBUG_MODE) return;

            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('debugLog');

            // Clear initial message
            if (logDiv.querySelector('.italic')) {
                logDiv.innerHTML = '';
            }

            const colors = {
                'info': 'text-blue-400',
                'success': 'text-green-400',
                'warning': 'text-yellow-400',
                'error': 'text-red-400',
                'click': 'text-purple-400'
            };

            const entry = document.createElement('div');
            entry.className = 'py-0.5';
            entry.innerHTML = `<span class="text-slate-500">[${timestamp}]</span> <span class="${colors[type] || colors.info}">${message}</span>`;

            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function showTooltip(event, html) {
            tooltip.style('opacity', 1)
                .html(html)
                .style('left', (event.pageX + 10) + 'px')
                .style('top', (event.pageY - 10) + 'px');
        }

        function hideTooltip() {
            tooltip.style('opacity', 0);
        }

        function toggleDebugConsole() {
            const content = document.getElementById('debugContent');
            const chevron = document.getElementById('debugChevron');

            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                chevron.style.transform = 'rotate(180deg)';
            } else {
                content.classList.add('hidden');
                chevron.style.transform = 'rotate(0deg)';
            }
        }

        function clearDebugLog() {
            const logDiv = document.getElementById('debugLog');
            logDiv.innerHTML = '<div class="text-slate-500 italic">Log cleared</div>';
        }

        // ============================================
        // Modal Functions
        // ============================================
        let currentDrilldownData = [];
        let currentDrilldownTitle = '';

        function showDrilldown(title, subtitle, content, footerText) {
            document.getElementById('drilldownTitle').textContent = title;
            document.getElementById('drilldownSubtitle').textContent = subtitle || '';
            document.getElementById('drilldownContent').innerHTML = content;
            document.getElementById('drilldownFooter').innerHTML = footerText || '';
            document.getElementById('drilldownModal').classList.remove('hidden');
            document.getElementById('drilldownModal').classList.add('flex');
            currentDrilldownTitle = title;
            debugLog(`Opened drilldown: ${title}`, 'click');
        }

        function closeDrilldown(event) {
            if (!event || event.target === document.getElementById('drilldownModal')) {
                document.getElementById('drilldownModal').classList.add('hidden');
                document.getElementById('drilldownModal').classList.remove('flex');
            }
        }

        function exportDrilldownData() {
            if (currentDrilldownData.length === 0) {
                alert('No data to export');
                return;
            }

            const headers = Object.keys(currentDrilldownData[0]);
            let csv = headers.join(',') + '\n';

            currentDrilldownData.forEach(row => {
                csv += headers.map(h => {
                    const val = row[h] || '';
                    return typeof val === 'string' && (val.includes(',') || val.includes('"'))
                        ? `"${val.replace(/"/g, '""')}"`
                        : val;
                }).join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.setAttribute('href', URL.createObjectURL(blob));
            link.setAttribute('download', `${currentDrilldownTitle.replace(/\s+/g, '_')}_${moment().format('YYYY-MM-DD_HHmmss')}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            debugLog(`Exported ${currentDrilldownData.length} rows to CSV`, 'success');
        }

        // ============================================
        // Fishbowl SQL Queries
        // ============================================

        function getStockByLocationGroup() {
            const locationGroup = document.getElementById('locationGroupFilter').value;
            const productCategory = document.getElementById('productCategoryFilter').value;
            const vendorFilter = document.getElementById('vendorFilter').value;

            let lgCondition = locationGroup !== '%' ? `AND lg.id = ${locationGroup}` : '';
            let vendorCondition = vendorFilter !== '%' ? `AND EXISTS (SELECT 1 FROM vendorparts vp WHERE vp.partid = p.id AND vp.vendorid = ${vendorFilter} AND vp.defaultflag = 1)` : '';

            // Get current inventory value by location group using avgCost
            const query = `
                SELECT
                    lg.id as location_group_id,
                    lg.name as location_group_name,
                    COUNT(DISTINCT p.id) as part_count,
                    SUM(COALESCE(inv.qty, 0)) as total_qty,
                    SUM(COALESCE(inv.qty, 0) * COALESCE(pc.avgCost, 0)) as total_value
                FROM locationgroup lg
                LEFT JOIN (
                    SELECT
                        l.locationgroupid,
                        tag.partid,
                        SUM(tag.qty) as qty
                    FROM tag
                    JOIN location l ON tag.locationid = l.id
                    WHERE tag.qty > 0
                    GROUP BY l.locationgroupid, tag.partid
                ) inv ON inv.locationgroupid = lg.id
                LEFT JOIN part p ON inv.partid = p.id AND p.activeflag = 1 AND p.typeid = 10
                LEFT JOIN partcost pc ON p.id = pc.partid
                WHERE 1=1
                    ${lgCondition}
                    ${vendorCondition}
                GROUP BY lg.id, lg.name
                HAVING total_qty > 0 OR total_value > 0
                ORDER BY total_value DESC
            `;

            console.log('Stock by Location Group Query:', query);
            debugLog('Stock by Location Group Query: ' + query.replace(/\s+/g, ' ').trim(), 'info');
            return JSON.parse(runQuery(query));
        }

        function getStockByLocationGroupDetail(locationGroupId) {
            const vendorFilter = document.getElementById('vendorFilter').value;

            let vendorCondition = vendorFilter !== '%' ? `AND EXISTS (SELECT 1 FROM vendorparts vp WHERE vp.partid = p.id AND vp.vendorid = ${vendorFilter} AND vp.defaultflag = 1)` : '';

            // Get parts and their values for a specific location group
            const query = `
                SELECT
                    p.num as part_num,
                    p.description,
                    SUM(tag.qty) as qty_on_hand,
                    COALESCE(pc.avgCost, 0) as avg_cost,
                    SUM(tag.qty) * COALESCE(pc.avgCost, 0) as total_value
                FROM tag
                JOIN location l ON tag.locationid = l.id
                JOIN part p ON tag.partid = p.id
                LEFT JOIN partcost pc ON p.id = pc.partid
                WHERE l.locationgroupid = ${locationGroupId}
                    AND tag.qty > 0
                    AND p.activeflag = 1
                    AND p.typeid = 10
                    ${vendorCondition}
                GROUP BY p.id, p.num, p.description, pc.avgCost
                ORDER BY total_value DESC
            `;

            console.log('Stock by Location Group Detail Query:', query);
            debugLog('Stock by Location Group Detail Query: ' + query.replace(/\s+/g, ' ').trim(), 'info');
            return JSON.parse(runQuery(query));
        }

        function getTopPartsByValue() {
            const locationGroup = document.getElementById('locationGroupFilter').value;
            const vendorFilter = document.getElementById('vendorFilter').value;

            let lgCondition = locationGroup !== '%' ? `AND lg.id = ${locationGroup}` : '';
            let vendorCondition = vendorFilter !== '%' ? `AND EXISTS (SELECT 1 FROM vendorparts vp WHERE vp.partid = p.id AND vp.vendorid = ${vendorFilter} AND vp.defaultflag = 1)` : '';

            // Query actual inventory from tag table, using partcost.avgCost for valuation
            const query = `
                SELECT
                    p.num AS part_num,
                    p.description,
                    lg.name AS location_group,
                    SUM(tag.qty) AS qty_on_hand,
                    COALESCE(pc.avgCost, 0) AS avg_cost,
                    SUM(tag.qty) * COALESCE(pc.avgCost, 0) AS total_value
                FROM tag
                JOIN location l ON tag.locationid = l.id
                JOIN locationgroup lg ON l.locationgroupid = lg.id
                JOIN part p ON tag.partid = p.id
                LEFT JOIN partcost pc ON p.id = pc.partid
                WHERE tag.qty > 0
                    AND p.activeflag = 1
                    AND p.typeid = 10
                    AND lg.activeflag = 1
                    ${lgCondition}
                    ${vendorCondition}
                GROUP BY p.id, p.num, p.description, lg.name, pc.avgCost
                ORDER BY total_value DESC
                LIMIT 10
            `;

            console.log('Top Parts Query:', query);
            debugLog('Top Parts Query: ' + query.replace(/\\s+/g, ' ').trim(), 'info');
            return JSON.parse(runQuery(query));
        }

        function getInventoryAvailability() {
            const locationGroup = document.getElementById('locationGroupFilter').value;
            const productCategory = document.getElementById('productCategoryFilter').value;
            const vendorFilter = document.getElementById('vendorFilter').value;

            let lgCondition = locationGroup !== '%' ? `AND locationgroup.id = ${locationGroup}` : '';
            let categoryCondition = productCategory !== '%' ? `AND pt.name = '${productCategory}'` : '';
            let vendorCondition = vendorFilter !== '%' ? `AND EXISTS (SELECT 1 FROM vendorparts vp WHERE vp.partid = part.id AND vp.vendorid = ${vendorFilter} AND vp.defaultflag = 1)` : '';

            // Full inventory availability query from Fishbowl report
            const query = `
                SELECT
                    part.num AS part_num,
                    part.description,
                    uom.code AS uom,
                    part.id AS part_id,
                    locationgroup.name AS location_group,
                    COALESCE(qtyonhand.qty, 0) AS qty_on_hand,
                    COALESCE(qtynotavailable.qty, 0) AS qty_unavailable,
                    COALESCE(qtydropship.qty, 0) AS qty_dropship,
                    COALESCE(qtycommitted.qty, 0) AS qty_committed,
                    COALESCE(qtyallocated.qty, 0) AS qty_allocated,
                    COALESCE(qtyonorder.qty, 0) AS qty_on_order,
                    (COALESCE(qtyonhand.qty, 0) - COALESCE(qtynotavailable.qty, 0) - COALESCE(qtycommitted.qty, 0) - COALESCE(qtyallocated.qty, 0)) AS qty_available
                FROM part
                LEFT JOIN locationgroup ON locationgroup.activeflag = 1
                LEFT JOIN uom ON part.uomid = uom.id
                LEFT JOIN producttree pt ON part.treeId = pt.id
                LEFT JOIN qtyonorder ON qtyonorder.partid = part.id AND qtyonorder.locationgroupid = locationgroup.id
                LEFT JOIN qtyallocated ON qtyallocated.partid = part.id AND qtyallocated.locationgroupid = locationgroup.id
                LEFT JOIN qtycommitted ON qtycommitted.partid = part.id AND qtycommitted.locationgroupid = locationgroup.id
                LEFT JOIN qtynotavailable ON qtynotavailable.partid = part.id AND qtynotavailable.locationgroupid = locationgroup.id
                LEFT JOIN qtydropship ON qtydropship.partid = part.id AND qtydropship.locationgroupid = locationgroup.id
                LEFT JOIN qtyonhand ON qtyonhand.partid = part.id AND qtyonhand.locationgroupid = locationgroup.id
                WHERE part.id != 0
                    AND part.typeid = 10
                    AND part.activeflag = 1
                    ${lgCondition}
                    ${categoryCondition}
                    ${vendorCondition}
                HAVING (qty_on_hand + qty_unavailable + qty_dropship + qty_committed + qty_allocated + qty_on_order) > 0
                ORDER BY locationgroup.id, part.num
            `;

            console.log('Inventory Availability Query:', query);
            return JSON.parse(runQuery(query));
        }

        function getAvailabilityStatus() {
            const locationGroup = document.getElementById('locationGroupFilter').value;
            const productCategory = document.getElementById('productCategoryFilter').value;
            const vendorFilter = document.getElementById('vendorFilter').value;

            let lgCondition = locationGroup !== '%' ? `AND lg.id = ${locationGroup}` : '';
            let vendorCondition = vendorFilter !== '%' ? `AND EXISTS (SELECT 1 FROM vendorparts vp WHERE vp.partid = p.id AND vp.vendorid = ${vendorFilter} AND vp.defaultflag = 1)` : '';

            // Stock value by ABC code (Pareto classification)
            const query = `
                SELECT
                    CASE
                        WHEN COALESCE(p.abcCode, '') = 'A' THEN 'A - High Value'
                        WHEN COALESCE(p.abcCode, '') = 'B' THEN 'B - Medium Value'
                        WHEN COALESCE(p.abcCode, '') = 'C' THEN 'C - Low Value'
                        WHEN COALESCE(p.abcCode, '') = 'N' THEN 'N - New/Unclassified'
                        ELSE 'Unassigned'
                    END as status,
                    COALESCE(p.abcCode, 'U') as abc_code,
                    COUNT(DISTINCT p.id) as part_count,
                    SUM(COALESCE(qoh.qty, 0)) as qty,
                    SUM(COALESCE(qoh.qty, 0) * COALESCE(pc.avgCost, 0)) as total_value
                FROM part p
                LEFT JOIN qtyonhand qoh ON p.id = qoh.partid
                LEFT JOIN locationgroup lg ON qoh.locationgroupid = lg.id
                LEFT JOIN partcost pc ON p.id = pc.partid
                WHERE p.activeflag = 1
                    AND p.typeid = 10
                    ${lgCondition}
                    ${vendorCondition}
                GROUP BY COALESCE(p.abcCode, 'U')
                HAVING SUM(COALESCE(qoh.qty, 0)) > 0
                ORDER BY
                    CASE COALESCE(p.abcCode, '')
                        WHEN 'A' THEN 1
                        WHEN 'B' THEN 2
                        WHEN 'C' THEN 3
                        WHEN 'N' THEN 4
                        ELSE 5
                    END
            `;

            debugLog('ABC Status Query: ' + query, 'info');
            return JSON.parse(runQuery(query));
        }

        function getKPIMetrics() {
            const locationGroup = document.getElementById('locationGroupFilter').value;
            let locationCondition = locationGroup !== '%' ? `AND qoh.locationgroupid = ${locationGroup}` : '';

            let query = `
                SELECT
                    SUM(qoh.qty * COALESCE(pc.avgCost, 0)) as total_value,
                    COUNT(DISTINCT part.id) as part_count,
                    SUM(qoh.qty) as total_qty
                FROM part
                INNER JOIN qtyonhand qoh ON part.id = qoh.partid
                LEFT JOIN partcost pc ON part.id = pc.partid
                WHERE part.activeflag = 1
                    AND qoh.qty > 0
                    ${locationCondition}
            `;

            debugLog('KPI Query: ' + query.replace(/\s+/g, ' ').trim(), 'info');
            try {
                const rawResult = runQuery(query);
                debugLog('KPI Query raw result: ' + rawResult, 'info');
                if (!rawResult || rawResult === 'null' || rawResult === '') {
                    debugLog('KPI Query returned empty/null result', 'warning');
                    return [];
                }
                const result = JSON.parse(rawResult);
                debugLog('KPI Query parsed: ' + JSON.stringify(result), 'info');
                return result;
            } catch (e) {
                debugLog('Error getting KPI metrics: ' + e.message, 'error');
                console.error('KPI Query error:', e);
                console.log('Query was:', query);
                return [];
            }
        }

        function getBelowReorderCount() {
            const locationGroup = document.getElementById('locationGroupFilter').value;
            const productCategory = document.getElementById('productCategoryFilter').value;
            const vendorFilter = document.getElementById('vendorFilter').value;

            let lgCondition = locationGroup !== '%' ? `AND lg.id = ${locationGroup}` : '';
            let categoryCondition = productCategory !== '%' ? `AND pt.name = '${productCategory}'` : '';
            let vendorCondition = vendorFilter !== '%' ? `AND EXISTS (SELECT 1 FROM vendorparts vp WHERE vp.partid = p.id AND vp.vendorid = ${vendorFilter} AND vp.defaultflag = 1)` : '';

            // Count parts below reorder point
            const query = `
                SELECT COUNT(DISTINCT p.id) as below_reorder
                FROM part p
                INNER JOIN partreorder pr ON p.id = pr.partid
                INNER JOIN locationgroup lg ON pr.locationgroupid = lg.id
                LEFT JOIN qtyonhand qoh ON p.id = qoh.partid AND qoh.locationgroupid = lg.id
                LEFT JOIN producttree pt ON p.treeId = pt.id
                WHERE p.activeflag = 1
                    AND p.typeid = 10
                    AND pr.reorderpoint IS NOT NULL
                    AND pr.reorderpoint > 0
                    AND COALESCE(qoh.qty, 0) < pr.reorderpoint
                    ${lgCondition}
                    ${categoryCondition}
                    ${vendorCondition}
            `;

            debugLog('Below Reorder Query executing...', 'info');
            try {
                const result = JSON.parse(runQuery(query));
                return result && result.length > 0 ? parseInt(result[0].below_reorder || 0) : 0;
            } catch (e) {
                debugLog('Error getting below reorder count: ' + e.message, 'error');
                return 0;
            }
        }

        function loadLocationGroups() {
            const query = `SELECT id, name FROM locationgroup WHERE activeflag = 1 ORDER BY name`;
            const locations = JSON.parse(runQuery(query));

            const selector = document.getElementById('locationGroupFilter');
            selector.innerHTML = '<option value="%">All Locations</option>';

            locations.forEach(lg => {
                selector.innerHTML += `<option value="${lg.id}">${lg.name}</option>`;
            });
        }

        function loadProductCategories() {
            const query = `SELECT DISTINCT name FROM producttree WHERE activeflag = 1 AND name IS NOT NULL AND name != '' ORDER BY name`;
            try {
                const categories = JSON.parse(runQuery(query));
                const selector = document.getElementById('productCategoryFilter');
                selector.innerHTML = '<option value="%">All Categories</option>';

                categories.forEach(cat => {
                    if (cat.name) {
                        selector.innerHTML += `<option value="${cat.name}">${cat.name}</option>`;
                    }
                });
            } catch (e) {
                console.error('Error loading product categories:', e);
            }
        }

        function loadVendors() {
            const query = `
                SELECT DISTINCT v.id, v.name
                FROM vendor v
                INNER JOIN vendorparts vp ON v.id = vp.vendorid AND vp.defaultflag = 1
                WHERE v.activeflag = 1
                ORDER BY v.name
            `;
            try {
                const vendors = JSON.parse(runQuery(query));
                const selector = document.getElementById('vendorFilter');
                selector.innerHTML = '<option value="%">All Vendors</option>';

                vendors.forEach(vendor => {
                    if (vendor.name) {
                        selector.innerHTML += `<option value="${vendor.id}">${vendor.name}</option>`;
                    }
                });
            } catch (e) {
                console.error('Error loading vendors:', e);
            }
        }

        function getShortParts() {
            const locationGroup = document.getElementById('locationGroupFilter').value;
            let lgCondition = locationGroup !== '%' ? `AND Pick.LocationGroupId = ${locationGroup}` : '';

            // Count distinct parts in picking that are short (insufficient qty to fulfill pick)
            const query = `
                SELECT COUNT(DISTINCT pi.partId) as short_count
                FROM PickItem pi
                INNER JOIN Pick ON pi.PickId = Pick.Id
                WHERE Pick.StatusId < 40
                    AND pi.StatusId < 40
                    ${lgCondition}
                    AND (
                        pi.StatusId IN (5, 6)
                        OR (
                            pi.StatusId IN (10, 11, 20)
                            AND (
                                COALESCE((SELECT qty FROM qtyonhand WHERE partId = pi.PartId AND locationGroupId = Pick.LocationGroupId), 0)
                                - COALESCE((SELECT qty FROM qtycommitted WHERE partId = pi.PartId AND locationGroupId = Pick.LocationGroupId), 0)
                                - COALESCE((SELECT qty FROM qtynotavailabletopick WHERE partId = pi.PartId AND locationGroupId = Pick.LocationGroupId), 0)
                            ) < pi.Qty
                        )
                    )
            `;

            debugLog('Short Parts Query: ' + query.substring(0, 100) + '...', 'info');
            try {
                const result = JSON.parse(runQuery(query));
                return result && result.length > 0 ? parseInt(result[0].short_count || 0) : 0;
            } catch (e) {
                debugLog('Error getting short parts: ' + e.message, 'error');
                return 0;
            }
        }

        function getShortPartsDetail() {
            const locationGroup = document.getElementById('locationGroupFilter').value;
            let lgCondition = locationGroup !== '%' ? `AND Pick.LocationGroupId = ${locationGroup}` : '';

            // Get detailed short parts info with pick numbers and availability
            const query = `
                SELECT
                    Pick.dateScheduled AS date_scheduled,
                    p.num AS part_num,
                    p.description,
                    Pick.num AS pick_num,
                    pi.Qty AS qty_needed,
                    (
                        COALESCE((SELECT qty FROM qtyonhand WHERE partId = p.id AND locationGroupId = Pick.LocationGroupId), 0)
                        - COALESCE((SELECT qty FROM qtycommitted WHERE partId = p.id AND locationGroupId = Pick.LocationGroupId), 0)
                        - COALESCE((SELECT qty FROM qtynotavailabletopick WHERE partId = p.id AND locationGroupId = Pick.LocationGroupId), 0)
                    ) AS qty_available,
                    COALESCE(
                        (SELECT So.Num FROM SoItem si JOIN So ON si.SoId = So.Id WHERE si.Id = pi.SoItemId),
                        (SELECT Po.Num FROM PoItem JOIN Po ON PoItem.PoId = Po.Id WHERE PoItem.Id = pi.PoItemId),
                        (SELECT Wo.Num FROM WoItem JOIN Wo ON WoItem.WoId = Wo.Id WHERE WoItem.Id = pi.WoItemId),
                        'N/A'
                    ) AS order_num,
                    pi.OrderTypeId AS order_type_id,
                    COALESCE(SoItem.UnitPrice, 0) AS unit_price,
                    (pi.Qty * COALESCE(SoItem.UnitPrice, 0)) AS line_value
                FROM PickItem pi
                INNER JOIN Pick ON pi.PickId = Pick.Id
                INNER JOIN part p ON pi.PartId = p.id
                LEFT JOIN SoItem ON SoItem.Id = pi.SoItemId
                WHERE Pick.StatusId < 40
                    AND pi.StatusId < 40
                    ${lgCondition}
                    AND (
                        pi.StatusId IN (5, 6)
                        OR (
                            pi.StatusId IN (10, 11, 20)
                            AND (
                                COALESCE((SELECT qty FROM qtyonhand WHERE partId = pi.PartId AND locationGroupId = Pick.LocationGroupId), 0)
                                - COALESCE((SELECT qty FROM qtycommitted WHERE partId = pi.PartId AND locationGroupId = Pick.LocationGroupId), 0)
                                - COALESCE((SELECT qty FROM qtynotavailabletopick WHERE partId = pi.PartId AND locationGroupId = Pick.LocationGroupId), 0)
                            ) < pi.Qty
                        )
                    )
                ORDER BY p.num, Pick.num
            `;

            debugLog('Short Parts Detail Query executing...', 'info');
            console.log('Short Parts Detail Query:', query);
            try {
                const rawResult = runQuery(query);
                debugLog('Short Parts Detail raw result: ' + (rawResult ? rawResult.substring(0, 200) : 'null'), 'info');
                const result = JSON.parse(rawResult);
                debugLog('Short Parts Detail returned ' + (result ? result.length : 0) + ' rows', 'info');
                return result;
            } catch (e) {
                debugLog('Error getting short parts detail: ' + e.message, 'error');
                console.error('Short Parts Detail error:', e);
                return [];
            }
        }

        function getCycleCountData() {
            const locationGroup = document.getElementById('locationGroupFilter').value;
            const vendorFilter = document.getElementById('vendorFilter').value;
            let lgCondition = locationGroup !== '%' ? `AND INVENTORYLOG.LOCATIONGROUPID = ${locationGroup}` : '';
            let vendorCondition = vendorFilter !== '%' ? `AND EXISTS (SELECT 1 FROM vendorparts vp WHERE vp.partid = PART.id AND vp.vendorid = ${vendorFilter} AND vp.defaultflag = 1)` : '';

            // Cycle count adjustments using POST table for historical cost
            // POST.TYPEID = 50 for inventory adjustments, REFITEMID = 3 for Cycle Count
            // Exclude zero-quantity adjustments (inventory count with no change)
            const query = `
                SELECT
                    COUNT(DISTINCT PART.id) AS part_count,
                    SUM(ABS(COALESCE(POST.QUANTITY, 0))) AS total_qty_adjusted,
                    SUM(COALESCE(POST.AMOUNT, 0)) AS net_value_change
                FROM POST
                INNER JOIN PART ON POST.REFID = PART.ID
                LEFT JOIN INVENTORYLOG ON INVENTORYLOG.RECORDID = POST.ID AND INVENTORYLOG.TABLEID = -1407594912
                WHERE POST.TYPEID = 50
                    AND POST.REFITEMID = 3
                    AND COALESCE(POST.QUANTITY, 0) != 0
                    AND ${getDateCondition('POST.DATECREATED')}
                    AND PART.activeflag = 1
                    AND PART.typeid = 10
                    ${lgCondition}
                    ${vendorCondition}
            `;

            debugLog('Cycle Count Query: ' + query.replace(/\\s+/g, ' ').trim(), 'info');
            try {
                return JSON.parse(runQuery(query));
            } catch (e) {
                debugLog('Error getting cycle count data: ' + e.message, 'error');
                return [];
            }
        }

        function getCycleCountDetail() {
            const locationGroup = document.getElementById('locationGroupFilter').value;
            const vendorFilter = document.getElementById('vendorFilter').value;
            let lgCondition = locationGroup !== '%' ? `AND INVENTORYLOG.LOCATIONGROUPID = ${locationGroup}` : '';
            let vendorCondition = vendorFilter !== '%' ? `AND EXISTS (SELECT 1 FROM vendorparts vp WHERE vp.partid = PART.id AND vp.vendorid = ${vendorFilter} AND vp.defaultflag = 1)` : '';

            // Cycle count detail using POST table for historical cost - individual adjustments (not grouped)
            // Exclude zero-quantity adjustments (inventory count with no change)
            const query = `
                SELECT
                    PART.num AS part_num,
                    PART.description,
                    COALESCE(POST.QUANTITY, 0) AS qty_adjusted,
                    COALESCE(POST.AMOUNT, 0) AS value_adjusted,
                    POST.DATECREATED AS date_adjusted,
                    COALESCE(LOCGRP.name, 'Unknown') AS location_group,
                    COALESCE(INVENTORYLOG.info, '') AS notes
                FROM POST
                INNER JOIN PART ON POST.REFID = PART.ID
                LEFT JOIN INVENTORYLOG ON INVENTORYLOG.RECORDID = POST.ID AND INVENTORYLOG.TABLEID = -1407594912
                LEFT JOIN LOCATIONGROUP LOCGRP ON INVENTORYLOG.LOCATIONGROUPID = LOCGRP.ID
                WHERE POST.TYPEID = 50
                    AND POST.REFITEMID = 3
                    AND COALESCE(POST.QUANTITY, 0) != 0
                    AND ${getDateCondition('POST.DATECREATED')}
                    AND PART.activeflag = 1
                    AND PART.typeid = 10
                    ${lgCondition}
                    ${vendorCondition}
                ORDER BY POST.DATECREATED DESC
            `;

            debugLog('Cycle Count Detail Query: ' + query.replace(/\\s+/g, ' ').trim(), 'info');
            try {
                return JSON.parse(runQuery(query));
            } catch (e) {
                debugLog('Error getting cycle count detail: ' + e.message, 'error');
                return [];
            }
        }

        function getScrapData() {
            const locationGroup = document.getElementById('locationGroupFilter').value;
            const vendorFilter = document.getElementById('vendorFilter').value;
            let lgCondition = locationGroup !== '%' ? `AND INVENTORYLOG.LOCATIONGROUPID = ${locationGroup}` : '';
            let vendorCondition = vendorFilter !== '%' ? `AND EXISTS (SELECT 1 FROM vendorparts vp WHERE vp.partid = PART.id AND vp.vendorid = ${vendorFilter} AND vp.defaultflag = 1)` : '';

            // Scrap using POST table for historical cost
            // POST.TYPEID = 50 for inventory adjustments, REFITEMID = 2 for Scrap
            const query = `
                SELECT
                    COUNT(DISTINCT PART.id) AS part_count,
                    SUM(ABS(COALESCE(POST.AMOUNT, 0))) AS total_value_scrapped,
                    SUM(ABS(COALESCE(POST.QUANTITY, 0))) AS total_qty_scrapped
                FROM POST
                INNER JOIN PART ON POST.REFID = PART.ID
                LEFT JOIN INVENTORYLOG ON INVENTORYLOG.RECORDID = POST.ID AND INVENTORYLOG.TABLEID = -1407594912
                WHERE POST.TYPEID = 50
                    AND POST.REFITEMID = 2
                    AND ${getDateCondition('POST.DATECREATED')}
                    AND PART.activeflag = 1
                    AND PART.typeid = 10
                    ${lgCondition}
                    ${vendorCondition}
            `;

            debugLog('Scrap Query: ' + query.replace(/\\s+/g, ' ').trim(), 'info');
            try {
                return JSON.parse(runQuery(query));
            } catch (e) {
                debugLog('Error getting scrap data: ' + e.message, 'error');
                return [];
            }
        }

        function getScrapDetail() {
            const locationGroup = document.getElementById('locationGroupFilter').value;
            const vendorFilter = document.getElementById('vendorFilter').value;
            let lgCondition = locationGroup !== '%' ? `AND INVENTORYLOG.LOCATIONGROUPID = ${locationGroup}` : '';
            let vendorCondition = vendorFilter !== '%' ? `AND EXISTS (SELECT 1 FROM vendorparts vp WHERE vp.partid = PART.id AND vp.vendorid = ${vendorFilter} AND vp.defaultflag = 1)` : '';

            // Scrap detail using POST table for historical cost - individual scrap entries (not grouped)
            const query = `
                SELECT
                    PART.num AS part_num,
                    PART.description,
                    ABS(COALESCE(POST.QUANTITY, 0)) AS qty_scrapped,
                    ABS(COALESCE(POST.AMOUNT, 0)) AS value_scrapped,
                    POST.DATECREATED AS date_scrapped,
                    COALESCE(LOCGRP.name, 'Unknown') AS location_group,
                    COALESCE(INVENTORYLOG.info, '') AS notes
                FROM POST
                INNER JOIN PART ON POST.REFID = PART.ID
                LEFT JOIN INVENTORYLOG ON INVENTORYLOG.RECORDID = POST.ID AND INVENTORYLOG.TABLEID = -1407594912
                LEFT JOIN LOCATIONGROUP LOCGRP ON INVENTORYLOG.LOCATIONGROUPID = LOCGRP.ID
                WHERE POST.TYPEID = 50
                    AND POST.REFITEMID = 2
                    AND ${getDateCondition('POST.DATECREATED')}
                    AND PART.activeflag = 1
                    AND PART.typeid = 10
                    ${lgCondition}
                    ${vendorCondition}
                ORDER BY POST.DATECREATED DESC
            `;

            debugLog('Scrap Detail Query: ' + query.replace(/\\s+/g, ' ').trim(), 'info');
            try {
                return JSON.parse(runQuery(query));
            } catch (e) {
                debugLog('Error getting scrap detail: ' + e.message, 'error');
                return [];
            }
        }

        // Fulfillment Pipeline - SO items picked but awaiting pack/ship
        // Uses Ship.StatusId: 10 = Entered (not packed), 20 = Packed (awaiting ship)
        // OrderTypeId 20 = Sales Orders only
        function getFulfillmentPipeline() {
            try {
                const query = `
                    SELECT
                        Ship.Id AS shipId,
                        Ship.Num AS shipNum,
                        Ship.StatusId AS statusId,
                        ShipStatus.Name AS statusName,
                        So.Num AS soNum,
                        So.Id AS soId,
                        Customer.Name AS customerName,
                        So.DateFirstShip AS dateScheduled,
                        ShipItem.QtyShipped AS qty,
                        SoItem.UnitPrice AS unitPrice,
                        (ShipItem.QtyShipped * SoItem.UnitPrice) AS lineValue,
                        Product.Num AS productNum,
                        Product.Description AS productDesc,
                        Part.Num AS partNum
                    FROM Ship
                    INNER JOIN ShipItem ON ShipItem.ShipId = Ship.Id
                    INNER JOIN SoItem ON SoItem.Id = ShipItem.SoItemId
                    INNER JOIN So ON So.Id = SoItem.SoId
                    INNER JOIN Product ON Product.Id = SoItem.ProductId
                    INNER JOIN Part ON Part.Id = Product.PartId
                    LEFT JOIN Customer ON Customer.Id = So.CustomerId
                    LEFT JOIN ShipStatus ON ShipStatus.Id = Ship.StatusId
                    WHERE Ship.OrderTypeId = 20
                    AND Ship.StatusId IN (10, 20)
                    ORDER BY So.DateFirstShip ASC, So.Num, Ship.Num
                `;
                debugLog('Fulfillment Pipeline query: ' + query.replace(/\\s+/g, ' ').trim(), 'info');
                const result = JSON.parse(runQuery(query));
                debugLog('Fulfillment Pipeline returned ' + (result ? result.length : 0) + ' rows', 'info');
                return result || [];
            } catch (error) {
                debugLog('ERROR in getFulfillmentPipeline: ' + error.message, 'error');
                return [];
            }
        }

        // Fulfillment Pipeline Summary (aggregated counts and values by status)
        function getFulfillmentPipelineSummary() {
            try {
                const query = `
                    SELECT
                        Ship.StatusId AS statusId,
                        ShipStatus.Name AS statusName,
                        COUNT(DISTINCT Ship.Id) AS shipCount,
                        COUNT(ShipItem.Id) AS itemCount,
                        SUM(ShipItem.QtyShipped * SoItem.UnitPrice) AS totalValue
                    FROM Ship
                    INNER JOIN ShipItem ON ShipItem.ShipId = Ship.Id
                    INNER JOIN SoItem ON SoItem.Id = ShipItem.SoItemId
                    LEFT JOIN ShipStatus ON ShipStatus.Id = Ship.StatusId
                    WHERE Ship.OrderTypeId = 20
                    AND Ship.StatusId IN (10, 20)
                    GROUP BY Ship.StatusId, ShipStatus.Name
                    ORDER BY Ship.StatusId
                `;
                debugLog('Fulfillment Pipeline Summary query: ' + query.replace(/\\s+/g, ' ').trim(), 'info');
                const result = JSON.parse(runQuery(query));
                debugLog('Fulfillment Pipeline Summary returned ' + (result ? result.length : 0) + ' rows', 'info');
                return result || [];
            } catch (error) {
                debugLog('ERROR in getFulfillmentPipelineSummary: ' + error.message, 'error');
                return [];
            }
        }

        function getUnavailableData() {
            const locationGroup = document.getElementById('locationGroupFilter').value;
            const productCategory = document.getElementById('productCategoryFilter').value;
            const vendorFilter = document.getElementById('vendorFilter').value;

            let lgCondition = locationGroup !== '%' ? `AND qna.locationgroupid = ${locationGroup}` : '';
            let categoryCondition = productCategory !== '%' ? `AND pt.name = '${productCategory}'` : '';
            let vendorCondition = vendorFilter !== '%' ? `AND EXISTS (SELECT 1 FROM vendorparts vp WHERE vp.partid = p.id AND vp.vendorid = ${vendorFilter} AND vp.defaultflag = 1)` : '';

            const query = `
                SELECT
                    SUM(qna.qty * COALESCE(pc.avgCost, 0)) AS total_value,
                    COUNT(DISTINCT qna.partid) AS part_count,
                    SUM(qna.qty) AS total_qty
                FROM qtynotavailable qna
                INNER JOIN part p ON qna.partid = p.id
                LEFT JOIN partcost pc ON p.id = pc.partid
                LEFT JOIN producttree pt ON p.treeId = pt.id
                WHERE p.activeflag = 1
                    AND p.typeid = 10
                    ${lgCondition}
                    ${categoryCondition}
                    ${vendorCondition}
            `;

            debugLog('Unavailable Stock Query executing...', 'info');
            try {
                return JSON.parse(runQuery(query));
            } catch (e) {
                debugLog('Error getting unavailable data: ' + e.message, 'error');
                return [];
            }
        }

        function getUnavailableDetail() {
            const locationGroup = document.getElementById('locationGroupFilter').value;
            const productCategory = document.getElementById('productCategoryFilter').value;
            const vendorFilter = document.getElementById('vendorFilter').value;

            let lgCondition = locationGroup !== '%' ? `AND qna.locationgroupid = ${locationGroup}` : '';
            let categoryCondition = productCategory !== '%' ? `AND pt.name = '${productCategory}'` : '';
            let vendorCondition = vendorFilter !== '%' ? `AND EXISTS (SELECT 1 FROM vendorparts vp WHERE vp.partid = p.id AND vp.vendorid = ${vendorFilter} AND vp.defaultflag = 1)` : '';

            const query = `
                SELECT
                    p.num AS part_num,
                    p.description,
                    lg.name AS location_group,
                    qna.qty AS qty_unavailable,
                    qna.qty * COALESCE(pc.avgCost, 0) AS value_unavailable,
                    COALESCE(pc.avgCost, 0) AS avg_cost
                FROM qtynotavailable qna
                INNER JOIN part p ON qna.partid = p.id
                INNER JOIN locationgroup lg ON qna.locationgroupid = lg.id
                LEFT JOIN partcost pc ON p.id = pc.partid
                LEFT JOIN producttree pt ON p.treeId = pt.id
                WHERE p.activeflag = 1
                    AND p.typeid = 10
                    AND qna.qty > 0
                    ${lgCondition}
                    ${categoryCondition}
                    ${vendorCondition}
                ORDER BY value_unavailable DESC
            `;

            debugLog('Unavailable Detail Query executing...', 'info');
            try {
                return JSON.parse(runQuery(query));
            } catch (e) {
                debugLog('Error getting unavailable detail: ' + e.message, 'error');
                return [];
            }
        }

        function getBelowReorderDetail() {
            const locationGroup = document.getElementById('locationGroupFilter').value;
            const productCategory = document.getElementById('productCategoryFilter').value;
            const vendorFilter = document.getElementById('vendorFilter').value;

            let lgCondition = locationGroup !== '%' ? `AND lg.id = ${locationGroup}` : '';
            let categoryCondition = productCategory !== '%' ? `AND pt.name = '${productCategory}'` : '';
            let vendorCondition = vendorFilter !== '%' ? `AND EXISTS (SELECT 1 FROM vendorparts vp WHERE vp.partid = p.id AND vp.vendorid = ${vendorFilter} AND vp.defaultflag = 1)` : '';

            const query = `
                SELECT
                    p.num AS part_num,
                    p.description,
                    lg.name AS location_group,
                    COALESCE(qoh.qty, 0) AS qty_on_hand,
                    pr.reorderpoint AS reorder_point,
                    (pr.reorderpoint - COALESCE(qoh.qty, 0)) AS qty_short,
                    COALESCE(pc.avgCost, 0) AS avg_cost
                FROM part p
                INNER JOIN partreorder pr ON p.id = pr.partid
                INNER JOIN locationgroup lg ON pr.locationgroupid = lg.id
                LEFT JOIN qtyonhand qoh ON p.id = qoh.partid AND qoh.locationgroupid = lg.id
                LEFT JOIN partcost pc ON p.id = pc.partid
                LEFT JOIN producttree pt ON p.treeId = pt.id
                WHERE p.activeflag = 1
                    AND p.typeid = 10
                    AND pr.reorderpoint IS NOT NULL
                    AND pr.reorderpoint > 0
                    AND COALESCE(qoh.qty, 0) < pr.reorderpoint
                    ${lgCondition}
                    ${categoryCondition}
                    ${vendorCondition}
                ORDER BY qty_short DESC
            `;

            debugLog('Below Reorder Detail Query executing...', 'info');
            try {
                return JSON.parse(runQuery(query));
            } catch (e) {
                debugLog('Error getting below reorder detail: ' + e.message, 'error');
                return [];
            }
        }

        // ============================================
        // Modal Show Functions
        // ============================================
        function showShortPartsModal() {
            try {
                debugLog('Loading short parts details...', 'click');
                const data = getShortPartsDetail();
                currentDrilldownData = data;
                currentDrilldownSort = { column: null, direction: 'asc' };

                if (!data || data.length === 0) {
                    showDrilldown('Short Parts in Picking', 'Parts with insufficient stock', '<p class="text-center text-slate-500 py-8">No short parts found</p>', '');
                    return;
                }

                // Helper to get order type prefix and opener function
                const getOrderInfo = (typeId) => {
                    if (typeId === 10) return { prefix: 'PO-', opener: 'openPurchaseOrder' };
                    if (typeId === 20) return { prefix: 'SO-', opener: 'openSalesOrder' };
                    if (typeId === 30) return { prefix: 'WO-', opener: 'openWorkOrder' };
                    if (typeId === 40) return { prefix: 'TO-', opener: 'openTransferOrder' };
                    return { prefix: '', opener: null };
                };

                function renderTable() {
                    let sortedData = data;
                    if (currentDrilldownSort.column) {
                        const colTypes = { date_scheduled: 'date', part_num: 'string', description: 'string', pick_num: 'string', order_num: 'string', qty_needed: 'number', qty_available: 'number', qty_short: 'number' };
                        sortedData = sortDrilldownData(data, currentDrilldownSort.column, currentDrilldownSort.direction, colTypes[currentDrilldownSort.column] || 'string');
                    }

                    const uniqueParts = new Set(data.map(r => r.part_num)).size;
                    const uniquePicks = new Set(data.map(r => r.pick_num)).size;

                    let tableHtml = `
                        <div class="drilldown-table-wrapper">
                            <table class="drilldown-table text-sm w-full" style="table-layout: auto;">
                                <thead>
                                    <tr>
                                        <th class="${getSortClass('date_scheduled')} px-3 py-3 text-left font-semibold text-slate-700 whitespace-nowrap" onclick="handleColumnSort('date_scheduled', 'date', renderShortPartsTable)">Scheduled${getSortIcon()}</th>
                                        <th class="${getSortClass('part_num')} px-3 py-3 text-left font-semibold text-slate-700 whitespace-nowrap" onclick="handleColumnSort('part_num', 'string', renderShortPartsTable)">Part Number${getSortIcon()}</th>
                                        <th class="${getSortClass('description')} px-3 py-3 text-left font-semibold text-slate-700" onclick="handleColumnSort('description', 'string', renderShortPartsTable)">Description${getSortIcon()}</th>
                                        <th class="${getSortClass('pick_num')} px-3 py-3 text-left font-semibold text-slate-700 whitespace-nowrap" onclick="handleColumnSort('pick_num', 'string', renderShortPartsTable)">Pick #${getSortIcon()}</th>
                                        <th class="${getSortClass('order_num')} px-3 py-3 text-left font-semibold text-slate-700 whitespace-nowrap" onclick="handleColumnSort('order_num', 'string', renderShortPartsTable)">Order #${getSortIcon()}</th>
                                        <th class="${getSortClass('qty_needed')} px-3 py-3 text-right font-semibold text-slate-700 whitespace-nowrap" onclick="handleColumnSort('qty_needed', 'number', renderShortPartsTable)">Needed${getSortIcon()}</th>
                                        <th class="${getSortClass('qty_available')} px-3 py-3 text-right font-semibold text-slate-700 whitespace-nowrap" onclick="handleColumnSort('qty_available', 'number', renderShortPartsTable)">Available${getSortIcon()}</th>
                                        <th class="${getSortClass('qty_short')} px-3 py-3 text-right font-semibold text-slate-700 whitespace-nowrap" onclick="handleColumnSort('qty_short', 'number', renderShortPartsTable)">Short${getSortIcon()}</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-200">
                    `;

                    sortedData.forEach(row => {
                        const qtyNeeded = parseFloat(row.qty_needed || 0);
                        const qtyAvailable = parseFloat(row.qty_available || 0);
                        const qtyShort = Math.max(0, qtyNeeded - Math.max(0, qtyAvailable));
                        row.qty_short = qtyShort; // Add for sorting
                        const orderInfo = getOrderInfo(row.order_type_id);
                        const orderNum = row.order_num || '';
                        const orderDisplay = orderInfo.prefix + orderNum;
                        const scheduledDate = row.date_scheduled ? moment(row.date_scheduled).format(MOMENT_DATE_FORMAT) : '-';

                        const pickLink = row.pick_num
                            ? `<a href="#" class="text-blue-600 hover:text-blue-800 hover:underline" onclick="event.stopPropagation(); openPick('${escapeSQL(row.pick_num)}'); return false;">${row.pick_num}</a>`
                            : '';

                        let orderLink = orderDisplay;
                        if (orderNum && orderNum !== 'N/A' && orderInfo.opener) {
                            orderLink = `<a href="#" class="text-blue-600 hover:text-blue-800 hover:underline" onclick="event.stopPropagation(); ${orderInfo.opener}('${escapeSQL(orderNum)}'); return false;">${orderDisplay}</a>`;
                        }

                        tableHtml += `
                            <tr class="hover:bg-slate-50">
                                <td class="px-3 py-3 text-slate-500 whitespace-nowrap">${scheduledDate}</td>
                                <td class="px-3 py-3 font-mono text-sm whitespace-nowrap">${row.part_num || ''}</td>
                                <td class="px-3 py-3">${row.description || ''}</td>
                                <td class="px-3 py-3 font-mono text-sm whitespace-nowrap">${pickLink}</td>
                                <td class="px-3 py-3 font-mono text-sm whitespace-nowrap">${orderLink}</td>
                                <td class="px-3 py-3 text-right whitespace-nowrap">${formatQty(qtyNeeded)}</td>
                                <td class="px-3 py-3 text-right whitespace-nowrap ${qtyAvailable < 0 ? 'text-red-600' : ''}">${formatQty(qtyAvailable)}</td>
                                <td class="px-3 py-3 text-right text-red-600 font-medium whitespace-nowrap">${formatQty(qtyShort)}</td>
                            </tr>
                        `;
                    });

                    tableHtml += '</tbody></table></div>';

                    const footer = `
                        <div class="flex justify-between items-center">
                            <span><strong>${uniqueParts}</strong> unique parts short</span>
                            <span><strong>${uniquePicks}</strong> picks affected</span>
                            <span><strong>${data.length}</strong> line items</span>
                        </div>
                    `;

                    document.getElementById('drilldownContent').innerHTML = tableHtml;
                    document.getElementById('drilldownFooter').innerHTML = footer;
                }

                window.renderShortPartsTable = renderTable;
                renderTable();
                document.getElementById('drilldownTitle').textContent = 'Short Parts in Picking';
                document.getElementById('drilldownSubtitle').textContent = 'Parts with insufficient stock to complete picks';
                document.getElementById('drilldownModal').classList.remove('hidden');
                document.getElementById('drilldownModal').classList.add('flex');
            } catch (e) {
                debugLog('Error in showShortPartsModal: ' + e.message, 'error');
                showDrilldown('Short Parts in Picking', 'Error', '<p class="text-center text-red-500 py-8">Error loading data: ' + e.message + '</p>', '');
            }
        }

        function showCycleCountModal() {
            debugLog('Loading cycle count details...', 'click');
            const data = getCycleCountDetail();
            currentDrilldownData = data;

            if (data.length === 0) {
                showDrilldown('Cycle Count Adjustments', 'No cycle count adjustments found', '<p class="text-center text-slate-500 py-8">No cycle count adjustments in this period</p>', '');
                return;
            }

            const totalValueAdjusted = data.reduce((sum, r) => sum + parseFloat(r.value_adjusted || 0), 0);
            const totalQtyAdjusted = data.reduce((sum, r) => sum + parseFloat(r.qty_adjusted || 0), 0);
            const uniqueParts = new Set(data.map(r => r.part_num)).size;

            let tableHtml = `
                <table class="w-full text-sm" style="table-layout: auto;">
                    <thead class="bg-slate-100 sticky top-0 z-10">
                        <tr>
                            <th class="px-3 py-3 text-left font-semibold text-slate-700 whitespace-nowrap">Date</th>
                            <th class="px-3 py-3 text-left font-semibold text-slate-700 whitespace-nowrap">Part Number</th>
                            <th class="px-3 py-3 text-left font-semibold text-slate-700">Description</th>
                            <th class="px-3 py-3 text-left font-semibold text-slate-700 whitespace-nowrap">Location</th>
                            <th class="px-3 py-3 text-right font-semibold text-slate-700 whitespace-nowrap">Qty</th>
                            <th class="px-3 py-3 text-right font-semibold text-slate-700 whitespace-nowrap">Value</th>
                            <th class="px-3 py-3 text-left font-semibold text-slate-700">Notes</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-200">
            `;

            data.forEach(row => {
                const qtyAdj = parseFloat(row.qty_adjusted || 0);
                const valueAdj = parseFloat(row.value_adjusted || 0);
                const qtyColor = qtyAdj >= 0 ? 'text-green-600' : 'text-red-600';
                const valueColor = valueAdj >= 0 ? 'text-green-600' : 'text-red-600';

                tableHtml += `
                    <tr class="hover:bg-slate-50">
                        <td class="px-3 py-3 text-slate-500 whitespace-nowrap">${moment(row.date_adjusted).format(MOMENT_DATE_FORMAT)}</td>
                        <td class="px-3 py-3 font-mono text-sm whitespace-nowrap">${row.part_num}</td>
                        <td class="px-3 py-3">${row.description || ''}</td>
                        <td class="px-3 py-3 whitespace-nowrap">${row.location_group || ''}</td>
                        <td class="px-3 py-3 text-right ${qtyColor} font-medium whitespace-nowrap">${qtyAdj >= 0 ? '+' : ''}${formatQty(qtyAdj)}</td>
                        <td class="px-3 py-3 text-right ${valueColor} font-medium whitespace-nowrap">${valueAdj >= 0 ? '+' : ''}${formatCurrencyValue(valueAdj)}</td>
                        <td class="px-3 py-3 text-xs text-slate-500 max-w-xs truncate" title="${row.notes || ''}">${row.notes || '-'}</td>
                    </tr>
                `;
            });

            tableHtml += '</tbody></table>';

            const netColor = totalValueAdjusted >= 0 ? 'text-green-600' : 'text-red-600';
            const footer = `
                <div class="flex justify-between items-center">
                    <span><strong>${uniqueParts}</strong> unique parts adjusted</span>
                    <span><strong>${data.length}</strong> total adjustments</span>
                    <span>Net Value: <strong class="${netColor}">${totalValueAdjusted >= 0 ? '+' : ''}${formatCurrencyValue(totalValueAdjusted)}</strong></span>
                </div>
            `;

            showDrilldown('Cycle Count Adjustments', 'Inventory adjustments in selected period', tableHtml, footer);
        }

        function showScrapModal() {
            debugLog('Loading scrap details...', 'click');
            const data = getScrapDetail();
            currentDrilldownData = data;

            if (data.length === 0) {
                showDrilldown('Scrapped Items', 'No scrapped items found', '<p class="text-center text-slate-500 py-8">No scrapped items in this period</p>', '');
                return;
            }

            const totalValueScrapped = data.reduce((sum, r) => sum + parseFloat(r.value_scrapped || 0), 0);
            const totalQtyScrapped = data.reduce((sum, r) => sum + parseFloat(r.qty_scrapped || 0), 0);
            const uniqueParts = new Set(data.map(r => r.part_num)).size;

            let tableHtml = `
                <table class="w-full text-sm" style="table-layout: auto;">
                    <thead class="bg-slate-100 sticky top-0 z-10">
                        <tr>
                            <th class="px-3 py-3 text-left font-semibold text-slate-700 whitespace-nowrap">Date</th>
                            <th class="px-3 py-3 text-left font-semibold text-slate-700 whitespace-nowrap">Part Number</th>
                            <th class="px-3 py-3 text-left font-semibold text-slate-700">Description</th>
                            <th class="px-3 py-3 text-left font-semibold text-slate-700 whitespace-nowrap">Location</th>
                            <th class="px-3 py-3 text-right font-semibold text-slate-700 whitespace-nowrap">Qty</th>
                            <th class="px-3 py-3 text-right font-semibold text-slate-700 whitespace-nowrap">Value</th>
                            <th class="px-3 py-3 text-left font-semibold text-slate-700">Notes</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-200">
            `;

            data.forEach(row => {
                tableHtml += `
                    <tr class="hover:bg-slate-50">
                        <td class="px-3 py-3 text-slate-500 whitespace-nowrap">${moment(row.date_scrapped).format(MOMENT_DATE_FORMAT)}</td>
                        <td class="px-3 py-3 font-mono text-sm whitespace-nowrap">${row.part_num}</td>
                        <td class="px-3 py-3">${row.description || ''}</td>
                        <td class="px-3 py-3 whitespace-nowrap">${row.location_group || ''}</td>
                        <td class="px-3 py-3 text-right text-red-600 font-medium whitespace-nowrap">${formatQty(row.qty_scrapped)}</td>
                        <td class="px-3 py-3 text-right text-red-600 font-medium whitespace-nowrap">${formatCurrencyValue(row.value_scrapped)}</td>
                        <td class="px-3 py-3 text-xs text-slate-500 max-w-xs truncate" title="${row.notes || ''}">${row.notes || '-'}</td>
                    </tr>
                `;
            });

            tableHtml += '</tbody></table>';

            const footer = `
                <div class="flex justify-between items-center">
                    <span><strong>${uniqueParts}</strong> unique parts scrapped</span>
                    <span><strong>${data.length}</strong> total scrap entries</span>
                    <span>Total Value Lost: <strong class="text-red-600">${formatCurrencyValue(totalValueScrapped)}</strong></span>
                </div>
            `;

            showDrilldown('Scrapped Items', 'Items scrapped in selected period', tableHtml, footer);
        }

        function showFulfillmentPipelineModal() {
            debugLog('Loading fulfillment pipeline details...', 'click');
            const data = getFulfillmentPipeline();
            currentDrilldownData = data;
            currentDrilldownSort = { column: null, direction: 'asc' };

            if (data.length === 0) {
                showDrilldown('Picked - Awaiting Pack/Ship', 'No items awaiting pack/ship', '<p class="text-center text-slate-500 py-8">No items awaiting pack/ship</p>', '');
                return;
            }

            function renderTable() {
                let sortedData = data;
                if (currentDrilldownSort.column) {
                    const colTypes = { sonum: 'string', shipnum: 'string', statusname: 'string', customername: 'string', productnum: 'string', qty: 'number', unitprice: 'number', linevalue: 'number', datescheduled: 'date' };
                    sortedData = sortDrilldownData(data, currentDrilldownSort.column, currentDrilldownSort.direction, colTypes[currentDrilldownSort.column] || 'string');
                }

                const totalValue = data.reduce((sum, r) => sum + parseFloat(r.linevalue || 0), 0);
                const uniqueSOs = new Set(data.map(r => r.sonum)).size;

                let tableHtml = `
                    <div class="drilldown-table-wrapper">
                        <table class="drilldown-table text-sm w-full" style="table-layout: auto;">
                            <thead>
                                <tr>
                                    <th class="${getSortClass('datescheduled')} px-3 py-3 text-left font-semibold text-slate-700 whitespace-nowrap" onclick="handleColumnSort('datescheduled', 'date', renderFulfillmentTable)">Scheduled${getSortIcon()}</th>
                                    <th class="${getSortClass('sonum')} px-3 py-3 text-left font-semibold text-slate-700 whitespace-nowrap" onclick="handleColumnSort('sonum', 'string', renderFulfillmentTable)">SO #${getSortIcon()}</th>
                                    <th class="${getSortClass('shipnum')} px-3 py-3 text-left font-semibold text-slate-700 whitespace-nowrap" onclick="handleColumnSort('shipnum', 'string', renderFulfillmentTable)">Ship #${getSortIcon()}</th>
                                    <th class="${getSortClass('statusname')} px-3 py-3 text-left font-semibold text-slate-700 whitespace-nowrap" onclick="handleColumnSort('statusname', 'string', renderFulfillmentTable)">Status${getSortIcon()}</th>
                                    <th class="${getSortClass('customername')} px-3 py-3 text-left font-semibold text-slate-700 whitespace-nowrap" onclick="handleColumnSort('customername', 'string', renderFulfillmentTable)">Customer${getSortIcon()}</th>
                                    <th class="${getSortClass('productnum')} px-3 py-3 text-left font-semibold text-slate-700 whitespace-nowrap" onclick="handleColumnSort('productnum', 'string', renderFulfillmentTable)">Product${getSortIcon()}</th>
                                    <th class="px-3 py-3 text-left font-semibold text-slate-700">Description</th>
                                    <th class="${getSortClass('qty')} px-3 py-3 text-right font-semibold text-slate-700 whitespace-nowrap" onclick="handleColumnSort('qty', 'number', renderFulfillmentTable)">Qty${getSortIcon()}</th>
                                    <th class="${getSortClass('unitprice')} px-3 py-3 text-right font-semibold text-slate-700 whitespace-nowrap" onclick="handleColumnSort('unitprice', 'number', renderFulfillmentTable)">Unit Price${getSortIcon()}</th>
                                    <th class="${getSortClass('linevalue')} px-3 py-3 text-right font-semibold text-slate-700 whitespace-nowrap" onclick="handleColumnSort('linevalue', 'number', renderFulfillmentTable)">Line Value${getSortIcon()}</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-200">
                `;

                sortedData.forEach(row => {
                    const scheduledDate = row.datescheduled ? moment(row.datescheduled).format(MOMENT_DATE_FORMAT) : '-';
                    tableHtml += `
                        <tr class="hover:bg-slate-50">
                            <td class="px-3 py-3 text-slate-500 whitespace-nowrap">${scheduledDate}</td>
                            <td class="px-3 py-3 whitespace-nowrap"><a href="#" class="text-cyan-600 hover:underline font-medium" onclick="openModule('Sales Order', '${row.sonum}'); return false;">${row.sonum}</a></td>
                            <td class="px-3 py-3 whitespace-nowrap"><a href="#" class="text-cyan-600 hover:underline" onclick="openModule('Shipping', '${row.shipnum}'); return false;">${row.shipnum}</a></td>
                            <td class="px-3 py-3"><span class="px-2 py-1 text-xs rounded whitespace-nowrap ${row.statusid === 10 ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700'}">${row.statusname}</span></td>
                            <td class="px-3 py-3">${row.customername || ''}</td>
                            <td class="px-3 py-3 font-mono text-sm whitespace-nowrap">${row.productnum}</td>
                            <td class="px-3 py-3 max-w-xs truncate" title="${row.productdesc || ''}">${row.productdesc || ''}</td>
                            <td class="px-3 py-3 text-right font-medium whitespace-nowrap">${formatQty(row.qty)}</td>
                            <td class="px-3 py-3 text-right whitespace-nowrap">${formatCurrencyValue(row.unitprice)}</td>
                            <td class="px-3 py-3 text-right font-medium text-cyan-600 whitespace-nowrap">${formatCurrencyValue(row.linevalue)}</td>
                        </tr>
                    `;
                });

                tableHtml += '</tbody></table></div>';

                const footer = `
                    <div class="flex justify-between items-center">
                        <span><strong>${uniqueSOs}</strong> Sales Orders</span>
                        <span><strong>${data.length}</strong> line items</span>
                        <span>Total Value: <strong class="text-cyan-600">${formatCurrencyValue(totalValue)}</strong></span>
                    </div>
                `;

                document.getElementById('drilldownContent').innerHTML = tableHtml;
                document.getElementById('drilldownFooter').innerHTML = footer;
            }

            window.renderFulfillmentTable = renderTable;
            renderTable();
            document.getElementById('drilldownTitle').textContent = 'Picked - Awaiting Pack/Ship';
            document.getElementById('drilldownSubtitle').textContent = 'SO items picked but not yet shipped';
            document.getElementById('drilldownModal').classList.remove('hidden');
            document.getElementById('drilldownModal').classList.add('flex');
        }

        function showUnavailableModal() {
            debugLog('Loading unavailable stock details...', 'click');
            const data = getUnavailableDetail();
            currentDrilldownData = data;

            if (data.length === 0) {
                showDrilldown('Unavailable Stock', 'No unavailable stock found', '<p class="text-center text-slate-500 py-8">No unavailable stock</p>', '');
                return;
            }

            const totalValue = data.reduce((sum, r) => sum + parseFloat(r.value_unavailable || 0), 0);
            const totalQty = data.reduce((sum, r) => sum + parseFloat(r.qty_unavailable || 0), 0);

            let tableHtml = `
                <table class="w-full text-sm" style="table-layout: auto;">
                    <thead class="bg-slate-100 sticky top-0">
                        <tr>
                            <th class="px-3 py-3 text-left font-semibold text-slate-700 whitespace-nowrap">Part Number</th>
                            <th class="px-3 py-3 text-left font-semibold text-slate-700">Description</th>
                            <th class="px-3 py-3 text-left font-semibold text-slate-700 whitespace-nowrap">Location</th>
                            <th class="px-3 py-3 text-right font-semibold text-slate-700 whitespace-nowrap">Qty Unavailable</th>
                            <th class="px-3 py-3 text-right font-semibold text-slate-700 whitespace-nowrap">Avg Cost</th>
                            <th class="px-3 py-3 text-right font-semibold text-slate-700 whitespace-nowrap">Value</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-200">
            `;

            data.forEach(row => {
                tableHtml += `
                    <tr class="hover:bg-slate-50">
                        <td class="px-3 py-3 font-mono text-sm whitespace-nowrap">${row.part_num}</td>
                        <td class="px-3 py-3">${row.description || ''}</td>
                        <td class="px-3 py-3 whitespace-nowrap">${row.location_group || ''}</td>
                        <td class="px-3 py-3 text-right text-amber-600 font-medium whitespace-nowrap">${formatQty(row.qty_unavailable)}</td>
                        <td class="px-3 py-3 text-right whitespace-nowrap">${formatCurrencyValue(row.avg_cost)}</td>
                        <td class="px-3 py-3 text-right font-medium text-amber-600 whitespace-nowrap">${formatCurrencyValue(row.value_unavailable)}</td>
                    </tr>
                `;
            });

            tableHtml += '</tbody></table>';

            const footer = `
                <div class="flex justify-between items-center">
                    <span><strong>${data.length}</strong> parts unavailable</span>
                    <span><strong>${formatQty(totalQty)}</strong> total units</span>
                    <span>Total Value: <strong class="text-amber-600">${formatCurrencyValue(totalValue)}</strong></span>
                </div>
            `;

            showDrilldown('Unavailable Stock', 'Stock currently not available for allocation', tableHtml, footer);
        }

        function showBelowReorderModal() {
            debugLog('Loading below reorder details...', 'click');
            const data = getBelowReorderDetail();
            currentDrilldownData = data;

            if (data.length === 0) {
                showDrilldown('Below Reorder Point', 'No parts below reorder', '<p class="text-center text-slate-500 py-8">All parts are above reorder point</p>', '');
                return;
            }

            let tableHtml = `
                <table class="w-full text-sm" style="table-layout: auto;">
                    <thead class="bg-slate-100 sticky top-0">
                        <tr>
                            <th class="px-3 py-3 text-left font-semibold text-slate-700 whitespace-nowrap">Part Number</th>
                            <th class="px-3 py-3 text-left font-semibold text-slate-700">Description</th>
                            <th class="px-3 py-3 text-left font-semibold text-slate-700 whitespace-nowrap">Location</th>
                            <th class="px-3 py-3 text-right font-semibold text-slate-700 whitespace-nowrap">On Hand</th>
                            <th class="px-3 py-3 text-right font-semibold text-slate-700 whitespace-nowrap">Reorder Point</th>
                            <th class="px-3 py-3 text-right font-semibold text-slate-700 whitespace-nowrap">Qty Short</th>
                            <th class="px-3 py-3 text-right font-semibold text-slate-700 whitespace-nowrap">Avg Cost</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-200">
            `;

            data.forEach(row => {
                const qtyShort = parseFloat(row.qty_short || 0);
                tableHtml += `
                    <tr class="hover:bg-slate-50">
                        <td class="px-3 py-3 font-mono text-sm whitespace-nowrap">${row.part_num}</td>
                        <td class="px-3 py-3">${row.description || ''}</td>
                        <td class="px-3 py-3 whitespace-nowrap">${row.location_group || ''}</td>
                        <td class="px-3 py-3 text-right whitespace-nowrap">${formatQty(row.qty_on_hand)}</td>
                        <td class="px-3 py-3 text-right whitespace-nowrap">${formatQty(row.reorder_point)}</td>
                        <td class="px-3 py-3 text-right text-orange-600 font-medium whitespace-nowrap">${formatQty(qtyShort)}</td>
                        <td class="px-3 py-3 text-right whitespace-nowrap">${formatCurrencyValue(row.avg_cost)}</td>
                    </tr>
                `;
            });

            tableHtml += '</tbody></table>';

            const footer = `
                <div class="flex justify-between items-center">
                    <span><strong>${data.length}</strong> parts below reorder point</span>
                    <span>Click Export to download list</span>
                </div>
            `;

            showDrilldown('Below Reorder Point', 'Parts with stock below reorder level', tableHtml, footer);
        }

        function getABCCodeDetail(abcCode) {
            const locationGroup = document.getElementById('locationGroupFilter').value;
            const vendorFilter = document.getElementById('vendorFilter').value;

            let lgCondition = locationGroup !== '%' ? `AND lg.id = ${locationGroup}` : '';
            let vendorCondition = vendorFilter !== '%' ? `AND EXISTS (SELECT 1 FROM vendorparts vp WHERE vp.partid = p.id AND vp.vendorid = ${vendorFilter} AND vp.defaultflag = 1)` : '';

            // Handle NULL/empty abcCode
            let abcCondition = abcCode === 'U' || abcCode === '' || abcCode === null
                ? `AND (p.abcCode IS NULL OR p.abcCode = '')`
                : `AND p.abcCode = '${abcCode}'`;

            const query = `
                SELECT
                    p.num as part_num,
                    p.description,
                    COALESCE(p.abcCode, 'U') as abc_code,
                    SUM(COALESCE(qoh.qty, 0)) as qty_on_hand,
                    COALESCE(pc.avgCost, 0) as avg_cost,
                    SUM(COALESCE(qoh.qty, 0) * COALESCE(pc.avgCost, 0)) as total_value
                FROM part p
                LEFT JOIN qtyonhand qoh ON p.id = qoh.partid
                LEFT JOIN locationgroup lg ON qoh.locationgroupid = lg.id
                LEFT JOIN partcost pc ON p.id = pc.partid
                WHERE p.activeflag = 1
                    AND p.typeid = 10
                    ${abcCondition}
                    ${lgCondition}
                    ${vendorCondition}
                GROUP BY p.id, p.num, p.description, p.abcCode, pc.avgCost
                HAVING qty_on_hand > 0
                ORDER BY total_value DESC
                LIMIT 100
            `;

            debugLog('ABC Detail Query: ' + query, 'info');
            return JSON.parse(runQuery(query));
        }

        let abcDrilldownSort = { column: 'total_value', direction: 'desc' };
        let abcDrilldownData = [];
        let abcDrilldownLabel = '';

        function showABCCodeModal(abcCode, statusLabel) {
            debugLog(`Loading ABC code ${abcCode} details...`, 'click');
            abcDrilldownData = getABCCodeDetail(abcCode);
            abcDrilldownLabel = statusLabel;
            currentDrilldownData = abcDrilldownData;

            if (abcDrilldownData.length === 0) {
                showDrilldown(`ABC Code: ${statusLabel}`, 'No parts found', '<p class="text-center text-slate-500 py-8">No parts found with this ABC code</p>', '');
                return;
            }

            renderABCDrilldownTable();
        }

        window.sortABCDrilldown = function(column) {
            if (abcDrilldownSort.column === column) {
                abcDrilldownSort.direction = abcDrilldownSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                abcDrilldownSort.column = column;
                abcDrilldownSort.direction = 'desc';
            }
            renderABCDrilldownTable();
        };

        function renderABCDrilldownTable() {
            const data = [...abcDrilldownData].sort((a, b) => {
                let aVal = a[abcDrilldownSort.column];
                let bVal = b[abcDrilldownSort.column];
                if (typeof aVal === 'string') aVal = aVal.toLowerCase();
                if (typeof bVal === 'string') bVal = bVal.toLowerCase();
                aVal = parseFloat(aVal) || aVal || '';
                bVal = parseFloat(bVal) || bVal || '';
                if (aVal < bVal) return abcDrilldownSort.direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return abcDrilldownSort.direction === 'asc' ? 1 : -1;
                return 0;
            });

            const totalValue = data.reduce((sum, r) => sum + parseFloat(r.total_value || 0), 0);
            const totalQty = data.reduce((sum, r) => sum + parseFloat(r.qty_on_hand || 0), 0);

            const getSortClass = (col) => abcDrilldownSort.column === col ? `sortable sort-${abcDrilldownSort.direction}` : 'sortable';

            let tableHtml = `
                <table class="w-full text-sm drilldown-table" style="table-layout: auto;">
                    <thead class="bg-slate-100 sticky top-0 z-10">
                        <tr>
                            <th class="px-3 py-3 text-left font-semibold text-slate-700 whitespace-nowrap ${getSortClass('part_num')}" onclick="sortABCDrilldown('part_num')" style="cursor:pointer">Part Number</th>
                            <th class="px-3 py-3 text-left font-semibold text-slate-700 ${getSortClass('description')}" onclick="sortABCDrilldown('description')" style="cursor:pointer">Description</th>
                            <th class="px-3 py-3 text-right font-semibold text-slate-700 whitespace-nowrap ${getSortClass('qty_on_hand')}" onclick="sortABCDrilldown('qty_on_hand')" style="cursor:pointer">Qty On Hand</th>
                            <th class="px-3 py-3 text-right font-semibold text-slate-700 whitespace-nowrap ${getSortClass('avg_cost')}" onclick="sortABCDrilldown('avg_cost')" style="cursor:pointer">Avg Cost</th>
                            <th class="px-3 py-3 text-right font-semibold text-slate-700 whitespace-nowrap ${getSortClass('total_value')}" onclick="sortABCDrilldown('total_value')" style="cursor:pointer">Total Value</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-200">
            `;

            data.forEach(row => {
                tableHtml += `
                    <tr class="hover:bg-slate-50">
                        <td class="px-3 py-3 font-mono text-sm text-cyan-700 cursor-pointer hover:underline whitespace-nowrap" onclick="openModule('Part', '${row.part_num}')">${row.part_num}</td>
                        <td class="px-3 py-3">${row.description || ''}</td>
                        <td class="px-3 py-3 text-right font-medium whitespace-nowrap">${formatQty(row.qty_on_hand)}</td>
                        <td class="px-3 py-3 text-right whitespace-nowrap">${formatCurrencyValue(row.avg_cost)}</td>
                        <td class="px-3 py-3 text-right font-medium whitespace-nowrap">${formatCurrencyValue(row.total_value)}</td>
                    </tr>
                `;
            });

            tableHtml += '</tbody></table>';

            const footer = `
                <div class="flex justify-between items-center">
                    <span><strong>${data.length}</strong> parts${data.length >= 100 ? ' (limited to 100)' : ''}</span>
                    <span>Total Qty: <strong>${formatQty(totalQty)}</strong></span>
                    <span>Total Value: <strong class="text-indigo-600">${formatCurrencyValue(totalValue)}</strong></span>
                </div>
            `;

            showDrilldown(`ABC Code: ${abcDrilldownLabel}`, 'Parts with this ABC classification', tableHtml, footer);
        }

        function getStockMovements() {
            const locationGroup = document.getElementById('locationGroupFilter').value;
            const productCategory = document.getElementById('productCategoryFilter').value;
            const vendorFilter = document.getElementById('vendorFilter').value;

            let lgCondition = locationGroup !== '%' ? `AND LOCGRP.id = ${locationGroup}` : '';
            let categoryCondition = productCategory !== '%' ? `AND pt.name = '${productCategory}'` : '';
            let vendorCondition = vendorFilter !== '%' ? `AND EXISTS (SELECT 1 FROM vendorparts vp WHERE vp.partid = PART.id AND vp.vendorid = ${vendorFilter} AND vp.defaultflag = 1)` : '';

            // Simplified Part Activity query - grouped by date and event type
            const query = `
                SELECT
                    DATE(INVENTORYLOG.eventDate) as date,
                    INVENTORYLOGTYPE.DESCRIPTION as event_type,
                    SUM(INVENTORYLOG.CHANGEQTY) as total_change,
                    COUNT(*) as transaction_count
                FROM INVENTORYLOG
                INNER JOIN LOCATIONGROUP LOCGRP ON INVENTORYLOG.LOCATIONGROUPID = LOCGRP.ID
                INNER JOIN INVENTORYLOGTYPE ON INVENTORYLOG.TYPEID = INVENTORYLOGTYPE.ID
                INNER JOIN PART ON INVENTORYLOG.PARTID = PART.ID
                LEFT JOIN producttree pt ON PART.treeId = pt.id
                WHERE ${getDateCondition('INVENTORYLOG.eventDate')}
                    AND PART.activeflag = 1
                    AND PART.typeid = 10
                    ${lgCondition}
                    ${categoryCondition}
                    ${vendorCondition}
                GROUP BY DATE(INVENTORYLOG.eventDate), INVENTORYLOGTYPE.DESCRIPTION
                ORDER BY date ASC, event_type
            `;

            console.log('Stock Movements Query:', query);
            return JSON.parse(runQuery(query));
        }

        function getMovementSummary() {
            const locationGroup = document.getElementById('locationGroupFilter').value;
            const vendorFilter = document.getElementById('vendorFilter').value;
            const { start, end } = getDateRange();

            let lgCondition = locationGroup !== '%' ? `AND il.locationGroupId = ${locationGroup}` : '';
            let lgConditionReceipt = locationGroup !== '%' ? `AND r.locationgroupid = ${locationGroup}` : '';
            let lgConditionPost = locationGroup !== '%' ? `AND INVENTORYLOG.LOCATIONGROUPID = ${locationGroup}` : '';
            let vendorCondition = vendorFilter !== '%' ? `AND EXISTS (SELECT 1 FROM vendorparts vp WHERE vp.partid = p.id AND vp.vendorid = ${vendorFilter} AND vp.defaultflag = 1)` : '';
            let vendorConditionReceipt = vendorFilter !== '%' ? `AND po.vendorid = ${vendorFilter}` : '';
            let vendorConditionPost = vendorFilter !== '%' ? `AND EXISTS (SELECT 1 FROM vendorparts vp WHERE vp.partid = PART.id AND vp.vendorid = ${vendorFilter} AND vp.defaultflag = 1)` : '';

            // Value-based movement summary
            // Received: From receiptitem with statusid >= 20 (Reconciled, Received, Fulfilled), uses landedtotalcost
            //           Date filtered by newest of dateReceived/dateReconciled (whichever is most recent)
            // Shipped: From postsoitem (invoiced sales), uses PostedTotalCost
            // Scrap: From POST table (TYPEID=50, REFITEMID=2) using POST.AMOUNT for historical cost
            // Adjustments: From POST table (TYPEID=50, REFITEMID=3) using POST.AMOUNT for historical cost (Cycle Count)
            const query = `
                SELECT 'Received' as category,
                    COALESCE(SUM(ri.qty), 0) as total_qty,
                    COALESCE(SUM(ri.landedtotalcost), 0) as total_value,
                    COUNT(*) as count
                FROM receiptitem ri
                JOIN receipt r ON ri.receiptid = r.id
                JOIN poitem ON ri.poitemid = poitem.id
                JOIN part p ON poitem.partid = p.id
                JOIN po ON poitem.poid = po.id
                WHERE COALESCE(GREATEST(ri.dateReceived, ri.dateReconciled), ri.dateReceived, ri.dateReconciled) >= '${start}'
                  AND COALESCE(GREATEST(ri.dateReceived, ri.dateReconciled), ri.dateReceived, ri.dateReconciled) <= '${end} 23:59:59'
                  AND ri.statusid >= 20
                  AND p.typeid = 10
                  AND p.activeflag = 1
                  ${lgConditionReceipt}
                  ${vendorConditionReceipt}

                UNION ALL

                SELECT 'Shipped' as category,
                    COALESCE(SUM(ABS(psi.qty)), 0) as total_qty,
                    COALESCE(SUM(ABS(psi.PostedTotalCost)), 0) as total_value,
                    COUNT(*) as count
                FROM postsoitem psi
                JOIN soitem si ON psi.soitemid = si.id
                JOIN part p ON si.productid = p.id
                WHERE psi.dateCreated >= '${start}'
                  AND psi.dateCreated <= '${end} 23:59:59'
                  AND p.activeflag = 1
                  AND p.typeid = 10
                  ${vendorCondition}

                UNION ALL

                SELECT 'Scrap' as category,
                    COALESCE(SUM(ABS(POST.QUANTITY)), 0) as total_qty,
                    COALESCE(SUM(ABS(POST.AMOUNT)), 0) as total_value,
                    COUNT(*) as count
                FROM POST
                INNER JOIN PART ON POST.REFID = PART.ID
                LEFT JOIN INVENTORYLOG ON INVENTORYLOG.RECORDID = POST.ID AND INVENTORYLOG.TABLEID = -1407594912
                WHERE POST.TYPEID = 50
                    AND POST.REFITEMID = 2
                    AND POST.DATECREATED >= '${start}' AND POST.DATECREATED <= '${end} 23:59:59'
                    AND PART.activeflag = 1
                    AND PART.typeid = 10
                    ${lgConditionPost}
                    ${vendorConditionPost}

                UNION ALL

                SELECT 'Adjustments' as category,
                    COALESCE(SUM(ABS(POST.QUANTITY)), 0) as total_qty,
                    COALESCE(SUM(POST.AMOUNT), 0) as total_value,
                    COUNT(*) as count
                FROM POST
                INNER JOIN PART ON POST.REFID = PART.ID
                LEFT JOIN INVENTORYLOG ON INVENTORYLOG.RECORDID = POST.ID AND INVENTORYLOG.TABLEID = -1407594912
                WHERE POST.TYPEID = 50
                    AND POST.REFITEMID = 3
                    AND COALESCE(POST.QUANTITY, 0) != 0
                    AND POST.DATECREATED >= '${start}' AND POST.DATECREATED <= '${end} 23:59:59'
                    AND PART.activeflag = 1
                    AND PART.typeid = 10
                    ${lgConditionPost}
                    ${vendorConditionPost}
            `;

            debugLog('Movement Summary Query: ' + query, 'info');
            return JSON.parse(runQuery(query));
        }

        // Get Revenue for inventory parts (for margin calculation in Stock Value Flow)
        function getInventoryRevenue() {
            const { start, end } = getDateRange();
            const lg = document.getElementById('locationGroupFilter').value;
            const lgCondition = lg !== '%' ? `AND PostSo.LocationGroupId = ${lg}` : '';

            // Get Revenue from PostSoItem - INVENTORY PARTS ONLY
            const query = `
                SELECT
                    SUM(COALESCE(((PostSoItem.TotalPrice/PostSoItem.Qty)-((PostSoItem.TotalPrice/PostSoItem.Qty)*PSI.AdjustPercent)), PostSoItem.TotalPrice/PostSoItem.Qty) * PostSoItem.Qty) as revenue
                FROM PostSo
                JOIN PostSoItem ON PostSoItem.PostSoId = PostSo.Id
                JOIN SoItem ON SoItem.Id = PostSoItem.SoItemId
                JOIN Product ON Product.Id = SoItem.ProductId
                JOIN Part ON Part.Id = Product.PartId
                LEFT JOIN PostSoItem PSI ON PSI.SoItemId = COALESCE(
                    (SELECT K.Id FROM SoItem K WHERE K.SoLineItem = SoItem.SoLineItem+1 AND K.TypeId = 30 AND SoItem.typeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1),
                    (SELECT K.Id FROM SoItem K WHERE K.SoLineItem > SoItem.SoLineItem AND EXISTS (SELECT * FROM SoItem J WHERE J.TypeId = 40 AND J.SoId = K.SoId AND J.SoLineItem >= K.SoLineItem-1 ORDER BY J.SoLineItem ASC) AND K.TypeId = 30 AND SoItem.typeId !=30 AND K.SoId = SoItem.SoId ORDER BY K.SoLineItem ASC LIMIT 1)
                ) AND PSI.PostSoId = PostSo.Id
                WHERE PostSo.DATECREATED >= '${start}' AND PostSo.DATECREATED <= '${end}'
                  AND SoItem.typeId NOT IN (30, 40)
                  AND Part.typeid = 10
                  AND Part.activeflag = 1
                  ${lgCondition}
            `;

            try {
                const data = JSON.parse(runQuery(query));
                return parseFloat(data[0]?.revenue || 0);
            } catch (e) {
                debugLog('Revenue query error: ' + e.message, 'error');
                return 0;
            }
        }

        // Slow-Moving Inventory - parts with high days of supply based on sales velocity
        // Using exact working query from Sales Dashboard
        function getSlowMovingInventory() {
            try {
                const { start, end } = getDateRange();
                const daysDiff = moment(end).diff(moment(start), 'days') || 364;

                const query = `
                    SELECT
                        Product.Num AS part_num,
                        Product.Description AS part_name,
                        COALESCE(SUM(CASE WHEN PostSo.DATECREATED IS NOT NULL THEN PostSoItem.Qty ELSE 0 END), 0) AS qty_sold,
                        COALESCE(SUM(CASE WHEN PostSo.DATECREATED IS NOT NULL THEN PostSoItem.Qty ELSE 0 END), 0) / ${daysDiff} AS daily_velocity,
                        (
                            SELECT SUM(qtyOnHand)
                            FROM qtyInventoryTotals
                            WHERE partId = Product.Id
                        ) AS qty_on_hand,
                        (
                            SELECT SUM(qtyOnHand)
                            FROM qtyInventoryTotals
                            WHERE partId = Product.Id
                        ) / NULLIF(COALESCE(SUM(CASE WHEN PostSo.DATECREATED IS NOT NULL THEN PostSoItem.Qty ELSE 0 END), 0) / ${daysDiff}, 0) AS days_of_supply
                    FROM Product
                    LEFT JOIN SoItem ON SoItem.ProductId = Product.Id AND SoItem.typeId NOT IN (30, 40)
                    LEFT JOIN PostSoItem ON PostSoItem.SoItemId = SoItem.Id
                    LEFT JOIN So ON So.Id = SoItem.SoId
                    LEFT JOIN PostSo ON PostSo.SoId = So.Id AND PostSo.DATECREATED >= '${start}' AND PostSo.DATECREATED <= '${end}'
                    LEFT JOIN Customer ON Customer.Id = So.CustomerId
                    LEFT JOIN AccountGroup ON AccountGroup.Id = (
                        SELECT AccountGroupRelation.GroupId
                        FROM AccountGroupRelation
                        WHERE AccountGroupRelation.AccountId = Customer.AccountId
                        ORDER BY AccountGroupRelation.AccountId ASC
                        LIMIT 1
                    )
                    WHERE 1=1
                    GROUP BY Product.Id, Product.Num, Product.Description
                    HAVING qty_on_hand > 0 AND daily_velocity < 1
                    ORDER BY days_of_supply DESC
                    LIMIT 20
                `;

                debugLog('Slow-Moving Inventory query executing...', 'info');
                const result = JSON.parse(runQuery(query));
                debugLog(`Slow-Moving Inventory returned ${result ? result.length : 0} rows`, 'info');
                return result || [];
            } catch (error) {
                debugLog(`ERROR in getSlowMovingInventory: ${error.message}`, 'error');
                return [];
            }
        }

        // ============================================
        // Chart Rendering Functions
        // ============================================

        // Store location group data and sort state for the table
        let locationGroupTableData = [];
        let locationGroupSort = { column: 'total_value', direction: 'desc' };

        function renderLocationChart(data) {
            const container = document.getElementById('locationChart');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-12 text-sm">No data available</p>';
                return;
            }

            // Store data for sorting
            locationGroupTableData = data;

            // Render as a table with clickable rows
            renderLocationGroupTable();
        }

        function renderLocationGroupTable() {
            const container = document.getElementById('locationChart');
            const data = locationGroupTableData;

            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-12 text-sm">No data available</p>';
                return;
            }

            // Sort data
            const sortedData = [...data].sort((a, b) => {
                let aVal, bVal;
                if (locationGroupSort.column === 'location_group_name') {
                    aVal = (a.location_group_name || '').toLowerCase();
                    bVal = (b.location_group_name || '').toLowerCase();
                } else {
                    aVal = parseFloat(a[locationGroupSort.column] || 0);
                    bVal = parseFloat(b[locationGroupSort.column] || 0);
                }
                if (aVal < bVal) return locationGroupSort.direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return locationGroupSort.direction === 'asc' ? 1 : -1;
                return 0;
            });

            const getSortClass = (col) => {
                if (locationGroupSort.column !== col) return 'cursor-pointer hover:bg-slate-200';
                return `cursor-pointer hover:bg-slate-200 sort-${locationGroupSort.direction}`;
            };

            const getSortIcon = (col) => {
                if (locationGroupSort.column !== col) return '<span class="text-slate-300 ml-1">▲</span>';
                return locationGroupSort.direction === 'asc'
                    ? '<span class="text-indigo-600 ml-1">▲</span>'
                    : '<span class="text-indigo-600 ml-1">▼</span>';
            };

            let tableHtml = `
                <table class="w-full text-sm" style="table-layout: auto;">
                    <thead>
                        <tr class="border-b border-slate-200 bg-slate-50">
                            <th class="text-left px-3 py-2 font-semibold text-slate-700 ${getSortClass('location_group_name')}" onclick="sortLocationGroupTable('location_group_name')">
                                Location Group${getSortIcon('location_group_name')}
                            </th>
                            <th class="text-right px-3 py-2 font-semibold text-slate-700 whitespace-nowrap ${getSortClass('part_count')}" onclick="sortLocationGroupTable('part_count')">
                                Parts${getSortIcon('part_count')}
                            </th>
                            <th class="text-right px-3 py-2 font-semibold text-slate-700 whitespace-nowrap ${getSortClass('total_qty')}" onclick="sortLocationGroupTable('total_qty')">
                                Qty On Hand${getSortIcon('total_qty')}
                            </th>
                            <th class="text-right px-3 py-2 font-semibold text-slate-700 whitespace-nowrap ${getSortClass('total_value')}" onclick="sortLocationGroupTable('total_value')">
                                Total Value${getSortIcon('total_value')}
                            </th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            sortedData.forEach((row, idx) => {
                const bgClass = idx % 2 === 0 ? 'bg-white' : 'bg-slate-50';
                tableHtml += `
                    <tr class="${bgClass} hover:bg-indigo-50 cursor-pointer transition-colors border-b border-slate-100"
                        onclick="showLocationGroupDrilldown(${row.location_group_id}, '${escapeSQL(row.location_group_name)}')">
                        <td class="px-3 py-2 text-slate-800 font-medium">${row.location_group_name}</td>
                        <td class="px-3 py-2 text-right text-slate-600 whitespace-nowrap">${parseInt(row.part_count || 0).toLocaleString()}</td>
                        <td class="px-3 py-2 text-right text-slate-600 whitespace-nowrap">${formatQty(row.total_qty)}</td>
                        <td class="px-3 py-2 text-right text-indigo-600 font-semibold whitespace-nowrap">${formatCurrencyValue(row.total_value)}</td>
                    </tr>
                `;
            });

            tableHtml += '</tbody></table>';
            container.innerHTML = tableHtml;
        }

        function sortLocationGroupTable(column) {
            if (locationGroupSort.column === column) {
                locationGroupSort.direction = locationGroupSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                locationGroupSort.column = column;
                // Default to desc for numeric columns, asc for text
                locationGroupSort.direction = column === 'location_group_name' ? 'asc' : 'desc';
            }
            renderLocationGroupTable();
        }

        function showLocationGroupDrilldown(locationGroupId, locationGroupName) {
            debugLog(`Opening drilldown for location group: ${locationGroupName} (ID: ${locationGroupId})`, 'click');

            const data = getStockByLocationGroupDetail(locationGroupId);
            currentDrilldownData = data;

            if (!data || data.length === 0) {
                showDrilldown(
                    `Stock in ${locationGroupName}`,
                    'No parts found in this location group',
                    '<p class="text-center text-slate-500 py-8">No inventory found in this location group</p>',
                    ''
                );
                return;
            }

            // Store for sorting
            let drilldownData = [...data];
            let drilldownSort = { column: 'total_value', direction: 'desc' };

            function renderDrilldownTable() {
                // Sort data
                const sortedData = [...drilldownData].sort((a, b) => {
                    let aVal, bVal;
                    if (drilldownSort.column === 'part_num' || drilldownSort.column === 'description' || drilldownSort.column === 'category') {
                        aVal = (a[drilldownSort.column] || '').toLowerCase();
                        bVal = (b[drilldownSort.column] || '').toLowerCase();
                    } else {
                        aVal = parseFloat(a[drilldownSort.column] || 0);
                        bVal = parseFloat(b[drilldownSort.column] || 0);
                    }
                    if (aVal < bVal) return drilldownSort.direction === 'asc' ? -1 : 1;
                    if (aVal > bVal) return drilldownSort.direction === 'asc' ? 1 : -1;
                    return 0;
                });

                const getSortClass = (col) => {
                    if (drilldownSort.column !== col) return 'sortable';
                    return `sortable sort-${drilldownSort.direction}`;
                };

                let tableHtml = `
                    <div class="drilldown-table-wrapper custom-scrollbar mt-4">
                        <table class="drilldown-table w-full" style="table-layout: auto;">
                            <thead>
                                <tr>
                                    <th class="text-left px-3 py-3 text-xs font-semibold text-slate-600 uppercase tracking-wider whitespace-nowrap ${getSortClass('part_num')}" onclick="window.sortLgDrilldown('part_num')">Part #${getSortIcon()}</th>
                                    <th class="text-left px-3 py-3 text-xs font-semibold text-slate-600 uppercase tracking-wider ${getSortClass('description')}" onclick="window.sortLgDrilldown('description')">Description${getSortIcon()}</th>
                                    <th class="text-left px-3 py-3 text-xs font-semibold text-slate-600 uppercase tracking-wider whitespace-nowrap ${getSortClass('category')}" onclick="window.sortLgDrilldown('category')">Category${getSortIcon()}</th>
                                    <th class="text-right px-3 py-3 text-xs font-semibold text-slate-600 uppercase tracking-wider whitespace-nowrap ${getSortClass('qty_on_hand')}" onclick="window.sortLgDrilldown('qty_on_hand')">Qty On Hand${getSortIcon()}</th>
                                    <th class="text-right px-3 py-3 text-xs font-semibold text-slate-600 uppercase tracking-wider whitespace-nowrap ${getSortClass('avg_cost')}" onclick="window.sortLgDrilldown('avg_cost')">Avg Cost${getSortIcon()}</th>
                                    <th class="text-right px-3 py-3 text-xs font-semibold text-slate-600 uppercase tracking-wider whitespace-nowrap ${getSortClass('total_value')}" onclick="window.sortLgDrilldown('total_value')">Total Value${getSortIcon()}</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                sortedData.forEach((row, idx) => {
                    const bgClass = idx % 2 === 0 ? 'bg-white' : 'bg-slate-50';
                    tableHtml += `
                        <tr class="${bgClass} hover:bg-indigo-50 transition-colors">
                            <td class="px-3 py-3 text-slate-800 font-medium whitespace-nowrap">${row.part_num}</td>
                            <td class="px-3 py-3 text-slate-600">${row.description || ''}</td>
                            <td class="px-3 py-3 text-slate-500 whitespace-nowrap">${row.category || ''}</td>
                            <td class="px-3 py-3 text-right text-slate-600 whitespace-nowrap">${formatQty(row.qty_on_hand)}</td>
                            <td class="px-3 py-3 text-right text-slate-600 whitespace-nowrap">${formatCurrencyValue(row.avg_cost)}</td>
                            <td class="px-3 py-3 text-right text-indigo-600 font-semibold whitespace-nowrap">${formatCurrencyValue(row.total_value)}</td>
                        </tr>
                    `;
                });

                tableHtml += '</tbody></table></div>';

                document.getElementById('drilldownContent').innerHTML = tableHtml;
            }

            // Expose sort function for this drilldown
            window.sortLgDrilldown = function(column) {
                if (drilldownSort.column === column) {
                    drilldownSort.direction = drilldownSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    drilldownSort.column = column;
                    drilldownSort.direction = (column === 'part_num' || column === 'description' || column === 'category') ? 'asc' : 'desc';
                }
                renderDrilldownTable();
            };

            renderDrilldownTable();

            // Calculate totals
            const totalValue = data.reduce((sum, r) => sum + parseFloat(r.total_value || 0), 0);
            const totalQty = data.reduce((sum, r) => sum + parseFloat(r.qty_on_hand || 0), 0);
            const uniqueParts = data.length;

            const footer = `
                <div class="flex items-center justify-between text-slate-600">
                    <span><strong>${uniqueParts}</strong> parts</span>
                    <span>Total Qty: <strong>${formatQty(totalQty)}</strong></span>
                    <span>Total Value: <strong class="text-indigo-600">${formatCurrencyValue(totalValue)}</strong></span>
                </div>
            `;

            showDrilldown(`Stock in ${locationGroupName}`, 'Inventory by part in this location group', document.getElementById('drilldownContent').innerHTML, footer);
        }

        function renderTopPartsChart(data) {
            const container = document.getElementById('topPartsChart');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-12 text-sm">No data available</p>';
                return;
            }

            const margin = { top: 20, right: 30, bottom: 60, left: 100 };
            const width = container.offsetWidth - margin.left - margin.right;
            const height = 300 - margin.top - margin.bottom;

            // Differentiated color palette for location groups
            const locationColors = [
                '#2563eb', // blue
                '#dc2626', // red
                '#16a34a', // green
                '#9333ea', // purple
                '#ea580c', // orange
                '#0891b2', // cyan
                '#c026d3', // fuchsia
                '#ca8a04', // yellow
                '#4f46e5', // indigo
                '#059669'  // emerald
            ];

            // Create color scale for unique location groups
            const uniqueLocations = [...new Set(data.map(d => d.location_group))];
            const locationColorMap = {};
            uniqueLocations.forEach((loc, i) => {
                locationColorMap[loc] = locationColors[i % locationColors.length];
            });

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            // Scales
            const x = d3.scaleLinear()
                .domain([0, d3.max(data, d => parseFloat(d.total_value))])
                .nice()
                .range([0, width]);

            const y = d3.scaleBand()
                .domain(data.map(d => d.part_num))
                .range([0, height])
                .padding(0.2);

            // Bars - colored by location group
            svg.selectAll('.bar')
                .data(data)
                .enter()
                .append('rect')
                .attr('class', 'bar')
                .attr('x', 0)
                .attr('y', d => y(d.part_num))
                .attr('width', d => x(parseFloat(d.total_value)))
                .attr('height', y.bandwidth())
                .attr('fill', d => locationColorMap[d.location_group] || locationColors[0])
                .attr('rx', 4)
                .style('cursor', 'pointer')
                .on('click', function(event, d) {
                    openModule('Part', d.part_num);
                })
                .on('mouseover', function(event, d) {
                    d3.select(this).attr('opacity', 0.8);
                    tooltip.style('opacity', 1)
                        .html(`
                            <div><span class="tooltip-label">Part:</span><span class="tooltip-value">${d.part_num}</span></div>
                            <div><span class="tooltip-label">Description:</span><span class="tooltip-value">${d.description || ''}</span></div>
                            <div><span class="tooltip-label">Location:</span><span class="tooltip-value">${d.location_group || ''}</span></div>
                            <div><span class="tooltip-label">On Hand:</span><span class="tooltip-value">${formatQty(d.qty_on_hand)}</span></div>
                            <div><span class="tooltip-label">Avg Cost:</span><span class="tooltip-value">${formatCurrencyValue(d.avg_cost)}</span></div>
                            <div><span class="tooltip-label">Total Value:</span><span class="tooltip-value">${formatCurrencyValue(d.total_value)}</span></div>
                            <div class="text-xs text-cyan-400 mt-1">Click to open in Part</div>
                        `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function(event, d) {
                    d3.select(this).attr('opacity', 1);
                    tooltip.style('opacity', 0);
                });

            // X Axis
            svg.append('g')
                .attr('class', 'axis')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x).ticks(4).tickFormat(d => CURRENCY_SYMBOL + d3.format('.2s')(d)));

            // Y Axis with clickable part numbers
            const yAxis = svg.append('g')
                .attr('class', 'axis')
                .call(d3.axisLeft(y));

            // Make Y-axis labels clickable
            yAxis.selectAll('.tick text')
                .style('cursor', 'pointer')
                .style('fill', '#0891b2')
                .on('click', function(event, partNum) {
                    openModule('Part', partNum);
                })
                .on('mouseover', function() {
                    d3.select(this).style('fill', '#0e7490').style('text-decoration', 'underline');
                })
                .on('mouseout', function() {
                    d3.select(this).style('fill', '#0891b2').style('text-decoration', 'none');
                });
        }

        function renderStatusChart(data) {
            const container = document.getElementById('statusChart');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-12 text-sm">No ABC code data available</p>';
                return;
            }

            // ABC code colors
            const abcColors = {
                'A': '#ef4444',  // Red - high value, needs attention
                'B': '#f59e0b',  // Amber - medium value
                'C': '#10b981',  // Green - low value
                'N': '#6366f1',  // Indigo - new/unclassified
                'Unassigned': '#94a3b8'  // Gray
            };

            const totalValue = data.reduce((sum, d) => sum + parseFloat(d.total_value || 0), 0);

            const width = 300;
            const height = 260;
            const radius = Math.min(width, height) / 2 - 20;

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height)
                .append('g')
                .attr('transform', `translate(${width / 2},${height / 2})`);

            const color = d3.scaleOrdinal()
                .domain(data.map(d => d.abc_code || 'Unassigned'))
                .range(data.map(d => abcColors[d.abc_code] || abcColors['Unassigned']));

            const pie = d3.pie()
                .value(d => parseFloat(d.total_value || 0))
                .sort(null);

            const arc = d3.arc()
                .innerRadius(radius * 0.5)
                .outerRadius(radius * 0.85);

            const arcs = svg.selectAll('.arc')
                .data(pie(data))
                .enter()
                .append('g')
                .attr('class', 'arc');

            arcs.append('path')
                .attr('d', arc)
                .attr('fill', d => color(d.data.abc_code || 'Unassigned'))
                .attr('stroke', 'white')
                .attr('stroke-width', 2)
                .style('cursor', 'pointer')
                .on('mouseover', function(event, d) {
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr('d', d3.arc().innerRadius(radius * 0.5).outerRadius(radius * 0.9));

                    const pct = totalValue > 0 ? ((parseFloat(d.data.total_value || 0) / totalValue) * 100).toFixed(1) : 0;
                    tooltip.style('opacity', 1)
                        .html(`
                            <div><span class="tooltip-label">ABC Code:</span><span class="tooltip-value">${d.data.status}</span></div>
                            <div><span class="tooltip-label">Parts:</span><span class="tooltip-value">${d.data.part_count}</span></div>
                            <div><span class="tooltip-label">Quantity:</span><span class="tooltip-value">${formatQty(d.data.qty)}</span></div>
                            <div><span class="tooltip-label">Value:</span><span class="tooltip-value">${formatCurrencyValue(d.data.total_value)}</span></div>
                            <div><span class="tooltip-label">% of Total:</span><span class="tooltip-value">${pct}%</span></div>
                            <div class="text-xs text-cyan-400 mt-1">Click to view parts</div>
                        `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr('d', arc);
                    tooltip.style('opacity', 0);
                })
                .on('click', function(event, d) {
                    tooltip.style('opacity', 0);
                    showABCCodeModal(d.data.abc_code, d.data.status);
                });

            // Center text showing total value
            svg.append('text')
                .attr('text-anchor', 'middle')
                .attr('dominant-baseline', 'middle')
                .style('font-size', '18px')
                .style('font-weight', '700')
                .style('fill', '#1e293b')
                .text(formatCurrencyValue(totalValue));

            svg.append('text')
                .attr('text-anchor', 'middle')
                .attr('dominant-baseline', 'middle')
                .attr('y', 20)
                .style('font-size', '10px')
                .style('fill', '#64748b')
                .text('Total Value');

            // Legend below chart
            const legend = d3.select(container)
                .append('div')
                .style('display', 'flex')
                .style('flex-wrap', 'wrap')
                .style('justify-content', 'center')
                .style('gap', '12px')
                .style('margin-top', '8px');

            data.forEach(d => {
                const pct = totalValue > 0 ? ((parseFloat(d.total_value || 0) / totalValue) * 100).toFixed(0) : 0;
                legend.append('div')
                    .style('display', 'flex')
                    .style('align-items', 'center')
                    .style('gap', '4px')
                    .style('font-size', '11px')
                    .html(`
                        <span style="width:10px;height:10px;border-radius:2px;background:${abcColors[d.abc_code] || abcColors['Unassigned']}"></span>
                        <span style="color:#475569;font-weight:500">${d.abc_code || '?'}</span>
                        <span style="color:#94a3b8">(${pct}%)</span>
                    `);
            });
        }

        function renderMovementChart(data, revenue) {
            const container = document.getElementById('movementChart');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-12 text-sm">No movement data available</p>';
                return;
            }

            // Movement category colors
            const movementColors = {
                'Received': '#10b981',    // Green - stock in
                'Shipped': '#ef4444',     // Red - stock out
                'Scrap': '#dc2626',       // Dark red - scrapped
                'Adjustments': '#3b82f6', // Blue - cycle count/adjustments
                'Other': '#94a3b8'        // Gray
            };

            // Calculate values for each category
            const received = data.find(d => d.category === 'Received');
            const shipped = data.find(d => d.category === 'Shipped');
            const scrap = data.find(d => d.category === 'Scrap');
            const adjustments = data.find(d => d.category === 'Adjustments');

            const receivedValue = parseFloat(received?.total_value || 0);
            const shippedValue = Math.abs(parseFloat(shipped?.total_value || 0));
            const scrapValue = Math.abs(parseFloat(scrap?.total_value || 0));
            const adjustmentsValue = parseFloat(adjustments?.total_value || 0);

            // Net position = received - shipped - scrap + adjustments
            const netPosition = receivedValue - shippedValue - scrapValue + adjustmentsValue;

            // Build bar chart data
            const chartData = [
                {
                    category: 'Received',
                    value: receivedValue,
                    color: movementColors['Received'],
                    count: received?.count || 0
                },
                {
                    category: 'Shipped',
                    value: -shippedValue,
                    color: movementColors['Shipped'],
                    count: shipped?.count || 0,
                    revenue: revenue
                },
                { category: 'Scrap', value: -scrapValue, color: movementColors['Scrap'], count: scrap?.count || 0 },
                { category: 'Adjustments', value: adjustmentsValue, color: movementColors['Adjustments'], count: adjustments?.count || 0 }
            ].filter(d => d.value !== 0 || d.count > 0);

            const width = container.clientWidth || 300;
            const height = 260;
            const margin = { top: 20, right: 20, bottom: 60, left: 90 };
            const innerWidth = width - margin.left - margin.right;
            const innerHeight = height - margin.top - margin.bottom;

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            // Scales
            const maxAbsValue = d3.max(chartData, d => Math.abs(d.value)) || 1;
            const x = d3.scaleLinear()
                .domain([-maxAbsValue, maxAbsValue])
                .range([0, innerWidth]);

            const y = d3.scaleBand()
                .domain(chartData.map(d => d.category))
                .range([0, innerHeight])
                .padding(0.3);

            // Zero line
            svg.append('line')
                .attr('x1', x(0))
                .attr('x2', x(0))
                .attr('y1', 0)
                .attr('y2', innerHeight)
                .attr('stroke', '#cbd5e1')
                .attr('stroke-width', 1);

            // Bars
            svg.selectAll('.bar')
                .data(chartData)
                .enter()
                .append('rect')
                .attr('class', 'bar')
                .attr('y', d => y(d.category))
                .attr('x', d => d.value >= 0 ? x(0) : x(d.value))
                .attr('width', d => Math.abs(x(d.value) - x(0)))
                .attr('height', y.bandwidth())
                .attr('fill', d => d.color)
                .attr('rx', 4)
                .on('mouseover', function(event, d) {
                    d3.select(this).attr('opacity', 0.8);
                    const valueDisplay = d.value >= 0 ? `+${formatCurrencyValue(d.value)}` : formatCurrencyValue(d.value);

                    // Build tooltip
                    let tooltipHtml = `
                        <div><span class="tooltip-label">Category:</span><span class="tooltip-value">${d.category}</span></div>
                        <div><span class="tooltip-label">Value (Posted Cost):</span><span class="tooltip-value" style="color: ${d.value >= 0 ? '#10b981' : '#ef4444'}">${valueDisplay}</span></div>
                        <div><span class="tooltip-label">Transactions:</span><span class="tooltip-value">${parseInt(d.count).toLocaleString()}</span></div>
                    `;

                    // Add revenue and margin for Shipped category
                    if (d.revenue && d.revenue > 0) {
                        const cogs = Math.abs(d.value);
                        const grossProfit = d.revenue - cogs;
                        const marginPct = (grossProfit / d.revenue * 100).toFixed(1);
                        tooltipHtml += `
                            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #475569;">
                                <div><span class="tooltip-label">Revenue:</span><span class="tooltip-value" style="color: #3b82f6">${formatCurrencyValue(d.revenue)}</span></div>
                                <div><span class="tooltip-label">Gross Profit:</span><span class="tooltip-value" style="color: #10b981">${formatCurrencyValue(grossProfit)}</span></div>
                                <div><span class="tooltip-label">Margin:</span><span class="tooltip-value">${marginPct}%</span></div>
                            </div>
                        `;
                    }

                    // Add note if available
                    if (d.note) {
                        tooltipHtml += `<div style="font-size: 10px; color: #94a3b8; margin-top: 6px; max-width: 200px;">${d.note}</div>`;
                    }

                    tooltip.style('opacity', 1)
                        .html(tooltipHtml)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    d3.select(this).attr('opacity', 1);
                    tooltip.style('opacity', 0);
                });

            // Y axis (categories)
            svg.append('g')
                .attr('class', 'axis')
                .call(d3.axisLeft(y))
                .selectAll('text')
                .style('font-size', '11px')
                .style('font-weight', '500');

            // X axis (values)
            svg.append('g')
                .attr('class', 'axis')
                .attr('transform', `translate(0,${innerHeight})`)
                .call(d3.axisBottom(x).ticks(5).tickFormat(d => CURRENCY_SYMBOL + d3.format('.2s')(Math.abs(d))));

            // Net position display
            const netContainer = d3.select(container)
                .append('div')
                .style('display', 'flex')
                .style('justify-content', 'center')
                .style('align-items', 'center')
                .style('gap', '8px')
                .style('margin-top', '8px')
                .style('padding', '8px 12px')
                .style('background', netPosition >= 0 ? '#ecfdf5' : '#fef2f2')
                .style('border-radius', '8px')
                .style('border', `1px solid ${netPosition >= 0 ? '#a7f3d0' : '#fecaca'}`);

            netContainer.append('span')
                .style('font-size', '12px')
                .style('color', '#64748b')
                .style('font-weight', '500')
                .text('Net Position:');

            netContainer.append('span')
                .style('font-size', '14px')
                .style('font-weight', '700')
                .style('color', netPosition >= 0 ? '#10b981' : '#ef4444')
                .text((netPosition >= 0 ? '+' : '') + formatCurrencyValue(netPosition));
        }

        function renderSlowMovingChart(data) {
            const container = document.getElementById('slowMovingChart');
            container.innerHTML = '';

            if (!data || !Array.isArray(data) || data.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-400 py-8">No slow-moving inventory found</div>';
                return;
            }

            const width = container.clientWidth;
            const height = 300;
            const margin = { top: 10, right: 10, bottom: 60, left: 100 };

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            const topData = data.slice(0, 10);

            // Cap days_of_supply at a reasonable maximum for display
            const maxDays = Math.min(d3.max(topData, d => parseFloat(d.days_of_supply) || 0), 365);

            const x = d3.scaleLinear()
                .domain([0, maxDays])
                .nice()
                .range([margin.left, width - margin.right]);

            const y = d3.scaleBand()
                .domain(topData.map(d => d.part_num))
                .range([margin.top, height - margin.bottom])
                .padding(0.2);

            svg.selectAll('rect')
                .data(topData)
                .enter()
                .append('rect')
                .attr('x', margin.left)
                .attr('y', d => y(d.part_num))
                .attr('width', d => Math.max(0, x(Math.min(parseFloat(d.days_of_supply) || 0, maxDays)) - margin.left))
                .attr('height', y.bandwidth())
                .attr('fill', '#f97316')
                .style('cursor', 'pointer')
                .on('click', (event, d) => openModule('Part', d.part_num))
                .on('mouseover', function(event, d) {
                    d3.select(this).style('opacity', 0.7);
                    showTooltip(event, `
                        <strong style="color: #0891b2;">${d.part_num}</strong><br>
                        ${d.part_name || ''}<br>
                        On Hand: ${formatQty(d.qty_on_hand)}<br>
                        Sold (period): ${formatQty(d.qty_sold)}<br>
                        Days of Supply: ${d.days_of_supply && d.days_of_supply < 99999 ? parseFloat(d.days_of_supply).toFixed(0) : '∞'}<br>
                        <em style="font-size: 10px; color: #64748b;">Click to open in Part</em>
                    `);
                })
                .on('mouseout', function() {
                    d3.select(this).style('opacity', 1);
                    hideTooltip();
                });

            svg.append('g')
                .attr('transform', `translate(0, ${height - margin.bottom})`)
                .attr('class', 'axis')
                .call(d3.axisBottom(x));

            // Add X-axis label
            svg.append('text')
                .attr('x', width / 2)
                .attr('y', height - 5)
                .attr('text-anchor', 'middle')
                .style('font-size', '12px')
                .style('fill', '#64748b')
                .text('Days of Stock');

            const yAxis = svg.append('g')
                .attr('transform', `translate(${margin.left}, 0)`)
                .attr('class', 'axis')
                .call(d3.axisLeft(y));

            // Make Y-axis labels clickable
            yAxis.selectAll('.tick text')
                .style('font-size', '9px')
                .style('cursor', 'pointer')
                .style('fill', '#0891b2')
                .text(d => d && d.length > 15 ? d.substring(0, 15) + '...' : d)
                .on('click', function(event, partNum) {
                    openModule('Part', partNum);
                })
                .on('mouseover', function() {
                    d3.select(this).style('fill', '#0e7490').style('text-decoration', 'underline');
                })
                .on('mouseout', function() {
                    d3.select(this).style('fill', '#0891b2').style('text-decoration', 'none');
                });
        }

        // Store KPI values globally for header updates
        let kpiValues = {
            totalValue: 0,
            partCount: 0,
            belowReorder: 0,
            shortParts: 0,
            shortPickValue: 0,
            cycleCountValue: 0,
            scrapValue: 0
        };

        function updateHeaderKPIs() {
            const kpiCardsContainer = document.getElementById('kpiCards');
            if (!kpiCardsContainer) return;

            kpiCardsContainer.innerHTML = `
                <div class="flex items-center gap-2 px-3 py-2 bg-emerald-50 border border-emerald-200 rounded-lg">
                    <svg class="w-4 h-4 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="text-xs font-semibold text-slate-600">Inventory Value:</span>
                    <span class="text-sm font-bold text-slate-900">${formatCurrencyValue(kpiValues.totalValue, false)}</span>
                </div>
                <div class="flex items-center gap-2 px-3 py-2 bg-blue-50 border border-blue-200 rounded-lg">
                    <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                    </svg>
                    <span class="text-xs font-semibold text-slate-600">Parts in Stock:</span>
                    <span class="text-sm font-bold text-slate-900">${kpiValues.partCount.toLocaleString()}</span>
                </div>
                ${kpiValues.belowReorder > 0 ? `
                <div class="flex items-center gap-2 px-3 py-2 bg-orange-50 border border-orange-200 rounded-lg cursor-pointer hover:bg-orange-100" onclick="showBelowReorderModal()">
                    <svg class="w-4 h-4 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                    <span class="text-xs font-semibold text-slate-600">Low Stock:</span>
                    <span class="text-sm font-bold text-orange-600">${kpiValues.belowReorder}</span>
                </div>
                ` : ''}
            `;
        }

        function updateKPIs(data) {
            if (!data || data.length === 0) {
                debugLog('No KPI data returned', 'warning');
                kpiValues.totalValue = 0;
                kpiValues.partCount = 0;
            } else {
                const metrics = data[0];
                kpiValues.totalValue = parseFloat(metrics.total_value || 0);
                kpiValues.partCount = parseInt(metrics.part_count || 0);
                debugLog(`KPIs updated: Value=${formatCurrencyValue(kpiValues.totalValue)}, Parts=${kpiValues.partCount}`, 'success');
            }
            updateHeaderKPIs();
        }

        function updateBelowReorderKPI(count) {
            kpiValues.belowReorder = count || 0;
            updateHeaderKPIs();
        }

        function updateUnavailableKPI(data) {
            // Unavailable is shown in Activity row, not header
            // No action needed here for header
        }

        // ============================================
        // UI Functions
        // ============================================
        function applyDateRange() {
            const rangeValue = document.getElementById('dateRangeFilter').value;
            const customContainer = document.getElementById('customDateRangeContainer');

            // Hide/show custom date picker
            if (rangeValue === 'custom') {
                customContainer.style.display = 'flex';
                return; // Don't load dashboard until custom dates are set
            } else {
                customContainer.style.display = 'none';
            }

            // Calculate date range
            let dates;
            switch(rangeValue) {
                case 'today':
                    dates = {
                        start: moment().format('YYYY-MM-DD'),
                        end: moment().format('YYYY-MM-DD')
                    };
                    break;
                case 'this_week':
                    dates = {
                        start: moment().startOf('week').format('YYYY-MM-DD'),
                        end: moment().endOf('week').format('YYYY-MM-DD')
                    };
                    break;
                case 'this_month':
                    dates = {
                        start: moment().startOf('month').format('YYYY-MM-DD'),
                        end: moment().endOf('month').format('YYYY-MM-DD')
                    };
                    break;
                case 'last_month':
                    dates = {
                        start: moment().subtract(1, 'month').startOf('month').format('YYYY-MM-DD'),
                        end: moment().subtract(1, 'month').endOf('month').format('YYYY-MM-DD')
                    };
                    break;
                case 'this_quarter':
                    dates = getQuarterDates(0);
                    break;
                case 'last_quarter':
                    dates = getQuarterDates(1);
                    break;
                case 'current_fy':
                    dates = getFYDates(0);
                    break;
                case 'last_fy':
                    dates = getFYDates(1);
                    break;
                case 'current_cy':
                    dates = getCalendarYearDates(0);
                    break;
                case 'last_cy':
                    dates = getCalendarYearDates(1);
                    break;
                default:
                    // Numeric days
                    currentDateRange = parseInt(rangeValue);
                    customStartDate = null;
                    customEndDate = null;
                    updateDateRangeDisplay();
                    loadDashboard();
                    return;
            }

            customStartDate = dates.start;
            customEndDate = dates.end;
            document.getElementById('customStartDate').value = dates.start;
            document.getElementById('customEndDate').value = dates.end;

            updateDateRangeDisplay();
            loadDashboard();
        }

        function setDateRange(days) {
            // Legacy function for backward compatibility
            document.getElementById('dateRangeFilter').value = days.toString();
            applyDateRange();
        }

        function updateDateRangeDisplay() {
            const displayEl = document.getElementById('dateRangeDisplay');
            if (!displayEl) return;

            const rangeValue = document.getElementById('dateRangeFilter').value;
            let displayText = '';

            // Always show the actual date range using DateFormatShort property
            if (customStartDate && customEndDate) {
                displayText = `(${moment(customStartDate).format(MOMENT_DATE_FORMAT)} - ${moment(customEndDate).format(MOMENT_DATE_FORMAT)})`;
            }

            displayEl.textContent = displayText;
        }

        function applyCustomDateRange() {
            const startInput = document.getElementById('customStartDate');
            const endInput = document.getElementById('customEndDate');

            if (startInput.value && endInput.value) {
                customStartDate = startInput.value;
                customEndDate = endInput.value;
                currentDateRange = null;

                updateDateRangeDisplay();
                loadDashboard();
            }
        }

        function clearAllFilters() {
            // Reset all filter dropdowns to default "All" values
            document.getElementById('locationGroupFilter').value = '%';
            document.getElementById('productCategoryFilter').value = '%';
            document.getElementById('vendorFilter').value = '%';
            document.getElementById('dateRangeFilter').value = 'current_fy';

            // Reset custom dates and apply FY dates
            const dates = getFYDates(0);
            customStartDate = dates.start;
            customEndDate = dates.end;
            document.getElementById('customStartDate').value = dates.start;
            document.getElementById('customEndDate').value = dates.end;

            // Hide custom date picker
            document.getElementById('customDateRangeContainer').style.display = 'none';

            // Reload dashboard with cleared filters
            updateDateRangeDisplay();
            loadDashboard();
        }

        // ============================================
        // Data Loading and Refresh
        // ============================================
        function loadDashboard() {
            const loading = document.getElementById('loadingOverlay');
            loading.style.display = 'flex';
            debugLog('Loading dashboard...', 'info');

            try {
                // Load KPIs (inventory valuation)
                const kpiData = getKPIMetrics();
                updateKPIs(kpiData);

                // Load below reorder count
                const belowReorderCount = getBelowReorderCount();
                updateBelowReorderKPI(belowReorderCount);

                // Load short parts count and value
                const shortPartsData = getShortPartsDetail();
                const shortLinesCount = shortPartsData ? shortPartsData.length : 0;
                const shortPartsCount = shortPartsData ? new Set(shortPartsData.map(r => r.part_num)).size : 0;
                const shortPicksCount = shortPartsData ? new Set(shortPartsData.map(r => r.pick_num)).size : 0;
                // Calculate at-risk value from short parts (using qty * SoItem.UnitPrice)
                const shortValue = shortPartsData ? shortPartsData.reduce((sum, r) => sum + parseFloat(r.line_value || 0), 0) : 0;
                updateShortPickTile(shortPartsCount, shortLinesCount, shortPicksCount, shortValue);

                // Load cycle count data
                const cycleCountData = getCycleCountData();
                updateCycleCountKPI(cycleCountData);

                // Load scrap data
                const scrapData = getScrapData();
                updateScrapKPI(scrapData);

                // Load fulfillment pipeline data (picked/packed SO items)
                const fulfillmentDetailData = getFulfillmentPipeline();
                const fulfillmentSummaryData = getFulfillmentPipelineSummary();
                updateFulfillmentPipeline(fulfillmentDetailData, fulfillmentSummaryData);

                // Load unavailable stock data
                const unavailableData = getUnavailableData();
                updateUnavailableKPI(unavailableData);

                // Load charts
                const locationData = getStockByLocationGroup();
                renderLocationChart(locationData);

                const topPartsData = getTopPartsByValue();
                renderTopPartsChart(topPartsData);

                const statusData = getAvailabilityStatus();
                renderStatusChart(statusData);

                // Stock Value Flow
                // Received = receiptitem.landedtotalcost (statusid >= 20: reconciled/received/fulfilled, date by newest of dateReceived/dateReconciled)
                // Shipped = postsoitem.PostedTotalCost (invoiced sales)
                // Scrap = POST table (TYPEID=50, REFITEMID=2) using POST.AMOUNT (same as Stock Loss tile)
                // Adjustments = POST table (TYPEID=50, REFITEMID=3) using POST.AMOUNT (same as Stock Loss tile)
                const movementData = getMovementSummary();
                const inventoryRevenue = getInventoryRevenue();
                debugLog('Stock Value Flow loaded. Revenue for margin calc: ' + formatCurrencyValue(inventoryRevenue), 'info');
                renderMovementChart(movementData, inventoryRevenue);

                // Load slow-moving inventory data
                const slowMovingData = getSlowMovingInventory();
                renderSlowMovingChart(slowMovingData);

                debugLog('Dashboard loaded successfully', 'success');

            } catch (error) {
                debugLog('Error loading dashboard: ' + error.message, 'error');
                console.error('Error loading dashboard:', error);
                alert('Error loading dashboard data. Please check console for details.');
            } finally {
                loading.style.display = 'none';
            }
        }

        function updateCycleCountKPI(data) {
            const partsEl = document.getElementById('cycleCountParts');
            const valueEl = document.getElementById('cycleCountValue');

            if (data && data.length > 0 && data[0]) {
                const metrics = data[0];
                const partCount = parseInt(metrics.part_count || 0);
                const netValue = parseFloat(metrics.net_value_change || 0);

                if (partsEl) partsEl.textContent = partCount.toLocaleString() + ' parts';

                const valueStr = netValue >= 0 ? `+${formatCurrencyValue(netValue)}` : formatCurrencyValue(netValue);
                if (valueEl) {
                    valueEl.textContent = valueStr;
                    // Red when negative (loss), blue when positive (gain)
                    valueEl.classList.remove('text-blue-600', 'text-red-600');
                    valueEl.classList.add(netValue >= 0 ? 'text-blue-600' : 'text-red-600');
                }

                // Track for stock loss total - use absolute value for losses
                kpiValues.cycleCountValue = Math.abs(netValue < 0 ? netValue : 0);
            } else {
                if (partsEl) partsEl.textContent = '0 parts';
                if (valueEl) {
                    valueEl.textContent = '$0';
                    valueEl.classList.remove('text-red-600');
                    valueEl.classList.add('text-blue-600');
                }
                kpiValues.cycleCountValue = 0;
            }
            updateStockLossTotal();
        }

        function updateScrapKPI(data) {
            const partsEl = document.getElementById('scrapParts');
            const valueEl = document.getElementById('scrapValue');

            if (data && data.length > 0 && data[0]) {
                const metrics = data[0];
                const partCount = parseInt(metrics.part_count || 0);
                const totalValue = parseFloat(metrics.total_value_scrapped || 0);

                if (partsEl) partsEl.textContent = partCount.toLocaleString() + ' parts';
                if (valueEl) valueEl.textContent = formatCurrencyValue(totalValue);

                kpiValues.scrapValue = totalValue;
            } else {
                if (partsEl) partsEl.textContent = '0 parts';
                if (valueEl) valueEl.textContent = '$0';
                kpiValues.scrapValue = 0;
            }
            updateStockLossTotal();
        }

        function updateStockLossTotal() {
            const totalEl = document.getElementById('stockLossTotalValue');
            const cycleVal = kpiValues.cycleCountValue || 0;
            const scrapVal = kpiValues.scrapValue || 0;
            const total = cycleVal + scrapVal;

            if (totalEl) totalEl.textContent = formatCurrencyValue(total);
        }

        function updateShortPickTile(partsCount, linesCount, picksCount, value) {
            const partsEl = document.getElementById('shortPickPartsCount');
            const linesEl = document.getElementById('shortPickLinesCount');
            const picksEl = document.getElementById('shortPickPicksCount');
            const valueEl = document.getElementById('shortPickValue');

            kpiValues.shortParts = partsCount || 0;
            kpiValues.shortPickValue = value || 0;

            if (partsEl) partsEl.textContent = (partsCount || 0).toLocaleString();
            if (linesEl) linesEl.textContent = (linesCount || 0).toLocaleString();
            if (picksEl) picksEl.textContent = (picksCount || 0).toLocaleString();
            if (valueEl) valueEl.textContent = formatCurrencyValue(value);

            updateHeaderKPIs();
        }

        function updateFulfillmentPipeline(detailData, summaryData) {
            const ordersCountEl = document.getElementById('fulfillmentOrdersCount');
            const itemCountEl = document.getElementById('fulfillmentItemCount');
            const totalValueEl = document.getElementById('fulfillmentTotalValue');

            // Calculate totals from detail data
            const totalItems = detailData ? detailData.length : 0;
            const totalOrders = detailData ? new Set(detailData.map(r => r.shipnum)).size : 0;
            const totalValue = detailData ? detailData.reduce((sum, item) => sum + (parseFloat(item.linevalue) || 0), 0) : 0;

            if (ordersCountEl) ordersCountEl.textContent = totalOrders.toLocaleString();
            if (itemCountEl) itemCountEl.textContent = totalItems.toLocaleString();
            if (totalValueEl) totalValueEl.textContent = formatCurrencyValue(totalValue);

            debugLog('Fulfillment Pipeline updated: ' + totalOrders + ' orders, ' + totalItems + ' items, ' + formatCurrencyValue(totalValue), 'success');
        }

        function exportToCSV() {
            try {
                const kpiData = getKPIMetrics();
                const topPartsData = getTopPartsByValue();

                // Build CSV header
                let csv = 'Inventory Dashboard Export - ' + moment().format('YYYY-MM-DD HH:mm:ss') + '\n\n';

                // KPI Summary
                csv += 'Key Metrics\n';
                csv += 'Metric,Value\n';
                if (kpiData && kpiData.length > 0) {
                    const metrics = kpiData[0];
                    csv += `Total Inventory Value,${formatCurrencyValue(metrics.total_value || 0)}\n`;
                    csv += `Active Parts,${metrics.part_count || 0}\n`;
                    csv += `Total Quantity,${parseFloat(metrics.total_qty || 0).toFixed(2)}\n`;
                    csv += `Below Reorder Point,${metrics.below_reorder || 0}\n`;
                }

                csv += '\n\nTop Parts by Value\n';
                csv += 'Part Number,Description,Location Group,On Hand,Avg Cost,Total Value\n';
                topPartsData.forEach(part => {
                    csv += `"${part.part_num}","${(part.description || '').replace(/"/g, '""')}",`;
                    csv += `"${part.location_group || ''}",`;
                    csv += `${parseFloat(part.qty_on_hand || 0).toFixed(0)},`;
                    csv += `${parseFloat(part.avg_cost || 0).toFixed(2)},`;
                    csv += `${parseFloat(part.total_value || 0).toFixed(2)}\n`;
                });

                // Create download link
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);

                link.setAttribute('href', url);
                link.setAttribute('download', 'Inventory_Dashboard_' + moment().format('YYYY-MM-DD_HHmmss') + '.csv');
                link.style.visibility = 'hidden';

                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                console.log('CSV export completed successfully');
            } catch (error) {
                console.error('Error exporting CSV:', error);
                alert('Error exporting CSV. Please check console for details.');
            }
        }

        // ============================================
        // Event Listeners
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            // Show debug console if DEBUG_MODE is enabled
            if (DEBUG_MODE) {
                document.getElementById('debugConsoleContainer').style.display = 'block';
            }

            // Load filter options
            loadLocationGroups();
            loadProductCategories();
            loadVendors();

            // Hide Financial Year options if FY_START_MONTH is 1 (Calendar Year)
            // When FY = Calendar Year, these options are redundant with Calendar Year options
            if (FY_START_MONTH === 1) {
                document.querySelectorAll('.fy-option').forEach(opt => opt.style.display = 'none');
                debugLog('FY options hidden (FY_START_MONTH = 1, same as calendar year)', 'info');
            }

            // Set default date range based on FY configuration
            if (FY_START_MONTH !== 1) {
                // Non-calendar FY: default to Current Financial Year
                const dates = getFYDates(0);
                customStartDate = dates.start;
                customEndDate = dates.end;
                document.getElementById('dateRangeFilter').value = 'current_fy';
                document.getElementById('customStartDate').value = dates.start;
                document.getElementById('customEndDate').value = dates.end;
            } else {
                // Calendar year FY: default to Current Calendar Year
                const cyDates = getCalendarYearDates(0);
                customStartDate = cyDates.start;
                customEndDate = cyDates.end;
                document.getElementById('dateRangeFilter').value = 'current_cy';
                document.getElementById('customStartDate').value = cyDates.start;
                document.getElementById('customEndDate').value = cyDates.end;
            }

            updateDateRangeDisplay();
            loadDashboard();

            // Window resize handler
            let resizeTimeout;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(loadDashboard, 250);
            });
        });
    </script>
</body>
</html>
